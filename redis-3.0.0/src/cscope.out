cscope 15 $HOME/codes/apps/redis-3.0.0/src               0001412383
	@adlist.c

32 
	~<¡dlib.h
>

33 
	~"adli¡.h
"

34 
	~"zm®loc.h
"

41 
li¡
 *
	$li¡C»©e
()

43 
li¡
 *list;

45 ià((
li¡
 = 
	`zm®loc
((*li¡))è=ğ
NULL
)

46  
NULL
;

47 
li¡
->
h—d
 =†i¡->

 = 
NULL
;

48 
li¡
->
Ën
 = 0;

49 
li¡
->
dup
 = 
NULL
;

50 
li¡
->
ä“
 = 
NULL
;

51 
li¡
->
m©ch
 = 
NULL
;

52  
li¡
;

53 
	}
}

58 
	$li¡R–—£
(
li¡
 *list)

60 
Ën
;

61 
li¡Node
 *
cu¼’t
, *
Ãxt
;

63 
cu¼’t
 = 
li¡
->
h—d
;

64 
Ën
 = 
li¡
->len;

65 
Ën
--) {

66 
Ãxt
 = 
cu¼’t
->next;

67 ià(
li¡
->
ä“
èli¡->
	`ä“
(
cu¼’t
->
v®ue
);

68 
	`zä“
(
cu¼’t
);

69 
cu¼’t
 = 
Ãxt
;

71 
	`zä“
(
li¡
);

72 
	}
}

80 
li¡
 *
	$li¡AddNodeH—d
(
li¡
 *li¡, *
v®ue
)

82 
li¡Node
 *
node
;

84 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

85  
NULL
;

86 
node
->
v®ue
 = value;

87 ià(
li¡
->
Ën
 == 0) {

88 
li¡
->
h—d
 =†i¡->

 = 
node
;

89 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

91 
node
->
´ev
 = 
NULL
;

92 
node
->
Ãxt
 = 
li¡
->
h—d
;

93 
li¡
->
h—d
->
´ev
 = 
node
;

94 
li¡
->
h—d
 = 
node
;

96 
li¡
->
Ën
++;

97  
li¡
;

98 
	}
}

106 
li¡
 *
	$li¡AddNodeTa
(
li¡
 *li¡, *
v®ue
)

108 
li¡Node
 *
node
;

110 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

111  
NULL
;

112 
node
->
v®ue
 = value;

113 ià(
li¡
->
Ën
 == 0) {

114 
li¡
->
h—d
 =†i¡->

 = 
node
;

115 
node
->
´ev
 =‚ode->
Ãxt
 = 
NULL
;

117 
node
->
´ev
 = 
li¡
->

;

118 
node
->
Ãxt
 = 
NULL
;

119 
li¡
->

->
Ãxt
 = 
node
;

120 
li¡
->

 = 
node
;

122 
li¡
->
Ën
++;

123  
li¡
;

124 
	}
}

126 
li¡
 *
	$li¡In£¹Node
(
li¡
 *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
) {

127 
li¡Node
 *
node
;

129 ià((
node
 = 
	`zm®loc
((*node))è=ğ
NULL
)

130  
NULL
;

131 
node
->
v®ue
 = value;

132 ià(
aá”
) {

133 
node
->
´ev
 = 
Şd_node
;

134 
node
->
Ãxt
 = 
Şd_node
->next;

135 ià(
li¡
->

 =ğ
Şd_node
) {

136 
li¡
->

 = 
node
;

139 
node
->
Ãxt
 = 
Şd_node
;

140 
node
->
´ev
 = 
Şd_node
->prev;

141 ià(
li¡
->
h—d
 =ğ
Şd_node
) {

142 
li¡
->
h—d
 = 
node
;

145 ià(
node
->
´ev
 !ğ
NULL
) {

146 
node
->
´ev
->
Ãxt
 =‚ode;

148 ià(
node
->
Ãxt
 !ğ
NULL
) {

149 
node
->
Ãxt
->
´ev
 =‚ode;

151 
li¡
->
Ën
++;

152  
li¡
;

153 
	}
}

159 
	$li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
)

161 ià(
node
->
´ev
)

162 
node
->
´ev
->
Ãxt
 =‚ode->next;

164 
li¡
->
h—d
 = 
node
->
Ãxt
;

165 ià(
node
->
Ãxt
)

166 
node
->
Ãxt
->
´ev
 =‚ode->prev;

168 
li¡
->

 = 
node
->
´ev
;

169 ià(
li¡
->
ä“
èli¡->
	`ä“
(
node
->
v®ue
);

170 
	`zä“
(
node
);

171 
li¡
->
Ën
--;

172 
	}
}

178 
li¡I‹r
 *
	$li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
)

180 
li¡I‹r
 *
™”
;

182 ià((
™”
 = 
	`zm®loc
((*™”))è=ğ
NULL
)  NULL;

183 ià(
dœeùiÚ
 =ğ
AL_START_HEAD
)

184 
™”
->
Ãxt
 = 
li¡
->
h—d
;

186 
™”
->
Ãxt
 = 
li¡
->

;

187 
™”
->
dœeùiÚ
 = direction;

188  
™”
;

189 
	}
}

192 
	$li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
) {

193 
	`zä“
(
™”
);

194 
	}
}

197 
	$li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

198 
li
->
Ãxt
 = 
li¡
->
h—d
;

199 
li
->
dœeùiÚ
 = 
AL_START_HEAD
;

200 
	}
}

202 
	$li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
) {

203 
li
->
Ãxt
 = 
li¡
->

;

204 
li
->
dœeùiÚ
 = 
AL_START_TAIL
;

205 
	}
}

221 
li¡Node
 *
	$li¡Next
(
li¡I‹r
 *
™”
)

223 
li¡Node
 *
cu¼’t
 = 
™”
->
Ãxt
;

225 ià(
cu¼’t
 !ğ
NULL
) {

226 ià(
™”
->
dœeùiÚ
 =ğ
AL_START_HEAD
)

227 
™”
->
Ãxt
 = 
cu¼’t
->next;

229 
™”
->
Ãxt
 = 
cu¼’t
->
´ev
;

231  
cu¼’t
;

232 
	}
}

242 
li¡
 *
	$li¡Dup
(
li¡
 *
Üig
)

244 
li¡
 *
cİy
;

245 
li¡I‹r
 *
™”
;

246 
li¡Node
 *
node
;

248 ià((
cİy
 = 
	`li¡C»©e
()è=ğ
NULL
)

249  
NULL
;

250 
cİy
->
dup
 = 
Üig
->dup;

251 
cİy
->
ä“
 = 
Üig
->free;

252 
cİy
->
m©ch
 = 
Üig
->match;

253 
™”
 = 
	`li¡G‘I‹¿tÜ
(
Üig
, 
AL_START_HEAD
);

254 (
node
 = 
	`li¡Next
(
™”
)è!ğ
NULL
) {

255 *
v®ue
;

257 ià(
cİy
->
dup
) {

258 
v®ue
 = 
cİy
->
	`dup
(
node
->value);

259 ià(
v®ue
 =ğ
NULL
) {

260 
	`li¡R–—£
(
cİy
);

261 
	`li¡R–—£I‹¿tÜ
(
™”
);

262  
NULL
;

265 
v®ue
 = 
node
->value;

266 ià(
	`li¡AddNodeTa
(
cİy
, 
v®ue
è=ğ
NULL
) {

267 
	`li¡R–—£
(
cİy
);

268 
	`li¡R–—£I‹¿tÜ
(
™”
);

269  
NULL
;

272 
	`li¡R–—£I‹¿tÜ
(
™”
);

273  
cİy
;

274 
	}
}

285 
li¡Node
 *
	$li¡S—rchKey
(
li¡
 *li¡, *
key
)

287 
li¡I‹r
 *
™”
;

288 
li¡Node
 *
node
;

290 
™”
 = 
	`li¡G‘I‹¿tÜ
(
li¡
, 
AL_START_HEAD
);

291 (
node
 = 
	`li¡Next
(
™”
)è!ğ
NULL
) {

292 ià(
li¡
->
m©ch
) {

293 ià(
li¡
->
	`m©ch
(
node
->
v®ue
, 
key
)) {

294 
	`li¡R–—£I‹¿tÜ
(
™”
);

295  
node
;

298 ià(
key
 =ğ
node
->
v®ue
) {

299 
	`li¡R–—£I‹¿tÜ
(
™”
);

300  
node
;

304 
	`li¡R–—£I‹¿tÜ
(
™”
);

305  
NULL
;

306 
	}
}

313 
li¡Node
 *
	$li¡Index
(
li¡
 *li¡, 
šdex
) {

314 
li¡Node
 *
n
;

316 ià(
šdex
 < 0) {

317 
šdex
 = (-index)-1;

318 
n
 = 
li¡
->

;

319 
šdex
-- && 
n
èÀğn->
´ev
;

321 
n
 = 
li¡
->
h—d
;

322 
šdex
-- && 
n
èÀğn->
Ãxt
;

324  
n
;

325 
	}
}

328 
	$li¡RÙ©e
(
li¡
 *list) {

329 
li¡Node
 *

 = 
li¡
->tail;

331 ià(
	`li¡L’gth
(
li¡
) <= 1) ;

334 
li¡
->

 =a->
´ev
;

335 
li¡
->

->
Ãxt
 = 
NULL
;

337 
li¡
->
h—d
->
´ev
 = 

;

338 

->
´ev
 = 
NULL
;

339 

->
Ãxt
 = 
li¡
->
h—d
;

340 
li¡
->
h—d
 = 

;

341 
	}
}

	@adlist.h

31 #iâdeà
__ADLIST_H__


32 
	#__ADLIST_H__


	)

36 
	sli¡Node
 {

37 
li¡Node
 *
	m´ev
;

38 
li¡Node
 *
	mÃxt
;

39 *
	mv®ue
;

40 } 
	tli¡Node
;

42 
	sli¡I‹r
 {

43 
li¡Node
 *
	mÃxt
;

44 
	mdœeùiÚ
;

45 } 
	tli¡I‹r
;

47 
	sli¡
 {

48 
li¡Node
 *
	mh—d
;

49 
li¡Node
 *
	m
;

50 *(*
	mdup
)(*
	m±r
);

51 (*
	mä“
)(*
	m±r
);

52 (*
	mm©ch
)(*
	m±r
, *
	mkey
);

53 
	mËn
;

54 } 
	tli¡
;

57 
	#li¡L’gth
(
l
è(Ö)->
Ën
)

	)

58 
	#li¡Fœ¡
(
l
è(Ö)->
h—d
)

	)

59 
	#li¡La¡
(
l
è(Ö)->

)

	)

60 
	#li¡P»vNode
(
n
è(Ò)->
´ev
)

	)

61 
	#li¡NextNode
(
n
è(Ò)->
Ãxt
)

	)

62 
	#li¡NodeV®ue
(
n
è(Ò)->
v®ue
)

	)

64 
	#li¡S‘DupM‘hod
(
l
,
m
è(Ö)->
dup
 = (m))

	)

65 
	#li¡S‘F»eM‘hod
(
l
,
m
è(Ö)->
ä“
 = (m))

	)

66 
	#li¡S‘M©chM‘hod
(
l
,
m
è(Ö)->
m©ch
 = (m))

	)

68 
	#li¡G‘DupM‘hod
(
l
è(Ö)->
dup
)

	)

69 
	#li¡G‘F»e
(
l
è(Ö)->
ä“
)

	)

70 
	#li¡G‘M©chM‘hod
(
l
è(Ö)->
m©ch
)

	)

73 
li¡
 *
li¡C»©e
();

74 
li¡R–—£
(
li¡
 *list);

75 
li¡
 *
li¡AddNodeH—d
Öi¡ *li¡, *
v®ue
);

76 
li¡
 *
li¡AddNodeTa
Öi¡ *li¡, *
v®ue
);

77 
li¡
 *
li¡In£¹Node
Öi¡ *li¡, 
li¡Node
 *
Şd_node
, *
v®ue
, 
aá”
);

78 
li¡D–Node
(
li¡
 *li¡, 
li¡Node
 *
node
);

79 
li¡I‹r
 *
li¡G‘I‹¿tÜ
(
li¡
 *li¡, 
dœeùiÚ
);

80 
li¡Node
 *
li¡Next
(
li¡I‹r
 *
™”
);

81 
li¡R–—£I‹¿tÜ
(
li¡I‹r
 *
™”
);

82 
li¡
 *
li¡Dup
Öi¡ *
Üig
);

83 
li¡Node
 *
li¡S—rchKey
(
li¡
 *li¡, *
key
);

84 
li¡Node
 *
li¡Index
(
li¡
 *li¡, 
šdex
);

85 
li¡Rewšd
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

86 
li¡RewšdTa
(
li¡
 *li¡, 
li¡I‹r
 *
li
);

87 
li¡RÙ©e
(
li¡
 *list);

90 
	#AL_START_HEAD
 0

	)

91 
	#AL_START_TAIL
 1

	)

	@ae.c

33 
	~<¡dio.h
>

34 
	~<sys/time.h
>

35 
	~<sys/ty³s.h
>

36 
	~<uni¡d.h
>

37 
	~<¡dlib.h
>

38 
	~<pŞl.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<”ºo.h
>

43 
	~"«.h
"

44 
	~"zm®loc.h
"

45 
	~"cÚfig.h
"

49 #ifdeà
HAVE_EVPORT


50 
	~"«_evpÜt.c
"

52 #ifdeà
HAVE_EPOLL


53 
	~"«_•Şl.c
"

55 #ifdeà
HAVE_KQUEUE


56 
	~"«_kqueue.c
"

58 
	~"«_£Ëù.c
"

63 
«Ev’tLoİ
 *
	$«C»©eEv’tLoİ
(
£tsize
) {

64 
«Ev’tLoİ
 *
ev’tLoİ
;

65 
i
;

67 ià((
ev’tLoİ
 = 
	`zm®loc
((*ev’tLoİ))è=ğ
NULL
è
”r
;

68 
ev’tLoİ
->
ev’ts
 = 
	`zm®loc
((
«FeEv’t
)*
£tsize
);

69 
ev’tLoİ
->
fœed
 = 
	`zm®loc
((
«FœedEv’t
)*
£tsize
);

70 ià(
ev’tLoİ
->
ev’ts
 =ğ
NULL
 ||ƒv’tLoİ->
fœed
 =ğNULLè
”r
;

71 
ev’tLoİ
->
£tsize
 = setsize;

72 
ev’tLoİ
->
Ï¡Time
 = 
	`time
(
NULL
);

73 
ev’tLoİ
->
timeEv’tH—d
 = 
NULL
;

74 
ev’tLoİ
->
timeEv’tNextId
 = 0;

75 
ev’tLoİ
->
¡İ
 = 0;

76 
ev’tLoİ
->
maxfd
 = -1;

77 
ev’tLoİ
->
befÜe¦“p
 = 
NULL
;

78 ià(
	`«ApiC»©e
(
ev’tLoİ
è=ğ-1è
”r
;

81 
i
 = 0; i < 
£tsize
; i++)

82 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

83  
ev’tLoİ
;

85 
”r
:

86 ià(
ev’tLoİ
) {

87 
	`zä“
(
ev’tLoİ
->
ev’ts
);

88 
	`zä“
(
ev’tLoİ
->
fœed
);

89 
	`zä“
(
ev’tLoİ
);

91  
NULL
;

92 
	}
}

95 
	$«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
) {

96  
ev’tLoİ
->
£tsize
;

97 
	}
}

106 
	$«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

107 
i
;

109 ià(
£tsize
 =ğ
ev’tLoİ
->£tsizeè 
AE_OK
;

110 ià(
ev’tLoİ
->
maxfd
 >ğ
£tsize
è 
AE_ERR
;

111 ià(
	`«ApiResize
(
ev’tLoİ
,
£tsize
è=ğ-1è 
AE_ERR
;

113 
ev’tLoİ
->
ev’ts
 = 
	`z»®loc
Óv’tLoİ->ev’ts,(
«FeEv’t
)*
£tsize
);

114 
ev’tLoİ
->
fœed
 = 
	`z»®loc
Óv’tLoİ->fœed,(
«FœedEv’t
)*
£tsize
);

115 
ev’tLoİ
->
£tsize
 = setsize;

119 
i
 = 
ev’tLoİ
->
maxfd
+1; i < 
£tsize
; i++)

120 
ev’tLoİ
->
ev’ts
[
i
].
mask
 = 
AE_NONE
;

121  
AE_OK
;

122 
	}
}

124 
	$«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

125 
	`«ApiF»e
(
ev’tLoİ
);

126 
	`zä“
(
ev’tLoİ
->
ev’ts
);

127 
	`zä“
(
ev’tLoİ
->
fœed
);

128 
	`zä“
(
ev’tLoİ
);

129 
	}
}

131 
	$«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
) {

132 
ev’tLoİ
->
¡İ
 = 1;

133 
	}
}

135 
	$«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

136 
«FeProc
 *
´oc
, *
ş›ÁD©a
)

138 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) {

139 
”ºo
 = 
ERANGE
;

140  
AE_ERR
;

142 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

144 ià(
	`«ApiAddEv’t
(
ev’tLoİ
, 
fd
, 
mask
) == -1)

145  
AE_ERR
;

146 
ã
->
mask
 |= mask;

147 ià(
mask
 & 
AE_READABLE
è
ã
->
rfeProc
 = 
´oc
;

148 ià(
mask
 & 
AE_WRITABLE
è
ã
->
wfeProc
 = 
´oc
;

149 
ã
->
ş›ÁD©a
 = clientData;

150 ià(
fd
 > 
ev’tLoİ
->
maxfd
)

151 
ev’tLoİ
->
maxfd
 = 
fd
;

152  
AE_OK
;

153 
	}
}

155 
	$«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
)

157 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
) ;

158 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

159 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

161 
	`«ApiD–Ev’t
(
ev’tLoİ
, 
fd
, 
mask
);

162 
ã
->
mask
 = fe->mask & (~mask);

163 ià(
fd
 =ğ
ev’tLoİ
->
maxfd
 && 
ã
->
mask
 =ğ
AE_NONE
) {

165 
j
;

167 
j
 = 
ev’tLoİ
->
maxfd
-1; j >= 0; j--)

168 ià(
ev’tLoİ
->
ev’ts
[
j
].
mask
 !ğ
AE_NONE
) ;

169 
ev’tLoİ
->
maxfd
 = 
j
;

171 
	}
}

173 
	$«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
) {

174 ià(
fd
 >ğ
ev’tLoİ
->
£tsize
)  0;

175 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
fd
];

177  
ã
->
mask
;

178 
	}
}

180 
	$«G‘Time
(*
£cÚds
, *
mli£cÚds
)

182 
timev®
 
tv
;

184 
	`g‘timeofday
(&
tv
, 
NULL
);

185 *
£cÚds
 = 
tv
.
tv_£c
;

186 *
mli£cÚds
 = 
tv
.
tv_u£c
/1000;

187 
	}
}

189 
	$«AddMli£cÚdsToNow
(
mli£cÚds
, *
£c
, *
ms
) {

190 
cur_£c
, 
cur_ms
, 
wh’_£c
, 
wh’_ms
;

192 
	`«G‘Time
(&
cur_£c
, &
cur_ms
);

193 
wh’_£c
 = 
cur_£c
 + 
mli£cÚds
/1000;

194 
wh’_ms
 = 
cur_ms
 + 
mli£cÚds
%1000;

195 ià(
wh’_ms
 >= 1000) {

196 
wh’_£c
 ++;

197 
wh’_ms
 -= 1000;

199 *
£c
 = 
wh’_£c
;

200 *
ms
 = 
wh’_ms
;

201 
	}
}

203 
	$«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

204 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

205 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
)

207 
id
 = 
ev’tLoİ
->
timeEv’tNextId
++;

208 
«TimeEv’t
 *
‹
;

210 
‹
 = 
	`zm®loc
((*te));

211 ià(
‹
 =ğ
NULL
è 
AE_ERR
;

212 
‹
->
id
 = id;

213 
	`«AddMli£cÚdsToNow
(
mli£cÚds
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

214 
‹
->
timeProc
 = 
´oc
;

215 
‹
->
fš®iz”Proc
 = finalizerProc;

216 
‹
->
ş›ÁD©a
 = clientData;

217 
‹
->
Ãxt
 = 
ev’tLoİ
->
timeEv’tH—d
;

218 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
;

219  
id
;

220 
	}
}

222 
	$«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
)

224 
«TimeEv’t
 *
‹
, *
´ev
 = 
NULL
;

226 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

227 
‹
) {

228 ià(
‹
->
id
 == id) {

229 ià(
´ev
 =ğ
NULL
)

230 
ev’tLoİ
->
timeEv’tH—d
 = 
‹
->
Ãxt
;

232 
´ev
->
Ãxt
 = 
‹
->next;

233 ià(
‹
->
fš®iz”Proc
)

234 
‹
->
	`fš®iz”Proc
(
ev’tLoİ
,e->
ş›ÁD©a
);

235 
	`zä“
(
‹
);

236  
AE_OK
;

238 
´ev
 = 
‹
;

239 
‹
 =e->
Ãxt
;

241  
AE_ERR
;

242 
	}
}

255 
«TimeEv’t
 *
	$«S—rchN—»¡Tim”
(
«Ev’tLoİ
 *
ev’tLoİ
)

257 
«TimeEv’t
 *
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

258 
«TimeEv’t
 *
Ã¬e¡
 = 
NULL
;

260 
‹
) {

261 ià(!
Ã¬e¡
 || 
‹
->
wh’_£c
 <‚earest->when_sec ||

262 (
‹
->
wh’_£c
 =ğ
Ã¬e¡
->when_sec &&

263 
‹
->
wh’_ms
 < 
Ã¬e¡
->when_ms))

264 
Ã¬e¡
 = 
‹
;

265 
‹
 =e->
Ãxt
;

267  
Ã¬e¡
;

268 
	}
}

271 
	$´oûssTimeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
) {

272 
´oûs£d
 = 0;

273 
«TimeEv’t
 *
‹
;

274 
maxId
;

275 
time_t
 
now
 = 
	`time
(
NULL
);

285 ià(
now
 < 
ev’tLoİ
->
Ï¡Time
) {

286 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

287 
‹
) {

288 
‹
->
wh’_£c
 = 0;

289 
‹
 =e->
Ãxt
;

292 
ev’tLoİ
->
Ï¡Time
 = 
now
;

294 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

295 
maxId
 = 
ev’tLoİ
->
timeEv’tNextId
-1;

296 
‹
) {

297 
now_£c
, 
now_ms
;

298 
id
;

300 ià(
‹
->
id
 > 
maxId
) {

301 
‹
 =e->
Ãxt
;

304 
	`«G‘Time
(&
now_£c
, &
now_ms
);

305 ià(
now_£c
 > 
‹
->
wh’_£c
 ||

306 (
now_£c
 =ğ
‹
->
wh’_£c
 && 
now_ms
 >ğ‹->
wh’_ms
))

308 
»tv®
;

310 
id
 = 
‹
->id;

311 
»tv®
 = 
‹
->
	`timeProc
(
ev’tLoİ
, 
id
,e->
ş›ÁD©a
);

312 
´oûs£d
++;

326 ià(
»tv®
 !ğ
AE_NOMORE
) {

327 
	`«AddMli£cÚdsToNow
(
»tv®
,&
‹
->
wh’_£c
,&‹->
wh’_ms
);

329 
	`«D–‘eTimeEv’t
(
ev’tLoİ
, 
id
);

331 
‹
 = 
ev’tLoİ
->
timeEv’tH—d
;

333 
‹
 =e->
Ãxt
;

336  
´oûs£d
;

337 
	}
}

352 
	$«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
)

354 
´oûs£d
 = 0, 
numev’ts
;

357 ià(!(
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_FILE_EVENTS
))  0;

363 ià(
ev’tLoİ
->
maxfd
 != -1 ||

364 ((
æags
 & 
AE_TIME_EVENTS
è&& !(æag & 
AE_DONT_WAIT
))) {

365 
j
;

366 
«TimeEv’t
 *
shÜ‹¡
 = 
NULL
;

367 
timev®
 
tv
, *
tvp
;

369 ià(
æags
 & 
AE_TIME_EVENTS
 && !(æag & 
AE_DONT_WAIT
))

370 
shÜ‹¡
 = 
	`«S—rchN—»¡Tim”
(
ev’tLoİ
);

371 ià(
shÜ‹¡
) {

372 
now_£c
, 
now_ms
;

376 
	`«G‘Time
(&
now_£c
, &
now_ms
);

377 
tvp
 = &
tv
;

378 
tvp
->
tv_£c
 = 
shÜ‹¡
->
wh’_£c
 - 
now_£c
;

379 ià(
shÜ‹¡
->
wh’_ms
 < 
now_ms
) {

380 
tvp
->
tv_u£c
 = ((
shÜ‹¡
->
wh’_ms
+1000è- 
now_ms
)*1000;

381 
tvp
->
tv_£c
 --;

383 
tvp
->
tv_u£c
 = (
shÜ‹¡
->
wh’_ms
 - 
now_ms
)*1000;

385 ià(
tvp
->
tv_£c
 < 0)vp->tv_sec = 0;

386 ià(
tvp
->
tv_u£c
 < 0)vp->tv_usec = 0;

391 ià(
æags
 & 
AE_DONT_WAIT
) {

392 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

393 
tvp
 = &
tv
;

396 
tvp
 = 
NULL
;

400 
numev’ts
 = 
	`«ApiPŞl
(
ev’tLoİ
, 
tvp
);

401 
j
 = 0; j < 
numev’ts
; j++) {

402 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[ev’tLoİ->
fœed
[
j
].
fd
];

403 
mask
 = 
ev’tLoİ
->
fœed
[
j
].mask;

404 
fd
 = 
ev’tLoİ
->
fœed
[
j
].fd;

405 
rfœed
 = 0;

410 ià(
ã
->
mask
 & mask & 
AE_READABLE
) {

411 
rfœed
 = 1;

412 
ã
->
	`rfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

414 ià(
ã
->
mask
 & mask & 
AE_WRITABLE
) {

415 ià(!
rfœed
 || 
ã
->
wfeProc
 !ğã->
rfeProc
)

416 
ã
->
	`wfeProc
(
ev’tLoİ
,
fd
,ã->
ş›ÁD©a
,
mask
);

418 
´oûs£d
++;

422 ià(
æags
 & 
AE_TIME_EVENTS
)

423 
´oûs£d
 +ğ
	`´oûssTimeEv’ts
(
ev’tLoİ
);

425  
´oûs£d
;

426 
	}
}

430 
	$«Wa™
(
fd
, 
mask
, 
mli£cÚds
) {

431 
pŞlfd
 
pfd
;

432 
»tmask
 = 0, 
»tv®
;

434 
	`mem£t
(&
pfd
, 0, (pfd));

435 
pfd
.
fd
 = fd;

436 ià(
mask
 & 
AE_READABLE
è
pfd
.
ev’ts
 |ğ
POLLIN
;

437 ià(
mask
 & 
AE_WRITABLE
è
pfd
.
ev’ts
 |ğ
POLLOUT
;

439 ià((
»tv®
 = 
	`pŞl
(&
pfd
, 1, 
mli£cÚds
))== 1) {

440 ià(
pfd
.
»v’ts
 & 
POLLIN
è
»tmask
 |ğ
AE_READABLE
;

441 ià(
pfd
.
»v’ts
 & 
POLLOUT
è
»tmask
 |ğ
AE_WRITABLE
;

442 ià(
pfd
.
»v’ts
 & 
POLLERR
è
»tmask
 |ğ
AE_WRITABLE
;

443 ià(
pfd
.
»v’ts
 & 
POLLHUP
è
»tmask
 |ğ
AE_WRITABLE
;

444  
»tmask
;

446  
»tv®
;

448 
	}
}

450 
	$«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
) {

451 
ev’tLoİ
->
¡İ
 = 0;

452 !
ev’tLoİ
->
¡İ
) {

453 ià(
ev’tLoİ
->
befÜe¦“p
 !ğ
NULL
)

454 
ev’tLoİ
->
	`befÜe¦“p
(eventLoop);

455 
	`«ProûssEv’ts
(
ev’tLoİ
, 
AE_ALL_EVENTS
);

457 
	}
}

459 *
	$«G‘ApiName
() {

460  
	`«ApiName
();

461 
	}
}

463 
	$«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
) {

464 
ev’tLoİ
->
befÜe¦“p
 = beforesleep;

465 
	}
}

	@ae.h

33 #iâdeà
__AE_H__


34 
	#__AE_H__


	)

36 
	#AE_OK
 0

	)

37 
	#AE_ERR
 -1

	)

39 
	#AE_NONE
 0

	)

40 
	#AE_READABLE
 1

	)

41 
	#AE_WRITABLE
 2

	)

43 
	#AE_FILE_EVENTS
 1

	)

44 
	#AE_TIME_EVENTS
 2

	)

45 
	#AE_ALL_EVENTS
 (
AE_FILE_EVENTS
|
AE_TIME_EVENTS
)

	)

46 
	#AE_DONT_WAIT
 4

	)

48 
	#AE_NOMORE
 -1

	)

51 
	#AE_NOTUSED
(
V
è((èV)

	)

53 
	g«Ev’tLoİ
;

56 
	t«FeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tfd
, *
	tş›ÁD©a
, 
	tmask
);

57 
	t«TimeProc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, 
	tid
, *
	tş›ÁD©a
);

58 
	t«Ev’tFš®iz”Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
, *
	tş›ÁD©a
);

59 
	t«BefÜeSË•Proc
(
	t«Ev’tLoİ
 *
	tev’tLoİ
);

62 
	s«FeEv’t
 {

63 
	mmask
;

64 
«FeProc
 *
	mrfeProc
;

65 
«FeProc
 *
	mwfeProc
;

66 *
	mş›ÁD©a
;

67 } 
	t«FeEv’t
;

70 
	s«TimeEv’t
 {

71 
	mid
;

72 
	mwh’_£c
;

73 
	mwh’_ms
;

74 
«TimeProc
 *
	mtimeProc
;

75 
«Ev’tFš®iz”Proc
 *
	mfš®iz”Proc
;

76 *
	mş›ÁD©a
;

77 
«TimeEv’t
 *
	mÃxt
;

78 } 
	t«TimeEv’t
;

81 
	s«FœedEv’t
 {

82 
	mfd
;

83 
	mmask
;

84 } 
	t«FœedEv’t
;

87 
	s«Ev’tLoİ
 {

88 
	mmaxfd
;

89 
	m£tsize
;

90 
	mtimeEv’tNextId
;

91 
time_t
 
	mÏ¡Time
;

92 
«FeEv’t
 *
	mev’ts
;

93 
«FœedEv’t
 *
	mfœed
;

94 
«TimeEv’t
 *
	mtimeEv’tH—d
;

95 
	m¡İ
;

96 *
	m­id©a
;

97 
«BefÜeSË•Proc
 *
	mbefÜe¦“p
;

98 } 
	t«Ev’tLoİ
;

101 
«Ev’tLoİ
 *
«C»©eEv’tLoİ
(
£tsize
);

102 
«D–‘eEv’tLoİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

103 
«Stİ
(
«Ev’tLoİ
 *
ev’tLoİ
);

104 
«C»©eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
,

105 
«FeProc
 *
´oc
, *
ş›ÁD©a
);

106 
«D–‘eFeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
);

107 
«G‘FeEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
);

108 
«C»©eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
mli£cÚds
,

109 
«TimeProc
 *
´oc
, *
ş›ÁD©a
,

110 
«Ev’tFš®iz”Proc
 *
fš®iz”Proc
);

111 
«D–‘eTimeEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
);

112 
«ProûssEv’ts
(
«Ev’tLoİ
 *
ev’tLoİ
, 
æags
);

113 
«Wa™
(
fd
, 
mask
, 
mli£cÚds
);

114 
«Maš
(
«Ev’tLoİ
 *
ev’tLoİ
);

115 *
«G‘ApiName
();

116 
«S‘BefÜeSË•Proc
(
«Ev’tLoİ
 *
ev’tLoİ
, 
«BefÜeSË•Proc
 *
befÜe¦“p
);

117 
«G‘S‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
);

118 
«ResizeS‘Size
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
);

	@ae_epoll.c

32 
	~<sys/•Şl.h
>

34 
	s«ApiS‹
 {

35 
	m•fd
;

36 
•Şl_ev’t
 *
	mev’ts
;

37 } 
	t«ApiS‹
;

39 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

40 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

42 ià(!
¡©e
)  -1;

43 
¡©e
->
ev’ts
 = 
	`zm®loc
((
•Şl_ev’t
)*
ev’tLoİ
->
£tsize
);

44 ià(!
¡©e
->
ev’ts
) {

45 
	`zä“
(
¡©e
);

48 
¡©e
->
•fd
 = 
	`•Şl_ü—‹
(1024);

49 ià(
¡©e
->
•fd
 == -1) {

50 
	`zä“
(
¡©e
->
ev’ts
);

51 
	`zä“
(
¡©e
);

54 
ev’tLoİ
->
­id©a
 = 
¡©e
;

56 
	}
}

58 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

59 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

61 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
•Şl_ev’t
)*
£tsize
);

63 
	}
}

65 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

66 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

68 
	`şo£
(
¡©e
->
•fd
);

69 
	`zä“
(
¡©e
->
ev’ts
);

70 
	`zä“
(
¡©e
);

71 
	}
}

73 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

74 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

75 
•Şl_ev’t
 
“
;

78 
İ
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
 =ğ
AE_NONE
 ?

79 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
;

81 
“
.
ev’ts
 = 0;

82 
mask
 |ğ
ev’tLoİ
->
ev’ts
[
fd
].mask;

83 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

84 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

85 
“
.
d©a
.
u64
 = 0;

86 
“
.
d©a
.
fd
 = fd;

87 ià(
	`•Şl_ùl
(
¡©e
->
•fd
,
İ
,
fd
,&
“
) == -1)  -1;

89 
	}
}

91 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
d–mask
) {

92 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

93 
•Şl_ev’t
 
“
;

94 
mask
 = 
ev’tLoİ
->
ev’ts
[
fd
].mask & (~
d–mask
);

96 
“
.
ev’ts
 = 0;

97 ià(
mask
 & 
AE_READABLE
è
“
.
ev’ts
 |ğ
EPOLLIN
;

98 ià(
mask
 & 
AE_WRITABLE
è
“
.
ev’ts
 |ğ
EPOLLOUT
;

99 
“
.
d©a
.
u64
 = 0;

100 
“
.
d©a
.
fd
 = fd;

101 ià(
mask
 !ğ
AE_NONE
) {

102 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_MOD
,
fd
,&
“
);

106 
	`•Şl_ùl
(
¡©e
->
•fd
,
EPOLL_CTL_DEL
,
fd
,&
“
);

108 
	}
}

110 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

111 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

112 
»tv®
, 
numev’ts
 = 0;

114 
»tv®
 = 
	`•Şl_wa™
(
¡©e
->
•fd
,¡©e->
ev’ts
,
ev’tLoİ
->
£tsize
,

115 
tvp
 ? (tvp->
tv_£c
*1000 +vp->
tv_u£c
/1000) : -1);

116 ià(
»tv®
 > 0) {

117 
j
;

119 
numev’ts
 = 
»tv®
;

120 
j
 = 0; j < 
numev’ts
; j++) {

121 
mask
 = 0;

122 
•Şl_ev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

124 ià(
e
->
ev’ts
 & 
EPOLLIN
è
mask
 |ğ
AE_READABLE
;

125 ià(
e
->
ev’ts
 & 
EPOLLOUT
è
mask
 |ğ
AE_WRITABLE
;

126 ià(
e
->
ev’ts
 & 
EPOLLERR
è
mask
 |ğ
AE_WRITABLE
;

127 ià(
e
->
ev’ts
 & 
EPOLLHUP
è
mask
 |ğ
AE_WRITABLE
;

128 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
d©a
.fd;

129 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

132  
numev’ts
;

133 
	}
}

135 *
	$«ApiName
() {

137 
	}
}

	@ae_evport.c

31 
	~<as£¹.h
>

32 
	~<”ºo.h
>

33 
	~<pÜt.h
>

34 
	~<pŞl.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

39 
	~<¡dio.h
>

41 
	gevpÜt_debug
 = 0;

66 
	#MAX_EVENT_BATCHSZ
 512

	)

68 
	s«ApiS‹
 {

69 
	mpÜtfd
;

70 
	mÅ’dšg
;

71 
	m³ndšg_fds
[
MAX_EVENT_BATCHSZ
];

72 
	m³ndšg_masks
[
MAX_EVENT_BATCHSZ
];

73 } 
	t«ApiS‹
;

75 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

76 
i
;

77 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

78 ià(!
¡©e
)  -1;

80 
¡©e
->
pÜtfd
 = 
	`pÜt_ü—‹
();

81 ià(
¡©e
->
pÜtfd
 == -1) {

82 
	`zä“
(
¡©e
);

86 
¡©e
->
Å’dšg
 = 0;

88 
i
 = 0; i < 
MAX_EVENT_BATCHSZ
; i++) {

89 
¡©e
->
³ndšg_fds
[
i
] = -1;

90 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

93 
ev’tLoİ
->
­id©a
 = 
¡©e
;

95 
	}
}

97 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

100 
	}
}

102 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

103 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

105 
	`şo£
(
¡©e
->
pÜtfd
);

106 
	`zä“
(
¡©e
);

107 
	}
}

109 
	$«ApiLookupP’dšg
(
«ApiS‹
 *
¡©e
, 
fd
) {

110 
i
;

112 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

113 ià(
¡©e
->
³ndšg_fds
[
i
] =ğ
fd
)

114  (
i
);

118 
	}
}

123 
	$«ApiAssocŸ‹
(cÚ¡ *
wh”e
, 
pÜtfd
, 
fd
, 
mask
) {

124 
ev’ts
 = 0;

125 
rv
, 
”r
;

127 ià(
mask
 & 
AE_READABLE
)

128 
ev’ts
 |ğ
POLLIN
;

129 ià(
mask
 & 
AE_WRITABLE
)

130 
ev’ts
 |ğ
POLLOUT
;

132 ià(
evpÜt_debug
)

133 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹(%d, 0x%xèğ", 
wh”e
, 
fd
, 
ev’ts
);

135 
rv
 = 
	`pÜt_assocŸ‹
(
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
, 
ev’ts
,

136 (*)(
ušŒ_t
)
mask
);

137 
”r
 = 
”ºo
;

139 ià(
evpÜt_debug
)

140 
	`årštf
(
¡d”r
, "%d (%s)\n", 
rv
,„v =ğ0 ? "nØ”rÜ" : 
	`¡»¼Ü
(
”r
));

142 ià(
rv
 == -1) {

143 
	`årštf
(
¡d”r
, "%s:…Üt_assocŸ‹: %s\n", 
wh”e
, 
	`¡»¼Ü
(
”r
));

145 ià(
”r
 =ğ
EAGAIN
)

146 
	`årštf
(
¡d”r
, "aeApiAssociate:ƒvent…ort†imitƒxceeded.");

149  
rv
;

150 
	}
}

152 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

153 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

154 
fuÎmask
, 
pfd
;

156 ià(
evpÜt_debug
)

157 
	`årštf
(
¡d”r
, "«ApiAddEv’t: fd %d mask 0x%x\n", 
fd
, 
mask
);

164 
fuÎmask
 = 
mask
 | 
ev’tLoİ
->
ev’ts
[
fd
].mask;

165 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

167 ià(
pfd
 != -1) {

174 ià(
evpÜt_debug
)

175 
	`årštf
(
¡d”r
, "«ApiAddEv’t:‡ddšgØ³ndšg fd %d\n", 
fd
);

176 
¡©e
->
³ndšg_masks
[
pfd
] |ğ
fuÎmask
;

180  (
	`«ApiAssocŸ‹
("«ApiAddEv’t", 
¡©e
->
pÜtfd
, 
fd
, 
fuÎmask
));

181 
	}
}

183 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

184 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

185 
fuÎmask
, 
pfd
;

187 ià(
evpÜt_debug
)

188 
	`årštf
(
¡d”r
, "d– fd %d mask 0x%x\n", 
fd
, 
mask
);

190 
pfd
 = 
	`«ApiLookupP’dšg
(
¡©e
, 
fd
);

192 ià(
pfd
 != -1) {

193 ià(
evpÜt_debug
)

194 
	`årštf
(
¡d”r
, "d–‘šgƒv’ˆäom…’dšg fd %d\n", 
fd
);

201 
¡©e
->
³ndšg_masks
[
pfd
] &ğ~
mask
;

203 ià(
¡©e
->
³ndšg_masks
[
pfd
] =ğ
AE_NONE
)

204 
¡©e
->
³ndšg_fds
[
pfd
] = -1;

217 
fuÎmask
 = 
ev’tLoİ
->
ev’ts
[
fd
].
mask
;

218 ià(
fuÎmask
 =ğ
AE_NONE
) {

223 ià(
evpÜt_debug
)

224 
	`årštf
(
¡d”r
, "«ApiD–Ev’t:…Üt_dissocŸ‹(%d)\n", 
fd
);

226 ià(
	`pÜt_dissocŸ‹
(
¡©e
->
pÜtfd
, 
PORT_SOURCE_FD
, 
fd
) != 0) {

227 
	`³¼Ü
("aeApiDelEvent:…ort_dissociate");

228 
	`abÜt
();

230 } ià(
	`«ApiAssocŸ‹
("«ApiD–Ev’t", 
¡©e
->
pÜtfd
, 
fd
,

231 
fuÎmask
) != 0) {

239 
	`abÜt
();

241 
	}
}

243 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

244 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

245 
time¥ec
 
timeout
, *
t¥
;

246 
mask
, 
i
;

247 
ušt_t
 
Ãv’ts
;

248 
pÜt_ev’t_t
 
ev’t
[
MAX_EVENT_BATCHSZ
];

255 
i
 = 0; i < 
¡©e
->
Å’dšg
; i++) {

256 ià(
¡©e
->
³ndšg_fds
[
i
] == -1)

260 ià(
	`«ApiAssocŸ‹
("«ApiPŞl", 
¡©e
->
pÜtfd
,

261 
¡©e
->
³ndšg_fds
[
i
], s‹->
³ndšg_masks
[i]) != 0) {

263 
	`abÜt
();

266 
¡©e
->
³ndšg_masks
[
i
] = 
AE_NONE
;

267 
¡©e
->
³ndšg_fds
[
i
] = -1;

270 
¡©e
->
Å’dšg
 = 0;

272 ià(
tvp
 !ğ
NULL
) {

273 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

274 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

275 
t¥
 = &
timeout
;

277 
t¥
 = 
NULL
;

284 
Ãv’ts
 = 1;

285 ià(
	`pÜt_g‘n
(
¡©e
->
pÜtfd
, 
ev’t
, 
MAX_EVENT_BATCHSZ
, &
Ãv’ts
,

286 
t¥
è=ğ-1 && (
”ºo
 !ğ
ETIME
 || 
Ãv’ts
 == 0)) {

287 ià(
”ºo
 =ğ
ETIME
 ||ƒ¼nØ=ğ
EINTR
)

291 
	`³¼Ü
("aeApiPoll:…ort_get");

292 
	`abÜt
();

295 
¡©e
->
Å’dšg
 = 
Ãv’ts
;

297 
i
 = 0; i < 
Ãv’ts
; i++) {

298 
mask
 = 0;

299 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLIN
)

300 
mask
 |ğ
AE_READABLE
;

301 ià(
ev’t
[
i
].
pÜ‹v_ev’ts
 & 
POLLOUT
)

302 
mask
 |ğ
AE_WRITABLE
;

304 
ev’tLoİ
->
fœed
[
i
].
fd
 = 
ev’t
[i].
pÜ‹v_objeù
;

305 
ev’tLoİ
->
fœed
[
i
].
mask
 = mask;

307 ià(
evpÜt_debug
)

308 
	`årštf
(
¡d”r
, "aeApiPoll: fd %d mask 0x%x\n",

309 ()
ev’t
[
i
].
pÜ‹v_objeù
, 
mask
);

311 
¡©e
->
³ndšg_fds
[
i
] = 
ev’t
[i].
pÜ‹v_objeù
;

312 
¡©e
->
³ndšg_masks
[
i
] = (
ušŒ_t
)
ev’t
[i].
pÜ‹v_u£r
;

315  
Ãv’ts
;

316 
	}
}

318 *
	$«ApiName
() {

320 
	}
}

	@ae_kqueue.c

32 
	~<sys/ty³s.h
>

33 
	~<sys/ev’t.h
>

34 
	~<sys/time.h
>

36 
	s«ApiS‹
 {

37 
	mkqfd
;

38 
kev’t
 *
	mev’ts
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
¡©e
->
ev’ts
 = 
	`zm®loc
((
kev’t
)*
ev’tLoİ
->
£tsize
);

46 ià(!
¡©e
->
ev’ts
) {

47 
	`zä“
(
¡©e
);

50 
¡©e
->
kqfd
 = 
	`kqueue
();

51 ià(
¡©e
->
kqfd
 == -1) {

52 
	`zä“
(
¡©e
->
ev’ts
);

53 
	`zä“
(
¡©e
);

56 
ev’tLoİ
->
­id©a
 = 
¡©e
;

58 
	}
}

60 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

61 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

63 
¡©e
->
ev’ts
 = 
	`z»®loc
(¡©e->ev’ts, (
kev’t
)*
£tsize
);

65 
	}
}

67 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

68 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

70 
	`şo£
(
¡©e
->
kqfd
);

71 
	`zä“
(
¡©e
->
ev’ts
);

72 
	`zä“
(
¡©e
);

73 
	}
}

75 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

76 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

77 
kev’t
 
ke
;

79 ià(
mask
 & 
AE_READABLE
) {

80 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
NULL
);

81 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

83 ià(
mask
 & 
AE_WRITABLE
) {

84 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
NULL
);

85 ià(
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL) == -1)  -1;

88 
	}
}

90 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

91 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

92 
kev’t
 
ke
;

94 ià(
mask
 & 
AE_READABLE
) {

95 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

96 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

98 ià(
mask
 & 
AE_WRITABLE
) {

99 
	`EV_SET
(&
ke
, 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

100 
	`kev’t
(
¡©e
->
kqfd
, &
ke
, 1, 
NULL
, 0, NULL);

102 
	}
}

104 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

105 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

106 
»tv®
, 
numev’ts
 = 0;

108 ià(
tvp
 !ğ
NULL
) {

109 
time¥ec
 
timeout
;

110 
timeout
.
tv_£c
 = 
tvp
->tv_sec;

111 
timeout
.
tv_n£c
 = 
tvp
->
tv_u£c
 * 1000;

112 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

113 &
timeout
);

115 
»tv®
 = 
	`kev’t
(
¡©e
->
kqfd
, 
NULL
, 0, s‹->
ev’ts
, 
ev’tLoİ
->
£tsize
,

116 
NULL
);

119 ià(
»tv®
 > 0) {

120 
j
;

122 
numev’ts
 = 
»tv®
;

123 
j
 = 0; j < 
numev’ts
; j++) {

124 
mask
 = 0;

125 
kev’t
 *
e
 = 
¡©e
->
ev’ts
+
j
;

127 ià(
e
->
f‹r
 =ğ
EVFILT_READ
è
mask
 |ğ
AE_READABLE
;

128 ià(
e
->
f‹r
 =ğ
EVFILT_WRITE
è
mask
 |ğ
AE_WRITABLE
;

129 
ev’tLoİ
->
fœed
[
j
].
fd
 = 
e
->
id’t
;

130 
ev’tLoİ
->
fœed
[
j
].
mask
 = mask;

133  
numev’ts
;

134 
	}
}

136 *
	$«ApiName
() {

138 
	}
}

	@ae_select.c

32 
	~<¡ršg.h
>

34 
	s«ApiS‹
 {

35 
fd_£t
 
	mrfds
, 
	mwfds
;

38 
fd_£t
 
	m_rfds
, 
	m_wfds
;

39 } 
	t«ApiS‹
;

41 
	$«ApiC»©e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

42 
«ApiS‹
 *
¡©e
 = 
	`zm®loc
((aeApiState));

44 ià(!
¡©e
)  -1;

45 
	`FD_ZERO
(&
¡©e
->
rfds
);

46 
	`FD_ZERO
(&
¡©e
->
wfds
);

47 
ev’tLoİ
->
­id©a
 = 
¡©e
;

49 
	}
}

51 
	$«ApiResize
(
«Ev’tLoİ
 *
ev’tLoİ
, 
£tsize
) {

53 ià(
£tsize
 >ğ
FD_SETSIZE
)  -1;

55 
	}
}

57 
	$«ApiF»e
(
«Ev’tLoİ
 *
ev’tLoİ
) {

58 
	`zä“
(
ev’tLoİ
->
­id©a
);

59 
	}
}

61 
	$«ApiAddEv’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

62 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

64 ià(
mask
 & 
AE_READABLE
è
	`FD_SET
(
fd
,&
¡©e
->
rfds
);

65 ià(
mask
 & 
AE_WRITABLE
è
	`FD_SET
(
fd
,&
¡©e
->
wfds
);

67 
	}
}

69 
	$«ApiD–Ev’t
(
«Ev’tLoİ
 *
ev’tLoİ
, 
fd
, 
mask
) {

70 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

72 ià(
mask
 & 
AE_READABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
rfds
);

73 ià(
mask
 & 
AE_WRITABLE
è
	`FD_CLR
(
fd
,&
¡©e
->
wfds
);

74 
	}
}

76 
	$«ApiPŞl
(
«Ev’tLoİ
 *
ev’tLoİ
, 
timev®
 *
tvp
) {

77 
«ApiS‹
 *
¡©e
 = 
ev’tLoİ
->
­id©a
;

78 
»tv®
, 
j
, 
numev’ts
 = 0;

80 
	`memıy
(&
¡©e
->
_rfds
,&¡©e->
rfds
,(
fd_£t
));

81 
	`memıy
(&
¡©e
->
_wfds
,&¡©e->
wfds
,(
fd_£t
));

83 
»tv®
 = 
	`£Ëù
(
ev’tLoİ
->
maxfd
+1,

84 &
¡©e
->
_rfds
,&¡©e->
_wfds
,
NULL
,
tvp
);

85 ià(
»tv®
 > 0) {

86 
j
 = 0; j <ğ
ev’tLoİ
->
maxfd
; j++) {

87 
mask
 = 0;

88 
«FeEv’t
 *
ã
 = &
ev’tLoİ
->
ev’ts
[
j
];

90 ià(
ã
->
mask
 =ğ
AE_NONE
) ;

91 ià(
ã
->
mask
 & 
AE_READABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_rfds
))

92 
mask
 |ğ
AE_READABLE
;

93 ià(
ã
->
mask
 & 
AE_WRITABLE
 && 
	`FD_ISSET
(
j
,&
¡©e
->
_wfds
))

94 
mask
 |ğ
AE_WRITABLE
;

95 
ev’tLoİ
->
fœed
[
numev’ts
].
fd
 = 
j
;

96 
ev’tLoİ
->
fœed
[
numev’ts
].
mask
 = mask;

97 
numev’ts
++;

100  
numev’ts
;

101 
	}
}

103 *
	$«ApiName
() {

105 
	}
}

	@anet.c

31 
	~"fmaüos.h
"

33 
	~<sys/ty³s.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/un.h
>

37 
	~<sys/time.h
>

38 
	~<Ãtš‘/š.h
>

39 
	~<Ãtš‘/tı.h
>

40 
	~<¬·/š‘.h
>

41 
	~<uni¡d.h
>

42 
	~<fú.h
>

43 
	~<¡ršg.h
>

44 
	~<Ãtdb.h
>

45 
	~<”ºo.h
>

46 
	~<¡d¬g.h
>

47 
	~<¡dio.h
>

49 
	~"ª‘.h
"

51 
	$ª‘S‘E¼Ü
(*
”r
, cÚ¡ *
fmt
, ...)

53 
va_li¡
 
­
;

55 ià(!
”r
) ;

56 
	`va_¡¬t
(
­
, 
fmt
);

57 
	`v¢´štf
(
”r
, 
ANET_ERR_LEN
, 
fmt
, 
­
);

58 
	`va_’d
(
­
);

59 
	}
}

61 
	$ª‘S‘Block
(*
”r
, 
fd
, 
nÚ_block
) {

62 
æags
;

67 ià((
æags
 = 
	`fú
(
fd
, 
F_GETFL
)) == -1) {

68 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_GETFL): %s", 
	`¡»¼Ü
(
”ºo
));

69  
ANET_ERR
;

72 ià(
nÚ_block
)

73 
æags
 |ğ
O_NONBLOCK
;

75 
æags
 &ğ~
O_NONBLOCK
;

77 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

78 
	`ª‘S‘E¼Ü
(
”r
, "fú(F_SETFL,O_NONBLOCK): %s", 
	`¡»¼Ü
(
”ºo
));

79  
ANET_ERR
;

81  
ANET_OK
;

82 
	}
}

84 
	$ª‘NÚBlock
(*
”r
, 
fd
) {

85  
	`ª‘S‘Block
(
”r
,
fd
,1);

86 
	}
}

88 
	$ª‘Block
(*
”r
, 
fd
) {

89  
	`ª‘S‘Block
(
”r
,
fd
,0);

90 
	}
}

95 
	$ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
)

97 
v®
 = 1;

99 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
v®
, (val)) == -1)

101 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

102  
ANET_ERR
;

105 #ifdeà
__lšux__


111 
v®
 = 
š‹rv®
;

112 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPIDLE
, &
v®
, (val)) < 0) {

113 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPIDLE: %s\n", 
	`¡»¼Ü
(
”ºo
));

114  
ANET_ERR
;

120 
v®
 = 
š‹rv®
/3;

121 ià(
v®
 == 0) val = 1;

122 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPINTVL
, &
v®
, (val)) < 0) {

123 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPINTVL: %s\n", 
	`¡»¼Ü
(
”ºo
));

124  
ANET_ERR
;

129 
v®
 = 3;

130 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_KEEPCNT
, &
v®
, (val)) < 0) {

131 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_KEEPCNT: %s\n", 
	`¡»¼Ü
(
”ºo
));

132  
ANET_ERR
;

135 ((è
š‹rv®
);

138  
ANET_OK
;

139 
	}
}

141 
	$ª‘S‘TıNoD–ay
(*
”r
, 
fd
, 
v®
)

143 ià(
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
v®
, (val)) == -1)

145 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆTCP_NODELAY: %s", 
	`¡»¼Ü
(
”ºo
));

146  
ANET_ERR
;

148  
ANET_OK
;

149 
	}
}

151 
	$ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
)

153  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 1);

154 
	}
}

156 
	$ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
)

158  
	`ª‘S‘TıNoD–ay
(
”r
, 
fd
, 0);

159 
	}
}

162 
	$ª‘S‘S’dBufãr
(*
”r
, 
fd
, 
buffsize
)

164 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buffsize
, (buffsize)) == -1)

166 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDBUF: %s", 
	`¡»¼Ü
(
”ºo
));

167  
ANET_ERR
;

169  
ANET_OK
;

170 
	}
}

172 
	$ª‘TıK“pAlive
(*
”r
, 
fd
)

174 
yes
 = 1;

175 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, &
yes
, (yes)) == -1) {

176 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_KEEPALIVE: %s", 
	`¡»¼Ü
(
”ºo
));

177  
ANET_ERR
;

179  
ANET_OK
;

180 
	}
}

184 
	$ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
) {

185 
timev®
 
tv
;

187 
tv
.
tv_£c
 = 
ms
/1000;

188 
tv
.
tv_u£c
 = (
ms
%1000)*1000;

189 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (tv)) == -1) {

190 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_SNDTIMEO: %s", 
	`¡»¼Ü
(
”ºo
));

191  
ANET_ERR
;

193  
ANET_OK
;

194 
	}
}

203 
	$ª‘G’”icResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
,

204 
æags
)

206 
addršfo
 
hšts
, *
šfo
;

207 
rv
;

209 
	`mem£t
(&
hšts
,0,(hints));

210 ià(
æags
 & 
ANET_IP_ONLY
è
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

211 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

212 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

214 ià((
rv
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
šfo
)) != 0) {

215 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

216  
ANET_ERR
;

218 ià(
šfo
->
ai_çmy
 =ğ
AF_INET
) {

219 
sockaddr_š
 *
§
 = (sockaddr_š *)
šfo
->
ai_addr
;

220 
	`š‘_Áİ
(
AF_INET
, &(
§
->
sš_addr
), 
buf
, 
buf_Ën
);

222 
sockaddr_š6
 *
§
 = (sockaddr_š6 *)
šfo
->
ai_addr
;

223 
	`š‘_Áİ
(
AF_INET6
, &(
§
->
sš6_addr
), 
buf
, 
buf_Ën
);

226 
	`ä“addršfo
(
šfo
);

227  
ANET_OK
;

228 
	}
}

230 
	$ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

231  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_NONE
);

232 
	}
}

234 
	$ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
) {

235  
	`ª‘G’”icResŞve
(
”r
,
ho¡
,
buf
,
buf_Ën
,
ANET_IP_ONLY
);

236 
	}
}

238 
	$ª‘S‘Reu£Addr
(*
”r
, 
fd
) {

239 
yes
 = 1;

242 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes)) == -1) {

243 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİˆSO_REUSEADDR: %s", 
	`¡»¼Ü
(
”ºo
));

244  
ANET_ERR
;

246  
ANET_OK
;

247 
	}
}

249 
	$ª‘C»©eSock‘
(*
”r
, 
domaš
) {

250 
s
;

251 ià((
s
 = 
	`sock‘
(
domaš
, 
SOCK_STREAM
, 0)) == -1) {

252 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

253  
ANET_ERR
;

258 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
) {

259 
	`şo£
(
s
);

260  
ANET_ERR
;

262  
s
;

263 
	}
}

265 
	#ANET_CONNECT_NONE
 0

	)

266 
	#ANET_CONNECT_NONBLOCK
 1

	)

267 
	$ª‘TıG’”icCÚÃù
(*
”r
, *
addr
, 
pÜt
,

268 *
sourû_addr
, 
æags
)

270 
s
 = 
ANET_ERR
, 
rv
;

271 
pÜt¡r
[6];

272 
addršfo
 
hšts
, *
£rvšfo
, *
b£rvšfo
, *
p
, *
b
;

274 
	`¢´štf
(
pÜt¡r
,ÕÜt¡r),"%d",
pÜt
);

275 
	`mem£t
(&
hšts
,0,(hints));

276 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

277 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

279 ià((
rv
 = 
	`g‘addršfo
(
addr
,
pÜt¡r
,&
hšts
,&
£rvšfo
)) != 0) {

280 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

281  
ANET_ERR
;

283 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

287 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

289 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

290 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
 && 
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

291 
”rÜ
;

292 ià(
sourû_addr
) {

293 
bound
 = 0;

295 ià((
rv
 = 
	`g‘addršfo
(
sourû_addr
, 
NULL
, &
hšts
, &
b£rvšfo
)) != 0)

297 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

298 
’d
;

300 
b
 = 
b£rvšfo
; b !ğ
NULL
; b = b->
ai_Ãxt
) {

301 ià(
	`bšd
(
s
,
b
->
ai_addr
,b->
ai_add¾’
) != -1) {

302 
bound
 = 1;

306 
	`ä“addršfo
(
b£rvšfo
);

307 ià(!
bound
) {

308 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

309 
’d
;

312 ià(
	`cÚÃù
(
s
,
p
->
ai_addr
,p->
ai_add¾’
) == -1) {

315 ià(
”ºo
 =ğ
EINPROGRESS
 && 
æags
 & 
ANET_CONNECT_NONBLOCK
)

316 
’d
;

317 
	`şo£
(
s
);

318 
s
 = 
ANET_ERR
;

324 
’d
;

326 ià(
p
 =ğ
NULL
)

327 
	`ª‘S‘E¼Ü
(
”r
, "ü—tšg sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

329 
”rÜ
:

330 ià(
s
 !ğ
ANET_ERR
) {

331 
	`şo£
(
s
);

332 
s
 = 
ANET_ERR
;

334 
’d
:

335 
	`ä“addršfo
(
£rvšfo
);

336  
s
;

337 
	}
}

339 
	$ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
)

341  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONE
);

342 
	}
}

344 
	$ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
)

346  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
NULL
,
ANET_CONNECT_NONBLOCK
);

347 
	}
}

349 
	$ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
)

351  
	`ª‘TıG’”icCÚÃù
(
”r
,
addr
,
pÜt
,
sourû_addr
,
ANET_CONNECT_NONBLOCK
);

352 
	}
}

354 
	$ª‘UnixG’”icCÚÃù
(*
”r
, *
·th
, 
æags
)

356 
s
;

357 
sockaddr_un
 
§
;

359 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

360  
ANET_ERR
;

362 
§
.
sun_çmy
 = 
AF_LOCAL
;

363 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

364 ià(
æags
 & 
ANET_CONNECT_NONBLOCK
) {

365 ià(
	`ª‘NÚBlock
(
”r
,
s
è!ğ
ANET_OK
)

366  
ANET_ERR
;

368 ià(
	`cÚÃù
(
s
,(
sockaddr
*)&
§
,(sa)) == -1) {

369 ià(
”ºo
 =ğ
EINPROGRESS
 &&

370 
æags
 & 
ANET_CONNECT_NONBLOCK
)

371  
s
;

373 
	`ª‘S‘E¼Ü
(
”r
, "cÚÃù: %s", 
	`¡»¼Ü
(
”ºo
));

374 
	`şo£
(
s
);

375  
ANET_ERR
;

377  
s
;

378 
	}
}

380 
	$ª‘UnixCÚÃù
(*
”r
, *
·th
)

382  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONE
);

383 
	}
}

385 
	$ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
)

387  
	`ª‘UnixG’”icCÚÃù
(
”r
,
·th
,
ANET_CONNECT_NONBLOCK
);

388 
	}
}

392 
	$ª‘R—d
(
fd
, *
buf
, 
couÁ
)

394 
Ä—d
, 
tÙËn
 = 0;

395 
tÙËn
 !ğ
couÁ
) {

396 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
couÁ
-
tÙËn
);

397 ià(
Ä—d
 =ğ0è 
tÙËn
;

398 ià(
Ä—d
 == -1)  -1;

399 
tÙËn
 +ğ
Ä—d
;

400 
buf
 +ğ
Ä—d
;

402  
tÙËn
;

403 
	}
}

407 
	$ª‘Wr™e
(
fd
, *
buf
, 
couÁ
)

409 
nwr™‹n
, 
tÙËn
 = 0;

410 
tÙËn
 !ğ
couÁ
) {

411 
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
couÁ
-
tÙËn
);

412 ià(
nwr™‹n
 =ğ0è 
tÙËn
;

413 ià(
nwr™‹n
 == -1)  -1;

414 
tÙËn
 +ğ
nwr™‹n
;

415 
buf
 +ğ
nwr™‹n
;

417  
tÙËn
;

418 
	}
}

420 
	$ª‘Li¡’
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 
Ën
, 
backlog
) {

421 ià(
	`bšd
(
s
,
§
,
Ën
) == -1) {

422 
	`ª‘S‘E¼Ü
(
”r
, "bšd: %s", 
	`¡»¼Ü
(
”ºo
));

423 
	`şo£
(
s
);

424  
ANET_ERR
;

427 ià(
	`li¡’
(
s
, 
backlog
) == -1) {

428 
	`ª‘S‘E¼Ü
(
”r
, "li¡’: %s", 
	`¡»¼Ü
(
”ºo
));

429 
	`şo£
(
s
);

430  
ANET_ERR
;

432  
ANET_OK
;

433 
	}
}

435 
	$ª‘V6OÆy
(*
”r
, 
s
) {

436 
yes
 = 1;

437 ià(
	`£tsockİt
(
s
,
IPPROTO_IPV6
,
IPV6_V6ONLY
,&
yes
,(yes)) == -1) {

438 
	`ª‘S‘E¼Ü
(
”r
, "£tsockİt: %s", 
	`¡»¼Ü
(
”ºo
));

439 
	`şo£
(
s
);

440  
ANET_ERR
;

442  
ANET_OK
;

443 
	}
}

445 
	$_ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
af
, 
backlog
)

447 
s
, 
rv
;

448 
_pÜt
[6];

449 
addršfo
 
hšts
, *
£rvšfo
, *
p
;

451 
	`¢´štf
(
_pÜt
,6,"%d",
pÜt
);

452 
	`mem£t
(&
hšts
,0,(hints));

453 
hšts
.
ai_çmy
 = 
af
;

454 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

455 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

457 ià((
rv
 = 
	`g‘addršfo
(
bšdaddr
,
_pÜt
,&
hšts
,&
£rvšfo
)) != 0) {

458 
	`ª‘S‘E¼Ü
(
”r
, "%s", 
	`gai_¡»¼Ü
(
rv
));

459  
ANET_ERR
;

461 
p
 = 
£rvšfo
;… !ğ
NULL
;… =…->
ai_Ãxt
) {

462 ià((
s
 = 
	`sock‘
(
p
->
ai_çmy
,p->
ai_sockty³
,p->
ai_´ÙocŞ
)) == -1)

465 ià(
af
 =ğ
AF_INET6
 && 
	`ª‘V6OÆy
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

466 ià(
	`ª‘S‘Reu£Addr
(
”r
,
s
è=ğ
ANET_ERR
è
”rÜ
;

467 ià(
	`ª‘Li¡’
(
”r
,
s
,
p
->
ai_addr
,p->
ai_add¾’
,
backlog
è=ğ
ANET_ERR
è
”rÜ
;

468 
’d
;

470 ià(
p
 =ğ
NULL
) {

471 
	`ª‘S‘E¼Ü
(
”r
, "unableo bind socket");

472 
”rÜ
;

475 
”rÜ
:

476 
s
 = 
ANET_ERR
;

477 
’d
:

478 
	`ä“addršfo
(
£rvšfo
);

479  
s
;

480 
	}
}

482 
	$ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

484  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET
, 
backlog
);

485 
	}
}

487 
	$ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
)

489  
	`_ª‘TıS”v”
(
”r
, 
pÜt
, 
bšdaddr
, 
AF_INET6
, 
backlog
);

490 
	}
}

492 
	$ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
)

494 
s
;

495 
sockaddr_un
 
§
;

497 ià((
s
 = 
	`ª‘C»©eSock‘
(
”r
,
AF_LOCAL
)è=ğ
ANET_ERR
)

498  
ANET_ERR
;

500 
	`mem£t
(&
§
,0,(sa));

501 
§
.
sun_çmy
 = 
AF_LOCAL
;

502 
	`¡ºıy
(
§
.
sun_·th
,
·th
,(sa.sun_path)-1);

503 ià(
	`ª‘Li¡’
(
”r
,
s
,(
sockaddr
*)&
§
,(§),
backlog
è=ğ
ANET_ERR
)

504  
ANET_ERR
;

505 ià(
³rm
)

506 
	`chmod
(
§
.
sun_·th
, 
³rm
);

507  
s
;

508 
	}
}

510 
	$ª‘G’”icAcû±
(*
”r
, 
s
, 
sockaddr
 *
§
, 
sockËn_t
 *
Ën
) {

511 
fd
;

513 
fd
 = 
	`acû±
(
s
,
§
,
Ën
);

514 ià(
fd
 == -1) {

515 ià(
”ºo
 =ğ
EINTR
)

518 
	`ª‘S‘E¼Ü
(
”r
, "acû±: %s", 
	`¡»¼Ü
(
”ºo
));

519  
ANET_ERR
;

524  
fd
;

525 
	}
}

527 
	$ª‘TıAcû±
(*
”r
, 
s
, *

, 
size_t
 
_Ën
, *
pÜt
) {

528 
fd
;

529 
sockaddr_¡Üage
 
§
;

530 
sockËn_t
 
§Ën
 = (
§
);

531 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

532  
ANET_ERR
;

534 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

535 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

536 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

537 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

539 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

540 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

541 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

543  
fd
;

544 
	}
}

546 
	$ª‘UnixAcû±
(*
”r
, 
s
) {

547 
fd
;

548 
sockaddr_un
 
§
;

549 
sockËn_t
 
§Ën
 = (
§
);

550 ià((
fd
 = 
	`ª‘G’”icAcû±
(
”r
,
s
,(
sockaddr
*)&
§
,&
§Ën
)) == -1)

551  
ANET_ERR
;

553  
fd
;

554 
	}
}

556 
	$ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

557 
sockaddr_¡Üage
 
§
;

558 
sockËn_t
 
§Ën
 = (
§
);

560 ià(
	`g‘³”Çme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
è=ğ-1è
”rÜ
;

561 ià(
_Ën
 =ğ0è
”rÜ
;

563 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

564 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

565 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

566 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

567 } ià(
§
.
ss_çmy
 =ğ
AF_INET6
) {

568 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

569 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

570 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

571 } ià(
§
.
ss_çmy
 =ğ
AF_UNIX
) {

572 ià(

è
	`¡ºıy
(,"/unixsock‘",
_Ën
);

573 ià(
pÜt
) *port = 0;

575 
”rÜ
;

579 
”rÜ
:

580 ià(

) {

581 ià(
_Ën
 >= 2) {

582 

[0] = '?';

583 

[1] = '\0';

584 } ià(
_Ën
 == 1) {

585 

[0] = '\0';

588 ià(
pÜt
) *port = 0;

590 
	}
}

592 
	$ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
) {

593 
sockaddr_¡Üage
 
§
;

594 
sockËn_t
 
§Ën
 = (
§
);

596 ià(
	`g‘sockÇme
(
fd
,(
sockaddr
*)&
§
,&
§Ën
) == -1) {

597 ià(
pÜt
) *port = 0;

598 

[0] = '?';

599 

[1] = '\0';

602 ià(
§
.
ss_çmy
 =ğ
AF_INET
) {

603 
sockaddr_š
 *
s
 = (sockaddr_š *)&
§
;

604 ià(

è
	`š‘_Áİ
(
AF_INET
,(*)&(
s
->
sš_addr
),,
_Ën
);

605 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš_pÜt
);

607 
sockaddr_š6
 *
s
 = (sockaddr_š6 *)&
§
;

608 ià(

è
	`š‘_Áİ
(
AF_INET6
,(*)&(
s
->
sš6_addr
),,
_Ën
);

609 ià(
pÜt
è*pÜˆğ
	`Áohs
(
s
->
sš6_pÜt
);

612 
	}
}

	@anet.h

31 #iâdeà
ANET_H


32 
	#ANET_H


	)

34 
	#ANET_OK
 0

	)

35 
	#ANET_ERR
 -1

	)

36 
	#ANET_ERR_LEN
 256

	)

39 
	#ANET_NONE
 0

	)

40 
	#ANET_IP_ONLY
 (1<<0)

	)

42 #ià
defšed
(
__sun
è|| defšed(
_AIX
)

43 
	#AF_LOCAL
 
AF_UNIX


	)

46 #ifdeà
_AIX


47 #undeà
_Ën


50 
ª‘TıCÚÃù
(*
”r
, *
addr
, 
pÜt
);

51 
ª‘TıNÚBlockCÚÃù
(*
”r
, *
addr
, 
pÜt
);

52 
ª‘TıNÚBlockBšdCÚÃù
(*
”r
, *
addr
, 
pÜt
, *
sourû_addr
);

53 
ª‘UnixCÚÃù
(*
”r
, *
·th
);

54 
ª‘UnixNÚBlockCÚÃù
(*
”r
, *
·th
);

55 
ª‘R—d
(
fd
, *
buf
, 
couÁ
);

56 
ª‘ResŞve
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

57 
ª‘ResŞveIP
(*
”r
, *
ho¡
, *
buf
, 
size_t
 
buf_Ën
);

58 
ª‘TıS”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

59 
ª‘Tı6S”v”
(*
”r
, 
pÜt
, *
bšdaddr
, 
backlog
);

60 
ª‘UnixS”v”
(*
”r
, *
·th
, 
mode_t
 
³rm
, 
backlog
);

61 
ª‘TıAcû±
(*
”r
, 
£rv”sock
, *

, 
size_t
 
_Ën
, *
pÜt
);

62 
ª‘UnixAcû±
(*
”r
, 
£rv”sock
);

63 
ª‘Wr™e
(
fd
, *
buf
, 
couÁ
);

64 
ª‘NÚBlock
(*
”r
, 
fd
);

65 
ª‘Block
(*
”r
, 
fd
);

66 
ª‘EÇbËTıNoD–ay
(*
”r
, 
fd
);

67 
ª‘Di§bËTıNoD–ay
(*
”r
, 
fd
);

68 
ª‘TıK“pAlive
(*
”r
, 
fd
);

69 
ª‘S’dTimeout
(*
”r
, 
fd
, 
ms
);

70 
ª‘P“rToSŒšg
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

71 
ª‘K“pAlive
(*
”r
, 
fd
, 
š‹rv®
);

72 
ª‘SockName
(
fd
, *

, 
size_t
 
_Ën
, *
pÜt
);

	@aof.c

30 
	~"»dis.h
"

31 
	~"bio.h
"

32 
	~"rio.h
"

34 
	~<sigÇl.h
>

35 
	~<fú.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/time.h
>

39 
	~<sys/»sourû.h
>

40 
	~<sys/wa™.h
>

42 
aofUpd©eCu¼’tSize
();

43 
aofClo£Pes
();

59 
	#AOF_RW_BUF_BLOCK_SIZE
 (1024*1024*10è

	)

61 
	saoäwblock
 {

62 
	mu£d
, 
	mä“
;

63 
	mbuf
[
AOF_RW_BUF_BLOCK_SIZE
];

64 } 
	taoäwblock
;

69 
	$aofRewr™eBufãrRe£t
() {

70 ià(
£rv”
.
aof_»wr™e_buf_blocks
)

71 
	`li¡R–—£
(
£rv”
.
aof_»wr™e_buf_blocks
);

73 
£rv”
.
aof_»wr™e_buf_blocks
 = 
	`li¡C»©e
();

74 
	`li¡S‘F»eM‘hod
(
£rv”
.
aof_»wr™e_buf_blocks
,
zä“
);

75 
	}
}

78 
	$aofRewr™eBufãrSize
() {

79 
li¡Node
 *
Ê
;

80 
li¡I‹r
 
li
;

81 
size
 = 0;

83 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

84 (
Ê
 = 
	`li¡Next
(&
li
))) {

85 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

86 
size
 +ğ
block
->
u£d
;

88  
size
;

89 
	}
}

94 
	$aofChdWr™eDiffD©a
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

95 
li¡Node
 *
Ê
;

96 
aoäwblock
 *
block
;

97 
ssize_t
 
nwr™‹n
;

98 
	`REDIS_NOTUSED
(
–
);

99 
	`REDIS_NOTUSED
(
fd
);

100 
	`REDIS_NOTUSED
(
´ivd©a
);

101 
	`REDIS_NOTUSED
(
mask
);

104 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

105 
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

106 ià(
£rv”
.
aof_¡İ_£ndšg_diff
 || !
block
) {

107 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,

108 
AE_WRITABLE
);

111 ià(
block
->
u£d
 > 0) {

112 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
,

113 
block
->
buf
,block->
u£d
);

114 ià(
nwr™‹n
 <= 0) ;

115 
	`memmove
(
block
->
buf
,block->buf+
nwr™‹n
,block->
u£d
-nwritten);

116 
block
->
u£d
 -ğ
nwr™‹n
;

118 ià(
block
->
u£d
 =ğ0è
	`li¡D–Node
(
£rv”
.
aof_»wr™e_buf_blocks
,
Ê
);

120 
	}
}

123 
	$aofRewr™eBufãrAµ’d
(*
s
, 
Ën
) {

124 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
aof_»wr™e_buf_blocks
);

125 
aoäwblock
 *
block
 = 
Ê
 ?†n->
v®ue
 : 
NULL
;

127 
Ën
) {

130 ià(
block
) {

131 
thi¦’
 = (
block
->
ä“
 < 
Ën
) ? block->free :†en;

132 ià(
thi¦’
) {

133 
	`memıy
(
block
->
buf
+block->
u£d
, 
s
, 
thi¦’
);

134 
block
->
u£d
 +ğ
thi¦’
;

135 
block
->
ä“
 -ğ
thi¦’
;

136 
s
 +ğ
thi¦’
;

137 
Ën
 -ğ
thi¦’
;

141 ià(
Ën
) {

142 
numblocks
;

144 
block
 = 
	`zm®loc
((*block));

145 
block
->
ä“
 = 
AOF_RW_BUF_BLOCK_SIZE
;

146 
block
->
u£d
 = 0;

147 
	`li¡AddNodeTa
(
£rv”
.
aof_»wr™e_buf_blocks
,
block
);

151 
numblocks
 = 
	`li¡L’gth
(
£rv”
.
aof_»wr™e_buf_blocks
);

152 ià(((
numblocks
+1) % 10) == 0) {

153 
Ëv–
 = ((
numblocks
+1è% 100è=ğ0 ? 
REDIS_WARNING
 :

154 
REDIS_NOTICE
;

155 
	`»disLog
(
Ëv–
,"Background AOF buffer size: %lu MB",

156 
	`aofRewr™eBufãrSize
()/(1024*1024));

163 ià(
	`«G‘FeEv’ts
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
) == 0) {

164 
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
aof_pe_wr™e_d©a_to_chd
,

165 
AE_WRITABLE
, 
aofChdWr™eDiffD©a
, 
NULL
);

167 
	}
}

172 
ssize_t
 
	$aofRewr™eBufãrWr™e
(
fd
) {

173 
li¡Node
 *
Ê
;

174 
li¡I‹r
 
li
;

175 
ssize_t
 
couÁ
 = 0;

177 
	`li¡Rewšd
(
£rv”
.
aof_»wr™e_buf_blocks
,&
li
);

178 (
Ê
 = 
	`li¡Next
(&
li
))) {

179 
aoäwblock
 *
block
 = 
	`li¡NodeV®ue
(
Ê
);

180 
ssize_t
 
nwr™‹n
;

182 ià(
block
->
u£d
) {

183 
nwr™‹n
 = 
	`wr™e
(
fd
,
block
->
buf
,block->
u£d
);

184 ià(
nwr™‹n
 !ğ(
ssize_t
)
block
->
u£d
) {

185 ià(
nwr™‹n
 =ğ0è
”ºo
 = 
EIO
;

188 
couÁ
 +ğ
nwr™‹n
;

191  
couÁ
;

192 
	}
}

200 
	$aof_background_fsync
(
fd
) {

201 
	`bioC»©eBackgroundJob
(
REDIS_BIO_AOF_FSYNC
,(*)()
fd
,
NULL
,NULL);

202 
	}
}

206 
	$¡İAµ’dOÆy
() {

207 
	`»disAs£¹
(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
);

208 
	`æushAµ’dOÆyFe
(1);

209 
	`aof_fsync
(
£rv”
.
aof_fd
);

210 
	`şo£
(
£rv”
.
aof_fd
);

212 
£rv”
.
aof_fd
 = -1;

213 
£rv”
.
aof_£Ëùed_db
 = -1;

214 
£rv”
.
aof_¡©e
 = 
REDIS_AOF_OFF
;

216 ià(
£rv”
.
aof_chd_pid
 != -1) {

217 
¡©loc
;

219 
	`»disLog
(
REDIS_NOTICE
,"Killing„unning AOF„ewrite child: %ld",

220 (è
£rv”
.
aof_chd_pid
);

221 ià(
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
) != -1)

222 
	`wa™3
(&
¡©loc
,0,
NULL
);

224 
	`aofRewr™eBufãrRe£t
();

225 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

226 
£rv”
.
aof_chd_pid
 = -1;

227 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

229 
	`aofClo£Pes
();

231 
	}
}

235 
	$¡¬tAµ’dOÆy
() {

236 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

237 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

238 
	`»disAs£¹
(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_OFF
);

239 ià(
£rv”
.
aof_fd
 == -1) {

240 
	`»disLog
(
REDIS_WARNING
,"Redi Ãed tØ’abËhAOF buˆÿn'ˆİ’h­³nd oÆy fe: %s",
	`¡»¼Ü
(
”ºo
));

241  
REDIS_ERR
;

243 ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
REDIS_ERR
) {

244 
	`şo£
(
£rv”
.
aof_fd
);

245 
	`»disLog
(
REDIS_WARNING
,"Redis‚eedsoƒnablehe AOF but can'trigger‡ background AOF„ewrite operation. Checkhe‡bove†ogs for more info‡boutheƒrror.");

246  
REDIS_ERR
;

250 
£rv”
.
aof_¡©e
 = 
REDIS_AOF_WAIT_REWRITE
;

251  
REDIS_OK
;

252 
	}
}

272 
	#AOF_WRITE_LOG_ERROR_RATE
 30

	)

273 
	$æushAµ’dOÆyFe
(
fÜû
) {

274 
ssize_t
 
nwr™‹n
;

275 
sync_š_´og»ss
 = 0;

276 
m¡ime_t
 
Ï‹ncy
;

278 ià(
	`sd¦’
(
£rv”
.
aof_buf
) == 0) ;

280 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

281 
sync_š_´og»ss
 = 
	`bioP’dšgJobsOfTy³
(
REDIS_BIO_AOF_FSYNC
) != 0;

283 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 && !
fÜû
) {

287 ià(
sync_š_´og»ss
) {

288 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
 == 0) {

291 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = s”v”.
unixtime
;

293 } ià(
£rv”
.
unixtime
 - s”v”.
aof_æush_po¡pÚed_¡¬t
 < 2) {

300 
£rv”
.
aof_d–ayed_fsync
++;

301 
	`»disLog
(
REDIS_NOTICE
,"Asynchronous AOF fsync isakingoo†ong (disk is busy?). Writinghe AOF buffer without waiting for fsynco complete,his may slow down Redis.");

310 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

311 
nwr™‹n
 = 
	`wr™e
(
£rv”
.
aof_fd
,£rv”.
aof_buf
,
	`sd¦’
(server.aof_buf));

312 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

318 ià(
sync_š_´og»ss
) {

319 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-³ndšg-fsync",
Ï‹ncy
);

320 } ià(
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1) {

321 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-aùive-chd",
Ï‹ncy
);

323 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e-®Úe",
Ï‹ncy
);

325 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-wr™e",
Ï‹ncy
);

328 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

330 ià(
nwr™‹n
 !ğ(sigÃd)
	`sd¦’
(
£rv”
.
aof_buf
)) {

331 
time_t
 
Ï¡_wr™e_”rÜ_log
 = 0;

332 
ÿn_log
 = 0;

335 ià((
£rv”
.
unixtime
 - 
Ï¡_wr™e_”rÜ_log
è> 
AOF_WRITE_LOG_ERROR_RATE
) {

336 
ÿn_log
 = 1;

337 
Ï¡_wr™e_”rÜ_log
 = 
£rv”
.
unixtime
;

341 ià(
nwr™‹n
 == -1) {

342 ià(
ÿn_log
) {

343 
	`»disLog
(
REDIS_WARNING
,"Error writingohe AOF file: %s",

344 
	`¡»¼Ü
(
”ºo
));

345 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
”ºo
;

348 ià(
ÿn_log
) {

349 
	`»disLog
(
REDIS_WARNING
,"Short write while writingo "

352 ()
nwr™‹n
,

353 ()
	`sd¦’
(
£rv”
.
aof_buf
));

356 ià(
	`árunÿ‹
(
£rv”
.
aof_fd
, s”v”.
aof_cu¼’t_size
) == -1) {

357 ià(
ÿn_log
) {

358 
	`»disLog
(
REDIS_WARNING
, "Could‚ot„emove short write "

361 "árunÿ‹: %s", 
	`¡»¼Ü
(
”ºo
));

366 
nwr™‹n
 = -1;

368 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 
ENOSPC
;

372 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

377 
	`»disLog
(
REDIS_WARNING
,"Can't„ecover from AOF writeƒrror whenhe AOF fsync…olicy is 'always'. Exiting...");

378 
	`ex™
(1);

383 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
REDIS_ERR
;

387 ià(
nwr™‹n
 > 0) {

388 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

389 
	`sd¤ªge
(
£rv”
.
aof_buf
,
nwr™‹n
,-1);

396 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
REDIS_ERR
) {

397 
	`»disLog
(
REDIS_WARNING
,

399 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
REDIS_OK
;

402 
£rv”
.
aof_cu¼’t_size
 +ğ
nwr™‹n
;

406 ià((
	`sd¦’
(
£rv”
.
aof_buf
)+
	`sd§va
(server.aof_buf)) < 4000) {

407 
	`sdsş—r
(
£rv”
.
aof_buf
);

409 
	`sdsä“
(
£rv”
.
aof_buf
);

410 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

415 ià(
£rv”
.
aof_no_fsync_Ú_»wr™e
 &&

416 (
£rv”
.
aof_chd_pid
 !ğ-1 || s”v”.
rdb_chd_pid
 != -1))

420 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

423 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

424 
	`aof_fsync
(
£rv”
.
aof_fd
);

425 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

426 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-fsync-®ways",
Ï‹ncy
);

427 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

428 } ià((
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
 &&

429 
£rv”
.
unixtime
 > s”v”.
aof_Ï¡_fsync
)) {

430 ià(!
sync_š_´og»ss
è
	`aof_background_fsync
(
£rv”
.
aof_fd
);

431 
£rv”
.
aof_Ï¡_fsync
 = s”v”.
unixtime
;

433 
	}
}

435 
sds
 
	$ÿtAµ’dOÆyG’”icCommªd
(
sds
 
d¡
, 
¬gc
, 
robj
 **
¬gv
) {

436 
buf
[32];

437 
Ën
, 
j
;

438 
robj
 *
o
;

440 
buf
[0] = '*';

441 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
¬gc
);

442 
buf
[
Ën
++] = '\r';

443 
buf
[
Ën
++] = '\n';

444 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

446 
j
 = 0; j < 
¬gc
; j++) {

447 
o
 = 
	`g‘DecodedObjeù
(
¬gv
[
j
]);

448 
buf
[0] = '$';

449 
Ën
 = 1+
	`Î2¡ršg
(
buf
+1,(buf)-1,
	`sd¦’
(
o
->
±r
));

450 
buf
[
Ën
++] = '\r';

451 
buf
[
Ën
++] = '\n';

452 
d¡
 = 
	`sdsÿ’
(d¡,
buf
,
Ën
);

453 
d¡
 = 
	`sdsÿ’
(d¡,
o
->
±r
,
	`sd¦’
(o->ptr));

454 
d¡
 = 
	`sdsÿ’
(dst,"\r\n",2);

455 
	`deüRefCouÁ
(
o
);

457  
d¡
;

458 
	}
}

467 
sds
 
	$ÿtAµ’dOÆyExpœeAtCommªd
(
sds
 
buf
, 
»disCommªd
 *
cmd
, 
robj
 *
key
,„obj *
£cÚds
) {

468 
wh’
;

469 
robj
 *
¬gv
[3];

472 
£cÚds
 = 
	`g‘DecodedObjeù
(seconds);

473 
wh’
 = 
	`¡¹Şl
(
£cÚds
->
±r
,
NULL
,10);

475 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
£‹xCommªd
 ||

476 
cmd
->
´oc
 =ğ
expœ—tCommªd
)

478 
wh’
 *= 1000;

481 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

482 
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
)

484 
wh’
 +ğ
	`m¡ime
();

486 
	`deüRefCouÁ
(
£cÚds
);

488 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PEXPIREAT",9);

489 
¬gv
[1] = 
key
;

490 
¬gv
[2] = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
wh’
);

491 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf, 3, 
¬gv
);

492 
	`deüRefCouÁ
(
¬gv
[0]);

493 
	`deüRefCouÁ
(
¬gv
[2]);

494  
buf
;

495 
	}
}

497 
	$ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

498 
sds
 
buf
 = 
	`sd£m±y
();

499 
robj
 *
tm·rgv
[3];

503 ià(
diùid
 !ğ
£rv”
.
aof_£Ëùed_db
) {

504 
£ldb
[64];

506 
	`¢´štf
(
£ldb
,(£ldb),"%d",
diùid
);

507 
buf
 = 
	`sdsÿrštf
(buf,"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n",

508 ()
	`¡¾’
(
£ldb
),seldb);

509 
£rv”
.
aof_£Ëùed_db
 = 
diùid
;

512 ià(
cmd
->
´oc
 =ğ
expœeCommªd
 || cmd->´oø=ğ
³xpœeCommªd
 ||

513 
cmd
->
´oc
 =ğ
expœ—tCommªd
) {

515 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

516 } ià(
cmd
->
´oc
 =ğ
£‹xCommªd
 || cmd->´oø=ğ
p£‹xCommªd
) {

518 
tm·rgv
[0] = 
	`ü—‹SŒšgObjeù
("SET",3);

519 
tm·rgv
[1] = 
¬gv
[1];

520 
tm·rgv
[2] = 
¬gv
[3];

521 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,3,
tm·rgv
);

522 
	`deüRefCouÁ
(
tm·rgv
[0]);

523 
buf
 = 
	`ÿtAµ’dOÆyExpœeAtCommªd
(buf,
cmd
,
¬gv
[1],argv[2]);

528 
buf
 = 
	`ÿtAµ’dOÆyG’”icCommªd
(buf,
¬gc
,
¬gv
);

534 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_ON
)

535 
£rv”
.
aof_buf
 = 
	`sdsÿ’
(£rv”.aof_buf,
buf
,
	`sd¦’
(buf));

541 ià(
£rv”
.
aof_chd_pid
 != -1)

542 
	`aofRewr™eBufãrAµ’d
((*)
buf
,
	`sd¦’
(buf));

544 
	`sdsä“
(
buf
);

545 
	}
}

553 
»disCl›Á
 *
	$ü—‹FakeCl›Á
() {

554 
»disCl›Á
 *
c
 = 
	`zm®loc
((*c));

556 
	`£ËùDb
(
c
,0);

557 
c
->
fd
 = -1;

558 
c
->
Çme
 = 
NULL
;

559 
c
->
qu”ybuf
 = 
	`sd£m±y
();

560 
c
->
qu”ybuf_³ak
 = 0;

561 
c
->
¬gc
 = 0;

562 
c
->
¬gv
 = 
NULL
;

563 
c
->
buåos
 = 0;

564 
c
->
æags
 = 0;

565 
c
->
bty³
 = 
REDIS_BLOCKED_NONE
;

568 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_START
;

569 
c
->
»¶y
 = 
	`li¡C»©e
();

570 
c
->
»¶y_by‹s
 = 0;

571 
c
->
obuf_soá_lim™_»ached_time
 = 0;

572 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

573 
c
->
³”id
 = 
NULL
;

574 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
deüRefCouÁVoid
);

575 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

576 
	`š™Cl›ÁMuÉiS‹
(
c
);

577  
c
;

578 
	}
}

580 
	$ä“FakeCl›ÁArgv
(
»disCl›Á
 *
c
) {

581 
j
;

583 
j
 = 0; j < 
c
->
¬gc
; j++)

584 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

585 
	`zä“
(
c
->
¬gv
);

586 
	}
}

588 
	$ä“FakeCl›Á
(
»disCl›Á
 *
c
) {

589 
	`sdsä“
(
c
->
qu”ybuf
);

590 
	`li¡R–—£
(
c
->
»¶y
);

591 
	`li¡R–—£
(
c
->
w©ched_keys
);

592 
	`ä“Cl›ÁMuÉiS‹
(
c
);

593 
	`zä“
(
c
);

594 
	}
}

599 
	$lßdAµ’dOÆyFe
(*
f’ame
) {

600 
»disCl›Á
 *
çkeCl›Á
;

601 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

602 
»dis_¡©
 
sb
;

603 
Şd_aof_¡©e
 = 
£rv”
.
aof_¡©e
;

604 
loİs
 = 0;

605 
off_t
 
v®id_up_to
 = 0;

607 ià(
å
 && 
	`»dis_f¡©
(
	`f’o
(å),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

608 
£rv”
.
aof_cu¼’t_size
 = 0;

609 
	`fşo£
(
å
);

610  
REDIS_ERR
;

613 ià(
å
 =ğ
NULL
) {

614 
	`»disLog
(
REDIS_WARNING
,"F©®ƒ¼Ü: cª'ˆİ’h­³nd†og ffÜ„—dšg: %s",
	`¡»¼Ü
(
”ºo
));

615 
	`ex™
(1);

620 
£rv”
.
aof_¡©e
 = 
REDIS_AOF_OFF
;

622 
çkeCl›Á
 = 
	`ü—‹FakeCl›Á
();

623 
	`¡¬tLßdšg
(
å
);

626 
¬gc
, 
j
;

627 
Ën
;

628 
robj
 **
¬gv
;

629 
buf
[128];

630 
sds
 
¬gsds
;

631 
»disCommªd
 *
cmd
;

634 ià(!(
loİs
++ % 1000)) {

635 
	`lßdšgProg»ss
(
	`á–lo
(
å
));

636 
	`´oûssEv’tsWheBlocked
();

639 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

640 ià(
	`ãof
(
å
))

643 
»ad”r
;

645 ià(
buf
[0] !ğ'*'è
fm‹¼
;

646 ià(
buf
[1] =ğ'\0'è
»ad”r
;

647 
¬gc
 = 
	`©oi
(
buf
+1);

648 ià(
¬gc
 < 1è
fm‹¼
;

650 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

651 
çkeCl›Á
->
¬gc
 =‡rgc;

652 
çkeCl›Á
->
¬gv
 =‡rgv;

654 
j
 = 0; j < 
¬gc
; j++) {

655 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

656 
çkeCl›Á
->
¬gc
 = 
j
;

657 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

658 
»ad”r
;

660 ià(
buf
[0] !ğ'$'è
fm‹¼
;

661 
Ën
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

662 
¬gsds
 = 
	`sd¢ewËn
(
NULL
,
Ën
);

663 ià(
Ën
 && 
	`ä—d
(
¬gsds
,Ën,1,
å
) == 0) {

664 
	`sdsä“
(
¬gsds
);

665 
çkeCl›Á
->
¬gc
 = 
j
;

666 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

667 
»ad”r
;

669 
¬gv
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,
¬gsds
);

670 ià(
	`ä—d
(
buf
,2,1,
å
) == 0) {

671 
çkeCl›Á
->
¬gc
 = 
j
+1;

672 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

673 
»ad”r
;

678 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

679 ià(!
cmd
) {

680 
	`»disLog
(
REDIS_WARNING
,"UnknowÀcommªd '%s'„—dšgh­³nd oÆy fe", (*)
¬gv
[0]->
±r
);

681 
	`ex™
(1);

685 
cmd
->
	`´oc
(
çkeCl›Á
);

688 
	`»disAs£¹
(
çkeCl›Á
->
buåos
 =ğ0 && 
	`li¡L’gth
(çkeCl›Á->
»¶y
) == 0);

690 
	`»disAs£¹
((
çkeCl›Á
->
æags
 & 
REDIS_BLOCKED
) == 0);

694 
	`ä“FakeCl›ÁArgv
(
çkeCl›Á
);

695 ià(
£rv”
.
aof_lßd_Œunÿ‹d
è
v®id_up_to
 = 
	`á–lo
(
å
);

700 ià(
çkeCl›Á
->
æags
 & 
REDIS_MULTI
è
uxeof
;

702 
lßded_ok
:

703 
	`fşo£
(
å
);

704 
	`ä“FakeCl›Á
(
çkeCl›Á
);

705 
£rv”
.
aof_¡©e
 = 
Şd_aof_¡©e
;

706 
	`¡İLßdšg
();

707 
	`aofUpd©eCu¼’tSize
();

708 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

709  
REDIS_OK
;

711 
»ad”r
:

712 ià(!
	`ãof
(
å
)) {

713 
	`»disLog
(
REDIS_WARNING
,"UÄecov”abËƒ¼Ü„—dšgh­³nd oÆy fe: %s", 
	`¡»¼Ü
(
”ºo
));

714 
	`ex™
(1);

717 
uxeof
:

718 ià(
£rv”
.
aof_lßd_Œunÿ‹d
) {

719 
	`»disLog
(
REDIS_WARNING
,"!!! Warning: short„ead while†oadinghe AOF file !!!");

720 
	`»disLog
(
REDIS_WARNING
,"!!! Truncatinghe AOF‡t offset %llu !!!",

721 (è
v®id_up_to
);

722 ià(
v®id_up_to
 =ğ-1 || 
	`Œunÿ‹
(
f’ame
,valid_up_to) == -1) {

723 ià(
v®id_up_to
 == -1) {

724 
	`»disLog
(
REDIS_WARNING
,"Last valid command offset is invalid");

726 
	`»disLog
(
REDIS_WARNING
,"Errorruncatinghe AOF file: %s",

727 
	`¡»¼Ü
(
”ºo
));

732 ià(
£rv”
.
aof_fd
 !ğ-1 && 
	`l£ek
(£rv”.aof_fd,0,
SEEK_END
) == -1) {

733 
	`»disLog
(
REDIS_WARNING
,"Can't seekheƒnd ofhe AOF file: %s",

734 
	`¡»¼Ü
(
”ºo
));

736 
	`»disLog
(
REDIS_WARNING
,

738 
lßded_ok
;

742 
	`»disLog
(
REDIS_WARNING
,"Unexpectedƒnd of file„eadinghe‡ppend only file. You can: 1) Make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>. 2) Alternatively you can sethe 'aof-load-truncated' configuration optiono yes‡nd„estarthe server.");

743 
	`ex™
(1);

745 
fm‹¼
:

746 
	`»disLog
(
REDIS_WARNING
,"Bad file format„eadinghe‡ppend only file: make‡ backup of your AOF file,hen use ./redis-check-aof --fix <filename>");

747 
	`ex™
(1);

748 
	}
}

756 
	$rioWr™eBulkObjeù
(
rio
 *
r
, 
robj
 *
obj
) {

759 ià(
obj
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

760  
	`rioWr™eBulkLÚgLÚg
(
r
,()
obj
->
±r
);

761 } ià(
	`sdsEncodedObjeù
(
obj
)) {

762  
	`rioWr™eBulkSŒšg
(
r
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

764 
	`»disPªic
("Unknown stringƒncoding");

766 
	}
}

770 
	$»wr™eLi¡Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

771 
couÁ
 = 0, 
™ems
 = 
	`li¡Ty³L’gth
(
o
);

773 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

774 *
zl
 = 
o
->
±r
;

775 *
p
 = 
	`zli¡Index
(
zl
,0);

776 *
v¡r
;

777 
vËn
;

778 
vlÚg
;

780 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

781 ià(
couÁ
 == 0) {

782 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

783 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

785 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

786 ià(
	`rioWr™eBulkSŒšg
(
r
,"RPUSH",5) == 0)  0;

787 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

789 ià(
v¡r
) {

790 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
v¡r
,
vËn
) == 0)  0;

792 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
vlÚg
) == 0)  0;

794 
p
 = 
	`zli¡Next
(
zl
,p);

795 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

796 
™ems
--;

798 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

799 
li¡
 *li¡ = 
o
->
±r
;

800 
li¡Node
 *
Ê
;

801 
li¡I‹r
 
li
;

803 
	`li¡Rewšd
(
li¡
,&
li
);

804 (
Ê
 = 
	`li¡Next
(&
li
))) {

805 
robj
 *
–eobj
 = 
	`li¡NodeV®ue
(
Ê
);

807 ià(
couÁ
 == 0) {

808 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

809 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

811 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

812 ià(
	`rioWr™eBulkSŒšg
(
r
,"RPUSH",5) == 0)  0;

813 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

815 ià(
	`rioWr™eBulkObjeù
(
r
,
–eobj
) == 0)  0;

816 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

817 
™ems
--;

820 
	`»disPªic
("Unknown†istƒncoding");

823 
	}
}

827 
	$»wr™eS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

828 
couÁ
 = 0, 
™ems
 = 
	`£tTy³Size
(
o
);

830 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

831 
ii
 = 0;

832 
št64_t
 
Îv®
;

834 
	`št£tG‘
(
o
->
±r
,
ii
++,&
Îv®
)) {

835 ià(
couÁ
 == 0) {

836 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

837 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

839 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

840 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

841 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

843 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
Îv®
) == 0)  0;

844 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

845 
™ems
--;

847 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

848 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

849 
diùEÁry
 *
de
;

851 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

852 
robj
 *
–eobj
 = 
	`diùG‘Key
(
de
);

853 ià(
couÁ
 == 0) {

854 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

855 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

857 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
) == 0)  0;

858 ià(
	`rioWr™eBulkSŒšg
(
r
,"SADD",4) == 0)  0;

859 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

861 ià(
	`rioWr™eBulkObjeù
(
r
,
–eobj
) == 0)  0;

862 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

863 
™ems
--;

865 
	`diùR–—£I‹¿tÜ
(
di
);

867 
	`»disPªic
("Unknown setƒncoding");

870 
	}
}

874 
	$»wr™eSÜ‹dS‘Objeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

875 
couÁ
 = 0, 
™ems
 = 
	`z£tL’gth
(
o
);

877 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

878 *
zl
 = 
o
->
±r
;

879 *
•Œ
, *
¥Œ
;

880 *
v¡r
;

881 
vËn
;

882 
vÎ
;

883 
scÜe
;

885 
•Œ
 = 
	`zli¡Index
(
zl
,0);

886 
	`»disAs£¹
(
•Œ
 !ğ
NULL
);

887 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

888 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

890 
•Œ
 !ğ
NULL
) {

891 
	`»disAs£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

892 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

894 ià(
couÁ
 == 0) {

895 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

896 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

898 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

899 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

900 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

902 ià(
	`rioWr™eBulkDoubË
(
r
,
scÜe
) == 0)  0;

903 ià(
v¡r
 !ğ
NULL
) {

904 ià(
	`rioWr™eBulkSŒšg
(
r
,(*)
v¡r
,
vËn
) == 0)  0;

906 ià(
	`rioWr™eBulkLÚgLÚg
(
r
,
vÎ
) == 0)  0;

908 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

909 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

910 
™ems
--;

912 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

913 
z£t
 *
zs
 = 
o
->
±r
;

914 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

915 
diùEÁry
 *
de
;

917 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

918 
robj
 *
–eobj
 = 
	`diùG‘Key
(
de
);

919 *
scÜe
 = 
	`diùG‘V®
(
de
);

921 ià(
couÁ
 == 0) {

922 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

923 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

925 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

926 ià(
	`rioWr™eBulkSŒšg
(
r
,"ZADD",4) == 0)  0;

927 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

929 ià(
	`rioWr™eBulkDoubË
(
r
,*
scÜe
) == 0)  0;

930 ià(
	`rioWr™eBulkObjeù
(
r
,
–eobj
) == 0)  0;

931 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

932 
™ems
--;

934 
	`diùR–—£I‹¿tÜ
(
di
);

936 
	`»disPªic
("Unknown sorted zsetƒncoding");

939 
	}
}

947 
	$rioWr™eHashI‹¿tÜCursÜ
(
rio
 *
r
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

948 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

949 *
v¡r
 = 
NULL
;

950 
vËn
 = 
UINT_MAX
;

951 
vÎ
 = 
LLONG_MAX
;

953 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

954 ià(
v¡r
) {

955  
	`rioWr™eBulkSŒšg
(
r
, (*)
v¡r
, 
vËn
);

957  
	`rioWr™eBulkLÚgLÚg
(
r
, 
vÎ
);

960 } ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

961 
robj
 *
v®ue
;

963 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
v®ue
);

964  
	`rioWr™eBulkObjeù
(
r
, 
v®ue
);

967 
	`»disPªic
("Unknown hashƒncoding");

969 
	}
}

973 
	$»wr™eHashObjeù
(
rio
 *
r
, 
robj
 *
key
,„obj *
o
) {

974 
hashTy³I‹¿tÜ
 *
hi
;

975 
couÁ
 = 0, 
™ems
 = 
	`hashTy³L’gth
(
o
);

977 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

978 
	`hashTy³Next
(
hi
è!ğ
REDIS_ERR
) {

979 ià(
couÁ
 == 0) {

980 
cmd_™ems
 = (
™ems
 > 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) ?

981 
REDIS_AOF_REWRITE_ITEMS_PER_CMD
 : 
™ems
;

983 ià(
	`rioWr™eBulkCouÁ
(
r
,'*',2+
cmd_™ems
*2) == 0)  0;

984 ià(
	`rioWr™eBulkSŒšg
(
r
,"HMSET",5) == 0)  0;

985 ià(
	`rioWr™eBulkObjeù
(
r
,
key
) == 0)  0;

988 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
REDIS_HASH_KEY
) == 0)  0;

989 ià(
	`rioWr™eHashI‹¿tÜCursÜ
(
r
, 
hi
, 
REDIS_HASH_VALUE
) == 0)  0;

990 ià(++
couÁ
 =ğ
REDIS_AOF_REWRITE_ITEMS_PER_CMD
) count = 0;

991 
™ems
--;

994 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

997 
	}
}

1002 
ssize_t
 
	$aofR—dDiffFromP¬’t
() {

1003 
buf
[65536];

1004 
ssize_t
 
Ä—d
, 
tÙ®
 = 0;

1006 (
Ä—d
 =

1007 
	`»ad
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
,
buf
,(buf))) > 0) {

1008 
£rv”
.
aof_chd_diff
 = 
	`sdsÿ’
(£rv”.aof_chd_diff,
buf
,
Ä—d
);

1009 
tÙ®
 +ğ
Ä—d
;

1011  
tÙ®
;

1012 
	}
}

1021 
	$»wr™eAµ’dOÆyFe
(*
f’ame
) {

1022 
diùI‹¿tÜ
 *
di
 = 
NULL
;

1023 
diùEÁry
 *
de
;

1024 
rio
 
aof
;

1025 
FILE
 *
å
;

1026 
tmpfe
[256];

1027 
j
;

1028 
now
 = 
	`m¡ime
();

1029 
by‹
;

1030 
size_t
 
´oûs£d
 = 0;

1034 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-%d.aof", (è
	`g‘pid
());

1035 
å
 = 
	`fİ’
(
tmpfe
,"w");

1036 ià(!
å
) {

1037 
	`»disLog
(
REDIS_WARNING
, "O³nšgh‹m°ffÜ AOF„ewr™š„ewr™eAµ’dOÆyFe(): %s", 
	`¡»¼Ü
(
”ºo
));

1038  
REDIS_ERR
;

1041 
£rv”
.
aof_chd_diff
 = 
	`sd£m±y
();

1042 
	`rioIn™W™hFe
(&
aof
,
å
);

1043 ià(
£rv”
.
aof_»wr™e_šüem’l_fsync
)

1044 
	`rioS‘AutoSync
(&
aof
,
REDIS_AOF_AUTOSYNC_BYTES
);

1045 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1046 
£Ëùcmd
[] = "*2\r\n$6\r\nSELECT\r\n";

1047 
»disDb
 *
db
 = 
£rv”
.db+
j
;

1048 
diù
 *
d
 = 
db
->dict;

1049 ià(
	`diùSize
(
d
) == 0) ;

1050 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

1051 ià(!
di
) {

1052 
	`fşo£
(
å
);

1053  
REDIS_ERR
;

1057 ià(
	`rioWr™e
(&
aof
,
£Ëùcmd
,(£Ëùcmd)-1è=ğ0è
w”r
;

1058 ià(
	`rioWr™eBulkLÚgLÚg
(&
aof
,
j
è=ğ0è
w”r
;

1061 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1062 
sds
 
key¡r
;

1063 
robj
 
key
, *
o
;

1064 
expœ‘ime
;

1066 
key¡r
 = 
	`diùG‘Key
(
de
);

1067 
o
 = 
	`diùG‘V®
(
de
);

1068 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

1070 
expœ‘ime
 = 
	`g‘Expœe
(
db
,&
key
);

1073 ià(
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) ;

1076 ià(
o
->
ty³
 =ğ
REDIS_STRING
) {

1078 
cmd
[]="*3\r\n$3\r\nSET\r\n";

1079 ià(
	`rioWr™e
(&
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1081 ià(
	`rioWr™eBulkObjeù
(&
aof
,&
key
è=ğ0è
w”r
;

1082 ià(
	`rioWr™eBulkObjeù
(&
aof
,
o
è=ğ0è
w”r
;

1083 } ià(
o
->
ty³
 =ğ
REDIS_LIST
) {

1084 ià(
	`»wr™eLi¡Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1085 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

1086 ià(
	`»wr™eS‘Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1087 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
) {

1088 ià(
	`»wr™eSÜ‹dS‘Objeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1089 } ià(
o
->
ty³
 =ğ
REDIS_HASH
) {

1090 ià(
	`»wr™eHashObjeù
(&
aof
,&
key
,
o
è=ğ0è
w”r
;

1092 
	`»disPªic
("Unknown objectype");

1095 ià(
expœ‘ime
 != -1) {

1096 
cmd
[]="*3\r\n$9\r\nPEXPIREAT\r\n";

1097 ià(
	`rioWr™e
(&
aof
,
cmd
,(cmd)-1è=ğ0è
w”r
;

1098 ià(
	`rioWr™eBulkObjeù
(&
aof
,&
key
è=ğ0è
w”r
;

1099 ià(
	`rioWr™eBulkLÚgLÚg
(&
aof
,
expœ‘ime
è=ğ0è
w”r
;

1102 ià(
aof
.
´oûs£d_by‹s
 > 
´oûs£d
+1024*10) {

1103 
´oûs£d
 = 
aof
.
´oûs£d_by‹s
;

1104 
	`aofR—dDiffFromP¬’t
();

1107 
	`diùR–—£I‹¿tÜ
(
di
);

1108 
di
 = 
NULL
;

1113 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1114 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1122 
nod©a
 = 0;

1123 
m¡ime_t
 
¡¬t
 = 
	`m¡ime
();

1124 
	`m¡ime
()-
¡¬t
 < 1000 && 
nod©a
 < 20) {

1125 ià(
	`«Wa™
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
, 
AE_READABLE
, 1) <= 0)

1127 
nod©a
++;

1130 
nod©a
 = 0;

1132 
	`aofR—dDiffFromP¬’t
();

1136 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
,"!",1è!ğ1è
w”r
;

1137 ià(
	`ª‘NÚBlock
(
NULL
,
£rv”
.
aof_pe_»ad_ack_äom_·»Á
è!ğ
ANET_OK
)

1138 
w”r
;

1142 ià(
	`syncR—d
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
,&
by‹
,1,5000) != 1 ||

1143 
by‹
 !ğ'!'è
w”r
;

1144 
	`»disLog
(
REDIS_NOTICE
,"Parent‡greedo stop sending diffs. Finalizing AOF...");

1147 
	`aofR—dDiffFromP¬’t
();

1150 
	`»disLog
(
REDIS_NOTICE
,

1152 (è
	`sd¦’
(
£rv”
.
aof_chd_diff
) / (1024*1024));

1153 ià(
	`rioWr™e
(&
aof
,
£rv”
.
aof_chd_diff
,
	`sd¦’
(server.aof_child_diff)) == 0)

1154 
w”r
;

1157 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

1158 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

1159 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

1163 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

1164 
	`»disLog
(
REDIS_WARNING
,"E¼Ü movšgem°­³nd oÆy fÚhfš® de¡š©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1165 
	`uÆšk
(
tmpfe
);

1166  
REDIS_ERR
;

1168 
	`»disLog
(
REDIS_NOTICE
,"SYNC‡ppend only file„ewrite…erformed");

1169  
REDIS_OK
;

1171 
w”r
:

1172 
	`fşo£
(
å
);

1173 
	`uÆšk
(
tmpfe
);

1174 
	`»disLog
(
REDIS_WARNING
,"Wr™”rÜ wr™šg‡µ’d oÆy fÚ disk: %s", 
	`¡»¼Ü
(
”ºo
));

1175 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

1176  
REDIS_ERR
;

1177 
	}
}

1186 
	$aofChdPeR—dabË
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1187 
by‹
;

1188 
	`REDIS_NOTUSED
(
–
);

1189 
	`REDIS_NOTUSED
(
´ivd©a
);

1190 
	`REDIS_NOTUSED
(
mask
);

1192 ià(
	`»ad
(
fd
,&
by‹
,1) == 1 && byte == '!') {

1193 
	`»disLog
(
REDIS_NOTICE
,"AOF„ewrite child‡skso stop sending diffs.");

1194 
£rv”
.
aof_¡İ_£ndšg_diff
 = 1;

1195 ià(
	`wr™e
(
£rv”
.
aof_pe_wr™e_ack_to_chd
,"!",1) != 1) {

1200 
	`»disLog
(
REDIS_WARNING
,"Can't send ACKo AOF child: %s",

1201 
	`¡»¼Ü
(
”ºo
));

1206 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1207 
	}
}

1214 
	$aofC»©ePes
() {

1215 
fds
[6] = {-1, -1, -1, -1, -1, -1};

1216 
j
;

1218 ià(
	`pe
(
fds
è=ğ-1è
”rÜ
;

1219 ià(
	`pe
(
fds
+2è=ğ-1è
”rÜ
;

1220 ià(
	`pe
(
fds
+4è=ğ-1è
”rÜ
;

1222 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[0]è!ğ
ANET_OK
è
”rÜ
;

1223 ià(
	`ª‘NÚBlock
(
NULL
,
fds
[1]è!ğ
ANET_OK
è
”rÜ
;

1224 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
fds
[2], 
AE_READABLE
, 
aofChdPeR—dabË
, 
NULL
è=ğ
AE_ERR
è
”rÜ
;

1226 
£rv”
.
aof_pe_wr™e_d©a_to_chd
 = 
fds
[1];

1227 
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
 = 
fds
[0];

1228 
£rv”
.
aof_pe_wr™e_ack_to_·»Á
 = 
fds
[3];

1229 
£rv”
.
aof_pe_»ad_ack_äom_chd
 = 
fds
[2];

1230 
£rv”
.
aof_pe_wr™e_ack_to_chd
 = 
fds
[5];

1231 
£rv”
.
aof_pe_»ad_ack_äom_·»Á
 = 
fds
[4];

1232 
£rv”
.
aof_¡İ_£ndšg_diff
 = 0;

1233  
REDIS_OK
;

1235 
”rÜ
:

1236 
	`»disLog
(
REDIS_WARNING
,"Error opening /setting AOF„ewrite IPC…ipes: %s",

1237 
	`¡»¼Ü
(
”ºo
));

1238 
j
 = 0; j < 6; j++èif(
fds
[j] !ğ-1è
	`şo£
(fds[j]);

1239  
REDIS_ERR
;

1240 
	}
}

1242 
	$aofClo£Pes
() {

1243 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_»ad_ack_äom_chd
,
AE_READABLE
);

1244 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
aof_pe_wr™e_d©a_to_chd
,
AE_WRITABLE
);

1245 
	`şo£
(
£rv”
.
aof_pe_wr™e_d©a_to_chd
);

1246 
	`şo£
(
£rv”
.
aof_pe_»ad_d©a_äom_·»Á
);

1247 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_·»Á
);

1248 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_chd
);

1249 
	`şo£
(
£rv”
.
aof_pe_wr™e_ack_to_chd
);

1250 
	`şo£
(
£rv”
.
aof_pe_»ad_ack_äom_·»Á
);

1251 
	}
}

1269 
	$»wr™eAµ’dOÆyFeBackground
() {

1270 
pid_t
 
chdpid
;

1271 
¡¬t
;

1273 ià(
£rv”
.
aof_chd_pid
 !ğ-1è 
REDIS_ERR
;

1274 ià(
	`aofC»©ePes
(è!ğ
REDIS_OK
è 
REDIS_ERR
;

1275 
¡¬t
 = 
	`u¡ime
();

1276 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1277 
tmpfe
[256];

1280 
	`şo£Li¡’šgSock‘s
(0);

1281 
	`»disS‘ProcT™Ë
("redis-aof-rewrite");

1282 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
	`g‘pid
());

1283 ià(
	`»wr™eAµ’dOÆyFe
(
tmpfe
è=ğ
REDIS_OK
) {

1284 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

1286 ià(
´iv©e_dœty
) {

1287 
	`»disLog
(
REDIS_NOTICE
,

1289 
´iv©e_dœty
/(1024*1024));

1291 
	`ex™FromChd
(0);

1293 
	`ex™FromChd
(1);

1297 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1298 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1299 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1300 ià(
chdpid
 == -1) {

1301 
	`»disLog
(
REDIS_WARNING
,

1303 
	`¡»¼Ü
(
”ºo
));

1304  
REDIS_ERR
;

1306 
	`»disLog
(
REDIS_NOTICE
,

1307 "Background‡µ’d oÆy f»wr™šg s¹ed by…id %d",
chdpid
);

1308 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1309 
£rv”
.
aof_»wr™e_time_¡¬t
 = 
	`time
(
NULL
);

1310 
£rv”
.
aof_chd_pid
 = 
chdpid
;

1311 
	`upd©eDiùResizePŞicy
();

1316 
£rv”
.
aof_£Ëùed_db
 = -1;

1317 
	`»¶iÿtiÚSütCacheFlush
();

1318  
REDIS_OK
;

1320  
REDIS_OK
;

1321 
	}
}

1323 
	$bg»wr™—ofCommªd
(
»disCl›Á
 *
c
) {

1324 ià(
£rv”
.
aof_chd_pid
 != -1) {

1325 
	`addR•lyE¼Ü
(
c
,"Background‡ppend only file„ewriting‡lready in…rogress");

1326 } ià(
£rv”
.
rdb_chd_pid
 != -1) {

1327 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1328 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting scheduled");

1329 } ià(
	`»wr™eAµ’dOÆyFeBackground
(è=ğ
REDIS_OK
) {

1330 
	`addR•lyStus
(
c
,"Background‡ppend only file„ewriting started");

1332 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1334 
	}
}

1336 
	$aofRemoveTempFe
(
pid_t
 
chdpid
) {

1337 
tmpfe
[256];

1339 
	`¢´štf
(
tmpfe
,256,"‹mp-»wr™—of-bg-%d.aof", (è
chdpid
);

1340 
	`uÆšk
(
tmpfe
);

1341 
	}
}

1347 
	$aofUpd©eCu¼’tSize
() {

1348 
»dis_¡©
 
sb
;

1349 
m¡ime_t
 
Ï‹ncy
;

1351 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1352 ià(
	`»dis_f¡©
(
£rv”
.
aof_fd
,&
sb
) == -1) {

1353 
	`»disLog
(
REDIS_WARNING
,"Unableo obtainhe AOF file†ength. stat: %s",

1354 
	`¡»¼Ü
(
”ºo
));

1356 
£rv”
.
aof_cu¼’t_size
 = 
sb
.
¡_size
;

1358 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1359 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-f¡©",
Ï‹ncy
);

1360 
	}
}

1364 
	$backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1365 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1366 
Ãwfd
, 
Şdfd
;

1367 
tmpfe
[256];

1368 
now
 = 
	`u¡ime
();

1369 
m¡ime_t
 
Ï‹ncy
;

1371 
	`»disLog
(
REDIS_NOTICE
,

1376 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1377 
	`¢´štf
(
tmpfe
,256,"temp-rewriteaof-bg-%d.aof",

1378 ()
£rv”
.
aof_chd_pid
);

1379 
Ãwfd
 = 
	`İ’
(
tmpfe
,
O_WRONLY
|
O_APPEND
);

1380 ià(
Ãwfd
 == -1) {

1381 
	`»disLog
(
REDIS_WARNING
,

1382 "UÇbËØİ’h‹mpÜ¬y AOF…roduûd byhchd: %s", 
	`¡»¼Ü
(
”ºo
));

1383 
ş—nup
;

1386 ià(
	`aofRewr™eBufãrWr™e
(
Ãwfd
) == -1) {

1387 
	`»disLog
(
REDIS_WARNING
,

1388 "E¼ÜryšgØæushh·»Á difàtØth»wr™‹ÀAOF: %s", 
	`¡»¼Ü
(
”ºo
));

1389 
	`şo£
(
Ãwfd
);

1390 
ş—nup
;

1392 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1393 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»wr™e-diff-wr™e",
Ï‹ncy
);

1395 
	`»disLog
(
REDIS_NOTICE
,

1396 "Residu®…¬’ˆdifàsucûssfuÎy flushedØth»wr™‹ÀAOF (%.2àMB)", (è
	`aofRewr™eBufãrSize
() / (1024*1024));

1425 ià(
£rv”
.
aof_fd
 == -1) {

1431 
Şdfd
 = 
	`İ’
(
£rv”
.
aof_f’ame
,
O_RDONLY
|
O_NONBLOCK
);

1434 
Şdfd
 = -1;

1439 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1440 ià(
	`»Çme
(
tmpfe
,
£rv”
.
aof_f’ame
) == -1) {

1441 
	`»disLog
(
REDIS_WARNING
,

1442 "E¼ÜryšgØ»Çmth‹mpÜ¬y AOF fe: %s", 
	`¡»¼Ü
(
”ºo
));

1443 
	`şo£
(
Ãwfd
);

1444 ià(
Şdfd
 !ğ-1è
	`şo£
(oldfd);

1445 
ş—nup
;

1447 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1448 
	`Ï‹ncyAddSam¶eIfN“ded
("aof-»Çme",
Ï‹ncy
);

1450 ià(
£rv”
.
aof_fd
 == -1) {

1453 
	`şo£
(
Ãwfd
);

1456 
Şdfd
 = 
£rv”
.
aof_fd
;

1457 
£rv”
.
aof_fd
 = 
Ãwfd
;

1458 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
)

1459 
	`aof_fsync
(
Ãwfd
);

1460 ià(
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_EVERYSEC
)

1461 
	`aof_background_fsync
(
Ãwfd
);

1462 
£rv”
.
aof_£Ëùed_db
 = -1;

1463 
	`aofUpd©eCu¼’tSize
();

1464 
£rv”
.
aof_»wr™e_ba£_size
 = s”v”.
aof_cu¼’t_size
;

1468 
	`sdsä“
(
£rv”
.
aof_buf
);

1469 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1472 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
REDIS_OK
;

1474 
	`»disLog
(
REDIS_NOTICE
, "Background AOF„ewrite finished successfully");

1476 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_WAIT_REWRITE
)

1477 
£rv”
.
aof_¡©e
 = 
REDIS_AOF_ON
;

1480 ià(
Şdfd
 !ğ-1è
	`bioC»©eBackgroundJob
(
REDIS_BIO_CLOSE_FILE
,(*)()Şdfd,
NULL
,NULL);

1482 
	`»disLog
(
REDIS_VERBOSE
,

1483 "Background AOF„ewr™sigÇÈhªdË¸took %Îdus", 
	`u¡ime
()-
now
);

1484 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1485 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
REDIS_ERR
;

1487 
	`»disLog
(
REDIS_WARNING
,

1490 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
REDIS_ERR
;

1492 
	`»disLog
(
REDIS_WARNING
,

1493 "Background AOF„ewr™‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1496 
ş—nup
:

1497 
	`aofClo£Pes
();

1498 
	`aofRewr™eBufãrRe£t
();

1499 
	`aofRemoveTempFe
(
£rv”
.
aof_chd_pid
);

1500 
£rv”
.
aof_chd_pid
 = -1;

1501 
£rv”
.
aof_»wr™e_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
aof_»wr™e_time_¡¬t
;

1502 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1504 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_WAIT_REWRITE
)

1505 
£rv”
.
aof_»wr™e_scheduËd
 = 1;

1506 
	}
}

	@asciilogo.h

30 *
	gascii_logo
 =

	@bio.c

61 
	~"»dis.h
"

62 
	~"bio.h
"

64 
±h»ad_t
 
	gbio_th»ads
[
REDIS_BIO_NUM_OPS
];

65 
±h»ad_mu‹x_t
 
	gbio_mu‹x
[
REDIS_BIO_NUM_OPS
];

66 
±h»ad_cÚd_t
 
	gbio_cÚdv¬
[
REDIS_BIO_NUM_OPS
];

67 
li¡
 *
	gbio_jobs
[
REDIS_BIO_NUM_OPS
];

74 
	gbio_³ndšg
[
REDIS_BIO_NUM_OPS
];

78 
	sbio_job
 {

79 
time_t
 
	mtime
;

82 *
	m¬g1
, *
	m¬g2
, *
	m¬g3
;

85 *
bioProûssBackgroundJobs
(*
¬g
);

89 
	#REDIS_THREAD_STACK_SIZE
 (1024*1024*4)

	)

92 
	$bioIn™
() {

93 
±h»ad_©Œ_t
 
©Œ
;

94 
±h»ad_t
 
th»ad
;

95 
size_t
 
¡acksize
;

96 
j
;

99 
j
 = 0; j < 
REDIS_BIO_NUM_OPS
; j++) {

100 
	`±h»ad_mu‹x_š™
(&
bio_mu‹x
[
j
],
NULL
);

101 
	`±h»ad_cÚd_š™
(&
bio_cÚdv¬
[
j
],
NULL
);

102 
bio_jobs
[
j
] = 
	`li¡C»©e
();

103 
bio_³ndšg
[
j
] = 0;

107 
	`±h»ad_©Œ_š™
(&
©Œ
);

108 
	`±h»ad_©Œ_g‘¡acksize
(&
©Œ
,&
¡acksize
);

109 ià(!
¡acksize
) stacksize = 1;

110 
¡acksize
 < 
REDIS_THREAD_STACK_SIZE
) stacksize *= 2;

111 
	`±h»ad_©Œ_£t¡acksize
(&
©Œ
, 
¡acksize
);

116 
j
 = 0; j < 
REDIS_BIO_NUM_OPS
; j++) {

117 *
¬g
 = (*)(è
j
;

118 ià(
	`±h»ad_ü—‹
(&
th»ad
,&
©Œ
,
bioProûssBackgroundJobs
,
¬g
) != 0) {

119 
	`»disLog
(
REDIS_WARNING
,"Fatal: Can't initialize Background Jobs.");

120 
	`ex™
(1);

122 
bio_th»ads
[
j
] = 
th»ad
;

124 
	}
}

126 
	$bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
) {

127 
bio_job
 *
job
 = 
	`zm®loc
((*job));

129 
job
->
time
 = 
	`time
(
NULL
);

130 
job
->
¬g1
 =‡rg1;

131 
job
->
¬g2
 =‡rg2;

132 
job
->
¬g3
 =‡rg3;

133 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

134 
	`li¡AddNodeTa
(
bio_jobs
[
ty³
],
job
);

135 
bio_³ndšg
[
ty³
]++;

136 
	`±h»ad_cÚd_sigÇl
(&
bio_cÚdv¬
[
ty³
]);

137 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

138 
	}
}

140 *
	$bioProûssBackgroundJobs
(*
¬g
) {

141 
bio_job
 *
job
;

142 
ty³
 = (è
¬g
;

143 
sig£t_t
 
sig£t
;

147 
	`±h»ad_£tÿnûl¡©e
(
PTHREAD_CANCEL_ENABLE
, 
NULL
);

148 
	`±h»ad_£tÿnûÉy³
(
PTHREAD_CANCEL_ASYNCHRONOUS
, 
NULL
);

150 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

153 
	`sigem±y£t
(&
sig£t
);

154 
	`sigadd£t
(&
sig£t
, 
SIGALRM
);

155 ià(
	`±h»ad_sigmask
(
SIG_BLOCK
, &
sig£t
, 
NULL
))

156 
	`»disLog
(
REDIS_WARNING
,

157 "W¬nšg: cª'ˆmask SIGALRM iÀbio.øth»ad: %s", 
	`¡»¼Ü
(
”ºo
));

160 
li¡Node
 *
Ê
;

163 ià(
	`li¡L’gth
(
bio_jobs
[
ty³
]) == 0) {

164 
	`±h»ad_cÚd_wa™
(&
bio_cÚdv¬
[
ty³
],&
bio_mu‹x
[type]);

168 
Ê
 = 
	`li¡Fœ¡
(
bio_jobs
[
ty³
]);

169 
job
 = 
Ê
->
v®ue
;

172 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

175 ià(
ty³
 =ğ
REDIS_BIO_CLOSE_FILE
) {

176 
	`şo£
(()
job
->
¬g1
);

177 } ià(
ty³
 =ğ
REDIS_BIO_AOF_FSYNC
) {

178 
	`aof_fsync
(()
job
->
¬g1
);

180 
	`»disPªic
("Wrong jobype in bioProcessBackgroundJobs().");

182 
	`zä“
(
job
);

186 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

187 
	`li¡D–Node
(
bio_jobs
[
ty³
],
Ê
);

188 
bio_³ndšg
[
ty³
]--;

190 
	}
}

193 
	$bioP’dšgJobsOfTy³
(
ty³
) {

194 
v®
;

195 
	`±h»ad_mu‹x_lock
(&
bio_mu‹x
[
ty³
]);

196 
v®
 = 
bio_³ndšg
[
ty³
];

197 
	`±h»ad_mu‹x_uÆock
(&
bio_mu‹x
[
ty³
]);

198  
v®
;

199 
	}
}

205 
	$bioKlTh»ads
() {

206 
”r
, 
j
;

208 
j
 = 0; j < 
REDIS_BIO_NUM_OPS
; j++) {

209 ià(
	`±h»ad_ÿnûl
(
bio_th»ads
[
j
]) == 0) {

210 ià((
”r
 = 
	`±h»ad_još
(
bio_th»ads
[
j
],
NULL
)) != 0) {

211 
	`»disLog
(
REDIS_WARNING
,

213 
j
, 
	`¡»¼Ü
(
”r
));

215 
	`»disLog
(
REDIS_WARNING
,

216 "BiØth»ad fÜ joby³ #%d”mš©ed",
j
);

220 
	}
}

	@bio.h

31 
bioIn™
();

32 
bioC»©eBackgroundJob
(
ty³
, *
¬g1
, *
¬g2
, *
¬g3
);

33 
bioP’dšgJobsOfTy³
(
ty³
);

34 
bioWa™P’dšgJobsLE
(
ty³
, 
num
);

35 
time_t
 
bioOld”JobOfTy³
(
ty³
);

36 
bioKlTh»ads
();

39 
	#REDIS_BIO_CLOSE_FILE
 0

	)

40 
	#REDIS_BIO_AOF_FSYNC
 1

	)

41 
	#REDIS_BIO_NUM_OPS
 2

	)

	@bitops.c

31 
	~"»dis.h
"

40 
	$g‘B™Off£tFromArgum’t
(
»disCl›Á
 *
c
, 
robj
 *
o
, 
size_t
 *
off£t
) {

41 
loff£t
;

42 *
”r
 = "bit offset is‚ot‡n integer or out of„ange";

44 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
loff£t
,
”r
è!ğ
REDIS_OK
)

45  
REDIS_ERR
;

48 ià((
loff£t
 < 0) || (()loffset >> 3) >= (512*1024*1024))

50 
	`addR•lyE¼Ü
(
c
,
”r
);

51  
REDIS_ERR
;

54 *
off£t
 = (
size_t
)
loff£t
;

55  
REDIS_OK
;

56 
	}
}

61 
size_t
 
	$»disPİcouÁ
(*
s
, 
couÁ
) {

62 
size_t
 
b™s
 = 0;

63 *
p
 = 
s
;

64 
ušt32_t
 *
p4
;

65 cÚ¡ 
b™sšby‹
[256] = {0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,1,2,2,3,2,3,3,4,2,3,3,4,3,4,4,5,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,2,3,3,4,3,4,4,5,3,4,4,5,4,5,5,6,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,3,4,4,5,4,5,5,6,4,5,5,6,5,6,6,7,4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8};

68 ()
p
 & 3 && 
couÁ
) {

69 
b™s
 +ğ
b™sšby‹
[*
p
++];

70 
couÁ
--;

74 
p4
 = (
ušt32_t
*)
p
;

75 
couÁ
>=28) {

76 
ušt32_t
 
aux1
, 
aux2
, 
aux3
, 
aux4
, 
aux5
, 
aux6
, 
aux7
;

78 
aux1
 = *
p4
++;

79 
aux2
 = *
p4
++;

80 
aux3
 = *
p4
++;

81 
aux4
 = *
p4
++;

82 
aux5
 = *
p4
++;

83 
aux6
 = *
p4
++;

84 
aux7
 = *
p4
++;

85 
couÁ
 -= 28;

87 
aux1
 =‡ux1 - ((aux1 >> 1) & 0x55555555);

88 
aux1
 = (aux1 & 0x33333333) + ((aux1 >> 2) & 0x33333333);

89 
aux2
 =‡ux2 - ((aux2 >> 1) & 0x55555555);

90 
aux2
 = (aux2 & 0x33333333) + ((aux2 >> 2) & 0x33333333);

91 
aux3
 =‡ux3 - ((aux3 >> 1) & 0x55555555);

92 
aux3
 = (aux3 & 0x33333333) + ((aux3 >> 2) & 0x33333333);

93 
aux4
 =‡ux4 - ((aux4 >> 1) & 0x55555555);

94 
aux4
 = (aux4 & 0x33333333) + ((aux4 >> 2) & 0x33333333);

95 
aux5
 =‡ux5 - ((aux5 >> 1) & 0x55555555);

96 
aux5
 = (aux5 & 0x33333333) + ((aux5 >> 2) & 0x33333333);

97 
aux6
 =‡ux6 - ((aux6 >> 1) & 0x55555555);

98 
aux6
 = (aux6 & 0x33333333) + ((aux6 >> 2) & 0x33333333);

99 
aux7
 =‡ux7 - ((aux7 >> 1) & 0x55555555);

100 
aux7
 = (aux7 & 0x33333333) + ((aux7 >> 2) & 0x33333333);

101 
b™s
 +ğ((((
aux1
 + (aux1 >> 4)) & 0x0F0F0F0F) +

102 ((
aux2
 + (aux2 >> 4)) & 0x0F0F0F0F) +

103 ((
aux3
 + (aux3 >> 4)) & 0x0F0F0F0F) +

104 ((
aux4
 + (aux4 >> 4)) & 0x0F0F0F0F) +

105 ((
aux5
 + (aux5 >> 4)) & 0x0F0F0F0F) +

106 ((
aux6
 + (aux6 >> 4)) & 0x0F0F0F0F) +

107 ((
aux7
 + (aux7 >> 4)) & 0x0F0F0F0F))* 0x01010101) >> 24;

110 
p
 = (*)
p4
;

111 
couÁ
--è
b™s
 +ğ
b™sšby‹
[*
p
++];

112  
b™s
;

113 
	}
}

122 
	$»disB™pos
(*
s
, 
couÁ
, 
b™
) {

123 *
l
;

124 *
c
;

125 
skv®
, 
wÜd
 = 0, 
Úe
;

126 
pos
 = 0;

127 
j
;

139 
skv®
 = 
b™
 ? 0 : 
UCHAR_MAX
;

140 
c
 = (*è
s
;

141 ()
c
 & ((*
l
)-1è&& 
couÁ
) {

142 ià(*
c
 !ğ
skv®
) ;

143 
c
++;

144 
couÁ
--;

145 
pos
 += 8;

149 
skv®
 = 
b™
 ? 0 : 
ULONG_MAX
;

150 
l
 = (*è
c
;

151 
couÁ
 >ğ(*
l
)) {

152 ià(*
l
 !ğ
skv®
) ;

153 
l
++;

154 
couÁ
 -ğ(*
l
);

155 
pos
 +ğ(*
l
)*8;

165 
c
 = (*)
l
;

166 
j
 = 0; j < (*
l
); j++) {

167 
wÜd
 <<= 8;

168 ià(
couÁ
) {

169 
wÜd
 |ğ*
c
;

170 
c
++;

171 
couÁ
--;

180 ià(
b™
 =ğ1 && 
wÜd
 == 0)  -1;

186 
Úe
 = 
ULONG_MAX
;

187 
Úe
 >>= 1;

188 
Úe
 = ~one;

190 
Úe
) {

191 ià(((
Úe
 & 
wÜd
è!ğ0è=ğ
b™
è 
pos
;

192 
pos
++;

193 
Úe
 >>= 1;

198 
	`»disPªic
("End of„edisBitpos()„eached.");

200 
	}
}

206 
	#BITOP_AND
 0

	)

207 
	#BITOP_OR
 1

	)

208 
	#BITOP_XOR
 2

	)

209 
	#BITOP_NOT
 3

	)

212 
	$£tb™Commªd
(
»disCl›Á
 *
c
) {

213 
robj
 *
o
;

214 *
”r
 = "bit is‚ot‡n integer or out of„ange";

215 
size_t
 
b™off£t
;

216 
by‹
, 
b™
;

217 
by‹v®
, 
b™v®
;

218 
Ú
;

220 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
è!ğ
REDIS_OK
)

223 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
Ú
,
”r
è!ğ
REDIS_OK
)

227 ià(
Ú
 & ~1) {

228 
	`addR•lyE¼Ü
(
c
,
”r
);

232 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

233 ià(
o
 =ğ
NULL
) {

234 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd£m±y
());

235 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

237 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

238 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

242 
by‹
 = 
b™off£t
 >> 3;

243 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
by‹
+1);

246 
by‹v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
];

247 
b™
 = 7 - (
b™off£t
 & 0x7);

248 
b™v®
 = 
by‹v®
 & (1 << 
b™
);

251 
by‹v®
 &ğ~(1 << 
b™
);

252 
by‹v®
 |ğ((
Ú
 & 0x1è<< 
b™
);

253 ((
ušt8_t
*)
o
->
±r
)[
by‹
] = 
by‹v®
;

254 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

255 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"£tb™",
c
->
¬gv
[1],c->
db
->
id
);

256 
£rv”
.
dœty
++;

257 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

258 
	}
}

261 
	$g‘b™Commªd
(
»disCl›Á
 *
c
) {

262 
robj
 *
o
;

263 
Îbuf
[32];

264 
size_t
 
b™off£t
;

265 
size_t
 
by‹
, 
b™
;

266 
size_t
 
b™v®
 = 0;

268 ià(
	`g‘B™Off£tFromArgum’t
(
c
,c->
¬gv
[2],&
b™off£t
è!ğ
REDIS_OK
)

271 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

272 
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

274 
by‹
 = 
b™off£t
 >> 3;

275 
b™
 = 7 - (
b™off£t
 & 0x7);

276 ià(
	`sdsEncodedObjeù
(
o
)) {

277 ià(
by‹
 < 
	`sd¦’
(
o
->
±r
))

278 
b™v®
 = ((
ušt8_t
*)
o
->
±r
)[
by‹
] & (1 << 
b™
);

280 ià(
by‹
 < (
size_t
)
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
))

281 
b™v®
 = 
Îbuf
[
by‹
] & (1 << 
b™
);

284 
	`addR•ly
(
c
, 
b™v®
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

285 
	}
}

288 
	$b™İCommªd
(
»disCl›Á
 *
c
) {

289 *
İÇme
 = 
c
->
¬gv
[1]->
±r
;

290 
robj
 *
o
, *
rg‘key
 = 
c
->
¬gv
[2];

291 
İ
, 
j
, 
numkeys
;

292 
robj
 **
objeùs
;

293 **
¤c
;

294 *
Ën
, 
maxËn
 = 0;

296 
mšËn
 = 0;

297 *
»s
 = 
NULL
;

300 ià((
İÇme
[0] =ğ'a' || o²ame[0] =ğ'A'è&& !
	`¡rÿ£cmp
(opname,"and"))

301 
İ
 = 
BITOP_AND
;

302 if((
İÇme
[0] =ğ'o' || o²ame[0] =ğ'O'è&& !
	`¡rÿ£cmp
(opname,"or"))

303 
İ
 = 
BITOP_OR
;

304 if((
İÇme
[0] =ğ'x' || o²ame[0] =ğ'X'è&& !
	`¡rÿ£cmp
(opname,"xor"))

305 
İ
 = 
BITOP_XOR
;

306 if((
İÇme
[0] =ğ'n' || o²ame[0] =ğ'N'è&& !
	`¡rÿ£cmp
(opname,"not"))

307 
İ
 = 
BITOP_NOT
;

309 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

314 ià(
İ
 =ğ
BITOP_NOT
 && 
c
->
¬gc
 != 4) {

315 
	`addR•lyE¼Ü
(
c
,"BITOP NOT must be called with‡ single source key.");

320 
numkeys
 = 
c
->
¬gc
 - 3;

321 
¤c
 = 
	`zm®loc
((*è* 
numkeys
);

322 
Ën
 = 
	`zm®loc
((è* 
numkeys
);

323 
objeùs
 = 
	`zm®loc
((
robj
*è* 
numkeys
);

324 
j
 = 0; j < 
numkeys
; j++) {

325 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
+3]);

327 ià(
o
 =ğ
NULL
) {

328 
objeùs
[
j
] = 
NULL
;

329 
¤c
[
j
] = 
NULL
;

330 
Ën
[
j
] = 0;

331 
mšËn
 = 0;

335 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) {

336 
i
;

337 
i
 = 0; i < 
j
; i++) {

338 ià(
objeùs
[
i
])

339 
	`deüRefCouÁ
(
objeùs
[
i
]);

341 
	`zä“
(
¤c
);

342 
	`zä“
(
Ën
);

343 
	`zä“
(
objeùs
);

346 
objeùs
[
j
] = 
	`g‘DecodedObjeù
(
o
);

347 
¤c
[
j
] = 
objeùs
[j]->
±r
;

348 
Ën
[
j
] = 
	`sd¦’
(
objeùs
[j]->
±r
);

349 ià(
Ën
[
j
] > 
maxËn
) maxlen =†en[j];

350 ià(
j
 =ğ0 || 
Ën
[j] < 
mšËn
) minlen =†en[j];

354 ià(
maxËn
) {

355 
»s
 = (*è
	`sd¢ewËn
(
NULL
,
maxËn
);

356 
ouut
, 
by‹
;

357 
i
;

362 
j
 = 0;

363 ià(
mšËn
 >ğ()*4 && 
numkeys
 <= 16) {

364 *
Í
[16];

365 *
Ìes
 = (*è
»s
;

368 
	`memıy
(
Í
,
¤c
,(*)*
numkeys
);

369 
	`memıy
(
»s
,
¤c
[0],
mšËn
);

372 ià(
İ
 =ğ
BITOP_AND
) {

373 
mšËn
 >= ()*4) {

374 
i
 = 1; i < 
numkeys
; i++) {

375 
Ìes
[0] &ğ
Í
[
i
][0];

376 
Ìes
[1] &ğ
Í
[
i
][1];

377 
Ìes
[2] &ğ
Í
[
i
][2];

378 
Ìes
[3] &ğ
Í
[
i
][3];

379 
Í
[
i
]+=4;

381 
Ìes
+=4;

382 
j
 += ()*4;

383 
mšËn
 -= ()*4;

385 } ià(
İ
 =ğ
BITOP_OR
) {

386 
mšËn
 >= ()*4) {

387 
i
 = 1; i < 
numkeys
; i++) {

388 
Ìes
[0] |ğ
Í
[
i
][0];

389 
Ìes
[1] |ğ
Í
[
i
][1];

390 
Ìes
[2] |ğ
Í
[
i
][2];

391 
Ìes
[3] |ğ
Í
[
i
][3];

392 
Í
[
i
]+=4;

394 
Ìes
+=4;

395 
j
 += ()*4;

396 
mšËn
 -= ()*4;

398 } ià(
İ
 =ğ
BITOP_XOR
) {

399 
mšËn
 >= ()*4) {

400 
i
 = 1; i < 
numkeys
; i++) {

401 
Ìes
[0] ^ğ
Í
[
i
][0];

402 
Ìes
[1] ^ğ
Í
[
i
][1];

403 
Ìes
[2] ^ğ
Í
[
i
][2];

404 
Ìes
[3] ^ğ
Í
[
i
][3];

405 
Í
[
i
]+=4;

407 
Ìes
+=4;

408 
j
 += ()*4;

409 
mšËn
 -= ()*4;

411 } ià(
İ
 =ğ
BITOP_NOT
) {

412 
mšËn
 >= ()*4) {

413 
Ìes
[0] = ~lres[0];

414 
Ìes
[1] = ~lres[1];

415 
Ìes
[2] = ~lres[2];

416 
Ìes
[3] = ~lres[3];

417 
Ìes
+=4;

418 
j
 += ()*4;

419 
mšËn
 -= ()*4;

425 ; 
j
 < 
maxËn
; j++) {

426 
ouut
 = (
Ën
[0] <ğ
j
è? 0 : 
¤c
[0][j];

427 ià(
İ
 =ğ
BITOP_NOT
è
ouut
 = ~output;

428 
i
 = 1; i < 
numkeys
; i++) {

429 
by‹
 = (
Ën
[
i
] <ğ
j
è? 0 : 
¤c
[i][j];

430 
İ
) {

431 
BITOP_AND
: 
ouut
 &ğ
by‹
; ;

432 
BITOP_OR
: 
ouut
 |ğ
by‹
; ;

433 
BITOP_XOR
: 
ouut
 ^ğ
by‹
; ;

436 
»s
[
j
] = 
ouut
;

439 
j
 = 0; j < 
numkeys
; j++) {

440 ià(
objeùs
[
j
])

441 
	`deüRefCouÁ
(
objeùs
[
j
]);

443 
	`zä“
(
¤c
);

444 
	`zä“
(
Ën
);

445 
	`zä“
(
objeùs
);

448 ià(
maxËn
) {

449 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
»s
);

450 
	`£tKey
(
c
->
db
,
rg‘key
,
o
);

451 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"£t",
rg‘key
,
c
->
db
->
id
);

452 
	`deüRefCouÁ
(
o
);

453 } ià(
	`dbD–‘e
(
c
->
db
,
rg‘key
)) {

454 
	`sigÇlModif›dKey
(
c
->
db
,
rg‘key
);

455 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
rg‘key
,
c
->
db
->
id
);

457 
£rv”
.
dœty
++;

458 
	`addR•lyLÚgLÚg
(
c
,
maxËn
);

459 
	}
}

462 
	$b™couÁCommªd
(
»disCl›Á
 *
c
) {

463 
robj
 *
o
;

464 
¡¬t
, 
’d
, 
¡¾’
;

465 *
p
;

466 
Îbuf
[32];

469 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

470 
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

474 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

475 
p
 = (*è
Îbuf
;

476 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

478 
p
 = (*è
o
->
±r
;

479 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

483 ià(
c
->
¬gc
 == 4) {

484 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
REDIS_OK
)

486 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
REDIS_OK
)

489 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

490 ià(
’d
 < 0è’d = 
¡¾’
+end;

491 ià(
¡¬t
 < 0) start = 0;

492 ià(
’d
 < 0)ƒnd = 0;

493 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

494 } ià(
c
->
¬gc
 == 2) {

496 
¡¬t
 = 0;

497 
’d
 = 
¡¾’
-1;

500 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

506 ià(
¡¬t
 > 
’d
) {

507 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

509 
by‹s
 = 
’d
-
¡¬t
+1;

511 
	`addR•lyLÚgLÚg
(
c
,
	`»disPİcouÁ
(
p
+
¡¬t
,
by‹s
));

513 
	}
}

516 
	$b™posCommªd
(
»disCl›Á
 *
c
) {

517 
robj
 *
o
;

518 
b™
, 
¡¬t
, 
’d
, 
¡¾’
;

519 *
p
;

520 
Îbuf
[32];

521 
’d_giv’
 = 0;

525 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
b™
,
NULL
è!ğ
REDIS_OK
)

527 ià(
b™
 != 0 && bit != 1) {

528 
	`addR•lyE¼Ü
(
c
, "The bit‡rgument must be 1 or 0.");

535 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

536 
	`addR•lyLÚgLÚg
(
c
, 
b™
 ? -1 : 0);

539 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

543 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

544 
p
 = (*è
Îbuf
;

545 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

547 
p
 = (*è
o
->
±r
;

548 
¡¾’
 = 
	`sd¦’
(
o
->
±r
);

552 ià(
c
->
¬gc
 == 4 || c->argc == 5) {

553 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
¡¬t
,
NULL
è!ğ
REDIS_OK
)

555 ià(
c
->
¬gc
 == 5) {

556 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
’d
,
NULL
è!ğ
REDIS_OK
)

558 
’d_giv’
 = 1;

560 
’d
 = 
¡¾’
-1;

563 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

564 ià(
’d
 < 0è’d = 
¡¾’
+end;

565 ià(
¡¬t
 < 0) start = 0;

566 ià(
’d
 < 0)ƒnd = 0;

567 ià(
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

568 } ià(
c
->
¬gc
 == 3) {

570 
¡¬t
 = 0;

571 
’d
 = 
¡¾’
-1;

574 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

580 ià(
¡¬t
 > 
’d
) {

581 
	`addR•lyLÚgLÚg
(
c
, -1);

583 
by‹s
 = 
’d
-
¡¬t
+1;

584 
pos
 = 
	`»disB™pos
(
p
+
¡¬t
,
by‹s
,
b™
);

593 ià(
’d_giv’
 && 
b™
 =ğ0 && 
pos
 =ğ
by‹s
*8) {

594 
	`addR•lyLÚgLÚg
(
c
,-1);

597 ià(
pos
 !ğ-1èpo +ğ
¡¬t
*8;

598 
	`addR•lyLÚgLÚg
(
c
,
pos
);

600 
	}
}

	@blocked.c

66 
	~"»dis.h
"

76 
	$g‘TimeoutFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
) {

77 
tv®
;

79 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
objeù
,&
tv®
,

80 "timeouˆi nÙ‡Àš‹g” o¸ouˆoà¿nge"è!ğ
REDIS_OK
)

81  
REDIS_ERR
;

83 ià(
tv®
 < 0) {

84 
	`addR•lyE¼Ü
(
c
,"timeout is‚egative");

85  
REDIS_ERR
;

88 ià(
tv®
 > 0) {

89 ià(
un™
 =ğ
UNIT_SECONDS
è
tv®
 *= 1000;

90 
tv®
 +ğ
	`m¡ime
();

92 *
timeout
 = 
tv®
;

94  
REDIS_OK
;

95 
	}
}

100 
	$blockCl›Á
(
»disCl›Á
 *
c
, 
bty³
) {

101 
c
->
æags
 |ğ
REDIS_BLOCKED
;

102 
c
->
bty³
 = btype;

103 
£rv”
.
bpİ_blocked_ş›Ás
++;

104 
	}
}

109 
	$´oûssUnblockedCl›Ás
() {

110 
li¡Node
 *
Ê
;

111 
»disCl›Á
 *
c
;

113 
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
)) {

114 
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
unblocked_ş›Ás
);

115 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

116 
c
 = 
Ê
->
v®ue
;

117 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

118 
c
->
æags
 &ğ~
REDIS_UNBLOCKED
;

121 ià(
c
->
qu”ybuf
 && 
	`sd¦’
(c->querybuf) > 0) {

122 
£rv”
.
cu¼’t_ş›Á
 = 
c
;

123 
	`´oûssIÅutBufãr
(
c
);

124 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

127 
	}
}

131 
	$unblockCl›Á
(
»disCl›Á
 *
c
) {

132 ià(
c
->
bty³
 =ğ
REDIS_BLOCKED_LIST
) {

133 
	`unblockCl›ÁWa™šgD©a
(
c
);

134 } ià(
c
->
bty³
 =ğ
REDIS_BLOCKED_WAIT
) {

135 
	`unblockCl›ÁWa™šgR•liÿs
(
c
);

137 
	`»disPªic
("Unknown btype in unblockClient().");

141 
c
->
æags
 &ğ~
REDIS_BLOCKED
;

142 
c
->
æags
 |ğ
REDIS_UNBLOCKED
;

143 
c
->
bty³
 = 
REDIS_BLOCKED_NONE
;

144 
£rv”
.
bpİ_blocked_ş›Ás
--;

145 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

146 
	}
}

150 
	$»¶yToBlockedCl›ÁTimedOut
(
»disCl›Á
 *
c
) {

151 ià(
c
->
bty³
 =ğ
REDIS_BLOCKED_LIST
) {

152 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

153 } ià(
c
->
bty³
 =ğ
REDIS_BLOCKED_WAIT
) {

154 
	`addR•lyLÚgLÚg
(
c
,
	`»¶iÿtiÚCouÁAcksByOff£t
(c->
bpİ
.
»¶off£t
));

156 
	`»disPªic
("Unknown btype in„eplyToBlockedClientTimedOut().");

158 
	}
}

167 
	$discÚÃùAÎBlockedCl›Ás
() {

168 
li¡Node
 *
Ê
;

169 
li¡I‹r
 
li
;

171 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

172 (
Ê
 = 
	`li¡Next
(&
li
))) {

173 
»disCl›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

175 ià(
c
->
æags
 & 
REDIS_BLOCKED
) {

176 
	`addR•lySds
(
c
,
	`sd¢ew
(

179 
	`unblockCl›Á
(
c
);

180 
c
->
æags
 |ğ
REDIS_CLOSE_AFTER_REPLY
;

183 
	}
}

	@cluster.c

31 
	~"»dis.h
"

32 
	~"şu¡”.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<sys/ty³s.h
>

36 
	~<sys/sock‘.h
>

37 
	~<¬·/š‘.h
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<sys/sock‘.h
>

41 
	~<sys/¡©.h
>

42 
	~<sys/fe.h
>

43 
	~<m©h.h
>

48 
şu¡”Node
 *
	gmy£lf
 = 
NULL
;

50 
şu¡”Node
 *
ü—‹Clu¡”Node
(*
nod’ame
, 
æags
);

51 
şu¡”AddNode
(
şu¡”Node
 *
node
);

52 
şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

53 
şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

54 
şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
);

55 
şu¡”S’dFa
(*
nod’ame
);

56 
şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
);

57 
şu¡”Upd©eS‹
();

58 
şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

59 
sds
 
şu¡”G’NodesDesütiÚ
(
f‹r
);

60 
şu¡”Node
 *
şu¡”LookupNode
(*
Çme
);

61 
şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
);

62 
şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
);

63 
şu¡”D–SlÙ
(
¦Ù
);

64 
şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
);

65 
şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
);

66 
şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
);

67 
şu¡”HªdËSÏveFaov”
();

68 
şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

69 
b™m­Te¡B™
(*
b™m­
, 
pos
);

70 
şu¡”DoBefÜeSË•
(
æags
);

71 
şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
);

72 
»£tMªu®Faov”
();

73 
şu¡”Clo£AÎSlÙs
();

74 
şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
);

75 
şu¡”D–Node
(
şu¡”Node
 *
d–node
);

76 
sds
 
»´e£ÁRedisNodeFÏgs
(sd 
ci
, 
ušt16_t
 
æags
);

77 
ušt64_t
 
şu¡”G‘MaxEpoch
();

78 
şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

90 
	$şu¡”LßdCÚfig
(*
f’ame
) {

91 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r");

92 
¡©
 
sb
;

93 *
lše
;

94 
maxlše
, 
j
;

96 ià(
å
 =ğ
NULL
) {

97 ià(
”ºo
 =ğ
ENOENT
) {

98  
REDIS_ERR
;

100 
	`»disLog
(
REDIS_WARNING
,

102 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

103 
	`ex™
(1);

109 ià(
	`f¡©
(
	`f’o
(
å
),&
sb
è!ğ-1 && sb.
¡_size
 == 0) {

110 
	`fşo£
(
å
);

111  
REDIS_ERR
;

121 
maxlše
 = 1024+
REDIS_CLUSTER_SLOTS
*128;

122 
lše
 = 
	`zm®loc
(
maxlše
);

123 
	`fg‘s
(
lše
,
maxlše
,
å
è!ğ
NULL
) {

124 
¬gc
;

125 
sds
 *
¬gv
;

126 
şu¡”Node
 *
n
, *
ma¡”
;

127 *
p
, *
s
;

132 ià(
lše
[0] == '\n') ;

135 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

136 ià(
¬gv
 =ğ
NULL
è
fm‹¼
;

140 ià(
	`¡rÿ£cmp
(
¬gv
[0],"vars") == 0) {

141 
j
 = 1; j < 
¬gc
; j += 2) {

142 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"currentEpoch") == 0) {

143 
£rv”
.
şu¡”
->
cu¼’tEpoch
 =

144 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

145 } ià(
	`¡rÿ£cmp
(
¬gv
[
j
],"lastVoteEpoch") == 0) {

146 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =

147 
	`¡¹ouÎ
(
¬gv
[
j
+1],
NULL
,10);

149 
	`»disLog
(
REDIS_WARNING
,

151 
¬gv
[
j
]);

154 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

159 ià(
¬gc
 < 8è
fm‹¼
;

162 
n
 = 
	`şu¡”LookupNode
(
¬gv
[0]);

163 ià(!
n
) {

164 
n
 = 
	`ü—‹Clu¡”Node
(
¬gv
[0],0);

165 
	`şu¡”AddNode
(
n
);

168 ià((
p
 = 
	`¡¼chr
(
¬gv
[1],':')è=ğ
NULL
è
fm‹¼
;

169 *
p
 = '\0';

170 
	`memıy
(
n
->

,
¬gv
[1],
	`¡¾’
(argv[1])+1);

171 
n
->
pÜt
 = 
	`©oi
(
p
+1);

174 
p
 = 
s
 = 
¬gv
[2];

175 
p
) {

176 
p
 = 
	`¡rchr
(
s
,',');

177 ià(
p
) *p = '\0';

178 ià(!
	`¡rÿ£cmp
(
s
,"myself")) {

179 
	`»disAs£¹
(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
);

180 
my£lf
 = 
£rv”
.
şu¡”
->my£làğ
n
;

181 
n
->
æags
 |ğ
REDIS_NODE_MYSELF
;

182 } ià(!
	`¡rÿ£cmp
(
s
,"master")) {

183 
n
->
æags
 |ğ
REDIS_NODE_MASTER
;

184 } ià(!
	`¡rÿ£cmp
(
s
,"slave")) {

185 
n
->
æags
 |ğ
REDIS_NODE_SLAVE
;

186 } ià(!
	`¡rÿ£cmp
(
s
,"fail?")) {

187 
n
->
æags
 |ğ
REDIS_NODE_PFAIL
;

188 } ià(!
	`¡rÿ£cmp
(
s
,"fail")) {

189 
n
->
æags
 |ğ
REDIS_NODE_FAIL
;

190 
n
->
ç_time
 = 
	`m¡ime
();

191 } ià(!
	`¡rÿ£cmp
(
s
,"handshake")) {

192 
n
->
æags
 |ğ
REDIS_NODE_HANDSHAKE
;

193 } ià(!
	`¡rÿ£cmp
(
s
,"noaddr")) {

194 
n
->
æags
 |ğ
REDIS_NODE_NOADDR
;

195 } ià(!
	`¡rÿ£cmp
(
s
,"noflags")) {

198 
	`»disPªic
("Unknown flag in„edis cluster config file");

200 ià(
p
è
s
 =…+1;

205 ià(
¬gv
[3][0] != '-') {

206 
ma¡”
 = 
	`şu¡”LookupNode
(
¬gv
[3]);

207 ià(!
ma¡”
) {

208 
ma¡”
 = 
	`ü—‹Clu¡”Node
(
¬gv
[3],0);

209 
	`şu¡”AddNode
(
ma¡”
);

211 
n
->
¦aveof
 = 
ma¡”
;

212 
	`şu¡”NodeAddSÏve
(
ma¡”
,
n
);

216 ià(
	`©oi
(
¬gv
[4])è
n
->
pšg_£Á
 = 
	`m¡ime
();

217 ià(
	`©oi
(
¬gv
[5])è
n
->
pÚg_»ûived
 = 
	`m¡ime
();

220 
n
->
cÚfigEpoch
 = 
	`¡¹ouÎ
(
¬gv
[6],
NULL
,10);

223 
j
 = 8; j < 
¬gc
; j++) {

224 
¡¬t
, 
¡İ
;

226 ià(
¬gv
[
j
][0] == '[') {

228 
¦Ù
;

229 
dœeùiÚ
;

230 
şu¡”Node
 *
ú
;

232 
p
 = 
	`¡rchr
(
¬gv
[
j
],'-');

233 
	`»disAs£¹
(
p
 !ğ
NULL
);

234 *
p
 = '\0';

235 
dœeùiÚ
 = 
p
[1];

236 
¦Ù
 = 
	`©oi
(
¬gv
[
j
]+1);

237 
p
 += 3;

238 
ú
 = 
	`şu¡”LookupNode
(
p
);

239 ià(!
ú
) {

240 
ú
 = 
	`ü—‹Clu¡”Node
(
p
,0);

241 
	`şu¡”AddNode
(
ú
);

243 ià(
dœeùiÚ
 == '>') {

244 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
ú
;

246 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
ú
;

249 } ià((
p
 = 
	`¡rchr
(
¬gv
[
j
],'-')è!ğ
NULL
) {

250 *
p
 = '\0';

251 
¡¬t
 = 
	`©oi
(
¬gv
[
j
]);

252 
¡İ
 = 
	`©oi
(
p
+1);

254 
¡¬t
 = 
¡İ
 = 
	`©oi
(
¬gv
[
j
]);

256 
¡¬t
 <ğ
¡İ
è
	`şu¡”AddSlÙ
(
n
, start++);

259 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

262 ià(
£rv”
.
şu¡”
->
my£lf
 =ğ
NULL
è
fm‹¼
;

264 
	`zä“
(
lše
);

265 
	`fşo£
(
å
);

267 
	`»disLog
(
REDIS_NOTICE
,"NodcÚfigu¿tiÚ†ßded, I'm %.40s", 
my£lf
->
Çme
);

272 ià(
	`şu¡”G‘MaxEpoch
(è> 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

273 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
	`şu¡”G‘MaxEpoch
();

275  
REDIS_OK
;

277 
fm‹¼
:

278 
	`»disLog
(
REDIS_WARNING
,

280 
	`zä“
(
lše
);

281 ià(
å
è
	`fşo£
(fp);

282 
	`ex™
(1);

283 
	}
}

297 
	$şu¡”SaveCÚfig
(
do_fsync
) {

298 
sds
 
ci
;

299 
size_t
 
cÚ‹Á_size
;

300 
¡©
 
sb
;

301 
fd
;

303 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_SAVE_CONFIG
;

307 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(
REDIS_NODE_HANDSHAKE
);

308 
ci
 = 
	`sdsÿrštf
(ci,"vars currentEpoch %llu†astVoteEpoch %llu\n",

309 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

310 (è
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
);

311 
cÚ‹Á_size
 = 
	`sd¦’
(
ci
);

313 ià((
fd
 = 
	`İ’
(
£rv”
.
şu¡”_cÚfigfe
,
O_WRONLY
|
O_CREAT
,0644))

314 =ğ-1è
”r
;

317 ià(
	`f¡©
(
fd
,&
sb
) != -1) {

318 ià(
sb
.
¡_size
 > (
off_t
)
cÚ‹Á_size
) {

319 
ci
 = 
	`sdsgrowz”o
(ci,
sb
.
¡_size
);

320 
	`mem£t
(
ci
+
cÚ‹Á_size
,'\n',
sb
.
¡_size
-content_size);

323 ià(
	`wr™e
(
fd
,
ci
,
	`sd¦’
(ci)è!ğ(
ssize_t
)sd¦’(ci)è
”r
;

324 ià(
do_fsync
) {

325 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_FSYNC_CONFIG
;

326 
	`fsync
(
fd
);

331 ià(
cÚ‹Á_size
 !ğ
	`sd¦’
(
ci
è&& 
	`árunÿ‹
(
fd
,content_size) == -1) {

334 
	`şo£
(
fd
);

335 
	`sdsä“
(
ci
);

338 
”r
:

339 ià(
fd
 !ğ-1è
	`şo£
(fd);

340 
	`sdsä“
(
ci
);

342 
	}
}

344 
	$şu¡”SaveCÚfigOrD›
(
do_fsync
) {

345 ià(
	`şu¡”SaveCÚfig
(
do_fsync
) == -1) {

346 
	`»disLog
(
REDIS_WARNING
,"Fatal: can't update cluster config file.");

347 
	`ex™
(1);

349 
	}
}

360 
	$şu¡”LockCÚfig
(*
f’ame
) {

364 
fd
 = 
	`İ’
(
f’ame
,
O_WRONLY
|
O_CREAT
,0644);

365 ià(
fd
 == -1) {

366 
	`»disLog
(
REDIS_WARNING
,

368 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

369  
REDIS_ERR
;

372 ià(
	`æock
(
fd
,
LOCK_EX
|
LOCK_NB
) == -1) {

373 ià(
”ºo
 =ğ
EWOULDBLOCK
) {

374 
	`»disLog
(
REDIS_WARNING
,

378 "fes.", 
f’ame
);

380 
	`»disLog
(
REDIS_WARNING
,

381 "ImpossibËØlock %s: %s", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

383 
	`şo£
(
fd
);

384  
REDIS_ERR
;

388  
REDIS_OK
;

389 
	}
}

391 
	$şu¡”In™
() {

392 
§vecÚf
 = 0;

394 
£rv”
.
şu¡”
 = 
	`zm®loc
((
şu¡”S‹
));

395 
£rv”
.
şu¡”
->
my£lf
 = 
NULL
;

396 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

397 
£rv”
.
şu¡”
->
¡©e
 = 
REDIS_CLUSTER_FAIL
;

398 
£rv”
.
şu¡”
->
size
 = 1;

399 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

400 
£rv”
.
şu¡”
->
nodes
 = 
	`diùC»©e
(&
şu¡”NodesDiùTy³
,
NULL
);

401 
£rv”
.
şu¡”
->
nodes_bÏck_li¡
 =

402 
	`diùC»©e
(&
şu¡”NodesBÏckLi¡DiùTy³
,
NULL
);

403 
£rv”
.
şu¡”
->
çov”_auth_time
 = 0;

404 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

405 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

406 
£rv”
.
şu¡”
->
çov”_auth_•och
 = 0;

407 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
REDIS_CLUSTER_CANT_FAILOVER_NONE
;

408 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

409 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
 = 0;

410 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
 = 0;

411 
	`mem£t
(
£rv”
.
şu¡”
->
¦Ùs
,0, (server.cluster->slots));

412 
	`şu¡”Clo£AÎSlÙs
();

416 ià(
	`şu¡”LockCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
REDIS_ERR
)

417 
	`ex™
(1);

420 ià(
	`şu¡”LßdCÚfig
(
£rv”
.
şu¡”_cÚfigfe
è=ğ
REDIS_ERR
) {

423 
my£lf
 = 
£rv”
.
şu¡”
->myself =

424 
	`ü—‹Clu¡”Node
(
NULL
,
REDIS_NODE_MYSELF
|
REDIS_NODE_MASTER
);

425 
	`»disLog
(
REDIS_NOTICE
,"No cluster configuration found, I'm %.40s",

426 
my£lf
->
Çme
);

427 
	`şu¡”AddNode
(
my£lf
);

428 
§vecÚf
 = 1;

430 ià(
§vecÚf
è
	`şu¡”SaveCÚfigOrD›
(1);

433 
£rv”
.
cfd_couÁ
 = 0;

438 ià(
£rv”
.
pÜt
 > (65535-
REDIS_CLUSTER_PORT_INCR
)) {

439 
	`»disLog
(
REDIS_WARNING
, "Redis…ort‚umberoo high. "

444 
	`ex™
(1);

447 ià(
	`li¡’ToPÜt
(
£rv”
.
pÜt
+
REDIS_CLUSTER_PORT_INCR
,

448 
£rv”
.
cfd
,&£rv”.
cfd_couÁ
è=ğ
REDIS_ERR
)

450 
	`ex™
(1);

452 
j
;

454 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++) {

455 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
cfd
[
j
], 
AE_READABLE
,

456 
şu¡”Acû±HªdËr
, 
NULL
è=ğ
AE_ERR
)

457 
	`»disPªic
("Unrecoverableƒrror creating Redis Cluster "

463 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`z¦C»©e
();

467 
my£lf
->
pÜt
 = 
£rv”
.port;

469 
£rv”
.
şu¡”
->
mf_’d
 = 0;

470 
	`»£tMªu®Faov”
();

471 
	}
}

482 
	$şu¡”Re£t
(
h¬d
) {

483 
diùI‹¿tÜ
 *
di
;

484 
diùEÁry
 *
de
;

485 
j
;

488 ià(
	`nodeIsSÏve
(
my£lf
)) {

489 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

490 
	`»¶iÿtiÚUn£tMa¡”
();

491 
	`em±yDb
(
NULL
);

495 
	`şu¡”Clo£AÎSlÙs
();

496 
	`»£tMªu®Faov”
();

499 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++è
	`şu¡”D–SlÙ
(j);

502 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

503 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

504 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

506 ià(
node
 =ğ
my£lf
) ;

507 
	`şu¡”D–Node
(
node
);

509 
	`diùR–—£I‹¿tÜ
(
di
);

512 ià(
h¬d
) {

513 
sds
 
ŞdÇme
;

515 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 0;

516 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = 0;

517 
my£lf
->
cÚfigEpoch
 = 0;

518 
	`»disLog
(
REDIS_WARNING
, "configEpoch seto 0 via CLUSTER RESET HARD");

522 
ŞdÇme
 = 
	`sd¢ewËn
(
my£lf
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

523 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
ŞdÇme
);

524 
	`sdsä“
(
ŞdÇme
);

525 
	`g‘RªdomHexCh¬s
(
my£lf
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

526 
	`şu¡”AddNode
(
my£lf
);

530 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

531 
CLUSTER_TODO_UPDATE_STATE
|

532 
CLUSTER_TODO_FSYNC_CONFIG
);

533 
	}
}

539 
şu¡”Lšk
 *
	$ü—‹Clu¡”Lšk
(
şu¡”Node
 *
node
) {

540 
şu¡”Lšk
 *
lšk
 = 
	`zm®loc
((*link));

541 
lšk
->
ùime
 = 
	`m¡ime
();

542 
lšk
->
¢dbuf
 = 
	`sd£m±y
();

543 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

544 
lšk
->
node
 =‚ode;

545 
lšk
->
fd
 = -1;

546  
lšk
;

547 
	}
}

552 
	$ä“Clu¡”Lšk
(
şu¡”Lšk
 *
lšk
) {

553 ià(
lšk
->
fd
 != -1) {

554 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

555 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_READABLE
);

557 
	`sdsä“
(
lšk
->
¢dbuf
);

558 
	`sdsä“
(
lšk
->
rcvbuf
);

559 ià(
lšk
->
node
)

560 
lšk
->
node
->lšk = 
NULL
;

561 
	`şo£
(
lšk
->
fd
);

562 
	`zä“
(
lšk
);

563 
	}
}

565 
	#MAX_CLUSTER_ACCEPTS_PER_CALL
 1000

	)

566 
	$şu¡”Acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

567 
ıÜt
, 
cfd
;

568 
max
 = 
MAX_CLUSTER_ACCEPTS_PER_CALL
;

569 
c
[
REDIS_IP_STR_LEN
];

570 
şu¡”Lšk
 *
lšk
;

571 
	`REDIS_NOTUSED
(
–
);

572 
	`REDIS_NOTUSED
(
mask
);

573 
	`REDIS_NOTUSED
(
´ivd©a
);

577 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && s”v”.
lßdšg
) ;

579 
max
--) {

580 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

581 ià(
cfd
 =ğ
ANET_ERR
) {

582 ià(
”ºo
 !ğ
EWOULDBLOCK
)

583 
	`»disLog
(
REDIS_VERBOSE
,

584 "E¼Ü‡cû±šg clu¡”‚ode: %s", 
£rv”
.
Ã‹¼
);

587 
	`ª‘NÚBlock
(
NULL
,
cfd
);

588 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
cfd
);

591 
	`»disLog
(
REDIS_VERBOSE
,"Acû±ed clu¡”‚od%s:%d", 
c
, 
ıÜt
);

597 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
NULL
);

598 
lšk
->
fd
 = 
cfd
;

599 
	`«C»©eFeEv’t
(
£rv”
.
–
,
cfd
,
AE_READABLE
,
şu¡”R—dHªdËr
,
lšk
);

601 
	}
}

613 
	$keyHashSlÙ
(*
key
, 
keyËn
) {

614 
s
, 
e
;

616 
s
 = 0; s < 
keyËn
; s++)

617 ià(
key
[
s
] == '{') ;

620 ià(
s
 =ğ
keyËn
è 
	`üc16
(
key
,keylen) & 0x3FFF;

623 
e
 = 
s
+1;ƒ < 
keyËn
;ƒ++)

624 ià(
key
[
e
] == '}') ;

627 ià(
e
 =ğ
keyËn
 ||ƒ =ğ
s
+1è 
	`üc16
(
key
,keylen) & 0x3FFF;

631  
	`üc16
(
key
+
s
+1,
e
-s-1) & 0x3FFF;

632 
	}
}

645 
şu¡”Node
 *
	$ü—‹Clu¡”Node
(*
nod’ame
, 
æags
) {

646 
şu¡”Node
 *
node
 = 
	`zm®loc
((*node));

648 ià(
nod’ame
)

649 
	`memıy
(
node
->
Çme
, 
nod’ame
, 
REDIS_CLUSTER_NAMELEN
);

651 
	`g‘RªdomHexCh¬s
(
node
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

652 
node
->
ùime
 = 
	`m¡ime
();

653 
node
->
cÚfigEpoch
 = 0;

654 
node
->
æags
 = flags;

655 
	`mem£t
(
node
->
¦Ùs
,0,(node->slots));

656 
node
->
num¦Ùs
 = 0;

657 
node
->
num¦aves
 = 0;

658 
node
->
¦aves
 = 
NULL
;

659 
node
->
¦aveof
 = 
NULL
;

660 
node
->
pšg_£Á
 =‚ode->
pÚg_»ûived
 = 0;

661 
node
->
ç_time
 = 0;

662 
node
->
lšk
 = 
NULL
;

663 
	`mem£t
(
node
->

,0,(node->ip));

664 
node
->
pÜt
 = 0;

665 
node
->
ç_»pÜts
 = 
	`li¡C»©e
();

666 
node
->
vÙed_time
 = 0;

667 
node
->
»¶_off£t_time
 = 0;

668 
node
->
»¶_off£t
 = 0;

669 
	`li¡S‘F»eM‘hod
(
node
->
ç_»pÜts
,
zä“
);

670  
node
;

671 
	}
}

683 
	$şu¡”NodeAddFau»R•Üt
(
şu¡”Node
 *
çšg
, clu¡”Nod*
£nd”
) {

684 
li¡
 *
l
 = 
çšg
->
ç_»pÜts
;

685 
li¡Node
 *
Ê
;

686 
li¡I‹r
 
li
;

687 
şu¡”NodeFaR•Üt
 *
ä
;

691 
	`li¡Rewšd
(
l
,&
li
);

692 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

693 
ä
 = 
Ê
->
v®ue
;

694 ià(
ä
->
node
 =ğ
£nd”
) {

695 
ä
->
time
 = 
	`m¡ime
();

701 
ä
 = 
	`zm®loc
((*fr));

702 
ä
->
node
 = 
£nd”
;

703 
ä
->
time
 = 
	`m¡ime
();

704 
	`li¡AddNodeTa
(
l
,
ä
);

706 
	}
}

713 
	$şu¡”NodeCËªupFau»R•Üts
(
şu¡”Node
 *
node
) {

714 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

715 
li¡Node
 *
Ê
;

716 
li¡I‹r
 
li
;

717 
şu¡”NodeFaR•Üt
 *
ä
;

718 
m¡ime_t
 
maxtime
 = 
£rv”
.
şu¡”_node_timeout
 *

719 
REDIS_CLUSTER_FAIL_REPORT_VALIDITY_MULT
;

720 
m¡ime_t
 
now
 = 
	`m¡ime
();

722 
	`li¡Rewšd
(
l
,&
li
);

723 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

724 
ä
 = 
Ê
->
v®ue
;

725 ià(
now
 - 
ä
->
time
 > 
maxtime
è
	`li¡D–Node
(
l
,
Ê
);

727 
	}
}

740 
	$şu¡”NodeD–Fau»R•Üt
(
şu¡”Node
 *
node
, clu¡”Nod*
£nd”
) {

741 
li¡
 *
l
 = 
node
->
ç_»pÜts
;

742 
li¡Node
 *
Ê
;

743 
li¡I‹r
 
li
;

744 
şu¡”NodeFaR•Üt
 *
ä
;

747 
	`li¡Rewšd
(
l
,&
li
);

748 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

749 
ä
 = 
Ê
->
v®ue
;

750 ià(
ä
->
node
 =ğ
£nd”
) ;

752 ià(!
Ê
)  0;

755 
	`li¡D–Node
(
l
,
Ê
);

756 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

758 
	}
}

763 
	$şu¡”NodeFau»R•ÜtsCouÁ
(
şu¡”Node
 *
node
) {

764 
	`şu¡”NodeCËªupFau»R•Üts
(
node
);

765  
	`li¡L’gth
(
node
->
ç_»pÜts
);

766 
	}
}

768 
	$şu¡”NodeRemoveSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

769 
j
;

771 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++) {

772 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
) {

773 ià((
j
+1è< 
ma¡”
->
num¦aves
) {

774 
»maššg_¦aves
 = (
ma¡”
->
num¦aves
 - 
j
) - 1;

775 
	`memmove
(
ma¡”
->
¦aves
+
j
,master->slaves+(j+1),

776 ((*
ma¡”
->
¦aves
è* 
»maššg_¦aves
));

778 
ma¡”
->
num¦aves
--;

779  
REDIS_OK
;

782  
REDIS_ERR
;

783 
	}
}

785 
	$şu¡”NodeAddSÏve
(
şu¡”Node
 *
ma¡”
, clu¡”Nod*
¦ave
) {

786 
j
;

789 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

790 ià(
ma¡”
->
¦aves
[
j
] =ğ
¦ave
è 
REDIS_ERR
;

791 
ma¡”
->
¦aves
 = 
	`z»®loc
(master->slaves,

792 (
şu¡”Node
*)*(
ma¡”
->
num¦aves
+1));

793 
ma¡”
->
¦aves
[ma¡”->
num¦aves
] = 
¦ave
;

794 
ma¡”
->
num¦aves
++;

795  
REDIS_OK
;

796 
	}
}

798 
	$şu¡”NodeRe£tSÏves
(
şu¡”Node
 *
n
) {

799 
	`zä“
(
n
->
¦aves
);

800 
n
->
num¦aves
 = 0;

801 
n
->
¦aves
 = 
NULL
;

802 
	}
}

804 
	$şu¡”CouÁNÚFašgSÏves
(
şu¡”Node
 *
n
) {

805 
j
, 
ok¦aves
 = 0;

807 
j
 = 0; j < 
n
->
num¦aves
; j++)

808 ià(!
	`nodeFaed
(
n
->
¦aves
[
j
])è
ok¦aves
++;

809  
ok¦aves
;

810 
	}
}

813 
	$ä“Clu¡”Node
(
şu¡”Node
 *
n
) {

814 
sds
 
nod’ame
;

815 
j
;

819 ià(
	`nodeIsMa¡”
(
n
)) {

820 
j
 = 0; j < 
n
->
num¦aves
; j++)

821 
n
->
¦aves
[
j
]->
¦aveof
 = 
NULL
;

825 ià(
	`nodeIsSÏve
(
n
è&&‚->
¦aveof
è
	`şu¡”NodeRemoveSÏve
(n->slaveof,n);

828 
nod’ame
 = 
	`sd¢ewËn
(
n
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

829 
	`»disAs£¹
(
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
,
nod’ame
è=ğ
DICT_OK
);

830 
	`sdsä“
(
nod’ame
);

833 ià(
n
->
lšk
è
	`ä“Clu¡”Lšk
(n->link);

834 
	`li¡R–—£
(
n
->
ç_»pÜts
);

835 
	`zä“
(
n
->
¦aves
);

836 
	`zä“
(
n
);

837 
	}
}

840 
	$şu¡”AddNode
(
şu¡”Node
 *
node
) {

841 
»tv®
;

843 
»tv®
 = 
	`diùAdd
(
£rv”
.
şu¡”
->
nodes
,

844 
	`sd¢ewËn
(
node
->
Çme
,
REDIS_CLUSTER_NAMELEN
),‚ode);

845  (
»tv®
 =ğ
DICT_OK
è? 
REDIS_OK
 : 
REDIS_ERR
;

846 
	}
}

859 
	$şu¡”D–Node
(
şu¡”Node
 *
d–node
) {

860 
j
;

861 
diùI‹¿tÜ
 *
di
;

862 
diùEÁry
 *
de
;

865 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

866 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] =ğ
d–node
)

867 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

868 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] =ğ
d–node
)

869 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
] = 
NULL
;

870 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
d–node
)

871 
	`şu¡”D–SlÙ
(
j
);

875 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

876 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

877 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

879 ià(
node
 =ğ
d–node
) ;

880 
	`şu¡”NodeD–Fau»R•Üt
(
node
,
d–node
);

882 
	`diùR–—£I‹¿tÜ
(
di
);

885 
	`ä“Clu¡”Node
(
d–node
);

886 
	}
}

889 
şu¡”Node
 *
	$şu¡”LookupNode
(*
Çme
) {

890 
sds
 
s
 = 
	`sd¢ewËn
(
Çme
, 
REDIS_CLUSTER_NAMELEN
);

891 
diùEÁry
 *
de
;

893 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes
,
s
);

894 
	`sdsä“
(
s
);

895 ià(
de
 =ğ
NULL
)  NULL;

896  
	`diùG‘V®
(
de
);

897 
	}
}

903 
	$şu¡”R’ameNode
(
şu¡”Node
 *
node
, *
ÃwÇme
) {

904 
»tv®
;

905 
sds
 
s
 = 
	`sd¢ewËn
(
node
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

907 
	`»disLog
(
REDIS_DEBUG
,"Renaming‚ode %.40s into %.40s",

908 
node
->
Çme
, 
ÃwÇme
);

909 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes
, 
s
);

910 
	`sdsä“
(
s
);

911 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

912 
	`memıy
(
node
->
Çme
, 
ÃwÇme
, 
REDIS_CLUSTER_NAMELEN
);

913 
	`şu¡”AddNode
(
node
);

914 
	}
}

922 
ušt64_t
 
	$şu¡”G‘MaxEpoch
() {

923 
ušt64_t
 
max
 = 0;

924 
diùI‹¿tÜ
 *
di
;

925 
diùEÁry
 *
de
;

927 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

928 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

929 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

930 ià(
node
->
cÚfigEpoch
 > 
max
) max =‚ode->configEpoch;

932 
	`diùR–—£I‹¿tÜ
(
di
);

933 ià(
max
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) max = server.cluster->currentEpoch;

934  
max
;

935 
	}
}

966 
	$şu¡”BumpCÚfigEpochW™houtCÚ£nsus
() {

967 
ušt64_t
 
maxEpoch
 = 
	`şu¡”G‘MaxEpoch
();

969 ià(
my£lf
->
cÚfigEpoch
 == 0 ||

970 
my£lf
->
cÚfigEpoch
 !ğ
maxEpoch
)

972 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

973 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

974 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

975 
CLUSTER_TODO_FSYNC_CONFIG
);

976 
	`»disLog
(
REDIS_WARNING
,

978 (è
my£lf
->
cÚfigEpoch
);

979  
REDIS_OK
;

981  
REDIS_ERR
;

983 
	}
}

1031 
	$şu¡”HªdËCÚfigEpochCŞlisiÚ
(
şu¡”Node
 *
£nd”
) {

1033 ià(
£nd”
->
cÚfigEpoch
 !ğ
my£lf
->configEpoch ||

1034 !
	`nodeIsMa¡”
(
£nd”
è|| !nodeIsMa¡”(
my£lf
)) ;

1036 ià(
	`memcmp
(
£nd”
->
Çme
,
my£lf
->Çme,
REDIS_CLUSTER_NAMELEN
) <= 0) ;

1038 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

1039 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
cu¼’tEpoch
;

1040 
	`şu¡”SaveCÚfigOrD›
(1);

1041 
	`»disLog
(
REDIS_VERBOSE
,

1044 
£nd”
->
Çme
,

1045 (è
my£lf
->
cÚfigEpoch
);

1046 
	}
}

1070 
	#REDIS_CLUSTER_BLACKLIST_TTL
 60

	)

1079 
	$şu¡”BÏckli¡CËªup
() {

1080 
diùI‹¿tÜ
 *
di
;

1081 
diùEÁry
 *
de
;

1083 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
);

1084 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1085 
št64_t
 
expœe
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

1087 ià(
expœe
 < 
£rv”
.
unixtime
)

1088 
	`diùD–‘e
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
	`diùG‘Key
(
de
));

1090 
	`diùR–—£I‹¿tÜ
(
di
);

1091 
	}
}

1094 
	$şu¡”BÏckli¡AddNode
(
şu¡”Node
 *
node
) {

1095 
diùEÁry
 *
de
;

1096 
sds
 
id
 = 
	`sd¢ewËn
(
node
->
Çme
,
REDIS_CLUSTER_NAMELEN
);

1098 
	`şu¡”BÏckli¡CËªup
();

1099 ià(
	`diùAdd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
,
NULL
è=ğ
DICT_OK
) {

1102 
id
 = 
	`sdsdup
(id);

1104 
de
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
);

1105 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
	`time
(
NULL
)+
REDIS_CLUSTER_BLACKLIST_TTL
);

1106 
	`sdsä“
(
id
);

1107 
	}
}

1112 
	$şu¡”BÏckli¡Exi¡s
(*
nodeid
) {

1113 
sds
 
id
 = 
	`sd¢ewËn
(
nodeid
,
REDIS_CLUSTER_NAMELEN
);

1114 
»tv®
;

1116 
	`şu¡”BÏckli¡CËªup
();

1117 
»tv®
 = 
	`diùFšd
(
£rv”
.
şu¡”
->
nodes_bÏck_li¡
,
id
è!ğ
NULL
;

1118 
	`sdsä“
(
id
);

1119  
»tv®
;

1120 
	}
}

1147 
	$m¬kNodeAsFašgIfN“ded
(
şu¡”Node
 *
node
) {

1148 
çu»s
;

1149 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

1151 ià(!
	`nodeTimedOut
(
node
)) ;

1152 ià(
	`nodeFaed
(
node
)) ;

1154 
çu»s
 = 
	`şu¡”NodeFau»R•ÜtsCouÁ
(
node
);

1156 ià(
	`nodeIsMa¡”
(
my£lf
)è
çu»s
++;

1157 ià(
çu»s
 < 
Ãeded_quÜum
) ;

1159 
	`»disLog
(
REDIS_NOTICE
,

1160 "M¬kšg‚od%.40 a çšg (quÜum„—ched).", 
node
->
Çme
);

1163 
node
->
æags
 &ğ~
REDIS_NODE_PFAIL
;

1164 
node
->
æags
 |ğ
REDIS_NODE_FAIL
;

1165 
node
->
ç_time
 = 
	`m¡ime
();

1169 ià(
	`nodeIsMa¡”
(
my£lf
)è
	`şu¡”S’dFa
(
node
->
Çme
);

1170 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1171 
	}
}

1176 
	$ş—rNodeFau»IfN“ded
(
şu¡”Node
 *
node
) {

1177 
m¡ime_t
 
now
 = 
	`m¡ime
();

1179 
	`»disAs£¹
(
	`nodeFaed
(
node
));

1183 ià(
	`nodeIsSÏve
(
node
è||‚ode->
num¦Ùs
 == 0) {

1184 
	`»disLog
(
REDIS_NOTICE
,

1186 
node
->
Çme
,

1187 
	`nodeIsSÏve
(
node
) ? "slave" : "master without slots");

1188 
node
->
æags
 &ğ~
REDIS_NODE_FAIL
;

1189 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1196 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
 > 0 &&

1197 (
now
 - 
node
->
ç_time
) >

1198 (
£rv”
.
şu¡”_node_timeout
 * 
REDIS_CLUSTER_FAIL_UNDO_TIME_MULT
))

1200 
	`»disLog
(
REDIS_NOTICE
,

1202 
node
->
Çme
);

1203 
node
->
æags
 &ğ~
REDIS_NODE_FAIL
;

1204 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

1206 
	}
}

1211 
	$şu¡”HªdshakeInProg»ss
(*

, 
pÜt
) {

1212 
diùI‹¿tÜ
 *
di
;

1213 
diùEÁry
 *
de
;

1215 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

1216 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1217 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

1219 ià(!
	`nodeInHªdshake
(
node
)) ;

1220 ià(!
	`¡rÿ£cmp
(
node
->

,è&&‚ode->
pÜt
 ==…ort) ;

1222 
	`diùR–—£I‹¿tÜ
(
di
);

1223  
de
 !ğ
NULL
;

1224 
	}
}

1233 
	$şu¡”S¹Hªdshake
(*

, 
pÜt
) {

1234 
şu¡”Node
 *
n
;

1235 
nÜm_
[
REDIS_IP_STR_LEN
];

1236 
sockaddr_¡Üage
 
§
;

1239 ià(
	`š‘_±Ú
(
AF_INET
,

,

1240 &(((
sockaddr_š
 *)&
§
)->
sš_addr
)))

1242 
§
.
ss_çmy
 = 
AF_INET
;

1243 } ià(
	`š‘_±Ú
(
AF_INET6
,

,

1244 &(((
sockaddr_š6
 *)&
§
)->
sš6_addr
)))

1246 
§
.
ss_çmy
 = 
AF_INET6
;

1248 
”ºo
 = 
EINVAL
;

1253 ià(
pÜt
 <ğ0 ||…Üˆ> (65535-
REDIS_CLUSTER_PORT_INCR
)) {

1254 
”ºo
 = 
EINVAL
;

1260 
	`mem£t
(
nÜm_
,0,
REDIS_IP_STR_LEN
);

1261 ià(
§
.
ss_çmy
 =ğ
AF_INET
)

1262 
	`š‘_Áİ
(
AF_INET
,

1263 (*)&(((
sockaddr_š
 *)&
§
)->
sš_addr
),

1264 
nÜm_
,
REDIS_IP_STR_LEN
);

1266 
	`š‘_Áİ
(
AF_INET6
,

1267 (*)&(((
sockaddr_š6
 *)&
§
)->
sš6_addr
),

1268 
nÜm_
,
REDIS_IP_STR_LEN
);

1270 ià(
	`şu¡”HªdshakeInProg»ss
(
nÜm_
,
pÜt
)) {

1271 
”ºo
 = 
EAGAIN
;

1278 
n
 = 
	`ü—‹Clu¡”Node
(
NULL
,
REDIS_NODE_HANDSHAKE
|
REDIS_NODE_MEET
);

1279 
	`memıy
(
n
->

,
nÜm_
,(n->ip));

1280 
n
->
pÜt
 =…ort;

1281 
	`şu¡”AddNode
(
n
);

1283 
	}
}

1289 
	$şu¡”ProûssGossSeùiÚ
(
şu¡”Msg
 *
hdr
, 
şu¡”Lšk
 *
lšk
) {

1290 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1291 
şu¡”MsgD©aGoss
 *
g
 = (şu¡”MsgD©aGoss*è
hdr
->
d©a
.
pšg
.
goss
;

1292 
şu¡”Node
 *
£nd”
 = 
lšk
->
node
 ?†šk->nod: 
	`şu¡”LookupNode
(
hdr
->sender);

1294 
couÁ
--) {

1295 
ušt16_t
 
æags
 = 
	`Áohs
(
g
->flags);

1296 
şu¡”Node
 *
node
;

1297 
sds
 
ci
;

1299 
ci
 = 
	`»´e£ÁRedisNodeFÏgs
(
	`sd£m±y
(), 
æags
);

1300 
	`»disLog
(
REDIS_DEBUG
,"GOSSIP %.40s %s:%d %s",

1301 
g
->
nod’ame
,

1302 
g
->

,

1303 
	`Áohs
(
g
->
pÜt
),

1304 
ci
);

1305 
	`sdsä“
(
ci
);

1308 
node
 = 
	`şu¡”LookupNode
(
g
->
nod’ame
);

1309 ià(
node
) {

1312 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
node
 !ğ
my£lf
) {

1313 ià(
æags
 & (
REDIS_NODE_FAIL
|
REDIS_NODE_PFAIL
)) {

1314 ià(
	`şu¡”NodeAddFau»R•Üt
(
node
,
£nd”
)) {

1315 
	`»disLog
(
REDIS_VERBOSE
,

1317 
£nd”
->
Çme
, 
node
->name);

1319 
	`m¬kNodeAsFašgIfN“ded
(
node
);

1321 ià(
	`şu¡”NodeD–Fau»R•Üt
(
node
,
£nd”
)) {

1322 
	`»disLog
(
REDIS_VERBOSE
,

1324 
£nd”
->
Çme
, 
node
->name);

1334 ià(
node
->
æags
 & (
REDIS_NODE_FAIL
|
REDIS_NODE_PFAIL
) &&

1335 (
	`¡rÿ£cmp
(
node
->

,
g
->è||‚ode->
pÜt
 !ğ
	`Áohs
(g->port)))

1337 
	`şu¡”S¹Hªdshake
(
g
->

,
	`Áohs
(g->
pÜt
));

1346 ià(
£nd”
 &&

1347 !(
æags
 & 
REDIS_NODE_NOADDR
) &&

1348 !
	`şu¡”BÏckli¡Exi¡s
(
g
->
nod’ame
))

1350 
	`şu¡”S¹Hªdshake
(
g
->

,
	`Áohs
(g->
pÜt
));

1355 
g
++;

1357 
	}
}

1360 
	$nodeIp2SŒšg
(*
buf
, 
şu¡”Lšk
 *
lšk
) {

1361 
	`ª‘P“rToSŒšg
(
lšk
->
fd
, 
buf
, 
REDIS_IP_STR_LEN
, 
NULL
);

1362 
	}
}

1374 
	$nodeUpd©eAdd»ssIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Lšk
 *
lšk
, 
pÜt
) {

1375 

[
REDIS_IP_STR_LEN
] = {0};

1383 ià(
lšk
 =ğ
node
->link)  0;

1385 
	`nodeIp2SŒšg
(

,
lšk
);

1386 ià(
node
->
pÜt
 =ğpÜˆ&& 
	`¡rcmp
(

,node->ip) == 0)  0;

1389 
	`memıy
(
node
->

,ip,(ip));

1390 
node
->
pÜt
 =…ort;

1391 ià(
node
->
lšk
è
	`ä“Clu¡”Lšk
(node->link);

1392 
node
->
æags
 &ğ~
REDIS_NODE_NOADDR
;

1393 
	`»disLog
(
REDIS_WARNING
,"Address updated for‚ode %.40s,‚ow %s:%d",

1394 
node
->
Çme
,‚ode->

,‚ode->
pÜt
);

1398 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

1399 
	`»¶iÿtiÚS‘Ma¡”
(
node
->

,‚ode->
pÜt
);

1401 
	}
}

1406 
	$şu¡”S‘NodeAsMa¡”
(
şu¡”Node
 *
n
) {

1407 ià(
	`nodeIsMa¡”
(
n
)) ;

1409 ià(
n
->
¦aveof
è
	`şu¡”NodeRemoveSÏve
(n->slaveof,n);

1410 
n
->
æags
 &ğ~
REDIS_NODE_SLAVE
;

1411 
n
->
æags
 |ğ
REDIS_NODE_MASTER
;

1412 
n
->
¦aveof
 = 
NULL
;

1415 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1416 
CLUSTER_TODO_UPDATE_STATE
);

1417 
	}
}

1430 
	$şu¡”Upd©eSlÙsCÚfigW™h
(
şu¡”Node
 *
£nd”
, 
ušt64_t
 
£nd”CÚfigEpoch
, *
¦Ùs
) {

1431 
j
;

1432 
şu¡”Node
 *
curma¡”
, *
Ãwma¡”
 = 
NULL
;

1440 
ušt16_t
 
dœty_¦Ùs
[
REDIS_CLUSTER_SLOTS
];

1441 
dœty_¦Ùs_couÁ
 = 0;

1446 
curma¡”
 = 
	`nodeIsMa¡”
(
my£lf
è? my£là: my£lf->
¦aveof
;

1448 ià(
£nd”
 =ğ
my£lf
) {

1449 
	`»disLog
(
REDIS_WARNING
,"Discarding UPDATE message‡bout myself.");

1453 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

1454 ià(
	`b™m­Te¡B™
(
¦Ùs
,
j
)) {

1456 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
) ;

1462 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) ;

1468 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

1469 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 < 
£nd”CÚfigEpoch
)

1473 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 &&

1474 
	`couÁKeysInSlÙ
(
j
) &&

1475 
£nd”
 !ğ
my£lf
)

1477 
dœty_¦Ùs
[
dœty_¦Ùs_couÁ
] = 
j
;

1478 
dœty_¦Ùs_couÁ
++;

1481 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
curma¡”
)

1482 
Ãwma¡”
 = 
£nd”
;

1483 
	`şu¡”D–SlÙ
(
j
);

1484 
	`şu¡”AddSlÙ
(
£nd”
,
j
);

1485 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1486 
CLUSTER_TODO_UPDATE_STATE
|

1487 
CLUSTER_TODO_FSYNC_CONFIG
);

1499 ià(
Ãwma¡”
 && 
curma¡”
->
num¦Ùs
 == 0) {

1500 
	`»disLog
(
REDIS_WARNING
,

1502 "a ¨»¶iÿ oà%.40s", 
£nd”
->
Çme
);

1503 
	`şu¡”S‘Ma¡”
(
£nd”
);

1504 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1505 
CLUSTER_TODO_UPDATE_STATE
|

1506 
CLUSTER_TODO_FSYNC_CONFIG
);

1507 } ià(
dœty_¦Ùs_couÁ
) {

1515 
j
 = 0; j < 
dœty_¦Ùs_couÁ
; j++)

1516 
	`d–KeysInSlÙ
(
dœty_¦Ùs
[
j
]);

1518 
	}
}

1529 
	$şu¡”ProûssPack‘
(
şu¡”Lšk
 *
lšk
) {

1530 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
lšk
->
rcvbuf
;

1531 
ušt32_t
 
tÙËn
 = 
	`Áohl
(
hdr
->totlen);

1532 
ušt16_t
 
ty³
 = 
	`Áohs
(
hdr
->type);

1533 
ušt16_t
 
æags
 = 
	`Áohs
(
hdr
->flags);

1534 
ušt64_t
 
£nd”Cu¼’tEpoch
 = 0, 
£nd”CÚfigEpoch
 = 0;

1535 
şu¡”Node
 *
£nd”
;

1537 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived
++;

1538 
	`»disLog
(
REDIS_DEBUG
,"--- Processing…acket ofype %d, %lu bytes",

1539 
ty³
, (è
tÙËn
);

1542 ià(
tÙËn
 < 16)  1;

1543 ià(
	`Áohs
(
hdr
->
v”
è!ğ
CLUSTER_PROTO_VER
)

1545 ià(
tÙËn
 > 
	`sd¦’
(
lšk
->
rcvbuf
))  1;

1546 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1547 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1549 
ušt16_t
 
couÁ
 = 
	`Áohs
(
hdr
->count);

1550 
ušt32_t
 
ex¶’
;

1552 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1553 
ex¶’
 +ğ((
şu¡”MsgD©aGoss
)*
couÁ
);

1554 ià(
tÙËn
 !ğ
ex¶’
)  1;

1555 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1556 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1558 
ex¶’
 +ğ(
şu¡”MsgD©aFa
);

1559 ià(
tÙËn
 !ğ
ex¶’
)  1;

1560 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1561 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1563 
ex¶’
 +ğ(
şu¡”MsgD©aPublish
) -

1565 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
) +

1566 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
);

1567 ià(
tÙËn
 !ğ
ex¶’
)  1;

1568 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 ||

1569 
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 ||

1570 
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
)

1572 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1574 ià(
tÙËn
 !ğ
ex¶’
)  1;

1575 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1576 
ušt32_t
 
ex¶’
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

1578 
ex¶’
 +ğ(
şu¡”MsgD©aUpd©e
);

1579 ià(
tÙËn
 !ğ
ex¶’
)  1;

1583 
£nd”
 = 
	`şu¡”LookupNode
(
hdr
->sender);

1584 ià(
£nd”
 && !
	`nodeInHªdshake
(sender)) {

1586 
£nd”Cu¼’tEpoch
 = 
	`Áohu64
(
hdr
->
cu¼’tEpoch
);

1587 
£nd”CÚfigEpoch
 = 
	`Áohu64
(
hdr
->
cÚfigEpoch
);

1588 ià(
£nd”Cu¼’tEpoch
 > 
£rv”
.
şu¡”
->
cu¼’tEpoch
)

1589 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
£nd”Cu¼’tEpoch
;

1591 ià(
£nd”CÚfigEpoch
 > 
£nd”
->
cÚfigEpoch
) {

1592 
£nd”
->
cÚfigEpoch
 = 
£nd”CÚfigEpoch
;

1593 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1594 
CLUSTER_TODO_FSYNC_CONFIG
);

1597 
£nd”
->
»¶_off£t
 = 
	`Áohu64
(
hdr
->
off£t
);

1598 
£nd”
->
»¶_off£t_time
 = 
	`m¡ime
();

1601 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

1602 
	`nodeIsSÏve
(
my£lf
) &&

1603 
my£lf
->
¦aveof
 =ğ
£nd”
 &&

1604 
hdr
->
mæags
[0] & 
CLUSTERMSG_FLAG0_PAUSED
 &&

1605 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0)

1607 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 
£nd”
->
»¶_off£t
;

1608 
	`»disLog
(
REDIS_WARNING
,

1611 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
);

1616 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_MEET
) {

1617 
	`»disLog
(
REDIS_DEBUG
,"Pšg…ack‘„eûived: %p", (*)
lšk
->
node
);

1630 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
 || 
my£lf
->

[0] == '\0') {

1631 

[
REDIS_IP_STR_LEN
];

1633 ià(
	`ª‘SockName
(
lšk
->
fd
,

,(),
NULL
) != -1 &&

1634 
	`¡rcmp
(

,
my£lf
->ip))

1636 
	`memıy
(
my£lf
->

,,
REDIS_IP_STR_LEN
);

1637 
	`»disLog
(
REDIS_WARNING
,"IP‡ddress forhis‚ode updatedo %s",

1638 
my£lf
->

);

1639 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1647 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
) {

1648 
şu¡”Node
 *
node
;

1650 
node
 = 
	`ü—‹Clu¡”Node
(
NULL
,
REDIS_NODE_HANDSHAKE
);

1651 
	`nodeIp2SŒšg
(
node
->

,
lšk
);

1652 
node
->
pÜt
 = 
	`Áohs
(
hdr
->port);

1653 
	`şu¡”AddNode
(
node
);

1654 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1660 ià(!
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1661 
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1664 
	`şu¡”S’dPšg
(
lšk
,
CLUSTERMSG_TYPE_PONG
);

1668 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ||y³ =ğ
CLUSTERMSG_TYPE_PONG
 ||

1669 
ty³
 =ğ
CLUSTERMSG_TYPE_MEET
)

1671 
	`»disLog
(
REDIS_DEBUG
,"%s…acket„eceived: %p",

1672 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 ? "ping" : "pong",

1673 (*)
lšk
->
node
);

1674 ià(
lšk
->
node
) {

1675 ià(
	`nodeInHªdshake
(
lšk
->
node
)) {

1678 ià(
£nd”
) {

1679 
	`»disLog
(
REDIS_VERBOSE
,

1681 "upd©šghadd»s iàÃeded.", 
£nd”
->
Çme
);

1682 ià(
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
	`Áohs
(
hdr
->
pÜt
)))

1684 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1685 
CLUSTER_TODO_UPDATE_STATE
);

1689 
	`şu¡”D–Node
(
lšk
->
node
);

1695 
	`şu¡”R’ameNode
(
lšk
->
node
, 
hdr
->
£nd”
);

1696 
	`»disLog
(
REDIS_DEBUG
,"Handshake with‚ode %.40s completed.",

1697 
lšk
->
node
->
Çme
);

1698 
lšk
->
node
->
æags
 &ğ~
REDIS_NODE_HANDSHAKE
;

1699 
lšk
->
node
->
æags
 |ğæags&(
REDIS_NODE_MASTER
|
REDIS_NODE_SLAVE
);

1700 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1701 } ià(
	`memcmp
(
lšk
->
node
->
Çme
,
hdr
->
£nd”
,

1702 
REDIS_CLUSTER_NAMELEN
) != 0)

1707 
	`»disLog
(
REDIS_DEBUG
,"PONG contains mismatching sender ID");

1708 
lšk
->
node
->
æags
 |ğ
REDIS_NODE_NOADDR
;

1709 
lšk
->
node
->

[0] = '\0';

1710 
lšk
->
node
->
pÜt
 = 0;

1711 
	`ä“Clu¡”Lšk
(
lšk
);

1712 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1718 ià(
£nd”
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
 &&

1719 !
	`nodeInHªdshake
(
£nd”
) &&

1720 
	`nodeUpd©eAdd»ssIfN“ded
(
£nd”
,
lšk
,
	`Áohs
(
hdr
->
pÜt
)))

1722 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1723 
CLUSTER_TODO_UPDATE_STATE
);

1727 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PONG
) {

1728 
lšk
->
node
->
pÚg_»ûived
 = 
	`m¡ime
();

1729 
lšk
->
node
->
pšg_£Á
 = 0;

1737 ià(
	`nodeTimedOut
(
lšk
->
node
)) {

1738 
lšk
->
node
->
æags
 &ğ~
REDIS_NODE_PFAIL
;

1739 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1740 
CLUSTER_TODO_UPDATE_STATE
);

1741 } ià(
	`nodeFaed
(
lšk
->
node
)) {

1742 
	`ş—rNodeFau»IfN“ded
(
lšk
->
node
);

1747 ià(
£nd”
) {

1748 ià(!
	`memcmp
(
hdr
->
¦aveof
,
REDIS_NODE_NULL_NAME
,

1749 (
hdr
->
¦aveof
)))

1752 
	`şu¡”S‘NodeAsMa¡”
(
£nd”
);

1755 
şu¡”Node
 *
ma¡”
 = 
	`şu¡”LookupNode
(
hdr
->
¦aveof
);

1757 ià(
	`nodeIsMa¡”
(
£nd”
)) {

1759 
	`şu¡”D–NodeSlÙs
(
£nd”
);

1760 
£nd”
->
æags
 &ğ~
REDIS_NODE_MASTER
;

1761 
£nd”
->
æags
 |ğ
REDIS_NODE_SLAVE
;

1764 ià(
£nd”
->
num¦aves
è
	`şu¡”NodeRe£tSÏves
(sender);

1767 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1768 
CLUSTER_TODO_UPDATE_STATE
);

1772 ià(
ma¡”
 && 
£nd”
->
¦aveof
 != master) {

1773 ià(
£nd”
->
¦aveof
)

1774 
	`şu¡”NodeRemoveSÏve
(
£nd”
->
¦aveof
,sender);

1775 
	`şu¡”NodeAddSÏve
(
ma¡”
,
£nd”
);

1776 
£nd”
->
¦aveof
 = 
ma¡”
;

1779 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
);

1793 
şu¡”Node
 *
£nd”_ma¡”
 = 
NULL
;

1794 
dœty_¦Ùs
 = 0;

1796 ià(
£nd”
) {

1797 
£nd”_ma¡”
 = 
	`nodeIsMa¡”
(
£nd”
è? s’d” : s’d”->
¦aveof
;

1798 ià(
£nd”_ma¡”
) {

1799 
dœty_¦Ùs
 = 
	`memcmp
(
£nd”_ma¡”
->
¦Ùs
,

1800 
hdr
->
my¦Ùs
,(hdr->myslots)) != 0;

1807 ià(
£nd”
 && 
	`nodeIsMa¡”
(£nd”è&& 
dœty_¦Ùs
)

1808 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
£nd”
,
£nd”CÚfigEpoch
,
hdr
->
my¦Ùs
);

1828 ià(
£nd”
 && 
dœty_¦Ùs
) {

1829 
j
;

1831 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

1832 ià(
	`b™m­Te¡B™
(
hdr
->
my¦Ùs
,
j
)) {

1833 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
£nd”
 ||

1834 
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) ;

1835 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 >

1836 
£nd”CÚfigEpoch
)

1838 
	`»disLog
(
REDIS_VERBOSE
,

1841 
£nd”
->
Çme
, 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->name);

1842 
	`şu¡”S’dUpd©e
(
£nd”
->
lšk
,

1843 
£rv”
.
şu¡”
->
¦Ùs
[
j
]);

1856 ià(
£nd”
 &&

1857 
	`nodeIsMa¡”
(
my£lf
è&&‚odeIsMa¡”(
£nd”
) &&

1858 
£nd”CÚfigEpoch
 =ğ
my£lf
->
cÚfigEpoch
)

1860 
	`şu¡”HªdËCÚfigEpochCŞlisiÚ
(
£nd”
);

1864 ià(
£nd”
è
	`şu¡”ProûssGossSeùiÚ
(
hdr
,
lšk
);

1865 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

1866 
şu¡”Node
 *
çšg
;

1868 ià(
£nd”
) {

1869 
çšg
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
);

1870 ià(
çšg
 &&

1871 !(
çšg
->
æags
 & (
REDIS_NODE_FAIL
|
REDIS_NODE_MYSELF
)))

1873 
	`»disLog
(
REDIS_NOTICE
,

1875 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1876 
çšg
->
æags
 |ğ
REDIS_NODE_FAIL
;

1877 
çšg
->
ç_time
 = 
	`m¡ime
();

1878 
çšg
->
æags
 &ğ~
REDIS_NODE_PFAIL
;

1879 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1880 
CLUSTER_TODO_UPDATE_STATE
);

1883 
	`»disLog
(
REDIS_NOTICE
,

1885 
hdr
->
£nd”
, hdr->
d©a
.
ç
.
about
.
nod’ame
);

1887 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_PUBLISH
) {

1888 
robj
 *
chªÃl
, *
mes§ge
;

1889 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

1893 ià(
	`diùSize
(
£rv”
.
pubsub_chªÃls
) ||

1894 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
))

1896 
chªÃl_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.channel_len);

1897 
mes§ge_Ën
 = 
	`Áohl
(
hdr
->
d©a
.
publish
.
msg
.message_len);

1898 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(

1899 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl_Ën
);

1900 
mes§ge
 = 
	`ü—‹SŒšgObjeù
(

1901 (*)
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
chªÃl_Ën
,

1902 
mes§ge_Ën
);

1903 
	`pubsubPublishMes§ge
(
chªÃl
,
mes§ge
);

1904 
	`deüRefCouÁ
(
chªÃl
);

1905 
	`deüRefCouÁ
(
mes§ge
);

1907 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
) {

1908 ià(!
£nd”
)  1;

1909 
	`şu¡”S’dFaov”AuthIfN“ded
(
£nd”
,
hdr
);

1910 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
) {

1911 ià(!
£nd”
)  1;

1915 ià(
	`nodeIsMa¡”
(
£nd”
è&& s’d”->
num¦Ùs
 > 0 &&

1916 
£nd”Cu¼’tEpoch
 >ğ
£rv”
.
şu¡”
->
çov”_auth_•och
)

1918 
£rv”
.
şu¡”
->
çov”_auth_couÁ
++;

1921 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_HANDLE_FAILOVER
);

1923 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_MFSTART
) {

1926 ià(!
£nd”
 || s’d”->
¦aveof
 !ğ
my£lf
)  1;

1929 
	`»£tMªu®Faov”
();

1930 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
REDIS_CLUSTER_MF_TIMEOUT
;

1931 
£rv”
.
şu¡”
->
mf_¦ave
 = 
£nd”
;

1932 
	`·u£Cl›Ás
(
	`m¡ime
()+(
REDIS_CLUSTER_MF_TIMEOUT
*2));

1933 
	`»disLog
(
REDIS_WARNING
,"Manual failover„equested by slave %.40s.",

1934 
£nd”
->
Çme
);

1935 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

1936 
şu¡”Node
 *
n
;

1937 
ušt64_t
 
»pÜ‹dCÚfigEpoch
 =

1938 
	`Áohu64
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
);

1940 ià(!
£nd”
)  1;

1941 
n
 = 
	`şu¡”LookupNode
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
);

1942 ià(!
n
)  1;

1943 ià(
n
->
cÚfigEpoch
 >ğ
»pÜ‹dCÚfigEpoch
)  1;

1946 ià(
	`nodeIsSÏve
(
n
)è
	`şu¡”S‘NodeAsMa¡”
(n);

1949 
n
->
cÚfigEpoch
 = 
»pÜ‹dCÚfigEpoch
;

1950 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

1951 
CLUSTER_TODO_FSYNC_CONFIG
);

1955 
	`şu¡”Upd©eSlÙsCÚfigW™h
(
n
,
»pÜ‹dCÚfigEpoch
,

1956 
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
);

1958 
	`»disLog
(
REDIS_WARNING
,"Reûived unknowÀ·ck‘y³: %d", 
ty³
);

1961 
	}
}

1969 
	$hªdËLškIOE¼Ü
(
şu¡”Lšk
 *
lšk
) {

1970 
	`ä“Clu¡”Lšk
(
lšk
);

1971 
	}
}

1976 
	$şu¡”Wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1977 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

1978 
ssize_t
 
nwr™‹n
;

1979 
	`REDIS_NOTUSED
(
–
);

1980 
	`REDIS_NOTUSED
(
mask
);

1982 
nwr™‹n
 = 
	`wr™e
(
fd
, 
lšk
->
¢dbuf
, 
	`sd¦’
(link->sndbuf));

1983 ià(
nwr™‹n
 <= 0) {

1984 
	`»disLog
(
REDIS_DEBUG
,"I/Oƒrror writingo‚ode†ink: %s",

1985 
	`¡»¼Ü
(
”ºo
));

1986 
	`hªdËLškIOE¼Ü
(
lšk
);

1989 
	`sd¤ªge
(
lšk
->
¢dbuf
,
nwr™‹n
,-1);

1990 ià(
	`sd¦’
(
lšk
->
¢dbuf
) == 0)

1991 
	`«D–‘eFeEv’t
(
£rv”
.
–
, 
lšk
->
fd
, 
AE_WRITABLE
);

1992 
	}
}

1997 
	$şu¡”R—dHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1998 
buf
[(
şu¡”Msg
)];

1999 
ssize_t
 
Ä—d
;

2000 
şu¡”Msg
 *
hdr
;

2001 
şu¡”Lšk
 *
lšk
 = (şu¡”Lšk*è
´ivd©a
;

2002 
»adËn
, 
rcvbuæ’
;

2003 
	`REDIS_NOTUSED
(
–
);

2004 
	`REDIS_NOTUSED
(
mask
);

2007 
rcvbuæ’
 = 
	`sd¦’
(
lšk
->
rcvbuf
);

2008 ià(
rcvbuæ’
 < 8) {

2011 
»adËn
 = 8 - 
rcvbuæ’
;

2014 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2015 ià(
rcvbuæ’
 == 8) {

2018 ià(
	`memcmp
(
hdr
->
sig
,"RCmb",4) != 0 ||

2019 
	`Áohl
(
hdr
->
tÙËn
è< 
CLUSTERMSG_MIN_LEN
)

2021 
	`»disLog
(
REDIS_WARNING
,

2024 
	`hªdËLškIOE¼Ü
(
lšk
);

2028 
»adËn
 = 
	`Áohl
(
hdr
->
tÙËn
è- 
rcvbuæ’
;

2029 ià(
»adËn
 > (
buf
))„eadlen = (buf);

2032 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

2033 ià(
Ä—d
 =ğ-1 && 
”ºo
 =ğ
EAGAIN
) ;

2035 ià(
Ä—d
 <= 0) {

2037 
	`»disLog
(
REDIS_DEBUG
,"I/Oƒrror„eading from‚ode†ink: %s",

2038 (
Ä—d
 =ğ0è? "cÚÃùiÚ clo£d" : 
	`¡»¼Ü
(
”ºo
));

2039 
	`hªdËLškIOE¼Ü
(
lšk
);

2043 
lšk
->
rcvbuf
 = 
	`sdsÿ’
Öšk->rcvbuf,
buf
,
Ä—d
);

2044 
hdr
 = (
şu¡”Msg
*è
lšk
->
rcvbuf
;

2045 
rcvbuæ’
 +ğ
Ä—d
;

2049 ià(
rcvbuæ’
 >ğ8 &&„cvbuæ’ =ğ
	`Áohl
(
hdr
->
tÙËn
)) {

2050 ià(
	`şu¡”ProûssPack‘
(
lšk
)) {

2051 
	`sdsä“
(
lšk
->
rcvbuf
);

2052 
lšk
->
rcvbuf
 = 
	`sd£m±y
();

2058 
	}
}

2065 
	$şu¡”S’dMes§ge
(
şu¡”Lšk
 *
lšk
, *
msg
, 
size_t
 
msgËn
) {

2066 ià(
	`sd¦’
(
lšk
->
¢dbuf
è=ğ0 && 
msgËn
 != 0)

2067 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_WRITABLE
,

2068 
şu¡”Wr™eHªdËr
,
lšk
);

2070 
lšk
->
¢dbuf
 = 
	`sdsÿ’
Öšk->¢dbuf, 
msg
, 
msgËn
);

2071 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
++;

2072 
	}
}

2080 
	$şu¡”Brßdÿ¡Mes§ge
(*
buf
, 
size_t
 
Ën
) {

2081 
diùI‹¿tÜ
 *
di
;

2082 
diùEÁry
 *
de
;

2084 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2085 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2086 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2088 ià(!
node
->
lšk
) ;

2089 ià(
node
->
æags
 & (
REDIS_NODE_MYSELF
|
REDIS_NODE_HANDSHAKE
))

2091 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
Ën
);

2093 
	`diùR–—£I‹¿tÜ
(
di
);

2094 
	}
}

2098 
	$şu¡”BudMes§geHdr
(
şu¡”Msg
 *
hdr
, 
ty³
) {

2099 
tÙËn
 = 0;

2100 
ušt64_t
 
off£t
;

2101 
şu¡”Node
 *
ma¡”
;

2107 
ma¡”
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

2108 
my£lf
->
¦aveof
 : myself;

2110 
	`mem£t
(
hdr
,0,(*hdr));

2111 
hdr
->
v”
 = 
	`htÚs
(
CLUSTER_PROTO_VER
);

2112 
hdr
->
sig
[0] = 'R';

2113 
hdr
->
sig
[1] = 'C';

2114 
hdr
->
sig
[2] = 'm';

2115 
hdr
->
sig
[3] = 'b';

2116 
hdr
->
ty³
 = 
	`htÚs
(type);

2117 
	`memıy
(
hdr
->
£nd”
,
my£lf
->
Çme
,
REDIS_CLUSTER_NAMELEN
);

2119 
	`memıy
(
hdr
->
my¦Ùs
,
ma¡”
->
¦Ùs
,(hdr->myslots));

2120 
	`mem£t
(
hdr
->
¦aveof
,0,
REDIS_CLUSTER_NAMELEN
);

2121 ià(
my£lf
->
¦aveof
 !ğ
NULL
)

2122 
	`memıy
(
hdr
->
¦aveof
,
my£lf
->¦aveof->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

2123 
hdr
->
pÜt
 = 
	`htÚs
(
£rv”
.port);

2124 
hdr
->
æags
 = 
	`htÚs
(
my£lf
->flags);

2125 
hdr
->
¡©e
 = 
£rv”
.
şu¡”
->state;

2128 
hdr
->
cu¼’tEpoch
 = 
	`htÚu64
(
£rv”
.
şu¡”
->currentEpoch);

2129 
hdr
->
cÚfigEpoch
 = 
	`htÚu64
(
ma¡”
->configEpoch);

2132 ià(
	`nodeIsSÏve
(
my£lf
))

2133 
off£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2135 
off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

2136 
hdr
->
off£t
 = 
	`htÚu64
(offset);

2139 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
£rv”
.
şu¡”
->
mf_’d
)

2140 
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_PAUSED
;

2144 ià(
ty³
 =ğ
CLUSTERMSG_TYPE_FAIL
) {

2145 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2146 
tÙËn
 +ğ(
şu¡”MsgD©aFa
);

2147 } ià(
ty³
 =ğ
CLUSTERMSG_TYPE_UPDATE
) {

2148 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2149 
tÙËn
 +ğ(
şu¡”MsgD©aUpd©e
);

2151 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2153 
	}
}

2157 
	$şu¡”S’dPšg
(
şu¡”Lšk
 *
lšk
, 
ty³
) {

2158 *
buf
;

2159 
şu¡”Msg
 *
hdr
;

2160 
gosscouÁ
 = 0;

2161 
wª‹d
;

2162 
tÙËn
;

2167 
äeshnodes
 = 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)-2;

2195 
wª‹d
 = 
	`æoÜ
(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
)/10);

2196 ià(
wª‹d
 < 3) wanted = 3;

2197 ià(
wª‹d
 > 
äeshnodes
) wanted = freshnodes;

2202 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2203 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
wª‹d
);

2206 ià(
tÙËn
 < ()(
şu¡”Msg
))otlen = (clusterMsg);

2207 
buf
 = 
	`zÿÎoc
(
tÙËn
);

2208 
hdr
 = (
şu¡”Msg
*è
buf
;

2211 ià(
lšk
->
node
 && 
ty³
 =ğ
CLUSTERMSG_TYPE_PING
)

2212 
lšk
->
node
->
pšg_£Á
 = 
	`m¡ime
();

2213 
	`şu¡”BudMes§geHdr
(
hdr
,
ty³
);

2216 
max™”©iÚs
 = 
wª‹d
*3;

2217 
äeshnodes
 > 0 && 
gosscouÁ
 < 
wª‹d
 && 
max™”©iÚs
--) {

2218 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

2219 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

2220 
şu¡”MsgD©aGoss
 *
goss
;

2221 
j
;

2225 ià(
this
 =ğ
my£lf
) ;

2228 ià(
max™”©iÚs
 > 
wª‹d
*2 &&

2229 !(
this
->
æags
 & (
REDIS_NODE_PFAIL
|
REDIS_NODE_FAIL
)))

2237 ià(
this
->
æags
 & (
REDIS_NODE_HANDSHAKE
|
REDIS_NODE_NOADDR
) ||

2238 (
this
->
lšk
 =ğ
NULL
 &&his->
num¦Ùs
 == 0))

2240 
äeshnodes
--;

2245 
j
 = 0; j < 
gosscouÁ
; j++) {

2246 ià(
	`memcmp
(
hdr
->
d©a
.
pšg
.
goss
[
j
].
nod’ame
,
this
->
Çme
,

2247 
REDIS_CLUSTER_NAMELEN
) == 0) ;

2249 ià(
j
 !ğ
gosscouÁ
) ;

2252 
äeshnodes
--;

2253 
goss
 = &(
hdr
->
d©a
.
pšg
.goss[
gosscouÁ
]);

2254 
	`memıy
(
goss
->
nod’ame
,
this
->
Çme
,
REDIS_CLUSTER_NAMELEN
);

2255 
goss
->
pšg_£Á
 = 
	`htÚl
(
this
->ping_sent);

2256 
goss
->
pÚg_»ûived
 = 
	`htÚl
(
this
->pong_received);

2257 
	`memıy
(
goss
->

,
this
->ip,(this->ip));

2258 
goss
->
pÜt
 = 
	`htÚs
(
this
->port);

2259 
goss
->
æags
 = 
	`htÚs
(
this
->flags);

2260 
goss
->
nÙu£d1
 = 0;

2261 
goss
->
nÙu£d2
 = 0;

2262 
gosscouÁ
++;

2267 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2268 
tÙËn
 +ğ((
şu¡”MsgD©aGoss
)*
gosscouÁ
);

2269 
hdr
->
couÁ
 = 
	`htÚs
(
gosscouÁ
);

2270 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2271 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
tÙËn
);

2272 
	`zä“
(
buf
);

2273 
	}
}

2289 
	#CLUSTER_BROADCAST_ALL
 0

	)

2290 
	#CLUSTER_BROADCAST_LOCAL_SLAVES
 1

	)

2291 
	$şu¡”Brßdÿ¡PÚg
(
rg‘
) {

2292 
diùI‹¿tÜ
 *
di
;

2293 
diùEÁry
 *
de
;

2295 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2296 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2297 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2299 ià(!
node
->
lšk
) ;

2300 ià(
node
 =ğ
my£lf
 || 
	`nodeInHªdshake
(node)) ;

2301 ià(
rg‘
 =ğ
CLUSTER_BROADCAST_LOCAL_SLAVES
) {

2302 
loÿl_¦ave
 =

2303 
	`nodeIsSÏve
(
node
è&&‚ode->
¦aveof
 &&

2304 (
node
->
¦aveof
 =ğ
my£lf
 ||‚ode->slaveof == myself->slaveof);

2305 ià(!
loÿl_¦ave
) ;

2307 
	`şu¡”S’dPšg
(
node
->
lšk
,
CLUSTERMSG_TYPE_PONG
);

2309 
	`diùR–—£I‹¿tÜ
(
di
);

2310 
	}
}

2315 
	$şu¡”S’dPublish
(
şu¡”Lšk
 *
lšk
, 
robj
 *
chªÃl
,„obj *
mes§ge
) {

2316 
buf
[(
şu¡”Msg
)], *
·ylßd
;

2317 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2318 
ušt32_t
 
tÙËn
;

2319 
ušt32_t
 
chªÃl_Ën
, 
mes§ge_Ën
;

2321 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

2322 
mes§ge
 = 
	`g‘DecodedObjeù
(message);

2323 
chªÃl_Ën
 = 
	`sd¦’
(
chªÃl
->
±r
);

2324 
mes§ge_Ën
 = 
	`sd¦’
(
mes§ge
->
±r
);

2326 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_PUBLISH
);

2327 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2328 
tÙËn
 +ğ(
şu¡”MsgD©aPublish
è- 8 + 
chªÃl_Ën
 + 
mes§ge_Ën
;

2330 
hdr
->
d©a
.
publish
.
msg
.
chªÃl_Ën
 = 
	`htÚl
(channel_len);

2331 
hdr
->
d©a
.
publish
.
msg
.
mes§ge_Ën
 = 
	`htÚl
(message_len);

2332 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2335 ià(
tÙËn
 < (
buf
)) {

2336 
·ylßd
 = 
buf
;

2338 
·ylßd
 = 
	`zm®loc
(
tÙËn
);

2339 
	`memıy
(
·ylßd
,
hdr
,(*hdr));

2340 
hdr
 = (
şu¡”Msg
*è
·ylßd
;

2342 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
,
chªÃl
->
±r
,
	`sd¦’
(channel->ptr));

2343 
	`memıy
(
hdr
->
d©a
.
publish
.
msg
.
bulk_d©a
+
	`sd¦’
(
chªÃl
->
±r
),

2344 
mes§ge
->
±r
,
	`sd¦’
(message->ptr));

2346 ià(
lšk
)

2347 
	`şu¡”S’dMes§ge
(
lšk
,
·ylßd
,
tÙËn
);

2349 
	`şu¡”Brßdÿ¡Mes§ge
(
·ylßd
,
tÙËn
);

2351 
	`deüRefCouÁ
(
chªÃl
);

2352 
	`deüRefCouÁ
(
mes§ge
);

2353 ià(
·ylßd
 !ğ
buf
è
	`zä“
(payload);

2354 
	}
}

2361 
	$şu¡”S’dFa
(*
nod’ame
) {

2362 
buf
[(
şu¡”Msg
)];

2363 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2365 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAIL
);

2366 
	`memıy
(
hdr
->
d©a
.
ç
.
about
.
nod’ame
,nod’ame,
REDIS_CLUSTER_NAMELEN
);

2367 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2368 
	}
}

2373 
	$şu¡”S’dUpd©e
(
şu¡”Lšk
 *
lšk
, 
şu¡”Node
 *
node
) {

2374 
buf
[(
şu¡”Msg
)];

2375 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2377 ià(
lšk
 =ğ
NULL
) ;

2378 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_UPDATE
);

2379 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
nod’ame
,
node
->
Çme
,
REDIS_CLUSTER_NAMELEN
);

2380 
hdr
->
d©a
.
upd©e
.
nodecfg
.
cÚfigEpoch
 = 
	`htÚu64
(
node
->configEpoch);

2381 
	`memıy
(
hdr
->
d©a
.
upd©e
.
nodecfg
.
¦Ùs
,
node
->slots,(node->slots));

2382 
	`şu¡”S’dMes§ge
(
lšk
,
buf
,
	`Áohl
(
hdr
->
tÙËn
));

2383 
	}
}

2392 
	$şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

2393 
	`şu¡”S’dPublish
(
NULL
, 
chªÃl
, 
mes§ge
);

2394 
	}
}

2406 
	$şu¡”Reque¡Faov”Auth
() {

2407 
buf
[(
şu¡”Msg
)];

2408 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2409 
ušt32_t
 
tÙËn
;

2411 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
);

2415 ià(
£rv”
.
şu¡”
->
mf_’d
è
hdr
->
mæags
[0] |ğ
CLUSTERMSG_FLAG0_FORCEACK
;

2416 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2417 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2418 
	`şu¡”Brßdÿ¡Mes§ge
(
buf
,
tÙËn
);

2419 
	}
}

2422 
	$şu¡”S’dFaov”Auth
(
şu¡”Node
 *
node
) {

2423 
buf
[(
şu¡”Msg
)];

2424 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2425 
ušt32_t
 
tÙËn
;

2427 ià(!
node
->
lšk
) ;

2428 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
);

2429 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2430 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2431 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2432 
	}
}

2435 
	$şu¡”S’dMFS¹
(
şu¡”Node
 *
node
) {

2436 
buf
[(
şu¡”Msg
)];

2437 
şu¡”Msg
 *
hdr
 = (şu¡”Msg*è
buf
;

2438 
ušt32_t
 
tÙËn
;

2440 ià(!
node
->
lšk
) ;

2441 
	`şu¡”BudMes§geHdr
(
hdr
,
CLUSTERMSG_TYPE_MFSTART
);

2442 
tÙËn
 = (
şu¡”Msg
)-(
şu¡”MsgD©a
);

2443 
hdr
->
tÙËn
 = 
	`htÚl
(totlen);

2444 
	`şu¡”S’dMes§ge
(
node
->
lšk
,
buf
,
tÙËn
);

2445 
	}
}

2448 
	$şu¡”S’dFaov”AuthIfN“ded
(
şu¡”Node
 *
node
, 
şu¡”Msg
 *
»que¡
) {

2449 
şu¡”Node
 *
ma¡”
 = 
node
->
¦aveof
;

2450 
ušt64_t
 
»que¡Cu¼’tEpoch
 = 
	`Áohu64
(
»que¡
->
cu¼’tEpoch
);

2451 
ušt64_t
 
»que¡CÚfigEpoch
 = 
	`Áohu64
(
»que¡
->
cÚfigEpoch
);

2452 *
şaimed_¦Ùs
 = 
»que¡
->
my¦Ùs
;

2453 
fÜû_ack
 = 
»que¡
->
mæags
[0] & 
CLUSTERMSG_FLAG0_FORCEACK
;

2454 
j
;

2460 ià(
	`nodeIsSÏve
(
my£lf
è|| my£lf->
num¦Ùs
 == 0) ;

2466 ià(
»que¡Cu¼’tEpoch
 < 
£rv”
.
şu¡”
->
cu¼’tEpoch
) {

2467 
	`»disLog
(
REDIS_WARNING
,

2469 
node
->
Çme
,

2470 (è
»que¡Cu¼’tEpoch
,

2471 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2476 ià(
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 =ğ£rv”.şu¡”->
cu¼’tEpoch
) {

2477 
	`»disLog
(
REDIS_WARNING
,

2479 
node
->
Çme
,

2480 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2487 ià(
	`nodeIsMa¡”
(
node
è|| 
ma¡”
 =ğ
NULL
 ||

2488 (!
	`nodeFaed
(
ma¡”
è&& !
fÜû_ack
))

2490 ià(
	`nodeIsMa¡”
(
node
)) {

2491 
	`»disLog
(
REDIS_WARNING
,

2493 
node
->
Çme
);

2494 } ià(
ma¡”
 =ğ
NULL
) {

2495 
	`»disLog
(
REDIS_WARNING
,

2497 
node
->
Çme
);

2498 } ià(!
	`nodeFaed
(
ma¡”
)) {

2499 
	`»disLog
(
REDIS_WARNING
,

2501 
node
->
Çme
);

2509 ià(
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
 < 
£rv”
.
şu¡”_node_timeout
 * 2)

2511 
	`»disLog
(
REDIS_WARNING
,

2514 
node
->
Çme
,

2515 (è((
£rv”
.
şu¡”_node_timeout
*2)-

2516 (
	`m¡ime
(è- 
node
->
¦aveof
->
vÙed_time
)));

2523 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

2524 ià(
	`b™m­Te¡B™
(
şaimed_¦Ùs
, 
j
) == 0) ;

2525 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

2526 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
 <ğ
»que¡CÚfigEpoch
)

2533 
	`»disLog
(
REDIS_WARNING
,

2536 
node
->
Çme
, 
j
,

2537 (è
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
cÚfigEpoch
,

2538 (è
»que¡CÚfigEpoch
);

2543 
	`şu¡”S’dFaov”Auth
(
node
);

2544 
£rv”
.
şu¡”
->
Ï¡VÙeEpoch
 = s”v”.şu¡”->
cu¼’tEpoch
;

2545 
node
->
¦aveof
->
vÙed_time
 = 
	`m¡ime
();

2546 
	`»disLog
(
REDIS_WARNING
, "Failover‡uth grantedo %.40s forƒpoch %llu",

2547 
node
->
Çme
, (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2548 
	}
}

2562 
	$şu¡”G‘SÏveRªk
() {

2563 
myoff£t
;

2564 
j
, 
¿nk
 = 0;

2565 
şu¡”Node
 *
ma¡”
;

2567 
	`»disAs£¹
(
	`nodeIsSÏve
(
my£lf
));

2568 
ma¡”
 = 
my£lf
->
¦aveof
;

2569 ià(
ma¡”
 =ğ
NULL
)  0;

2571 
myoff£t
 = 
	`»¶iÿtiÚG‘SÏveOff£t
();

2572 
j
 = 0; j < 
ma¡”
->
num¦aves
; j++)

2573 ià(
ma¡”
->
¦aves
[
j
] !ğ
my£lf
 &&

2574 
ma¡”
->
¦aves
[
j
]->
»¶_off£t
 > 
myoff£t
è
¿nk
++;

2575  
¿nk
;

2576 
	}
}

2600 
	$şu¡”LogCªtFaov”
(
»asÚ
) {

2601 *
msg
;

2602 
time_t
 
Ï¡log_time
 = 0;

2603 
m¡ime_t
 
nŞog_ç_time
 = 
£rv”
.
şu¡”_node_timeout
 + 5000;

2606 ià(
»asÚ
 =ğ
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 &&

2607 
	`time
(
NULL
)-
Ï¡log_time
 < 
REDIS_CLUSTER_CANT_FAILOVER_RELOG_PERIOD
)

2610 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
»asÚ
;

2615 ià(
my£lf
->
¦aveof
 &&

2616 
	`nodeFaed
(
my£lf
->
¦aveof
) &&

2617 (
	`m¡ime
(è- 
my£lf
->
¦aveof
->
ç_time
è< 
nŞog_ç_time
) ;

2619 
»asÚ
) {

2620 
REDIS_CLUSTER_CANT_FAILOVER_DATA_AGE
:

2621 
msg
 = "Disconnected from master for†ongerhan‡llowed.";

2623 
REDIS_CLUSTER_CANT_FAILOVER_WAITING_DELAY
:

2624 
msg
 = "Waitinghe delay before I can start‡‚ew failover.";

2626 
REDIS_CLUSTER_CANT_FAILOVER_EXPIRED
:

2627 
msg
 = "Failover‡ttemptƒxpired.";

2629 
REDIS_CLUSTER_CANT_FAILOVER_WAITING_VOTES
:

2630 
msg
 = "Waiting for votes, but majority still‚ot„eached.";

2633 
msg
 = "Unknown„eason code.";

2636 
Ï¡log_time
 = 
	`time
(
NULL
);

2637 
	`»disLog
(
REDIS_WARNING
,"Cu¼’y uÇbËØçov”: %s", 
msg
);

2638 
	}
}

2646 
	$şu¡”Faov”R•ÏûYourMa¡”
() {

2647 
j
;

2648 
şu¡”Node
 *
Şdma¡”
 = 
my£lf
->
¦aveof
;

2650 ià(
	`nodeIsMa¡”
(
my£lf
è|| 
Şdma¡”
 =ğ
NULL
) ;

2653 
	`şu¡”S‘NodeAsMa¡”
(
my£lf
);

2654 
	`»¶iÿtiÚUn£tMa¡”
();

2657 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

2658 ià(
	`şu¡”NodeG‘SlÙB™
(
Şdma¡”
,
j
)) {

2659 
	`şu¡”D–SlÙ
(
j
);

2660 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

2665 
	`şu¡”Upd©eS‹
();

2666 
	`şu¡”SaveCÚfigOrD›
(1);

2670 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_ALL
);

2673 
	`»£tMªu®Faov”
();

2674 
	}
}

2684 
	$şu¡”HªdËSÏveFaov”
() {

2685 
m¡ime_t
 
d©a_age
;

2686 
m¡ime_t
 
auth_age
 = 
	`m¡ime
(è- 
£rv”
.
şu¡”
->
çov”_auth_time
;

2687 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

2688 
mªu®_çov”
 = 
£rv”
.
şu¡”
->
mf_’d
 != 0 &&

2689 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
;

2690 
m¡ime_t
 
auth_timeout
, 
auth_»Œy_time
;

2692 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_HANDLE_FAILOVER
;

2701 
auth_timeout
 = 
£rv”
.
şu¡”_node_timeout
*2;

2702 ià(
auth_timeout
 < 2000)‡uth_timeout = 2000;

2703 
auth_»Œy_time
 = 
auth_timeout
*2;

2710 ià(
	`nodeIsMa¡”
(
my£lf
) ||

2711 
my£lf
->
¦aveof
 =ğ
NULL
 ||

2712 (!
	`nodeFaed
(
my£lf
->
¦aveof
è&& !
mªu®_çov”
) ||

2713 
my£lf
->
¦aveof
->
num¦Ùs
 == 0)

2717 
£rv”
.
şu¡”
->
ÿÁ_çov”_»asÚ
 = 
REDIS_CLUSTER_CANT_FAILOVER_NONE
;

2723 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTED
) {

2724 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
ma¡”
->
Ï¡š‹¿ùiÚ
)

2727 
d©a_age
 = (
m¡ime_t
)(
£rv”
.
unixtime
 - s”v”.
»¶_down_sšû
) * 1000;

2733 ià(
d©a_age
 > 
£rv”
.
şu¡”_node_timeout
)

2734 
d©a_age
 -ğ
£rv”
.
şu¡”_node_timeout
;

2740 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 &&

2741 
d©a_age
 >

2742 (((
m¡ime_t
)
£rv”
.
»¶_pšg_¦ave_³riod
 * 1000) +

2743 (
£rv”
.
şu¡”_node_timeout
 * s”v”.
şu¡”_¦ave_v®id™y_çùÜ
)))

2745 ià(!
mªu®_çov”
) {

2746 
	`şu¡”LogCªtFaov”
(
REDIS_CLUSTER_CANT_FAILOVER_DATA_AGE
);

2753 ià(
auth_age
 > 
auth_»Œy_time
) {

2754 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
() +

2756 
	`¿ndom
() % 500;

2757 
£rv”
.
şu¡”
->
çov”_auth_couÁ
 = 0;

2758 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 0;

2759 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2763 
£rv”
.
şu¡”
->
çov”_auth_time
 +=

2764 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 * 1000;

2766 ià(
£rv”
.
şu¡”
->
mf_’d
) {

2767 
£rv”
.
şu¡”
->
çov”_auth_time
 = 
	`m¡ime
();

2768 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 0;

2770 
	`»disLog
(
REDIS_WARNING
,

2773 
£rv”
.
şu¡”
->
çov”_auth_time
 - 
	`m¡ime
(),

2774 
£rv”
.
şu¡”
->
çov”_auth_¿nk
,

2775 
	`»¶iÿtiÚG‘SÏveOff£t
());

2779 
	`şu¡”Brßdÿ¡PÚg
(
CLUSTER_BROADCAST_LOCAL_SLAVES
);

2788 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0 &&

2789 
£rv”
.
şu¡”
->
mf_’d
 == 0)

2791 
Ãw¿nk
 = 
	`şu¡”G‘SÏveRªk
();

2792 ià(
Ãw¿nk
 > 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) {

2793 
added_d–ay
 =

2794 (
Ãw¿nk
 - 
£rv”
.
şu¡”
->
çov”_auth_¿nk
) * 1000;

2795 
£rv”
.
şu¡”
->
çov”_auth_time
 +ğ
added_d–ay
;

2796 
£rv”
.
şu¡”
->
çov”_auth_¿nk
 = 
Ãw¿nk
;

2797 
	`»disLog
(
REDIS_WARNING
,

2799 
Ãw¿nk
, 
added_d–ay
);

2804 ià(
	`m¡ime
(è< 
£rv”
.
şu¡”
->
çov”_auth_time
) {

2805 
	`şu¡”LogCªtFaov”
(
REDIS_CLUSTER_CANT_FAILOVER_WAITING_DELAY
);

2810 ià(
auth_age
 > 
auth_timeout
) {

2811 
	`şu¡”LogCªtFaov”
(
REDIS_CLUSTER_CANT_FAILOVER_EXPIRED
);

2816 ià(
£rv”
.
şu¡”
->
çov”_auth_£Á
 == 0) {

2817 
£rv”
.
şu¡”
->
cu¼’tEpoch
++;

2818 
£rv”
.
şu¡”
->
çov”_auth_•och
 = s”v”.şu¡”->
cu¼’tEpoch
;

2819 
	`»disLog
(
REDIS_WARNING
,"Starting‡ failoverƒlection forƒpoch %llu.",

2820 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
);

2821 
	`şu¡”Reque¡Faov”Auth
();

2822 
£rv”
.
şu¡”
->
çov”_auth_£Á
 = 1;

2823 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|

2824 
CLUSTER_TODO_UPDATE_STATE
|

2825 
CLUSTER_TODO_FSYNC_CONFIG
);

2830 ià(
£rv”
.
şu¡”
->
çov”_auth_couÁ
 >ğ
Ãeded_quÜum
) {

2833 
	`»disLog
(
REDIS_WARNING
,

2837 ià(
my£lf
->
cÚfigEpoch
 < 
£rv”
.
şu¡”
->
çov”_auth_•och
) {

2838 
my£lf
->
cÚfigEpoch
 = 
£rv”
.
şu¡”
->
çov”_auth_•och
;

2839 
	`»disLog
(
REDIS_WARNING
,

2841 (è
my£lf
->
cÚfigEpoch
);

2845 
	`şu¡”Faov”R•ÏûYourMa¡”
();

2847 
	`şu¡”LogCªtFaov”
(
REDIS_CLUSTER_CANT_FAILOVER_WAITING_VOTES
);

2849 
	}
}

2878 
	$şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
) {

2879 
j
, 
ok¦aves
 = 0;

2880 
şu¡”Node
 *
myma¡”
 = 
my£lf
->
¦aveof
, *
rg‘
 = 
NULL
, *
ÿndid©e
 = NULL;

2881 
diùI‹¿tÜ
 *
di
;

2882 
diùEÁry
 *
de
;

2885 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
REDIS_CLUSTER_OK
) ;

2889 ià(
myma¡”
 =ğ
NULL
) ;

2890 
j
 = 0; j < 
myma¡”
->
num¦aves
; j++)

2891 ià(!
	`nodeFaed
(
myma¡”
->
¦aves
[
j
]) &&

2892 !
	`nodeTimedOut
(
myma¡”
->
¦aves
[
j
])è
ok¦aves
++;

2893 ià(
ok¦aves
 <ğ
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
) ;

2904 
ÿndid©e
 = 
my£lf
;

2905 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

2906 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2907 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

2908 
ok¦aves
;

2911 ià(
	`nodeIsSÏve
(
node
è|| 
	`nodeFaed
(node)) ;

2915 ià(
node
->
num¦aves
 == 0) ;

2916 
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(
node
);

2918 ià(
ok¦aves
 =ğ0 && 
rg‘
 =ğ
NULL
 && 
node
->
num¦Ùs
 > 0)

2919 
rg‘
 = 
node
;

2921 ià(
ok¦aves
 =ğ
max_¦aves
) {

2922 
j
 = 0; j < 
node
->
num¦aves
; j++) {

2923 ià(
	`memcmp
(
node
->
¦aves
[
j
]->
Çme
,

2924 
ÿndid©e
->
Çme
,

2925 
REDIS_CLUSTER_NAMELEN
) < 0)

2927 
ÿndid©e
 = 
node
->
¦aves
[
j
];

2932 
	`diùR–—£I‹¿tÜ
(
di
);

2936 ià(
rg‘
 && 
ÿndid©e
 =ğ
my£lf
) {

2937 
	`»disLog
(
REDIS_WARNING
,"Migratingo orphaned master %.40s",

2938 
rg‘
->
Çme
);

2939 
	`şu¡”S‘Ma¡”
(
rg‘
);

2941 
	}
}

2977 
	$»£tMªu®Faov”
() {

2978 ià(
£rv”
.
şu¡”
->
mf_’d
 && 
	`ş›ÁsA»Pau£d
()) {

2979 
£rv”
.
ş›Ás_·u£_’d_time
 = 0;

2980 
	`ş›ÁsA»Pau£d
();

2982 
£rv”
.
şu¡”
->
mf_’d
 = 0;

2983 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 0;

2984 
£rv”
.
şu¡”
->
mf_¦ave
 = 
NULL
;

2985 
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 = 0;

2986 
	}
}

2989 
	$mªu®Faov”CheckTimeout
() {

2990 ià(
£rv”
.
şu¡”
->
mf_’d
 && s”v”.şu¡”->mf_’d < 
	`m¡ime
()) {

2991 
	`»disLog
(
REDIS_WARNING
,"Manual failoverimed out.");

2992 
	`»£tMªu®Faov”
();

2994 
	}
}

2998 
	$şu¡”HªdËMªu®Faov”
() {

3000 ià(
£rv”
.
şu¡”
->
mf_’d
 == 0) ;

3004 ià(
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
) ;

3006 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 == 0) ;

3008 ià(
£rv”
.
şu¡”
->
mf_ma¡”_off£t
 =ğ
	`»¶iÿtiÚG‘SÏveOff£t
()) {

3011 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

3012 
	`»disLog
(
REDIS_WARNING
,

3016 
	}
}

3023 
	$şu¡”CrÚ
() {

3024 
diùI‹¿tÜ
 *
di
;

3025 
diùEÁry
 *
de
;

3026 
upd©e_¡©e
 = 0;

3027 
Üphªed_ma¡”s
;

3028 
max_¦aves
;

3029 
this_¦aves
;

3030 
m¡ime_t
 
mš_pÚg
 = 0, 
now
 = 
	`m¡ime
();

3031 
şu¡”Node
 *
mš_pÚg_node
 = 
NULL
;

3032 
™”©iÚ
 = 0;

3033 
m¡ime_t
 
hªdshake_timeout
;

3035 
™”©iÚ
++;

3041 
hªdshake_timeout
 = 
£rv”
.
şu¡”_node_timeout
;

3042 ià(
hªdshake_timeout
 < 1000) handshake_timeout = 1000;

3045 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3046 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3047 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3049 ià(
node
->
æags
 & (
REDIS_NODE_MYSELF
|
REDIS_NODE_NOADDR
)) ;

3053 ià(
	`nodeInHªdshake
(
node
è&& 
now
 -‚ode->
ùime
 > 
hªdshake_timeout
) {

3054 
	`şu¡”D–Node
(
node
);

3058 ià(
node
->
lšk
 =ğ
NULL
) {

3059 
fd
;

3060 
m¡ime_t
 
Şd_pšg_£Á
;

3061 
şu¡”Lšk
 *
lšk
;

3063 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
£rv”
.
Ã‹¼
, 
node
->

,

3064 
node
->
pÜt
+
REDIS_CLUSTER_PORT_INCR
, 
REDIS_BIND_ADDR
);

3065 ià(
fd
 == -1) {

3071 ià(
node
->
pšg_£Á
 =ğ0ènode->pšg_£Á = 
	`m¡ime
();

3072 
	`»disLog
(
REDIS_DEBUG
, "Unableo connecto "

3073 "Clu¡” Nod[%s]:%d -> %s", 
node
->

,

3074 
node
->
pÜt
+
REDIS_CLUSTER_PORT_INCR
,

3075 
£rv”
.
Ã‹¼
);

3078 
lšk
 = 
	`ü—‹Clu¡”Lšk
(
node
);

3079 
lšk
->
fd
 = fd;

3080 
node
->
lšk
 =†ink;

3081 
	`«C»©eFeEv’t
(
£rv”
.
–
,
lšk
->
fd
,
AE_READABLE
,

3082 
şu¡”R—dHªdËr
,
lšk
);

3089 
Şd_pšg_£Á
 = 
node
->
pšg_£Á
;

3090 
	`şu¡”S’dPšg
(
lšk
, 
node
->
æags
 & 
REDIS_NODE_MEET
 ?

3091 
CLUSTERMSG_TYPE_MEET
 : 
CLUSTERMSG_TYPE_PING
);

3092 ià(
Şd_pšg_£Á
) {

3096 
node
->
pšg_£Á
 = 
Şd_pšg_£Á
;

3103 
node
->
æags
 &ğ~
REDIS_NODE_MEET
;

3105 
	`»disLog
(
REDIS_DEBUG
,"Connecting with Node %.40s‡t %s:%d",

3106 
node
->
Çme
,‚ode->

,‚ode->
pÜt
+
REDIS_CLUSTER_PORT_INCR
);

3109 
	`diùR–—£I‹¿tÜ
(
di
);

3113 ià(!(
™”©iÚ
 % 10)) {

3114 
j
;

3118 
j
 = 0; j < 5; j++) {

3119 
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
şu¡”
->
nodes
);

3120 
şu¡”Node
 *
this
 = 
	`diùG‘V®
(
de
);

3123 ià(
this
->
lšk
 =ğ
NULL
 ||his->
pšg_£Á
 != 0) ;

3124 ià(
this
->
æags
 & (
REDIS_NODE_MYSELF
|
REDIS_NODE_HANDSHAKE
))

3126 ià(
mš_pÚg_node
 =ğ
NULL
 || 
mš_pÚg
 > 
this
->
pÚg_»ûived
) {

3127 
mš_pÚg_node
 = 
this
;

3128 
mš_pÚg
 = 
this
->
pÚg_»ûived
;

3131 ià(
mš_pÚg_node
) {

3132 
	`»disLog
(
REDIS_DEBUG
,"Pšgšg‚od%.40s", 
mš_pÚg_node
->
Çme
);

3133 
	`şu¡”S’dPšg
(
mš_pÚg_node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3143 
Üphªed_ma¡”s
 = 0;

3144 
max_¦aves
 = 0;

3145 
this_¦aves
 = 0;

3146 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3147 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3148 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3149 
now
 = 
	`m¡ime
();

3150 
m¡ime_t
 
d–ay
;

3152 ià(
node
->
æags
 &

3153 (
REDIS_NODE_MYSELF
|
REDIS_NODE_NOADDR
|
REDIS_NODE_HANDSHAKE
))

3158 ià(
	`nodeIsSÏve
(
my£lf
è&& 
	`nodeIsMa¡”
(
node
è&& !
	`nodeFaed
(node)) {

3159 
ok¦aves
 = 
	`şu¡”CouÁNÚFašgSÏves
(
node
);

3164 ià(
ok¦aves
 =ğ0 && 
node
->
num¦Ùs
 > 0 &&‚ode->
num¦aves
)

3165 
Üphªed_ma¡”s
++;

3166 ià(
ok¦aves
 > 
max_¦aves
) max_slaves = okslaves;

3167 ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
node
)

3168 
this_¦aves
 = 
ok¦aves
;

3174 ià(
node
->
lšk
 &&

3175 
now
 - 
node
->
lšk
->
ùime
 >

3176 
£rv”
.
şu¡”_node_timeout
 &&

3177 
node
->
pšg_£Á
 &&

3178 
node
->
pÚg_»ûived
 <‚ode->
pšg_£Á
 &&

3180 
now
 - 
node
->
pšg_£Á
 > 
£rv”
.
şu¡”_node_timeout
/2)

3183 
	`ä“Clu¡”Lšk
(
node
->
lšk
);

3190 ià(
node
->
lšk
 &&

3191 
node
->
pšg_£Á
 == 0 &&

3192 (
now
 - 
node
->
pÚg_»ûived
è> 
£rv”
.
şu¡”_node_timeout
/2)

3194 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3200 ià(
£rv”
.
şu¡”
->
mf_’d
 &&

3201 
	`nodeIsMa¡”
(
my£lf
) &&

3202 
£rv”
.
şu¡”
->
mf_¦ave
 =ğ
node
 &&

3203 
node
->
lšk
)

3205 
	`şu¡”S’dPšg
(
node
->
lšk
, 
CLUSTERMSG_TYPE_PING
);

3210 ià(
node
->
pšg_£Á
 == 0) ;

3215 
d–ay
 = 
now
 - 
node
->
pšg_£Á
;

3217 ià(
d–ay
 > 
£rv”
.
şu¡”_node_timeout
) {

3220 ià(!(
node
->
æags
 & (
REDIS_NODE_PFAIL
|
REDIS_NODE_FAIL
))) {

3221 
	`»disLog
(
REDIS_DEBUG
,"*** NODE %.40s…ossibly failing",

3222 
node
->
Çme
);

3223 
node
->
æags
 |ğ
REDIS_NODE_PFAIL
;

3224 
upd©e_¡©e
 = 1;

3228 
	`diùR–—£I‹¿tÜ
(
di
);

3233 ià(
	`nodeIsSÏve
(
my£lf
) &&

3234 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

3235 
my£lf
->
¦aveof
 &&

3236 
	`nodeHasAddr
(
my£lf
->
¦aveof
))

3238 
	`»¶iÿtiÚS‘Ma¡”
(
my£lf
->
¦aveof
->

, my£lf->¦aveof->
pÜt
);

3242 
	`mªu®Faov”CheckTimeout
();

3244 ià(
	`nodeIsSÏve
(
my£lf
)) {

3245 
	`şu¡”HªdËMªu®Faov”
();

3246 
	`şu¡”HªdËSÏveFaov”
();

3252 ià(
Üphªed_ma¡”s
 && 
max_¦aves
 >ğ2 && 
this_¦aves
 == max_slaves)

3253 
	`şu¡”HªdËSÏveMig¿tiÚ
(
max_¦aves
);

3256 ià(
upd©e_¡©e
 || 
£rv”
.
şu¡”
->
¡©e
 =ğ
REDIS_CLUSTER_FAIL
)

3257 
	`şu¡”Upd©eS‹
();

3258 
	}
}

3265 
	$şu¡”BefÜeSË•
() {

3268 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_HANDLE_FAILOVER
)

3269 
	`şu¡”HªdËSÏveFaov”
();

3272 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_UPDATE_STATE
)

3273 
	`şu¡”Upd©eS‹
();

3276 ià(
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 & 
CLUSTER_TODO_SAVE_CONFIG
) {

3277 
fsync
 = 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &

3278 
CLUSTER_TODO_FSYNC_CONFIG
;

3279 
	`şu¡”SaveCÚfigOrD›
(
fsync
);

3284 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 = 0;

3285 
	}
}

3287 
	$şu¡”DoBefÜeSË•
(
æags
) {

3288 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 |ğ
æags
;

3289 
	}
}

3297 
	$b™m­Te¡B™
(*
b™m­
, 
pos
) {

3298 
off_t
 
by‹
 = 
pos
/8;

3299 
b™
 = 
pos
&7;

3300  (
b™m­
[
by‹
] & (1<<
b™
)) != 0;

3301 
	}
}

3304 
	$b™m­S‘B™
(*
b™m­
, 
pos
) {

3305 
off_t
 
by‹
 = 
pos
/8;

3306 
b™
 = 
pos
&7;

3307 
b™m­
[
by‹
] |ğ1<<
b™
;

3308 
	}
}

3311 
	$b™m­CË¬B™
(*
b™m­
, 
pos
) {

3312 
off_t
 
by‹
 = 
pos
/8;

3313 
b™
 = 
pos
&7;

3314 
b™m­
[
by‹
] &ğ~(1<<
b™
);

3315 
	}
}

3318 
	$şu¡”NodeS‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3319 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3320 
	`b™m­S‘B™
(
n
->
¦Ùs
,
¦Ù
);

3321 ià(!
Şd
è
n
->
num¦Ùs
++;

3322  
Şd
;

3323 
	}
}

3326 
	$şu¡”NodeCË¬SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3327 
Şd
 = 
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3328 
	`b™m­CË¬B™
(
n
->
¦Ùs
,
¦Ù
);

3329 ià(
Şd
è
n
->
num¦Ùs
--;

3330  
Şd
;

3331 
	}
}

3334 
	$şu¡”NodeG‘SlÙB™
(
şu¡”Node
 *
n
, 
¦Ù
) {

3335  
	`b™m­Te¡B™
(
n
->
¦Ùs
,
¦Ù
);

3336 
	}
}

3342 
	$şu¡”AddSlÙ
(
şu¡”Node
 *
n
, 
¦Ù
) {

3343 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]è 
REDIS_ERR
;

3344 
	`şu¡”NodeS‘SlÙB™
(
n
,
¦Ù
);

3345 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
n
;

3346  
REDIS_OK
;

3347 
	}
}

3352 
	$şu¡”D–SlÙ
(
¦Ù
) {

3353 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

3355 ià(!
n
è 
REDIS_ERR
;

3356 
	`»disAs£¹
(
	`şu¡”NodeCË¬SlÙB™
(
n
,
¦Ù
) == 1);

3357 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] = 
NULL
;

3358  
REDIS_OK
;

3359 
	}
}

3363 
	$şu¡”D–NodeSlÙs
(
şu¡”Node
 *
node
) {

3364 
d–‘ed
 = 0, 
j
;

3366 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3367 ià(
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)è
	`şu¡”D–SlÙ
(j);

3368 
d–‘ed
++;

3370  
d–‘ed
;

3371 
	}
}

3375 
	$şu¡”Clo£AÎSlÙs
() {

3376 
	`mem£t
(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
,0,

3377 (
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
));

3378 
	`mem£t
(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
,0,

3379 (
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
));

3380 
	}
}

3390 
	#REDIS_CLUSTER_MAX_REJOIN_DELAY
 5000

	)

3391 
	#REDIS_CLUSTER_MIN_REJOIN_DELAY
 500

	)

3392 
	#REDIS_CLUSTER_WRITABLE_DELAY
 2000

	)

3394 
	$şu¡”Upd©eS‹
() {

3395 
j
, 
Ãw_¡©e
;

3396 
»achabË_ma¡”s
 = 0;

3397 
m¡ime_t
 
amÚg_mšÜ™y_time
;

3398 
m¡ime_t
 
fœ¡_ÿÎ_time
 = 0;

3400 
£rv”
.
şu¡”
->
todo_befÜe_¦“p
 &ğ~
CLUSTER_TODO_UPDATE_STATE
;

3408 ià(
fœ¡_ÿÎ_time
 =ğ0èfœ¡_ÿÎ_timğ
	`m¡ime
();

3409 ià(
	`nodeIsMa¡”
(
my£lf
) &&

3410 
£rv”
.
şu¡”
->
¡©e
 =ğ
REDIS_CLUSTER_FAIL
 &&

3411 
	`m¡ime
(è- 
fœ¡_ÿÎ_time
 < 
REDIS_CLUSTER_WRITABLE_DELAY
) ;

3415 
Ãw_¡©e
 = 
REDIS_CLUSTER_OK
;

3418 ià(
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
) {

3419 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3420 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
 ||

3421 
£rv”
.
şu¡”
->
¦Ùs
[
j
]->
æags
 & (
REDIS_NODE_FAIL
))

3423 
Ãw_¡©e
 = 
REDIS_CLUSTER_FAIL
;

3435 
diùI‹¿tÜ
 *
di
;

3436 
diùEÁry
 *
de
;

3438 
£rv”
.
şu¡”
->
size
 = 0;

3439 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3440 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3441 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3443 ià(
	`nodeIsMa¡”
(
node
è&&‚ode->
num¦Ùs
) {

3444 
£rv”
.
şu¡”
->
size
++;

3445 ià((
node
->
æags
 & (
REDIS_NODE_FAIL
|
REDIS_NODE_PFAIL
)) == 0)

3446 
»achabË_ma¡”s
++;

3449 
	`diùR–—£I‹¿tÜ
(
di
);

3455 
Ãeded_quÜum
 = (
£rv”
.
şu¡”
->
size
 / 2) + 1;

3457 ià(
»achabË_ma¡”s
 < 
Ãeded_quÜum
) {

3458 
Ãw_¡©e
 = 
REDIS_CLUSTER_FAIL
;

3459 
amÚg_mšÜ™y_time
 = 
	`m¡ime
();

3464 ià(
Ãw_¡©e
 !ğ
£rv”
.
şu¡”
->
¡©e
) {

3465 
m¡ime_t
 
»još_d–ay
 = 
£rv”
.
şu¡”_node_timeout
;

3471 ià(
»još_d–ay
 > 
REDIS_CLUSTER_MAX_REJOIN_DELAY
)

3472 
»još_d–ay
 = 
REDIS_CLUSTER_MAX_REJOIN_DELAY
;

3473 ià(
»još_d–ay
 < 
REDIS_CLUSTER_MIN_REJOIN_DELAY
)

3474 
»još_d–ay
 = 
REDIS_CLUSTER_MIN_REJOIN_DELAY
;

3476 ià(
Ãw_¡©e
 =ğ
REDIS_CLUSTER_OK
 &&

3477 
	`nodeIsMa¡”
(
my£lf
) &&

3478 
	`m¡ime
(è- 
amÚg_mšÜ™y_time
 < 
»još_d–ay
)

3484 
	`»disLog
(
REDIS_WARNING
,"Cluster state changed: %s",

3485 
Ãw_¡©e
 =ğ
REDIS_CLUSTER_OK
 ? "ok" : "fail");

3486 
£rv”
.
şu¡”
->
¡©e
 = 
Ãw_¡©e
;

3488 
	}
}

3512 
	$v”ifyClu¡”CÚfigW™hD©a
() {

3513 
j
;

3514 
upd©e_cÚfig
 = 0;

3518 ià(
	`nodeIsSÏve
(
my£lf
)è 
REDIS_OK
;

3521 
j
 = 1; j < 
£rv”
.
dbnum
; j++) {

3522 ià(
	`diùSize
(
£rv”
.
db
[
j
].
diù
)è 
REDIS_ERR
;

3527 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3528 ià(!
	`couÁKeysInSlÙ
(
j
)) ;

3532 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
my£lf
 ||

3533 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] !ğ
NULL
) ;

3539 
upd©e_cÚfig
++;

3541 ià(
£rv”
.
şu¡”
->
¦Ùs
[
j
] =ğ
NULL
) {

3542 
	`»disLog
(
REDIS_WARNING
, "I have keys for unassigned slot %d. "

3543 "Takšg„e¥Úsib™y fÜ it.",
j
);

3544 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

3546 
	`»disLog
(
REDIS_WARNING
, "I have keys for slot %d, buthe slot is "

3548 "S‘tšg iˆtØimpÜtšg s‹.",
j
);

3549 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = s”v”.şu¡”->
¦Ùs
[j];

3552 ià(
upd©e_cÚfig
è
	`şu¡”SaveCÚfigOrD›
(1);

3553  
REDIS_OK
;

3554 
	}
}

3562 
	$şu¡”S‘Ma¡”
(
şu¡”Node
 *
n
) {

3563 
	`»disAs£¹
(
n
 !ğ
my£lf
);

3564 
	`»disAs£¹
(
my£lf
->
num¦Ùs
 == 0);

3566 ià(
	`nodeIsMa¡”
(
my£lf
)) {

3567 
my£lf
->
æags
 &ğ~
REDIS_NODE_MASTER
;

3568 
my£lf
->
æags
 |ğ
REDIS_NODE_SLAVE
;

3569 
	`şu¡”Clo£AÎSlÙs
();

3571 ià(
my£lf
->
¦aveof
)

3572 
	`şu¡”NodeRemoveSÏve
(
my£lf
->
¦aveof
,myself);

3574 
my£lf
->
¦aveof
 = 
n
;

3575 
	`şu¡”NodeAddSÏve
(
n
,
my£lf
);

3576 
	`»¶iÿtiÚS‘Ma¡”
(
n
->

,‚->
pÜt
);

3577 
	`»£tMªu®Faov”
();

3578 
	}
}

3584 
	s»disNodeFÏgs
 {

3585 
ušt16_t
 
	mæag
;

3586 *
	mÇme
;

3589 
»disNodeFÏgs
 
	g»disNodeFÏgsTabË
[] = {

3590 {
REDIS_NODE_MYSELF
, "myself,"},

3591 {
REDIS_NODE_MASTER
, "master,"},

3592 {
REDIS_NODE_SLAVE
, "slave,"},

3593 {
REDIS_NODE_PFAIL
, "fail?,"},

3594 {
REDIS_NODE_FAIL
, "fail,"},

3595 {
REDIS_NODE_HANDSHAKE
, "handshake,"},

3596 {
REDIS_NODE_NOADDR
, "noaddr,"}

3601 
sds
 
	$»´e£ÁRedisNodeFÏgs
(
sds
 
ci
, 
ušt16_t
 
æags
) {

3602 ià(
æags
 == 0) {

3603 
ci
 = 
	`sdsÿt
(ci,"noflags,");

3605 
i
, 
size
 = (
»disNodeFÏgsTabË
)/(
»disNodeFÏgs
);

3606 
i
 = 0; i < 
size
; i++) {

3607 
»disNodeFÏgs
 *
nodeæag
 = 
»disNodeFÏgsTabË
 + 
i
;

3608 ià(
æags
 & 
nodeæag
->
æag
è
ci
 = 
	`sdsÿt
(ci,‚odeæag->
Çme
);

3611 
	`sdsInüL’
(
ci
,-1);

3612  
ci
;

3613 
	}
}

3619 
sds
 
	$şu¡”G’NodeDesütiÚ
(
şu¡”Node
 *
node
) {

3620 
j
, 
¡¬t
;

3621 
sds
 
ci
;

3624 
ci
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%.40s %s:%d ",

3625 
node
->
Çme
,

3626 
node
->

,

3627 
node
->
pÜt
);

3630 
ci
 = 
	`»´e£ÁRedisNodeFÏgs
(ci, 
node
->
æags
);

3633 ià(
node
->
¦aveof
)

3634 
ci
 = 
	`sdsÿrštf
(ci," %.40 ",
node
->
¦aveof
->
Çme
);

3636 
ci
 = 
	`sdsÿ’
(ci," - ",3);

3639 
ci
 = 
	`sdsÿrštf
(ci,"%lld %lld %llu %s",

3640 (è
node
->
pšg_£Á
,

3641 (è
node
->
pÚg_»ûived
,

3642 (è
node
->
cÚfigEpoch
,

3643 (
node
->
lšk
 ||‚ode->
æags
 & 
REDIS_NODE_MYSELF
) ?

3647 
¡¬t
 = -1;

3648 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3649 
b™
;

3651 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3652 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3654 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
REDIS_CLUSTER_SLOTS
-1)) {

3655 ià(
b™
 && 
j
 =ğ
REDIS_CLUSTER_SLOTS
-1) j++;

3657 ià(
¡¬t
 =ğ
j
-1) {

3658 
ci
 = 
	`sdsÿrštf
(ci," %d",
¡¬t
);

3660 
ci
 = 
	`sdsÿrštf
(ci," %d-%d",
¡¬t
,
j
-1);

3662 
¡¬t
 = -1;

3669 ià(
node
->
æags
 & 
REDIS_NODE_MYSELF
) {

3670 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3671 ià(
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]) {

3672 
ci
 = 
	`sdsÿrštf
(ci," [%d->-%.40s]",
j
,

3673 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
j
]->
Çme
);

3674 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]) {

3675 
ci
 = 
	`sdsÿrštf
(ci," [%d-<-%.40s]",
j
,

3676 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
]->
Çme
);

3680  
ci
;

3681 
	}
}

3695 
sds
 
	$şu¡”G’NodesDesütiÚ
(
f‹r
) {

3696 
sds
 
ci
 = 
	`sd£m±y
(), 
ni
;

3697 
diùI‹¿tÜ
 *
di
;

3698 
diùEÁry
 *
de
;

3700 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3701 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3702 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3704 ià(
node
->
æags
 & 
f‹r
) ;

3705 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
node
);

3706 
ci
 = 
	`sdsÿtsds
(ci,
ni
);

3707 
	`sdsä“
(
ni
);

3708 
ci
 = 
	`sdsÿ’
(ci,"\n",1);

3710 
	`diùR–—£I‹¿tÜ
(
di
);

3711  
ci
;

3712 
	}
}

3718 
	$g‘SlÙOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
) {

3719 
¦Ù
;

3721 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
¦Ù
è!ğ
REDIS_OK
 ||

3722 
¦Ù
 < 0 || slÙ >ğ
REDIS_CLUSTER_SLOTS
)

3724 
	`addR•lyE¼Ü
(
c
,"Invalid or out of„ange slot");

3727  (è
¦Ù
;

3728 
	}
}

3730 
	$şu¡”R•lyMuÉiBulkSlÙs
(
»disCl›Á
 *
c
) {

3740 
num_ma¡”s
 = 0;

3741 *
¦Ù_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

3743 
diùEÁry
 *
de
;

3744 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
şu¡”
->
nodes
);

3745 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3746 
şu¡”Node
 *
node
 = 
	`diùG‘V®
(
de
);

3747 
j
 = 0, 
¡¬t
 = -1;

3751 ià(!
	`nodeIsMa¡”
(
node
è||‚ode->
num¦Ùs
 == 0) ;

3753 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3754 
b™
, 
i
;

3756 ià((
b™
 = 
	`şu¡”NodeG‘SlÙB™
(
node
,
j
)) != 0) {

3757 ià(
¡¬t
 =ğ-1è¡¬ˆğ
j
;

3759 ià(
¡¬t
 !ğ-1 && (!
b™
 || 
j
 =ğ
REDIS_CLUSTER_SLOTS
-1)) {

3760 
Ã¡ed_–em’ts
 = 3;

3761 *
Ã¡ed_»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

3763 ià(
b™
 && 
j
 =ğ
REDIS_CLUSTER_SLOTS
-1) j++;

3767 ià(
¡¬t
 =ğ
j
-1) {

3768 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3769 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3771 
	`addR•lyLÚgLÚg
(
c
, 
¡¬t
);

3772 
	`addR•lyLÚgLÚg
(
c
, 
j
-1);

3774 
¡¬t
 = -1;

3777 
	`addR•lyMuÉiBulkL’
(
c
, 2);

3778 
	`addR•lyBulkCSŒšg
(
c
, 
node
->

);

3779 
	`addR•lyLÚgLÚg
(
c
, 
node
->
pÜt
);

3782 
i
 = 0; i < 
node
->
num¦aves
; i++) {

3785 ià(
	`nodeFaed
(
node
->
¦aves
[
i
])) ;

3786 
	`addR•lyMuÉiBulkL’
(
c
, 2);

3787 
	`addR•lyBulkCSŒšg
(
c
, 
node
->
¦aves
[
i
]->

);

3788 
	`addR•lyLÚgLÚg
(
c
, 
node
->
¦aves
[
i
]->
pÜt
);

3789 
Ã¡ed_–em’ts
++;

3791 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
Ã¡ed_»¶yËn
, 
Ã¡ed_–em’ts
);

3792 
num_ma¡”s
++;

3796 
	`diùR–—£I‹¿tÜ
(
di
);

3797 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
¦Ù_»¶yËn
, 
num_ma¡”s
);

3798 
	}
}

3800 
	$şu¡”Commªd
(
»disCl›Á
 *
c
) {

3801 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

3802 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

3806 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"m“t"è&& c->
¬gc
 == 4) {

3807 
pÜt
;

3809 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[3], &
pÜt
è!ğ
REDIS_OK
) {

3810 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid TCP…ort specified: %s",

3811 (*)
c
->
¬gv
[3]->
±r
);

3815 ià(
	`şu¡”S¹Hªdshake
(
c
->
¬gv
[2]->
±r
,
pÜt
) == 0 &&

3816 
”ºo
 =ğ
EINVAL
)

3818 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‚ode‡ddress specified: %s:%s",

3819 (*)
c
->
¬gv
[2]->
±r
, (*)c->argv[3]->ptr);

3821 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3823 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nodes"è&& c->
¬gc
 == 2) {

3825 
robj
 *
o
;

3826 
sds
 
ci
 = 
	`şu¡”G’NodesDesütiÚ
(0);

3828 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
ci
);

3829 
	`addR•lyBulk
(
c
,
o
);

3830 
	`deüRefCouÁ
(
o
);

3831 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"myid"è&& c->
¬gc
 == 2) {

3833 
	`addR•lyBulkCBufãr
(
c
,
my£lf
->
Çme
, 
REDIS_CLUSTER_NAMELEN
);

3834 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦Ùs"è&& c->
¬gc
 == 2) {

3836 
	`şu¡”R•lyMuÉiBulkSlÙs
(
c
);

3837 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"æush¦Ùs"è&& c->
¬gc
 == 2) {

3839 ià(
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0) {

3840 
	`addR•lyE¼Ü
(
c
,"DB must beƒmptyo…erform CLUSTER FLUSHSLOTS.");

3843 
	`şu¡”D–NodeSlÙs
(
my£lf
);

3844 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

3845 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3846 } ià((!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"addslots") ||

3847 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"d–¦Ùs")è&& c->
¬gc
 >= 3)

3851 
j
, 
¦Ù
;

3852 *
¦Ùs
 = 
	`zm®loc
(
REDIS_CLUSTER_SLOTS
);

3853 
d–
 = !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"delslots");

3855 
	`mem£t
(
¦Ùs
,0,
REDIS_CLUSTER_SLOTS
);

3858 
j
 = 2; j < 
c
->
¬gc
; j++) {

3859 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[
j
])) == -1) {

3860 
	`zä“
(
¦Ùs
);

3863 ià(
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
NULL
) {

3864 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady uÇssigÃd", 
¦Ù
);

3865 
	`zä“
(
¦Ùs
);

3867 } ià(!
d–
 && 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
]) {

3868 
	`addR•lyE¼ÜFÜm©
(
c
,"SlÙ %d i ®»ady busy", 
¦Ù
);

3869 
	`zä“
(
¦Ùs
);

3872 ià(
¦Ùs
[
¦Ù
]++ == 1) {

3873 
	`addR•lyE¼ÜFÜm©
(
c
,"Slot %d specified multipleimes",

3874 ()
¦Ù
);

3875 
	`zä“
(
¦Ùs
);

3879 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3880 ià(
¦Ùs
[
j
]) {

3881 
»tv®
;

3885 ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
])

3886 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
j
] = 
NULL
;

3888 
»tv®
 = 
d–
 ? 
	`şu¡”D–SlÙ
(
j
) :

3889 
	`şu¡”AddSlÙ
(
my£lf
,
j
);

3890 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
REDIS_OK
);

3893 
	`zä“
(
¦Ùs
);

3894 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

3895 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3896 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t¦Ù"è&& c->
¬gc
 >= 4) {

3901 
¦Ù
;

3902 
şu¡”Node
 *
n
;

3904 ià((
¦Ù
 = 
	`g‘SlÙOrR•ly
(
c
,c->
¬gv
[2])) == -1) ;

3906 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"mig¿tšg"è&& c->
¬gc
 == 5) {

3907 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] !ğ
my£lf
) {

3908 
	`addR•lyE¼ÜFÜm©
(
c
,"I'm‚ÙhowÃ¸oàhash slÙ %u",
¦Ù
);

3911 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

3912 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

3913 (*)
c
->
¬gv
[4]->
±r
);

3916 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
n
;

3917 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"impÜtšg"è&& c->
¬gc
 == 5) {

3918 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
) {

3919 
	`addR•lyE¼ÜFÜm©
(
c
,

3920 "I'm‡Ì—dyhowÃ¸oàhash slÙ %u",
¦Ù
);

3923 ià((
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
)è=ğ
NULL
) {

3924 
	`addR•lyE¼ÜFÜm©
(
c
,"I don't know‡bout‚ode %s",

3925 (*)
c
->
¬gv
[3]->
±r
);

3928 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
n
;

3929 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"¡abË"è&& c->
¬gc
 == 4) {

3931 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

3932 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

3933 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[3]->
±r
,"node"è&& c->
¬gc
 == 5) {

3935 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[4]->
±r
);

3937 ià(!
n
) {

3938 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown‚ode %s",

3939 (*)
c
->
¬gv
[4]->
±r
);

3944 ià(
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
] =ğ
my£lf
 && 
n
 != myself) {

3945 ià(
	`couÁKeysInSlÙ
(
¦Ù
) != 0) {

3946 
	`addR•lyE¼ÜFÜm©
(
c
,

3948 "whI stÈhŞd key fÜhi hash slÙ.", 
¦Ù
);

3955 ià(
	`couÁKeysInSlÙ
(
¦Ù
) == 0 &&

3956 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
])

3957 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] = 
NULL
;

3961 ià(
n
 =ğ
my£lf
 &&

3962 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
])

3973 ià(
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
(è=ğ
REDIS_OK
) {

3974 
	`»disLog
(
REDIS_WARNING
,

3975 "cÚfigEpoch upd©ed‡á” impÜtšg slÙ %d", 
¦Ù
);

3977 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] = 
NULL
;

3979 
	`şu¡”D–SlÙ
(
¦Ù
);

3980 
	`şu¡”AddSlÙ
(
n
,
¦Ù
);

3982 
	`addR•lyE¼Ü
(
c
,

3986 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_SAVE_CONFIG
|
CLUSTER_TODO_UPDATE_STATE
);

3987 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3988 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"šfo"è&& c->
¬gc
 == 2) {

3990 *
¡©e¡r
[] = {"ok","fail","needhelp"};

3991 
¦Ùs_assigÃd
 = 0, 
¦Ùs_ok
 = 0, 
¦Ùs_pç
 = 0, 
¦Ùs_ç
 = 0;

3992 
ušt64_t
 
my•och
;

3993 
j
;

3995 
j
 = 0; j < 
REDIS_CLUSTER_SLOTS
; j++) {

3996 
şu¡”Node
 *
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
j
];

3998 ià(
n
 =ğ
NULL
) ;

3999 
¦Ùs_assigÃd
++;

4000 ià(
	`nodeFaed
(
n
)) {

4001 
¦Ùs_ç
++;

4002 } ià(
	`nodeTimedOut
(
n
)) {

4003 
¦Ùs_pç
++;

4005 
¦Ùs_ok
++;

4009 
my•och
 = (
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
) ?

4010 
my£lf
->
¦aveof
->
cÚfigEpoch
 : myself->configEpoch;

4012 
sds
 
šfo
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

4024 , 
¡©e¡r
[
£rv”
.
şu¡”
->
¡©e
],

4025 
¦Ùs_assigÃd
,

4026 
¦Ùs_ok
,

4027 
¦Ùs_pç
,

4028 
¦Ùs_ç
,

4029 
	`diùSize
(
£rv”
.
şu¡”
->
nodes
),

4030 
£rv”
.
şu¡”
->
size
,

4031 (è
£rv”
.
şu¡”
->
cu¼’tEpoch
,

4032 (è
my•och
,

4033 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_£Á
,

4034 
£rv”
.
şu¡”
->
¡©s_bus_mes§ges_»ûived


4036 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

4037 ()
	`sd¦’
(
šfo
)));

4038 
	`addR•lySds
(
c
,
šfo
);

4039 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

4040 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"§vecÚfig"è&& c->
¬gc
 == 2) {

4041 
»tv®
 = 
	`şu¡”SaveCÚfig
(1);

4043 ià(
»tv®
 == 0)

4044 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4046 
	`addR•lyE¼ÜFÜm©
(
c
,"error savinghe cluster‚ode config: %s",

4047 
	`¡»¼Ü
(
”ºo
));

4048 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"key¦Ù"è&& c->
¬gc
 == 3) {

4050 
sds
 
key
 = 
c
->
¬gv
[2]->
±r
;

4052 
	`addR•lyLÚgLÚg
(
c
,
	`keyHashSlÙ
(
key
,
	`sd¦’
(key)));

4053 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"couÁkeysš¦Ù"è&& c->
¬gc
 == 3) {

4055 
¦Ù
;

4057 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
REDIS_OK
)

4059 ià(
¦Ù
 < 0 || slÙ >ğ
REDIS_CLUSTER_SLOTS
) {

4060 
	`addR•lyE¼Ü
(
c
,"Invalid slot");

4063 
	`addR•lyLÚgLÚg
(
c
,
	`couÁKeysInSlÙ
(
¦Ù
));

4064 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keysš¦Ù"è&& c->
¬gc
 == 4) {

4066 
maxkeys
, 
¦Ù
;

4067 
numkeys
, 
j
;

4068 
robj
 **
keys
;

4070 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¦Ù
,
NULL
è!ğ
REDIS_OK
)

4072 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
maxkeys
,
NULL
)

4073 !ğ
REDIS_OK
)

4075 ià(
¦Ù
 < 0 || slÙ >ğ
REDIS_CLUSTER_SLOTS
 || 
maxkeys
 < 0) {

4076 
	`addR•lyE¼Ü
(
c
,"Invalid slot or‚umber of keys");

4080 
keys
 = 
	`zm®loc
((
robj
*)*
maxkeys
);

4081 
numkeys
 = 
	`g‘KeysInSlÙ
(
¦Ù
, 
keys
, 
maxkeys
);

4082 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

4083 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,
keys
[j]);

4084 
	`zä“
(
keys
);

4085 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"fÜg‘"è&& c->
¬gc
 == 3) {

4087 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4089 ià(!
n
) {

4090 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4092 } ià(
n
 =ğ
my£lf
) {

4093 
	`addR•lyE¼Ü
(
c
,"Iried hard but I can't forget myself...");

4095 } ià(
	`nodeIsSÏve
(
my£lf
è&& my£lf->
¦aveof
 =ğ
n
) {

4096 
	`addR•lyE¼Ü
(
c
,"Can't forget my master!");

4099 
	`şu¡”BÏckli¡AddNode
(
n
);

4100 
	`şu¡”D–Node
(
n
);

4101 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4102 
CLUSTER_TODO_SAVE_CONFIG
);

4103 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4104 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»¶iÿ‹"è&& c->
¬gc
 == 3) {

4106 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4109 ià(!
n
) {

4110 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4115 ià(
n
 =ğ
my£lf
) {

4116 
	`addR•lyE¼Ü
(
c
,"Can't„eplicate myself");

4121 ià(
	`nodeIsSÏve
(
n
)) {

4122 
	`addR•lyE¼Ü
(
c
,"I can only„eplicate‡ master,‚ot‡ slave.");

4129 ià(
	`nodeIsMa¡”
(
my£lf
) &&

4130 (
my£lf
->
num¦Ùs
 !ğ0 || 
	`diùSize
(
£rv”
.
db
[0].
diù
) != 0)) {

4131 
	`addR•lyE¼Ü
(
c
,

4138 
	`şu¡”S‘Ma¡”
(
n
);

4139 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|
CLUSTER_TODO_SAVE_CONFIG
);

4140 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4141 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦aves"è&& c->
¬gc
 == 3) {

4143 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4144 
j
;

4147 ià(!
n
) {

4148 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4152 ià(
	`nodeIsSÏve
(
n
)) {

4153 
	`addR•lyE¼Ü
(
c
,"The specified‚ode is‚ot‡ master");

4157 
	`addR•lyMuÉiBulkL’
(
c
,
n
->
num¦aves
);

4158 
j
 = 0; j < 
n
->
num¦aves
; j++) {

4159 
sds
 
ni
 = 
	`şu¡”G’NodeDesütiÚ
(
n
->
¦aves
[
j
]);

4160 
	`addR•lyBulkCSŒšg
(
c
,
ni
);

4161 
	`sdsä“
(
ni
);

4163 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"count-failure-reports") &&

4164 
c
->
¬gc
 == 3)

4167 
şu¡”Node
 *
n
 = 
	`şu¡”LookupNode
(
c
->
¬gv
[2]->
±r
);

4169 ià(!
n
) {

4170 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀnod%s", (*)c->
¬gv
[2]->
±r
);

4173 
	`addR•lyLÚgLÚg
(
c
,
	`şu¡”NodeFau»R•ÜtsCouÁ
(
n
));

4175 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover") &&

4176 (
c
->
¬gc
 == 2 || c->argc == 3))

4179 
fÜû
 = 0, 
keov”
 = 0;

4181 ià(
c
->
¬gc
 == 3) {

4182 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"force")) {

4183 
fÜû
 = 1;

4184 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"takeover")) {

4185 
keov”
 = 1;

4186 
fÜû
 = 1;

4188 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4194 ià(
	`nodeIsMa¡”
(
my£lf
)) {

4195 
	`addR•lyE¼Ü
(
c
,"You should send CLUSTER FAILOVERo‡ slave");

4197 } ià(
my£lf
->
¦aveof
 =ğ
NULL
) {

4198 
	`addR•lyE¼Ü
(
c
,"I'm‡ slave but my master is unknowno me");

4200 } ià(!
fÜû
 &&

4201 (
	`nodeFaed
(
my£lf
->
¦aveof
) ||

4202 
my£lf
->
¦aveof
->
lšk
 =ğ
NULL
))

4204 
	`addR•lyE¼Ü
(
c
,"Master is down or failed, "

4208 
	`»£tMªu®Faov”
();

4209 
£rv”
.
şu¡”
->
mf_’d
 = 
	`m¡ime
(è+ 
REDIS_CLUSTER_MF_TIMEOUT
;

4211 ià(
keov”
) {

4216 
	`»disLog
(
REDIS_WARNING
,"Taking overhe master (user„equest).");

4217 
	`şu¡”BumpCÚfigEpochW™houtCÚ£nsus
();

4218 
	`şu¡”Faov”R•ÏûYourMa¡”
();

4219 } ià(
fÜû
) {

4223 
	`»disLog
(
REDIS_WARNING
,"Forced failover user„equest‡ccepted.");

4224 
£rv”
.
şu¡”
->
mf_ÿn_¡¬t
 = 1;

4226 
	`»disLog
(
REDIS_WARNING
,"Manual failover user„equest‡ccepted.");

4227 
	`şu¡”S’dMFS¹
(
my£lf
->
¦aveof
);

4229 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4230 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£t-cÚfig-•och"è&& c->
¬gc
 == 3)

4239 
•och
;

4241 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
•och
,
NULL
è!ğ
REDIS_OK
)

4244 ià(
•och
 < 0) {

4245 
	`addR•lyE¼ÜFÜm©
(
c
,"Inv®id cÚfigƒpoch s³cif›d: %Îd",
•och
);

4246 } ià(
	`diùSize
(
£rv”
.
şu¡”
->
nodes
) > 1) {

4247 
	`addR•lyE¼Ü
(
c
,"The user can‡ssign‡ configƒpoch only whenhe "

4249 } ià(
my£lf
->
cÚfigEpoch
 != 0) {

4250 
	`addR•lyE¼Ü
(
c
,"Node configƒpoch is‡lready‚on-zero");

4252 
my£lf
->
cÚfigEpoch
 = 
•och
;

4253 
	`»disLog
(
REDIS_WARNING
,

4255 (è
my£lf
->
cÚfigEpoch
);

4257 ià(
£rv”
.
şu¡”
->
cu¼’tEpoch
 < (
ušt64_t
)
•och
)

4258 
£rv”
.
şu¡”
->
cu¼’tEpoch
 = 
•och
;

4262 
	`şu¡”DoBefÜeSË•
(
CLUSTER_TODO_UPDATE_STATE
|

4263 
CLUSTER_TODO_SAVE_CONFIG
);

4264 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4266 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset") &&

4267 (
c
->
¬gc
 == 2 || c->argc == 3))

4270 
h¬d
 = 0;

4273 ià(
c
->
¬gc
 == 3) {

4274 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hard")) {

4275 
h¬d
 = 1;

4276 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"soft")) {

4277 
h¬d
 = 0;

4279 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4286 ià(
	`nodeIsMa¡”
(
my£lf
è&& 
	`diùSize
(
c
->
db
->
diù
) != 0) {

4287 
	`addR•lyE¼Ü
(
c
,"CLUSTER RESET can't be called with "

4291 
	`şu¡”Re£t
(
h¬d
);

4292 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4294 
	`addR•lyE¼Ü
(
c
,"Wrong CLUSTER subcommand or‚umber of‡rguments");

4296 
	}
}

4304 
	$ü—‹DumpPaylßd
(
rio
 *
·ylßd
, 
robj
 *
o
) {

4305 
buf
[2];

4306 
ušt64_t
 
üc
;

4310 
	`rioIn™W™hBufãr
(
·ylßd
,
	`sd£m±y
());

4311 
	`»disAs£¹
(
	`rdbSaveObjeùTy³
(
·ylßd
,
o
));

4312 
	`»disAs£¹
(
	`rdbSaveObjeù
(
·ylßd
,
o
));

4322 
buf
[0] = 
REDIS_RDB_VERSION
 & 0xff;

4323 
buf
[1] = (
REDIS_RDB_VERSION
 >> 8) & 0xff;

4324 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,
buf
,2);

4327 
üc
 = 
	`üc64
(0,(*)
·ylßd
->
io
.
bufãr
.
±r
,

4328 
	`sd¦’
(
·ylßd
->
io
.
bufãr
.
±r
));

4329 
	`mem»v64ifbe
(&
üc
);

4330 
·ylßd
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Õaylßd->io.bufãr.±r,&
üc
,8);

4331 
	}
}

4337 
	$v”ifyDumpPaylßd
(*
p
, 
size_t
 
Ën
) {

4338 *
foÙ”
;

4339 
ušt16_t
 
rdbv”
;

4340 
ušt64_t
 
üc
;

4343 ià(
Ën
 < 10è 
REDIS_ERR
;

4344 
foÙ”
 = 
p
+(
Ën
-10);

4347 
rdbv”
 = (
foÙ”
[1] << 8) | footer[0];

4348 ià(
rdbv”
 !ğ
REDIS_RDB_VERSION
è 
REDIS_ERR
;

4351 
üc
 = 
	`üc64
(0,
p
,
Ën
-8);

4352 
	`mem»v64ifbe
(&
üc
);

4353  (
	`memcmp
(&
üc
,
foÙ”
+2,8è=ğ0è? 
REDIS_OK
 : 
REDIS_ERR
;

4354 
	}
}

4359 
	$dumpCommªd
(
»disCl›Á
 *
c
) {

4360 
robj
 *
o
, *
dumpobj
;

4361 
rio
 
·ylßd
;

4364 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1])è=ğ
NULL
) {

4365 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

4370 
	`ü—‹DumpPaylßd
(&
·ylßd
,
o
);

4373 
dumpobj
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
·ylßd
.
io
.
bufãr
.
±r
);

4374 
	`addR•lyBulk
(
c
,
dumpobj
);

4375 
	`deüRefCouÁ
(
dumpobj
);

4377 
	}
}

4380 
	$»¡ÜeCommªd
(
»disCl›Á
 *
c
) {

4381 
‰l
;

4382 
rio
 
·ylßd
;

4383 
j
, 
ty³
, 
»¶aû
 = 0;

4384 
robj
 *
obj
;

4387 
j
 = 4; j < 
c
->
¬gc
; j++) {

4388 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4389 
»¶aû
 = 1;

4391 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4397 ià(!
»¶aû
 && 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]è!ğ
NULL
) {

4398 
	`addR•ly
(
c
,
sh¬ed
.
busykey”r
);

4403 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
‰l
,
NULL
è!ğ
REDIS_OK
) {

4405 } ià(
‰l
 < 0) {

4406 
	`addR•lyE¼Ü
(
c
,"Invalid TTL value, must be >= 0");

4411 ià(
	`v”ifyDumpPaylßd
(
c
->
¬gv
[3]->
±r
,
	`sd¦’
(c->¬gv[3]->±r)è=ğ
REDIS_ERR
)

4413 
	`addR•lyE¼Ü
(
c
,"DUMP…ayload version or checksum‡re wrong");

4417 
	`rioIn™W™hBufãr
(&
·ylßd
,
c
->
¬gv
[3]->
±r
);

4418 ià(((
ty³
 = 
	`rdbLßdObjeùTy³
(&
·ylßd
)) == -1) ||

4419 ((
obj
 = 
	`rdbLßdObjeù
(
ty³
,&
·ylßd
)è=ğ
NULL
))

4421 
	`addR•lyE¼Ü
(
c
,"Bad data format");

4426 ià(
»¶aû
è
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

4429 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
obj
);

4430 ià(
‰l
è
	`£tExpœe
(
c
->
db
,c->
¬gv
[1],
	`m¡ime
()+ttl);

4431 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

4432 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4433 
£rv”
.
dœty
++;

4434 
	}
}

4442 
	#MIGRATE_SOCKET_CACHE_ITEMS
 64

	)

4443 
	#MIGRATE_SOCKET_CACHE_TTL
 10

	)

4445 
	smig¿‹CachedSock‘
 {

4446 
	mfd
;

4447 
	mÏ¡_dbid
;

4448 
time_t
 
	mÏ¡_u£_time
;

4449 } 
	tmig¿‹CachedSock‘
;

4462 
mig¿‹CachedSock‘
* 
	$mig¿‹G‘Sock‘
(
»disCl›Á
 *
c
, 
robj
 *
ho¡
,„obj *
pÜt
, 
timeout
) {

4463 
fd
;

4464 
sds
 
Çme
 = 
	`sd£m±y
();

4465 
mig¿‹CachedSock‘
 *
cs
;

4468 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4469 
Çme
 = 
	`sdsÿ’
(name,":",1);

4470 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4471 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4472 ià(
cs
) {

4473 
	`sdsä“
(
Çme
);

4474 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4475  
cs
;

4479 ià(
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
è=ğ
MIGRATE_SOCKET_CACHE_ITEMS
) {

4481 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4482 
cs
 = 
	`diùG‘V®
(
de
);

4483 
	`şo£
(
cs
->
fd
);

4484 
	`zä“
(
cs
);

4485 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4489 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
£rv”
.
Ã‹¼
,
c
->
¬gv
[1]->
±r
,

4490 
	`©oi
(
c
->
¬gv
[2]->
±r
),
REDIS_BIND_ADDR
);

4491 ià(
fd
 == -1) {

4492 
	`sdsä“
(
Çme
);

4493 
	`addR•lyE¼ÜFÜm©
(
c
,"Can't connectoarget‚ode: %s",

4494 
£rv”
.
Ã‹¼
);

4495  
NULL
;

4497 
	`ª‘EÇbËTıNoD–ay
(
£rv”
.
Ã‹¼
,
fd
);

4500 ià((
	`«Wa™
(
fd
,
AE_WRITABLE
,
timeout
) & AE_WRITABLE) == 0) {

4501 
	`sdsä“
(
Çme
);

4502 
	`addR•lySds
(
c
,

4503 
	`sd¢ew
("-IOERRƒrror orimeout connectingohe client\r\n"));

4504 
	`şo£
(
fd
);

4505  
NULL
;

4509 
cs
 = 
	`zm®loc
((*cs));

4510 
cs
->
fd
 = fd;

4511 
cs
->
Ï¡_dbid
 = -1;

4512 
cs
->
Ï¡_u£_time
 = 
£rv”
.
unixtime
;

4513 
	`diùAdd
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
,
cs
);

4514  
cs
;

4515 
	}
}

4518 
	$mig¿‹Clo£Sock‘
(
robj
 *
ho¡
,„obj *
pÜt
) {

4519 
sds
 
Çme
 = 
	`sd£m±y
();

4520 
mig¿‹CachedSock‘
 *
cs
;

4522 
Çme
 = 
	`sdsÿ’
Òame,
ho¡
->
±r
,
	`sd¦’
(host->ptr));

4523 
Çme
 = 
	`sdsÿ’
(name,":",1);

4524 
Çme
 = 
	`sdsÿ’
Òame,
pÜt
->
±r
,
	`sd¦’
(port->ptr));

4525 
cs
 = 
	`diùF‘chV®ue
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4526 ià(!
cs
) {

4527 
	`sdsä“
(
Çme
);

4531 
	`şo£
(
cs
->
fd
);

4532 
	`zä“
(
cs
);

4533 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
Çme
);

4534 
	`sdsä“
(
Çme
);

4535 
	}
}

4537 
	$mig¿‹Clo£TimedoutSock‘s
() {

4538 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
mig¿‹_ÿched_sock‘s
);

4539 
diùEÁry
 *
de
;

4541 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4542 
mig¿‹CachedSock‘
 *
cs
 = 
	`diùG‘V®
(
de
);

4544 ià((
£rv”
.
unixtime
 - 
cs
->
Ï¡_u£_time
è> 
MIGRATE_SOCKET_CACHE_TTL
) {

4545 
	`şo£
(
cs
->
fd
);

4546 
	`zä“
(
cs
);

4547 
	`diùD–‘e
(
£rv”
.
mig¿‹_ÿched_sock‘s
,
	`diùG‘Key
(
de
));

4550 
	`diùR–—£I‹¿tÜ
(
di
);

4551 
	}
}

4554 
	$mig¿‹Commªd
(
»disCl›Á
 *
c
) {

4555 
mig¿‹CachedSock‘
 *
cs
;

4556 
cİy
, 
»¶aû
, 
j
;

4557 
timeout
;

4558 
dbid
;

4559 
‰l
, 
expœ—t
;

4560 
robj
 *
o
;

4561 
rio
 
cmd
, 
·ylßd
;

4562 
»Œy_num
 = 0;

4564 
Œy_agaš
:

4566 
cİy
 = 0;

4567 
»¶aû
 = 0;

4568 
‰l
 = 0;

4571 
j
 = 6; j < 
c
->
¬gc
; j++) {

4572 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"copy")) {

4573 
cİy
 = 1;

4574 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"replace")) {

4575 
»¶aû
 = 1;

4577 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

4583 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
timeout
,
NULL
è!ğ
REDIS_OK
)

4585 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
dbid
,
NULL
è!ğ
REDIS_OK
)

4587 ià(
timeout
 <= 0)imeout = 1000;

4592 ià((
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[3])è=ğ
NULL
) {

4593 
	`addR•lySds
(
c
,
	`sd¢ew
("+NOKEY\r\n"));

4598 
cs
 = 
	`mig¿‹G‘Sock‘
(
c
,c->
¬gv
[1],c->¬gv[2],
timeout
);

4599 ià(
cs
 =ğ
NULL
) ;

4601 
	`rioIn™W™hBufãr
(&
cmd
,
	`sd£m±y
());

4604 
£Ëù
 = 
cs
->
Ï¡_dbid
 !ğ
dbid
;

4605 ià(
£Ëù
) {

4606 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',2));

4607 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"SELECT",6));

4608 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
dbid
));

4612 
expœ—t
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[3]);

4613 ià(
expœ—t
 != -1) {

4614 
‰l
 = 
expœ—t
-
	`m¡ime
();

4615 ià(
‰l
 < 1)tl = 1;

4617 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkCouÁ
(&
cmd
,'*',
»¶aû
 ? 5 : 4));

4618 ià(
£rv”
.
şu¡”_’abËd
)

4619 
	`»disAs£¹W™hInfo
(
c
,
NULL
,

4620 
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE-ASKING",14));

4622 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"RESTORE",7));

4623 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`sdsEncodedObjeù
(c->
¬gv
[3]));

4624 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,c->
¬gv
[3]->
±r
,

4625 
	`sd¦’
(
c
->
¬gv
[3]->
±r
)));

4626 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkLÚgLÚg
(&
cmd
,
‰l
));

4630 
	`ü—‹DumpPaylßd
(&
·ylßd
,
o
);

4631 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,
·ylßd
.
io
.
bufãr
.
±r
,

4632 
	`sd¦’
(
·ylßd
.
io
.
bufãr
.
±r
)));

4633 
	`sdsä“
(
·ylßd
.
io
.
bufãr
.
±r
);

4637 ià(
»¶aû
)

4638 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`rioWr™eBulkSŒšg
(&
cmd
,"REPLACE",7));

4641 
”ºo
 = 0;

4643 
sds
 
buf
 = 
cmd
.
io
.
bufãr
.
±r
;

4644 
size_t
 
pos
 = 0, 
towr™e
;

4645 
nwr™‹n
 = 0;

4647 (
towr™e
 = 
	`sd¦’
(
buf
)-
pos
) > 0) {

4648 
towr™e
 = (towrite > (64*1024) ? (64*1024) :owrite);

4649 
nwr™‹n
 = 
	`syncWr™e
(
cs
->
fd
,
buf
+
pos
,
towr™e
,
timeout
);

4650 ià(
nwr™‹n
 !ğ(sigÃd)
towr™e
è
sock‘_wr_”r
;

4651 
pos
 +ğ
nwr™‹n
;

4657 
buf1
[1024];

4658 
buf2
[1024];

4661 ià(
£Ëù
 && 
	`syncR—dLše
(
cs
->
fd
, 
buf1
, (buf1), 
timeout
) <= 0)

4662 
sock‘_rd_”r
;

4663 ià(
	`syncR—dLše
(
cs
->
fd
, 
buf2
, (buf2), 
timeout
) <= 0)

4664 
sock‘_rd_”r
;

4665 ià((
£Ëù
 && 
buf1
[0] =ğ'-'è|| 
buf2
[0] == '-') {

4667 
cs
->
Ï¡_dbid
 = -1;

4668 
	`addR•lyE¼ÜFÜm©
(
c
,"Target instance„eplied withƒrror: %s",

4669 (
£Ëù
 && 
buf1
[0] =ğ'-'è? buf1+1 : 
buf2
+1);

4672 
cs
->
Ï¡_dbid
 = 
dbid
;

4673 
robj
 *
aux
;

4675 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4677 ià(!
cİy
) {

4679 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[3]);

4680 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[3]);

4681 
£rv”
.
dœty
++;

4684 
aux
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

4685 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
aux
,c->
¬gv
[3]);

4686 
	`deüRefCouÁ
(
aux
);

4691 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

4694 
sock‘_wr_”r
:

4695 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

4696 
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

4697 ià(
”ºo
 !ğ
ETIMEDOUT
 && 
»Œy_num
++ =ğ0è
Œy_agaš
;

4698 
	`addR•lySds
(
c
,

4699 
	`sd¢ew
("-IOERRƒrror orimeout writingoarget instance\r\n"));

4702 
sock‘_rd_”r
:

4703 
	`sdsä“
(
cmd
.
io
.
bufãr
.
±r
);

4704 
	`mig¿‹Clo£Sock‘
(
c
->
¬gv
[1],c->argv[2]);

4705 ià(
”ºo
 !ğ
ETIMEDOUT
 && 
»Œy_num
++ =ğ0è
Œy_agaš
;

4706 
	`addR•lySds
(
c
,

4707 
	`sd¢ew
("-IOERRƒrror orimeout„eading fromarget‚ode\r\n"));

4709 
	}
}

4719 
	$askšgCommªd
(
»disCl›Á
 *
c
) {

4720 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

4721 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

4724 
c
->
æags
 |ğ
REDIS_ASKING
;

4725 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4726 
	}
}

4731 
	$»adÚlyCommªd
(
»disCl›Á
 *
c
) {

4732 ià(
£rv”
.
şu¡”_’abËd
 == 0) {

4733 
	`addR•lyE¼Ü
(
c
,"This instance has cluster support disabled");

4736 
c
->
æags
 |ğ
REDIS_READONLY
;

4737 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4738 
	}
}

4741 
	$»adwr™eCommªd
(
»disCl›Á
 *
c
) {

4742 
c
->
æags
 &ğ~
REDIS_READONLY
;

4743 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

4744 
	}
}

4775 
şu¡”Node
 *
	$g‘NodeByQu”y
(
»disCl›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
”rÜ_code
) {

4776 
şu¡”Node
 *
n
 = 
NULL
;

4777 
robj
 *
fœ¡key
 = 
NULL
;

4778 
muÉË_keys
 = 0;

4779 
muÉiS‹
 *
ms
, 
_ms
;

4780 
muÉiCmd
 
mc
;

4781 
i
, 
¦Ù
 = 0, 
mig¿tšg_¦Ù
 = 0, 
impÜtšg_¦Ù
 = 0, 
missšg_keys
 = 0;

4784 ià(
”rÜ_code
è*”rÜ_codğ
REDIS_CLUSTER_REDIR_NONE
;

4788 ià(
cmd
->
´oc
 =ğ
execCommªd
) {

4791 ià(!(
c
->
æags
 & 
REDIS_MULTI
)è 
my£lf
;

4792 
ms
 = &
c
->
m¡©e
;

4797 
ms
 = &
_ms
;

4798 
_ms
.
commªds
 = &
mc
;

4799 
_ms
.
couÁ
 = 1;

4800 
mc
.
¬gv
 =‡rgv;

4801 
mc
.
¬gc
 =‡rgc;

4802 
mc
.
cmd
 = cmd;

4807 
i
 = 0; i < 
ms
->
couÁ
; i++) {

4808 
»disCommªd
 *
mcmd
;

4809 
robj
 **
m¬gv
;

4810 
m¬gc
, *
keyšdex
, 
numkeys
, 
j
;

4812 
mcmd
 = 
ms
->
commªds
[
i
].
cmd
;

4813 
m¬gc
 = 
ms
->
commªds
[
i
].
¬gc
;

4814 
m¬gv
 = 
ms
->
commªds
[
i
].
¬gv
;

4816 
keyšdex
 = 
	`g‘KeysFromCommªd
(
mcmd
,
m¬gv
,
m¬gc
,&
numkeys
);

4817 
j
 = 0; j < 
numkeys
; j++) {

4818 
robj
 *
thiskey
 = 
m¬gv
[
keyšdex
[
j
]];

4819 
this¦Ù
 = 
	`keyHashSlÙ
((*)
thiskey
->
±r
,

4820 
	`sd¦’
(
thiskey
->
±r
));

4822 ià(
fœ¡key
 =ğ
NULL
) {

4825 
fœ¡key
 = 
thiskey
;

4826 
¦Ù
 = 
this¦Ù
;

4827 
n
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

4833 ià(
n
 =ğ
NULL
) {

4834 
	`g‘KeysF»eResuÉ
(
keyšdex
);

4835 ià(
”rÜ_code
)

4836 *
”rÜ_code
 = 
REDIS_CLUSTER_REDIR_DOWN_UNBOUND
;

4837  
NULL
;

4845 ià(
n
 =ğ
my£lf
 &&

4846 
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
] !ğ
NULL
)

4848 
mig¿tšg_¦Ù
 = 1;

4849 } ià(
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] !ğ
NULL
) {

4850 
impÜtšg_¦Ù
 = 1;

4855 ià(!
	`equ®SŒšgObjeùs
(
fœ¡key
,
thiskey
)) {

4856 ià(
¦Ù
 !ğ
this¦Ù
) {

4858 
	`g‘KeysF»eResuÉ
(
keyšdex
);

4859 ià(
”rÜ_code
)

4860 *
”rÜ_code
 = 
REDIS_CLUSTER_REDIR_CROSS_SLOT
;

4861  
NULL
;

4865 
muÉË_keys
 = 1;

4871 ià((
mig¿tšg_¦Ù
 || 
impÜtšg_¦Ù
) &&

4872 
	`lookupKeyR—d
(&
£rv”
.
db
[0],
thiskey
è=ğ
NULL
)

4874 
missšg_keys
++;

4877 
	`g‘KeysF»eResuÉ
(
keyšdex
);

4882 ià(
n
 =ğ
NULL
è 
my£lf
;

4885 ià(
hash¦Ù
è*hash¦Ù = 
¦Ù
;

4892 ià(
mig¿tšg_¦Ù
 && 
missšg_keys
) {

4893 ià(
”rÜ_code
è*”rÜ_codğ
REDIS_CLUSTER_REDIR_ASK
;

4894  
£rv”
.
şu¡”
->
mig¿tšg_¦Ùs_to
[
¦Ù
];

4901 ià(
impÜtšg_¦Ù
 &&

4902 (
c
->
æags
 & 
REDIS_ASKING
 || 
cmd
->æag & 
REDIS_CMD_ASKING
))

4904 ià(
muÉË_keys
 && 
missšg_keys
) {

4905 ià(
”rÜ_code
è*”rÜ_codğ
REDIS_CLUSTER_REDIR_UNSTABLE
;

4906  
NULL
;

4908  
my£lf
;

4915 ià(
c
->
æags
 & 
REDIS_READONLY
 &&

4916 
cmd
->
æags
 & 
REDIS_CMD_READONLY
 &&

4917 
	`nodeIsSÏve
(
my£lf
) &&

4918 
my£lf
->
¦aveof
 =ğ
n
)

4920  
my£lf
;

4925 ià(
n
 !ğ
my£lf
 && 
”rÜ_code
è*”rÜ_codğ
REDIS_CLUSTER_REDIR_MOVED
;

4926  
n
;

4927 
	}
}

4936 
	$şu¡”RedœeùCl›Á
(
»disCl›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
) {

4937 ià(
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_CROSS_SLOT
) {

4938 
	`addR•lySds
(
c
,
	`sd¢ew
("-CROSSSLOT Keys in„equest don't hashohe same slot\r\n"));

4939 } ià(
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_UNSTABLE
) {

4943 
	`addR•lySds
(
c
,
	`sd¢ew
("-TRYAGAIN Multiple keys„equest during„ehashing of slot\r\n"));

4944 } ià(
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_DOWN_STATE
) {

4945 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN The cluster is down\r\n"));

4946 } ià(
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_DOWN_UNBOUND
) {

4947 
	`addR•lySds
(
c
,
	`sd¢ew
("-CLUSTERDOWN Hash slot‚ot served\r\n"));

4948 } ià(
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_MOVED
 ||

4949 
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_ASK
)

4951 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),

4953 (
”rÜ_code
 =ğ
REDIS_CLUSTER_REDIR_ASK
) ? "ASK" : "MOVED",

4954 
hash¦Ù
,
n
->

,n->
pÜt
));

4956 
	`»disPªic
("getNodeByQuery() unknownƒrror.");

4958 
	}
}

4971 
	$şu¡”RedœeùBlockedCl›ÁIfN“ded
(
»disCl›Á
 *
c
) {

4972 ià(
c
->
æags
 & 
REDIS_BLOCKED
 && c->
bty³
 =ğ
REDIS_BLOCKED_LIST
) {

4973 
diùEÁry
 *
de
;

4974 
diùI‹¿tÜ
 *
di
;

4977 ià(
£rv”
.
şu¡”
->
¡©e
 =ğ
REDIS_CLUSTER_FAIL
) {

4978 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,
REDIS_CLUSTER_REDIR_DOWN_STATE
);

4982 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

4983 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

4984 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

4985 
¦Ù
 = 
	`keyHashSlÙ
((*)
key
->
±r
, 
	`sd¦’
(key->ptr));

4986 
şu¡”Node
 *
node
 = 
£rv”
.
şu¡”
->
¦Ùs
[
¦Ù
];

4991 ià(
node
 !ğ
my£lf
 &&

4992 
£rv”
.
şu¡”
->
impÜtšg_¦Ùs_äom
[
¦Ù
] =ğ
NULL
)

4994 ià(
node
 =ğ
NULL
) {

4995 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,

4996 
REDIS_CLUSTER_REDIR_DOWN_UNBOUND
);

4998 
	`şu¡”RedœeùCl›Á
(
c
,
node
,
¦Ù
,

4999 
REDIS_CLUSTER_REDIR_MOVED
);

5004 
	`diùR–—£I‹¿tÜ
(
di
);

5007 
	}
}

	@cluster.h

1 #iâdeà
__REDIS_CLUSTER_H


2 
	#__REDIS_CLUSTER_H


	)

8 
	#REDIS_CLUSTER_SLOTS
 16384

	)

9 
	#REDIS_CLUSTER_OK
 0

	)

10 
	#REDIS_CLUSTER_FAIL
 1

	)

11 
	#REDIS_CLUSTER_NAMELEN
 40

	)

12 
	#REDIS_CLUSTER_PORT_INCR
 10000

	)

16 
	#REDIS_CLUSTER_DEFAULT_NODE_TIMEOUT
 15000

	)

17 
	#REDIS_CLUSTER_DEFAULT_SLAVE_VALIDITY
 10

	)

18 
	#REDIS_CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
 1

	)

19 
	#REDIS_CLUSTER_FAIL_REPORT_VALIDITY_MULT
 2

	)

20 
	#REDIS_CLUSTER_FAIL_UNDO_TIME_MULT
 2

	)

21 
	#REDIS_CLUSTER_FAIL_UNDO_TIME_ADD
 10

	)

22 
	#REDIS_CLUSTER_FAILOVER_DELAY
 5

	)

23 
	#REDIS_CLUSTER_DEFAULT_MIGRATION_BARRIER
 1

	)

24 
	#REDIS_CLUSTER_MF_TIMEOUT
 5000

	)

25 
	#REDIS_CLUSTER_MF_PAUSE_MULT
 2

	)

28 
	#REDIS_CLUSTER_REDIR_NONE
 0

	)

29 
	#REDIS_CLUSTER_REDIR_CROSS_SLOT
 1

	)

30 
	#REDIS_CLUSTER_REDIR_UNSTABLE
 2

	)

31 
	#REDIS_CLUSTER_REDIR_ASK
 3

	)

32 
	#REDIS_CLUSTER_REDIR_MOVED
 4

	)

33 
	#REDIS_CLUSTER_REDIR_DOWN_STATE
 5

	)

34 
	#REDIS_CLUSTER_REDIR_DOWN_UNBOUND
 6

	)

36 
	gşu¡”Node
;

39 
	sşu¡”Lšk
 {

40 
m¡ime_t
 
	mùime
;

41 
	mfd
;

42 
sds
 
	m¢dbuf
;

43 
sds
 
	mrcvbuf
;

44 
şu¡”Node
 *
	mnode
;

45 } 
	tşu¡”Lšk
;

48 
	#REDIS_NODE_MASTER
 1

	)

49 
	#REDIS_NODE_SLAVE
 2

	)

50 
	#REDIS_NODE_PFAIL
 4

	)

51 
	#REDIS_NODE_FAIL
 8

	)

52 
	#REDIS_NODE_MYSELF
 16

	)

53 
	#REDIS_NODE_HANDSHAKE
 32

	)

54 
	#REDIS_NODE_NOADDR
 64

	)

55 
	#REDIS_NODE_MEET
 128

	)

56 
	#REDIS_NODE_PROMOTED
 256

	)

57 
	#REDIS_NODE_NULL_NAME
 "\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000"

	)

59 
	#nodeIsMa¡”
(
n
è(Ò)->
æags
 & 
REDIS_NODE_MASTER
)

	)

60 
	#nodeIsSÏve
(
n
è(Ò)->
æags
 & 
REDIS_NODE_SLAVE
)

	)

61 
	#nodeInHªdshake
(
n
è(Ò)->
æags
 & 
REDIS_NODE_HANDSHAKE
)

	)

62 
	#nodeHasAddr
(
n
è(!(Ò)->
æags
 & 
REDIS_NODE_NOADDR
))

	)

63 
	#nodeW™houtAddr
(
n
è(Ò)->
æags
 & 
REDIS_NODE_NOADDR
)

	)

64 
	#nodeTimedOut
(
n
è(Ò)->
æags
 & 
REDIS_NODE_PFAIL
)

	)

65 
	#nodeFaed
(
n
è(Ò)->
æags
 & 
REDIS_NODE_FAIL
)

	)

68 
	#REDIS_CLUSTER_CANT_FAILOVER_NONE
 0

	)

69 
	#REDIS_CLUSTER_CANT_FAILOVER_DATA_AGE
 1

	)

70 
	#REDIS_CLUSTER_CANT_FAILOVER_WAITING_DELAY
 2

	)

71 
	#REDIS_CLUSTER_CANT_FAILOVER_EXPIRED
 3

	)

72 
	#REDIS_CLUSTER_CANT_FAILOVER_WAITING_VOTES
 4

	)

73 
	#REDIS_CLUSTER_CANT_FAILOVER_RELOG_PERIOD
 (60*5è

	)

76 
	sşu¡”NodeFaR•Üt
 {

77 
şu¡”Node
 *
	mnode
;

78 
m¡ime_t
 
	mtime
;

79 } 
	tşu¡”NodeFaR•Üt
;

81 
	sşu¡”Node
 {

82 
m¡ime_t
 
	mùime
;

83 
	mÇme
[
REDIS_CLUSTER_NAMELEN
];

84 
	mæags
;

85 
ušt64_t
 
	mcÚfigEpoch
;

86 
	m¦Ùs
[
REDIS_CLUSTER_SLOTS
/8];

87 
	mnum¦Ùs
;

88 
	mnum¦aves
;

89 
şu¡”Node
 **
	m¦aves
;

90 
şu¡”Node
 *
	m¦aveof
;

91 
m¡ime_t
 
	mpšg_£Á
;

92 
m¡ime_t
 
	mpÚg_»ûived
;

93 
m¡ime_t
 
	mç_time
;

94 
m¡ime_t
 
	mvÙed_time
;

95 
m¡ime_t
 
	m»¶_off£t_time
;

96 
	m»¶_off£t
;

97 
	m
[
REDIS_IP_STR_LEN
];

98 
	mpÜt
;

99 
şu¡”Lšk
 *
	mlšk
;

100 
li¡
 *
	mç_»pÜts
;

101 } 
	tşu¡”Node
;

103 
	sşu¡”S‹
 {

104 
şu¡”Node
 *
	mmy£lf
;

105 
ušt64_t
 
	mcu¼’tEpoch
;

106 
	m¡©e
;

107 
	msize
;

108 
diù
 *
	mnodes
;

109 
diù
 *
	mnodes_bÏck_li¡
;

110 
şu¡”Node
 *
	mmig¿tšg_¦Ùs_to
[
REDIS_CLUSTER_SLOTS
];

111 
şu¡”Node
 *
	mimpÜtšg_¦Ùs_äom
[
REDIS_CLUSTER_SLOTS
];

112 
şu¡”Node
 *
	m¦Ùs
[
REDIS_CLUSTER_SLOTS
];

113 
zskli¡
 *
	m¦Ùs_to_keys
;

115 
m¡ime_t
 
	mçov”_auth_time
;

116 
	mçov”_auth_couÁ
;

117 
	mçov”_auth_£Á
;

118 
	mçov”_auth_¿nk
;

119 
ušt64_t
 
	mçov”_auth_•och
;

120 
	mÿÁ_çov”_»asÚ
;

123 
m¡ime_t
 
	mmf_’d
;

126 
şu¡”Node
 *
	mmf_¦ave
;

128 
	mmf_ma¡”_off£t
;

130 
	mmf_ÿn_¡¬t
;

133 
ušt64_t
 
	mÏ¡VÙeEpoch
;

134 
	mtodo_befÜe_¦“p
;

135 
	m¡©s_bus_mes§ges_£Á
;

136 
	m¡©s_bus_mes§ges_»ûived
;

137 } 
	tşu¡”S‹
;

140 
	#CLUSTER_TODO_HANDLE_FAILOVER
 (1<<0)

	)

141 
	#CLUSTER_TODO_UPDATE_STATE
 (1<<1)

	)

142 
	#CLUSTER_TODO_SAVE_CONFIG
 (1<<2)

	)

143 
	#CLUSTER_TODO_FSYNC_CONFIG
 (1<<3)

	)

151 
	#CLUSTERMSG_TYPE_PING
 0

	)

152 
	#CLUSTERMSG_TYPE_PONG
 1

	)

153 
	#CLUSTERMSG_TYPE_MEET
 2

	)

154 
	#CLUSTERMSG_TYPE_FAIL
 3

	)

155 
	#CLUSTERMSG_TYPE_PUBLISH
 4

	)

156 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST
 5

	)

157 
	#CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK
 6

	)

158 
	#CLUSTERMSG_TYPE_UPDATE
 7

	)

159 
	#CLUSTERMSG_TYPE_MFSTART
 8

	)

165 
	mnod’ame
[
REDIS_CLUSTER_NAMELEN
];

166 
ušt32_t
 
	mpšg_£Á
;

167 
ušt32_t
 
	mpÚg_»ûived
;

168 
	m
[
REDIS_IP_STR_LEN
];

169 
ušt16_t
 
	mpÜt
;

170 
ušt16_t
 
	mæags
;

171 
ušt16_t
 
	mnÙu£d1
;

172 
ušt32_t
 
	mnÙu£d2
;

173 } 
	tşu¡”MsgD©aGoss
;

176 
	mnod’ame
[
REDIS_CLUSTER_NAMELEN
];

177 } 
	tşu¡”MsgD©aFa
;

180 
ušt32_t
 
	mchªÃl_Ën
;

181 
ušt32_t
 
	mmes§ge_Ën
;

185 
	mbulk_d©a
[8];

186 } 
	tşu¡”MsgD©aPublish
;

189 
ušt64_t
 
	mcÚfigEpoch
;

190 
	mnod’ame
[
REDIS_CLUSTER_NAMELEN
];

191 
	m¦Ùs
[
REDIS_CLUSTER_SLOTS
/8];

192 } 
	tşu¡”MsgD©aUpd©e
;

194 
	uşu¡”MsgD©a
 {

198 
şu¡”MsgD©aGoss
 
	mgoss
[1];

199 } 
	mpšg
;

203 
şu¡”MsgD©aFa
 
	mabout
;

204 } 
	mç
;

208 
şu¡”MsgD©aPublish
 
	mmsg
;

209 } 
	mpublish
;

213 
şu¡”MsgD©aUpd©e
 
	mnodecfg
;

214 } 
	mupd©e
;

217 
	#CLUSTER_PROTO_VER
 0

	)

220 
	msig
[4];

221 
ušt32_t
 
	mtÙËn
;

222 
ušt16_t
 
	mv”
;

223 
ušt16_t
 
	mnÙu£d0
;

224 
ušt16_t
 
	mty³
;

225 
ušt16_t
 
	mcouÁ
;

226 
ušt64_t
 
	mcu¼’tEpoch
;

227 
ušt64_t
 
	mcÚfigEpoch
;

230 
ušt64_t
 
	moff£t
;

232 
	m£nd”
[
REDIS_CLUSTER_NAMELEN
];

233 
	mmy¦Ùs
[
REDIS_CLUSTER_SLOTS
/8];

234 
	m¦aveof
[
REDIS_CLUSTER_NAMELEN
];

235 
	mnÙu£d1
[32];

236 
ušt16_t
 
	mpÜt
;

237 
ušt16_t
 
	mæags
;

238 
	m¡©e
;

239 
	mmæags
[3];

240 
şu¡”MsgD©a
 
	md©a
;

241 } 
	tşu¡”Msg
;

243 
	#CLUSTERMSG_MIN_LEN
 ((
şu¡”Msg
)-(
şu¡”MsgD©a
))

	)

247 
	#CLUSTERMSG_FLAG0_PAUSED
 (1<<0è

	)

248 
	#CLUSTERMSG_FLAG0_FORCEACK
 (1<<1è

	)

252 
şu¡”Node
 *
g‘NodeByQu”y
(
»disCl›Á
 *
c
, 
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
hash¦Ù
, *
ask
);

253 
şu¡”RedœeùBlockedCl›ÁIfN“ded
(
»disCl›Á
 *
c
);

254 
şu¡”RedœeùCl›Á
(
»disCl›Á
 *
c
, 
şu¡”Node
 *
n
, 
hash¦Ù
, 
”rÜ_code
);

	@config.c

31 
	~"»dis.h
"

32 
	~"şu¡”.h
"

34 
	~<fú.h
>

35 
	~<sys/¡©.h
>

38 cÚ¡ *
	mÇme
;

39 cÚ¡ 
	mv®ue
;

40 } 
	gv®idSy¦ogFac™›s
[] = {

41 {"u£r", 
LOG_USER
},

42 {"loÿl0", 
LOG_LOCAL0
},

43 {"loÿl1", 
LOG_LOCAL1
},

44 {"loÿl2", 
LOG_LOCAL2
},

45 {"loÿl3", 
LOG_LOCAL3
},

46 {"loÿl4", 
LOG_LOCAL4
},

47 {"loÿl5", 
LOG_LOCAL5
},

48 {"loÿl6", 
LOG_LOCAL6
},

49 {"loÿl7", 
LOG_LOCAL7
},

50 {
NULL
, 0}

53 
ş›ÁBufãrLim™sCÚfig
 
	gş›ÁBufãrLim™sDeçuÉs
[
REDIS_CLIENT_TYPE_COUNT
] = {

63 
	$ye¢Ùoi
(*
s
) {

64 ià(!
	`¡rÿ£cmp
(
s
,"yes"))  1;

65 ià(!
	`¡rÿ£cmp
(
s
,"no"))  0;

67 
	}
}

69 
	$­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
) {

70 
£rv”
.
§v•¬ams
 = 
	`z»®loc
(£rv”.§v•¬ams,(
§v•¬am
)*(£rv”.
§v•¬am¦’
+1));

71 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
£cÚds
 = seconds;

72 
£rv”
.
§v•¬ams
[£rv”.
§v•¬am¦’
].
chªges
 = changes;

73 
£rv”
.
§v•¬am¦’
++;

74 
	}
}

76 
	$»£tS”v”SaveP¬ams
() {

77 
	`zä“
(
£rv”
.
§v•¬ams
);

78 
£rv”
.
§v•¬ams
 = 
NULL
;

79 
£rv”
.
§v•¬am¦’
 = 0;

80 
	}
}

82 
	$lßdS”v”CÚfigFromSŒšg
(*
cÚfig
) {

83 *
”r
 = 
NULL
;

84 
lš’um
 = 0, 
tÙlšes
, 
i
;

85 
¦aveof_lš’um
 = 0;

86 
sds
 *
lšes
;

88 
lšes
 = 
	`sds¥l™Ën
(
cÚfig
,
	`¡¾’
(cÚfig),"\n",1,&
tÙlšes
);

90 
i
 = 0; i < 
tÙlšes
; i++) {

91 
sds
 *
¬gv
;

92 
¬gc
;

94 
lš’um
 = 
i
+1;

95 
lšes
[
i
] = 
	`sd¡rim
(lines[i]," \t\r\n");

98 ià(
lšes
[
i
][0] == '#' ||†ines[i][0] == '\0') ;

101 
¬gv
 = 
	`sds¥l™¬gs
(
lšes
[
i
],&
¬gc
);

102 ià(
¬gv
 =ğ
NULL
) {

103 
”r
 = "Unbalanced quotes in configuration†ine";

104 
lßd”r
;

108 ià(
¬gc
 == 0) {

109 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

112 
	`sd¡Şow”
(
¬gv
[0]);

115 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"timeout"è&& 
¬gc
 == 2) {

116 
£rv”
.
maxidËtime
 = 
	`©oi
(
¬gv
[1]);

117 ià(
£rv”
.
maxidËtime
 < 0) {

118 
”r
 = "Inv®idimeouˆv®ue"; 
lßd”r
;

120 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-k“·live"è&& 
¬gc
 == 2) {

121 
£rv”
.
tık“·live
 = 
	`©oi
(
¬gv
[1]);

122 ià(
£rv”
.
tık“·live
 < 0) {

123 
”r
 = "Inv®idı-k“·livv®ue"; 
lßd”r
;

125 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pÜt"è&& 
¬gc
 == 2) {

126 
£rv”
.
pÜt
 = 
	`©oi
(
¬gv
[1]);

127 ià(
£rv”
.
pÜt
 < 0 || server.port > 65535) {

128 
”r
 = "Inv®id…Üt"; 
lßd”r
;

130 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"tı-backlog"è&& 
¬gc
 == 2) {

131 
£rv”
.
tı_backlog
 = 
	`©oi
(
¬gv
[1]);

132 ià(
£rv”
.
tı_backlog
 < 0) {

133 
”r
 = "Inv®id backlog v®ue"; 
lßd”r
;

135 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"bšd"è&& 
¬gc
 >= 2) {

136 
j
, 
add»s£s
 = 
¬gc
-1;

138 ià(
add»s£s
 > 
REDIS_BINDADDR_MAX
) {

139 
”r
 = "ToØmªy bšd‡dd»s£ ¥ecif›d"; 
lßd”r
;

141 
j
 = 0; j < 
add»s£s
; j++)

142 
£rv”
.
bšdaddr
[
j
] = 
	`z¡rdup
(
¬gv
[j+1]);

143 
£rv”
.
bšdaddr_couÁ
 = 
add»s£s
;

144 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘"è&& 
¬gc
 == 2) {

145 
£rv”
.
unixsock‘
 = 
	`z¡rdup
(
¬gv
[1]);

146 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"unixsock‘³rm"è&& 
¬gc
 == 2) {

147 
”ºo
 = 0;

148 
£rv”
.
unixsock‘³rm
 = (
mode_t
)
	`¡¹Ş
(
¬gv
[1], 
NULL
, 8);

149 ià(
”ºo
 || 
£rv”
.
unixsock‘³rm
 > 0777) {

150 
”r
 = "Inv®id sock‘ f³rmissiÚs"; 
lßd”r
;

152 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"save")) {

153 ià(
¬gc
 == 3) {

154 
£cÚds
 = 
	`©oi
(
¬gv
[1]);

155 
chªges
 = 
	`©oi
(
¬gv
[2]);

156 ià(
£cÚds
 < 1 || 
chªges
 < 0) {

157 
”r
 = "Inv®id sav·¿m‘”s"; 
lßd”r
;

159 
	`­³ndS”v”SaveP¬ams
(
£cÚds
,
chªges
);

160 } ià(
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
¬gv
[1],"")) {

161 
	`»£tS”v”SaveP¬ams
();

163 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dœ"è&& 
¬gc
 == 2) {

164 ià(
	`chdœ
(
¬gv
[1]) == -1) {

165 
	`»disLog
(
REDIS_WARNING
,"Can't chdiro '%s': %s",

166 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

167 
	`ex™
(1);

169 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logËv–"è&& 
¬gc
 == 2) {

170 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"debug")è
£rv”
.
v”bos™y
 = 
REDIS_DEBUG
;

171 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"v”bo£")è
£rv”
.
v”bos™y
 = 
REDIS_VERBOSE
;

172 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"nÙiû")è
£rv”
.
v”bos™y
 = 
REDIS_NOTICE
;

173 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"w¬nšg")è
£rv”
.
v”bos™y
 = 
REDIS_WARNING
;

175 
”r
 = "Invalid†og†evel. Must be one of debug,‚otice, warning";

176 
lßd”r
;

178 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"logfe"è&& 
¬gc
 == 2) {

179 
FILE
 *
logå
;

181 
	`zä“
(
£rv”
.
logfe
);

182 
£rv”
.
logfe
 = 
	`z¡rdup
(
¬gv
[1]);

183 ià(
£rv”
.
logfe
[0] != '\0') {

186 
logå
 = 
	`fİ’
(
£rv”
.
logfe
,"a");

187 ià(
logå
 =ğ
NULL
) {

188 
”r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

189 "Cª'ˆİ’hlog fe: %s", 
	`¡»¼Ü
(
”ºo
));

190 
lßd”r
;

192 
	`fşo£
(
logå
);

194 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-’abËd"è&& 
¬gc
 == 2) {

195 ià((
£rv”
.
sy¦og_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

196 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

198 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-id’t"è&& 
¬gc
 == 2) {

199 ià(
£rv”
.
sy¦og_id’t
è
	`zä“
(server.syslog_ident);

200 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
¬gv
[1]);

201 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sy¦og-çc™y"è&& 
¬gc
 == 2) {

202 
i
;

204 
i
 = 0; 
v®idSy¦ogFac™›s
[i].
Çme
; i++) {

205 ià(!
	`¡rÿ£cmp
(
v®idSy¦ogFac™›s
[
i
].
Çme
, 
¬gv
[1])) {

206 
£rv”
.
sy¦og_çc™y
 = 
v®idSy¦ogFac™›s
[
i
].
v®ue
;

211 ià(!
v®idSy¦ogFac™›s
[
i
].
Çme
) {

212 
”r
 = "Invalid†og facility. Must be one of USER or between LOCAL0-LOCAL7";

213 
lßd”r
;

215 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d©aba£s"è&& 
¬gc
 == 2) {

216 
£rv”
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

217 ià(
£rv”
.
dbnum
 < 1) {

218 
”r
 = "Inv®id‚umb” oàd©aba£s"; 
lßd”r
;

220 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"šşude"è&& 
¬gc
 == 2) {

221 
	`lßdS”v”CÚfig
(
¬gv
[1],
NULL
);

222 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxş›Ás"è&& 
¬gc
 == 2) {

223 
£rv”
.
maxş›Ás
 = 
	`©oi
(
¬gv
[1]);

224 ià(
£rv”
.
maxş›Ás
 < 1) {

225 
”r
 = "Inv®id max cl›Á lim™"; 
lßd”r
;

227 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy"è&& 
¬gc
 == 2) {

228 
£rv”
.
maxmemÜy
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

229 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-pŞicy"è&& 
¬gc
 == 2) {

230 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"volatile-lru")) {

231 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_LRU
;

232 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"volatile-random")) {

233 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_RANDOM
;

234 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"volatile-ttl")) {

235 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_TTL
;

236 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"allkeys-lru")) {

237 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_ALLKEYS_LRU
;

238 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"allkeys-random")) {

239 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_ALLKEYS_RANDOM
;

240 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"noeviction")) {

241 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_NO_EVICTION
;

243 
”r
 = "Invalid maxmemory…olicy";

244 
lßd”r
;

246 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"maxmemÜy-§m¶es"è&& 
¬gc
 == 2) {

247 
£rv”
.
maxmemÜy_§m¶es
 = 
	`©oi
(
¬gv
[1]);

248 ià(
£rv”
.
maxmemÜy_§m¶es
 <= 0) {

249 
”r
 = "maxmemory-samples must be 1 or greater";

250 
lßd”r
;

252 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦aveof"è&& 
¬gc
 == 3) {

253 
¦aveof_lš’um
 = 
lš’um
;

254 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

255 
£rv”
.
ma¡”pÜt
 = 
	`©oi
(
¬gv
[2]);

256 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

257 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-pšg-¦ave-³riod"è&& 
¬gc
 == 2) {

258 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
	`©oi
(
¬gv
[1]);

259 ià(
£rv”
.
»¶_pšg_¦ave_³riod
 <= 0) {

260 
”r
 = "repl-ping-slave-period must be 1 or greater";

261 
lßd”r
;

263 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-timeout"è&& 
¬gc
 == 2) {

264 
£rv”
.
»¶_timeout
 = 
	`©oi
(
¬gv
[1]);

265 ià(
£rv”
.
»¶_timeout
 <= 0) {

266 
”r
 = "repl-timeout must be 1 or greater";

267 
lßd”r
;

269 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-di§bË-tı-nod–ay"è&& 
¬gc
==2) {

270 ià((
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

271 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

273 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync"è&& 
¬gc
==2) {

274 ià((
£rv”
.
»¶_diskËss_sync
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

275 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

277 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-diskËss-sync-d–ay"è&& 
¬gc
==2) {

278 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
	`©oi
(
¬gv
[1]);

279 ià(
£rv”
.
»¶_diskËss_sync_d–ay
 < 0) {

280 
”r
 = "repl-diskless-sync-delay can't be‚egative";

281 
lßd”r
;

283 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-size"è&& 
¬gc
 == 2) {

284 
size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

285 ià(
size
 <= 0) {

286 
”r
 = "repl-backlog-size must be 1 or greater.";

287 
lßd”r
;

289 
	`»sizeR•liÿtiÚBacklog
(
size
);

290 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»¶-backlog-‰l"è&& 
¬gc
 == 2) {

291 
£rv”
.
»¶_backlog_time_lim™
 = 
	`©oi
(
¬gv
[1]);

292 ià(
£rv”
.
»¶_backlog_time_lim™
 < 0) {

293 
”r
 = "repl-backlog-ttl can't be‚egative ";

294 
lßd”r
;

296 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ma¡”auth"è&& 
¬gc
 == 2) {

297 
£rv”
.
ma¡”auth
 = 
	`z¡rdup
(
¬gv
[1]);

298 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-£rve-¡®e-d©a"è&& 
¬gc
 == 2) {

299 ià((
£rv”
.
»¶_£rve_¡®e_d©a
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

300 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

302 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-»ad-Úly"è&& 
¬gc
 == 2) {

303 ià((
£rv”
.
»¶_¦ave_ro
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

304 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

306 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbcom´essiÚ"è&& 
¬gc
 == 2) {

307 ià((
£rv”
.
rdb_com´essiÚ
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

308 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

310 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"rdbchecksum"è&& 
¬gc
 == 2) {

311 ià((
£rv”
.
rdb_checksum
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

312 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

314 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aùiv”ehashšg"è&& 
¬gc
 == 2) {

315 ià((
£rv”
.
aùiv”ehashšg
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

316 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

318 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"d«mÚize"è&& 
¬gc
 == 2) {

319 ià((
£rv”
.
d«mÚize
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

320 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

322 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hz"è&& 
¬gc
 == 2) {

323 
£rv”
.
hz
 = 
	`©oi
(
¬gv
[1]);

324 ià(
£rv”
.
hz
 < 
REDIS_MIN_HZ
) server.hz = REDIS_MIN_HZ;

325 ià(
£rv”
.
hz
 > 
REDIS_MAX_HZ
) server.hz = REDIS_MAX_HZ;

326 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndÚly"è&& 
¬gc
 == 2) {

327 
yes
;

329 ià((
yes
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

330 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

332 
£rv”
.
aof_¡©e
 = 
yes
 ? 
REDIS_AOF_ON
 : 
REDIS_AOF_OFF
;

333 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndf’ame"è&& 
¬gc
 == 2) {

334 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

335 
”r
 = "appendfilename can't be‡…ath, just‡ filename";

336 
lßd”r
;

338 
	`zä“
(
£rv”
.
aof_f’ame
);

339 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

340 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"no-appendfsync-on-rewrite")

341 && 
¬gc
 == 2) {

342 ià((
£rv”
.
aof_no_fsync_Ú_»wr™e
ğ
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

343 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

345 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"­³ndfsync"è&& 
¬gc
 == 2) {

346 ià(!
	`¡rÿ£cmp
(
¬gv
[1],"no")) {

347 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_NO
;

348 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"always")) {

349 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_ALWAYS
;

350 } ià(!
	`¡rÿ£cmp
(
¬gv
[1],"everysec")) {

351 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_EVERYSEC
;

353 
”r
 = "argument must be 'no', 'always' or 'everysec'";

354 
lßd”r
;

356 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-percentage") &&

357 
¬gc
 == 2)

359 
£rv”
.
aof_»wr™e_³rc
 = 
	`©oi
(
¬gv
[1]);

360 ià(
£rv”
.
aof_»wr™e_³rc
 < 0) {

361 
”r
 = "Invalid‚egative…ercentage for AOF‡uto„ewrite";

362 
lßd”r
;

364 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auto-aof-rewrite-min-size") &&

365 
¬gc
 == 2)

367 
£rv”
.
aof_»wr™e_mš_size
 = 
	`memtŞl
(
¬gv
[1],
NULL
);

368 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-rewrite-incremental-fsync") &&

369 
¬gc
 == 2)

371 ià((
£rv”
.
aof_»wr™e_šüem’l_fsync
 =

372 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

373 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

375 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"aof-lßd-Œunÿ‹d"è&& 
¬gc
 == 2) {

376 ià((
£rv”
.
aof_lßd_Œunÿ‹d
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

377 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

379 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»quœ•ass"è&& 
¬gc
 == 2) {

380 ià(
	`¡¾’
(
¬gv
[1]è> 
REDIS_AUTHPASS_MAX_LEN
) {

381 
”r
 = "Password is†ongerhan REDIS_AUTHPASS_MAX_LEN";

382 
lßd”r
;

384 
£rv”
.
»quœ•ass
 = 
	`z¡rdup
(
¬gv
[1]);

385 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"pidfe"è&& 
¬gc
 == 2) {

386 
	`zä“
(
£rv”
.
pidfe
);

387 
£rv”
.
pidfe
 = 
	`z¡rdup
(
¬gv
[1]);

388 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"dbf’ame"è&& 
¬gc
 == 2) {

389 ià(!
	`·thIsBa£Name
(
¬gv
[1])) {

390 
”r
 = "dbfilename can't be‡…ath, just‡ filename";

391 
lßd”r
;

393 
	`zä“
(
£rv”
.
rdb_f’ame
);

394 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
¬gv
[1]);

395 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

396 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

397 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hash-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

398 
£rv”
.
hash_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

399 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-’Œ›s"è&& 
¬gc
 == 2){

400 
£rv”
.
li¡_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

401 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"li¡-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

402 
£rv”
.
li¡_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

403 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"£t-max-št£t-’Œ›s"è&& 
¬gc
 == 2) {

404 
£rv”
.
£t_max_št£t_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

405 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-’Œ›s"è&& 
¬gc
 == 2) {

406 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

407 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"z£t-max-zli¡-v®ue"è&& 
¬gc
 == 2) {

408 
£rv”
.
z£t_max_zli¡_v®ue
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

409 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"hÎ-¥¬£-max-by‹s"è&& 
¬gc
 == 2) {

410 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
	`memtŞl
(
¬gv
[1], 
NULL
);

411 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"»Çme-commªd"è&& 
¬gc
 == 3) {

412 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
¬gv
[1]);

413 
»tv®
;

415 ià(!
cmd
) {

416 
”r
 = "No such command in„ename-command";

417 
lßd”r
;

422 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
commªds
, 
¬gv
[1]);

423 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

426 ià(
	`sd¦’
(
¬gv
[2]) != 0) {

427 
sds
 
cİy
 = 
	`sdsdup
(
¬gv
[2]);

429 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
cİy
, 
cmd
);

430 ià(
»tv®
 !ğ
DICT_OK
) {

431 
	`sdsä“
(
cİy
);

432 
”r
 = "T¬g‘ commªd‚am®»adyƒxi¡s"; 
lßd”r
;

435 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-’abËd"è&& 
¬gc
 == 2) {

436 ià((
£rv”
.
şu¡”_’abËd
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

437 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

439 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-cÚfig-fe"è&& 
¬gc
 == 2) {

440 
	`zä“
(
£rv”
.
şu¡”_cÚfigfe
);

441 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
¬gv
[1]);

442 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-require-full-coverage") &&

443 
¬gc
 == 2)

445 ià((
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1)

447 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

449 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"şu¡”-node-timeout"è&& 
¬gc
 == 2) {

450 
£rv”
.
şu¡”_node_timeout
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

451 ià(
£rv”
.
şu¡”_node_timeout
 <= 0) {

452 
”r
 = "şu¡”‚odtimeouˆmu¡ b1 o¸g»©”"; 
lßd”r
;

454 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-migration-barrier")

455 && 
¬gc
 == 2)

457 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
	`©oi
(
¬gv
[1]);

458 ià(
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 < 0) {

459 
”r
 = "cluster migration barrier must zero or…ositive";

460 
lßd”r
;

462 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cluster-slave-validity-factor")

463 && 
¬gc
 == 2)

465 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
	`©oi
(
¬gv
[1]);

466 ià(
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 < 0) {

467 
”r
 = "cluster slave validity factor must be zero or…ositive";

468 
lßd”r
;

470 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"lua-time-lim™"è&& 
¬gc
 == 2) {

471 
£rv”
.
lua_time_lim™
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

472 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"slowlog-log-slower-than") &&

473 
¬gc
 == 2)

475 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

476 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"latency-monitor-threshold") &&

477 
¬gc
 == 2)

479 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

480 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 < 0) {

481 
”r
 = "The†atencyhreshold can't be‚egative";

482 
lßd”r
;

484 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦owlog-max-Ën"è&& 
¬gc
 == 2) {

485 
£rv”
.
¦owlog_max_Ën
 = 
	`¡¹Şl
(
¬gv
[1],
NULL
,10);

486 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"client-output-buffer-limit") &&

487 
¬gc
 == 5)

489 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
¬gv
[1]);

490 
h¬d
, 
soá
;

491 
soá_£cÚds
;

493 ià(
şass
 == -1) {

494 
”r
 = "Unrecognized client†imit class";

495 
lßd”r
;

497 
h¬d
 = 
	`memtŞl
(
¬gv
[2],
NULL
);

498 
soá
 = 
	`memtŞl
(
¬gv
[3],
NULL
);

499 
soá_£cÚds
 = 
	`©oi
(
¬gv
[4]);

500 ià(
soá_£cÚds
 < 0) {

501 
”r
 = "Negative‚umber of seconds in soft†imit is invalid";

502 
lßd”r
;

504 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

505 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

506 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

507 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"stop-writes-on-bgsave-error") &&

508 
¬gc
 == 2) {

509 ià((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
	`ye¢Ùoi
(
¬gv
[1])) == -1) {

510 
”r
 = "¬gum’ˆmu¡ b'yes' o¸'no'"; 
lßd”r
;

512 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"¦ave-´iÜ™y"è&& 
¬gc
 == 2) {

513 
£rv”
.
¦ave_´iÜ™y
 = 
	`©oi
(
¬gv
[1]);

514 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-to-wr™e"è&& 
¬gc
 == 2) {

515 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
	`©oi
(
¬gv
[1]);

516 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 < 0) {

517 
”r
 = "Inv®id v®ufÜ mš-¦aves-to-wr™e."; 
lßd”r
;

519 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mš-¦aves-max-Ïg"è&& 
¬gc
 == 2) {

520 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
	`©oi
(
¬gv
[1]);

521 ià(
£rv”
.
»¶_mš_¦aves_max_Ïg
 < 0) {

522 
”r
 = "Inv®id v®ufÜ mš-¦aves-max-Ïg."; 
lßd”r
;

524 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙify-key¥aû-ev’ts"è&& 
¬gc
 == 2) {

525 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
¬gv
[1]);

527 ià(
æags
 == -1) {

528 
”r
 = "Invalidƒvent class character. Use 'g$lshzxeA'.";

529 
lßd”r
;

531 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

532 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"sentinel")) {

535 ià(
¬gc
 != 1) {

536 ià(!
£rv”
.
£Áš–_mode
) {

537 
”r
 = "sentinel directive while‚ot in sentinel mode";

538 
lßd”r
;

540 
”r
 = 
	`£Áš–HªdËCÚfigu¿tiÚ
(
¬gv
+1,
¬gc
-1);

541 ià(
”r
è
lßd”r
;

544 
”r
 = "Bad dœeùivÜ wrÚg‚umb” oà¬gum’ts"; 
lßd”r
;

546 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

550 ià(
£rv”
.
şu¡”_’abËd
 && s”v”.
ma¡”ho¡
) {

551 
lš’um
 = 
¦aveof_lš’um
;

552 
i
 = 
lš’um
-1;

553 
”r
 = "slaveof directive‚ot‡llowed in cluster mode";

554 
lßd”r
;

557 
	`sdsä“¥l™»s
(
lšes
,
tÙlšes
);

560 
lßd”r
:

561 
	`årštf
(
¡d”r
, "\n*** FATAL CONFIG FILE ERROR ***\n");

562 
	`årštf
(
¡d”r
, "R—dšghcÚfigu¿tiÚ fe,‡ˆlš%d\n", 
lš’um
);

563 
	`årštf
(
¡d”r
, ">>> '%s'\n", 
lšes
[
i
]);

564 
	`årštf
(
¡d”r
, "%s\n", 
”r
);

565 
	`ex™
(1);

566 
	}
}

575 
	$lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
) {

576 
sds
 
cÚfig
 = 
	`sd£m±y
();

577 
buf
[
REDIS_CONFIGLINE_MAX
+1];

580 ià(
f’ame
) {

581 
FILE
 *
å
;

583 ià(
f’ame
[0] == '-' && filename[1] == '\0') {

584 
å
 = 
¡dš
;

586 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
) {

587 
	`»disLog
(
REDIS_WARNING
,

588 "F©®ƒ¼Ü, cª'ˆİ’ cÚfig f'%s'", 
f’ame
);

589 
	`ex™
(1);

592 
	`fg‘s
(
buf
,
REDIS_CONFIGLINE_MAX
+1,
å
è!ğ
NULL
)

593 
cÚfig
 = 
	`sdsÿt
(cÚfig,
buf
);

594 ià(
å
 !ğ
¡dš
è
	`fşo£
(fp);

597 ià(
İtiÚs
) {

598 
cÚfig
 = 
	`sdsÿt
(config,"\n");

599 
cÚfig
 = 
	`sdsÿt
(cÚfig,
İtiÚs
);

601 
	`lßdS”v”CÚfigFromSŒšg
(
cÚfig
);

602 
	`sdsä“
(
cÚfig
);

603 
	}
}

609 
	$cÚfigS‘Commªd
(
»disCl›Á
 *
c
) {

610 
robj
 *
o
;

611 
Î
;

612 
”r
;

613 
	`»disAs£¹W™hInfo
(
c
,c->
¬gv
[2],
	`sdsEncodedObjeù
(c->argv[2]));

614 
	`»disAs£¹W™hInfo
(
c
,c->
¬gv
[3],
	`sdsEncodedObjeù
(c->argv[3]));

615 
o
 = 
c
->
¬gv
[3];

617 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"dbfilename")) {

618 ià(!
	`·thIsBa£Name
(
o
->
±r
)) {

619 
	`addR•lyE¼Ü
(
c
, "dbfilename can't be‡…ath, just‡ filename");

622 
	`zä“
(
£rv”
.
rdb_f’ame
);

623 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
o
->
±r
);

624 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"requirepass")) {

625 ià(
	`sd¦’
(
o
->
±r
è> 
REDIS_AUTHPASS_MAX_LEN
è
badfmt
;

626 
	`zä“
(
£rv”
.
»quœ•ass
);

627 
£rv”
.
»quœ•ass
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

628 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"masterauth")) {

629 
	`zä“
(
£rv”
.
ma¡”auth
);

630 
£rv”
.
ma¡”auth
 = ((*)
o
->
±r
)[0] ? 
	`z¡rdup
(o->±rè: 
NULL
;

631 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"maxmemory")) {

632 
Î
 = 
	`memtŞl
(
o
->
±r
,&
”r
);

633 ià(
”r
 || 
Î
 < 0è
badfmt
;

634 
£rv”
.
maxmemÜy
 = 
Î
;

635 ià(
£rv”
.
maxmemÜy
) {

636 ià(
£rv”
.
maxmemÜy
 < 
	`zm®loc_u£d_memÜy
()) {

637 
	`»disLog
(
REDIS_WARNING
,"WARNING:he‚ew maxmemory value set via CONFIG SET is smallerhanhe current memory usage. This will„esult in keysƒviction‡nd/or inabilityo‡ccept‚ew write commands depending onhe maxmemory-policy.");

639 
	`ä“MemÜyIfN“ded
();

641 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"maxclients")) {

642 
Üig_v®ue
 = 
£rv”
.
maxş›Ás
;

644 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 1è
badfmt
;

647 
£rv”
.
maxş›Ás
 = 
Î
;

648 ià(
Î
 > 
Üig_v®ue
) {

649 
	`adju¡O³nFesLim™
();

650 ià(
£rv”
.
maxş›Ás
 !ğ
Î
) {

651 
	`addR•lyE¼ÜFÜm©
(
c
,"Thİ”©šg sy¡em i nÙ‡bËØhªdËh¥ecif›d‚umb” oàş›Ás,ry w™h %d", 
£rv”
.
maxş›Ás
);

652 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

655 ià((è
	`«G‘S‘Size
(
£rv”
.
–
) <

656 
£rv”
.
maxş›Ás
 + 
REDIS_EVENTLOOP_FDSET_INCR
)

658 ià(
	`«ResizeS‘Size
(
£rv”
.
–
,

659 
£rv”
.
maxş›Ás
 + 
REDIS_EVENTLOOP_FDSET_INCR
è=ğ
AE_ERR
)

661 
	`addR•lyE¼Ü
(
c
,"Theƒvent†oop API used by Redis is‚ot‡bleo handlehe specified‚umber of clients");

662 
£rv”
.
maxş›Ás
 = 
Üig_v®ue
;

667 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hz")) {

668 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

669 
£rv”
.
hz
 = 
Î
;

670 ià(
£rv”
.
hz
 < 
REDIS_MIN_HZ
) server.hz = REDIS_MIN_HZ;

671 ià(
£rv”
.
hz
 > 
REDIS_MAX_HZ
) server.hz = REDIS_MAX_HZ;

672 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"maxmemory-policy")) {

673 ià(!
	`¡rÿ£cmp
(
o
->
±r
,"volatile-lru")) {

674 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_LRU
;

675 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"volatile-random")) {

676 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_RANDOM
;

677 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"volatile-ttl")) {

678 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_VOLATILE_TTL
;

679 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"allkeys-lru")) {

680 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_ALLKEYS_LRU
;

681 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"allkeys-random")) {

682 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_ALLKEYS_RANDOM
;

683 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"noeviction")) {

684 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_NO_EVICTION
;

686 
badfmt
;

688 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"maxmemory-samples")) {

689 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

690 
Î
 <ğ0è
badfmt
;

691 
£rv”
.
maxmemÜy_§m¶es
 = 
Î
;

692 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"timeout")) {

693 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

694 
Î
 < 0 ||†È> 
LONG_MAX
è
badfmt
;

695 
£rv”
.
maxidËtime
 = 
Î
;

696 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"tcp-keepalive")) {

697 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

698 
Î
 < 0 ||†È> 
INT_MAX
è
badfmt
;

699 
£rv”
.
tık“·live
 = 
Î
;

700 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"appendfsync")) {

701 ià(!
	`¡rÿ£cmp
(
o
->
±r
,"no")) {

702 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_NO
;

703 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"everysec")) {

704 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_EVERYSEC
;

705 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"always")) {

706 
£rv”
.
aof_fsync
 = 
AOF_FSYNC_ALWAYS
;

708 
badfmt
;

710 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"no-appendfsync-on-rewrite")) {

711 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

713 ià(
yn
 =ğ-1è
badfmt
;

714 
£rv”
.
aof_no_fsync_Ú_»wr™e
 = 
yn
;

715 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"appendonly")) {

716 
’abË
 = 
	`ye¢Ùoi
(
o
->
±r
);

718 ià(
’abË
 =ğ-1è
badfmt
;

719 ià(
’abË
 =ğ0 && 
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
) {

720 
	`¡İAµ’dOÆy
();

721 } ià(
’abË
 && 
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_OFF
) {

722 ià(
	`¡¬tAµ’dOÆy
(è=ğ
REDIS_ERR
) {

723 
	`addR•lyE¼Ü
(
c
,

728 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"auto-aof-rewrite-percentage")) {

729 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

730 
£rv”
.
aof_»wr™e_³rc
 = 
Î
;

731 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"auto-aof-rewrite-min-size")) {

732 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

733 
£rv”
.
aof_»wr™e_mš_size
 = 
Î
;

734 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"aof-rewrite-incremental-fsync")) {

735 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

737 ià(
yn
 =ğ-1è
badfmt
;

738 
£rv”
.
aof_»wr™e_šüem’l_fsync
 = 
yn
;

739 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"aof-load-truncated")) {

740 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

742 ià(
yn
 =ğ-1è
badfmt
;

743 
£rv”
.
aof_lßd_Œunÿ‹d
 = 
yn
;

744 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"save")) {

745 
vËn
, 
j
;

746 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

751 ià(
vËn
 & 1) {

752 
	`sdsä“¥l™»s
(
v
,
vËn
);

753 
badfmt
;

755 
j
 = 0; j < 
vËn
; j++) {

756 *
•Œ
;

757 
v®
;

759 
v®
 = 
	`¡¹Şl
(
v
[
j
], &
•Œ
, 10);

760 ià(
•Œ
[0] != '\0' ||

761 ((
j
 & 1è=ğ0 && 
v®
 < 1) ||

762 ((
j
 & 1è=ğ1 && 
v®
 < 0)) {

763 
	`sdsä“¥l™»s
(
v
,
vËn
);

764 
badfmt
;

768 
	`»£tS”v”SaveP¬ams
();

769 
j
 = 0; j < 
vËn
; j += 2) {

770 
time_t
 
£cÚds
;

771 
chªges
;

773 
£cÚds
 = 
	`¡¹Şl
(
v
[
j
],
NULL
,10);

774 
chªges
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

775 
	`­³ndS”v”SaveP¬ams
(
£cÚds
, 
chªges
);

777 
	`sdsä“¥l™»s
(
v
,
vËn
);

778 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"slave-serve-stale-data")) {

779 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

781 ià(
yn
 =ğ-1è
badfmt
;

782 
£rv”
.
»¶_£rve_¡®e_d©a
 = 
yn
;

783 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"slave-read-only")) {

784 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

786 ià(
yn
 =ğ-1è
badfmt
;

787 
£rv”
.
»¶_¦ave_ro
 = 
yn
;

788 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"activerehashing")) {

789 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

791 ià(
yn
 =ğ-1è
badfmt
;

792 
£rv”
.
aùiv”ehashšg
 = 
yn
;

793 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"dir")) {

794 ià(
	`chdœ
((*)
o
->
±r
) == -1) {

795 
	`addR•lyE¼ÜFÜm©
(
c
,"Chªgšg dœeùÜy: %s", 
	`¡»¼Ü
(
”ºo
));

798 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hash-max-ziplist-entries")) {

799 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

800 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
Î
;

801 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hash-max-ziplist-value")) {

802 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

803 
£rv”
.
hash_max_zli¡_v®ue
 = 
Î
;

804 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"list-max-ziplist-entries")) {

805 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

806 
£rv”
.
li¡_max_zli¡_’Œ›s
 = 
Î
;

807 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"list-max-ziplist-value")) {

808 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

809 
£rv”
.
li¡_max_zli¡_v®ue
 = 
Î
;

810 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"set-max-intset-entries")) {

811 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

812 
£rv”
.
£t_max_št£t_’Œ›s
 = 
Î
;

813 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"zset-max-ziplist-entries")) {

814 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

815 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
Î
;

816 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"zset-max-ziplist-value")) {

817 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

818 
£rv”
.
z£t_max_zli¡_v®ue
 = 
Î
;

819 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"hll-sparse-max-bytes")) {

820 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

821 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
Î
;

822 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"lua-time-limit")) {

823 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

824 
£rv”
.
lua_time_lim™
 = 
Î
;

825 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"slowlog-log-slower-than")) {

826 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
è
badfmt
;

827 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
Î
;

828 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"slowlog-max-len")) {

829 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

830 
£rv”
.
¦owlog_max_Ën
 = ()
Î
;

831 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"latency-monitor-threshold")) {

832 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

833 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
Î
;

834 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"loglevel")) {

835 ià(!
	`¡rÿ£cmp
(
o
->
±r
,"warning")) {

836 
£rv”
.
v”bos™y
 = 
REDIS_WARNING
;

837 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"notice")) {

838 
£rv”
.
v”bos™y
 = 
REDIS_NOTICE
;

839 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"verbose")) {

840 
£rv”
.
v”bos™y
 = 
REDIS_VERBOSE
;

841 } ià(!
	`¡rÿ£cmp
(
o
->
±r
,"debug")) {

842 
£rv”
.
v”bos™y
 = 
REDIS_DEBUG
;

844 
badfmt
;

846 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"client-output-buffer-limit")) {

847 
vËn
, 
j
;

848 
sds
 *
v
 = 
	`sds¥l™Ën
(
o
->
±r
,
	`sd¦’
(o->±r)," ",1,&
vËn
);

851 ià(
vËn
 % 4) {

852 
	`sdsä“¥l™»s
(
v
,
vËn
);

853 
badfmt
;

859 
j
 = 0; j < 
vËn
; j++) {

860 
v®
;

862 ià((
j
 % 4) == 0) {

863 ià(
	`g‘Cl›ÁTy³ByName
(
v
[
j
]) == -1) {

864 
	`sdsä“¥l™»s
(
v
,
vËn
);

865 
badfmt
;

868 
v®
 = 
	`memtŞl
(
v
[
j
], &
”r
);

869 ià(
”r
 || 
v®
 < 0) {

870 
	`sdsä“¥l™»s
(
v
,
vËn
);

871 
badfmt
;

876 
j
 = 0; j < 
vËn
; j += 4) {

877 
şass
;

878 
h¬d
, 
soá
;

879 
soá_£cÚds
;

881 
şass
 = 
	`g‘Cl›ÁTy³ByName
(
v
[
j
]);

882 
h¬d
 = 
	`¡¹Şl
(
v
[
j
+1],
NULL
,10);

883 
soá
 = 
	`¡¹Şl
(
v
[
j
+2],
NULL
,10);

884 
soá_£cÚds
 = 
	`¡¹Şl
(
v
[
j
+3],
NULL
,10);

886 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 = 
h¬d
;

887 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 = 
soá
;

888 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
 = 
soá_£cÚds
;

890 
	`sdsä“¥l™»s
(
v
,
vËn
);

891 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"stop-writes-on-bgsave-error")) {

892 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

894 ià(
yn
 =ğ-1è
badfmt
;

895 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
yn
;

896 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-ping-slave-period")) {

897 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È<ğ0è
badfmt
;

898 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
Î
;

899 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-timeout")) {

900 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È<ğ0è
badfmt
;

901 
£rv”
.
»¶_timeout
 = 
Î
;

902 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-backlog-size")) {

903 
Î
 = 
	`memtŞl
(
o
->
±r
,&
”r
);

904 ià(
”r
 || 
Î
 < 0è
badfmt
;

905 
	`»sizeR•liÿtiÚBacklog
(
Î
);

906 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-backlog-ttl")) {

907 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

908 
£rv”
.
»¶_backlog_time_lim™
 = 
Î
;

909 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"watchdog-period")) {

910 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†È< 0è
badfmt
;

911 ià(
Î
)

912 
	`’abËW©chdog
(
Î
);

914 
	`di§bËW©chdog
();

915 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"rdbcompression")) {

916 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

918 ià(
yn
 =ğ-1è
badfmt
;

919 
£rv”
.
rdb_com´essiÚ
 = 
yn
;

920 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"notify-keyspace-events")) {

921 
æags
 = 
	`key¥aûEv’tsSŒšgToFÏgs
(
o
->
±r
);

923 ià(
æags
 =ğ-1è
badfmt
;

924 
£rv”
.
nÙify_key¥aû_ev’ts
 = 
æags
;

925 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-disable-tcp-nodelay")) {

926 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

928 ià(
yn
 =ğ-1è
badfmt
;

929 
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
yn
;

930 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-diskless-sync")) {

931 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

933 ià(
yn
 =ğ-1è
badfmt
;

934 
£rv”
.
»¶_diskËss_sync
 = 
yn
;

935 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"repl-diskless-sync-delay")) {

936 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

937 
Î
 < 0è
badfmt
;

938 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
Î
;

939 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"slave-priority")) {

940 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

941 
Î
 < 0è
badfmt
;

942 
£rv”
.
¦ave_´iÜ™y
 = 
Î
;

943 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"min-slaves-to-write")) {

944 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

945 
Î
 < 0è
badfmt
;

946 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
Î
;

947 
	`»äeshGoodSÏvesCouÁ
();

948 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"min-slaves-max-lag")) {

949 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

950 
Î
 < 0è
badfmt
;

951 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
Î
;

952 
	`»äeshGoodSÏvesCouÁ
();

953 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"cluster-require-full-coverage")) {

954 
yn
 = 
	`ye¢Ùoi
(
o
->
±r
);

956 ià(
yn
 =ğ-1è
badfmt
;

957 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
yn
;

958 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"cluster-node-timeout")) {

959 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

960 
Î
 <ğ0è
badfmt
;

961 
£rv”
.
şu¡”_node_timeout
 = 
Î
;

962 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"cluster-migration-barrier")) {

963 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

964 
Î
 < 0è
badfmt
;

965 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
Î
;

966 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"cluster-slave-validity-factor")) {

967 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||

968 
Î
 < 0è
badfmt
;

969 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
Î
;

971 
	`addR•lyE¼ÜFÜm©
(
c
,"Unsupported CONFIG…arameter: %s",

972 (*)
c
->
¬gv
[2]->
±r
);

975 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

978 
badfmt
:

979 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for CONFIG SET '%s'",

980 (*)
o
->
±r
,

981 (*)
c
->
¬gv
[2]->
±r
);

982 
	}
}

988 
	#cÚfig_g‘_¡ršg_f›ld
(
_Çme
,
_v¬
) do { \

989 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,0)) { \

990 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

991 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? _var : ""); \

992 
m©ches
++; \

994 } 0);

	)

996 
	#cÚfig_g‘_boŞ_f›ld
(
_Çme
,
_v¬
) do { \

997 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,0)) { \

998 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

999 
	`addR•lyBulkCSŒšg
(
c
,
_v¬
 ? "yes" : "no"); \

1000 
m©ches
++; \

1002 } 0);

	)

1004 
	#cÚfig_g‘_num”iÿl_f›ld
(
_Çme
,
_v¬
) do { \

1005 ià(
	`¡ršgm©ch
(
·‰”n
,
_Çme
,0)) { \

1006 
	`Î2¡ršg
(
buf
,(buf),
_v¬
); \

1007 
	`addR•lyBulkCSŒšg
(
c
,
_Çme
); \

1008 
	`addR•lyBulkCSŒšg
(
c
,
buf
); \

1009 
m©ches
++; \

1011 } 0);

	)

1013 
	$cÚfigG‘Commªd
(
»disCl›Á
 *
c
) {

1014 
robj
 *
o
 = 
c
->
¬gv
[2];

1015 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1016 *
·‰”n
 = 
o
->
±r
;

1017 
buf
[128];

1018 
m©ches
 = 0;

1019 
	`»disAs£¹W™hInfo
(
c
,
o
,
	`sdsEncodedObjeù
(o));

1022 
	`cÚfig_g‘_¡ršg_f›ld
("dbf’ame",
£rv”
.
rdb_f’ame
);

1023 
	`cÚfig_g‘_¡ršg_f›ld
("»quœ•ass",
£rv”
.
»quœ•ass
);

1024 
	`cÚfig_g‘_¡ršg_f›ld
("ma¡”auth",
£rv”
.
ma¡”auth
);

1025 
	`cÚfig_g‘_¡ršg_f›ld
("unixsock‘",
£rv”
.
unixsock‘
);

1026 
	`cÚfig_g‘_¡ršg_f›ld
("logfe",
£rv”
.
logfe
);

1027 
	`cÚfig_g‘_¡ršg_f›ld
("pidfe",
£rv”
.
pidfe
);

1030 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy",
£rv”
.
maxmemÜy
);

1031 
	`cÚfig_g‘_num”iÿl_f›ld
("maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
);

1032 
	`cÚfig_g‘_num”iÿl_f›ld
("timeout",
£rv”
.
maxidËtime
);

1033 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-k“·live",
£rv”
.
tık“·live
);

1034 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-percentage",

1035 
£rv”
.
aof_»wr™e_³rc
);

1036 
	`cÚfig_g‘_num”iÿl_f›ld
("auto-aof-rewrite-min-size",

1037 
£rv”
.
aof_»wr™e_mš_size
);

1038 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-entries",

1039 
£rv”
.
hash_max_zli¡_’Œ›s
);

1040 
	`cÚfig_g‘_num”iÿl_f›ld
("hash-max-ziplist-value",

1041 
£rv”
.
hash_max_zli¡_v®ue
);

1042 
	`cÚfig_g‘_num”iÿl_f›ld
("list-max-ziplist-entries",

1043 
£rv”
.
li¡_max_zli¡_’Œ›s
);

1044 
	`cÚfig_g‘_num”iÿl_f›ld
("list-max-ziplist-value",

1045 
£rv”
.
li¡_max_zli¡_v®ue
);

1046 
	`cÚfig_g‘_num”iÿl_f›ld
("set-max-intset-entries",

1047 
£rv”
.
£t_max_št£t_’Œ›s
);

1048 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-entries",

1049 
£rv”
.
z£t_max_zli¡_’Œ›s
);

1050 
	`cÚfig_g‘_num”iÿl_f›ld
("zset-max-ziplist-value",

1051 
£rv”
.
z£t_max_zli¡_v®ue
);

1052 
	`cÚfig_g‘_num”iÿl_f›ld
("hll-sparse-max-bytes",

1053 
£rv”
.
hÎ_¥¬£_max_by‹s
);

1054 
	`cÚfig_g‘_num”iÿl_f›ld
("lua-time-lim™",
£rv”
.
lua_time_lim™
);

1055 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-log-slower-than",

1056 
£rv”
.
¦owlog_log_¦ow”_thª
);

1057 
	`cÚfig_g‘_num”iÿl_f›ld
("latency-monitor-threshold",

1058 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
);

1059 
	`cÚfig_g‘_num”iÿl_f›ld
("slowlog-max-len",

1060 
£rv”
.
¦owlog_max_Ën
);

1061 
	`cÚfig_g‘_num”iÿl_f›ld
("pÜt",
£rv”
.
pÜt
);

1062 
	`cÚfig_g‘_num”iÿl_f›ld
("tı-backlog",
£rv”
.
tı_backlog
);

1063 
	`cÚfig_g‘_num”iÿl_f›ld
("d©aba£s",
£rv”
.
dbnum
);

1064 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
);

1065 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-timeout",
£rv”
.
»¶_timeout
);

1066 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-size",
£rv”
.
»¶_backlog_size
);

1067 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
);

1068 
	`cÚfig_g‘_num”iÿl_f›ld
("maxş›Ás",
£rv”
.
maxş›Ás
);

1069 
	`cÚfig_g‘_num”iÿl_f›ld
("w©chdog-³riod",
£rv”
.
w©chdog_³riod
);

1070 
	`cÚfig_g‘_num”iÿl_f›ld
("¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
);

1071 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
);

1072 
	`cÚfig_g‘_num”iÿl_f›ld
("mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
);

1073 
	`cÚfig_g‘_num”iÿl_f›ld
("hz",
£rv”
.
hz
);

1074 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
);

1075 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
);

1076 
	`cÚfig_g‘_num”iÿl_f›ld
("şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
);

1077 
	`cÚfig_g‘_num”iÿl_f›ld
("»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
);

1080 
	`cÚfig_g‘_boŞ_f›ld
("cluster-require-full-coverage",

1081 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
);

1082 
	`cÚfig_g‘_boŞ_f›ld
("no-appendfsync-on-rewrite",

1083 
£rv”
.
aof_no_fsync_Ú_»wr™e
);

1084 
	`cÚfig_g‘_boŞ_f›ld
("slave-serve-stale-data",

1085 
£rv”
.
»¶_£rve_¡®e_d©a
);

1086 
	`cÚfig_g‘_boŞ_f›ld
("slave-read-only",

1087 
£rv”
.
»¶_¦ave_ro
);

1088 
	`cÚfig_g‘_boŞ_f›ld
("stop-writes-on-bgsave-error",

1089 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
);

1090 
	`cÚfig_g‘_boŞ_f›ld
("d«mÚize", 
£rv”
.
d«mÚize
);

1091 
	`cÚfig_g‘_boŞ_f›ld
("rdbcom´essiÚ", 
£rv”
.
rdb_com´essiÚ
);

1092 
	`cÚfig_g‘_boŞ_f›ld
("rdbchecksum", 
£rv”
.
rdb_checksum
);

1093 
	`cÚfig_g‘_boŞ_f›ld
("aùiv”ehashšg", 
£rv”
.
aùiv”ehashšg
);

1094 
	`cÚfig_g‘_boŞ_f›ld
("repl-disable-tcp-nodelay",

1095 
£rv”
.
»¶_di§bË_tı_nod–ay
);

1096 
	`cÚfig_g‘_boŞ_f›ld
("repl-diskless-sync",

1097 
£rv”
.
»¶_diskËss_sync
);

1098 
	`cÚfig_g‘_boŞ_f›ld
("aof-rewrite-incremental-fsync",

1099 
£rv”
.
aof_»wr™e_šüem’l_fsync
);

1100 
	`cÚfig_g‘_boŞ_f›ld
("aof-load-truncated",

1101 
£rv”
.
aof_lßd_Œunÿ‹d
);

1105 ià(
	`¡ršgm©ch
(
·‰”n
,"appendonly",0)) {

1106 
	`addR•lyBulkCSŒšg
(
c
,"appendonly");

1107 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_OFF
 ? "no" : "yes");

1108 
m©ches
++;

1110 ià(
	`¡ršgm©ch
(
·‰”n
,"dir",0)) {

1111 
buf
[1024];

1113 ià(
	`g‘cwd
(
buf
,(buf)è=ğ
NULL
)

1114 
buf
[0] = '\0';

1116 
	`addR•lyBulkCSŒšg
(
c
,"dir");

1117 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1118 
m©ches
++;

1120 ià(
	`¡ršgm©ch
(
·‰”n
,"maxmemory-policy",0)) {

1121 *
s
;

1123 
£rv”
.
maxmemÜy_pŞicy
) {

1124 
REDIS_MAXMEMORY_VOLATILE_LRU
: 
s
 = "volatile-lru"; ;

1125 
REDIS_MAXMEMORY_VOLATILE_TTL
: 
s
 = "volatile-ttl"; ;

1126 
REDIS_MAXMEMORY_VOLATILE_RANDOM
: 
s
 = "volatile-random"; ;

1127 
REDIS_MAXMEMORY_ALLKEYS_LRU
: 
s
 = "allkeys-lru"; ;

1128 
REDIS_MAXMEMORY_ALLKEYS_RANDOM
: 
s
 = "allkeys-random"; ;

1129 
REDIS_MAXMEMORY_NO_EVICTION
: 
s
 = "noeviction"; ;

1130 : 
s
 = "unknown"; ;

1132 
	`addR•lyBulkCSŒšg
(
c
,"maxmemory-policy");

1133 
	`addR•lyBulkCSŒšg
(
c
,
s
);

1134 
m©ches
++;

1136 ià(
	`¡ršgm©ch
(
·‰”n
,"appendfsync",0)) {

1137 *
pŞicy
;

1139 
£rv”
.
aof_fsync
) {

1140 
AOF_FSYNC_NO
: 
pŞicy
 = "no"; ;

1141 
AOF_FSYNC_EVERYSEC
: 
pŞicy
 = "everysec"; ;

1142 
AOF_FSYNC_ALWAYS
: 
pŞicy
 = "always"; ;

1143 : 
pŞicy
 = "unknown"; ;

1145 
	`addR•lyBulkCSŒšg
(
c
,"appendfsync");

1146 
	`addR•lyBulkCSŒšg
(
c
,
pŞicy
);

1147 
m©ches
++;

1149 ià(
	`¡ršgm©ch
(
·‰”n
,"save",0)) {

1150 
sds
 
buf
 = 
	`sd£m±y
();

1151 
j
;

1153 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1154 
buf
 = 
	`sdsÿrštf
(buf,"%jd %d",

1155 (
štmax_t
)
£rv”
.
§v•¬ams
[
j
].
£cÚds
,

1156 
£rv”
.
§v•¬ams
[
j
].
chªges
);

1157 ià(
j
 !ğ
£rv”
.
§v•¬am¦’
-1)

1158 
buf
 = 
	`sdsÿ’
(buf," ",1);

1160 
	`addR•lyBulkCSŒšg
(
c
,"save");

1161 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1162 
	`sdsä“
(
buf
);

1163 
m©ches
++;

1165 ià(
	`¡ršgm©ch
(
·‰”n
,"loglevel",0)) {

1166 *
s
;

1168 
£rv”
.
v”bos™y
) {

1169 
REDIS_WARNING
: 
s
 = "warning"; ;

1170 
REDIS_VERBOSE
: 
s
 = "verbose"; ;

1171 
REDIS_NOTICE
: 
s
 = "notice"; ;

1172 
REDIS_DEBUG
: 
s
 = "debug"; ;

1173 : 
s
 = "unknown"; ;

1175 
	`addR•lyBulkCSŒšg
(
c
,"loglevel");

1176 
	`addR•lyBulkCSŒšg
(
c
,
s
);

1177 
m©ches
++;

1179 ià(
	`¡ršgm©ch
(
·‰”n
,"client-output-buffer-limit",0)) {

1180 
sds
 
buf
 = 
	`sd£m±y
();

1181 
j
;

1183 
j
 = 0; j < 
REDIS_CLIENT_TYPE_COUNT
; j++) {

1184 
buf
 = 
	`sdsÿrštf
(buf,"%s %llu %llu %ld",

1185 
	`g‘Cl›ÁTy³Name
(
j
),

1186 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
,

1187 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
,

1188 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1189 ià(
j
 !ğ
REDIS_CLIENT_TYPE_COUNT
-1)

1190 
buf
 = 
	`sdsÿ’
(buf," ",1);

1192 
	`addR•lyBulkCSŒšg
(
c
,"client-output-buffer-limit");

1193 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1194 
	`sdsä“
(
buf
);

1195 
m©ches
++;

1197 ià(
	`¡ršgm©ch
(
·‰”n
,"unixsocketperm",0)) {

1198 
buf
[32];

1199 
	`¢´štf
(
buf
,(buf),"%o",
£rv”
.
unixsock‘³rm
);

1200 
	`addR•lyBulkCSŒšg
(
c
,"unixsocketperm");

1201 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1202 
m©ches
++;

1204 ià(
	`¡ršgm©ch
(
·‰”n
,"slaveof",0)) {

1205 
buf
[256];

1207 
	`addR•lyBulkCSŒšg
(
c
,"slaveof");

1208 ià(
£rv”
.
ma¡”ho¡
)

1209 
	`¢´štf
(
buf
,(buf),"%s %d",

1210 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1212 
buf
[0] = '\0';

1213 
	`addR•lyBulkCSŒšg
(
c
,
buf
);

1214 
m©ches
++;

1216 ià(
	`¡ršgm©ch
(
·‰”n
,"notify-keyspace-events",0)) {

1217 
robj
 *
æagsobj
 = 
	`ü—‹Objeù
(
REDIS_STRING
,

1218 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
));

1220 
	`addR•lyBulkCSŒšg
(
c
,"notify-keyspace-events");

1221 
	`addR•lyBulk
(
c
,
æagsobj
);

1222 
	`deüRefCouÁ
(
æagsobj
);

1223 
m©ches
++;

1225 ià(
	`¡ršgm©ch
(
·‰”n
,"bind",0)) {

1226 
sds
 
aux
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1228 
	`addR•lyBulkCSŒšg
(
c
,"bind");

1229 
	`addR•lyBulkCSŒšg
(
c
,
aux
);

1230 
	`sdsä“
(
aux
);

1231 
m©ches
++;

1233 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
m©ches
*2);

1234 
	}
}

1240 
	#REDIS_CONFIG_REWRITE_SIGNATURE
 "# G’”©ed by CONFIG REWRITE"

	)

1245 
diùSdsCa£Hash
(cÚ¡ *
key
);

1246 
diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

1247 
diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
);

1248 
diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
);

1252 
»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
);

1254 
diùTy³
 
	gİtiÚToLšeDiùTy³
 = {

1255 
diùSdsCa£Hash
,

1256 
NULL
,

1257 
NULL
,

1258 
diùSdsKeyCa£Com·»
,

1259 
diùSdsDe¡ruùÜ
,

1260 
diùLi¡De¡ruùÜ


1263 
diùTy³
 
	gİtiÚS‘DiùTy³
 = {

1264 
diùSdsCa£Hash
,

1265 
NULL
,

1266 
NULL
,

1267 
diùSdsKeyCa£Com·»
,

1268 
diùSdsDe¡ruùÜ
,

1269 
NULL


1273 
	s»wr™eCÚfigS‹
 {

1274 
diù
 *
	mİtiÚ_to_lše
;

1275 
diù
 *
	m»wr™‹n
;

1276 
	mnumlšes
;

1277 
sds
 *
	mlšes
;

1278 
	mhas_
;

1283 
	$»wr™eCÚfigAµ’dLše
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
lše
) {

1284 
¡©e
->
lšes
 = 
	`z»®loc
(¡©e->lšes, (*è* (¡©e->
numlšes
+1));

1285 
¡©e
->
lšes
[¡©e->
numlšes
++] = 
lše
;

1286 
	}
}

1289 
	$»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, 
sds
 
İtiÚ
, 
lš’um
) {

1290 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
İtiÚ
);

1292 ià(
l
 =ğ
NULL
) {

1293 
l
 = 
	`li¡C»©e
();

1294 
	`diùAdd
(
¡©e
->
İtiÚ_to_lše
,
	`sdsdup
(
İtiÚ
),
l
);

1296 
	`li¡AddNodeTa
(
l
,(*)()
lš’um
);

1297 
	}
}

1303 
	$»wr™eCÚfigM¬kAsProûs£d
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
) {

1304 
sds
 
İt
 = 
	`sd¢ew
(
İtiÚ
);

1306 ià(
	`diùAdd
(
¡©e
->
»wr™‹n
,
İt
,
NULL
è!ğ
DICT_OK
è
	`sdsä“
(opt);

1307 
	}
}

1314 
»wr™eCÚfigS‹
 *
	$»wr™eCÚfigR—dOldFe
(*
·th
) {

1315 
FILE
 *
å
 = 
	`fİ’
(
·th
,"r");

1316 
»wr™eCÚfigS‹
 *
¡©e
 = 
	`zm®loc
((*state));

1317 
buf
[
REDIS_CONFIGLINE_MAX
+1];

1318 
lš’um
 = -1;

1320 ià(
å
 =ğ
NULL
 && 
”ºo
 !ğ
ENOENT
)  NULL;

1322 
¡©e
->
İtiÚ_to_lše
 = 
	`diùC»©e
(&
İtiÚToLšeDiùTy³
,
NULL
);

1323 
¡©e
->
»wr™‹n
 = 
	`diùC»©e
(&
İtiÚS‘DiùTy³
,
NULL
);

1324 
¡©e
->
numlšes
 = 0;

1325 
¡©e
->
lšes
 = 
NULL
;

1326 
¡©e
->
has_
 = 0;

1327 ià(
å
 =ğ
NULL
è 
¡©e
;

1330 
	`fg‘s
(
buf
,
REDIS_CONFIGLINE_MAX
+1,
å
è!ğ
NULL
) {

1331 
¬gc
;

1332 
sds
 *
¬gv
;

1333 
sds
 
lše
 = 
	`sd¡rim
(
	`sd¢ew
(
buf
),"\r\n\t ");

1335 
lš’um
++;

1338 ià(
lše
[0] == '#' ||†ine[0] == '\0') {

1339 ià(!
¡©e
->
has_
 && !
	`¡rcmp
(
lše
,
REDIS_CONFIG_REWRITE_SIGNATURE
))

1340 
¡©e
->
has_
 = 1;

1341 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1346 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

1347 ià(
¬gv
 =ğ
NULL
) {

1351 
sds
 
aux
 = 
	`sd¢ew
("# ??? ");

1352 
aux
 = 
	`sdsÿtsds
×ux,
lše
);

1353 
	`sdsä“
(
lše
);

1354 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
aux
);

1358 
	`sd¡Şow”
(
¬gv
[0]);

1362 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1363 
	`»wr™eCÚfigAddLšeNumb”ToO±iÚ
(
¡©e
,
¬gv
[0],
lš’um
);

1365 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1367 
	`fşo£
(
å
);

1368  
¡©e
;

1369 
	}
}

1387 
	$»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
sds
 
lše
, 
fÜû
) {

1388 
sds
 
o
 = 
	`sd¢ew
(
İtiÚ
);

1389 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
¡©e
->
İtiÚ_to_lše
,
o
);

1391 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1393 ià(!
l
 && !
fÜû
) {

1395 
	`sdsä“
(
lše
);

1396 
	`sdsä“
(
o
);

1400 ià(
l
) {

1401 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1402 
lš’um
 = (è
Ê
->
v®ue
;

1406 
	`li¡D–Node
(
l
,
Ê
);

1407 ià(
	`li¡L’gth
(
l
è=ğ0è
	`diùD–‘e
(
¡©e
->
İtiÚ_to_lše
,
o
);

1408 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1409 
¡©e
->
lšes
[
lš’um
] = 
lše
;

1412 ià(!
¡©e
->
has_
) {

1413 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,

1414 
	`sd¢ew
(
REDIS_CONFIG_REWRITE_SIGNATURE
));

1415 
¡©e
->
has_
 = 1;

1417 
	`»wr™eCÚfigAµ’dLše
(
¡©e
,
lše
);

1419 
	`sdsä“
(
o
);

1420 
	}
}

1424 
	$»wr™eCÚfigFÜm©MemÜy
(*
buf
, 
size_t
 
Ën
, 
by‹s
) {

1425 
gb
 = 1024*1024*1024;

1426 
mb
 = 1024*1024;

1427 
kb
 = 1024;

1429 ià(
by‹s
 && (by‹ % 
gb
) == 0) {

1430  
	`¢´štf
(
buf
,
Ën
,"%Îdgb",
by‹s
/
gb
);

1431 } ià(
by‹s
 && (by‹ % 
mb
) == 0) {

1432  
	`¢´štf
(
buf
,
Ën
,"%Îdmb",
by‹s
/
mb
);

1433 } ià(
by‹s
 && (by‹ % 
kb
) == 0) {

1434  
	`¢´štf
(
buf
,
Ën
,"%Îdkb",
by‹s
/
kb
);

1436  
	`¢´štf
(
buf
,
Ën
,"%Îd",
by‹s
);

1438 
	}
}

1441 
	$»wr™eCÚfigBy‹sO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1442 
buf
[64];

1443 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1444 
sds
 
lše
;

1446 
	`»wr™eCÚfigFÜm©MemÜy
(
buf
,(buf),
v®ue
);

1447 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
buf
);

1448 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1449 
	}
}

1452 
	$»wr™eCÚfigYesNoO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1453 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1454 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,

1455 
v®ue
 ? "yes" : "no");

1457 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1458 
	}
}

1461 
	$»wr™eCÚfigSŒšgO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, *
v®ue
, *
defv®ue
) {

1462 
fÜû
 = 1;

1463 
sds
 
lše
;

1467 ià(
v®ue
 =ğ
NULL
) {

1468 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1473 ià(
defv®ue
 && 
	`¡rcmp
(
v®ue
,defv®ueè=ğ0è
fÜû
 = 0;

1475 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1476 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1477 
lše
 = 
	`sdsÿŒ•r
Öše, 
v®ue
, 
	`¡¾’
(value));

1479 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1480 
	}
}

1483 
	$»wr™eCÚfigNum”iÿlO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1484 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1485 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %Îd",
İtiÚ
,
v®ue
);

1487 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1488 
	}
}

1491 
	$»wr™eCÚfigOù®O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, 
defv®ue
) {

1492 
fÜû
 = 
v®ue
 !ğ
defv®ue
;

1493 
sds
 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %o",
İtiÚ
,
v®ue
);

1495 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1496 
	}
}

1501 
	$»wr™eCÚfigEnumO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
v®ue
, ...) {

1502 
va_li¡
 
­
;

1503 *
’um_Çme
, *
m©chšg_Çme
 = 
NULL
;

1504 
’um_v®
, 
def_v®
, 
fÜû
;

1505 
sds
 
lše
;

1507 
	`va_¡¬t
(
­
, 
v®ue
);

1509 
’um_Çme
 = 
	`va_¬g
(
­
,*);

1510 
’um_v®
 = 
	`va_¬g
(
­
,);

1511 ià(
’um_Çme
 =ğ
NULL
) {

1512 
def_v®
 = 
’um_v®
;

1515 ià(
v®ue
 =ğ
’um_v®
è
m©chšg_Çme
 = 
’um_Çme
;

1517 
	`va_’d
(
­
);

1519 
fÜû
 = 
v®ue
 !ğ
def_v®
;

1520 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
m©chšg_Çme
);

1521 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1522 
	}
}

1525 
	$»wr™eCÚfigSy¦ogçc™yO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1526 
v®ue
 = 
£rv”
.
sy¦og_çc™y
, 
j
;

1527 
fÜû
 = 
v®ue
 !ğ
LOG_LOCAL0
;

1528 *
Çme
 = 
NULL
, *
İtiÚ
 = "syslog-facility";

1529 
sds
 
lše
;

1531 
j
 = 0; 
v®idSy¦ogFac™›s
[j].
Çme
; j++) {

1532 ià(
v®idSy¦ogFac™›s
[
j
].
v®ue
 == value) {

1533 
Çme
 = (*è
v®idSy¦ogFac™›s
[
j
].name;

1537 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% %s",
İtiÚ
,
Çme
);

1538 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1539 
	}
}

1542 
	$»wr™eCÚfigSaveO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1543 
j
;

1544 
sds
 
lše
;

1549 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1550 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"save %ld %d",

1551 (è
£rv”
.
§v•¬ams
[
j
].
£cÚds
, s”v”.§v•¬ams[j].
chªges
);

1552 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"§ve",
lše
,1);

1555 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"save");

1556 
	}
}

1559 
	$»wr™eCÚfigDœO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1560 
cwd
[1024];

1562 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

1563 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"dir");

1566 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dœ",
cwd
,
NULL
);

1567 
	}
}

1570 
	$»wr™eCÚfigSÏveofO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1571 *
İtiÚ
 = "slaveof";

1572 
sds
 
lše
;

1577 ià(
£rv”
.
şu¡”_’abËd
 || s”v”.
ma¡”ho¡
 =ğ
NULL
) {

1578 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,"slaveof");

1581 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"% % %d", 
İtiÚ
,

1582 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1583 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,1);

1584 
	}
}

1587 
	$»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1588 
fÜû
 = 
£rv”
.
nÙify_key¥aû_ev’ts
 != 0;

1589 *
İtiÚ
 = "notify-keyspace-events";

1590 
sds
 
lše
, 
æags
;

1592 
æags
 = 
	`key¥aûEv’tsFÏgsToSŒšg
(
£rv”
.
nÙify_key¥aû_ev’ts
);

1593 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1594 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1595 
lše
 = 
	`sdsÿŒ•r
Öše, 
æags
, 
	`sd¦’
(flags));

1596 
	`sdsä“
(
æags
);

1597 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1598 
	}
}

1601 
	$»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1602 
j
;

1603 *
İtiÚ
 = "client-output-buffer-limit";

1605 
j
 = 0; j < 
REDIS_CLIENT_TYPE_COUNT
; j++) {

1606 
fÜû
 = (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
 !=

1607 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
h¬d_lim™_by‹s
) ||

1608 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
 !=

1609 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_by‹s
) ||

1610 (
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
 !=

1611 
ş›ÁBufãrLim™sDeçuÉs
[
j
].
soá_lim™_£cÚds
);

1612 
sds
 
lše
;

1613 
h¬d
[64], 
soá
[64];

1615 
	`»wr™eCÚfigFÜm©MemÜy
(
h¬d
,(hard),

1616 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
h¬d_lim™_by‹s
);

1617 
	`»wr™eCÚfigFÜm©MemÜy
(
soá
,(soft),

1618 
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_by‹s
);

1620 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%s %s %s %s %ld",

1621 
İtiÚ
, 
	`g‘Cl›ÁTy³Name
(
j
), 
h¬d
, 
soá
,

1622 (è
£rv”
.
ş›Á_obuf_lim™s
[
j
].
soá_lim™_£cÚds
);

1623 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1625 
	}
}

1628 
	$»wr™eCÚfigBšdO±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1629 
fÜû
 = 1;

1630 
sds
 
lše
, 
add»s£s
;

1631 *
İtiÚ
 = "bind";

1634 ià(
£rv”
.
bšdaddr_couÁ
 == 0) {

1635 
	`»wr™eCÚfigM¬kAsProûs£d
(
¡©e
,
İtiÚ
);

1640 
add»s£s
 = 
	`sdsjoš
(
£rv”
.
bšdaddr
,£rv”.
bšdaddr_couÁ
," ");

1641 
lše
 = 
	`sd¢ew
(
İtiÚ
);

1642 
lše
 = 
	`sdsÿ’
(line, " ", 1);

1643 
lše
 = 
	`sdsÿtsds
Öše, 
add»s£s
);

1644 
	`sdsä“
(
add»s£s
);

1646 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,
İtiÚ
,
lše
,
fÜû
);

1647 
	}
}

1651 
sds
 
	$»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1652 
sds
 
cÚ‹Á
 = 
	`sd£m±y
();

1653 
j
, 
was_em±y
 = 0;

1655 
j
 = 0; j < 
¡©e
->
numlšes
; j++) {

1657 ià(
	`sd¦’
(
¡©e
->
lšes
[
j
]) == 0) {

1658 ià(
was_em±y
) ;

1659 
was_em±y
 = 1;

1661 
was_em±y
 = 0;

1663 
cÚ‹Á
 = 
	`sdsÿtsds
(cÚ‹Á,
¡©e
->
lšes
[
j
]);

1664 
cÚ‹Á
 = 
	`sdsÿ’
(content,"\n",1);

1666  
cÚ‹Á
;

1667 
	}
}

1670 
	$»wr™eCÚfigR–—£S‹
(
»wr™eCÚfigS‹
 *
¡©e
) {

1671 
	`sdsä“¥l™»s
(
¡©e
->
lšes
,¡©e->
numlšes
);

1672 
	`diùR–—£
(
¡©e
->
İtiÚ_to_lše
);

1673 
	`diùR–—£
(
¡©e
->
»wr™‹n
);

1674 
	`zä“
(
¡©e
);

1675 
	}
}

1685 
	$»wr™eCÚfigRemoveO½hªed
(
»wr™eCÚfigS‹
 *
¡©e
) {

1686 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
¡©e
->
İtiÚ_to_lše
);

1687 
diùEÁry
 *
de
;

1689 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1690 
li¡
 *
l
 = 
	`diùG‘V®
(
de
);

1691 
sds
 
İtiÚ
 = 
	`diùG‘Key
(
de
);

1695 ià(
	`diùFšd
(
¡©e
->
»wr™‹n
,
İtiÚ
è=ğ
NULL
) {

1696 
	`»disLog
(
REDIS_DEBUG
,"NÙ„ewr™‹ÀİtiÚ: %s", 
İtiÚ
);

1700 
	`li¡L’gth
(
l
)) {

1701 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

1702 
lš’um
 = (è
Ê
->
v®ue
;

1704 
	`sdsä“
(
¡©e
->
lšes
[
lš’um
]);

1705 
¡©e
->
lšes
[
lš’um
] = 
	`sd£m±y
();

1706 
	`li¡D–Node
(
l
,
Ê
);

1709 
	`diùR–—£I‹¿tÜ
(
di
);

1710 
	}
}

1724 
	$»wr™eCÚfigOv”wr™eFe
(*
cÚfigfe
, 
sds
 
cÚ‹Á
) {

1725 
»tv®
 = 0;

1726 
fd
 = 
	`İ’
(
cÚfigfe
,
O_RDWR
|
O_CREAT
,0644);

1727 
cÚ‹Á_size
 = 
	`sd¦’
(
cÚ‹Á
), 
·ddšg
 = 0;

1728 
¡©
 
sb
;

1729 
sds
 
cÚ‹Á_·dded
;

1733 ià(
fd
 == -1)  -1;

1734 ià(
	`f¡©
(
fd
,&
sb
) == -1) {

1735 
	`şo£
(
fd
);

1740 
cÚ‹Á_·dded
 = 
	`sdsdup
(
cÚ‹Á
);

1741 ià(
cÚ‹Á_size
 < 
sb
.
¡_size
) {

1744 
·ddšg
 = 
sb
.
¡_size
 - 
cÚ‹Á_size
;

1745 
cÚ‹Á_·dded
 = 
	`sdsgrowz”o
(cÚ‹Á_·dded,
sb
.
¡_size
);

1746 
cÚ‹Á_·dded
[
cÚ‹Á_size
] = '\n';

1747 
	`mem£t
(
cÚ‹Á_·dded
+
cÚ‹Á_size
+1,'#',
·ddšg
-1);

1751 ià(
	`wr™e
(
fd
,
cÚ‹Á_·dded
,
	`¡¾’
(content_padded)) == -1) {

1752 
»tv®
 = -1;

1753 
ş—nup
;

1757 ià(
·ddšg
) {

1758 ià(
	`árunÿ‹
(
fd
,
cÚ‹Á_size
) == -1) {

1763 
ş—nup
:

1764 
	`sdsä“
(
cÚ‹Á_·dded
);

1765 
	`şo£
(
fd
);

1766  
»tv®
;

1767 
	}
}

1777 
	$»wr™eCÚfig
(*
·th
) {

1778 
»wr™eCÚfigS‹
 *
¡©e
;

1779 
sds
 
ÃwcÚ‹Á
;

1780 
»tv®
;

1783 ià((
¡©e
 = 
	`»wr™eCÚfigR—dOldFe
(
·th
)è=ğ
NULL
)  -1;

1788 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"d«mÚize",
£rv”
.
d«mÚize
,0);

1789 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"pidfe",
£rv”
.
pidfe
,
REDIS_DEFAULT_PID_FILE
);

1790 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"pÜt",
£rv”
.
pÜt
,
REDIS_SERVERPORT
);

1791 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-backlog",
£rv”
.
tı_backlog
,
REDIS_TCP_BACKLOG
);

1792 
	`»wr™eCÚfigBšdO±iÚ
(
¡©e
);

1793 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"unixsock‘",
£rv”
.
unixsock‘
,
NULL
);

1794 
	`»wr™eCÚfigOù®O±iÚ
(
¡©e
,"unixsock‘³rm",
£rv”
.
unixsock‘³rm
,
REDIS_DEFAULT_UNIX_SOCKET_PERM
);

1795 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"timeout",
£rv”
.
maxidËtime
,
REDIS_MAXIDLETIME
);

1796 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"tı-k“·live",
£rv”
.
tık“·live
,
REDIS_DEFAULT_TCP_KEEPALIVE
);

1797 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"logËv–",
£rv”
.
v”bos™y
,

1798 "debug", 
REDIS_DEBUG
,

1799 "v”bo£", 
REDIS_VERBOSE
,

1800 "nÙiû", 
REDIS_NOTICE
,

1801 "w¬nšg", 
REDIS_WARNING
,

1802 
NULL
, 
REDIS_DEFAULT_VERBOSITY
);

1803 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"logfe",
£rv”
.
logfe
,
REDIS_DEFAULT_LOGFILE
);

1804 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"sy¦og-’abËd",
£rv”
.
sy¦og_’abËd
,
REDIS_DEFAULT_SYSLOG_ENABLED
);

1805 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"sy¦og-id’t",
£rv”
.
sy¦og_id’t
,
REDIS_DEFAULT_SYSLOG_IDENT
);

1806 
	`»wr™eCÚfigSy¦ogçc™yO±iÚ
(
¡©e
);

1807 
	`»wr™eCÚfigSaveO±iÚ
(
¡©e
);

1808 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"d©aba£s",
£rv”
.
dbnum
,
REDIS_DEFAULT_DBNUM
);

1809 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¡İ-wr™es-Ú-bg§ve-”rÜ",
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
,
REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
);

1810 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbcom´essiÚ",
£rv”
.
rdb_com´essiÚ
,
REDIS_DEFAULT_RDB_COMPRESSION
);

1811 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"rdbchecksum",
£rv”
.
rdb_checksum
,
REDIS_DEFAULT_RDB_CHECKSUM
);

1812 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"dbf’ame",
£rv”
.
rdb_f’ame
,
REDIS_DEFAULT_RDB_FILENAME
);

1813 
	`»wr™eCÚfigDœO±iÚ
(
¡©e
);

1814 
	`»wr™eCÚfigSÏveofO±iÚ
(
¡©e
);

1815 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"ma¡”auth",
£rv”
.
ma¡”auth
,
NULL
);

1816 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-£rve-¡®e-d©a",
£rv”
.
»¶_£rve_¡®e_d©a
,
REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA
);

1817 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"¦ave-»ad-Úly",
£rv”
.
»¶_¦ave_ro
,
REDIS_DEFAULT_SLAVE_READ_ONLY
);

1818 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-pšg-¦ave-³riod",
£rv”
.
»¶_pšg_¦ave_³riod
,
REDIS_REPL_PING_SLAVE_PERIOD
);

1819 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-timeout",
£rv”
.
»¶_timeout
,
REDIS_REPL_TIMEOUT
);

1820 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-size",
£rv”
.
»¶_backlog_size
,
REDIS_DEFAULT_REPL_BACKLOG_SIZE
);

1821 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"»¶-backlog-‰l",
£rv”
.
»¶_backlog_time_lim™
,
REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT
);

1822 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-di§bË-tı-nod–ay",
£rv”
.
»¶_di§bË_tı_nod–ay
,
REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY
);

1823 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"»¶-diskËss-sync",
£rv”
.
»¶_diskËss_sync
,
REDIS_DEFAULT_REPL_DISKLESS_SYNC
);

1824 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"»¶-diskËss-sync-d–ay",
£rv”
.
»¶_diskËss_sync_d–ay
,
REDIS_DEFAULT_REPL_DISKLESS_SYNC_DELAY
);

1825 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦ave-´iÜ™y",
£rv”
.
¦ave_´iÜ™y
,
REDIS_DEFAULT_SLAVE_PRIORITY
);

1826 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-to-wr™e",
£rv”
.
»¶_mš_¦aves_to_wr™e
,
REDIS_DEFAULT_MIN_SLAVES_TO_WRITE
);

1827 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"mš-¦aves-max-Ïg",
£rv”
.
»¶_mš_¦aves_max_Ïg
,
REDIS_DEFAULT_MIN_SLAVES_MAX_LAG
);

1828 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"»quœ•ass",
£rv”
.
»quœ•ass
,
NULL
);

1829 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxş›Ás",
£rv”
.
maxş›Ás
,
REDIS_MAX_CLIENTS
);

1830 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"maxmemÜy",
£rv”
.
maxmemÜy
,
REDIS_DEFAULT_MAXMEMORY
);

1831 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"maxmemÜy-pŞicy",
£rv”
.
maxmemÜy_pŞicy
,

1832 "vŞ©e-Ìu", 
REDIS_MAXMEMORY_VOLATILE_LRU
,

1833 "®lkeys-Ìu", 
REDIS_MAXMEMORY_ALLKEYS_LRU
,

1834 "vŞ©e-¿ndom", 
REDIS_MAXMEMORY_VOLATILE_RANDOM
,

1835 "®lkeys-¿ndom", 
REDIS_MAXMEMORY_ALLKEYS_RANDOM
,

1836 "vŞ©e-‰l", 
REDIS_MAXMEMORY_VOLATILE_TTL
,

1837 "nÛviùiÚ", 
REDIS_MAXMEMORY_NO_EVICTION
,

1838 
NULL
, 
REDIS_DEFAULT_MAXMEMORY_POLICY
);

1839 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"maxmemÜy-§m¶es",
£rv”
.
maxmemÜy_§m¶es
,
REDIS_DEFAULT_MAXMEMORY_SAMPLES
);

1840 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"­³ndÚly",
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
,0);

1841 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"­³ndf’ame",
£rv”
.
aof_f’ame
,
REDIS_DEFAULT_AOF_FILENAME
);

1842 
	`»wr™eCÚfigEnumO±iÚ
(
¡©e
,"­³ndfsync",
£rv”
.
aof_fsync
,

1843 "ev”y£c", 
AOF_FSYNC_EVERYSEC
,

1844 "®ways", 
AOF_FSYNC_ALWAYS
,

1845 "no", 
AOF_FSYNC_NO
,

1846 
NULL
, 
REDIS_DEFAULT_AOF_FSYNC
);

1847 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"no-­³ndfsync-Ú-»wr™e",
£rv”
.
aof_no_fsync_Ú_»wr™e
,
REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
);

1848 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"auto-aof-»wr™e-³rûÁage",
£rv”
.
aof_»wr™e_³rc
,
REDIS_AOF_REWRITE_PERC
);

1849 
	`»wr™eCÚfigBy‹sO±iÚ
(
¡©e
,"auto-aof-»wr™e-mš-size",
£rv”
.
aof_»wr™e_mš_size
,
REDIS_AOF_REWRITE_MIN_SIZE
);

1850 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"lua-time-lim™",
£rv”
.
lua_time_lim™
,
REDIS_LUA_TIME_LIMIT
);

1851 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-’abËd",
£rv”
.
şu¡”_’abËd
,0);

1852 
	`»wr™eCÚfigSŒšgO±iÚ
(
¡©e
,"şu¡”-cÚfig-fe",
£rv”
.
şu¡”_cÚfigfe
,
REDIS_DEFAULT_CLUSTER_CONFIG_FILE
);

1853 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"şu¡”-»quœe-fuÎ-cov”age",
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
,
REDIS_CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
);

1854 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-node-timeout",
£rv”
.
şu¡”_node_timeout
,
REDIS_CLUSTER_DEFAULT_NODE_TIMEOUT
);

1855 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-mig¿tiÚ-b¬r›r",
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
,
REDIS_CLUSTER_DEFAULT_MIGRATION_BARRIER
);

1856 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"şu¡”-¦ave-v®id™y-çùÜ",
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
,
REDIS_CLUSTER_DEFAULT_SLAVE_VALIDITY
);

1857 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-log-¦ow”-thª",
£rv”
.
¦owlog_log_¦ow”_thª
,
REDIS_SLOWLOG_LOG_SLOWER_THAN
);

1858 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"Ï‹ncy-mÚ™Ü-th»shŞd",
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
,
REDIS_DEFAULT_LATENCY_MONITOR_THRESHOLD
);

1859 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"¦owlog-max-Ën",
£rv”
.
¦owlog_max_Ën
,
REDIS_SLOWLOG_MAX_LEN
);

1860 
	`»wr™eCÚfigNÙifykey¥aûev’tsO±iÚ
(
¡©e
);

1861 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-’Œ›s",
£rv”
.
hash_max_zli¡_’Œ›s
,
REDIS_HASH_MAX_ZIPLIST_ENTRIES
);

1862 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hash-max-zli¡-v®ue",
£rv”
.
hash_max_zli¡_v®ue
,
REDIS_HASH_MAX_ZIPLIST_VALUE
);

1863 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-max-zli¡-’Œ›s",
£rv”
.
li¡_max_zli¡_’Œ›s
,
REDIS_LIST_MAX_ZIPLIST_ENTRIES
);

1864 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"li¡-max-zli¡-v®ue",
£rv”
.
li¡_max_zli¡_v®ue
,
REDIS_LIST_MAX_ZIPLIST_VALUE
);

1865 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"£t-max-št£t-’Œ›s",
£rv”
.
£t_max_št£t_’Œ›s
,
REDIS_SET_MAX_INTSET_ENTRIES
);

1866 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-’Œ›s",
£rv”
.
z£t_max_zli¡_’Œ›s
,
REDIS_ZSET_MAX_ZIPLIST_ENTRIES
);

1867 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"z£t-max-zli¡-v®ue",
£rv”
.
z£t_max_zli¡_v®ue
,
REDIS_ZSET_MAX_ZIPLIST_VALUE
);

1868 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hÎ-¥¬£-max-by‹s",
£rv”
.
hÎ_¥¬£_max_by‹s
,
REDIS_DEFAULT_HLL_SPARSE_MAX_BYTES
);

1869 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aùiv”ehashšg",
£rv”
.
aùiv”ehashšg
,
REDIS_DEFAULT_ACTIVE_REHASHING
);

1870 
	`»wr™eCÚfigCl›Áouutbufã¾im™O±iÚ
(
¡©e
);

1871 
	`»wr™eCÚfigNum”iÿlO±iÚ
(
¡©e
,"hz",
£rv”
.
hz
,
REDIS_DEFAULT_HZ
);

1872 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-»wr™e-šüem’l-fsync",
£rv”
.
aof_»wr™e_šüem’l_fsync
,
REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
);

1873 
	`»wr™eCÚfigYesNoO±iÚ
(
¡©e
,"aof-lßd-Œunÿ‹d",
£rv”
.
aof_lßd_Œunÿ‹d
,
REDIS_DEFAULT_AOF_LOAD_TRUNCATED
);

1874 ià(
£rv”
.
£Áš–_mode
è
	`»wr™eCÚfigS’tš–O±iÚ
(
¡©e
);

1879 
	`»wr™eCÚfigRemoveO½hªed
(
¡©e
);

1883 
ÃwcÚ‹Á
 = 
	`»wr™eCÚfigG‘CÚ‹ÁFromS‹
(
¡©e
);

1884 
»tv®
 = 
	`»wr™eCÚfigOv”wr™eFe
(
£rv”
.
cÚfigfe
,
ÃwcÚ‹Á
);

1886 
	`sdsä“
(
ÃwcÚ‹Á
);

1887 
	`»wr™eCÚfigR–—£S‹
(
¡©e
);

1888  
»tv®
;

1889 
	}
}

1895 
	$cÚfigCommªd
(
»disCl›Á
 *
c
) {

1896 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

1897 ià(
c
->
¬gc
 !ğ4è
bad¬™y
;

1898 
	`cÚfigS‘Commªd
(
c
);

1899 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get")) {

1900 ià(
c
->
¬gc
 !ğ3è
bad¬™y
;

1901 
	`cÚfigG‘Commªd
(
c
);

1902 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"resetstat")) {

1903 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

1904 
	`»£tS”v”Sts
();

1905 
	`»£tCommªdTabËSts
();

1906 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1907 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"rewrite")) {

1908 ià(
c
->
¬gc
 !ğ2è
bad¬™y
;

1909 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

1910 
	`addR•lyE¼Ü
(
c
,"The server is„unning without‡ config file");

1913 ià(
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
) == -1) {

1914 
	`»disLog
(
REDIS_WARNING
,"CONFIG REWRITE faed: %s", 
	`¡»¼Ü
(
”ºo
));

1915 
	`addR•lyE¼ÜFÜm©
(
c
,"Rewr™šg cÚfig fe: %s", 
	`¡»¼Ü
(
”ºo
));

1917 
	`»disLog
(
REDIS_WARNING
,"CONFIG REWRITEƒxecuted with success.");

1918 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1921 
	`addR•lyE¼Ü
(
c
,

1926 
bad¬™y
:

1927 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for CONFIG %s",

1928 (*è
c
->
¬gv
[1]->
±r
);

1929 
	}
}

	@config.h

30 #iâdeà
__CONFIG_H


31 
	#__CONFIG_H


	)

33 #ifdeà
__APPLE__


34 
	~<Avaab™yMaüos.h
>

37 #ifdeà
__lšux__


38 
	~<lšux/v”siÚ.h
>

39 
	~<ã©u»s.h
>

43 #ià
defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

44 
	#»dis_f¡©
 
f¡©64


	)

45 
	#»dis_¡©
 
¡©64


	)

47 
	#»dis_f¡©
 
f¡©


	)

48 
	#»dis_¡©
 
¡©


	)

52 #ifdeà
__lšux__


53 
	#HAVE_PROC_STAT
 1

	)

54 
	#HAVE_PROC_MAPS
 1

	)

55 
	#HAVE_PROC_SMAPS
 1

	)

56 
	#HAVE_PROC_SOMAXCONN
 1

	)

60 #ià
defšed
(
__APPLE__
)

61 
	#HAVE_TASKINFO
 1

	)

65 #ià
defšed
(
__APPLE__
è|| (defšed(
__lšux__
è&& defšed(
__GLIBC__
))

66 
	#HAVE_BACKTRACE
 1

	)

70 #ifdeà
__lšux__


71 
	#HAVE_EPOLL
 1

	)

74 #ià(
defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD__
è|| defšed (
__N‘BSD__
)

75 
	#HAVE_KQUEUE
 1

	)

78 #ifdeà
__sun


79 
	~<sys/ã©u»_‹¡s.h
>

80 #ifdeà
_DTRACE_VERSION


81 
	#HAVE_EVPORT
 1

	)

86 #ifdeà
__lšux__


87 
	#aof_fsync
 
fd©async


	)

89 
	#aof_fsync
 
fsync


	)

94 #ifdeà
__lšux__


95 #ià
defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
)

96 #ià(
LINUX_VERSION_CODE
 >ğ0x020611 && 
__GLIBC_PREREQ
(2, 6))

97 
	#HAVE_SYNC_FILE_RANGE
 1

	)

100 #ià(
LINUX_VERSION_CODE
 >= 0x020611)

101 
	#HAVE_SYNC_FILE_RANGE
 1

	)

106 #ifdeà
HAVE_SYNC_FILE_RANGE


107 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`sync_fe_¿nge
(fd,off,size,
SYNC_FILE_RANGE_WAIT_BEFORE
|
SYNC_FILE_RANGE_WRITE
)

	)

109 
	#rdb_fsync_¿nge
(
fd
,
off
,
size
è
	`fsync
(fd)

	)

115 #ià(
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

116 
	#USE_SETPROCTITLE


	)

119 #ià((
defšed
 
__lšux
 && defšed(
__GLIBC__
)è|| defšed 
__APPLE__
)

120 
	#USE_SETPROCTITLE


	)

121 
	#INIT_SETPROCTITLE_REPLACEMENT


	)

122 
¥t_š™
(
¬gc
, *
¬gv
[]);

123 
£roù™Ë
(cÚ¡ *
fmt
, ...);

127 
	~<sys/ty³s.h
>

129 #iâdeà
BYTE_ORDER


130 #ià(
BSD
 >= 199103)

131 
	~<machše/’dŸn.h
>

133 #ià
defšed
(
lšux
è|| defšed(
__lšux__
)

134 
	~<’dŸn.h
>

136 
	#LITTLE_ENDIAN
 1234

	)

137 
	#BIG_ENDIAN
 4321

	)

138 
	#PDP_ENDIAN
 3412

	)

140 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
è|| defšed(
__amd64__
) || \

141 
defšed
(
vax
è|| defšed(
ns32000
è|| defšed(
sun386
) || \

142 
defšed
(
MIPSEL
è|| defšed(
_MIPSEL
è|| defšed(
BIT_ZERO_ON_RIGHT
) || \

143 
defšed
(
__®pha__
è|| 
	$defšed
(
__®pha
)

144 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

147 #ià
	`defšed
(
£l
è|| defšed(
pyr
è|| defšed(
mc68000
è|| defšed(
¥¬c
) || \

148 
	`defšed
(
is68k
è|| defšed(
hÛ
è|| defšed(
ibm032
è|| defšed(
ibm370
) || \

149 
	`defšed
(
MIPSEB
è|| defšed(
_MIPSEB
è|| defšed(
_IBMR2
è|| defšed(
DGUX
) ||\

150 
	`defšed
(
­Şlo
è|| defšed(
__cÚvex__
è|| defšed(
_CRAY
) || \

151 
	`defšed
(
__hµa
è|| defšed(
__hp9000
) || \

152 
	`defšed
(
__hp9000s300
è|| defšed(
__hp9000s700
) || \

153 
	`defšed
 (
BIT_ZERO_ON_LEFT
è|| defšed(
m68k
è|| 
	$defšed
(
__¥¬c
)

154 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

164 #iâdeà
BYTE_ORDER


165 #ifdeà
__BYTE_ORDER


166 #ià
	`defšed
(
__LITTLE_ENDIAN
è&& defšed(
__BIG_ENDIAN
)

167 #iâdeà
LITTLE_ENDIAN


168 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

170 #iâdeà
BIG_ENDIAN


171 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

173 #ià(
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
)

174 
	#BYTE_ORDER
 
LITTLE_ENDIAN


	)

176 
	#BYTE_ORDER
 
BIG_ENDIAN


	)

182 #ià!
	`defšed
(
BYTE_ORDER
) || \

183 (
BYTE_ORDER
 !ğ
BIG_ENDIAN
 && BYTE_ORDER !ğ
LITTLE_ENDIAN
)

192 #ià(
__i386
 || 
__amd64
 || 
__pow”pc__
è&& 
__GNUC__


193 
	#GNUC_VERSION
 (
__GNUC__
 * 10000 + 
__GNUC_MINOR__
 * 100 + 
__GNUC_PATCHLEVEL__
)

	)

194 #ià
	`defšed
(
__şªg__
)

195 
	#HAVE_ATOMIC


	)

197 #ià(
	`defšed
(
__GLIBC__
è&& defšed(
__GLIBC_PREREQ
))

198 #ià(
GNUC_VERSION
 >ğ40100 && 
	`__GLIBC_PREREQ
(2, 6))

199 
	#HAVE_ATOMIC


	)

	@crc16.c

1 
	~"»dis.h
"

47 cÚ¡ 
ušt16_t
 
	güc16b
[256]= {

82 
ušt16_t
 
	$üc16
(cÚ¡ *
buf
, 
Ën
) {

83 
couÁ”
;

84 
ušt16_t
 
üc
 = 0;

85 
couÁ”
 = 0; couÁ” < 
Ën
; counter++)

86 
üc
 = (üc<<8è^ 
üc16b
[((üc>>8è^ *
buf
++)&0x00FF];

87  
üc
;

88 
	}
}

	@crc64.c

40 
	~<¡dšt.h
>

42 cÚ¡ 
ušt64_t
 
	güc64_b
[256] = {

43 
UINT64_C
(0x0000000000000000), UINT64_C(0x7ad870c830358979),

44 
UINT64_C
(0xf5b0e190606b12f2), UINT64_C(0x8f689158505e9b8b),

45 
UINT64_C
(0xc038e5739841b68f), UINT64_C(0xbae095bba8743ff6),

46 
UINT64_C
(0x358804e3f82aa47d), UINT64_C(0x4f50742bc81f2d04),

47 
UINT64_C
(0xab28ecb46814fe75), UINT64_C(0xd1f09c7c5821770c),

48 
UINT64_C
(0x5e980d24087fec87), UINT64_C(0x24407dec384a65fe),

49 
UINT64_C
(0x6b1009c7f05548fa), UINT64_C(0x11c8790fc060c183),

50 
UINT64_C
(0x9ea0e857903e5a08), UINT64_C(0xe478989fa00bd371),

51 
UINT64_C
(0x7d08ff3b88be6f81), UINT64_C(0x07d08ff3b88be6f8),

52 
UINT64_C
(0x88b81eabe8d57d73), UINT64_C(0xf2606e63d8e0f40a),

53 
UINT64_C
(0xbd301a4810ffd90e), UINT64_C(0xc7e86a8020ca5077),

54 
UINT64_C
(0x4880fbd87094cbfc), UINT64_C(0x32588b1040a14285),

55 
UINT64_C
(0xd620138fe0aa91f4), UINT64_C(0xacf86347d09f188d),

56 
UINT64_C
(0x2390f21f80c18306), UINT64_C(0x594882d7b0f40a7f),

57 
UINT64_C
(0x1618f6fc78eb277b), UINT64_C(0x6cc0863448deae02),

58 
UINT64_C
(0xe3a8176c18803589), UINT64_C(0x997067a428b5bcf0),

59 
UINT64_C
(0xfa11fe77117cdf02), UINT64_C(0x80c98ebf2149567b),

60 
UINT64_C
(0x0fa11fe77117cdf0), UINT64_C(0x75796f2f41224489),

61 
UINT64_C
(0x3a291b04893d698d), UINT64_C(0x40f16bccb908e0f4),

62 
UINT64_C
(0xcf99fa94e9567b7f), UINT64_C(0xb5418a5cd963f206),

63 
UINT64_C
(0x513912c379682177), UINT64_C(0x2be1620b495da80e),

64 
UINT64_C
(0xa489f35319033385), UINT64_C(0xde51839b2936bafc),

65 
UINT64_C
(0x9101f7b0e12997f8), UINT64_C(0xebd98778d11c1e81),

66 
UINT64_C
(0x64b116208142850a), UINT64_C(0x1e6966e8b1770c73),

67 
UINT64_C
(0x8719014c99c2b083), UINT64_C(0xfdc17184a9f739fa),

68 
UINT64_C
(0x72a9e0dcf9a9a271), UINT64_C(0x08719014c99c2b08),

69 
UINT64_C
(0x4721e43f0183060c), UINT64_C(0x3df994f731b68f75),

70 
UINT64_C
(0xb29105af61e814fe), UINT64_C(0xc849756751dd9d87),

71 
UINT64_C
(0x2c31edf8f1d64ef6), UINT64_C(0x56e99d30c1e3c78f),

72 
UINT64_C
(0xd9810c6891bd5c04), UINT64_C(0xa3597ca0a188d57d),

73 
UINT64_C
(0xec09088b6997f879), UINT64_C(0x96d1784359a27100),

74 
UINT64_C
(0x19b9e91b09fcea8b), UINT64_C(0x636199d339c963f2),

75 
UINT64_C
(0xdf7adabd7a6e2d6f), UINT64_C(0xa5a2aa754a5ba416),

76 
UINT64_C
(0x2aca3b2d1a053f9d), UINT64_C(0x50124be52a30b6e4),

77 
UINT64_C
(0x1f423fcee22f9be0), UINT64_C(0x659a4f06d21a1299),

78 
UINT64_C
(0xeaf2de5e82448912), UINT64_C(0x902aae96b271006b),

79 
UINT64_C
(0x74523609127ad31a), UINT64_C(0x0e8a46c1224f5a63),

80 
UINT64_C
(0x81e2d7997211c1e8), UINT64_C(0xfb3aa75142244891),

81 
UINT64_C
(0xb46ad37a8a3b6595), UINT64_C(0xceb2a3b2ba0eecec),

82 
UINT64_C
(0x41da32eaea507767), UINT64_C(0x3b024222da65fe1e),

83 
UINT64_C
(0xa2722586f2d042ee), UINT64_C(0xd8aa554ec2e5cb97),

84 
UINT64_C
(0x57c2c41692bb501c), UINT64_C(0x2d1ab4dea28ed965),

85 
UINT64_C
(0x624ac0f56a91f461), UINT64_C(0x1892b03d5aa47d18),

86 
UINT64_C
(0x97fa21650afae693), UINT64_C(0xed2251ad3acf6fea),

87 
UINT64_C
(0x095ac9329ac4bc9b), UINT64_C(0x7382b9faaaf135e2),

88 
UINT64_C
(0xfcea28a2faafae69), UINT64_C(0x8632586aca9a2710),

89 
UINT64_C
(0xc9622c4102850a14), UINT64_C(0xb3ba5c8932b0836d),

90 
UINT64_C
(0x3cd2cdd162ee18e6), UINT64_C(0x460abd1952db919f),

91 
UINT64_C
(0x256b24ca6b12f26d), UINT64_C(0x5fb354025b277b14),

92 
UINT64_C
(0xd0dbc55a0b79e09f), UINT64_C(0xaa03b5923b4c69e6),

93 
UINT64_C
(0xe553c1b9f35344e2), UINT64_C(0x9f8bb171c366cd9b),

94 
UINT64_C
(0x10e3202993385610), UINT64_C(0x6a3b50e1a30ddf69),

95 
UINT64_C
(0x8e43c87e03060c18), UINT64_C(0xf49bb8b633338561),

96 
UINT64_C
(0x7bf329ee636d1eea), UINT64_C(0x012b592653589793),

97 
UINT64_C
(0x4e7b2d0d9b47ba97), UINT64_C(0x34a35dc5ab7233ee),

98 
UINT64_C
(0xbbcbcc9dfb2ca865), UINT64_C(0xc113bc55cb19211c),

99 
UINT64_C
(0x5863dbf1e3ac9dec), UINT64_C(0x22bbab39d3991495),

100 
UINT64_C
(0xadd33a6183c78f1e), UINT64_C(0xd70b4aa9b3f20667),

101 
UINT64_C
(0x985b3e827bed2b63), UINT64_C(0xe2834e4a4bd8a21a),

102 
UINT64_C
(0x6debdf121b863991), UINT64_C(0x1733afda2bb3b0e8),

103 
UINT64_C
(0xf34b37458bb86399), UINT64_C(0x8993478dbb8deae0),

104 
UINT64_C
(0x06fbd6d5ebd3716b), UINT64_C(0x7c23a61ddbe6f812),

105 
UINT64_C
(0x3373d23613f9d516), UINT64_C(0x49aba2fe23cc5c6f),

106 
UINT64_C
(0xc6c333a67392c7e4), UINT64_C(0xbc1b436e43a74e9d),

107 
UINT64_C
(0x95ac9329ac4bc9b5), UINT64_C(0xef74e3e19c7e40cc),

108 
UINT64_C
(0x601c72b9cc20db47), UINT64_C(0x1ac40271fc15523e),

109 
UINT64_C
(0x5594765a340a7f3a), UINT64_C(0x2f4c0692043ff643),

110 
UINT64_C
(0xa02497ca54616dc8), UINT64_C(0xdafce7026454e4b1),

111 
UINT64_C
(0x3e847f9dc45f37c0), UINT64_C(0x445c0f55f46abeb9),

112 
UINT64_C
(0xcb349e0da4342532), UINT64_C(0xb1eceec59401ac4b),

113 
UINT64_C
(0xfebc9aee5c1e814f), UINT64_C(0x8464ea266c2b0836),

114 
UINT64_C
(0x0b0c7b7e3c7593bd), UINT64_C(0x71d40bb60c401ac4),

115 
UINT64_C
(0xe8a46c1224f5a634), UINT64_C(0x927c1cda14c02f4d),

116 
UINT64_C
(0x1d148d82449eb4c6), UINT64_C(0x67ccfd4a74ab3dbf),

117 
UINT64_C
(0x289c8961bcb410bb), UINT64_C(0x5244f9a98c8199c2),

118 
UINT64_C
(0xdd2c68f1dcdf0249), UINT64_C(0xa7f41839ecea8b30),

119 
UINT64_C
(0x438c80a64ce15841), UINT64_C(0x3954f06e7cd4d138),

120 
UINT64_C
(0xb63c61362c8a4ab3), UINT64_C(0xcce411fe1cbfc3ca),

121 
UINT64_C
(0x83b465d5d4a0eece), UINT64_C(0xf96c151de49567b7),

122 
UINT64_C
(0x76048445b4cbfc3c), UINT64_C(0x0cdcf48d84fe7545),

123 
UINT64_C
(0x6fbd6d5ebd3716b7), UINT64_C(0x15651d968d029fce),

124 
UINT64_C
(0x9a0d8ccedd5c0445), UINT64_C(0xe0d5fc06ed698d3c),

125 
UINT64_C
(0xaf85882d2576a038), UINT64_C(0xd55df8e515432941),

126 
UINT64_C
(0x5a3569bd451db2ca), UINT64_C(0x20ed197575283bb3),

127 
UINT64_C
(0xc49581ead523e8c2), UINT64_C(0xbe4df122e51661bb),

128 
UINT64_C
(0x3125607ab548fa30), UINT64_C(0x4bfd10b2857d7349),

129 
UINT64_C
(0x04ad64994d625e4d), UINT64_C(0x7e7514517d57d734),

130 
UINT64_C
(0xf11d85092d094cbf), UINT64_C(0x8bc5f5c11d3cc5c6),

131 
UINT64_C
(0x12b5926535897936), UINT64_C(0x686de2ad05bcf04f),

132 
UINT64_C
(0xe70573f555e26bc4), UINT64_C(0x9ddd033d65d7e2bd),

133 
UINT64_C
(0xd28d7716adc8cfb9), UINT64_C(0xa85507de9dfd46c0),

134 
UINT64_C
(0x273d9686cda3dd4b), UINT64_C(0x5de5e64efd965432),

135 
UINT64_C
(0xb99d7ed15d9d8743), UINT64_C(0xc3450e196da80e3a),

136 
UINT64_C
(0x4c2d9f413df695b1), UINT64_C(0x36f5ef890dc31cc8),

137 
UINT64_C
(0x79a59ba2c5dc31cc), UINT64_C(0x037deb6af5e9b8b5),

138 
UINT64_C
(0x8c157a32a5b7233e), UINT64_C(0xf6cd0afa9582aa47),

139 
UINT64_C
(0x4ad64994d625e4da), UINT64_C(0x300e395ce6106da3),

140 
UINT64_C
(0xbf66a804b64ef628), UINT64_C(0xc5bed8cc867b7f51),

141 
UINT64_C
(0x8aeeace74e645255), UINT64_C(0xf036dc2f7e51db2c),

142 
UINT64_C
(0x7f5e4d772e0f40a7), UINT64_C(0x05863dbf1e3ac9de),

143 
UINT64_C
(0xe1fea520be311aaf), UINT64_C(0x9b26d5e88e0493d6),

144 
UINT64_C
(0x144e44b0de5a085d), UINT64_C(0x6e963478ee6f8124),

145 
UINT64_C
(0x21c640532670ac20), UINT64_C(0x5b1e309b16452559),

146 
UINT64_C
(0xd476a1c3461bbed2), UINT64_C(0xaeaed10b762e37ab),

147 
UINT64_C
(0x37deb6af5e9b8b5b), UINT64_C(0x4d06c6676eae0222),

148 
UINT64_C
(0xc26e573f3ef099a9), UINT64_C(0xb8b627f70ec510d0),

149 
UINT64_C
(0xf7e653dcc6da3dd4), UINT64_C(0x8d3e2314f6efb4ad),

150 
UINT64_C
(0x0256b24ca6b12f26), UINT64_C(0x788ec2849684a65f),

151 
UINT64_C
(0x9cf65a1b368f752e), UINT64_C(0xe62e2ad306bafc57),

152 
UINT64_C
(0x6946bb8b56e467dc), UINT64_C(0x139ecb4366d1eea5),

153 
UINT64_C
(0x5ccebf68aecec3a1), UINT64_C(0x2616cfa09efb4ad8),

154 
UINT64_C
(0xa97e5ef8cea5d153), UINT64_C(0xd3a62e30fe90582a),

155 
UINT64_C
(0xb0c7b7e3c7593bd8), UINT64_C(0xca1fc72bf76cb2a1),

156 
UINT64_C
(0x45775673a732292a), UINT64_C(0x3faf26bb9707a053),

157 
UINT64_C
(0x70ff52905f188d57), UINT64_C(0x0a2722586f2d042e),

158 
UINT64_C
(0x854fb3003f739fa5), UINT64_C(0xff97c3c80f4616dc),

159 
UINT64_C
(0x1bef5b57af4dc5ad), UINT64_C(0x61372b9f9f784cd4),

160 
UINT64_C
(0xee5fbac7cf26d75f), UINT64_C(0x9487ca0fff135e26),

161 
UINT64_C
(0xdbd7be24370c7322), UINT64_C(0xa10fceec0739fa5b),

162 
UINT64_C
(0x2e675fb4576761d0), UINT64_C(0x54bf2f7c6752e8a9),

163 
UINT64_C
(0xcdcf48d84fe75459), UINT64_C(0xb71738107fd2dd20),

164 
UINT64_C
(0x387fa9482f8c46ab), UINT64_C(0x42a7d9801fb9cfd2),

165 
UINT64_C
(0x0df7adabd7a6e2d6), UINT64_C(0x772fdd63e7936baf),

166 
UINT64_C
(0xf8474c3bb7cdf024), UINT64_C(0x829f3cf387f8795d),

167 
UINT64_C
(0x66e7a46c27f3aa2c), UINT64_C(0x1c3fd4a417c62355),

168 
UINT64_C
(0x935745fc4798b8de), UINT64_C(0xe98f353477ad31a7),

169 
UINT64_C
(0xa6df411fbfb21ca3), UINT64_C(0xdc0731d78f8795da),

170 
UINT64_C
(0x536fa08fdfd90e51), UINT64_C(0x29b7d047efec8728),

173 
ušt64_t
 
	$üc64
(
ušt64_t
 
üc
, cÚ¡ *
s
, ušt64_ˆ
l
) {

174 
ušt64_t
 
j
;

176 
j
 = 0; j < 
l
; j++) {

177 
ušt8_t
 
by‹
 = 
s
[
j
];

178 
üc
 = 
üc64_b
[(
ušt8_t
)üø^ 
by‹
] ^ (crc >> 8);

180  
üc
;

181 
	}
}

184 #ifdeà
TEST_MAIN


185 
	~<¡dio.h
>

186 
	$maš
() {

187 
	`´štf
("e9c6d914c4b8d9ca == %016llx\n",

188 (è
	`üc64
(0,(*)"123456789",9));

190 
	}
}

	@crc64.h

1 #iâdeà
CRC64_H


2 
	#CRC64_H


	)

4 
	~<¡dšt.h
>

6 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

	@db.c

30 
	~"»dis.h
"

31 
	~"şu¡”.h
"

33 
	~<sigÇl.h
>

34 
	~<ùy³.h
>

36 
¦ÙToKeyAdd
(
robj
 *
key
);

37 
¦ÙToKeyD–
(
robj
 *
key
);

38 
¦ÙToKeyFlush
();

44 
robj
 *
	$lookupKey
(
»disDb
 *
db
, 
robj
 *
key
) {

45 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

46 ià(
de
) {

47 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

52 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

53 
v®
->
Ìu
 = 
	`LRU_CLOCK
();

54  
v®
;

56  
NULL
;

58 
	}
}

60 
robj
 *
	$lookupKeyR—d
(
»disDb
 *
db
, 
robj
 *
key
) {

61 
robj
 *
v®
;

63 
	`expœeIfN“ded
(
db
,
key
);

64 
v®
 = 
	`lookupKey
(
db
,
key
);

65 ià(
v®
 =ğ
NULL
)

66 
£rv”
.
¡©_key¥aû_mis£s
++;

68 
£rv”
.
¡©_key¥aû_h™s
++;

69  
v®
;

70 
	}
}

72 
robj
 *
	$lookupKeyWr™e
(
»disDb
 *
db
, 
robj
 *
key
) {

73 
	`expœeIfN“ded
(
db
,
key
);

74  
	`lookupKey
(
db
,
key
);

75 
	}
}

77 
robj
 *
	$lookupKeyR—dOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

78 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
, 
key
);

79 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

80  
o
;

81 
	}
}

83 
robj
 *
	$lookupKeyWr™eOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

84 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
, 
key
);

85 ià(!
o
è
	`addR•ly
(
c
,
»¶y
);

86  
o
;

87 
	}
}

93 
	$dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

94 
sds
 
cİy
 = 
	`sdsdup
(
key
->
±r
);

95 
»tv®
 = 
	`diùAdd
(
db
->
diù
, 
cİy
, 
v®
);

97 
	`»disAs£¹W™hInfo
(
NULL
,
key
,
»tv®
 =ğ
REDIS_OK
);

98 ià(
v®
->
ty³
 =ğ
REDIS_LIST
è
	`sigÇlLi¡AsR—dy
(
db
, 
key
);

99 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyAdd
(
key
);

100 
	}
}

107 
	$dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

108 
diùEÁry
 *
de
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

110 
	`»disAs£¹W™hInfo
(
NULL
,
key
,
de
 != NULL);

111 
	`diùR•Ïû
(
db
->
diù
, 
key
->
±r
, 
v®
);

112 
	}
}

120 
	$£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
) {

121 ià(
	`lookupKeyWr™e
(
db
,
key
è=ğ
NULL
) {

122 
	`dbAdd
(
db
,
key
,
v®
);

124 
	`dbOv”wr™e
(
db
,
key
,
v®
);

126 
	`šüRefCouÁ
(
v®
);

127 
	`»moveExpœe
(
db
,
key
);

128 
	`sigÇlModif›dKey
(
db
,
key
);

129 
	}
}

131 
	$dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
) {

132  
	`diùFšd
(
db
->
diù
,
key
->
±r
è!ğ
NULL
;

133 
	}
}

139 
robj
 *
	$dbRªdomKey
(
»disDb
 *
db
) {

140 
diùEÁry
 *
de
;

143 
sds
 
key
;

144 
robj
 *
keyobj
;

146 
de
 = 
	`diùG‘RªdomKey
(
db
->
diù
);

147 ià(
de
 =ğ
NULL
)  NULL;

149 
key
 = 
	`diùG‘Key
(
de
);

150 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

151 ià(
	`diùFšd
(
db
->
expœes
,
key
)) {

152 ià(
	`expœeIfN“ded
(
db
,
keyobj
)) {

153 
	`deüRefCouÁ
(
keyobj
);

157  
keyobj
;

159 
	}
}

162 
	$dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
) {

165 ià(
	`diùSize
(
db
->
expœes
è> 0è
	`diùD–‘e
(db->expœes,
key
->
±r
);

166 ià(
	`diùD–‘e
(
db
->
diù
,
key
->
±r
è=ğ
DICT_OK
) {

167 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyD–
(
key
);

172 
	}
}

201 
robj
 *
	$dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
o
) {

202 
	`»disAs£¹
(
o
->
ty³
 =ğ
REDIS_STRING
);

203 ià(
o
->
»fcouÁ
 !ğ1 || o->
’codšg
 !ğ
REDIS_ENCODING_RAW
) {

204 
robj
 *
decoded
 = 
	`g‘DecodedObjeù
(
o
);

205 
o
 = 
	`ü—‹RawSŒšgObjeù
(
decoded
->
±r
, 
	`sd¦’
(decoded->ptr));

206 
	`deüRefCouÁ
(
decoded
);

207 
	`dbOv”wr™e
(
db
,
key
,
o
);

209  
o
;

210 
	}
}

212 
em±yDb
((
ÿÎback
)(*)) {

213 
j
;

214 
»moved
 = 0;

216 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

217 
»moved
 +ğ
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

218 
	`diùEm±y
(
£rv”
.
db
[
j
].
diù
,
ÿÎback
);

219 
	`diùEm±y
(
£rv”
.
db
[
j
].
expœes
,
ÿÎback
);

221 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyFlush
();

222  
»moved
;

223 
	}
}

225 
	$£ËùDb
(
»disCl›Á
 *
c
, 
id
) {

226 ià(
id
 < 0 || id >ğ
£rv”
.
dbnum
)

227  
REDIS_ERR
;

228 
c
->
db
 = &
£rv”
.db[
id
];

229  
REDIS_OK
;

230 
	}
}

241 
	$sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
) {

242 
	`touchW©chedKey
(
db
,
key
);

243 
	}
}

245 
	$sigÇlFlushedDb
(
dbid
) {

246 
	`touchW©chedKeysOnFlush
(
dbid
);

247 
	}
}

253 
	$æushdbCommªd
(
»disCl›Á
 *
c
) {

254 
£rv”
.
dœty
 +ğ
	`diùSize
(
c
->
db
->
diù
);

255 
	`sigÇlFlushedDb
(
c
->
db
->
id
);

256 
	`diùEm±y
(
c
->
db
->
diù
,
NULL
);

257 
	`diùEm±y
(
c
->
db
->
expœes
,
NULL
);

258 ià(
£rv”
.
şu¡”_’abËd
è
	`¦ÙToKeyFlush
();

259 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

260 
	}
}

262 
	$æush®lCommªd
(
»disCl›Á
 *
c
) {

263 
	`sigÇlFlushedDb
(-1);

264 
£rv”
.
dœty
 +ğ
	`em±yDb
(
NULL
);

265 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

266 ià(
£rv”
.
rdb_chd_pid
 != -1) {

267 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

268 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

270 ià(
£rv”
.
§v•¬am¦’
 > 0) {

273 
§ved_dœty
 = 
£rv”
.
dœty
;

274 
	`rdbSave
(
£rv”
.
rdb_f’ame
);

275 
£rv”
.
dœty
 = 
§ved_dœty
;

277 
£rv”
.
dœty
++;

278 
	}
}

280 
	$d–Commªd
(
»disCl›Á
 *
c
) {

281 
d–‘ed
 = 0, 
j
;

283 
j
 = 1; j < 
c
->
¬gc
; j++) {

284 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[
j
]);

285 ià(
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
])) {

286 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

287 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,

288 "d–",
c
->
¬gv
[
j
],c->
db
->
id
);

289 
£rv”
.
dœty
++;

290 
d–‘ed
++;

293 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

294 
	}
}

296 
	$exi¡sCommªd
(
»disCl›Á
 *
c
) {

297 
	`expœeIfN“ded
(
c
->
db
,c->
¬gv
[1]);

298 ià(
	`dbExi¡s
(
c
->
db
,c->
¬gv
[1])) {

299 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

301 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

303 
	}
}

305 
	$£ËùCommªd
(
»disCl›Á
 *
c
) {

306 
id
;

308 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[1], &
id
,

309 "šv®id DB index"è!ğ
REDIS_OK
)

312 ià(
£rv”
.
şu¡”_’abËd
 && 
id
 != 0) {

313 
	`addR•lyE¼Ü
(
c
,"SELECT is‚ot‡llowed in cluster mode");

316 ià(
	`£ËùDb
(
c
,
id
è=ğ
REDIS_ERR
) {

317 
	`addR•lyE¼Ü
(
c
,"invalid DB index");

319 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

321 
	}
}

323 
	$¿ndomkeyCommªd
(
»disCl›Á
 *
c
) {

324 
robj
 *
key
;

326 ià((
key
 = 
	`dbRªdomKey
(
c
->
db
)è=ğ
NULL
) {

327 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

331 
	`addR•lyBulk
(
c
,
key
);

332 
	`deüRefCouÁ
(
key
);

333 
	}
}

335 
	$keysCommªd
(
»disCl›Á
 *
c
) {

336 
diùI‹¿tÜ
 *
di
;

337 
diùEÁry
 *
de
;

338 
sds
 
·‰”n
 = 
c
->
¬gv
[1]->
±r
;

339 
¶’
 = 
	`sd¦’
(
·‰”n
), 
®lkeys
;

340 
numkeys
 = 0;

341 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

343 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
db
->
diù
);

344 
®lkeys
 = (
·‰”n
[0] == '*' &&…attern[1] == '\0');

345 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

346 
sds
 
key
 = 
	`diùG‘Key
(
de
);

347 
robj
 *
keyobj
;

349 ià(
®lkeys
 || 
	`¡ršgm©chËn
(
·‰”n
,
¶’
,
key
,
	`sd¦’
(key),0)) {

350 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

351 ià(
	`expœeIfN“ded
(
c
->
db
,
keyobj
) == 0) {

352 
	`addR•lyBulk
(
c
,
keyobj
);

353 
numkeys
++;

355 
	`deüRefCouÁ
(
keyobj
);

358 
	`diùR–—£I‹¿tÜ
(
di
);

359 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
numkeys
);

360 
	}
}

364 
	$sÿnC®lback
(*
´ivd©a
, cÚ¡ 
diùEÁry
 *
de
) {

365 **
pd
 = (**è
´ivd©a
;

366 
li¡
 *
keys
 = 
pd
[0];

367 
robj
 *
o
 = 
pd
[1];

368 
robj
 *
key
, *
v®
 = 
NULL
;

370 ià(
o
 =ğ
NULL
) {

371 
sds
 
sdskey
 = 
	`diùG‘Key
(
de
);

372 
key
 = 
	`ü—‹SŒšgObjeù
(
sdskey
, 
	`sd¦’
(sdskey));

373 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

374 
key
 = 
	`diùG‘Key
(
de
);

375 
	`šüRefCouÁ
(
key
);

376 } ià(
o
->
ty³
 =ğ
REDIS_HASH
) {

377 
key
 = 
	`diùG‘Key
(
de
);

378 
	`šüRefCouÁ
(
key
);

379 
v®
 = 
	`diùG‘V®
(
de
);

380 
	`šüRefCouÁ
(
v®
);

381 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
) {

382 
key
 = 
	`diùG‘Key
(
de
);

383 
	`šüRefCouÁ
(
key
);

384 
v®
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(*(*)
	`diùG‘V®
(
de
),0);

386 
	`»disPªic
("Type‚ot handled in SCAN callback.");

389 
	`li¡AddNodeTa
(
keys
, 
key
);

390 ià(
v®
è
	`li¡AddNodeTa
(
keys
, val);

391 
	}
}

397 
	$·r£SÿnCursÜOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
cursÜ
) {

398 *
•Œ
;

402 
”ºo
 = 0;

403 *
cursÜ
 = 
	`¡¹oul
(
o
->
±r
, &
•Œ
, 10);

404 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
)

406 
	`addR•lyE¼Ü
(
c
, "invalid cursor");

407  
REDIS_ERR
;

409  
REDIS_OK
;

410 
	}
}

423 
	$sÿnG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 *
o
, 
cursÜ
) {

424 
i
, 
j
;

425 
li¡
 *
keys
 = 
	`li¡C»©e
();

426 
li¡Node
 *
node
, *
ÃxŠode
;

427 
couÁ
 = 10;

428 
sds
 
·t
;

429 
·’
, 
u£_·‰”n
 = 0;

430 
diù
 *
ht
;

434 
	`»disAs£¹
(
o
 =ğ
NULL
 || o->
ty³
 =ğ
REDIS_SET
 || o->ty³ =ğ
REDIS_HASH
 ||

435 
o
->
ty³
 =ğ
REDIS_ZSET
);

438 
i
 = (
o
 =ğ
NULL
) ? 2 : 3;

441 
i
 < 
c
->
¬gc
) {

442 
j
 = 
c
->
¬gc
 - 
i
;

443 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "couÁ"è&& 
j
 >= 2) {

444 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
i
+1], &
couÁ
, 
NULL
)

445 !ğ
REDIS_OK
)

447 
ş—nup
;

450 ià(
couÁ
 < 1) {

451 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

452 
ş—nup
;

455 
i
 += 2;

456 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
, "m©ch"è&& 
j
 >= 2) {

457 
·t
 = 
c
->
¬gv
[
i
+1]->
±r
;

458 
·’
 = 
	`sd¦’
(
·t
);

462 
u£_·‰”n
 = !(
·t
[0] =ğ'*' && 
·’
 == 1);

464 
i
 += 2;

466 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

467 
ş—nup
;

480 
ht
 = 
NULL
;

481 ià(
o
 =ğ
NULL
) {

482 
ht
 = 
c
->
db
->
diù
;

483 } ià(
o
->
ty³
 =ğ
REDIS_SET
 && o->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

484 
ht
 = 
o
->
±r
;

485 } ià(
o
->
ty³
 =ğ
REDIS_HASH
 && o->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

486 
ht
 = 
o
->
±r
;

487 
couÁ
 *= 2;

488 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
 && o->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

489 
z£t
 *
zs
 = 
o
->
±r
;

490 
ht
 = 
zs
->
diù
;

491 
couÁ
 *= 2;

494 ià(
ht
) {

495 *
´ivd©a
[2];

500 
max™”©iÚs
 = 
couÁ
*10;

505 
´ivd©a
[0] = 
keys
;

506 
´ivd©a
[1] = 
o
;

508 
cursÜ
 = 
	`diùSÿn
(
ht
, cursÜ, 
sÿnC®lback
, 
´ivd©a
);

509 } 
cursÜ
 &&

510 
max™”©iÚs
-- &&

511 
	`li¡L’gth
(
keys
è< ()
couÁ
);

512 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

513 
pos
 = 0;

514 
št64_t
 
Î
;

516 
	`št£tG‘
(
o
->
±r
,
pos
++,&
Î
))

517 
	`li¡AddNodeTa
(
keys
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î
));

518 
cursÜ
 = 0;

519 } ià(
o
->
ty³
 =ğ
REDIS_HASH
 || o->ty³ =ğ
REDIS_ZSET
) {

520 *
p
 = 
	`zli¡Index
(
o
->
±r
,0);

521 *
v¡r
;

522 
vËn
;

523 
vÎ
;

525 
p
) {

526 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vÎ
);

527 
	`li¡AddNodeTa
(
keys
,

528 (
v¡r
 !ğ
NULL
è? 
	`ü—‹SŒšgObjeù
((*)v¡r,
vËn
) :

529 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
));

530 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

532 
cursÜ
 = 0;

534 
	`»disPªic
("Not handledƒncoding in SCAN.");

538 
node
 = 
	`li¡Fœ¡
(
keys
);

539 
node
) {

540 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

541 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

542 
f‹r
 = 0;

545 ià(!
f‹r
 && 
u£_·‰”n
) {

546 ià(
	`sdsEncodedObjeù
(
kobj
)) {

547 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
kobj
->
±r
, 
	`sd¦’
(kobj->ptr), 0))

548 
f‹r
 = 1;

550 
buf
[
REDIS_LONGSTR_SIZE
];

551 
Ën
;

553 
	`»disAs£¹
(
kobj
->
’codšg
 =ğ
REDIS_ENCODING_INT
);

554 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
kobj
->
±r
);

555 ià(!
	`¡ršgm©chËn
(
·t
, 
·’
, 
buf
, 
Ën
, 0)è
f‹r
 = 1;

560 ià(!
f‹r
 && 
o
 =ğ
NULL
 && 
	`expœeIfN“ded
(
c
->
db
, 
kobj
)) filter = 1;

563 ià(
f‹r
) {

564 
	`deüRefCouÁ
(
kobj
);

565 
	`li¡D–Node
(
keys
, 
node
);

571 ià(
o
 && (o->
ty³
 =ğ
REDIS_ZSET
 || o->ty³ =ğ
REDIS_HASH
)) {

572 
node
 = 
ÃxŠode
;

573 
ÃxŠode
 = 
	`li¡NextNode
(
node
);

574 ià(
f‹r
) {

575 
kobj
 = 
	`li¡NodeV®ue
(
node
);

576 
	`deüRefCouÁ
(
kobj
);

577 
	`li¡D–Node
(
keys
, 
node
);

580 
node
 = 
ÃxŠode
;

584 
	`addR•lyMuÉiBulkL’
(
c
, 2);

585 
	`addR•lyBulkLÚgLÚg
(
c
,
cursÜ
);

587 
	`addR•lyMuÉiBulkL’
(
c
, 
	`li¡L’gth
(
keys
));

588 (
node
 = 
	`li¡Fœ¡
(
keys
)è!ğ
NULL
) {

589 
robj
 *
kobj
 = 
	`li¡NodeV®ue
(
node
);

590 
	`addR•lyBulk
(
c
, 
kobj
);

591 
	`deüRefCouÁ
(
kobj
);

592 
	`li¡D–Node
(
keys
, 
node
);

595 
ş—nup
:

596 
	`li¡S‘F»eM‘hod
(
keys
,
deüRefCouÁVoid
);

597 
	`li¡R–—£
(
keys
);

598 
	}
}

601 
	$sÿnCommªd
(
»disCl›Á
 *
c
) {

602 
cursÜ
;

603 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[1],&
cursÜ
è=ğ
REDIS_ERR
) ;

604 
	`sÿnG’”icCommªd
(
c
,
NULL
,
cursÜ
);

605 
	}
}

607 
	$dbsizeCommªd
(
»disCl›Á
 *
c
) {

608 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
db
->
diù
));

609 
	}
}

611 
	$Ï¡§veCommªd
(
»disCl›Á
 *
c
) {

612 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
Ï¡§ve
);

613 
	}
}

615 
	$ty³Commªd
(
»disCl›Á
 *
c
) {

616 
robj
 *
o
;

617 *
ty³
;

619 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

620 ià(
o
 =ğ
NULL
) {

621 
ty³
 = "none";

623 
o
->
ty³
) {

624 
REDIS_STRING
: 
ty³
 = "string"; ;

625 
REDIS_LIST
: 
ty³
 = "list"; ;

626 
REDIS_SET
: 
ty³
 = "set"; ;

627 
REDIS_ZSET
: 
ty³
 = "zset"; ;

628 
REDIS_HASH
: 
ty³
 = "hash"; ;

629 : 
ty³
 = "unknown"; ;

632 
	`addR•lyStus
(
c
,
ty³
);

633 
	}
}

635 
	$shutdownCommªd
(
»disCl›Á
 *
c
) {

636 
æags
 = 0;

638 ià(
c
->
¬gc
 > 2) {

639 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

641 } ià(
c
->
¬gc
 == 2) {

642 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"nosave")) {

643 
æags
 |ğ
REDIS_SHUTDOWN_NOSAVE
;

644 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"save")) {

645 
æags
 |ğ
REDIS_SHUTDOWN_SAVE
;

647 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

657 ià(
£rv”
.
lßdšg
 || s”v”.
£Áš–_mode
)

658 
æags
 = (æag & ~
REDIS_SHUTDOWN_SAVE
è| 
REDIS_SHUTDOWN_NOSAVE
;

659 ià(
	`´•¬eFÜShutdown
(
æags
è=ğ
REDIS_OK
è
	`ex™
(0);

660 
	`addR•lyE¼Ü
(
c
,"Errorsryingo SHUTDOWN. Check†ogs.");

661 
	}
}

663 
	$»ÇmeG’”icCommªd
(
»disCl›Á
 *
c
, 
nx
) {

664 
robj
 *
o
;

665 
expœe
;

668 ià(
	`sdscmp
(
c
->
¬gv
[1]->
±r
,c->argv[2]->ptr) == 0) {

669 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

673 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
)è=ğ
NULL
)

676 
	`šüRefCouÁ
(
o
);

677 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

678 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]è!ğ
NULL
) {

679 ià(
nx
) {

680 
	`deüRefCouÁ
(
o
);

681 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

686 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[2]);

688 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
o
);

689 ià(
expœe
 !ğ-1è
	`£tExpœe
(
c
->
db
,c->
¬gv
[2],expire);

690 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

691 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

692 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

693 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"rename_from",

694 
c
->
¬gv
[1],c->
db
->
id
);

695 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"rename_to",

696 
c
->
¬gv
[2],c->
db
->
id
);

697 
£rv”
.
dœty
++;

698 
	`addR•ly
(
c
,
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

699 
	}
}

701 
	$»ÇmeCommªd
(
»disCl›Á
 *
c
) {

702 
	`»ÇmeG’”icCommªd
(
c
,0);

703 
	}
}

705 
	$»Çm’xCommªd
(
»disCl›Á
 *
c
) {

706 
	`»ÇmeG’”icCommªd
(
c
,1);

707 
	}
}

709 
	$moveCommªd
(
»disCl›Á
 *
c
) {

710 
robj
 *
o
;

711 
»disDb
 *
¤c
, *
d¡
;

712 
¤cid
;

713 
dbid
;

715 ià(
£rv”
.
şu¡”_’abËd
) {

716 
	`addR•lyE¼Ü
(
c
,"MOVE is‚ot‡llowed in cluster mode");

721 
¤c
 = 
c
->
db
;

722 
¤cid
 = 
c
->
db
->
id
;

724 ià(
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[2],&
dbid
è=ğ
REDIS_ERR
 ||

725 
dbid
 < 
INT_MIN
 || dbid > 
INT_MAX
 ||

726 
	`£ËùDb
(
c
,
dbid
è=ğ
REDIS_ERR
)

728 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

731 
d¡
 = 
c
->
db
;

732 
	`£ËùDb
(
c
,
¤cid
);

736 ià(
¤c
 =ğ
d¡
) {

737 
	`addR•ly
(
c
,
sh¬ed
.
§meobjeù”r
);

742 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

743 ià(!
o
) {

744 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

749 ià(
	`lookupKeyWr™e
(
d¡
,
c
->
¬gv
[1]è!ğ
NULL
) {

750 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

753 
	`dbAdd
(
d¡
,
c
->
¬gv
[1],
o
);

754 
	`šüRefCouÁ
(
o
);

757 
	`dbD–‘e
(
¤c
,
c
->
¬gv
[1]);

758 
£rv”
.
dœty
++;

759 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

760 
	}
}

766 
	$»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

769 
	`»disAs£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

770  
	`diùD–‘e
(
db
->
expœes
,
key
->
±r
è=ğ
DICT_OK
;

771 
	}
}

773 
	$£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
) {

774 
diùEÁry
 *
kde
, *
de
;

777 
kde
 = 
	`diùFšd
(
db
->
diù
,
key
->
±r
);

778 
	`»disAs£¹W™hInfo
(
NULL
,
key
,
kde
 != NULL);

779 
de
 = 
	`diùR•ÏûRaw
(
db
->
expœes
,
	`diùG‘Key
(
kde
));

780 
	`diùS‘SigÃdIÁeg”V®
(
de
,
wh’
);

781 
	}
}

785 
	$g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
) {

786 
diùEÁry
 *
de
;

789 ià(
	`diùSize
(
db
->
expœes
) == 0 ||

790 (
de
 = 
	`diùFšd
(
db
->
expœes
,
key
->
±r
)è=ğ
NULL
)  -1;

794 
	`»disAs£¹W™hInfo
(
NULL
,
key
,
	`diùFšd
(
db
->
diù
,key->
±r
) != NULL);

795  
	`diùG‘SigÃdIÁeg”V®
(
de
);

796 
	}
}

806 
	$´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
) {

807 
robj
 *
¬gv
[2];

809 
¬gv
[0] = 
sh¬ed
.
d–
;

810 
¬gv
[1] = 
key
;

811 
	`šüRefCouÁ
(
¬gv
[0]);

812 
	`šüRefCouÁ
(
¬gv
[1]);

814 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
)

815 
	`ãedAµ’dOÆyFe
(
£rv”
.
d–Commªd
,
db
->
id
,
¬gv
,2);

816 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
db
->
id
,
¬gv
,2);

818 
	`deüRefCouÁ
(
¬gv
[0]);

819 
	`deüRefCouÁ
(
¬gv
[1]);

820 
	}
}

822 
	$expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
) {

823 
m¡ime_t
 
wh’
 = 
	`g‘Expœe
(
db
,
key
);

824 
m¡ime_t
 
now
;

826 ià(
wh’
 < 0)  0;

829 ià(
£rv”
.
lßdšg
)  0;

836 
now
 = 
£rv”
.
lua_ÿÎ”
 ? s”v”.
lua_time_¡¬t
 : 
	`m¡ime
();

845 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
è 
now
 > 
wh’
;

848 ià(
now
 <ğ
wh’
)  0;

851 
£rv”
.
¡©_expœedkeys
++;

852 
	`´İag©eExpœe
(
db
,
key
);

853 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_EXPIRED
,

854 "expœed",
key
,
db
->
id
);

855  
	`dbD–‘e
(
db
,
key
);

856 
	}
}

869 
	$expœeG’”icCommªd
(
»disCl›Á
 *
c
, 
ba£time
, 
un™
) {

870 
robj
 *
key
 = 
c
->
¬gv
[1], *
·¿m
 = c->argv[2];

871 
wh’
;

873 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
·¿m
, &
wh’
, 
NULL
è!ğ
REDIS_OK
)

876 ià(
un™
 =ğ
UNIT_SECONDS
è
wh’
 *= 1000;

877 
wh’
 +ğ
ba£time
;

880 ià(
	`lookupKeyR—d
(
c
->
db
,
key
è=ğ
NULL
) {

881 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

891 ià(
wh’
 <ğ
	`m¡ime
(è&& !
£rv”
.
lßdšg
 && !£rv”.
ma¡”ho¡
) {

892 
robj
 *
aux
;

894 
	`»disAs£¹W™hInfo
(
c
,
key
,
	`dbD–‘e
(c->
db
,key));

895 
£rv”
.
dœty
++;

898 
aux
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

899 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,
aux
,
key
);

900 
	`deüRefCouÁ
(
aux
);

901 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

902 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

903 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

906 
	`£tExpœe
(
c
->
db
,
key
,
wh’
);

907 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

908 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

909 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"expœe",
key
,
c
->
db
->
id
);

910 
£rv”
.
dœty
++;

913 
	}
}

915 
	$expœeCommªd
(
»disCl›Á
 *
c
) {

916 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_SECONDS
);

917 
	}
}

919 
	$expœ—tCommªd
(
»disCl›Á
 *
c
) {

920 
	`expœeG’”icCommªd
(
c
,0,
UNIT_SECONDS
);

921 
	}
}

923 
	$³xpœeCommªd
(
»disCl›Á
 *
c
) {

924 
	`expœeG’”icCommªd
(
c
,
	`m¡ime
(),
UNIT_MILLISECONDS
);

925 
	}
}

927 
	$³xpœ—tCommªd
(
»disCl›Á
 *
c
) {

928 
	`expœeG’”icCommªd
(
c
,0,
UNIT_MILLISECONDS
);

929 
	}
}

931 
	$‰lG’”icCommªd
(
»disCl›Á
 *
c
, 
ouut_ms
) {

932 
expœe
, 
‰l
 = -1;

935 ià(
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]è=ğ
NULL
) {

936 
	`addR•lyLÚgLÚg
(
c
,-2);

941 
expœe
 = 
	`g‘Expœe
(
c
->
db
,c->
¬gv
[1]);

942 ià(
expœe
 != -1) {

943 
‰l
 = 
expœe
-
	`m¡ime
();

944 ià(
‰l
 < 0)tl = 0;

946 ià(
‰l
 == -1) {

947 
	`addR•lyLÚgLÚg
(
c
,-1);

949 
	`addR•lyLÚgLÚg
(
c
,
ouut_ms
 ? 
‰l
 : ((ttl+500)/1000));

951 
	}
}

953 
	$‰lCommªd
(
»disCl›Á
 *
c
) {

954 
	`‰lG’”icCommªd
(
c
, 0);

955 
	}
}

957 
	$±Commªd
(
»disCl›Á
 *
c
) {

958 
	`‰lG’”icCommªd
(
c
, 1);

959 
	}
}

961 
	$³rsi¡Commªd
(
»disCl›Á
 *
c
) {

962 
diùEÁry
 *
de
;

964 
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[1]->
±r
);

965 ià(
de
 =ğ
NULL
) {

966 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

968 ià(
	`»moveExpœe
(
c
->
db
,c->
¬gv
[1])) {

969 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

970 
£rv”
.
dœty
++;

972 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

975 
	}
}

983 *
	$g‘KeysUsšgCommªdTabË
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

984 
j
, 
i
 = 0, 
Ï¡
, *
keys
;

985 
	`REDIS_NOTUSED
(
¬gv
);

987 ià(
cmd
->
fœ¡key
 == 0) {

988 *
numkeys
 = 0;

989  
NULL
;

991 
Ï¡
 = 
cmd
->
Ï¡key
;

992 ià(
Ï¡
 < 0èÏ¡ = 
¬gc
+last;

993 
keys
 = 
	`zm®loc
(()*((
Ï¡
 - 
cmd
->
fœ¡key
)+1));

994 
j
 = 
cmd
->
fœ¡key
; j <ğ
Ï¡
; j +ğcmd->
key¡•
) {

995 
	`»disAs£¹
(
j
 < 
¬gc
);

996 
keys
[
i
++] = 
j
;

998 *
numkeys
 = 
i
;

999  
keys
;

1000 
	}
}

1013 *
	$g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1014 ià(
cmd
->
g‘keys_´oc
) {

1015  
cmd
->
	`g‘keys_´oc
(cmd,
¬gv
,
¬gc
,
numkeys
);

1017  
	`g‘KeysUsšgCommªdTabË
(
cmd
,
¬gv
,
¬gc
,
numkeys
);

1019 
	}
}

1022 
	$g‘KeysF»eResuÉ
(*
»suÉ
) {

1023 
	`zä“
(
»suÉ
);

1024 
	}
}

1029 *
	$zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1030 
i
, 
num
, *
keys
;

1031 
	`REDIS_NOTUSED
(
cmd
);

1033 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1036 ià(
num
 > (
¬gc
-3)) {

1037 *
numkeys
 = 0;

1038  
NULL
;

1044 
keys
 = 
	`zm®loc
(()*(
num
+1));

1047 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1050 
keys
[
num
] = 1;

1051 *
numkeys
 = 
num
+1;

1052  
keys
;

1053 
	}
}

1058 *
	$ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1059 
i
, 
num
, *
keys
;

1060 
	`REDIS_NOTUSED
(
cmd
);

1062 
num
 = 
	`©oi
(
¬gv
[2]->
±r
);

1065 ià(
num
 > (
¬gc
-3)) {

1066 *
numkeys
 = 0;

1067  
NULL
;

1070 
keys
 = 
	`zm®loc
(()*
num
);

1071 *
numkeys
 = 
num
;

1074 
i
 = 0; i < 
num
; i++è
keys
[i] = 3+i;

1076  
keys
;

1077 
	}
}

1086 *
	$sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
) {

1087 
i
, 
j
, 
num
, *
keys
, 
found_¡Üe
 = 0;

1088 
	`REDIS_NOTUSED
(
cmd
);

1090 
num
 = 0;

1091 
keys
 = 
	`zm®loc
(()*2);

1093 
keys
[
num
++] = 1;

1100 *
Çme
;

1101 
sk
;

1102 } 
skli¡
[] = {

1106 {
NULL
, 0}

1109 
i
 = 2; i < 
¬gc
; i++) {

1110 
j
 = 0; 
skli¡
[j].
Çme
 !ğ
NULL
; j++) {

1111 ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,
skli¡
[
j
].
Çme
)) {

1112 
i
 +ğ
skli¡
[
j
].
sk
;

1114 } ià(!
	`¡rÿ£cmp
(
¬gv
[
i
]->
±r
,"¡Üe"è&& i+1 < 
¬gc
) {

1118 
found_¡Üe
 = 1;

1119 
keys
[
num
] = 
i
+1;

1124 *
numkeys
 = 
num
 + 
found_¡Üe
;

1125  
keys
;

1126 
	}
}

1131 
	$¦ÙToKeyAdd
(
robj
 *
key
) {

1132 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1134 
	`z¦In£¹
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
hash¦Ù
,
key
);

1135 
	`šüRefCouÁ
(
key
);

1136 
	}
}

1138 
	$¦ÙToKeyD–
(
robj
 *
key
) {

1139 
hash¦Ù
 = 
	`keyHashSlÙ
(
key
->
±r
,
	`sd¦’
(key->ptr));

1141 
	`z¦D–‘e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
,
hash¦Ù
,
key
);

1142 
	}
}

1144 
	$¦ÙToKeyFlush
() {

1145 
	`z¦F»e
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
);

1146 
£rv”
.
şu¡”
->
¦Ùs_to_keys
 = 
	`z¦C»©e
();

1147 
	}
}

1149 
	$g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
) {

1150 
zskli¡Node
 *
n
;

1151 
z¿nge¥ec
 
¿nge
;

1152 
j
 = 0;

1154 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1155 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1157 
n
 = 
	`z¦Fœ¡InRªge
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
, &
¿nge
);

1158 
n
 &&‚->
scÜe
 =ğ
hash¦Ù
 && 
couÁ
--) {

1159 
keys
[
j
++] = 
n
->
obj
;

1160 
n
 =‚->
Ëv–
[0].
fÜw¬d
;

1162  
j
;

1163 
	}
}

1167 
	$d–KeysInSlÙ
(
hash¦Ù
) {

1168 
zskli¡Node
 *
n
;

1169 
z¿nge¥ec
 
¿nge
;

1170 
j
 = 0;

1172 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1173 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1175 
n
 = 
	`z¦Fœ¡InRªge
(
£rv”
.
şu¡”
->
¦Ùs_to_keys
, &
¿nge
);

1176 
n
 &&‚->
scÜe
 =ğ
hash¦Ù
) {

1177 
robj
 *
key
 = 
n
->
obj
;

1178 
n
 =‚->
Ëv–
[0].
fÜw¬d
;

1179 
	`šüRefCouÁ
(
key
);

1180 
	`dbD–‘e
(&
£rv”
.
db
[0],
key
);

1181 
	`deüRefCouÁ
(
key
);

1182 
j
++;

1184  
j
;

1185 
	}
}

1187 
	$couÁKeysInSlÙ
(
hash¦Ù
) {

1188 
zskli¡
 *
z¦
 = 
£rv”
.
şu¡”
->
¦Ùs_to_keys
;

1189 
zskli¡Node
 *
zn
;

1190 
z¿nge¥ec
 
¿nge
;

1191 
¿nk
, 
couÁ
 = 0;

1193 
¿nge
.
mš
 =„ªge.
max
 = 
hash¦Ù
;

1194 
¿nge
.
mšex
 =„ªge.
maxex
 = 0;

1197 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

1200 ià(
zn
 !ğ
NULL
) {

1201 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

1202 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

1205 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

1208 ià(
zn
 !ğ
NULL
) {

1209 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

1210 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

1213  
couÁ
;

1214 
	}
}

	@debug.c

30 
	~"»dis.h
"

31 
	~"sha1.h
"

32 
	~"üc64.h
"

34 
	~<¬·/š‘.h
>

35 
	~<sigÇl.h
>

37 #ifdeà
HAVE_BACKTRACE


38 
	~<execšfo.h
>

39 
	~<ucÚ‹xt.h
>

40 
	~<fú.h
>

41 
	~"bio.h
"

44 #ifdeà
__CYGWIN__


45 #iâdeà
SA_ONSTACK


46 
	#SA_ONSTACK
 0x08000000

	)

58 
	$xÜDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

59 
SHA1_CTX
 
ùx
;

60 
hash
[20], *
s
 = 
±r
;

61 
j
;

63 
	`SHA1In™
(&
ùx
);

64 
	`SHA1Upd©e
(&
ùx
,
s
,
Ën
);

65 
	`SHA1Fš®
(
hash
,&
ùx
);

67 
j
 = 0; j < 20; j++)

68 
dige¡
[
j
] ^ğ
hash
[j];

69 
	}
}

71 
	$xÜObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

72 
o
 = 
	`g‘DecodedObjeù
(o);

73 
	`xÜDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

74 
	`deüRefCouÁ
(
o
);

75 
	}
}

91 
	$mixDige¡
(*
dige¡
, *
±r
, 
size_t
 
Ën
) {

92 
SHA1_CTX
 
ùx
;

93 *
s
 = 
±r
;

95 
	`xÜDige¡
(
dige¡
,
s
,
Ën
);

96 
	`SHA1In™
(&
ùx
);

97 
	`SHA1Upd©e
(&
ùx
,
dige¡
,20);

98 
	`SHA1Fš®
(
dige¡
,&
ùx
);

99 
	}
}

101 
	$mixObjeùDige¡
(*
dige¡
, 
robj
 *
o
) {

102 
o
 = 
	`g‘DecodedObjeù
(o);

103 
	`mixDige¡
(
dige¡
,
o
->
±r
,
	`sd¦’
(o->ptr));

104 
	`deüRefCouÁ
(
o
);

105 
	}
}

113 
	$compu‹D©a£tDige¡
(*
fš®
) {

114 
dige¡
[20];

115 
buf
[128];

116 
diùI‹¿tÜ
 *
di
 = 
NULL
;

117 
diùEÁry
 *
de
;

118 
j
;

119 
ušt32_t
 
aux
;

121 
	`mem£t
(
fš®
,0,20);

123 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

124 
»disDb
 *
db
 = 
£rv”
.db+
j
;

126 ià(
	`diùSize
(
db
->
diù
) == 0) ;

127 
di
 = 
	`diùG‘I‹¿tÜ
(
db
->
diù
);

131 
aux
 = 
	`htÚl
(
j
);

132 
	`mixDige¡
(
fš®
,&
aux
,(aux));

135 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

136 
sds
 
key
;

137 
robj
 *
keyobj
, *
o
;

138 
expœ‘ime
;

140 
	`mem£t
(
dige¡
,0,20);

141 
key
 = 
	`diùG‘Key
(
de
);

142 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

144 
	`mixDige¡
(
dige¡
,
key
,
	`sd¦’
(key));

146 
o
 = 
	`diùG‘V®
(
de
);

148 
aux
 = 
	`htÚl
(
o
->
ty³
);

149 
	`mixDige¡
(
dige¡
,&
aux
,(aux));

150 
expœ‘ime
 = 
	`g‘Expœe
(
db
,
keyobj
);

153 ià(
o
->
ty³
 =ğ
REDIS_STRING
) {

154 
	`mixObjeùDige¡
(
dige¡
,
o
);

155 } ià(
o
->
ty³
 =ğ
REDIS_LIST
) {

156 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
o
,0,
REDIS_TAIL
);

157 
li¡Ty³EÁry
 
’Œy
;

158 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

159 
robj
 *
–eobj
 = 
	`li¡Ty³G‘
(&
’Œy
);

160 
	`mixObjeùDige¡
(
dige¡
,
–eobj
);

161 
	`deüRefCouÁ
(
–eobj
);

163 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

164 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

165 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
o
);

166 
robj
 *
–e
;

167 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

168 
	`xÜObjeùDige¡
(
dige¡
,
–e
);

169 
	`deüRefCouÁ
(
–e
);

171 
	`£tTy³R–—£I‹¿tÜ
(
si
);

172 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
) {

173 
–edige¡
[20];

175 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

176 *
zl
 = 
o
->
±r
;

177 *
•Œ
, *
¥Œ
;

178 *
v¡r
;

179 
vËn
;

180 
vÎ
;

181 
scÜe
;

183 
•Œ
 = 
	`zli¡Index
(
zl
,0);

184 
	`»disAs£¹
(
•Œ
 !ğ
NULL
);

185 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

186 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

188 
•Œ
 !ğ
NULL
) {

189 
	`»disAs£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vÎ
));

190 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

192 
	`mem£t
(
–edige¡
,0,20);

193 ià(
v¡r
 !ğ
NULL
) {

194 
	`mixDige¡
(
–edige¡
,
v¡r
,
vËn
);

196 
	`Î2¡ršg
(
buf
,(buf),
vÎ
);

197 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

200 
	`¢´štf
(
buf
,(buf),"%.17g",
scÜe
);

201 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

202 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

203 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

205 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

206 
z£t
 *
zs
 = 
o
->
±r
;

207 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

208 
diùEÁry
 *
de
;

210 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

211 
robj
 *
–eobj
 = 
	`diùG‘Key
(
de
);

212 *
scÜe
 = 
	`diùG‘V®
(
de
);

214 
	`¢´štf
(
buf
,(buf),"%.17g",*
scÜe
);

215 
	`mem£t
(
–edige¡
,0,20);

216 
	`mixObjeùDige¡
(
–edige¡
,
–eobj
);

217 
	`mixDige¡
(
–edige¡
,
buf
,
	`¡¾’
(buf));

218 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

220 
	`diùR–—£I‹¿tÜ
(
di
);

222 
	`»disPªic
("Unknown sorted setƒncoding");

224 } ià(
o
->
ty³
 =ğ
REDIS_HASH
) {

225 
hashTy³I‹¿tÜ
 *
hi
;

226 
robj
 *
obj
;

228 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

229 
	`hashTy³Next
(
hi
è!ğ
REDIS_ERR
) {

230 
–edige¡
[20];

232 
	`mem£t
(
–edige¡
,0,20);

233 
obj
 = 
	`hashTy³Cu¼’tObjeù
(
hi
,
REDIS_HASH_KEY
);

234 
	`mixObjeùDige¡
(
–edige¡
,
obj
);

235 
	`deüRefCouÁ
(
obj
);

236 
obj
 = 
	`hashTy³Cu¼’tObjeù
(
hi
,
REDIS_HASH_VALUE
);

237 
	`mixObjeùDige¡
(
–edige¡
,
obj
);

238 
	`deüRefCouÁ
(
obj
);

239 
	`xÜDige¡
(
dige¡
,
–edige¡
,20);

241 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

243 
	`»disPªic
("Unknown objectype");

246 ià(
expœ‘ime
 !ğ-1è
	`xÜDige¡
(
dige¡
,"!!expire!!",10);

248 
	`xÜDige¡
(
fš®
,
dige¡
,20);

249 
	`deüRefCouÁ
(
keyobj
);

251 
	`diùR–—£I‹¿tÜ
(
di
);

253 
	}
}

255 
	$debugCommªd
(
»disCl›Á
 *
c
) {

256 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"segfault")) {

258 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"oom")) {

259 *
±r
 = 
	`zm®loc
(
ULONG_MAX
);

260 
	`zä“
(
±r
);

261 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

262 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"assert")) {

263 ià(
c
->
¬gc
 >ğ3èc->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

264 
	`»disAs£¹W™hInfo
(
c
,c->
¬gv
[0],1 == 2);

265 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reload")) {

266 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è!ğ
REDIS_OK
) {

267 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

270 
	`em±yDb
(
NULL
);

271 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è!ğ
REDIS_OK
) {

272 
	`addR•lyE¼Ü
(
c
,"Errorryingo†oadhe RDB dump");

275 
	`»disLog
(
REDIS_WARNING
,"DB„eloaded by DEBUG RELOAD");

276 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

277 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"loadaof")) {

278 
	`em±yDb
(
NULL
);

279 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è!ğ
REDIS_OK
) {

280 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

283 
£rv”
.
dœty
 = 0;

284 
	`»disLog
(
REDIS_WARNING
,"Append Only File†oaded by DEBUG LOADAOF");

285 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

286 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"objeù"è&& c->
¬gc
 == 3) {

287 
diùEÁry
 *
de
;

288 
robj
 *
v®
;

289 *
¡»nc
;

291 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

292 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

295 
v®
 = 
	`diùG‘V®
(
de
);

296 
¡»nc
 = 
	`¡rEncodšg
(
v®
->
’codšg
);

298 
	`addR•lyStusFÜm©
(
c
,

302 (*)
v®
, v®->
»fcouÁ
,

303 
¡»nc
, (è
	`rdbSavedObjeùL’
(
v®
),

304 
v®
->
Ìu
, 
	`e¡im©eObjeùIdËTime
(val)/1000);

305 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sd¦’"è&& c->
¬gc
 == 3) {

306 
diùEÁry
 *
de
;

307 
robj
 *
v®
;

308 
sds
 
key
;

310 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,c->
¬gv
[2]->
±r
)è=ğ
NULL
) {

311 
	`addR•ly
(
c
,
sh¬ed
.
nokey”r
);

314 
v®
 = 
	`diùG‘V®
(
de
);

315 
key
 = 
	`diùG‘Key
(
de
);

317 ià(
v®
->
ty³
 !ğ
REDIS_STRING
 || !
	`sdsEncodedObjeù
(val)) {

318 
	`addR•lyE¼Ü
(
c
,"Not‡n sdsƒncoded string.");

320 
	`addR•lyStusFÜm©
(
c
,

323 (è
	`sd¦’
(
key
),

324 (è
	`sd§va
(
key
),

325 (è
	`sd¦’
(
v®
->
±r
),

326 (è
	`sd§va
(
v®
->
±r
));

328 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"populate") &&

329 (
c
->
¬gc
 == 3 || c->argc == 4)) {

330 
keys
, 
j
;

331 
robj
 *
key
, *
v®
;

332 
buf
[128];

334 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
keys
, 
NULL
è!ğ
REDIS_OK
)

336 
	`diùEx·nd
(
c
->
db
->
diù
,
keys
);

337 
j
 = 0; j < 
keys
; j++) {

338 
	`¢´štf
(
buf
,(buf),"%s:%lu",

339 (
c
->
¬gc
 =ğ3è? "key" : (*)c->
¬gv
[3]->
±r
, 
j
);

340 
key
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

341 ià(
	`lookupKeyR—d
(
c
->
db
,
key
è!ğ
NULL
) {

342 
	`deüRefCouÁ
(
key
);

345 
	`¢´štf
(
buf
,(buf),"v®ue:%lu",
j
);

346 
v®
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

347 
	`dbAdd
(
c
->
db
,
key
,
v®
);

348 
	`deüRefCouÁ
(
key
);

350 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

351 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"dige¡"è&& c->
¬gc
 == 2) {

352 
dige¡
[20];

353 
sds
 
d
 = 
	`sd£m±y
();

354 
j
;

356 
	`compu‹D©a£tDige¡
(
dige¡
);

357 
j
 = 0; j < 20; j++)

358 
d
 = 
	`sdsÿrštf
(d, "%02x",
dige¡
[
j
]);

359 
	`addR•lyStus
(
c
,
d
);

360 
	`sdsä“
(
d
);

361 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"¦“p"è&& c->
¬gc
 == 3) {

362 
dtime
 = 
	`¡¹od
(
c
->
¬gv
[2]->
±r
,
NULL
);

363 
utime
 = 
dtime
*1000000;

364 
time¥ec
 
tv
;

366 
tv
.
tv_£c
 = 
utime
 / 1000000;

367 
tv
.
tv_n£c
 = (
utime
 % 1000000) * 1000;

368 
	`Çno¦“p
(&
tv
, 
NULL
);

369 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

370 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set-active-expire") &&

371 
c
->
¬gc
 == 3)

373 
£rv”
.
aùive_expœe_’abËd
 = 
	`©oi
(
c
->
¬gv
[2]->
±r
);

374 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

375 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"”rÜ"è&& c->
¬gc
 == 3) {

376 
sds
 
”r¡r
 = 
	`sd¢ewËn
("-",1);

378 
”r¡r
 = 
	`sdsÿtsds
Ó¼¡r,
c
->
¬gv
[2]->
±r
);

379 
”r¡r
 = 
	`sdsm­ch¬s
(errstr,"\n\r"," ",2);

380 
”r¡r
 = 
	`sdsÿ’
(errstr,"\r\n",2);

381 
	`addR•lySds
(
c
,
”r¡r
);

383 
	`addR•lyE¼ÜFÜm©
(
c
, "Unknown DEBUG subcommand or wrong‚umber of‡rguments for '%s'",

384 (*)
c
->
¬gv
[1]->
±r
);

386 
	}
}

390 
	$_»disAs£¹
(*
e¡r
, *
fe
, 
lše
) {

391 
	`bugR•ÜtS¹
();

392 
	`»disLog
(
REDIS_WARNING
,"=== ASSERTION FAILED ===");

393 
	`»disLog
(
REDIS_WARNING
,"==> %s:%d '%s' i nÙrue",
fe
,
lše
,
e¡r
);

394 #ifdeà
HAVE_BACKTRACE


395 
£rv”
.
as£¹_çed
 = 
e¡r
;

396 
£rv”
.
as£¹_fe
 = 
fe
;

397 
£rv”
.
as£¹_lše
 = 
lše
;

398 
	`»disLog
(
REDIS_WARNING
,"(forcing SIGSEGVo…rinthe bug„eport.)");

401 
	}
}

403 
	$_»disAs£¹PrštCl›ÁInfo
(
»disCl›Á
 *
c
) {

404 
j
;

406 
	`bugR•ÜtS¹
();

407 
	`»disLog
(
REDIS_WARNING
,"=== ASSERTION FAILED CLIENT CONTEXT ===");

408 
	`»disLog
(
REDIS_WARNING
,"ş›Á->æag ğ%d", 
c
->
æags
);

409 
	`»disLog
(
REDIS_WARNING
,"ş›Á->fd = %d", 
c
->
fd
);

410 
	`»disLog
(
REDIS_WARNING
,"ş›Á->¬gøğ%d", 
c
->
¬gc
);

411 
j
=0; j < 
c
->
¬gc
; j++) {

412 
buf
[128];

413 *
¬g
;

415 ià(
c
->
¬gv
[
j
]->
ty³
 =ğ
REDIS_STRING
 && 
	`sdsEncodedObjeù
(c->argv[j])) {

416 
¬g
 = (*è
c
->
¬gv
[
j
]->
±r
;

418 
	`¢´štf
(
buf
,(buf),"Objectype: %d,ƒncoding: %d",

419 
c
->
¬gv
[
j
]->
ty³
, c->¬gv[j]->
’codšg
);

420 
¬g
 = 
buf
;

422 
	`»disLog
(
REDIS_WARNING
,"client->argv[%d] = \"%s\" (refcount: %d)",

423 
j
, 
¬g
, 
c
->
¬gv
[j]->
»fcouÁ
);

425 
	}
}

427 
	$»disLogObjeùDebugInfo
(
robj
 *
o
) {

428 
	`»disLog
(
REDIS_WARNING
,"Objeùy³: %d", 
o
->
ty³
);

429 
	`»disLog
(
REDIS_WARNING
,"Objeùƒncodšg: %d", 
o
->
’codšg
);

430 
	`»disLog
(
REDIS_WARNING
,"Objeù„efcouÁ: %d", 
o
->
»fcouÁ
);

431 ià(
o
->
ty³
 =ğ
REDIS_STRING
 && 
	`sdsEncodedObjeù
(o)) {

432 
	`»disLog
(
REDIS_WARNING
,"Objeù„aw sŒšg†’: %zu", 
	`sd¦’
(
o
->
±r
));

433 ià(
	`sd¦’
(
o
->
±r
) < 4096) {

434 
sds
 
»´
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
o
->
±r
,
	`sd¦’
(o->ptr));

435 
	`»disLog
(
REDIS_WARNING
,"Objeù„aw sŒšg cÚ‹Á: %s", 
»´
);

436 
	`sdsä“
(
»´
);

438 } ià(
o
->
ty³
 =ğ
REDIS_LIST
) {

439 
	`»disLog
(
REDIS_WARNING
,"Li¡†’gth: %d", (è
	`li¡Ty³L’gth
(
o
));

440 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

441 
	`»disLog
(
REDIS_WARNING
,"S‘ size: %d", (è
	`£tTy³Size
(
o
));

442 } ià(
o
->
ty³
 =ğ
REDIS_HASH
) {

443 
	`»disLog
(
REDIS_WARNING
,"Hash size: %d", (è
	`hashTy³L’gth
(
o
));

444 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
) {

445 
	`»disLog
(
REDIS_WARNING
,"SÜ‹d s‘ size: %d", (è
	`z£tL’gth
(
o
));

446 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
)

447 
	`»disLog
(
REDIS_WARNING
,"Skli¡†ev–: %d", (è((
z£t
*)
o
->
±r
)->
z¦
->
Ëv–
);

449 
	}
}

451 
	$_»disAs£¹PrštObjeù
(
robj
 *
o
) {

452 
	`bugR•ÜtS¹
();

453 
	`»disLog
(
REDIS_WARNING
,"=== ASSERTION FAILED OBJECT CONTEXT ===");

454 
	`»disLogObjeùDebugInfo
(
o
);

455 
	}
}

457 
	$_»disAs£¹W™hInfo
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
e¡r
, *
fe
, 
lše
) {

458 ià(
c
è
	`_»disAs£¹PrštCl›ÁInfo
(c);

459 ià(
o
è
	`_»disAs£¹PrštObjeù
(o);

460 
	`_»disAs£¹
(
e¡r
,
fe
,
lše
);

461 
	}
}

463 
	$_»disPªic
(*
msg
, *
fe
, 
lše
) {

464 
	`bugR•ÜtS¹
();

465 
	`»disLog
(
REDIS_WARNING
,"------------------------------------------------");

466 
	`»disLog
(
REDIS_WARNING
,"!!! Software Failure. Press†eft mouse buttono continue");

467 
	`»disLog
(
REDIS_WARNING
,"Guru Med™©iÚ: % #%s:%d",
msg
,
fe
,
lše
);

468 #ifdeà
HAVE_BACKTRACE


469 
	`»disLog
(
REDIS_WARNING
,"(forcing SIGSEGV in ordero…rinthe stackrace)");

471 
	`»disLog
(
REDIS_WARNING
,"------------------------------------------------");

473 
	}
}

475 
	$bugR•ÜtS¹
() {

476 ià(
£rv”
.
bug_»pÜt_¡¬t
 == 0) {

477 
	`»disLog
(
REDIS_WARNING
,

479 
£rv”
.
bug_»pÜt_¡¬t
 = 1;

481 
	}
}

483 #ifdeà
HAVE_BACKTRACE


484 *
	$g‘McÚ‹xtE
(
ucÚ‹xt_t
 *
uc
) {

485 #ià
	`defšed
(
__APPLE__
è&& !defšed(
MAC_OS_X_VERSION_10_6
)

487 #ià
	`defšed
(
__x86_64__
)

488  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

489 #–ià
	`defšed
(
__i386__
)

490  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

492  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¤r0
;

494 #–ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

496 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

497  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
;

499  (*è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
;

501 #–ià
	`defšed
(
__lšux__
)

503 #ià
	`defšed
(
__i386__
)

504  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[14];

505 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

506  (*è
uc
->
uc_mcÚ‹xt
.
g»gs
[16];

507 #–ià
	`defšed
(
__Ÿ64__
)

508  (*è
uc
->
uc_mcÚ‹xt
.
sc_
;

511  
NULL
;

513 
	}
}

515 
	$logSckCÚ‹Á
(**
¥
) {

516 
i
;

517 
i
 = 15; i >= 0; i--) {

518 
addr
 = (è
¥
+
i
;

519 
v®
 = (è
¥
[
i
];

522 
	`»disLog
(
REDIS_WARNING
, "(%08lxè-> %08lx", 
addr
, 
v®
);

524 
	`»disLog
(
REDIS_WARNING
, "(%016lxè-> %016lx", 
addr
, 
v®
);

526 
	}
}

528 
	$logRegi¡”s
(
ucÚ‹xt_t
 *
uc
) {

529 
	`»disLog
(
REDIS_WARNING
, "--- REGISTERS");

532 #ià
	`defšed
(
__APPLE__
è&& defšed(
MAC_OS_X_VERSION_10_6
)

534 #ià
	`defšed
(
_STRUCT_X86_THREAD_STATE64
è&& !defšed(
__i386__
)

535 
	`»disLog
(
REDIS_WARNING
,

542 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__¿x
,

543 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbx
,

544 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rcx
,

545 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdx
,

546 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rdi
,

547 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rsi
,

548 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__rbp
,

549 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
,

550 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r8
,

551 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r9
,

552 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r10
,

553 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r11
,

554 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r12
,

555 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r13
,

556 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r14
,

557 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r15
,

558 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__r
,

559 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ræags
,

560 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

561 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

562 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


564 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__r¥
);

567 
	`»disLog
(
REDIS_WARNING
,

573 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__—x
,

574 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebx
,

575 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ecx
,

576 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edx
,

577 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__edi
,

578 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__esi
,

579 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ebp
,

580 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
,

581 (è
uc
->
uc_mcÚ‹xt
->
__ss
.__ss,

582 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__eæags
,

583 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__e
,

584 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__cs
,

585 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__ds
,

586 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__es
,

587 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__fs
,

588 (è
uc
->
uc_mcÚ‹xt
->
__ss
.
__gs


590 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
->
__ss
.
__e¥
);

593 #–ià
	`defšed
(
__lšux__
)

595 #ià
	`defšed
(
__i386__
)

596 
	`»disLog
(
REDIS_WARNING
,

602 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

603 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

604 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

605 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

606 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

607 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

608 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

609 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

610 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18],

611 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

612 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

613 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

614 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

615 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

616 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

617 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0]

619 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[7]);

620 #–ià
	`defšed
(
__X86_64__
è|| defšed(
__x86_64__
)

622 
	`»disLog
(
REDIS_WARNING
,

629 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[13],

630 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[11],

631 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[14],

632 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[12],

633 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[8],

634 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[9],

635 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[10],

636 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[15],

637 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[0],

638 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[1],

639 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[2],

640 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[3],

641 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[4],

642 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[5],

643 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[6],

644 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[7],

645 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[16],

646 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[17],

647 (è
uc
->
uc_mcÚ‹xt
.
g»gs
[18]

649 
	`logSckCÚ‹Á
((**)
uc
->
uc_mcÚ‹xt
.
g»gs
[15]);

652 
	`»disLog
(
REDIS_WARNING
,

655 
	}
}

659 
	$logSckT¿û
(
ucÚ‹xt_t
 *
uc
) {

660 *
Œaû
[100];

661 
Œaû_size
 = 0, 
fd
;

662 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

665 
fd
 = 
log_to_¡dout
 ?

666 
STDOUT_FILENO
 :

667 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

668 ià(
fd
 == -1) ;

671 
Œaû_size
 = 
	`backŒaû
(
Œaû
, 100);

674 ià(
	`g‘McÚ‹xtE
(
uc
è!ğ
NULL
)

675 
Œaû
[1] = 
	`g‘McÚ‹xtE
(
uc
);

678 
	`backŒaû_symbŞs_fd
(
Œaû
, 
Œaû_size
, 
fd
);

681 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

682 
	}
}

687 
	$logCu¼’tCl›Á
() {

688 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
NULL
) ;

690 
»disCl›Á
 *
cc
 = 
£rv”
.
cu¼’t_ş›Á
;

691 
sds
 
ş›Á
;

692 
j
;

694 
	`»disLog
(
REDIS_WARNING
, "--- CURRENT CLIENT INFO");

695 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
cc
);

696 
	`»disLog
(
REDIS_WARNING
,"ş›Á: %s", 
ş›Á
);

697 
	`sdsä“
(
ş›Á
);

698 
j
 = 0; j < 
cc
->
¬gc
; j++) {

699 
robj
 *
decoded
;

701 
decoded
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[
j
]);

702 
	`»disLog
(
REDIS_WARNING
,"¬gv[%d]: '%s'", 
j
, (*)
decoded
->
±r
);

703 
	`deüRefCouÁ
(
decoded
);

707 ià(
cc
->
¬gc
 >= 1) {

708 
robj
 *
v®
, *
key
;

709 
diùEÁry
 *
de
;

711 
key
 = 
	`g‘DecodedObjeù
(
cc
->
¬gv
[1]);

712 
de
 = 
	`diùFšd
(
cc
->
db
->
diù
, 
key
->
±r
);

713 ià(
de
) {

714 
v®
 = 
	`diùG‘V®
(
de
);

715 
	`»disLog
(
REDIS_WARNING
,"key '%s' found iÀDB cÚššghfŞlowšg objeù:", (*)
key
->
±r
);

716 
	`»disLogObjeùDebugInfo
(
v®
);

718 
	`deüRefCouÁ
(
key
);

720 
	}
}

722 #ià
defšed
(
HAVE_PROC_MAPS
)

723 
mem‹¡_nÚ_de¡ruùive_šv”t
(*
addr
, 
size_t
 
size
);

724 
mem‹¡_nÚ_de¡ruùive_sw­
(*
addr
, 
size_t
 
size
);

725 
	#MEMTEST_MAX_REGIONS
 128

	)

727 
	$mem‹¡_‹¡_lšux_ªÚymous_m­s
() {

728 
FILE
 *
å
 = 
	`fİ’
("/proc/self/maps","r");

729 
lše
[1024];

730 
size_t
 
¡¬t_addr
, 
’d_addr
, 
size
;

731 
size_t
 
¡¬t_veù
[
MEMTEST_MAX_REGIONS
];

732 
size_t
 
size_veù
[
MEMTEST_MAX_REGIONS
];

733 
»giÚs
 = 0, 
j
;

734 
ušt64_t
 
üc1
 = 0, 
üc2
 = 0, 
üc3
 = 0;

736 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

737 *
¡¬t
, *
’d
, *
p
 = 
lše
;

739 
¡¬t
 = 
p
;

740 
p
 = 
	`¡rchr
(p,'-');

741 ià(!
p
) ;

742 *
p
++ = '\0';

743 
’d
 = 
p
;

744 
p
 = 
	`¡rchr
(p,' ');

745 ià(!
p
) ;

746 *
p
++ = '\0';

747 ià(
	`¡r¡r
(
p
,"stack") ||

748 
	`¡r¡r
(
p
,"vdso") ||

749 
	`¡r¡r
(
p
,"vsyscall")) ;

750 ià(!
	`¡r¡r
(
p
,"00:00")) ;

751 ià(!
	`¡r¡r
(
p
,"rw")) ;

753 
¡¬t_addr
 = 
	`¡¹oul
(
¡¬t
,
NULL
,16);

754 
’d_addr
 = 
	`¡¹oul
(
’d
,
NULL
,16);

755 
size
 = 
’d_addr
-
¡¬t_addr
;

757 
¡¬t_veù
[
»giÚs
] = 
¡¬t_addr
;

758 
size_veù
[
»giÚs
] = 
size
;

759 
	`´štf
("Te¡šg %lx %lu\n", (è
¡¬t_veù
[
»giÚs
],

760 (è
size_veù
[
»giÚs
]);

761 
»giÚs
++;

766 
j
 = 0; j < 
»giÚs
; j++) {

767 
üc1
 = 
	`üc64
(üc1,(*)
¡¬t_veù
[
j
],
size_veù
[j]);

772 
j
 = 0; j < 
»giÚs
; j++)

773 
	`mem‹¡_nÚ_de¡ruùive_šv”t
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

774 
j
 = 0; j < 
»giÚs
; j++)

775 
	`mem‹¡_nÚ_de¡ruùive_sw­
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

776 
j
 = 0; j < 
»giÚs
; j++)

777 
	`mem‹¡_nÚ_de¡ruùive_sw­
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

778 
j
 = 0; j < 
»giÚs
; j++)

779 
	`mem‹¡_nÚ_de¡ruùive_šv”t
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

782 
j
 = 0; j < 
»giÚs
; j++)

783 
üc2
 = 
	`üc64
(üc2,(*)
¡¬t_veù
[
j
],
size_veù
[j]);

786 
j
 = 0; j < 
»giÚs
; j++)

787 
	`mem‹¡_nÚ_de¡ruùive_sw­
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

788 
j
 = 0; j < 
»giÚs
; j++)

789 
	`mem‹¡_nÚ_de¡ruùive_sw­
((*)
¡¬t_veù
[
j
],
size_veù
[j]);

792 
j
 = 0; j < 
»giÚs
; j++)

793 
üc3
 = 
	`üc64
(üc3,(*)
¡¬t_veù
[
j
],
size_veù
[j]);

798 
	`fşo£
(
å
);

801  
üc1
 !ğ
üc2
 || crc2 !ğ
üc3
;

802 
	}
}

805 
	$sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

806 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

807 
sds
 
šfo¡ršg
, 
ş›Ás
;

808 
sigaùiÚ
 
aù
;

809 
	`REDIS_NOTUSED
(
šfo
);

811 
	`bugR•ÜtS¹
();

812 
	`»disLog
(
REDIS_WARNING
,

813 " Redi % üashed by sigÇl: %d", 
REDIS_VERSION
, 
sig
);

814 
	`»disLog
(
REDIS_WARNING
,

815 " Faed‡s£¹iÚ: % (%s:%d)", 
£rv”
.
as£¹_çed
,

816 
£rv”
.
as£¹_fe
, s”v”.
as£¹_lše
);

819 
	`»disLog
(
REDIS_WARNING
, "--- STACK TRACE");

820 
	`logSckT¿û
(
uc
);

823 
	`»disLog
(
REDIS_WARNING
, "--- INFO OUTPUT");

824 
šfo¡ršg
 = 
	`g’RedisInfoSŒšg
("all");

825 
šfo¡ršg
 = 
	`sdsÿrštf
(infostring, "hash_init_value: %u\n",

826 
	`diùG‘HashFunùiÚS“d
());

827 
	`»disLogRaw
(
REDIS_WARNING
, 
šfo¡ršg
);

828 
	`»disLog
(
REDIS_WARNING
, "--- CLIENT LIST OUTPUT");

829 
ş›Ás
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

830 
	`»disLogRaw
(
REDIS_WARNING
, 
ş›Ás
);

831 
	`sdsä“
(
šfo¡ršg
);

832 
	`sdsä“
(
ş›Ás
);

835 
	`logCu¼’tCl›Á
();

838 
	`logRegi¡”s
(
uc
);

840 #ià
	`defšed
(
HAVE_PROC_MAPS
)

842 
	`»disLog
(
REDIS_WARNING
, "--- FAST MEMORY TEST");

843 
	`bioKlTh»ads
();

844 ià(
	`mem‹¡_‹¡_lšux_ªÚymous_m­s
()) {

845 
	`»disLog
(
REDIS_WARNING
,

848 
	`»disLog
(
REDIS_WARNING
,

853 
	`»disLog
(
REDIS_WARNING
,

860 ià(
£rv”
.
d«mÚize
è
	`uÆšk
(£rv”.
pidfe
);

864 
	`sigem±y£t
 (&
aù
.
§_mask
);

865 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_ONSTACK
 | 
SA_RESETHAND
;

866 
aù
.
§_hªdËr
 = 
SIG_DFL
;

867 
	`sigaùiÚ
 (
sig
, &
aù
, 
NULL
);

868 
	`kl
(
	`g‘pid
(),
sig
);

869 
	}
}

874 
	$»disLogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
) {

875 
buf
[65], *
b
;

876 *
v
 = 
v®ue
;

877 
ch¬£t
[] = "0123456789abcdef";

879 
	`»disLog
(
Ëv–
,"% (hexdump):", 
desü
);

880 
b
 = 
buf
;

881 
Ën
) {

882 
b
[0] = 
ch¬£t
[(*
v
)>>4];

883 
b
[1] = 
ch¬£t
[(*
v
)&0xf];

884 
b
[2] = '\0';

885 
b
 += 2;

886 
Ën
--;

887 
v
++;

888 ià(
b
-
buf
 =ğ64 || 
Ën
 == 0) {

889 
	`»disLogRaw
(
Ëv–
|
REDIS_LOG_RAW
,
buf
);

890 
b
 = 
buf
;

893 
	`»disLogRaw
(
Ëv–
|
REDIS_LOG_RAW
,"\n");

894 
	}
}

897 
	~<sys/time.h
>

899 
	$w©chdogSigÇlHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
) {

900 #ifdeà
HAVE_BACKTRACE


901 
ucÚ‹xt_t
 *
uc
 = (ucÚ‹xt_t*è
£ü‘
;

903 
	`REDIS_NOTUSED
(
šfo
);

904 
	`REDIS_NOTUSED
(
sig
);

906 
	`»disLogFromHªdËr
(
REDIS_WARNING
,"\n--- WATCHDOG TIMER EXPIRED ---");

907 #ifdeà
HAVE_BACKTRACE


908 
	`logSckT¿û
(
uc
);

910 
	`»disLogFromHªdËr
(
REDIS_WARNING
,"Sorry:‚o support for backtrace().");

912 
	`»disLogFromHªdËr
(
REDIS_WARNING
,"--------\n");

913 
	}
}

918 
	$w©chdogScheduËSigÇl
(
³riod
) {

919 
™im”v®
 
™
;

922 
™
.
™_v®ue
.
tv_£c
 = 
³riod
/1000;

923 
™
.
™_v®ue
.
tv_u£c
 = (
³riod
%1000)*1000;

925 
™
.
™_š‹rv®
.
tv_£c
 = 0;

926 
™
.
™_š‹rv®
.
tv_u£c
 = 0;

927 
	`£t™im”
(
ITIMER_REAL
, &
™
, 
NULL
);

928 
	}
}

931 
	$’abËW©chdog
(
³riod
) {

932 
mš_³riod
;

934 ià(
£rv”
.
w©chdog_³riod
 == 0) {

935 
sigaùiÚ
 
aù
;

939 
	`sigem±y£t
(&
aù
.
§_mask
);

940 
aù
.
§_æags
 = 
SA_ONSTACK
 | 
SA_SIGINFO
;

941 
aù
.
§_sigaùiÚ
 = 
w©chdogSigÇlHªdËr
;

942 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

947 
mš_³riod
 = (1000/
£rv”
.
hz
)*2;

948 ià(
³riod
 < 
mš_³riod
)…eriod = min_period;

949 
	`w©chdogScheduËSigÇl
(
³riod
);

950 
£rv”
.
w©chdog_³riod
 = 
³riod
;

951 
	}
}

954 
	$di§bËW©chdog
() {

955 
sigaùiÚ
 
aù
;

956 ià(
£rv”
.
w©chdog_³riod
 == 0) ;

957 
	`w©chdogScheduËSigÇl
(0);

961 
	`sigem±y£t
(&
aù
.
§_mask
);

962 
aù
.
§_æags
 = 0;

963 
aù
.
§_hªdËr
 = 
SIG_IGN
;

964 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

965 
£rv”
.
w©chdog_³riod
 = 0;

966 
	}
}

	@dict.c

36 
	~"fmaüos.h
"

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<¡ršg.h
>

41 
	~<¡d¬g.h
>

42 
	~<lim™s.h
>

43 
	~<sys/time.h
>

44 
	~<ùy³.h
>

46 
	~"diù.h
"

47 
	~"zm®loc.h
"

48 
	~"»di§s£¹.h
"

58 
	gdiù_ÿn_»size
 = 1;

59 
	gdiù_fÜû_»size_¿tio
 = 5;

63 
_diùEx·ndIfN“ded
(
diù
 *
ht
);

64 
_diùNextPow”
(
size
);

65 
_diùKeyIndex
(
diù
 *
ht
, cÚ¡ *
key
);

66 
_diùIn™
(
diù
 *
ht
, 
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

71 
	$diùIÁHashFunùiÚ
(
key
)

73 
key
 += ~(key << 15);

74 
key
 ^= (key >> 10);

75 
key
 += (key << 3);

76 
key
 ^= (key >> 6);

77 
key
 += ~(key << 11);

78 
key
 ^= (key >> 16);

79  
key
;

80 
	}
}

82 
ušt32_t
 
	gdiù_hash_funùiÚ_£ed
 = 5381;

84 
	$diùS‘HashFunùiÚS“d
(
ušt32_t
 
£ed
) {

85 
diù_hash_funùiÚ_£ed
 = 
£ed
;

86 
	}
}

88 
ušt32_t
 
	$diùG‘HashFunùiÚS“d
() {

89  
diù_hash_funùiÚ_£ed
;

90 
	}
}

103 
	$diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
) {

106 
ušt32_t
 
£ed
 = 
diù_hash_funùiÚ_£ed
;

107 cÚ¡ 
ušt32_t
 
m
 = 0x5bd1e995;

108 cÚ¡ 
r
 = 24;

111 
ušt32_t
 
h
 = 
£ed
 ^ 
Ën
;

114 cÚ¡ *
d©a
 = (cÚ¡ *)
key
;

116 
Ën
 >= 4) {

117 
ušt32_t
 
k
 = *(ušt32_t*)
d©a
;

119 
k
 *ğ
m
;

120 
k
 ^ğk >> 
r
;

121 
k
 *ğ
m
;

123 
h
 *ğ
m
;

124 
h
 ^ğ
k
;

126 
d©a
 += 4;

127 
Ën
 -= 4;

131 
Ën
) {

132 3: 
h
 ^ğ
d©a
[2] << 16;

133 2: 
h
 ^ğ
d©a
[1] << 8;

134 1: 
h
 ^ğ
d©a
[0]; h *ğ
m
;

139 
h
 ^= h >> 13;

140 
h
 *ğ
m
;

141 
h
 ^= h >> 15;

143  ()
h
;

144 
	}
}

147 
	$diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
) {

148 
hash
 = ()
diù_hash_funùiÚ_£ed
;

150 
Ën
--)

151 
hash
 = ((hash << 5è+ hashè+ (
	`tŞow”
(*
buf
++));

152  
hash
;

153 
	}
}

159 
	$_diùRe£t
(
diùht
 *
ht
)

161 
ht
->
bË
 = 
NULL
;

162 
ht
->
size
 = 0;

163 
ht
->
sizemask
 = 0;

164 
ht
->
u£d
 = 0;

165 
	}
}

168 
diù
 *
	$diùC»©e
(
diùTy³
 *
ty³
,

169 *
´ivD©aPŒ
)

171 
diù
 *
d
 = 
	`zm®loc
((*d));

173 
	`_diùIn™
(
d
,
ty³
,
´ivD©aPŒ
);

174  
d
;

175 
	}
}

178 
	$_diùIn™
(
diù
 *
d
, 
diùTy³
 *
ty³
,

179 *
´ivD©aPŒ
)

181 
	`_diùRe£t
(&
d
->
ht
[0]);

182 
	`_diùRe£t
(&
d
->
ht
[1]);

183 
d
->
ty³
 =ype;

184 
d
->
´ivd©a
 = 
´ivD©aPŒ
;

185 
d
->
»hashidx
 = -1;

186 
d
->
™”©Üs
 = 0;

187  
DICT_OK
;

188 
	}
}

192 
	$diùResize
(
diù
 *
d
)

194 
mšim®
;

196 ià(!
diù_ÿn_»size
 || 
	`diùIsRehashšg
(
d
)è 
DICT_ERR
;

197 
mšim®
 = 
d
->
ht
[0].
u£d
;

198 ià(
mšim®
 < 
DICT_HT_INITIAL_SIZE
)

199 
mšim®
 = 
DICT_HT_INITIAL_SIZE
;

200  
	`diùEx·nd
(
d
, 
mšim®
);

201 
	}
}

204 
	$diùEx·nd
(
diù
 *
d
, 
size
)

206 
diùht
 
n
;

207 
»®size
 = 
	`_diùNextPow”
(
size
);

211 ià(
	`diùIsRehashšg
(
d
è|| d->
ht
[0].
u£d
 > 
size
)

212  
DICT_ERR
;

215 ià(
»®size
 =ğ
d
->
ht
[0].
size
è 
DICT_ERR
;

218 
n
.
size
 = 
»®size
;

219 
n
.
sizemask
 = 
»®size
-1;

220 
n
.
bË
 = 
	`zÿÎoc
(
»®size
*(
diùEÁry
*));

221 
n
.
u£d
 = 0;

225 ià(
d
->
ht
[0].
bË
 =ğ
NULL
) {

226 
d
->
ht
[0] = 
n
;

227  
DICT_OK
;

231 
d
->
ht
[1] = 
n
;

232 
d
->
»hashidx
 = 0;

233  
DICT_OK
;

234 
	}
}

245 
	$diùRehash
(
diù
 *
d
, 
n
) {

246 
em±y_vis™s
 = 
n
*10;

247 ià(!
	`diùIsRehashšg
(
d
))  0;

249 
n
-- && 
d
->
ht
[0].
u£d
 != 0) {

250 
diùEÁry
 *
de
, *
Ãxtde
;

254 
	`as£¹
(
d
->
ht
[0].
size
 > ()d->
»hashidx
);

255 
d
->
ht
[0].
bË
[d->
»hashidx
] =ğ
NULL
) {

256 
d
->
»hashidx
++;

257 ià(--
em±y_vis™s
 == 0)  1;

259 
de
 = 
d
->
ht
[0].
bË
[d->
»hashidx
];

261 
de
) {

262 
h
;

264 
Ãxtde
 = 
de
->
Ãxt
;

266 
h
 = 
	`diùHashKey
(
d
, 
de
->
key
è& d->
ht
[1].
sizemask
;

267 
de
->
Ãxt
 = 
d
->
ht
[1].
bË
[
h
];

268 
d
->
ht
[1].
bË
[
h
] = 
de
;

269 
d
->
ht
[0].
u£d
--;

270 
d
->
ht
[1].
u£d
++;

271 
de
 = 
Ãxtde
;

273 
d
->
ht
[0].
bË
[d->
»hashidx
] = 
NULL
;

274 
d
->
»hashidx
++;

278 ià(
d
->
ht
[0].
u£d
 == 0) {

279 
	`zä“
(
d
->
ht
[0].
bË
);

280 
d
->
ht
[0] = d->ht[1];

281 
	`_diùRe£t
(&
d
->
ht
[1]);

282 
d
->
»hashidx
 = -1;

288 
	}
}

290 
	$timeInMli£cÚds
() {

291 
timev®
 
tv
;

293 
	`g‘timeofday
(&
tv
,
NULL
);

294  ((()
tv
.
tv_£c
)*1000)+Ñv.
tv_u£c
/1000);

295 
	}
}

298 
	$diùRehashMli£cÚds
(
diù
 *
d
, 
ms
) {

299 
¡¬t
 = 
	`timeInMli£cÚds
();

300 
»hashes
 = 0;

302 
	`diùRehash
(
d
,100)) {

303 
»hashes
 += 100;

304 ià(
	`timeInMli£cÚds
()-
¡¬t
 > 
ms
) ;

306  
»hashes
;

307 
	}
}

317 
	$_diùRehashS‹p
(
diù
 *
d
) {

318 ià(
d
->
™”©Üs
 =ğ0è
	`diùRehash
(d,1);

319 
	}
}

322 
	$diùAdd
(
diù
 *
d
, *
key
, *
v®
)

324 
diùEÁry
 *
’Œy
 = 
	`diùAddRaw
(
d
,
key
);

326 ià(!
’Œy
è 
DICT_ERR
;

327 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

328  
DICT_OK
;

329 
	}
}

346 
diùEÁry
 *
	$diùAddRaw
(
diù
 *
d
, *
key
)

348 
šdex
;

349 
diùEÁry
 *
’Œy
;

350 
diùht
 *
ht
;

352 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

356 ià((
šdex
 = 
	`_diùKeyIndex
(
d
, 
key
)) == -1)

357  
NULL
;

360 
ht
 = 
	`diùIsRehashšg
(
d
) ? &d->ht[1] : &d->ht[0];

361 
’Œy
 = 
	`zm®loc
((*entry));

362 
’Œy
->
Ãxt
 = 
ht
->
bË
[
šdex
];

363 
ht
->
bË
[
šdex
] = 
’Œy
;

364 
ht
->
u£d
++;

367 
	`diùS‘Key
(
d
, 
’Œy
, 
key
);

368  
’Œy
;

369 
	}
}

375 
	$diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
)

377 
diùEÁry
 *
’Œy
, 
aux’Œy
;

381 ià(
	`diùAdd
(
d
, 
key
, 
v®
è=ğ
DICT_OK
)

384 
’Œy
 = 
	`diùFšd
(
d
, 
key
);

390 
aux’Œy
 = *
’Œy
;

391 
	`diùS‘V®
(
d
, 
’Œy
, 
v®
);

392 
	`diùF»eV®
(
d
, &
aux’Œy
);

394 
	}
}

402 
diùEÁry
 *
	$diùR•ÏûRaw
(
diù
 *
d
, *
key
) {

403 
diùEÁry
 *
’Œy
 = 
	`diùFšd
(
d
,
key
);

405  
’Œy
 ?ƒÁry : 
	`diùAddRaw
(
d
,
key
);

406 
	}
}

409 
	$diùG’”icD–‘e
(
diù
 *
d
, cÚ¡ *
key
, 
noä“
)

411 
h
, 
idx
;

412 
diùEÁry
 *
he
, *
´evHe
;

413 
bË
;

415 ià(
d
->
ht
[0].
size
 =ğ0è 
DICT_ERR
;

416 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

417 
h
 = 
	`diùHashKey
(
d
, 
key
);

419 
bË
 = 0;able <= 1;able++) {

420 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

421 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

422 
´evHe
 = 
NULL
;

423 
he
) {

424 ià(
	`diùCom·»Keys
(
d
, 
key
, 
he
->key)) {

426 ià(
´evHe
)

427 
´evHe
->
Ãxt
 = 
he
->next;

429 
d
->
ht
[
bË
].bË[
idx
] = 
he
->
Ãxt
;

430 ià(!
noä“
) {

431 
	`diùF»eKey
(
d
, 
he
);

432 
	`diùF»eV®
(
d
, 
he
);

434 
	`zä“
(
he
);

435 
d
->
ht
[
bË
].
u£d
--;

436  
DICT_OK
;

438 
´evHe
 = 
he
;

439 
he
 = he->
Ãxt
;

441 ià(!
	`diùIsRehashšg
(
d
)) ;

443  
DICT_ERR
;

444 
	}
}

446 
	$diùD–‘e
(
diù
 *
ht
, cÚ¡ *
key
) {

447  
	`diùG’”icD–‘e
(
ht
,
key
,0);

448 
	}
}

450 
	$diùD–‘eNoF»e
(
diù
 *
ht
, cÚ¡ *
key
) {

451  
	`diùG’”icD–‘e
(
ht
,
key
,1);

452 
	}
}

455 
_diùCË¬
(
diù
 *
d
, 
diùht
 *
ht
, (
ÿÎback
)(*)) {

456 
i
;

459 
i
 = 0; i < 
ht
->
size
 && ht->
u£d
 > 0; i++) {

460 
diùEÁry
 *
he
, *
ÃxtHe
;

462 ià(
ÿÎback
 && (
i
 & 65535è=ğ0è
	`ÿÎback
(
d
->
´ivd©a
);

464 ià((
he
 = 
ht
->
bË
[
i
]è=ğ
NULL
) ;

465 
he
) {

466 
ÃxtHe
 = 
he
->
Ãxt
;

467 
	`diùF»eKey
(
d
, 
he
);

468 
	`diùF»eV®
(
d
, 
he
);

469 
	`zä“
(
he
);

470 
ht
->
u£d
--;

471 
he
 = 
ÃxtHe
;

475 
	`zä“
(
ht
->
bË
);

477 
	`_diùRe£t
(
ht
);

478  
DICT_OK
;

479 
	}
}

482 
	$diùR–—£
(
diù
 *
d
)

484 
	`_diùCË¬
(
d
,&d->
ht
[0],
NULL
);

485 
	`_diùCË¬
(
d
,&d->
ht
[1],
NULL
);

486 
	`zä“
(
d
);

487 
	}
}

489 
diùEÁry
 *
	$diùFšd
(
diù
 *
d
, cÚ¡ *
key
)

491 
diùEÁry
 *
he
;

492 
h
, 
idx
, 
bË
;

494 ià(
d
->
ht
[0].
size
 =ğ0è 
NULL
;

495 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

496 
h
 = 
	`diùHashKey
(
d
, 
key
);

497 
bË
 = 0;able <= 1;able++) {

498 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

499 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

500 
he
) {

501 ià(
	`diùCom·»Keys
(
d
, 
key
, 
he
->key))

502  
he
;

503 
he
 = he->
Ãxt
;

505 ià(!
	`diùIsRehashšg
(
d
)è 
NULL
;

507  
NULL
;

508 
	}
}

510 *
	$diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
) {

511 
diùEÁry
 *
he
;

513 
he
 = 
	`diùFšd
(
d
,
key
);

514  
he
 ? 
	`diùG‘V®
(heè: 
NULL
;

515 
	}
}

523 
	$diùFšg”´št
(
diù
 *
d
) {

524 
š‹g”s
[6], 
hash
 = 0;

525 
j
;

527 
š‹g”s
[0] = (è
d
->
ht
[0].
bË
;

528 
š‹g”s
[1] = 
d
->
ht
[0].
size
;

529 
š‹g”s
[2] = 
d
->
ht
[0].
u£d
;

530 
š‹g”s
[3] = (è
d
->
ht
[1].
bË
;

531 
š‹g”s
[4] = 
d
->
ht
[1].
size
;

532 
š‹g”s
[5] = 
d
->
ht
[1].
u£d
;

541 
j
 = 0; j < 6; j++) {

542 
hash
 +ğ
š‹g”s
[
j
];

544 
hash
 = (~hash) + (hash << 21);

545 
hash
 = hash ^ (hash >> 24);

546 
hash
 = (hash + (hash << 3)) + (hash << 8);

547 
hash
 = hash ^ (hash >> 14);

548 
hash
 = (hash + (hash << 2)) + (hash << 4);

549 
hash
 = hash ^ (hash >> 28);

550 
hash
 = hash + (hash << 31);

552  
hash
;

553 
	}
}

555 
diùI‹¿tÜ
 *
	$diùG‘I‹¿tÜ
(
diù
 *
d
)

557 
diùI‹¿tÜ
 *
™”
 = 
	`zm®loc
((*iter));

559 
™”
->
d
 = d;

560 
™”
->
bË
 = 0;

561 
™”
->
šdex
 = -1;

562 
™”
->
§ã
 = 0;

563 
™”
->
’Œy
 = 
NULL
;

564 
™”
->
ÃxtEÁry
 = 
NULL
;

565  
™”
;

566 
	}
}

568 
diùI‹¿tÜ
 *
	$diùG‘SaãI‹¿tÜ
(
diù
 *
d
) {

569 
diùI‹¿tÜ
 *
i
 = 
	`diùG‘I‹¿tÜ
(
d
);

571 
i
->
§ã
 = 1;

572  
i
;

573 
	}
}

575 
diùEÁry
 *
	$diùNext
(
diùI‹¿tÜ
 *
™”
)

578 ià(
™”
->
’Œy
 =ğ
NULL
) {

579 
diùht
 *
ht
 = &
™”
->
d
->ht[™”->
bË
];

580 ià(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0) {

581 ià(
™”
->
§ã
)

582 
™”
->
d
->
™”©Üs
++;

584 
™”
->
fšg”´št
 = 
	`diùFšg”´št
(™”->
d
);

586 
™”
->
šdex
++;

587 ià(
™”
->
šdex
 >ğ(è
ht
->
size
) {

588 ià(
	`diùIsRehashšg
(
™”
->
d
è&& i‹r->
bË
 == 0) {

589 
™”
->
bË
++;

590 
™”
->
šdex
 = 0;

591 
ht
 = &
™”
->
d
->ht[1];

596 
™”
->
’Œy
 = 
ht
->
bË
[™”->
šdex
];

598 
™”
->
’Œy
 = i‹r->
ÃxtEÁry
;

600 ià(
™”
->
’Œy
) {

603 
™”
->
ÃxtEÁry
 = i‹r->
’Œy
->
Ãxt
;

604  
™”
->
’Œy
;

607  
NULL
;

608 
	}
}

610 
	$diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
)

612 ià(!(
™”
->
šdex
 =ğ-1 && i‹r->
bË
 == 0)) {

613 ià(
™”
->
§ã
)

614 
™”
->
d
->
™”©Üs
--;

616 
	`as£¹
(
™”
->
fšg”´št
 =ğ
	`diùFšg”´št
(™”->
d
));

618 
	`zä“
(
™”
);

619 
	}
}

623 
diùEÁry
 *
	$diùG‘RªdomKey
(
diù
 *
d
)

625 
diùEÁry
 *
he
, *
Üighe
;

626 
h
;

627 
li¡Ën
, 
li¡–e
;

629 ià(
	`diùSize
(
d
è=ğ0è 
NULL
;

630 ià(
	`diùIsRehashšg
(
d
)è
	`_diùRehashS‹p
(d);

631 ià(
	`diùIsRehashšg
(
d
)) {

635 
h
 = 
d
->
»hashidx
 + (
	`¿ndom
(è% (d->
ht
[0].
size
 +

636 
d
->
ht
[1].
size
 -

637 
d
->
»hashidx
));

638 
he
 = (
h
 >ğ
d
->
ht
[0].
size
è? d->ht[1].
bË
[h - d->ht[0].size] :

639 
d
->
ht
[0].
bË
[
h
];

640 } 
he
 =ğ
NULL
);

643 
h
 = 
	`¿ndom
(è& 
d
->
ht
[0].
sizemask
;

644 
he
 = 
d
->
ht
[0].
bË
[
h
];

645 } 
he
 =ğ
NULL
);

652 
li¡Ën
 = 0;

653 
Üighe
 = 
he
;

654 
he
) {

655 
he
 = he->
Ãxt
;

656 
li¡Ën
++;

658 
li¡–e
 = 
	`¿ndom
(è% 
li¡Ën
;

659 
he
 = 
Üighe
;

660 
li¡–e
--è
he
 = he->
Ãxt
;

661  
he
;

662 
	}
}

686 
	$diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
) {

687 
j
;

688 
bËs
;

689 
¡Üed
 = 0, 
maxsizemask
;

690 
max¡•s
;

692 ià(
	`diùSize
(
d
è< 
couÁ
) count = dictSize(d);

693 
max¡•s
 = 
couÁ
*10;

696 
j
 = 0; j < 
couÁ
; j++) {

697 ià(
	`diùIsRehashšg
(
d
))

698 
	`_diùRehashS‹p
(
d
);

703 
bËs
 = 
	`diùIsRehashšg
(
d
) ? 2 : 1;

704 
maxsizemask
 = 
d
->
ht
[0].
sizemask
;

705 ià(
bËs
 > 1 && 
maxsizemask
 < 
d
->
ht
[1].
sizemask
)

706 
maxsizemask
 = 
d
->
ht
[1].
sizemask
;

709 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

710 
em±yËn
 = 0;

711 
¡Üed
 < 
couÁ
 && 
max¡•s
--) {

712 
j
 = 0; j < 
bËs
; j++) {

716 ià(
bËs
 =ğ2 && 
j
 =ğ0 && 
i
 < (è
d
->
»hashidx
) {

721 ià(
i
 >ğ
d
->
ht
[1].
size
è˜ğd->
»hashidx
;

724 ià(
i
 >ğ
d
->
ht
[
j
].
size
) ;

725 
diùEÁry
 *
he
 = 
d
->
ht
[
j
].
bË
[
i
];

729 ià(
he
 =ğ
NULL
) {

730 
em±yËn
++;

731 ià(
em±yËn
 >ğ5 &&ƒm±yËÀ> 
couÁ
) {

732 
i
 = 
	`¿ndom
(è& 
maxsizemask
;

733 
em±yËn
 = 0;

736 
em±yËn
 = 0;

737 
he
) {

740 *
des
 = 
he
;

741 
des
++;

742 
he
 = he->
Ãxt
;

743 
¡Üed
++;

744 ià(
¡Üed
 =ğ
couÁ
)  stored;

748 
i
 = (i+1è& 
maxsizemask
;

750  
¡Üed
;

751 
	}
}

755 
	$»v
(
v
) {

756 
s
 = 8 * (
v
);

757 
mask
 = ~0;

758 (
s
 >>= 1) > 0) {

759 
mask
 ^ğ(mask << 
s
);

760 
v
 = ((v >> 
s
è& 
mask
) | ((v << s) & ~mask);

762  
v
;

763 
	}
}

849 
	$diùSÿn
(
diù
 *
d
,

850 
v
,

851 
diùSÿnFunùiÚ
 *
â
,

852 *
´ivd©a
)

854 
diùht
 *
t0
, *
t1
;

855 cÚ¡ 
diùEÁry
 *
de
;

856 
m0
, 
m1
;

858 ià(
	`diùSize
(
d
) == 0)  0;

860 ià(!
	`diùIsRehashšg
(
d
)) {

861 
t0
 = &(
d
->
ht
[0]);

862 
m0
 = 
t0
->
sizemask
;

865 
de
 = 
t0
->
bË
[
v
 & 
m0
];

866 
de
) {

867 
	`â
(
´ivd©a
, 
de
);

868 
de
 = de->
Ãxt
;

872 
t0
 = &
d
->
ht
[0];

873 
t1
 = &
d
->
ht
[1];

876 ià(
t0
->
size
 > 
t1
->size) {

877 
t0
 = &
d
->
ht
[1];

878 
t1
 = &
d
->
ht
[0];

881 
m0
 = 
t0
->
sizemask
;

882 
m1
 = 
t1
->
sizemask
;

885 
de
 = 
t0
->
bË
[
v
 & 
m0
];

886 
de
) {

887 
	`â
(
´ivd©a
, 
de
);

888 
de
 = de->
Ãxt
;

895 
de
 = 
t1
->
bË
[
v
 & 
m1
];

896 
de
) {

897 
	`â
(
´ivd©a
, 
de
);

898 
de
 = de->
Ãxt
;

902 
v
 = (((v | 
m0
) + 1) & ~m0) | (v & m0);

905 } 
v
 & (
m0
 ^ 
m1
));

910 
v
 |ğ~
m0
;

913 
v
 = 
	`»v
(v);

914 
v
++;

915 
v
 = 
	`»v
(v);

917  
v
;

918 
	}
}

923 
	$_diùEx·ndIfN“ded
(
diù
 *
d
)

926 ià(
	`diùIsRehashšg
(
d
)è 
DICT_OK
;

929 ià(
d
->
ht
[0].
size
 =ğ0è 
	`diùEx·nd
(d, 
DICT_HT_INITIAL_SIZE
);

935 ià(
d
->
ht
[0].
u£d
 >ğd->ht[0].
size
 &&

936 (
diù_ÿn_»size
 ||

937 
d
->
ht
[0].
u£d
/d->ht[0].
size
 > 
diù_fÜû_»size_¿tio
))

939  
	`diùEx·nd
(
d
, d->
ht
[0].
u£d
*2);

941  
DICT_OK
;

942 
	}
}

945 
	$_diùNextPow”
(
size
)

947 
i
 = 
DICT_HT_INITIAL_SIZE
;

949 ià(
size
 >ğ
LONG_MAX
)  LONG_MAX;

951 ià(
i
 >ğ
size
)

952  
i
;

953 
i
 *= 2;

955 
	}
}

963 
	$_diùKeyIndex
(
diù
 *
d
, cÚ¡ *
key
)

965 
h
, 
idx
, 
bË
;

966 
diùEÁry
 *
he
;

969 ià(
	`_diùEx·ndIfN“ded
(
d
è=ğ
DICT_ERR
)

972 
h
 = 
	`diùHashKey
(
d
, 
key
);

973 
bË
 = 0;able <= 1;able++) {

974 
idx
 = 
h
 & 
d
->
ht
[
bË
].
sizemask
;

976 
he
 = 
d
->
ht
[
bË
].bË[
idx
];

977 
he
) {

978 ià(
	`diùCom·»Keys
(
d
, 
key
, 
he
->key))

980 
he
 = he->
Ãxt
;

982 ià(!
	`diùIsRehashšg
(
d
)) ;

984  
idx
;

985 
	}
}

987 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*)) {

988 
	`_diùCË¬
(
d
,&d->
ht
[0],
ÿÎback
);

989 
	`_diùCË¬
(
d
,&d->
ht
[1],
ÿÎback
);

990 
d
->
»hashidx
 = -1;

991 
d
->
™”©Üs
 = 0;

992 
	}
}

994 
	$diùEÇbËResize
() {

995 
diù_ÿn_»size
 = 1;

996 
	}
}

998 
	$diùDi§bËResize
() {

999 
diù_ÿn_»size
 = 0;

1000 
	}
}

1009 
	#DICT_STATS_VECTLEN
 50

	)

1010 
	$_diùPrštStsHt
(
diùht
 *
ht
) {

1011 
i
, 
¦Ùs
 = 0, 
chašËn
, 
maxchašËn
 = 0;

1012 
tÙchašËn
 = 0;

1013 
şveùÜ
[
DICT_STATS_VECTLEN
];

1015 ià(
ht
->
u£d
 == 0) {

1016 
	`´štf
("No stats‡vailable forƒmpty dictionaries\n");

1020 
i
 = 0; i < 
DICT_STATS_VECTLEN
; i++è
şveùÜ
[i] = 0;

1021 
i
 = 0; i < 
ht
->
size
; i++) {

1022 
diùEÁry
 *
he
;

1024 ià(
ht
->
bË
[
i
] =ğ
NULL
) {

1025 
şveùÜ
[0]++;

1028 
¦Ùs
++;

1030 
chašËn
 = 0;

1031 
he
 = 
ht
->
bË
[
i
];

1032 
he
) {

1033 
chašËn
++;

1034 
he
 = he->
Ãxt
;

1036 
şveùÜ
[(
chašËn
 < 
DICT_STATS_VECTLEN
) ? chainlen : (DICT_STATS_VECTLEN-1)]++;

1037 ià(
chašËn
 > 
maxchašËn
) maxchainlen = chainlen;

1038 
tÙchašËn
 +ğ
chašËn
;

1040 
	`´štf
("Hashable stats:\n");

1041 
	`´štf
("abË size: %ld\n", 
ht
->
size
);

1042 
	`´štf
("‚umb” oà–em’ts: %ld\n", 
ht
->
u£d
);

1043 
	`´štf
(" difã»Á slÙs: %ld\n", 
¦Ùs
);

1044 
	`´štf
(" max chaš†’gth: %ld\n", 
maxchašËn
);

1045 
	`´štf
("‡vg chaš†’gth (couÁed): %.02f\n", ()
tÙchašËn
/
¦Ùs
);

1046 
	`´štf
("‡vg chaš†’gth (compu‹d): %.02f\n", ()
ht
->
u£d
/
¦Ùs
);

1047 
	`´štf
(" Chain†ength distribution:\n");

1048 
i
 = 0; i < 
DICT_STATS_VECTLEN
-1; i++) {

1049 ià(
şveùÜ
[
i
] == 0) ;

1050 
	`´štf
(" %s%ld: %ld (%.02f%%)\n",(
i
 =ğ
DICT_STATS_VECTLEN
-1)?">ğ":"", i, 
şveùÜ
[i], (()şveùÜ[i]/
ht
->
size
)*100);

1052 
	}
}

1054 
	$diùPrštSts
(
diù
 *
d
) {

1055 
	`_diùPrštStsHt
(&
d
->
ht
[0]);

1056 ià(
	`diùIsRehashšg
(
d
)) {

1057 
	`´štf
("-- Rehashing into ht[1]:\n");

1058 
	`_diùPrštStsHt
(&
d
->
ht
[1]);

1060 
	}
}

1064 
	$_diùSŒšgCİyHTHashFunùiÚ
(cÚ¡ *
key
)

1066  
	`diùG’HashFunùiÚ
(
key
, 
	`¡¾’
(key));

1067 
	}
}

1069 *
	$_diùSŒšgDup
(*
´ivd©a
, cÚ¡ *
key
)

1071 
Ën
 = 
	`¡¾’
(
key
);

1072 *
cİy
 = 
	`zm®loc
(
Ën
+1);

1073 
	`DICT_NOTUSED
(
´ivd©a
);

1075 
	`memıy
(
cİy
, 
key
, 
Ën
);

1076 
cİy
[
Ën
] = '\0';

1077  
cİy
;

1078 
	}
}

1080 
	$_diùSŒšgCİyHTKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

1081 cÚ¡ *
key2
)

1083 
	`DICT_NOTUSED
(
´ivd©a
);

1085  
	`¡rcmp
(
key1
, 
key2
) == 0;

1086 
	}
}

1088 
	$_diùSŒšgDe¡ruùÜ
(*
´ivd©a
, *
key
)

1090 
	`DICT_NOTUSED
(
´ivd©a
);

1092 
	`zä“
(
key
);

1093 
	}
}

1095 
diùTy³
 
	gdiùTy³H—pSŒšgCİyKey
 = {

1096 
_diùSŒšgCİyHTHashFunùiÚ
,

1097 
_diùSŒšgDup
,

1098 
NULL
,

1099 
_diùSŒšgCİyHTKeyCom·»
,

1100 
_diùSŒšgDe¡ruùÜ
,

1101 
NULL


1106 
diùTy³
 
	gdiùTy³H—pSŒšgs
 = {

1107 
_diùSŒšgCİyHTHashFunùiÚ
,

1108 
NULL
,

1109 
NULL
,

1110 
_diùSŒšgCİyHTKeyCom·»
,

1111 
_diùSŒšgDe¡ruùÜ
,

1112 
NULL


1117 
diùTy³
 
	gdiùTy³H—pSŒšgCİyKeyV®ue
 = {

1118 
_diùSŒšgCİyHTHashFunùiÚ
,

1119 
_diùSŒšgDup
,

1120 
_diùSŒšgDup
,

1121 
_diùSŒšgCİyHTKeyCom·»
,

1122 
_diùSŒšgDe¡ruùÜ
,

1123 
_diùSŒšgDe¡ruùÜ
,

	@dict.h

36 
	~<¡dšt.h
>

38 #iâdeà
__DICT_H


39 
	#__DICT_H


	)

41 
	#DICT_OK
 0

	)

42 
	#DICT_ERR
 1

	)

45 
	#DICT_NOTUSED
(
V
è((èV)

	)

47 
	sdiùEÁry
 {

48 *
	mkey
;

50 *
	mv®
;

51 
ušt64_t
 
	mu64
;

52 
št64_t
 
	ms64
;

53 
	md
;

54 } 
	mv
;

55 
diùEÁry
 *
	mÃxt
;

56 } 
	tdiùEÁry
;

58 
	sdiùTy³
 {

59 (*
	mhashFunùiÚ
)(cÚ¡ *
	mkey
);

60 *(*
	mkeyDup
)(*
	m´ivd©a
, cÚ¡ *
	mkey
);

61 *(*
	mv®Dup
)(*
	m´ivd©a
, cÚ¡ *
	mobj
);

62 (*
	mkeyCom·»
)(*
	m´ivd©a
, cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

63 (*
	mkeyDe¡ruùÜ
)(*
	m´ivd©a
, *
	mkey
);

64 (*
	mv®De¡ruùÜ
)(*
	m´ivd©a
, *
	mobj
);

65 } 
	tdiùTy³
;

69 
	sdiùht
 {

70 
diùEÁry
 **
	mbË
;

71 
	msize
;

72 
	msizemask
;

73 
	mu£d
;

74 } 
	tdiùht
;

76 
	sdiù
 {

77 
diùTy³
 *
	mty³
;

78 *
	m´ivd©a
;

79 
diùht
 
	mht
[2];

80 
	m»hashidx
;

81 
	m™”©Üs
;

82 } 
	tdiù
;

88 
	sdiùI‹¿tÜ
 {

89 
diù
 *
	md
;

90 
	mšdex
;

91 
	mbË
, 
	m§ã
;

92 
diùEÁry
 *
	m’Œy
, *
	mÃxtEÁry
;

94 
	mfšg”´št
;

95 } 
	tdiùI‹¿tÜ
;

97 (
	tdiùSÿnFunùiÚ
)(*
	t´ivd©a
, cÚ¡ 
	tdiùEÁry
 *
	tde
);

100 
	#DICT_HT_INITIAL_SIZE
 4

	)

103 
	#diùF»eV®
(
d
, 
’Œy
) \

104 ià((
d
)->
ty³
->
v®De¡ruùÜ
) \

105 (
d
)->
ty³
->
	`v®De¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
v
.
v®
)

	)

107 
	#diùS‘V®
(
d
, 
’Œy
, 
_v®_
) do { \

108 ià((
d
)->
ty³
->
v®Dup
) \

109 
’Œy
->
v
.
v®
 = (
d
)->
ty³
->
	`v®Dup
((d)->
´ivd©a
, 
_v®_
); \

111 
’Œy
->
v
.
v®
 = (
_v®_
); \

112 
	}
} 0)

	)

114 
	#diùS‘SigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

115 dØ{ 
’Œy
->
v
.
s64
 = 
_v®_
; } 0)

	)

117 
	#diùS‘UnsigÃdIÁeg”V®
(
’Œy
, 
_v®_
) \

118 dØ{ 
’Œy
->
v
.
u64
 = 
_v®_
; } 0)

	)

120 
	#diùS‘DoubËV®
(
’Œy
, 
_v®_
) \

121 dØ{ 
’Œy
->
v
.
d
 = 
_v®_
; } 0)

	)

123 
	#diùF»eKey
(
d
, 
’Œy
) \

124 ià((
d
)->
ty³
->
keyDe¡ruùÜ
) \

125 (
d
)->
ty³
->
	`keyDe¡ruùÜ
((d)->
´ivd©a
, (
’Œy
)->
key
)

	)

127 
	#diùS‘Key
(
d
, 
’Œy
, 
_key_
) do { \

128 ià((
d
)->
ty³
->
keyDup
) \

129 
’Œy
->
key
 = (
d
)->
ty³
->
	`keyDup
((d)->
´ivd©a
, 
_key_
); \

131 
’Œy
->
key
 = (
_key_
); \

132 } 0)

	)

134 
	#diùCom·»Keys
(
d
, 
key1
, 
key2
) \

135 (((
d
)->
ty³
->
keyCom·»
) ? \

136 (
d
)->
ty³
->
	`keyCom·»
((d)->
´ivd©a
, 
key1
, 
key2
) : \

137 (
key1
è=ğ(
key2
))

	)

139 
	#diùHashKey
(
d
, 
key
è(d)->
ty³
->
	`hashFunùiÚ
(key)

	)

140 
	#diùG‘Key
(
he
è((he)->
key
)

	)

141 
	#diùG‘V®
(
he
è((he)->
v
.
v®
)

	)

142 
	#diùG‘SigÃdIÁeg”V®
(
he
è((he)->
v
.
s64
)

	)

143 
	#diùG‘UnsigÃdIÁeg”V®
(
he
è((he)->
v
.
u64
)

	)

144 
	#diùG‘DoubËV®
(
he
è((he)->
v
.
d
)

	)

145 
	#diùSlÙs
(
d
è((d)->
ht
[0].
size
+(d)->ht[1].size)

	)

146 
	#diùSize
(
d
è((d)->
ht
[0].
u£d
+(d)->ht[1].u£d)

	)

147 
	#diùIsRehashšg
(
d
è((d)->
»hashidx
 !ğ-1)

	)

150 
diù
 *
diùC»©e
(
diùTy³
 *
ty³
, *
´ivD©aPŒ
);

151 
diùEx·nd
(
diù
 *
d
, 
size
);

152 
diùAdd
(
diù
 *
d
, *
key
, *
v®
);

153 
diùEÁry
 *
diùAddRaw
(
diù
 *
d
, *
key
);

154 
diùR•Ïû
(
diù
 *
d
, *
key
, *
v®
);

155 
diùEÁry
 *
diùR•ÏûRaw
(
diù
 *
d
, *
key
);

156 
diùD–‘e
(
diù
 *
d
, cÚ¡ *
key
);

157 
diùD–‘eNoF»e
(
diù
 *
d
, cÚ¡ *
key
);

158 
diùR–—£
(
diù
 *
d
);

159 
diùEÁry
 * 
diùFšd
(
diù
 *
d
, cÚ¡ *
key
);

160 *
diùF‘chV®ue
(
diù
 *
d
, cÚ¡ *
key
);

161 
diùResize
(
diù
 *
d
);

162 
diùI‹¿tÜ
 *
diùG‘I‹¿tÜ
(
diù
 *
d
);

163 
diùI‹¿tÜ
 *
diùG‘SaãI‹¿tÜ
(
diù
 *
d
);

164 
diùEÁry
 *
diùNext
(
diùI‹¿tÜ
 *
™”
);

165 
diùR–—£I‹¿tÜ
(
diùI‹¿tÜ
 *
™”
);

166 
diùEÁry
 *
diùG‘RªdomKey
(
diù
 *
d
);

167 
diùG‘SomeKeys
(
diù
 *
d
, 
diùEÁry
 **
des
, 
couÁ
);

168 
diùPrštSts
(
diù
 *
d
);

169 
diùG’HashFunùiÚ
(cÚ¡ *
key
, 
Ën
);

170 
diùG’Ca£HashFunùiÚ
(cÚ¡ *
buf
, 
Ën
);

171 
diùEm±y
(
diù
 *
d
, (
ÿÎback
)(*));

172 
	`diùEÇbËResize
();

173 
	`diùDi§bËResize
();

174 
	`diùRehash
(
diù
 *
d
, 
n
);

175 
	`diùRehashMli£cÚds
(
diù
 *
d
, 
ms
);

176 
	`diùS‘HashFunùiÚS“d
(
š™v®
);

177 
	`diùG‘HashFunùiÚS“d
();

178 
	`diùSÿn
(
diù
 *
d
, 
v
, 
diùSÿnFunùiÚ
 *
â
, *
´ivd©a
);

181 
diùTy³
 
diùTy³H—pSŒšgCİyKey
;

182 
diùTy³
 
diùTy³H—pSŒšgs
;

183 
diùTy³
 
diùTy³H—pSŒšgCİyKeyV®ue
;

	@endianconv.c

45 
	~<¡dšt.h
>

49 
	$mem»v16
(*
p
) {

50 *
x
 = 
p
, 
t
;

52 
t
 = 
x
[0];

53 
x
[0] = x[1];

54 
x
[1] = 
t
;

55 
	}
}

59 
	$mem»v32
(*
p
) {

60 *
x
 = 
p
, 
t
;

62 
t
 = 
x
[0];

63 
x
[0] = x[3];

64 
x
[3] = 
t
;

65 
t
 = 
x
[1];

66 
x
[1] = x[2];

67 
x
[2] = 
t
;

68 
	}
}

72 
	$mem»v64
(*
p
) {

73 *
x
 = 
p
, 
t
;

75 
t
 = 
x
[0];

76 
x
[0] = x[7];

77 
x
[7] = 
t
;

78 
t
 = 
x
[1];

79 
x
[1] = x[6];

80 
x
[6] = 
t
;

81 
t
 = 
x
[2];

82 
x
[2] = x[5];

83 
x
[5] = 
t
;

84 
t
 = 
x
[3];

85 
x
[3] = x[4];

86 
x
[4] = 
t
;

87 
	}
}

89 
ušt16_t
 
	$šŒev16
(
ušt16_t
 
v
) {

90 
	`mem»v16
(&
v
);

91  
v
;

92 
	}
}

94 
ušt32_t
 
	$šŒev32
(
ušt32_t
 
v
) {

95 
	`mem»v32
(&
v
);

96  
v
;

97 
	}
}

99 
ušt64_t
 
	$šŒev64
(
ušt64_t
 
v
) {

100 
	`mem»v64
(&
v
);

101  
v
;

102 
	}
}

104 #ifdeà
TESTMAIN


105 
	~<¡dio.h
>

107 
	$maš
() {

108 
buf
[32];

110 
	`¥rštf
(
buf
,"ciaoroma");

111 
	`mem»v16
(
buf
);

112 
	`´štf
("%s\n", 
buf
);

114 
	`¥rštf
(
buf
,"ciaoroma");

115 
	`mem»v32
(
buf
);

116 
	`´štf
("%s\n", 
buf
);

118 
	`¥rštf
(
buf
,"ciaoroma");

119 
	`mem»v64
(
buf
);

120 
	`´štf
("%s\n", 
buf
);

123 
	}
}

	@endianconv.h

33 #iâdeà
__ENDIANCONV_H


34 
	#__ENDIANCONV_H


	)

36 
	~"cÚfig.h
"

37 
	~<¡dšt.h
>

39 
mem»v16
(*
p
);

40 
mem»v32
(*
p
);

41 
mem»v64
(*
p
);

42 
ušt16_t
 
šŒev16
(ušt16_ˆ
v
);

43 
ušt32_t
 
šŒev32
(ušt32_ˆ
v
);

44 
ušt64_t
 
šŒev64
(ušt64_ˆ
v
);

48 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

49 
	#mem»v16ifbe
(
p
)

	)

50 
	#mem»v32ifbe
(
p
)

	)

51 
	#mem»v64ifbe
(
p
)

	)

52 
	#šŒev16ifbe
(
v
è(v)

	)

53 
	#šŒev32ifbe
(
v
è(v)

	)

54 
	#šŒev64ifbe
(
v
è(v)

	)

56 
	#mem»v16ifbe
(
p
è
	`mem»v16
Õ)

	)

57 
	#mem»v32ifbe
(
p
è
	`mem»v32
Õ)

	)

58 
	#mem»v64ifbe
(
p
è
	`mem»v64
Õ)

	)

59 
	#šŒev16ifbe
(
v
è
	`šŒev16
(v)

	)

60 
	#šŒev32ifbe
(
v
è
	`šŒev32
(v)

	)

61 
	#šŒev64ifbe
(
v
è
	`šŒev64
(v)

	)

66 #ià(
BYTE_ORDER
 =ğ
BIG_ENDIAN
)

67 
	#htÚu64
(
v
è(v)

	)

68 
	#Áohu64
(
v
è(v)

	)

70 
	#htÚu64
(
v
è
	`šŒev64
(v)

	)

71 
	#Áohu64
(
v
è
	`šŒev64
(v)

	)

	@fmacros.h

30 #iâdeà
_REDIS_FMACRO_H


31 
	#_REDIS_FMACRO_H


	)

33 
	#_BSD_SOURCE


	)

35 #ià
defšed
(
__lšux__
)

36 
	#_GNU_SOURCE


	)

37 
	#_DEFAULT_SOURCE


	)

40 #ià
defšed
(
_AIX
)

41 
	#_ALL_SOURCE


	)

44 #ià
defšed
(
__lšux__
è|| defšed(
__O³nBSD__
)

45 
	#_XOPEN_SOURCE
 700

	)

50 #–ià!
defšed
(
__N‘BSD__
)

51 
	#_XOPEN_SOURCE


	)

54 #ià
defšed
(
__sun
)

55 
	#_POSIX_C_SOURCE
 199506L

	)

58 
	#_LARGEFILE_SOURCE


	)

59 
	#_FILE_OFFSET_BITS
 64

	)

	@help.h

3 #iâdeà
__REDIS_HELP_H


4 
	#__REDIS_HELP_H


	)

6 *
	gcommªdGroups
[] = {

21 
	scommªdH–p
 {

22 *
	mÇme
;

23 *
	m·¿ms
;

24 *
	msumm¬y
;

25 
	mgroup
;

26 *
	msšû
;

27 } 
	gcommªdH–p
[] = {

	@hyperloglog.c

32 
	~"»dis.h
"

34 
	~<¡dšt.h
>

35 
	~<m©h.h
>

182 
	shÎhdr
 {

183 
	mmagic
[4];

184 
ušt8_t
 
	m’codšg
;

185 
ušt8_t
 
	mnÙu£d
[3];

186 
ušt8_t
 
	mÿrd
[8];

187 
ušt8_t
 
	m»gi¡”s
[];

191 
	#HLL_INVALIDATE_CACHE
(
hdr
è(hdr)->
ÿrd
[7] |ğ(1<<7)

	)

192 
	#HLL_VALID_CACHE
(
hdr
è(((hdr)->
ÿrd
[7] & (1<<7)è=ğ0)

	)

194 
	#HLL_P
 14

	)

195 
	#HLL_REGISTERS
 (1<<
HLL_P
è

	)

196 
	#HLL_P_MASK
 (
HLL_REGISTERS
-1è

	)

197 
	#HLL_BITS
 6

	)

198 
	#HLL_REGISTER_MAX
 ((1<<
HLL_BITS
)-1)

	)

199 
	#HLL_HDR_SIZE
 (
hÎhdr
)

	)

200 
	#HLL_DENSE_SIZE
 (
HLL_HDR_SIZE
+((
HLL_REGISTERS
*
HLL_BITS
+7)/8))

	)

201 
	#HLL_DENSE
 0

	)

202 
	#HLL_SPARSE
 1

	)

203 
	#HLL_RAW
 255

	)

204 
	#HLL_MAX_ENCODING
 1

	)

206 *
	gšv®id_hÎ_”r
 = "-INVALIDOBJ Corrupted HLL object detected\r\n";

337 
	#HLL_DENSE_GET_REGISTER
(
rg‘
,
p
,
»gnum
) do { \

338 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

339 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

340 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

341 
_fb8
 = 8 - 
_fb
; \

342 
b0
 = 
_p
[
_by‹
]; \

343 
b1
 = 
_p
[
_by‹
+1]; \

344 
rg‘
 = ((
b0
 >> 
_fb
è| (
b1
 << 
_fb8
)è& 
HLL_REGISTER_MAX
; \

345 } 0)

	)

349 
	#HLL_DENSE_SET_REGISTER
(
p
,
»gnum
,
v®
) do { \

350 
ušt8_t
 *
_p
 = (ušt8_t*è
p
; \

351 
_by‹
 = 
»gnum
*
HLL_BITS
/8; \

352 
_fb
 = 
»gnum
*
HLL_BITS
&7; \

353 
_fb8
 = 8 - 
_fb
; \

354 
_v
 = 
v®
; \

355 
_p
[
_by‹
] &ğ~(
HLL_REGISTER_MAX
 << 
_fb
); \

356 
_p
[
_by‹
] |ğ
_v
 << 
_fb
; \

357 
_p
[
_by‹
+1] &ğ~(
HLL_REGISTER_MAX
 >> 
_fb8
); \

358 
_p
[
_by‹
+1] |ğ
_v
 >> 
_fb8
; \

359 } 0)

	)

363 
	#HLL_SPARSE_XZERO_BIT
 0x40

	)

364 
	#HLL_SPARSE_VAL_BIT
 0x80

	)

365 
	#HLL_SPARSE_IS_ZERO
(
p
è(((*Õ)è& 0xc0è=ğ0è

	)

366 
	#HLL_SPARSE_IS_XZERO
(
p
è(((*Õ)è& 0xc0è=ğ
HLL_SPARSE_XZERO_BIT
)

	)

367 
	#HLL_SPARSE_IS_VAL
(
p
è((*Õ)è& 
HLL_SPARSE_VAL_BIT
)

	)

368 
	#HLL_SPARSE_ZERO_LEN
(
p
è(((*Õ)è& 0x3f)+1)

	)

369 
	#HLL_SPARSE_XZERO_LEN
(
p
è(((((*Õ)è& 0x3fè<< 8è| (*(Õ)+1)))+1)

	)

370 
	#HLL_SPARSE_VAL_VALUE
(
p
è((((*Õ)è>> 2è& 0x1f)+1)

	)

371 
	#HLL_SPARSE_VAL_LEN
(
p
è(((*Õ)è& 0x3)+1)

	)

372 
	#HLL_SPARSE_VAL_MAX_VALUE
 32

	)

373 
	#HLL_SPARSE_VAL_MAX_LEN
 4

	)

374 
	#HLL_SPARSE_ZERO_MAX_LEN
 64

	)

375 
	#HLL_SPARSE_XZERO_MAX_LEN
 16384

	)

376 
	#HLL_SPARSE_VAL_SET
(
p
,
v®
,
Ën
) do { \

377 *(
p
èğ(((
v®
)-1)<<2|((
Ën
)-1))|
HLL_SPARSE_VAL_BIT
; \

378 } 0)

	)

379 
	#HLL_SPARSE_ZERO_SET
(
p
,
Ën
) do { \

380 *(
p
èğ(
Ën
)-1; \

381 } 0)

	)

382 
	#HLL_SPARSE_XZERO_SET
(
p
,
Ën
) do { \

383 
_l
 = (
Ën
)-1; \

384 *(
p
èğ(
_l
>>8è| 
HLL_SPARSE_XZERO_BIT
; \

385 *((
p
)+1èğ(
_l
&0xff); \

386 } 0)

	)

393 
ušt64_t
 
	$MurmurHash64A
 (cÚ¡ * 
key
, 
Ën
, 
£ed
) {

394 cÚ¡ 
ušt64_t
 
m
 = 0xc6a4a7935bd1e995;

395 cÚ¡ 
r
 = 47;

396 
ušt64_t
 
h
 = 
£ed
 ^ (
Ën
 * 
m
);

397 cÚ¡ 
ušt8_t
 *
d©a
 = (cÚ¡ ušt8_ˆ*)
key
;

398 cÚ¡ 
ušt8_t
 *
’d
 = 
d©a
 + (
Ën
-(len&7));

400 
d©a
 !ğ
’d
) {

401 
ušt64_t
 
k
;

403 #ià(
BYTE_ORDER
 =ğ
LITTLE_ENDIAN
)

404 
k
 = *((
ušt64_t
*)
d©a
);

406 
k
 = (
ušt64_t
è
d©a
[0];

407 
k
 |ğ(
ušt64_t
è
d©a
[1] << 8;

408 
k
 |ğ(
ušt64_t
è
d©a
[2] << 16;

409 
k
 |ğ(
ušt64_t
è
d©a
[3] << 24;

410 
k
 |ğ(
ušt64_t
è
d©a
[4] << 32;

411 
k
 |ğ(
ušt64_t
è
d©a
[5] << 40;

412 
k
 |ğ(
ušt64_t
è
d©a
[6] << 48;

413 
k
 |ğ(
ušt64_t
è
d©a
[7] << 56;

416 
k
 *ğ
m
;

417 
k
 ^ğk >> 
r
;

418 
k
 *ğ
m
;

419 
h
 ^ğ
k
;

420 
h
 *ğ
m
;

421 
d©a
 += 8;

424 
Ën
 & 7) {

425 7: 
h
 ^ğ(
ušt64_t
)
d©a
[6] << 48;

426 6: 
h
 ^ğ(
ušt64_t
)
d©a
[5] << 40;

427 5: 
h
 ^ğ(
ušt64_t
)
d©a
[4] << 32;

428 4: 
h
 ^ğ(
ušt64_t
)
d©a
[3] << 24;

429 3: 
h
 ^ğ(
ušt64_t
)
d©a
[2] << 16;

430 2: 
h
 ^ğ(
ušt64_t
)
d©a
[1] << 8;

431 1: 
h
 ^ğ(
ušt64_t
)
d©a
[0];

432 
h
 *ğ
m
;

435 
h
 ^ğh >> 
r
;

436 
h
 *ğ
m
;

437 
h
 ^ğh >> 
r
;

438  
h
;

439 
	}
}

444 
	$hÎP©L’
(*
–e
, 
size_t
 
–esize
, *
»gp
) {

445 
ušt64_t
 
hash
, 
b™
, 
šdex
;

446 
couÁ
;

459 
hash
 = 
	`MurmurHash64A
(
–e
,
–esize
,0xadc83b19ULL);

460 
šdex
 = 
hash
 & 
HLL_P_MASK
;

461 
hash
 |ğ((
ušt64_t
)1<<63);

462 
b™
 = 
HLL_REGISTERS
;

463 
couÁ
 = 1;

464 (
hash
 & 
b™
) == 0) {

465 
couÁ
++;

466 
b™
 <<= 1;

468 *
»gp
 = (è
šdex
;

469  
couÁ
;

470 
	}
}

485 
	$hÎD’£Add
(
ušt8_t
 *
»gi¡”s
, *
–e
, 
size_t
 
–esize
) {

486 
ušt8_t
 
ŞdcouÁ
, 
couÁ
;

487 
šdex
;

490 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

491 
	`HLL_DENSE_GET_REGISTER
(
ŞdcouÁ
,
»gi¡”s
,
šdex
);

492 ià(
couÁ
 > 
ŞdcouÁ
) {

493 
	`HLL_DENSE_SET_REGISTER
(
»gi¡”s
,
šdex
,
couÁ
);

498 
	}
}

504 
	$hÎD’£Sum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

505 
E
 = 0;

506 
j
, 
ez
 = 0;

511 ià(
HLL_REGISTERS
 =ğ16384 && 
HLL_BITS
 == 6) {

512 
ušt8_t
 *
r
 = 
»gi¡”s
;

513 
r0
, 
r1
, 
r2
, 
r3
, 
r4
, 
r5
, 
r6
, 
r7
, 
r8
, 
r9
,

514 
r10
, 
r11
, 
r12
, 
r13
, 
r14
, 
r15
;

515 
j
 = 0; j < 1024; j++) {

517 
r0
 = 
r
[0] & 63; iàÔ0 =ğ0è
ez
++;

518 
r1
 = (
r
[0] >> 6 |„[1] << 2è& 63; iàÔ1 =ğ0è
ez
++;

519 
r2
 = (
r
[1] >> 4 |„[2] << 4è& 63; iàÔ2 =ğ0è
ez
++;

520 
r3
 = (
r
[2] >> 2è& 63; iàÔ3 =ğ0è
ez
++;

521 
r4
 = 
r
[3] & 63; iàÔ4 =ğ0è
ez
++;

522 
r5
 = (
r
[3] >> 6 |„[4] << 2è& 63; iàÔ5 =ğ0è
ez
++;

523 
r6
 = (
r
[4] >> 4 |„[5] << 4è& 63; iàÔ6 =ğ0è
ez
++;

524 
r7
 = (
r
[5] >> 2è& 63; iàÔ7 =ğ0è
ez
++;

525 
r8
 = 
r
[6] & 63; iàÔ8 =ğ0è
ez
++;

526 
r9
 = (
r
[6] >> 6 |„[7] << 2è& 63; iàÔ9 =ğ0è
ez
++;

527 
r10
 = (
r
[7] >> 4 |„[8] << 4è& 63; iàÔ10 =ğ0è
ez
++;

528 
r11
 = (
r
[8] >> 2è& 63; iàÔ11 =ğ0è
ez
++;

529 
r12
 = 
r
[9] & 63; iàÔ12 =ğ0è
ez
++;

530 
r13
 = (
r
[9] >> 6 |„[10] << 2è& 63; iàÔ13 =ğ0è
ez
++;

531 
r14
 = (
r
[10] >> 4 |„[11] << 4è& 63; iàÔ14 =ğ0è
ez
++;

532 
r15
 = (
r
[11] >> 2è& 63; iàÔ15 =ğ0è
ez
++;

537 
E
 +ğ(
PE
[
r0
] + PE[
r1
]è+ (PE[
r2
] + PE[
r3
]è+ (PE[
r4
] + PE[
r5
]) +

538 (
PE
[
r6
] + PE[
r7
]è+ (PE[
r8
] + PE[
r9
]è+ (PE[
r10
] + PE[
r11
]) +

539 (
PE
[
r12
] + PE[
r13
]è+ (PE[
r14
] + PE[
r15
]);

540 
r
 += 12;

543 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

544 
»g
;

546 
	`HLL_DENSE_GET_REGISTER
(
»g
,
»gi¡”s
,
j
);

547 ià(
»g
 == 0) {

548 
ez
++;

551 
E
 +ğ
PE
[
»g
];

554 
E
 +ğ
ez
;

556 *
ezp
 = 
ez
;

557  
E
;

558 
	}
}

568 
	$hÎS·r£ToD’£
(
robj
 *
o
) {

569 
sds
 
¥¬£
 = 
o
->
±r
, 
d’£
;

570 
hÎhdr
 *
hdr
, *
Şdhdr
 = (hÎhdr*)
¥¬£
;

571 
idx
 = 0, 
ruÆ’
, 
»gv®
;

572 
ušt8_t
 *
p
 = (ušt8_t*)
¥¬£
, *
’d
 =…+
	`sd¦’
(sparse);

575 
hdr
 = (
hÎhdr
*è
¥¬£
;

576 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
è 
REDIS_OK
;

581 
d’£
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

582 
hdr
 = (
hÎhdr
*è
d’£
;

583 *
hdr
 = *
Şdhdr
;

584 
hdr
->
’codšg
 = 
HLL_DENSE
;

588 
p
 +ğ
HLL_HDR_SIZE
;

589 
p
 < 
’d
) {

590 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

591 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

592 
idx
 +ğ
ruÆ’
;

593 
p
++;

594 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

595 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

596 
idx
 +ğ
ruÆ’
;

597 
p
 += 2;

599 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

600 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

601 
ruÆ’
--) {

602 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
idx
,
»gv®
);

603 
idx
++;

605 
p
++;

611 ià(
idx
 !ğ
HLL_REGISTERS
) {

612 
	`sdsä“
(
d’£
);

613  
REDIS_ERR
;

617 
	`sdsä“
(
o
->
±r
);

618 
o
->
±r
 = 
d’£
;

619  
REDIS_OK
;

620 
	}
}

638 
	$hÎS·r£Add
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

639 
hÎhdr
 *
hdr
;

640 
ušt8_t
 
ŞdcouÁ
, 
couÁ
, *
¥¬£
, *
’d
, *
p
, *
´ev
, *
Ãxt
;

641 
šdex
, 
fœ¡
, 
¥ª
;

642 
is_z”o
 = 0, 
is_xz”o
 = 0, 
is_v®
 = 0, 
ruÆ’
 = 0;

645 
couÁ
 = 
	`hÎP©L’
(
–e
,
–esize
,&
šdex
);

649 ià(
couÁ
 > 
HLL_SPARSE_VAL_MAX_VALUE
è
´omÙe
;

656 
o
->
±r
 = 
	`sdsMakeRoomFÜ
(o->ptr,3);

660 
¥¬£
 = 
p
 = ((
ušt8_t
*)
o
->
±r
è+ 
HLL_HDR_SIZE
;

661 
’d
 = 
p
 + 
	`sd¦’
(
o
->
±r
è- 
HLL_HDR_SIZE
;

663 
fœ¡
 = 0;

664 
´ev
 = 
NULL
;

665 
Ãxt
 = 
NULL
;

666 
¥ª
 = 0;

667 
p
 < 
’d
) {

668 
İËn
;

675 
İËn
 = 1;

676 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

677 
¥ª
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

678 } ià(
	`HLL_SPARSE_IS_VAL
(
p
)) {

679 
¥ª
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

681 
¥ª
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

682 
İËn
 = 2;

685 ià(
šdex
 <ğ
fœ¡
+
¥ª
-1) ;

686 
´ev
 = 
p
;

687 
p
 +ğ
İËn
;

688 
fœ¡
 +ğ
¥ª
;

690 ià(
¥ª
 == 0)  -1;

692 
Ãxt
 = 
	`HLL_SPARSE_IS_XZERO
(
p
) ?…+2 :…+1;

693 ià(
Ãxt
 >ğ
’d
èÃxˆğ
NULL
;

698 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

699 
is_z”o
 = 1;

700 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

701 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

702 
is_xz”o
 = 1;

703 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

705 
is_v®
 = 1;

706 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

730 ià(
is_v®
) {

731 
ŞdcouÁ
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

733 ià(
ŞdcouÁ
 >ğ
couÁ
)  0;

736 ià(
ruÆ’
 == 1) {

737 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

738 
upd©ed
;

744 ià(
is_z”o
 && 
ruÆ’
 == 1) {

745 
	`HLL_SPARSE_VAL_SET
(
p
,
couÁ
,1);

746 
upd©ed
;

764 
ušt8_t
 
£q
[5], *
n
 = seq;

765 
Ï¡
 = 
fœ¡
+
¥ª
-1;

766 
Ën
;

768 ià(
is_z”o
 || 
is_xz”o
) {

770 ià(
šdex
 !ğ
fœ¡
) {

771 
Ën
 = 
šdex
-
fœ¡
;

772 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

773 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

774 
n
 += 2;

776 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

777 
n
++;

780 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

781 
n
++;

782 ià(
šdex
 !ğ
Ï¡
) {

783 
Ën
 = 
Ï¡
-
šdex
;

784 ià(
Ën
 > 
HLL_SPARSE_ZERO_MAX_LEN
) {

785 
	`HLL_SPARSE_XZERO_SET
(
n
,
Ën
);

786 
n
 += 2;

788 
	`HLL_SPARSE_ZERO_SET
(
n
,
Ën
);

789 
n
++;

794 
curv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

796 ià(
šdex
 !ğ
fœ¡
) {

797 
Ën
 = 
šdex
-
fœ¡
;

798 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

799 
n
++;

801 
	`HLL_SPARSE_VAL_SET
(
n
,
couÁ
,1);

802 
n
++;

803 ià(
šdex
 !ğ
Ï¡
) {

804 
Ën
 = 
Ï¡
-
šdex
;

805 
	`HLL_SPARSE_VAL_SET
(
n
,
curv®
,
Ën
);

806 
n
++;

814 
£qËn
 = 
n
-
£q
;

815 
ŞdËn
 = 
is_xz”o
 ? 2 : 1;

816 
d–Ën
 = 
£qËn
-
ŞdËn
;

818 ià(
d–Ën
 > 0 &&

819 
	`sd¦’
(
o
->
±r
)+
d–Ën
 > 
£rv”
.
hÎ_¥¬£_max_by‹s
è
´omÙe
;

820 ià(
d–Ën
 && 
Ãxt
è
	`memmove
Òext+d–Ën,Ãxt,
’d
-next);

821 
	`sdsInüL’
(
o
->
±r
,
d–Ën
);

822 
	`memıy
(
p
,
£q
,
£qËn
);

823 
’d
 +ğ
d–Ën
;

825 
upd©ed
:

831 
p
 = 
´ev
 ?…»v : 
¥¬£
;

832 
sÿÆ’
 = 5;

833 
p
 < 
’d
 && 
sÿÆ’
--) {

834 ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

835 
p
 += 2;

837 } ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

838 
p
++;

843 ià(
p
+1 < 
’d
 && 
	`HLL_SPARSE_IS_VAL
(p+1)) {

844 
v1
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

845 
v2
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
+1);

846 ià(
v1
 =ğ
v2
) {

847 
Ën
 = 
	`HLL_SPARSE_VAL_LEN
(
p
)+HLL_SPARSE_VAL_LEN(p+1);

848 ià(
Ën
 <ğ
HLL_SPARSE_VAL_MAX_LEN
) {

849 
	`HLL_SPARSE_VAL_SET
(
p
+1,
v1
,
Ën
);

850 
	`memmove
(
p
,p+1,
’d
-p);

851 
	`sdsInüL’
(
o
->
±r
,-1);

852 
’d
--;

860 
p
++;

864 
hdr
 = 
o
->
±r
;

865 
	`HLL_INVALIDATE_CACHE
(
hdr
);

868 
´omÙe
:

869 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
REDIS_ERR
)  -1;

870 
hdr
 = 
o
->
±r
;

879 
d’£_»tv®
 = 
	`hÎD’£Add
(
hdr
->
»gi¡”s
, 
–e
, 
–esize
);

880 
	`»disAs£¹
(
d’£_»tv®
 == 1);

881  
d’£_»tv®
;

882 
	}
}

888 
	$hÎS·r£Sum
(
ušt8_t
 *
¥¬£
, 
¥¬£Ën
, *
PE
, *
ezp
, *
šv®id
) {

889 
E
 = 0;

890 
ez
 = 0, 
idx
 = 0, 
ruÆ’
, 
»gv®
;

891 
ušt8_t
 *
’d
 = 
¥¬£
+
¥¬£Ën
, *
p
 = sparse;

893 
p
 < 
’d
) {

894 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

895 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

896 
idx
 +ğ
ruÆ’
;

897 
ez
 +ğ
ruÆ’
;

899 
p
++;

900 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

901 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

902 
idx
 +ğ
ruÆ’
;

903 
ez
 +ğ
ruÆ’
;

905 
p
 += 2;

907 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

908 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

909 
idx
 +ğ
ruÆ’
;

910 
E
 +ğ
PE
[
»gv®
]*
ruÆ’
;

911 
p
++;

914 ià(
idx
 !ğ
HLL_REGISTERS
 && 
šv®id
) *invalid = 1;

915 
E
 +ğ
ez
;

916 *
ezp
 = 
ez
;

917  
E
;

918 
	}
}

928 
	$hÎRawSum
(
ušt8_t
 *
»gi¡”s
, *
PE
, *
ezp
) {

929 
E
 = 0;

930 
j
, 
ez
 = 0;

931 
ušt64_t
 *
wÜd
 = (ušt64_t*è
»gi¡”s
;

932 
ušt8_t
 *
by‹s
;

934 
j
 = 0; j < 
HLL_REGISTERS
/8; j++) {

935 ià(*
wÜd
 == 0) {

936 
ez
 += 8;

938 
by‹s
 = (
ušt8_t
*è
wÜd
;

939 ià(
by‹s
[0]è
E
 +ğ
PE
[by‹s[0]]; 
ez
++;

940 ià(
by‹s
[1]è
E
 +ğ
PE
[by‹s[1]]; 
ez
++;

941 ià(
by‹s
[2]è
E
 +ğ
PE
[by‹s[2]]; 
ez
++;

942 ià(
by‹s
[3]è
E
 +ğ
PE
[by‹s[3]]; 
ez
++;

943 ià(
by‹s
[4]è
E
 +ğ
PE
[by‹s[4]]; 
ez
++;

944 ià(
by‹s
[5]è
E
 +ğ
PE
[by‹s[5]]; 
ez
++;

945 ià(
by‹s
[6]è
E
 +ğ
PE
[by‹s[6]]; 
ez
++;

946 ià(
by‹s
[7]è
E
 +ğ
PE
[by‹s[7]]; 
ez
++;

948 
wÜd
++;

950 
E
 +ğ
ez
;

952 *
ezp
 = 
ez
;

953  
E
;

954 
	}
}

967 
ušt64_t
 
	$hÎCouÁ
(
hÎhdr
 *
hdr
, *
šv®id
) {

968 
m
 = 
HLL_REGISTERS
;

969 
E
, 
®pha
 = 0.7213/(1+1.079/
m
);

970 
j
, 
ez
;

974 
š™Ÿlized
 = 0;

975 
PE
[64];

976 ià(!
š™Ÿlized
) {

977 
PE
[0] = 1;

978 
j
 = 1; j < 64; j++) {

980 
PE
[
j
] = 1.0/(1ULL << j);

982 
š™Ÿlized
 = 1;

986 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

987 
E
 = 
	`hÎD’£Sum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

988 } ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

989 
E
 = 
	`hÎS·r£Sum
(
hdr
->
»gi¡”s
,

990 
	`sd¦’
((
sds
)
hdr
)-
HLL_HDR_SIZE
,
PE
,&
ez
,
šv®id
);

991 } ià(
hdr
->
’codšg
 =ğ
HLL_RAW
) {

992 
E
 = 
	`hÎRawSum
(
hdr
->
»gi¡”s
,
PE
,&
ez
);

994 
	`»disPªic
("Unknown HyperLogLogƒncoding in hllCount()");

998 
E
 = (1/E)*
®pha
*
m
*m;

1005 ià(
E
 < 
m
*2.5 && 
ez
 != 0) {

1006 
E
 = 
m
*
	`log
(m/
ez
);

1007 } ià(
m
 =ğ16384 && 
E
 < 72000) {

1012 
bŸs
 = 5.9119*1.0e-18*(
E
*E*E*E)

1013 -1.4253*1.0e-12*(
E
*E*E)+

1014 1.2940*1.0e-7*(
E
*E)

1015 -5.2921*1.0e-3*
E
+

1017 
E
 -ğE*(
bŸs
/100);

1023  (
ušt64_t
è
E
;

1024 
	}
}

1027 
	$hÎAdd
(
robj
 *
o
, *
–e
, 
size_t
 
–esize
) {

1028 
hÎhdr
 *
hdr
 = 
o
->
±r
;

1029 
hdr
->
’codšg
) {

1030 
HLL_DENSE
:  
	`hÎD’£Add
(
hdr
->
»gi¡”s
,
–e
,
–esize
);

1031 
HLL_SPARSE
:  
	`hÎS·r£Add
(
o
,
–e
,
–esize
);

1034 
	}
}

1044 
	$hÎM”ge
(
ušt8_t
 *
max
, 
robj
 *
hÎ
) {

1045 
hÎhdr
 *
hdr
 = 
hÎ
->
±r
;

1046 
i
;

1048 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
) {

1049 
ušt8_t
 
v®
;

1051 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1052 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1053 ià(
v®
 > 
max
[
i
]) max[i] = val;

1056 
ušt8_t
 *
p
 = 
hÎ
->
±r
, *
’d
 =… + 
	`sd¦’
(hll->ptr);

1057 
ruÆ’
, 
»gv®
;

1059 
p
 +ğ
HLL_HDR_SIZE
;

1060 
i
 = 0;

1061 
p
 < 
’d
) {

1062 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1063 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1064 
i
 +ğ
ruÆ’
;

1065 
p
++;

1066 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1067 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1068 
i
 +ğ
ruÆ’
;

1069 
p
 += 2;

1071 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1072 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1073 
ruÆ’
--) {

1074 ià(
»gv®
 > 
max
[
i
]) max[i] =„egval;

1075 
i
++;

1077 
p
++;

1080 ià(
i
 !ğ
HLL_REGISTERS
è 
REDIS_ERR
;

1082  
REDIS_OK
;

1083 
	}
}

1089 
robj
 *
	$ü—‹HLLObjeù
() {

1090 
robj
 *
o
;

1091 
hÎhdr
 *
hdr
;

1092 
sds
 
s
;

1093 
ušt8_t
 *
p
;

1094 
¥¬£Ën
 = 
HLL_HDR_SIZE
 +

1095 (((
HLL_REGISTERS
+(
HLL_SPARSE_XZERO_MAX_LEN
-1)) /

1096 
HLL_SPARSE_XZERO_MAX_LEN
)*2);

1097 
aux
;

1101 
aux
 = 
HLL_REGISTERS
;

1102 
s
 = 
	`sd¢ewËn
(
NULL
,
¥¬£Ën
);

1103 
p
 = (
ušt8_t
*)
s
 + 
HLL_HDR_SIZE
;

1104 
aux
) {

1105 
xz”o
 = 
HLL_SPARSE_XZERO_MAX_LEN
;

1106 ià(
xz”o
 > 
aux
) xzero =‡ux;

1107 
	`HLL_SPARSE_XZERO_SET
(
p
,
xz”o
);

1108 
p
 += 2;

1109 
aux
 -ğ
xz”o
;

1111 
	`»disAs£¹
((
p
-(
ušt8_t
*)
s
è=ğ
¥¬£Ën
);

1114 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
s
);

1115 
hdr
 = 
o
->
±r
;

1116 
	`memıy
(
hdr
->
magic
,"HYLL",4);

1117 
hdr
->
’codšg
 = 
HLL_SPARSE
;

1118  
o
;

1119 
	}
}

1124 
	$isHLLObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
) {

1125 
hÎhdr
 *
hdr
;

1128 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
))

1129  
REDIS_ERR
;

1131 ià(
	`¡ršgObjeùL’
(
o
è< (*
hdr
)è
šv®id
;

1132 
hdr
 = 
o
->
±r
;

1135 ià(
hdr
->
magic
[0] != 'H' || hdr->magic[1] != 'Y' ||

1136 
hdr
->
magic
[2] !ğ'L' || hdr->magic[3] !ğ'L'è
šv®id
;

1138 ià(
hdr
->
’codšg
 > 
HLL_MAX_ENCODING
è
šv®id
;

1141 ià(
hdr
->
’codšg
 =ğ
HLL_DENSE
 &&

1142 
	`¡ršgObjeùL’
(
o
è!ğ
HLL_DENSE_SIZE
è
šv®id
;

1145  
REDIS_OK
;

1147 
šv®id
:

1148 
	`addR•lySds
(
c
,

1149 
	`sd¢ew
("-WRONGTYPE Key is‚ot‡ valid "

1151  
REDIS_ERR
;

1152 
	}
}

1155 
	$pçddCommªd
(
»disCl›Á
 *
c
) {

1156 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1157 
hÎhdr
 *
hdr
;

1158 
upd©ed
 = 0, 
j
;

1160 ià(
o
 =ğ
NULL
) {

1164 
o
 = 
	`ü—‹HLLObjeù
();

1165 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1166 
upd©ed
++;

1168 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
REDIS_OK
) ;

1169 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1172 
j
 = 2; j < 
c
->
¬gc
; j++) {

1173 
»tv®
 = 
	`hÎAdd
(
o
, (*)
c
->
¬gv
[
j
]->
±r
,

1174 
	`sd¦’
(
c
->
¬gv
[
j
]->
±r
));

1175 
»tv®
) {

1177 
upd©ed
++;

1180 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1184 
hdr
 = 
o
->
±r
;

1185 ià(
upd©ed
) {

1186 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1187 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1188 
£rv”
.
dœty
++;

1189 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1191 
	`addR•ly
(
c
, 
upd©ed
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1192 
	}
}

1195 
	$pfcouÁCommªd
(
»disCl›Á
 *
c
) {

1196 
robj
 *
o
;

1197 
hÎhdr
 *
hdr
;

1198 
ušt64_t
 
ÿrd
;

1204 ià(
c
->
¬gc
 > 2) {

1205 
ušt8_t
 
max
[
HLL_HDR_SIZE
+
HLL_REGISTERS
], *
»gi¡”s
;

1206 
j
;

1209 
	`mem£t
(
max
,0,(max));

1210 
hdr
 = (
hÎhdr
*è
max
;

1211 
hdr
->
’codšg
 = 
HLL_RAW
;

1212 
»gi¡”s
 = 
max
 + 
HLL_HDR_SIZE
;

1213 
j
 = 1; j < 
c
->
¬gc
; j++) {

1215 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1216 ià(
o
 =ğ
NULL
) ;

1217 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
REDIS_OK
) ;

1221 ià(
	`hÎM”ge
(
»gi¡”s
,
o
è=ğ
REDIS_ERR
) {

1222 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1228 
	`addR•lyLÚgLÚg
(
c
,
	`hÎCouÁ
(
hdr
,
NULL
));

1236 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

1237 ià(
o
 =ğ
NULL
) {

1240 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1242 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
REDIS_OK
) ;

1243 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1246 
hdr
 = 
o
->
±r
;

1247 ià(
	`HLL_VALID_CACHE
(
hdr
)) {

1249 
ÿrd
 = (
ušt64_t
)
hdr
->card[0];

1250 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[1] << 8;

1251 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[2] << 16;

1252 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[3] << 24;

1253 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[4] << 32;

1254 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[5] << 40;

1255 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[6] << 48;

1256 
ÿrd
 |ğ(
ušt64_t
)
hdr
->card[7] << 56;

1258 
šv®id
 = 0;

1260 
ÿrd
 = 
	`hÎCouÁ
(
hdr
,&
šv®id
);

1261 ià(
šv®id
) {

1262 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1265 
hdr
->
ÿrd
[0] = card & 0xff;

1266 
hdr
->
ÿrd
[1] = (card >> 8) & 0xff;

1267 
hdr
->
ÿrd
[2] = (card >> 16) & 0xff;

1268 
hdr
->
ÿrd
[3] = (card >> 24) & 0xff;

1269 
hdr
->
ÿrd
[4] = (card >> 32) & 0xff;

1270 
hdr
->
ÿrd
[5] = (card >> 40) & 0xff;

1271 
hdr
->
ÿrd
[6] = (card >> 48) & 0xff;

1272 
hdr
->
ÿrd
[7] = (card >> 56) & 0xff;

1277 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1278 
£rv”
.
dœty
++;

1280 
	`addR•lyLÚgLÚg
(
c
,
ÿrd
);

1282 
	}
}

1285 
	$pfm”geCommªd
(
»disCl›Á
 *
c
) {

1286 
ušt8_t
 
max
[
HLL_REGISTERS
];

1287 
hÎhdr
 *
hdr
;

1288 
j
;

1293 
	`mem£t
(
max
,0,(max));

1294 
j
 = 1; j < 
c
->
¬gc
; j++) {

1296 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

1297 ià(
o
 =ğ
NULL
) ;

1298 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
REDIS_OK
) ;

1302 ià(
	`hÎM”ge
(
max
,
o
è=ğ
REDIS_ERR
) {

1303 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1309 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

1310 ià(
o
 =ğ
NULL
) {

1314 
o
 = 
	`ü—‹HLLObjeù
();

1315 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

1320 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

1324 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
REDIS_ERR
) {

1325 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1331 
hdr
 = 
o
->
±r
;

1332 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1333 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
j
,
max
[j]);

1335 
	`HLL_INVALIDATE_CACHE
(
hdr
);

1337 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

1340 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"pçdd",
c
->
¬gv
[1],c->
db
->
id
);

1341 
£rv”
.
dœty
++;

1342 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1343 
	}
}

1350 
	#HLL_TEST_CYCLES
 1000

	)

1351 
	$pf£láe¡Commªd
(
»disCl›Á
 *
c
) {

1352 
j
, 
i
;

1353 
sds
 
b™couÁ”s
 = 
	`sd¢ewËn
(
NULL
,
HLL_DENSE_SIZE
);

1354 
hÎhdr
 *
hdr
 = (hÎhdr*è
b™couÁ”s
, *
hdr2
;

1355 
robj
 *
o
 = 
NULL
;

1356 
ušt8_t
 
by‹couÁ”s
[
HLL_REGISTERS
];

1362 
j
 = 0; j < 
HLL_TEST_CYCLES
; j++) {

1365 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1366 
r
 = 
	`¿nd
(è& 
HLL_REGISTER_MAX
;

1368 
by‹couÁ”s
[
i
] = 
r
;

1369 
	`HLL_DENSE_SET_REGISTER
(
hdr
->
»gi¡”s
,
i
,
r
);

1372 
i
 = 0; i < 
HLL_REGISTERS
; i++) {

1373 
v®
;

1375 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
i
);

1376 ià(
v®
 !ğ
by‹couÁ”s
[
i
]) {

1377 
	`addR•lyE¼ÜFÜm©
(
c
,

1379 
i
, (è
by‹couÁ”s
[i], (è
v®
);

1380 
ş—nup
;

1395 
	`mem£t
(
hdr
->
»gi¡”s
,0,
HLL_DENSE_SIZE
-
HLL_HDR_SIZE
);

1396 
o
 = 
	`ü—‹HLLObjeù
();

1397 
»Ë¼
 = 1.04/
	`sq¹
(
HLL_REGISTERS
);

1398 
št64_t
 
checkpošt
 = 1;

1399 
ušt64_t
 
£ed
 = (ušt64_t)
	`¿nd
() | (uint64_t)rand() << 32;

1400 
ušt64_t
 
–e
;

1401 
j
 = 1; j <= 10000000; j++) {

1402 
–e
 = 
j
 ^ 
£ed
;

1403 
	`hÎD’£Add
(
hdr
->
»gi¡”s
,(*)&
–e
,(ele));

1404 
	`hÎAdd
(
o
,(*)&
–e
,(ele));

1408 ià(
j
 =ğ
checkpošt
 && j < 
£rv”
.
hÎ_¥¬£_max_by‹s
/2) {

1409 
hdr2
 = 
o
->
±r
;

1410 ià(
hdr2
->
’codšg
 !ğ
HLL_SPARSE
) {

1411 
	`addR•lyE¼Ü
(
c
, "TESTFAILED sparseƒncoding‚ot used");

1412 
ş—nup
;

1417 ià(
j
 =ğ
checkpošt
 && 
	`hÎCouÁ
(
hdr
,
NULL
è!ğhÎCouÁ(
o
->
±r
,NULL)) {

1418 
	`addR•lyE¼Ü
(
c
, "TESTFAILED dense/sparse disagree");

1419 
ş—nup
;

1423 ià(
j
 =ğ
checkpošt
) {

1424 
št64_t
 
ab£¼
 = 
checkpošt
 - (št64_t)
	`hÎCouÁ
(
hdr
,
NULL
);

1425 
ušt64_t
 
max”r
 = 
	`û
(
»Ë¼
*6*
checkpošt
);

1431 ià(
j
 =ğ10è
max”r
 = 1;

1433 ià(
ab£¼
 < 0)‡bserr = -abserr;

1434 ià(
ab£¼
 > (
št64_t
)
max”r
) {

1435 
	`addR•lyE¼ÜFÜm©
(
c
,

1437 (è
checkpošt
,

1438 (è
ab£¼
);

1439 
ş—nup
;

1441 
checkpošt
 *= 10;

1446 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1448 
ş—nup
:

1449 
	`sdsä“
(
b™couÁ”s
);

1450 ià(
o
è
	`deüRefCouÁ
(o);

1451 
	}
}

1455 
	$pfdebugCommªd
(
»disCl›Á
 *
c
) {

1456 *
cmd
 = 
c
->
¬gv
[1]->
±r
;

1457 
hÎhdr
 *
hdr
;

1458 
robj
 *
o
;

1459 
j
;

1461 
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[2]);

1462 ià(
o
 =ğ
NULL
) {

1463 
	`addR•lyE¼Ü
(
c
,"The specified key does‚otƒxist");

1466 ià(
	`isHLLObjeùOrR•ly
(
c
,
o
è!ğ
REDIS_OK
) ;

1467 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[2],o);

1468 
hdr
 = 
o
->
±r
;

1471 ià(!
	`¡rÿ£cmp
(
cmd
,"getreg")) {

1472 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1474 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1475 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
REDIS_ERR
) {

1476 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1479 
£rv”
.
dœty
++;

1482 
hdr
 = 
o
->
±r
;

1483 
	`addR•lyMuÉiBulkL’
(
c
,
HLL_REGISTERS
);

1484 
j
 = 0; j < 
HLL_REGISTERS
; j++) {

1485 
ušt8_t
 
v®
;

1487 
	`HLL_DENSE_GET_REGISTER
(
v®
,
hdr
->
»gi¡”s
,
j
);

1488 
	`addR•lyLÚgLÚg
(
c
,
v®
);

1492 ià(!
	`¡rÿ£cmp
(
cmd
,"decode")) {

1493 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1495 
ušt8_t
 *
p
 = 
o
->
±r
, *
’d
 =…+
	`sd¦’
(o->ptr);

1496 
sds
 
decoded
 = 
	`sd£m±y
();

1498 ià(
hdr
->
’codšg
 !ğ
HLL_SPARSE
) {

1499 
	`addR•lyE¼Ü
(
c
,"HLLƒncoding is‚ot sparse");

1503 
p
 +ğ
HLL_HDR_SIZE
;

1504 
p
 < 
’d
) {

1505 
ruÆ’
, 
»gv®
;

1507 ià(
	`HLL_SPARSE_IS_ZERO
(
p
)) {

1508 
ruÆ’
 = 
	`HLL_SPARSE_ZERO_LEN
(
p
);

1509 
p
++;

1510 
decoded
 = 
	`sdsÿrštf
(decoded,"z:%d ",
ruÆ’
);

1511 } ià(
	`HLL_SPARSE_IS_XZERO
(
p
)) {

1512 
ruÆ’
 = 
	`HLL_SPARSE_XZERO_LEN
(
p
);

1513 
p
 += 2;

1514 
decoded
 = 
	`sdsÿrštf
(decoded,"Z:%d ",
ruÆ’
);

1516 
ruÆ’
 = 
	`HLL_SPARSE_VAL_LEN
(
p
);

1517 
»gv®
 = 
	`HLL_SPARSE_VAL_VALUE
(
p
);

1518 
p
++;

1519 
decoded
 = 
	`sdsÿrštf
(decoded,"v:%d,%d ",
»gv®
,
ruÆ’
);

1522 
decoded
 = 
	`sd¡rim
(decoded," ");

1523 
	`addR•lyBulkCBufãr
(
c
,
decoded
,
	`sd¦’
(decoded));

1524 
	`sdsä“
(
decoded
);

1527 ià(!
	`¡rÿ£cmp
(
cmd
,"encoding")) {

1528 *
’codšg¡r
[2] = {"dense","sparse"};

1529 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1531 
	`addR•lyStus
(
c
,
’codšg¡r
[
hdr
->
’codšg
]);

1534 ià(!
	`¡rÿ£cmp
(
cmd
,"todense")) {

1535 
cÚv
 = 0;

1536 ià(
c
->
¬gc
 !ğ3è
¬™y”r
;

1538 ià(
hdr
->
’codšg
 =ğ
HLL_SPARSE
) {

1539 ià(
	`hÎS·r£ToD’£
(
o
è=ğ
REDIS_ERR
) {

1540 
	`addR•lySds
(
c
,
	`sd¢ew
(
šv®id_hÎ_”r
));

1543 
cÚv
 = 1;

1544 
£rv”
.
dœty
++;

1546 
	`addR•ly
(
c
,
cÚv
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

1548 
	`addR•lyE¼ÜFÜm©
(
c
,"UnknowÀPFDEBUG subcommªd '%s'", 
cmd
);

1552 
¬™y”r
:

1553 
	`addR•lyE¼ÜFÜm©
(
c
,

1554 "WrÚg‚umb” oà¬gum’t fÜh'%s' subcommªd",
cmd
);

1555 
	}
}

	@intset.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~"št£t.h
"

35 
	~"zm®loc.h
"

36 
	~"’dŸncÚv.h
"

40 
	#INTSET_ENC_INT16
 ((
št16_t
))

	)

41 
	#INTSET_ENC_INT32
 ((
št32_t
))

	)

42 
	#INTSET_ENC_INT64
 ((
št64_t
))

	)

45 
ušt8_t
 
	$_št£tV®ueEncodšg
(
št64_t
 
v
) {

46 ià(
v
 < 
INT32_MIN
 || v > 
INT32_MAX
)

47  
INTSET_ENC_INT64
;

48 ià(
v
 < 
INT16_MIN
 || v > 
INT16_MAX
)

49  
INTSET_ENC_INT32
;

51  
INTSET_ENC_INT16
;

52 
	}
}

55 
št64_t
 
	$_št£tG‘Encoded
(
št£t
 *
is
, 
pos
, 
ušt8_t
 
’c
) {

56 
št64_t
 
v64
;

57 
št32_t
 
v32
;

58 
št16_t
 
v16
;

60 ià(
’c
 =ğ
INTSET_ENC_INT64
) {

61 
	`memıy
(&
v64
,((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
,(v64));

62 
	`mem»v64ifbe
(&
v64
);

63  
v64
;

64 } ià(
’c
 =ğ
INTSET_ENC_INT32
) {

65 
	`memıy
(&
v32
,((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
,(v32));

66 
	`mem»v32ifbe
(&
v32
);

67  
v32
;

69 
	`memıy
(&
v16
,((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
,(v16));

70 
	`mem»v16ifbe
(&
v16
);

71  
v16
;

73 
	}
}

76 
št64_t
 
	$_št£tG‘
(
št£t
 *
is
, 
pos
) {

77  
	`_št£tG‘Encoded
(
is
,
pos
,
	`šŒev32ifbe
(is->
’codšg
));

78 
	}
}

81 
	$_št£tS‘
(
št£t
 *
is
, 
pos
, 
št64_t
 
v®ue
) {

82 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

84 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

85 ((
št64_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

86 
	`mem»v64ifbe
(((
št64_t
*)
is
->
cÚ‹Ás
)+
pos
);

87 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

88 ((
št32_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

89 
	`mem»v32ifbe
(((
št32_t
*)
is
->
cÚ‹Ás
)+
pos
);

91 ((
št16_t
*)
is
->
cÚ‹Ás
)[
pos
] = 
v®ue
;

92 
	`mem»v16ifbe
(((
št16_t
*)
is
->
cÚ‹Ás
)+
pos
);

94 
	}
}

97 
št£t
 *
	$št£tNew
() {

98 
št£t
 *
is
 = 
	`zm®loc
((intset));

99 
is
->
’codšg
 = 
	`šŒev32ifbe
(
INTSET_ENC_INT16
);

100 
is
->
Ëngth
 = 0;

101  
is
;

102 
	}
}

105 
št£t
 *
	$št£tResize
(
št£t
 *
is
, 
ušt32_t
 
Ën
) {

106 
ušt32_t
 
size
 = 
Ën
*
	`šŒev32ifbe
(
is
->
’codšg
);

107 
is
 = 
	`z»®loc
(is,(
št£t
)+
size
);

108  
is
;

109 
	}
}

115 
ušt8_t
 
	$št£tS—rch
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt32_t
 *
pos
) {

116 
mš
 = 0, 
max
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-1, 
mid
 = -1;

117 
št64_t
 
cur
 = -1;

120 ià(
	`šŒev32ifbe
(
is
->
Ëngth
) == 0) {

121 ià(
pos
) *pos = 0;

126 ià(
v®ue
 > 
	`_št£tG‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
)-1)) {

127 ià(
pos
è*po ğ
	`šŒev32ifbe
(
is
->
Ëngth
);

129 } ià(
v®ue
 < 
	`_št£tG‘
(
is
,0)) {

130 ià(
pos
) *pos = 0;

135 
max
 >ğ
mš
) {

136 
mid
 = (()
mš
 + ()
max
) >> 1;

137 
cur
 = 
	`_št£tG‘
(
is
,
mid
);

138 ià(
v®ue
 > 
cur
) {

139 
mš
 = 
mid
+1;

140 } ià(
v®ue
 < 
cur
) {

141 
max
 = 
mid
-1;

147 ià(
v®ue
 =ğ
cur
) {

148 ià(
pos
è*po ğ
mid
;

151 ià(
pos
è*po ğ
mš
;

154 
	}
}

157 
št£t
 *
	$št£tUpg¿deAndAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

158 
ušt8_t
 
cu»nc
 = 
	`šŒev32ifbe
(
is
->
’codšg
);

159 
ušt8_t
 
Ãw’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

160 
Ëngth
 = 
	`šŒev32ifbe
(
is
->length);

161 
´•’d
 = 
v®ue
 < 0 ? 1 : 0;

164 
is
->
’codšg
 = 
	`šŒev32ifbe
(
Ãw’c
);

165 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

170 
Ëngth
--)

171 
	`_št£tS‘
(
is
,
Ëngth
+
´•’d
,
	`_št£tG‘Encoded
(is,Ëngth,
cu»nc
));

174 ià(
´•’d
)

175 
	`_št£tS‘
(
is
,0,
v®ue
);

177 
	`_št£tS‘
(
is
,
	`šŒev32ifbe
(is->
Ëngth
),
v®ue
);

178 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

179  
is
;

180 
	}
}

182 
	$št£tMoveTa
(
št£t
 *
is
, 
ušt32_t
 
äom
, ušt32_ˆ
to
) {

183 *
¤c
, *
d¡
;

184 
ušt32_t
 
by‹s
 = 
	`šŒev32ifbe
(
is
->
Ëngth
)-
äom
;

185 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

187 ià(
’codšg
 =ğ
INTSET_ENC_INT64
) {

188 
¤c
 = (
št64_t
*)
is
->
cÚ‹Ás
+
äom
;

189 
d¡
 = (
št64_t
*)
is
->
cÚ‹Ás
+
to
;

190 
by‹s
 *ğ(
št64_t
);

191 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

192 
¤c
 = (
št32_t
*)
is
->
cÚ‹Ás
+
äom
;

193 
d¡
 = (
št32_t
*)
is
->
cÚ‹Ás
+
to
;

194 
by‹s
 *ğ(
št32_t
);

196 
¤c
 = (
št16_t
*)
is
->
cÚ‹Ás
+
äom
;

197 
d¡
 = (
št16_t
*)
is
->
cÚ‹Ás
+
to
;

198 
by‹s
 *ğ(
št16_t
);

200 
	`memmove
(
d¡
,
¤c
,
by‹s
);

201 
	}
}

204 
št£t
 *
	$št£tAdd
(
št£t
 *
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
) {

205 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

206 
ušt32_t
 
pos
;

207 ià(
sucûss
) *success = 1;

212 ià(
v®’c
 > 
	`šŒev32ifbe
(
is
->
’codšg
)) {

214  
	`št£tUpg¿deAndAdd
(
is
,
v®ue
);

219 ià(
	`št£tS—rch
(
is
,
v®ue
,&
pos
)) {

220 ià(
sucûss
) *success = 0;

221  
is
;

224 
is
 = 
	`št£tResize
(is,
	`šŒev32ifbe
(is->
Ëngth
)+1);

225 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)è
	`št£tMoveTa
(is,pos,pos+1);

228 
	`_št£tS‘
(
is
,
pos
,
v®ue
);

229 
is
->
Ëngth
 = 
	`šŒev32ifbe
(intrev32ifbe(is->length)+1);

230  
is
;

231 
	}
}

234 
št£t
 *
	$št£tRemove
(
št£t
 *
is
, 
št64_t
 
v®ue
, *
sucûss
) {

235 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

236 
ušt32_t
 
pos
;

237 ià(
sucûss
) *success = 0;

239 ià(
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,&
pos
)) {

240 
ušt32_t
 
Ën
 = 
	`šŒev32ifbe
(
is
->
Ëngth
);

243 ià(
sucûss
) *success = 1;

246 ià(
pos
 < (
Ën
-1)è
	`št£tMoveTa
(
is
,pos+1,pos);

247 
is
 = 
	`št£tResize
(is,
Ën
-1);

248 
is
->
Ëngth
 = 
	`šŒev32ifbe
(
Ën
-1);

250  
is
;

251 
	}
}

254 
ušt8_t
 
	$št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
) {

255 
ušt8_t
 
v®’c
 = 
	`_št£tV®ueEncodšg
(
v®ue
);

256  
v®’c
 <ğ
	`šŒev32ifbe
(
is
->
’codšg
è&& 
	`št£tS—rch
(is,
v®ue
,
NULL
);

257 
	}
}

260 
št64_t
 
	$št£tRªdom
(
št£t
 *
is
) {

261  
	`_št£tG‘
(
is
,
	`¿nd
()%
	`šŒev32ifbe
(is->
Ëngth
));

262 
	}
}

266 
ušt8_t
 
	$št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
) {

267 ià(
pos
 < 
	`šŒev32ifbe
(
is
->
Ëngth
)) {

268 *
v®ue
 = 
	`_št£tG‘
(
is
,
pos
);

272 
	}
}

275 
ušt32_t
 
	$št£tL’
(
št£t
 *
is
) {

276  
	`šŒev32ifbe
(
is
->
Ëngth
);

277 
	}
}

280 
size_t
 
	$št£tBlobL’
(
št£t
 *
is
) {

281  (
št£t
)+
	`šŒev32ifbe
(
is
->
Ëngth
)*šŒev32ifbe(is->
’codšg
);

282 
	}
}

284 #ifdeà
INTSET_TEST_MAIN


285 
	~<sys/time.h
>

287 
	$št£tR•r
(
št£t
 *
is
) {

288 
i
;

289 
i
 = 0; i < 
	`šŒev32ifbe
(
is
->
Ëngth
); i++) {

290 
	`´štf
("%Îd\n", (
ušt64_t
)
	`_št£tG‘
(
is
,
i
));

292 
	`´štf
("\n");

293 
	}
}

295 
	$”rÜ
(*
”r
) {

296 
	`´štf
("%s\n", 
”r
);

297 
	`ex™
(1);

298 
	}
}

300 
	$ok
() {

301 
	`´štf
("OK\n");

302 
	}
}

304 
	$u£c
() {

305 
timev®
 
tv
;

306 
	`g‘timeofday
(&
tv
,
NULL
);

307  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

308 
	}
}

310 
	#as£¹
(
_e
è((_e)?()0:(
	`_as£¹
(#_e,
__FILE__
,
__LINE__
),
	`ex™
(1)))

	)

311 
	$_as£¹
(*
e¡r
, *
fe
, 
lše
) {

312 
	`´štf
("\n\n=== ASSERTION FAILED ===\n");

313 
	`´štf
("==> %s:%d '%s' i nÙrue\n",
fe
,
lše
,
e¡r
);

314 
	}
}

316 
št£t
 *
	$ü—‹S‘
(
b™s
, 
size
) {

317 
ušt64_t
 
mask
 = (1<<
b™s
)-1;

318 
ušt64_t
 
i
, 
v®ue
;

319 
št£t
 *
is
 = 
	`št£tNew
();

321 
i
 = 0; i < 
size
; i++) {

322 ià(
b™s
 > 32) {

323 
v®ue
 = (
	`¿nd
()*¿nd()è& 
mask
;

325 
v®ue
 = 
	`¿nd
(è& 
mask
;

327 
is
 = 
	`št£tAdd
(is,
v®ue
,
NULL
);

329  
is
;

330 
	}
}

332 
	$checkCÚsi¡’cy
(
št£t
 *
is
) {

333 
i
;

335 
i
 = 0; i < (
	`šŒev32ifbe
(
is
->
Ëngth
)-1); i++) {

336 
ušt32_t
 
’codšg
 = 
	`šŒev32ifbe
(
is
->encoding);

338 ià(
’codšg
 =ğ
INTSET_ENC_INT16
) {

339 
št16_t
 *
i16
 = (št16_t*)
is
->
cÚ‹Ás
;

340 
	`as£¹
(
i16
[
i
] < i16[i+1]);

341 } ià(
’codšg
 =ğ
INTSET_ENC_INT32
) {

342 
št32_t
 *
i32
 = (št32_t*)
is
->
cÚ‹Ás
;

343 
	`as£¹
(
i32
[
i
] < i32[i+1]);

345 
št64_t
 *
i64
 = (št64_t*)
is
->
cÚ‹Ás
;

346 
	`as£¹
(
i64
[
i
] < i64[i+1]);

349 
	}
}

351 
	$maš
(
¬gc
, **
¬gv
) {

352 
ušt8_t
 
sucûss
;

353 
i
;

354 
št£t
 *
is
;

355 
	`¤ªddev
();

357 
	`´štf
("Valueƒncodings: "); {

358 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32768è=ğ
INTSET_ENC_INT16
);

359 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32767è=ğ
INTSET_ENC_INT16
);

360 
	`as£¹
(
	`_št£tV®ueEncodšg
(-32769è=ğ
INTSET_ENC_INT32
);

361 
	`as£¹
(
	`_št£tV®ueEncodšg
(+32768è=ğ
INTSET_ENC_INT32
);

362 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483648è=ğ
INTSET_ENC_INT32
);

363 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483647è=ğ
INTSET_ENC_INT32
);

364 
	`as£¹
(
	`_št£tV®ueEncodšg
(-2147483649è=ğ
INTSET_ENC_INT64
);

365 
	`as£¹
(
	`_št£tV®ueEncodšg
(+2147483648è=ğ
INTSET_ENC_INT64
);

366 
	`as£¹
(
	`_št£tV®ueEncodšg
(-9223372036854775808uÎè=ğ
INTSET_ENC_INT64
);

367 
	`as£¹
(
	`_št£tV®ueEncodšg
(+9223372036854775807uÎè=ğ
INTSET_ENC_INT64
);

368 
	`ok
();

371 
	`´štf
("Basic‡dding: "); {

372 
is
 = 
	`št£tNew
();

373 
is
 = 
	`št£tAdd
(is,5,&
sucûss
); 
	`as£¹
(success);

374 
is
 = 
	`št£tAdd
(is,6,&
sucûss
); 
	`as£¹
(success);

375 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(success);

376 
is
 = 
	`št£tAdd
(is,4,&
sucûss
); 
	`as£¹
(!success);

377 
	`ok
();

380 
	`´štf
("Large‚umber of„andom‡dds: "); {

381 
š£¹s
 = 0;

382 
is
 = 
	`št£tNew
();

383 
i
 = 0; i < 1024; i++) {

384 
is
 = 
	`št£tAdd
(is,
	`¿nd
()%0x800,&
sucûss
);

385 ià(
sucûss
è
š£¹s
++;

387 
	`as£¹
(
	`šŒev32ifbe
(
is
->
Ëngth
è=ğ
š£¹s
);

388 
	`checkCÚsi¡’cy
(
is
);

389 
	`ok
();

392 
	`´štf
("Upgrade from int16o int32: "); {

393 
is
 = 
	`št£tNew
();

394 
is
 = 
	`št£tAdd
(is,32,
NULL
);

395 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

396 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

397 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

398 
	`as£¹
(
	`št£tFšd
(
is
,32));

399 
	`as£¹
(
	`št£tFšd
(
is
,65535));

400 
	`checkCÚsi¡’cy
(
is
);

402 
is
 = 
	`št£tNew
();

403 
is
 = 
	`št£tAdd
(is,32,
NULL
);

404 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

405 
is
 = 
	`št£tAdd
(is,-65535,
NULL
);

406 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

407 
	`as£¹
(
	`št£tFšd
(
is
,32));

408 
	`as£¹
(
	`št£tFšd
(
is
,-65535));

409 
	`checkCÚsi¡’cy
(
is
);

410 
	`ok
();

413 
	`´štf
("Upgrade from int16o int64: "); {

414 
is
 = 
	`št£tNew
();

415 
is
 = 
	`št£tAdd
(is,32,
NULL
);

416 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

417 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

418 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

419 
	`as£¹
(
	`št£tFšd
(
is
,32));

420 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

421 
	`checkCÚsi¡’cy
(
is
);

423 
is
 = 
	`št£tNew
();

424 
is
 = 
	`št£tAdd
(is,32,
NULL
);

425 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT16
);

426 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

427 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

428 
	`as£¹
(
	`št£tFšd
(
is
,32));

429 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

430 
	`checkCÚsi¡’cy
(
is
);

431 
	`ok
();

434 
	`´štf
("Upgrade from int32o int64: "); {

435 
is
 = 
	`št£tNew
();

436 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

437 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

438 
is
 = 
	`št£tAdd
(is,4294967295,
NULL
);

439 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

440 
	`as£¹
(
	`št£tFšd
(
is
,65535));

441 
	`as£¹
(
	`št£tFšd
(
is
,4294967295));

442 
	`checkCÚsi¡’cy
(
is
);

444 
is
 = 
	`št£tNew
();

445 
is
 = 
	`št£tAdd
(is,65535,
NULL
);

446 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT32
);

447 
is
 = 
	`št£tAdd
(is,-4294967295,
NULL
);

448 
	`as£¹
(
	`šŒev32ifbe
(
is
->
’codšg
è=ğ
INTSET_ENC_INT64
);

449 
	`as£¹
(
	`št£tFšd
(
is
,65535));

450 
	`as£¹
(
	`št£tFšd
(
is
,-4294967295));

451 
	`checkCÚsi¡’cy
(
is
);

452 
	`ok
();

455 
	`´štf
("Stress†ookups: "); {

456 
num
 = 100000, 
size
 = 10000;

457 
i
, 
b™s
 = 20;

458 
¡¬t
;

459 
is
 = 
	`ü—‹S‘
(
b™s
,
size
);

460 
	`checkCÚsi¡’cy
(
is
);

462 
¡¬t
 = 
	`u£c
();

463 
i
 = 0; i < 
num
; i++è
	`št£tS—rch
(
is
,
	`¿nd
(è% ((1<<
b™s
)-1),
NULL
);

464 
	`´štf
("%ld†ookups, %ldƒËm’ˆ£t, %Îdu£c\n",
num
,
size
,
	`u£c
()-
¡¬t
);

467 
	`´štf
("Stress‡dd+delete: "); {

468 
i
, 
v1
, 
v2
;

469 
is
 = 
	`št£tNew
();

470 
i
 = 0; i < 0xffff; i++) {

471 
v1
 = 
	`¿nd
() % 0xfff;

472 
is
 = 
	`št£tAdd
(is,
v1
,
NULL
);

473 
	`as£¹
(
	`št£tFšd
(
is
,
v1
));

475 
v2
 = 
	`¿nd
() % 0xfff;

476 
is
 = 
	`št£tRemove
(is,
v2
,
NULL
);

477 
	`as£¹
(!
	`št£tFšd
(
is
,
v2
));

479 
	`checkCÚsi¡’cy
(
is
);

480 
	`ok
();

482 
	}
}

	@intset.h

31 #iâdeà
__INTSET_H


32 
	#__INTSET_H


	)

33 
	~<¡dšt.h
>

35 
	sšt£t
 {

36 
ušt32_t
 
	m’codšg
;

37 
ušt32_t
 
	mËngth
;

38 
št8_t
 
	mcÚ‹Ás
[];

39 } 
	tšt£t
;

41 
št£t
 *
št£tNew
();

42 
št£t
 *
št£tAdd
(št£ˆ*
is
, 
št64_t
 
v®ue
, 
ušt8_t
 *
sucûss
);

43 
št£t
 *
št£tRemove
(št£ˆ*
is
, 
št64_t
 
v®ue
, *
sucûss
);

44 
ušt8_t
 
št£tFšd
(
št£t
 *
is
, 
št64_t
 
v®ue
);

45 
št64_t
 
št£tRªdom
(
št£t
 *
is
);

46 
ušt8_t
 
št£tG‘
(
št£t
 *
is
, 
ušt32_t
 
pos
, 
št64_t
 *
v®ue
);

47 
ušt32_t
 
št£tL’
(
št£t
 *
is
);

48 
size_t
 
št£tBlobL’
(
št£t
 *
is
);

	@latency.c

36 
	~"»dis.h
"

39 
	$diùSŒšgKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
) {

40 
	`REDIS_NOTUSED
(
´ivd©a
);

41  
	`¡rcmp
(
key1
,
key2
) == 0;

42 
	}
}

44 
	$diùSŒšgHash
(cÚ¡ *
key
) {

45  
	`diùG’HashFunùiÚ
(
key
, 
	`¡¾’
(key));

46 
	}
}

48 
diùVªÏF»e
(*
´ivd©a
, *
v®
);

50 
diùTy³
 
	gÏ‹ncyTimeS”›sDiùTy³
 = {

51 
diùSŒšgHash
,

52 
NULL
,

53 
NULL
,

54 
diùSŒšgKeyCom·»
,

55 
diùVªÏF»e
,

56 
diùVªÏF»e


61 #ifdeà
__lšux__


64 
	$THPIsEÇbËd
() {

65 
buf
[1024];

67 
FILE
 *
å
 = 
	`fİ’
("/sys/kernel/mm/transparent_hugepage/enabled","r");

68 ià(!
å
)  0;

69 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

70 
	`fşo£
(
å
);

73 
	`fşo£
(
å
);

74  (
	`¡r¡r
(
buf
,"[Ãv”]"è=ğ
NULL
) ? 1 : 0;

75 
	}
}

81 
	$THPG‘AnÚHugePagesSize
() {

82  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("AnonHugePages:");

83 
	}
}

90 
	$Ï‹ncyMÚ™ÜIn™
() {

91 
£rv”
.
Ï‹ncy_ev’ts
 = 
	`diùC»©e
(&
Ï‹ncyTimeS”›sDiùTy³
,
NULL
);

92 
	}
}

98 
	$Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
) {

99 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

100 
time_t
 
now
 = 
	`time
(
NULL
);

101 
´ev
;

104 ià(
ts
 =ğ
NULL
) {

105 
ts
 = 
	`zm®loc
((*ts));

106 
ts
->
idx
 = 0;

107 
ts
->
max
 = 0;

108 
	`mem£t
(
ts
->
§m¶es
,0,(ts->samples));

109 
	`diùAdd
(
£rv”
.
Ï‹ncy_ev’ts
,
	`z¡rdup
(
ev’t
),
ts
);

114 
´ev
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

115 ià(
ts
->
§m¶es
[
´ev
].
time
 =ğ
now
) {

116 ià(
Ï‹ncy
 > 
ts
->
§m¶es
[
´ev
].latency)

117 
ts
->
§m¶es
[
´ev
].
Ï‹ncy
 =†atency;

121 
ts
->
§m¶es
[ts->
idx
].
time
 = 
	`time
(
NULL
);

122 
ts
->
§m¶es
[ts->
idx
].
Ï‹ncy
 =†atency;

123 ià(
Ï‹ncy
 > 
ts
->
max
)s->max =†atency;

125 
ts
->
idx
++;

126 ià(
ts
->
idx
 =ğ
LATENCY_TS_LEN
)s->idx = 0;

127 
	}
}

134 
	$Ï‹ncyRe£tEv’t
(*
ev’t_to_»£t
) {

135 
diùI‹¿tÜ
 *
di
;

136 
diùEÁry
 *
de
;

137 
»£ts
 = 0;

139 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

140 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

141 *
ev’t
 = 
	`diùG‘Key
(
de
);

143 ià(
ev’t_to_»£t
 =ğ
NULL
 || 
	`¡rÿ£cmp
(
ev’t
,event_to_reset) == 0) {

144 
	`diùD–‘e
(
£rv”
.
Ï‹ncy_ev’ts
, 
ev’t
);

145 
»£ts
++;

148 
	`diùR–—£I‹¿tÜ
(
di
);

149  
»£ts
;

150 
	}
}

159 
	$ª®yzeL©’cyFÜEv’t
(*
ev’t
, 
Ï‹ncySts
 *
ls
) {

160 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
ev’t
);

161 
j
;

162 
ušt64_t
 
sum
;

164 
ls
->
®l_time_high
 = 
ts
 ?s->
max
 : 0;

165 
ls
->
avg
 = 0;

166 
ls
->
mš
 = 0;

167 
ls
->
max
 = 0;

168 
ls
->
mad
 = 0;

169 
ls
->
§m¶es
 = 0;

170 
ls
->
³riod
 = 0;

171 ià(!
ts
) ;

174 
sum
 = 0;

175 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

176 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

177 
ls
->
§m¶es
++;

178 ià(
ls
->
§m¶es
 == 1) {

179 
ls
->
mš
 =†s->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

181 ià(
ls
->
mš
 > 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

182 
ls
->
mš
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

183 ià(
ls
->
max
 < 
ts
->
§m¶es
[
j
].
Ï‹ncy
)

184 
ls
->
max
 = 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

186 
sum
 +ğ
ts
->
§m¶es
[
j
].
Ï‹ncy
;

189 ià(
ls
->
³riod
 =ğ0 || 
ts
->
§m¶es
[
j
].
time
 <†s->period)

190 
ls
->
³riod
 = 
ts
->
§m¶es
[
j
].
time
;

196 ià(
ls
->
§m¶es
) {

197 
ls
->
avg
 = 
sum
 /†s->
§m¶es
;

198 
ls
->
³riod
 = 
	`time
(
NULL
) -†s->period;

199 ià(
ls
->
³riod
 == 0)†s->period = 1;

203 
sum
 = 0;

204 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

205 
št64_t
 
d–
;

207 ià(
ts
->
§m¶es
[
j
].
time
 == 0) ;

208 
d–
 = (
št64_t
)
ls
->
avg
 - 
ts
->
§m¶es
[
j
].
Ï‹ncy
;

209 ià(
d–
 < 0) delta = -delta;

210 
sum
 +ğ
d–
;

212 ià(
ls
->
§m¶es
èls->
mad
 = 
sum
 /†s->samples;

213 
	}
}

216 
sds
 
	$ü—‹L©’cyR•Üt
() {

217 
sds
 
»pÜt
 = 
	`sd£m±y
();

218 
advi£_b‘‹r_vm
 = 0;

219 
advi£_¦owlog_’abËd
 = 0;

220 
advi£_¦owlog_tunšg
 = 0;

221 
advi£_¦owlog_š¥eù
 = 0;

222 
advi£_disk_cÚ‹ÁiÚ
 = 0;

223 
advi£_scheduËr
 = 0;

224 
advi£_d©a_wr™eback
 = 0;

225 
advi£_no_­³ndfsync
 = 0;

226 
advi£_loÿl_disk
 = 0;

227 
advi£_ssd
 = 0;

228 
advi£_wr™e_lßd_šfo
 = 0;

229 
advi£_hz
 = 0;

230 
advi£_Ïrge_objeùs
 = 0;

231 
advi£_mass_eviùiÚ
 = 0;

232 
advi£_»Ïx_fsync_pŞicy
 = 0;

233 
advi£_di§bË_thp
 = 0;

234 
adviûs
 = 0;

238 ià(
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
) == 0 &&

239 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 == 0)

241 
»pÜt
 = 
	`sdsÿt
(report,"I'm sorry, Dave, I can't dohat. Latency monitoring is disabled inhis Redis instance. You may use \"CONFIG SET†atency-monitor-threshold <milliseconds>.\" in orderoƒnable it. If we weren't in‡ deep space mission I'd suggestoake‡†ook‡t http://redis.io/topics/latency-monitor.\n");

242  
»pÜt
;

247 
diùI‹¿tÜ
 *
di
;

248 
diùEÁry
 *
de
;

249 
ev’Šum
 = 0;

251 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

252 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

253 *
ev’t
 = 
	`diùG‘Key
(
de
);

254 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

255 
Ï‹ncySts
 
ls
;

257 ià(
ts
 =ğ
NULL
) ;

258 
ev’Šum
++;

259 ià(
ev’Šum
 == 1) {

260 
»pÜt
 = 
	`sdsÿt
(report,"Dave, I have observed†atency spikes inhis Redis instance. You don't mindalking‡bout it, do you Dave?\n\n");

262 
	`ª®yzeL©’cyFÜEv’t
(
ev’t
,&
ls
);

264 
»pÜt
 = 
	`sdsÿrštf
(report,

266 
ev’Šum
, 
ev’t
,

267 
ls
.
§m¶es
,

268 (è
ls
.
avg
,

269 (è
ls
.
mad
,

270 (è
ls
.
³riod
/ls.
§m¶es
,

271 (è
ts
->
max
);

274 ià(!
	`¡rÿ£cmp
(
ev’t
,"fork")) {

275 *
fÜk_qu®™y
;

276 ià(
£rv”
.
¡©_fÜk_¿‹
 < 10) {

277 
fÜk_qu®™y
 = "terrible";

278 
advi£_b‘‹r_vm
 = 1;

279 
adviûs
++;

280 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 25) {

281 
fÜk_qu®™y
 = "poor";

282 
advi£_b‘‹r_vm
 = 1;

283 
adviûs
++;

284 } ià(
£rv”
.
¡©_fÜk_¿‹
 < 100) {

285 
fÜk_qu®™y
 = "good";

287 
fÜk_qu®™y
 = "excellent";

289 
»pÜt
 = 
	`sdsÿrštf
(report,

290 " FÜk„©i %.2àGB/£ø(%s).", 
£rv”
.
¡©_fÜk_¿‹
,

291 
fÜk_qu®™y
);

295 ià(!
	`¡rÿ£cmp
(
ev’t
,"command")) {

296 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 == 0) {

297 
advi£_¦owlog_’abËd
 = 1;

298 
adviûs
++;

299 } ià(
£rv”
.
¦owlog_log_¦ow”_thª
/1000 >

300 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
)

302 
advi£_¦owlog_tunšg
 = 1;

303 
adviûs
++;

305 
advi£_¦owlog_š¥eù
 = 1;

306 
advi£_Ïrge_objeùs
 = 1;

307 
adviûs
 += 2;

311 ià(!
	`¡rÿ£cmp
(
ev’t
,"fast-command")) {

312 
advi£_scheduËr
 = 1;

313 
adviûs
++;

317 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-pending-fsync")) {

318 
advi£_loÿl_disk
 = 1;

319 
advi£_disk_cÚ‹ÁiÚ
 = 1;

320 
advi£_ssd
 = 1;

321 
advi£_d©a_wr™eback
 = 1;

322 
adviûs
 += 4;

325 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-active-child")) {

326 
advi£_no_­³ndfsync
 = 1;

327 
advi£_d©a_wr™eback
 = 1;

328 
advi£_ssd
 = 1;

329 
adviûs
 += 3;

332 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-write-alone")) {

333 
advi£_loÿl_disk
 = 1;

334 
advi£_d©a_wr™eback
 = 1;

335 
advi£_ssd
 = 1;

336 
adviûs
 += 3;

339 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fsync-always")) {

340 
advi£_»Ïx_fsync_pŞicy
 = 1;

341 
adviûs
++;

344 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-fstat") ||

345 !
	`¡rÿ£cmp
(
ev’t
,"rdb-unlik-temp-file")) {

346 
advi£_disk_cÚ‹ÁiÚ
 = 1;

347 
advi£_loÿl_disk
 = 1;

348 
adviûs
 += 2;

351 ià(!
	`¡rÿ£cmp
(
ev’t
,"aof-rewrite-diff-write") ||

352 !
	`¡rÿ£cmp
(
ev’t
,"aof-rename")) {

353 
advi£_wr™e_lßd_šfo
 = 1;

354 
advi£_d©a_wr™eback
 = 1;

355 
advi£_ssd
 = 1;

356 
advi£_loÿl_disk
 = 1;

357 
adviûs
 += 4;

361 ià(!
	`¡rÿ£cmp
(
ev’t
,"expire-cycle")) {

362 
advi£_hz
 = 1;

363 
advi£_Ïrge_objeùs
 = 1;

364 
adviûs
 += 2;

368 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-del")) {

369 
advi£_Ïrge_objeùs
 = 1;

370 
adviûs
++;

373 ià(!
	`¡rÿ£cmp
(
ev’t
,"eviction-cycle")) {

374 
advi£_mass_eviùiÚ
 = 1;

375 
adviûs
++;

378 
»pÜt
 = 
	`sdsÿ’
(report,"\n",1);

380 
	`diùR–—£I‹¿tÜ
(
di
);

383 ià(
	`THPG‘AnÚHugePagesSize
() > 0) {

384 
advi£_di§bË_thp
 = 1;

385 
adviûs
++;

388 ià(
ev’Šum
 =ğ0 && 
adviûs
 == 0) {

389 
»pÜt
 = 
	`sdsÿt
(report,"Dave,‚o†atency spike was observed duringhe†ifetime ofhis Redis instance,‚ot inhe slightest bit. I honestlyhink you oughto sit down calmly,ake‡ stress…ill,‡ndhinkhings over.\n");

390 } ià(
ev’Šum
 > 0 && 
adviûs
 == 0) {

391 
»pÜt
 = 
	`sdsÿt
(report,"\nWhilehere‡re†atencyƒvents†ogged, I'm‚ot‡bleo suggest‡nyƒasy fix. Please usehe Redis communityo get some help,…rovidinghis„eport in your help„equest.\n");

396 
»pÜt
 = 
	`sdsÿt
(report,"\nI have‡ few‡dvices for you:\n\n");

397 ià(
advi£_b‘‹r_vm
) {

398 
»pÜt
 = 
	`sdsÿt
(report,"- If you‡re using‡ virtual machine, consider upgrading it with‡ faster one using‡n hypervisiorhat…rovides†ess†atency during fork() calls. Xen is knowno have…oor fork()…erformance. Even inhe context ofhe same VM…rovider, certain kinds of instances canƒxecute fork fasterhan others.\n");

402 ià(
advi£_¦owlog_’abËd
) {

403 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- Th”¬Ï‹ncy issue w™h…Ù’tŸÎy slow commªd you‡» usšg. TryØ’abËhSlow Log Redi ã©u» usšghcommªd 'CONFIG SET slowlog-log-¦ow”-thª %Îu'. IàthSlow†og i di§bËd Redi i nÙ‡bËØlog slow commªd executiÚ fÜ you.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

406 ià(
advi£_¦owlog_tunšg
) {

407 
»pÜt
 = 
	`sdsÿrštf
Ô•Üt,"- You¸cu¼’ˆSlow Log cÚfigu¿tiÚ oÆy†og ev’t th©‡» slow”hª you¸cÚfigu»d†©’cy mÚ™Üh»shŞd. PËa£ u£ 'CONFIG SET slowlog-log-¦ow”-thª %Îu'.\n", ()
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
*1000);

410 ià(
advi£_¦owlog_š¥eù
) {

411 
»pÜt
 = 
	`sdsÿt
(report,"- Check your Slow Logo understand what‡rehe commands you‡re„unning which‡reoo slowoƒxecute. Please check http://redis.io/commands/slowlog for more information.\n");

415 ià(
advi£_scheduËr
) {

416 
»pÜt
 = 
	`sdsÿt
(report,"- The system is slowoƒxecute Redis code…aths‚ot containing system calls. This usually meanshe system does‚ot…rovide Redis CPUimeo„un for†ong…eriods. You shouldryo:\n"

425 ià(
advi£_loÿl_disk
) {

426 
»pÜt
 = 
	`sdsÿt
(report,"- It is strongly‡dvisedo use†ocal disks for…ersistence,ƒspecially if you‡re using AOF. Remote disks…rovided by…latform-as-a-service…roviders‡re knowno be slow.\n");

429 ià(
advi£_ssd
) {

430 
»pÜt
 = 
	`sdsÿt
(report,"- SSD disks‡re‡bleo„educe fsync†atency,‡ndotalime‚eeded for snapshotting‡nd AOF†og„ewriting (resulting in smaller memory usage‡nd smaller final AOF„ewrite buffer flushes). Withƒxtremely high write†oad SSD disks can be‡ good option. However Redis should…erform„easonably with high†oad using‚ormal disks. Usehis‡dvice‡s‡†ast„esort.\n");

433 ià(
advi£_d©a_wr™eback
) {

434 
»pÜt
 = 
	`sdsÿt
(report,"- Mountingƒxt3/4 filesystems with data=writeback can…rovide‡…erformance boost comparedo data=ordered, howeverhis mode of operation…rovides†ess guarantees,‡nd sometimes it can happenhat‡fter‡ hard crashhe AOF file will have‡n half-written command‡theƒnd‡nd will„equireo be„epaired before Redis„estarts.\n");

437 ià(
advi£_disk_cÚ‹ÁiÚ
) {

438 
»pÜt
 = 
	`sdsÿt
(report,"- Tryo†owerhe disk contention. This is often caused by other disk intensive…rocesses„unning inhe same computer (including other Redis instances).\n");

441 ià(
advi£_no_­³ndfsync
) {

442 
»pÜt
 = 
	`sdsÿt
(report,"- Assuming fromhe…oint of view of data safetyhis is viable in yourƒnvironment, you couldryoƒnablehe 'no-appendfsync-on-rewrite' option, sohat fsync will‚ot be…erformed whilehere is‡ child„ewritinghe AOF file or…roducing‡n RDB file (the moment wherehere is high disk contention).\n");

445 ià(
advi£_»Ïx_fsync_pŞicy
 && 
£rv”
.
aof_fsync
 =ğ
AOF_FSYNC_ALWAYS
) {

446 
»pÜt
 = 
	`sdsÿt
(report,"- Your fsync…olicy is seto 'always'. It is very hardo get good…erformances with such‡ setup, if…ossibleryo„elaxhe fsync…olicyo 'onesec'.\n");

449 ià(
advi£_wr™e_lßd_šfo
) {

450 
»pÜt
 = 
	`sdsÿt
(report,"- Latency duringhe AOF‡tomic„ename operation or whenhe final difference is flushedohe AOF file‡theƒnd ofhe„ewrite, sometimes is caused by very high write†oad, causinghe AOF buffero get very†arge. If…ossibleryo send†ess commandso‡ccomplishhe same work, or use Lua scriptso group multiple operations into‡ single EVALSHA call.\n");

453 ià(
advi£_hz
 && 
£rv”
.
hz
 < 100) {

454 
»pÜt
 = 
	`sdsÿt
(report,"- In ordero makehe Redis keysƒxpiring…rocess more incremental,ryo sethe 'hz' configuration…arametero 100 using 'CONFIG SET hz 100'.\n");

457 ià(
advi£_Ïrge_objeùs
) {

458 
»pÜt
 = 
	`sdsÿt
(report,"- Deleting,ƒxpiring orƒvicting (because of maxmemory…olicy)†arge objects is‡ blocking operation. If you have very†arge objectshat‡re often deleted,ƒxpired, orƒvicted,ryo fragmenthose objects into multiple smaller objects.\n");

461 ià(
advi£_mass_eviùiÚ
) {

462 
»pÜt
 = 
	`sdsÿt
(report,"- Sudden changesohe 'maxmemory' setting via 'CONFIG SET', or‡llocation of†arge objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster†arge keys migrations (RESTORE command), may create sudden memory…ressure forcinghe servero blockryingoƒvict keys. \n");

465 ià(
advi£_di§bË_thp
) {

466 
»pÜt
 = 
	`sdsÿt
(report,"- I detected‡‚on zero‡mount of‡nonymous huge…ages used by your…rocess. This creates very serious†atencyƒvents in different conditions,ƒspecially when Redis is…ersisting on disk. To disable THP support usehe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled', make sureo‡lso‡dd it into /etc/rc.local sohathe command will beƒxecuted‡gain‡fter‡„eboot. Notehatƒven if you have‡lready disabled THP, you still‚eedo„estarthe Redis…rocesso get„id ofhe huge…ages‡lready created.\n");

470  
»pÜt
;

471 
	}
}

477 
	$Ï‹ncyCommªdR•lyW™hSam¶es
(
»disCl›Á
 *
c
, 
Ï‹ncyTimeS”›s
 *
ts
) {

478 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

479 
§m¶es
 = 0, 
j
;

481 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

482 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

484 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

485 
	`addR•lyMuÉiBulkL’
(
c
,2);

486 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
time
);

487 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
i
].
Ï‹ncy
);

488 
§m¶es
++;

490 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
§m¶es
);

491 
	}
}

495 
	$Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
»disCl›Á
 *
c
) {

496 
diùI‹¿tÜ
 *
di
;

497 
diùEÁry
 *
de
;

499 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£rv”
.
Ï‹ncy_ev’ts
));

500 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
Ï‹ncy_ev’ts
);

501 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

502 *
ev’t
 = 
	`diùG‘Key
(
de
);

503 
Ï‹ncyTimeS”›s
 *
ts
 = 
	`diùG‘V®
(
de
);

504 
Ï¡
 = (
ts
->
idx
 + 
LATENCY_TS_LEN
 - 1) % LATENCY_TS_LEN;

506 
	`addR•lyMuÉiBulkL’
(
c
,4);

507 
	`addR•lyBulkCSŒšg
(
c
,
ev’t
);

508 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
time
);

509 
	`addR•lyLÚgLÚg
(
c
,
ts
->
§m¶es
[
Ï¡
].
Ï‹ncy
);

510 
	`addR•lyLÚgLÚg
(
c
,
ts
->
max
);

512 
	`diùR–—£I‹¿tÜ
(
di
);

513 
	}
}

515 
	#LATENCY_GRAPH_COLS
 80

	)

516 
sds
 
	$Ï‹ncyCommªdG’S·rk–še
(*
ev’t
, 
Ï‹ncyTimeS”›s
 *
ts
) {

517 
j
;

518 
£qu’û
 *
£q
 = 
	`ü—‹S·rklšeSequ’û
();

519 
sds
 
g¿ph
 = 
	`sd£m±y
();

520 
ušt32_t
 
mš
 = 0, 
max
 = 0;

522 
j
 = 0; j < 
LATENCY_TS_LEN
; j++) {

523 
i
 = (
ts
->
idx
 + 
j
è% 
LATENCY_TS_LEN
;

524 
–­£d
;

525 
buf
[64];

527 ià(
ts
->
§m¶es
[
i
].
time
 == 0) ;

529 ià(
£q
->
Ëngth
 == 0) {

530 
mš
 = 
max
 = 
ts
->
§m¶es
[
i
].
Ï‹ncy
;

532 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 > 
max
) max =s->samples[i].latency;

533 ià(
ts
->
§m¶es
[
i
].
Ï‹ncy
 < 
mš
) min =s->samples[i].latency;

537 
–­£d
 = 
	`time
(
NULL
è- 
ts
->
§m¶es
[
i
].
time
;

538 ià(
–­£d
 < 60)

539 
	`¢´štf
(
buf
,(buf),"%ds",
–­£d
);

540 ià(
–­£d
 < 3600)

541 
	`¢´štf
(
buf
,(buf),"%dm",
–­£d
/60);

542 ià(
–­£d
 < 3600*24)

543 
	`¢´štf
(
buf
,(buf),"%dh",
–­£d
/3600);

545 
	`¢´štf
(
buf
,(buf),"%dd",
–­£d
/(3600*24));

546 
	`¥¬klšeSequ’ûAddSam¶e
(
£q
,
ts
->
§m¶es
[
i
].
Ï‹ncy
,
buf
);

549 
g¿ph
 = 
	`sdsÿrštf
(graph,

550 "% - high %lu ms,†ow %lu m ×Îimhigh %lu ms)\n", 
ev’t
,

551 (è
max
, (è
mš
, (è
ts
->max);

552 
j
 = 0; j < 
LATENCY_GRAPH_COLS
; j++)

553 
g¿ph
 = 
	`sdsÿ’
(graph,"-",1);

554 
g¿ph
 = 
	`sdsÿ’
(graph,"\n",1);

555 
g¿ph
 = 
	`¥¬klšeR’d”
(g¿ph,
£q
,
LATENCY_GRAPH_COLS
,4,
SPARKLINE_FILL
);

556 
	`ä“S·rklšeSequ’û
(
£q
);

557  
g¿ph
;

558 
	}
}

567 
	$Ï‹ncyCommªd
(
»disCl›Á
 *
c
) {

568 
Ï‹ncyTimeS”›s
 *
ts
;

570 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"hi¡Üy"è&& c->
¬gc
 == 3) {

572 
ts
 = 
	`diùF‘chV®ue
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

573 ià(
ts
 =ğ
NULL
) {

574 
	`addR•lyMuÉiBulkL’
(
c
,0);

576 
	`Ï‹ncyCommªdR•lyW™hSam¶es
(
c
,
ts
);

578 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g¿ph"è&& c->
¬gc
 == 3) {

580 
sds
 
g¿ph
;

581 
diùEÁry
 *
de
;

582 *
ev’t
;

584 
de
 = 
	`diùFšd
(
£rv”
.
Ï‹ncy_ev’ts
,
c
->
¬gv
[2]->
±r
);

585 ià(
de
 =ğ
NULL
è
nod©«¼
;

586 
ts
 = 
	`diùG‘V®
(
de
);

587 
ev’t
 = 
	`diùG‘Key
(
de
);

589 
g¿ph
 = 
	`Ï‹ncyCommªdG’S·rk–še
(
ev’t
,
ts
);

590 
	`addR•lyBulkCSŒšg
(
c
,
g¿ph
);

591 
	`sdsä“
(
g¿ph
);

592 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"Ï‹¡"è&& c->
¬gc
 == 2) {

594 
	`Ï‹ncyCommªdR•lyW™hL©e¡Ev’ts
(
c
);

595 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"doùÜ"è&& c->
¬gc
 == 2) {

597 
sds
 
»pÜt
 = 
	`ü—‹L©’cyR•Üt
();

599 
	`addR•lyBulkCBufãr
(
c
,
»pÜt
,
	`sd¦’
(report));

600 
	`sdsä“
(
»pÜt
);

601 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»£t"è&& c->
¬gc
 >= 2) {

603 ià(
c
->
¬gc
 == 2) {

604 
	`addR•lyLÚgLÚg
(
c
,
	`Ï‹ncyRe£tEv’t
(
NULL
));

606 
j
, 
»£ts
 = 0;

608 
j
 = 2; j < 
c
->
¬gc
; j++)

609 
»£ts
 +ğ
	`Ï‹ncyRe£tEv’t
(
c
->
¬gv
[
j
]->
±r
);

610 
	`addR•lyLÚgLÚg
(
c
,
»£ts
);

613 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

617 
nod©«¼
:

620 
	`addR•lyE¼ÜFÜm©
(
c
,

621 "NØ§m¶e avaabË fÜƒv’ˆ'%s'", (*è
c
->
¬gv
[2]->
±r
);

622 
	}
}

	@latency.h

34 #iâdeà
__LATENCY_H


35 
	#__LATENCY_H


	)

37 
	#LATENCY_TS_LEN
 160

	)

41 
	sÏ‹ncySam¶e
 {

42 
št32_t
 
	mtime
;

43 
ušt32_t
 
	mÏ‹ncy
;

47 
	sÏ‹ncyTimeS”›s
 {

48 
	midx
;

49 
ušt32_t
 
	mmax
;

50 
Ï‹ncySam¶e
 
	m§m¶es
[
LATENCY_TS_LEN
];

54 
	sÏ‹ncySts
 {

55 
ušt32_t
 
	m®l_time_high
;

56 
ušt32_t
 
	mavg
;

57 
ušt32_t
 
	mmš
;

58 
ušt32_t
 
	mmax
;

59 
ušt32_t
 
	mmad
;

60 
ušt32_t
 
	m§m¶es
;

61 
time_t
 
	m³riod
;

64 
Ï‹ncyMÚ™ÜIn™
();

65 
Ï‹ncyAddSam¶e
(*
ev’t
, 
m¡ime_t
 
Ï‹ncy
);

66 
THPIsEÇbËd
();

71 
	#Ï‹ncyS¹MÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

72 
v¬
 = 
	`m¡ime
(); \

74 
v¬
 = 0; \

75 }

	)

79 
	#Ï‹ncyEndMÚ™Ü
(
v¬
èià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) { \

80 
v¬
 = 
	`m¡ime
() - var; \

81 }

	)

84 
	#Ï‹ncyAddSam¶eIfN“ded
(
ev’t
,
v¬
) \

85 ià(
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 && \

86 (
v¬
è>ğ
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
) \

87 
	`Ï‹ncyAddSam¶e
((
ev’t
),(
v¬
));

	)

90 
	#Ï‹ncyRemoveNe¡edEv’t
(
ev’t_v¬
,
Ã¡ed_v¬
) \

91 
ev’t_v¬
 +ğ
Ã¡ed_v¬
;

	)

	@lzf.h

37 #iâdeà
LZF_H


38 
	#LZF_H


	)

49 
	#LZF_VERSION
 0x0105

	)

77 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

78 *
out_d©a
, 
out_Ën
);

96 
lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

97 *
out_d©a
, 
out_Ën
);

	@lzfP.h

37 #iâdeà
LZFP_h


38 
	#LZFP_h


	)

40 
	#STANDALONE
 1

	)

42 #iâdeà
STANDALONE


43 
	~"lzf.h
"

54 #iâdeà
HLOG


55 
	#HLOG
 16

	)

63 #iâdeà
VERY_FAST


64 
	#VERY_FAST
 1

	)

74 #iâdeà
ULTRA_FAST


75 
	#ULTRA_FAST
 0

	)

81 #iâdeà
STRICT_ALIGN


82 
	#STRICT_ALIGN
 !(
	`defšed
(
__i386
è|| defšed (
__amd64
))

	)

90 #iâdeà
INIT_HTAB


91 
	#INIT_HTAB
 0

	)

99 #iâdeà
AVOID_ERRNO


100 
	#AVOID_ERRNO
 0

	)

108 #iâdeà
LZF_STATE_ARG


109 
	#LZF_STATE_ARG
 0

	)

120 #iâdeà
CHECK_INPUT


121 
	#CHECK_INPUT
 1

	)

127 
	tu8
;

129 cÚ¡ 
	tu8
 *
	tLZF_STATE
[1 << (
HLOG
)];

131 #ià!
STRICT_ALIGN


133 
	~<lim™s.h
>

134 #ià
USHRT_MAX
 == 65535

135 
	tu16
;

136 #–ià
UINT_MAX
 == 65535

137 
	tu16
;

139 #undeà
STRICT_ALIGN


140 
	#STRICT_ALIGN
 1

	)

144 #ià
ULTRA_FAST


145 #ià
defšed
(
VERY_FAST
)

146 #undeà
VERY_FAST


150 #ià
INIT_HTAB


151 #ifdeà
__ılu¥lus


152 
	~<c¡ršg
>

154 
	~<¡ršg.h
>

	@lzf_c.c

37 
	~"lzfP.h
"

39 
	#HSIZE
 (1 << (
HLOG
))

	)

47 #iâdeà
FRST


48 
	#FRST
(
p
è((Õ[0]è<< 8è|…[1])

	)

49 
	#NEXT
(
v
,
p
è(((vè<< 8è|…[2])

	)

50 #ià
ULTRA_FAST


51 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h ) & (
HSIZE
 - 1))

	)

52 #–ià
VERY_FAST


53 
	#IDX
(
h
è((Ğh >> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

55 
	#IDX
(
h
è((((h ^ (h << 5)è>> (3*8 - 
HLOG
)è- h*5è& (
HSIZE
 - 1))

	)

69 
	#FRST
(
p
èÕ[0] << 5è^…[1]

	)

70 
	#NEXT
(
v
,
p
è((vè<< 5è^…[2]

	)

71 
	#IDX
(
h
è((hè& (
HSIZE
 - 1))

	)

74 
	#MAX_LIT
 (1 << 5)

	)

75 
	#MAX_OFF
 (1 << 13)

	)

76 
	#MAX_REF
 ((1 << 8è+ (1 << 3))

	)

78 #ià
__GNUC__
 >= 3

79 
	#ex³ù
(
ex´
,
v®ue
è
	`__butš_ex³ù
 (Óx´),(v®ue))

	)

80 
	#šlše
 
šlše


	)

82 
	#ex³ù
(
ex´
,
v®ue
èÓx´)

	)

83 
	#šlše
 

	)

86 
	#ex³ù_çl£
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 0)

	)

87 
	#ex³ù_Œue
(
ex´
è
	`ex³ù
 (Óx´è!ğ0, 1)

	)

99 
lzf_com´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

100 *
out_d©a
, 
out_Ën


101 #ià
LZF_STATE_ARG


102 , 
LZF_STATE
 
hb


106 #ià!
LZF_STATE_ARG


107 
LZF_STATE
 
	ghb
;

109 cÚ¡ 
u8
 **
	gh¦Ù
;

110 cÚ¡ 
u8
 *
	g
 = (cÚ¡ u8 *)
š_d©a
;

111 
u8
 *
	gİ
 = (u8 *)
out_d©a
;

112 cÚ¡ 
u8
 *
	gš_’d
 = 

 + 
š_Ën
;

113 
u8
 *
	gout_’d
 = 
İ
 + 
out_Ën
;

114 cÚ¡ 
u8
 *
	g»f
;

123 #ià
defšed
 (
WIN32
è&& defšed (
_M_X64
)

124 
_št64
 
	goff
;

126 
	goff
;

128 
	ghv®
;

129 
	gl™
;

131 ià(!
	gš_Ën
 || !
	gout_Ën
)

134 #ià
INIT_HTAB


135 
mem£t
 (
hb
, 0,  (htab));

137 
	gh¦Ù
 = 
hb
; h¦Ù < 
	ghb
 + 
	gHSIZE
; hslot++)

138 *
	gh¦Ù
++ = 

;

142 
	gl™
 = 0; 
	gİ
++;

144 
	ghv®
 = 
FRST
 (

);

145 
	g
 < 
	gš_’d
 - 2)

147 
	ghv®
 = 
NEXT
 (
hv®
, 

);

148 
	gh¦Ù
 = 
hb
 + 
IDX
 (
hv®
);

149 
	g»f
 = *
h¦Ù
; *
	gh¦Ù
 = 

;

152 #ià
INIT_HTAB


153 && 
	g»f
 < 
	g


155 && (
	goff
 = 

 - 
»f
 - 1è< 
MAX_OFF


156 && 

 + 4 < 
š_’d


157 && 
»f
 > (
u8
 *)
š_d©a


158 #ià
STRICT_ALIGN


159 && 
»f
[0] =ğ

[0]

160 && 
»f
[1] =ğ

[1]

161 && 
»f
[2] =ğ

[2]

163 && *(
u16
 *)
»f
 =ğ*(u16 *)



164 && 
»f
[2] =ğ

[2]

169 
Ën
 = 2;

170 
	gmaxËn
 = 
š_’d
 - 

 - 
Ën
;

171 
	gmaxËn
 = 
maxËn
 > 
MAX_REF
 ? MAX_REF : maxlen;

173 
	gİ
 [- 
l™
 - 1] =†it - 1;

174 
	gİ
 -ğ!
l™
;

176 ià(
ex³ù_çl£
 (
İ
 + 3 + 1 >ğ
out_’d
))

181 ià(
ex³ù_Œue
 (
maxËn
 > 16))

183 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

184 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

185 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

186 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

188 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

189 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

190 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

191 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

193 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

194 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

195 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

196 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

198 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

199 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

200 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

201 
	gËn
++; ià(
	g»f
 [
Ën
] !ğ

 [len]) ;

205 
	gËn
++;

206 
	gËn
 < 
	gmaxËn
 && 
	g»f
[
Ën
] =ğ

[len]);

211 
	gËn
 -= 2;

212 
	g
++;

214 ià(
	gËn
 < 7)

216 *
	gİ
++ = (
off
 >> 8è+ (
Ën
 << 5);

220 *
	gİ
++ = (
off
 >> 8) + ( 7 << 5);

221 *
	gİ
++ = 
Ën
 - 7;

224 *
	gİ
++ = 
off
;

225 
	gl™
 = 0; 
	gİ
++;

227 
	g
 +ğ
Ën
 + 1;

229 ià(
ex³ù_çl£
 (

 >ğ
š_’d
 - 2))

232 #ià
ULTRA_FAST
 || 
VERY_FAST


233 --
	g
;

234 #ià
VERY_FAST
 && !
ULTRA_FAST


235 --
	g
;

237 
	ghv®
 = 
FRST
 (

);

239 
	ghv®
 = 
NEXT
 (
hv®
, 

);

240 
	ghb
[
IDX
 (
hv®
)] = 

;

241 
	g
++;

243 #ià
VERY_FAST
 && !
ULTRA_FAST


244 
	ghv®
 = 
NEXT
 (
hv®
, 

);

245 
	ghb
[
IDX
 (
hv®
)] = 

;

246 
	g
++;

249 
	g
 -ğ
Ën
 + 1;

253 
	ghv®
 = 
NEXT
 (
hv®
, 

);

254 
	ghb
[
IDX
 (
hv®
)] = 

;

255 
	g
++;

257 
	gËn
--);

263 ià(
ex³ù_çl£
 (
İ
 >ğ
out_’d
))

266 
	gl™
++; *
	gİ
++ = *

++;

268 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

270 
İ
 [- 
l™
 - 1] =†it - 1;

271 
	gl™
 = 0; 
	gİ
++;

276 ià(
	gİ
 + 3 > 
	gout_’d
)

279 
	g
 < 
	gš_’d
)

281 
	gl™
++; *
	gİ
++ = *

++;

283 ià(
ex³ù_çl£
 (
l™
 =ğ
MAX_LIT
))

285 
İ
 [- 
l™
 - 1] =†it - 1;

286 
	gl™
 = 0; 
	gİ
++;

290 
	gİ
 [- 
l™
 - 1] =†it - 1;

291 
	gİ
 -ğ!
l™
;

293  
	gİ
 - (
	gu8
 *)
	gout_d©a
;

	@lzf_d.c

37 
	~"lzfP.h
"

39 #ià
AVOID_ERRNO


40 
	#SET_ERRNO
(
n
)

	)

42 
	~<”ºo.h
>

43 
	#SET_ERRNO
(
n
è
”ºo
 = (n)

	)

56 
	$lzf_decom´ess
 (cÚ¡ *cÚ¡ 
š_d©a
, 
š_Ën
,

57 *
out_d©a
, 
out_Ën
)

59 
u8
 cÚ¡ *

 = (cÚ¡ u8 *)
š_d©a
;

60 
u8
 *
İ
 = (u8 *)
out_d©a
;

61 
u8
 cÚ¡ *cÚ¡ 
š_’d
 = 

 + 
š_Ën
;

62 
u8
 *cÚ¡ 
out_’d
 = 
İ
 + 
out_Ën
;

66 
ù¾
 = *

++;

68 ià(
ù¾
 < (1 << 5))

70 
ù¾
++;

72 ià(
İ
 + 
ù¾
 > 
out_’d
)

74 
	`SET_ERRNO
 (
E2BIG
);

78 #ià
CHECK_INPUT


79 ià(

 + 
ù¾
 > 
š_’d
)

81 
	`SET_ERRNO
 (
EINVAL
);

86 #ifdeà
lzf_movsb


87 
	`lzf_movsb
 (
İ
, 

, 
ù¾
);

90 *
İ
++ = *

++;

91 --
ù¾
);

96 
Ën
 = 
ù¾
 >> 5;

98 
u8
 *
»f
 = 
İ
 - ((
ù¾
 & 0x1f) << 8) - 1;

100 #ià
CHECK_INPUT


101 ià(

 >ğ
š_’d
)

103 
	`SET_ERRNO
 (
EINVAL
);

107 ià(
Ën
 == 7)

109 
Ën
 +ğ*

++;

110 #ià
CHECK_INPUT


111 ià(

 >ğ
š_’d
)

113 
	`SET_ERRNO
 (
EINVAL
);

119 
»f
 -ğ*

++;

121 ià(
İ
 + 
Ën
 + 2 > 
out_’d
)

123 
	`SET_ERRNO
 (
E2BIG
);

127 ià(
»f
 < (
u8
 *)
out_d©a
)

129 
	`SET_ERRNO
 (
EINVAL
);

133 #ifdeà
lzf_movsb


134 
Ën
 += 2;

135 
	`lzf_movsb
 (
İ
, 
»f
, 
Ën
);

137 *
İ
++ = *
»f
++;

138 *
İ
++ = *
»f
++;

141 *
İ
++ = *
»f
++;

142 --
Ën
);

146 

 < 
š_’d
);

148  
İ
 - (
u8
 *)
out_d©a
;

149 
	}
}

	@memtest.c

30 
	~<¡dlib.h
>

31 
	~<¡dio.h
>

32 
	~<¡ršg.h
>

33 
	~<as£¹.h
>

34 
	~<lim™s.h
>

35 
	~<”ºo.h
>

36 
	~<‹rmios.h
>

37 
	~<sys/ioùl.h
>

38 #ià
defšed
(
__sun
)

39 
	~<¡rİts.h
>

41 
	~"cÚfig.h
"

43 #ià(
ULONG_MAX
 == 4294967295UL)

44 
	#MEMTEST_32BIT


	)

45 #–ià(
ULONG_MAX
 == 18446744073709551615ULL)

46 
	#MEMTEST_64BIT


	)

51 #ifdeà
MEMTEST_32BIT


52 
	#ULONG_ONEZERO
 0x¯¯¯¯UL

	)

53 
	#ULONG_ZEROONE
 0x55555555UL

	)

55 
	#ULONG_ONEZERO
 0x¯¯¯¯¯¯¯¯UL

	)

56 
	#ULONG_ZEROONE
 0x5555555555555555UL

	)

59 
wšsize
 
	gws
;

60 
size_t
 
	g´og»ss_´š‹d
;

61 
size_t
 
	g´og»ss_fuÎ
;

63 
	$mem‹¡_´og»ss_¡¬t
(*
t™Ë
, 
·ss
) {

64 
j
;

66 
	`´štf
("\x1b[H\x1b[2J");

68 
j
 = 0; j < 
ws
.
ws_cŞ
*(ws.
ws_row
-2); j++è
	`´štf
(".");

69 
	`´štf
("Please keepheest„unning several minutes…er GB of memory.\n");

70 
	`´štf
("Also check http://www.memtest86.com/‡nd http://pyropus.ca/software/memtester/");

71 
	`´štf
("\x1b[H\x1b[2K");

72 
	`´štf
("% [%d]\n", 
t™Ë
, 
·ss
);

73 
´og»ss_´š‹d
 = 0;

74 
´og»ss_fuÎ
 = 
ws
.
ws_cŞ
*(ws.
ws_row
-3);

75 
	`fæush
(
¡dout
);

76 
	}
}

78 
	$mem‹¡_´og»ss_’d
() {

79 
	`´štf
("\x1b[H\x1b[2J");

80 
	}
}

82 
	$mem‹¡_´og»ss_¡•
(
size_t
 
cu¼
, size_ˆ
size
, 
c
) {

83 
size_t
 
ch¬s
 = (()
cu¼
*
´og»ss_fuÎ
)/
size
, 
j
;

85 
j
 = 0; j < 
ch¬s
-
´og»ss_´š‹d
; j++è
	`´štf
("%c",
c
);

86 
´og»ss_´š‹d
 = 
ch¬s
;

87 
	`fæush
(
¡dout
);

88 
	}
}

93 
	$mem‹¡_add»ssšg
(*
l
, 
size_t
 
by‹s
) {

94 
wÜds
 = 
by‹s
/();

95 
j
, *
p
;

98 
p
 = 
l
;

99 
j
 = 0; j < 
wÜds
; j++) {

100 *
p
 = ()p;

101 
p
++;

102 ià((
j
 & 0xffffè=ğ0è
	`mem‹¡_´og»ss_¡•
(j,
wÜds
*2,'A');

105 
p
 = 
l
;

106 
j
 = 0; j < 
wÜds
; j++) {

107 ià(*
p
 != ()p) {

108 
	`´štf
("\n*** MEMORY ADDRESSING ERROR: %p contains %lu\n",

109 (*è
p
, *p);

110 
	`ex™
(1);

112 
p
++;

113 ià((
j
 & 0xffffè=ğ0è
	`mem‹¡_´og»ss_¡•
(j+
wÜds
,words*2,'A');

115 
	}
}

121 
	$mem‹¡_fl_¿ndom
(*
l
, 
size_t
 
by‹s
) {

122 
¡•
 = 4096/();

123 
wÜds
 = 
by‹s
/()/2;

124 
iwÜds
 = 
wÜds
/
¡•
;

125 
off
, 
w
, *
l1
, *
l2
;

127 
	`as£¹
((
by‹s
 & 4095) == 0);

128 
off
 = 0; ofà< 
¡•
; off++) {

129 
l1
 = 
l
+
off
;

130 
l2
 = 
l1
+
wÜds
;

131 
w
 = 0; w < 
iwÜds
; w++) {

132 #ifdeà
MEMTEST_32BIT


133 *
l1
 = *
l2
 = ((è(
	`¿nd
()&0xffff)) |

134 (((è(
	`¿nd
()&0xffff)) << 16);

136 *
l1
 = *
l2
 = ((è(
	`¿nd
()&0xffff)) |

137 (((è(
	`¿nd
()&0xffff)) << 16) |

138 (((è(
	`¿nd
()&0xffff)) << 32) |

139 (((è(
	`¿nd
()&0xffff)) << 48);

141 
l1
 +ğ
¡•
;

142 
l2
 +ğ
¡•
;

143 ià((
w
 & 0xffff) == 0)

144 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,'R');

147 
	}
}

151 
	$mem‹¡_fl_v®ue
(*
l
, 
size_t
 
by‹s
, 
v1
,

152 
v2
, 
sym
)

154 
¡•
 = 4096/();

155 
wÜds
 = 
by‹s
/()/2;

156 
iwÜds
 = 
wÜds
/
¡•
;

157 
off
, 
w
, *
l1
, *
l2
, 
v
;

159 
	`as£¹
((
by‹s
 & 4095) == 0);

160 
off
 = 0; ofà< 
¡•
; off++) {

161 
l1
 = 
l
+
off
;

162 
l2
 = 
l1
+
wÜds
;

163 
v
 = (
off
 & 1è? 
v2
 : 
v1
;

164 
w
 = 0; w < 
iwÜds
; w++) {

165 #ifdeà
MEMTEST_32BIT


166 *
l1
 = *
l2
 = ((è
v
) |

167 (((è
v
) << 16);

169 *
l1
 = *
l2
 = ((è
v
) |

170 (((è
v
) << 16) |

171 (((è
v
) << 32) |

172 (((è
v
) << 48);

174 
l1
 +ğ
¡•
;

175 
l2
 +ğ
¡•
;

176 ià((
w
 & 0xffff) == 0)

177 
	`mem‹¡_´og»ss_¡•
(
w
+
iwÜds
*
off
,
wÜds
,
sym
);

180 
	}
}

182 
	$mem‹¡_com·»
(*
l
, 
size_t
 
by‹s
) {

183 
wÜds
 = 
by‹s
/()/2;

184 
w
, *
l1
, *
l2
;

186 
	`as£¹
((
by‹s
 & 4095) == 0);

187 
l1
 = 
l
;

188 
l2
 = 
l1
+
wÜds
;

189 
w
 = 0; w < 
wÜds
; w++) {

190 ià(*
l1
 !ğ*
l2
) {

191 
	`´štf
("\n*** MEMORY ERROR DETECTED: %p != %p (%lu vs %lu)\n",

192 (*)
l1
, (*)
l2
, *l1, *l2);

193 
	`ex™
(1);

195 
l1
 ++;

196 
l2
 ++;

197 ià((
w
 & 0xffffè=ğ0è
	`mem‹¡_´og»ss_¡•
(w,
wÜds
,'=');

199 
	}
}

201 
	$mem‹¡_com·»_times
(*
m
, 
size_t
 
by‹s
, 
·ss
, 
times
) {

202 
j
;

204 
j
 = 0; j < 
times
; j++) {

205 
	`mem‹¡_´og»ss_¡¬t
("Com·»",
·ss
);

206 
	`mem‹¡_com·»
(
m
,
by‹s
);

207 
	`mem‹¡_´og»ss_’d
();

209 
	}
}

211 
	$mem‹¡_‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

212 
size_t
 
by‹s
 = 
megaby‹s
*1024*1024;

213 *
m
 = 
	`m®loc
(
by‹s
);

214 
·ss
 = 0;

216 ià(
m
 =ğ
NULL
) {

217 
	`årštf
(
¡d”r
,"Unableo‡llocate %zu megabytes: %s",

218 
megaby‹s
, 
	`¡»¼Ü
(
”ºo
));

219 
	`ex™
(1);

221 
·ss
 !ğ
·s£s
) {

222 
·ss
++;

224 
	`mem‹¡_´og»ss_¡¬t
("Add»ssšge¡",
·ss
);

225 
	`mem‹¡_add»ssšg
(
m
,
by‹s
);

226 
	`mem‹¡_´og»ss_’d
();

228 
	`mem‹¡_´og»ss_¡¬t
("Rªdom fl",
·ss
);

229 
	`mem‹¡_fl_¿ndom
(
m
,
by‹s
);

230 
	`mem‹¡_´og»ss_’d
();

231 
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4);

233 
	`mem‹¡_´og»ss_¡¬t
("SŞid fl",
·ss
);

234 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,0,()-1,'S');

235 
	`mem‹¡_´og»ss_’d
();

236 
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4);

238 
	`mem‹¡_´og»ss_¡¬t
("Check”bßrd fl",
·ss
);

239 
	`mem‹¡_fl_v®ue
(
m
,
by‹s
,
ULONG_ONEZERO
,
ULONG_ZEROONE
,'C');

240 
	`mem‹¡_´og»ss_’d
();

241 
	`mem‹¡_com·»_times
(
m
,
by‹s
,
·ss
,4);

243 
	`ä“
(
m
);

244 
	}
}

246 
	$mem‹¡_nÚ_de¡ruùive_šv”t
(*
addr
, 
size_t
 
size
) {

247 vŞ©*
p
 = 
addr
;

248 
size_t
 
wÜds
 = 
size
 / ();

249 
size_t
 
j
;

252 
j
 = 0; j < 
wÜds
; j++)

253 
p
[
j
] = ~p[j];

254 
	}
}

256 
	$mem‹¡_nÚ_de¡ruùive_sw­
(*
addr
, 
size_t
 
size
) {

257 vŞ©*
p
 = 
addr
;

258 
size_t
 
wÜds
 = 
size
 / ();

259 
size_t
 
j
;

262 
j
 = 0; j < 
wÜds
; j += 2) {

263 
a
, 
b
;

265 
a
 = 
p
[
j
];

266 
b
 = 
p
[
j
+1];

267 
p
[
j
] = 
b
;

268 
p
[
j
+1] = 
a
;

270 
	}
}

272 
	$mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
) {

273 ià(
	`ioùl
(1, 
TIOCGWINSZ
, &
ws
) == -1) {

274 
ws
.
ws_cŞ
 = 80;

275 
ws
.
ws_row
 = 20;

277 
	`mem‹¡_‹¡
(
megaby‹s
,
·s£s
);

278 
	`´štf
("\nYour memory…assedhisest.\n");

279 
	`´štf
("Please if you‡re still in doubt usehe followingwoools:\n");

280 
	`´štf
("1) memtest86: http://www.memtest86.com/\n");

281 
	`´štf
("2) memtester: http://pyropus.ca/software/memtester/\n");

282 
	`ex™
(0);

283 
	}
}

	@multi.c

30 
	~"»dis.h
"

35 
	$š™Cl›ÁMuÉiS‹
(
»disCl›Á
 *
c
) {

36 
c
->
m¡©e
.
commªds
 = 
NULL
;

37 
c
->
m¡©e
.
couÁ
 = 0;

38 
	}
}

41 
	$ä“Cl›ÁMuÉiS‹
(
»disCl›Á
 *
c
) {

42 
j
;

44 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

45 
i
;

46 
muÉiCmd
 *
mc
 = 
c
->
m¡©e
.
commªds
+
j
;

48 
i
 = 0; i < 
mc
->
¬gc
; i++)

49 
	`deüRefCouÁ
(
mc
->
¬gv
[
i
]);

50 
	`zä“
(
mc
->
¬gv
);

52 
	`zä“
(
c
->
m¡©e
.
commªds
);

53 
	}
}

56 
	$queueMuÉiCommªd
(
»disCl›Á
 *
c
) {

57 
muÉiCmd
 *
mc
;

58 
j
;

60 
c
->
m¡©e
.
commªds
 = 
	`z»®loc
(c->mstate.commands,

61 (
muÉiCmd
)*(
c
->
m¡©e
.
couÁ
+1));

62 
mc
 = 
c
->
m¡©e
.
commªds
+c->m¡©e.
couÁ
;

63 
mc
->
cmd
 = 
c
->cmd;

64 
mc
->
¬gc
 = 
c
->argc;

65 
mc
->
¬gv
 = 
	`zm®loc
((
robj
*)*
c
->
¬gc
);

66 
	`memıy
(
mc
->
¬gv
,
c
->¬gv,(
robj
*)*c->
¬gc
);

67 
j
 = 0; j < 
c
->
¬gc
; j++)

68 
	`šüRefCouÁ
(
mc
->
¬gv
[
j
]);

69 
c
->
m¡©e
.
couÁ
++;

70 
	}
}

72 
	$disÿrdT¿n§ùiÚ
(
»disCl›Á
 *
c
) {

73 
	`ä“Cl›ÁMuÉiS‹
(
c
);

74 
	`š™Cl›ÁMuÉiS‹
(
c
);

75 
c
->
æags
 &ğ~(
REDIS_MULTI
|
REDIS_DIRTY_CAS
|
REDIS_DIRTY_EXEC
);

76 
	`unw©chAÎKeys
(
c
);

77 
	}
}

81 
	$æagT¿n§ùiÚ
(
»disCl›Á
 *
c
) {

82 ià(
c
->
æags
 & 
REDIS_MULTI
)

83 
c
->
æags
 |ğ
REDIS_DIRTY_EXEC
;

84 
	}
}

86 
	$muÉiCommªd
(
»disCl›Á
 *
c
) {

87 ià(
c
->
æags
 & 
REDIS_MULTI
) {

88 
	`addR•lyE¼Ü
(
c
,"MULTI calls can‚ot be‚ested");

91 
c
->
æags
 |ğ
REDIS_MULTI
;

92 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

93 
	}
}

95 
	$disÿrdCommªd
(
»disCl›Á
 *
c
) {

96 ià(!(
c
->
æags
 & 
REDIS_MULTI
)) {

97 
	`addR•lyE¼Ü
(
c
,"DISCARD without MULTI");

100 
	`disÿrdT¿n§ùiÚ
(
c
);

101 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

102 
	}
}

106 
	$execCommªdPrİag©eMuÉi
(
»disCl›Á
 *
c
) {

107 
robj
 *
muÉi¡ršg
 = 
	`ü—‹SŒšgObjeù
("MULTI",5);

109 
	`´İag©e
(
£rv”
.
muÉiCommªd
,
c
->
db
->
id
,&
muÉi¡ršg
,1,

110 
REDIS_PROPAGATE_AOF
|
REDIS_PROPAGATE_REPL
);

111 
	`deüRefCouÁ
(
muÉi¡ršg
);

112 
	}
}

114 
	$execCommªd
(
»disCl›Á
 *
c
) {

115 
j
;

116 
robj
 **
Üig_¬gv
;

117 
Üig_¬gc
;

118 
»disCommªd
 *
Üig_cmd
;

119 
mu¡_´İag©e
 = 0;

121 ià(!(
c
->
æags
 & 
REDIS_MULTI
)) {

122 
	`addR•lyE¼Ü
(
c
,"EXEC without MULTI");

132 ià(
c
->
æags
 & (
REDIS_DIRTY_CAS
|
REDIS_DIRTY_EXEC
)) {

133 
	`addR•ly
(
c
, c->
æags
 & 
REDIS_DIRTY_EXEC
 ? 
sh¬ed
.
exeÿbÜ‹¼
 :

134 
sh¬ed
.
nuÎmuÉibulk
);

135 
	`disÿrdT¿n§ùiÚ
(
c
);

136 
hªdË_mÚ™Ü
;

140 
	`unw©chAÎKeys
(
c
);

141 
Üig_¬gv
 = 
c
->
¬gv
;

142 
Üig_¬gc
 = 
c
->
¬gc
;

143 
Üig_cmd
 = 
c
->
cmd
;

144 
	`addR•lyMuÉiBulkL’
(
c
,c->
m¡©e
.
couÁ
);

145 
j
 = 0; j < 
c
->
m¡©e
.
couÁ
; j++) {

146 
c
->
¬gc
 = c->
m¡©e
.
commªds
[
j
].argc;

147 
c
->
¬gv
 = c->
m¡©e
.
commªds
[
j
].argv;

148 
c
->
cmd
 = c->
m¡©e
.
commªds
[
j
].cmd;

154 ià(!
mu¡_´İag©e
 && !(
c
->
cmd
->
æags
 & 
REDIS_CMD_READONLY
)) {

155 
	`execCommªdPrİag©eMuÉi
(
c
);

156 
mu¡_´İag©e
 = 1;

159 
	`ÿÎ
(
c
,
REDIS_CALL_FULL
);

162 
c
->
m¡©e
.
commªds
[
j
].
¬gc
 = c->argc;

163 
c
->
m¡©e
.
commªds
[
j
].
¬gv
 = c->argv;

164 
c
->
m¡©e
.
commªds
[
j
].
cmd
 = c->cmd;

166 
c
->
¬gv
 = 
Üig_¬gv
;

167 
c
->
¬gc
 = 
Üig_¬gc
;

168 
c
->
cmd
 = 
Üig_cmd
;

169 
	`disÿrdT¿n§ùiÚ
(
c
);

172 ià(
mu¡_´İag©e
è
£rv”
.
dœty
++;

174 
hªdË_mÚ™Ü
:

180 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
è&& !£rv”.
lßdšg
)

181 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

182 
	}
}

196 
	sw©chedKey
 {

197 
robj
 *
	mkey
;

198 
»disDb
 *
	mdb
;

199 } 
	tw©chedKey
;

202 
	$w©chFÜKey
(
»disCl›Á
 *
c
, 
robj
 *
key
) {

203 
li¡
 *
ş›Ás
 = 
NULL
;

204 
li¡I‹r
 
li
;

205 
li¡Node
 *
Ê
;

206 
w©chedKey
 *
wk
;

209 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

210 (
Ê
 = 
	`li¡Next
(&
li
))) {

211 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

212 ià(
wk
->
db
 =ğ
c
->db && 
	`equ®SŒšgObjeùs
(
key
,wk->key))

216 
ş›Ás
 = 
	`diùF‘chV®ue
(
c
->
db
->
w©ched_keys
,
key
);

217 ià(!
ş›Ás
) {

218 
ş›Ás
 = 
	`li¡C»©e
();

219 
	`diùAdd
(
c
->
db
->
w©ched_keys
,
key
,
ş›Ás
);

220 
	`šüRefCouÁ
(
key
);

222 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

224 
wk
 = 
	`zm®loc
((*wk));

225 
wk
->
key
 = key;

226 
wk
->
db
 = 
c
->db;

227 
	`šüRefCouÁ
(
key
);

228 
	`li¡AddNodeTa
(
c
->
w©ched_keys
,
wk
);

229 
	}
}

233 
	$unw©chAÎKeys
(
»disCl›Á
 *
c
) {

234 
li¡I‹r
 
li
;

235 
li¡Node
 *
Ê
;

237 ià(
	`li¡L’gth
(
c
->
w©ched_keys
) == 0) ;

238 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
))) {

240 
li¡
 *
ş›Ás
;

241 
w©chedKey
 *
wk
;

245 
wk
 = 
	`li¡NodeV®ue
(
Ê
);

246 
ş›Ás
 = 
	`diùF‘chV®ue
(
wk
->
db
->
w©ched_keys
, wk->
key
);

247 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
ş›Ás
 != NULL);

248 
	`li¡D–Node
(
ş›Ás
,
	`li¡S—rchKey
(ş›Ás,
c
));

250 ià(
	`li¡L’gth
(
ş›Ás
) == 0)

251 
	`diùD–‘e
(
wk
->
db
->
w©ched_keys
, wk->
key
);

253 
	`li¡D–Node
(
c
->
w©ched_keys
,
Ê
);

254 
	`deüRefCouÁ
(
wk
->
key
);

255 
	`zä“
(
wk
);

257 
	}
}

261 
	$touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
) {

262 
li¡
 *
ş›Ás
;

263 
li¡I‹r
 
li
;

264 
li¡Node
 *
Ê
;

266 ià(
	`diùSize
(
db
->
w©ched_keys
) == 0) ;

267 
ş›Ás
 = 
	`diùF‘chV®ue
(
db
->
w©ched_keys
, 
key
);

268 ià(!
ş›Ás
) ;

272 
	`li¡Rewšd
(
ş›Ás
,&
li
);

273 (
Ê
 = 
	`li¡Next
(&
li
))) {

274 
»disCl›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

276 
c
->
æags
 |ğ
REDIS_DIRTY_CAS
;

278 
	}
}

284 
	$touchW©chedKeysOnFlush
(
dbid
) {

285 
li¡I‹r
 
li1
, 
li2
;

286 
li¡Node
 *
Ê
;

289 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li1
);

290 (
Ê
 = 
	`li¡Next
(&
li1
))) {

291 
»disCl›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

292 
	`li¡Rewšd
(
c
->
w©ched_keys
,&
li2
);

293 (
Ê
 = 
	`li¡Next
(&
li2
))) {

294 
w©chedKey
 *
wk
 = 
	`li¡NodeV®ue
(
Ê
);

299 ià(
dbid
 =ğ-1 || 
wk
->
db
->
id
 == dbid) {

300 ià(
	`diùFšd
(
wk
->
db
->
diù
, wk->
key
->
±r
è!ğ
NULL
)

301 
c
->
æags
 |ğ
REDIS_DIRTY_CAS
;

305 
	}
}

307 
	$w©chCommªd
(
»disCl›Á
 *
c
) {

308 
j
;

310 ià(
c
->
æags
 & 
REDIS_MULTI
) {

311 
	`addR•lyE¼Ü
(
c
,"WATCH inside MULTI is‚ot‡llowed");

314 
j
 = 1; j < 
c
->
¬gc
; j++)

315 
	`w©chFÜKey
(
c
,c->
¬gv
[
j
]);

316 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

317 
	}
}

319 
	$unw©chCommªd
(
»disCl›Á
 *
c
) {

320 
	`unw©chAÎKeys
(
c
);

321 
c
->
æags
 &ğ(~
REDIS_DIRTY_CAS
);

322 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

323 
	}
}

	@networking.c

30 
	~"»dis.h
"

31 
	~<sys/uio.h
>

32 
	~<m©h.h
>

34 
£tPrÙocŞE¼Ü
(
»disCl›Á
 *
c
, 
pos
);

40 
size_t
 
	$zm®loc_size_sds
(
sds
 
s
) {

41  
	`zm®loc_size
(
s
-(
sdshdr
));

42 
	}
}

46 
size_t
 
	$g‘SŒšgObjeùSdsU£dMemÜy
(
robj
 *
o
) {

47 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

48 
o
->
’codšg
) {

49 
REDIS_ENCODING_RAW
:  
	`zm®loc_size_sds
(
o
->
±r
);

50 
REDIS_ENCODING_EMBSTR
:  
	`sd¦’
(
o
->
±r
);

53 
	}
}

55 *
	$dupCl›ÁR•lyV®ue
(*
o
) {

56 
	`šüRefCouÁ
((
robj
*)
o
);

57  
o
;

58 
	}
}

60 
	$li¡M©chObjeùs
(*
a
, *
b
) {

61  
	`equ®SŒšgObjeùs
(
a
,
b
);

62 
	}
}

64 
»disCl›Á
 *
	$ü—‹Cl›Á
(
fd
) {

65 
»disCl›Á
 *
c
 = 
	`zm®loc
((redisClient));

71 ià(
fd
 != -1) {

72 
	`ª‘NÚBlock
(
NULL
,
fd
);

73 
	`ª‘EÇbËTıNoD–ay
(
NULL
,
fd
);

74 ià(
£rv”
.
tık“·live
)

75 
	`ª‘K“pAlive
(
NULL
,
fd
,
£rv”
.
tık“·live
);

76 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
,

77 
»adQu”yFromCl›Á
, 
c
è=ğ
AE_ERR
)

79 
	`şo£
(
fd
);

80 
	`zä“
(
c
);

81  
NULL
;

85 
	`£ËùDb
(
c
,0);

86 
c
->
id
 = 
£rv”
.
Ãxt_ş›Á_id
++;

87 
c
->
fd
 = fd;

88 
c
->
Çme
 = 
NULL
;

89 
c
->
buåos
 = 0;

90 
c
->
qu”ybuf
 = 
	`sd£m±y
();

91 
c
->
qu”ybuf_³ak
 = 0;

92 
c
->
»qty³
 = 0;

93 
c
->
¬gc
 = 0;

94 
c
->
¬gv
 = 
NULL
;

95 
c
->
cmd
 = c->
Ï¡cmd
 = 
NULL
;

96 
c
->
muÉibulkËn
 = 0;

97 
c
->
bulkËn
 = -1;

98 
c
->
£ÁËn
 = 0;

99 
c
->
æags
 = 0;

100 
c
->
ùime
 = c->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

101 
c
->
auth’tiÿ‹d
 = 0;

102 
c
->
»¶¡©e
 = 
REDIS_REPL_NONE
;

103 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

104 
c
->
»¶off
 = 0;

105 
c
->
»¶_ack_off
 = 0;

106 
c
->
»¶_ack_time
 = 0;

107 
c
->
¦ave_li¡’šg_pÜt
 = 0;

108 
c
->
»¶y
 = 
	`li¡C»©e
();

109 
c
->
»¶y_by‹s
 = 0;

110 
c
->
obuf_soá_lim™_»ached_time
 = 0;

111 
	`li¡S‘F»eM‘hod
(
c
->
»¶y
,
deüRefCouÁVoid
);

112 
	`li¡S‘DupM‘hod
(
c
->
»¶y
,
dupCl›ÁR•lyV®ue
);

113 
c
->
bty³
 = 
REDIS_BLOCKED_NONE
;

114 
c
->
bpİ
.
timeout
 = 0;

115 
c
->
bpİ
.
keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

116 
c
->
bpİ
.
rg‘
 = 
NULL
;

117 
c
->
bpİ
.
num»¶iÿs
 = 0;

118 
c
->
bpİ
.
»¶off£t
 = 0;

119 
c
->
woff
 = 0;

120 
c
->
w©ched_keys
 = 
	`li¡C»©e
();

121 
c
->
pubsub_chªÃls
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

122 
c
->
pubsub_·‰”ns
 = 
	`li¡C»©e
();

123 
c
->
³”id
 = 
NULL
;

124 
	`li¡S‘F»eM‘hod
(
c
->
pubsub_·‰”ns
,
deüRefCouÁVoid
);

125 
	`li¡S‘M©chM‘hod
(
c
->
pubsub_·‰”ns
,
li¡M©chObjeùs
);

126 ià(
fd
 !ğ-1è
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,
c
);

127 
	`š™Cl›ÁMuÉiS‹
(
c
);

128  
c
;

129 
	}
}

153 
	$´•¬eCl›ÁToWr™e
(
»disCl›Á
 *
c
) {

156 ià(
c
->
æags
 & 
REDIS_LUA_CLIENT
è 
REDIS_OK
;

160 ià((
c
->
æags
 & 
REDIS_MASTER
) &&

161 !(
c
->
æags
 & 
REDIS_MASTER_FORCE_REPLY
)è 
REDIS_ERR
;

163 ià(
c
->
fd
 <ğ0è 
REDIS_ERR
;

167 ià(
c
->
buåos
 =ğ0 && 
	`li¡L’gth
(c->
»¶y
) == 0 &&

168 (
c
->
»¶¡©e
 =ğ
REDIS_REPL_NONE
 ||

169 (
c
->
»¶¡©e
 =ğ
REDIS_REPL_ONLINE
 && !c->
»¶_put_Úlše_Ú_ack
)))

172 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
c
->
fd
, 
AE_WRITABLE
,

173 
£ndR•lyToCl›Á
, 
c
è=ğ
AE_ERR
)

175 
	`ä“Cl›ÁAsync
(
c
);

176  
REDIS_ERR
;

181  
REDIS_OK
;

182 
	}
}

186 
robj
 *
	$dupLa¡ObjeùIfN“ded
(
li¡
 *
»¶y
) {

187 
robj
 *
Ãw
, *
cur
;

188 
li¡Node
 *
Ê
;

189 
	`»disAs£¹
(
	`li¡L’gth
(
»¶y
) > 0);

190 
Ê
 = 
	`li¡La¡
(
»¶y
);

191 
cur
 = 
	`li¡NodeV®ue
(
Ê
);

192 ià(
cur
->
»fcouÁ
 > 1) {

193 
Ãw
 = 
	`dupSŒšgObjeù
(
cur
);

194 
	`deüRefCouÁ
(
cur
);

195 
	`li¡NodeV®ue
(
Ê
èğ
Ãw
;

197  
	`li¡NodeV®ue
(
Ê
);

198 
	}
}

204 
	$_addR•lyToBufãr
(
»disCl›Á
 *
c
, *
s
, 
size_t
 
Ën
) {

205 
size_t
 
avaabË
 = (
c
->
buf
)-c->
buåos
;

207 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
è 
REDIS_OK
;

211 ià(
	`li¡L’gth
(
c
->
»¶y
è> 0è 
REDIS_ERR
;

214 ià(
Ën
 > 
avaabË
è 
REDIS_ERR
;

216 
	`memıy
(
c
->
buf
+c->
buåos
,
s
,
Ën
);

217 
c
->
buåos
+=
Ën
;

218  
REDIS_OK
;

219 
	}
}

221 
	$_addR•lyObjeùToLi¡
(
»disCl›Á
 *
c
, 
robj
 *
o
) {

222 
robj
 *

;

224 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
) ;

226 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

227 
	`šüRefCouÁ
(
o
);

228 
	`li¡AddNodeTa
(
c
->
»¶y
,
o
);

229 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

231 

 = 
	`li¡NodeV®ue
(
	`li¡La¡
(
c
->
»¶y
));

234 ià(

->
±r
 !ğ
NULL
 &&

235 

->
’codšg
 =ğ
REDIS_ENCODING_RAW
 &&

236 
	`sd¦’
(

->
±r
)+sd¦’(
o
->±rè<ğ
REDIS_REPLY_CHUNK_BYTES
)

238 
c
->
»¶y_by‹s
 -ğ
	`zm®loc_size_sds
(

->
±r
);

239 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

240 

->
±r
 = 
	`sdsÿ’
Ña->±r,
o
->±r,
	`sd¦’
(o->ptr));

241 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(

->
±r
);

243 
	`šüRefCouÁ
(
o
);

244 
	`li¡AddNodeTa
(
c
->
»¶y
,
o
);

245 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

248 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

249 
	}
}

253 
	$_addR•lySdsToLi¡
(
»disCl›Á
 *
c
, 
sds
 
s
) {

254 
robj
 *

;

256 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
) {

257 
	`sdsä“
(
s
);

261 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

262 
	`li¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
REDIS_STRING
,
s
));

263 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(
s
);

265 

 = 
	`li¡NodeV®ue
(
	`li¡La¡
(
c
->
»¶y
));

268 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
REDIS_ENCODING_RAW
 &&

269 
	`sd¦’
(

->
±r
)+sd¦’(
s
è<ğ
REDIS_REPLY_CHUNK_BYTES
)

271 
c
->
»¶y_by‹s
 -ğ
	`zm®loc_size_sds
(

->
±r
);

272 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

273 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
	`sd¦’
(s));

274 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(

->
±r
);

275 
	`sdsä“
(
s
);

277 
	`li¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
REDIS_STRING
,
s
));

278 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(
s
);

281 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

282 
	}
}

284 
	$_addR•lySŒšgToLi¡
(
»disCl›Á
 *
c
, *
s
, 
size_t
 
Ën
) {

285 
robj
 *

;

287 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
) ;

289 ià(
	`li¡L’gth
(
c
->
»¶y
) == 0) {

290 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

292 
	`li¡AddNodeTa
(
c
->
»¶y
,
o
);

293 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

295 

 = 
	`li¡NodeV®ue
(
	`li¡La¡
(
c
->
»¶y
));

298 ià(

->
±r
 !ğ
NULL
 &&a->
’codšg
 =ğ
REDIS_ENCODING_RAW
 &&

299 
	`sd¦’
(

->
±r
)+
Ën
 <ğ
REDIS_REPLY_CHUNK_BYTES
)

301 
c
->
»¶y_by‹s
 -ğ
	`zm®loc_size_sds
(

->
±r
);

302 

 = 
	`dupLa¡ObjeùIfN“ded
(
c
->
»¶y
);

303 

->
±r
 = 
	`sdsÿ’
Ña->±r,
s
,
Ën
);

304 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(

->
±r
);

306 
robj
 *
o
 = 
	`ü—‹SŒšgObjeù
(
s
,
Ën
);

308 
	`li¡AddNodeTa
(
c
->
»¶y
,
o
);

309 
c
->
»¶y_by‹s
 +ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

312 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

313 
	}
}

320 
	$addR•ly
(
»disCl›Á
 *
c
, 
robj
 *
obj
) {

321 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
REDIS_OK
) ;

330 ià(
	`sdsEncodedObjeù
(
obj
)) {

331 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
REDIS_OK
)

332 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

333 } ià(
obj
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

337 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && ((c->
buf
è- c->
buåos
) >= 32) {

338 
buf
[32];

339 
Ën
;

341 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),()
obj
->
±r
);

342 ià(
	`_addR•lyToBufãr
(
c
,
buf
,
Ën
è=ğ
REDIS_OK
)

347 
obj
 = 
	`g‘DecodedObjeù
(obj);

348 ià(
	`_addR•lyToBufãr
(
c
,
obj
->
±r
,
	`sd¦’
(obj->±r)è!ğ
REDIS_OK
)

349 
	`_addR•lyObjeùToLi¡
(
c
,
obj
);

350 
	`deüRefCouÁ
(
obj
);

352 
	`»disPªic
("Wrong obj->encoding in‡ddReply()");

354 
	}
}

356 
	$addR•lySds
(
»disCl›Á
 *
c
, 
sds
 
s
) {

357 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
REDIS_OK
) {

359 
	`sdsä“
(
s
);

362 ià(
	`_addR•lyToBufãr
(
c
,
s
,
	`sd¦’
(s)è=ğ
REDIS_OK
) {

363 
	`sdsä“
(
s
);

366 
	`_addR•lySdsToLi¡
(
c
,
s
);

368 
	}
}

370 
	$addR•lySŒšg
(
»disCl›Á
 *
c
, *
s
, 
size_t
 
Ën
) {

371 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
REDIS_OK
) ;

372 ià(
	`_addR•lyToBufãr
(
c
,
s
,
Ën
è!ğ
REDIS_OK
)

373 
	`_addR•lySŒšgToLi¡
(
c
,
s
,
Ën
);

374 
	}
}

376 
	$addR•lyE¼ÜL’gth
(
»disCl›Á
 *
c
, *
s
, 
size_t
 
Ën
) {

377 
	`addR•lySŒšg
(
c
,"-ERR ",5);

378 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

379 
	`addR•lySŒšg
(
c
,"\r\n",2);

380 
	}
}

382 
	$addR•lyE¼Ü
(
»disCl›Á
 *
c
, *
”r
) {

383 
	`addR•lyE¼ÜL’gth
(
c
,
”r
,
	`¡¾’
(err));

384 
	}
}

386 
	$addR•lyE¼ÜFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...) {

387 
size_t
 
l
, 
j
;

388 
va_li¡
 
­
;

389 
	`va_¡¬t
(
­
,
fmt
);

390 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

391 
	`va_’d
(
­
);

394 
l
 = 
	`sd¦’
(
s
);

395 
j
 = 0; j < 
l
; j++) {

396 ià(
s
[
j
] == '\r' || s[j] == '\n') s[j] = ' ';

398 
	`addR•lyE¼ÜL’gth
(
c
,
s
,
	`sd¦’
(s));

399 
	`sdsä“
(
s
);

400 
	}
}

402 
	$addR•lyStusL’gth
(
»disCl›Á
 *
c
, *
s
, 
size_t
 
Ën
) {

403 
	`addR•lySŒšg
(
c
,"+",1);

404 
	`addR•lySŒšg
(
c
,
s
,
Ën
);

405 
	`addR•lySŒšg
(
c
,"\r\n",2);

406 
	}
}

408 
	$addR•lyStus
(
»disCl›Á
 *
c
, *
¡©us
) {

409 
	`addR•lyStusL’gth
(
c
,
¡©us
,
	`¡¾’
(status));

410 
	}
}

412 
	$addR•lyStusFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...) {

413 
va_li¡
 
­
;

414 
	`va_¡¬t
(
­
,
fmt
);

415 
sds
 
s
 = 
	`sdsÿtv´štf
(
	`sd£m±y
(),
fmt
,
­
);

416 
	`va_’d
(
­
);

417 
	`addR•lyStusL’gth
(
c
,
s
,
	`sd¦’
(s));

418 
	`sdsä“
(
s
);

419 
	}
}

423 *
	$addDeã¼edMuÉiBulkL’gth
(
»disCl›Á
 *
c
) {

427 ià(
	`´•¬eCl›ÁToWr™e
(
c
è!ğ
REDIS_OK
è 
NULL
;

428 
	`li¡AddNodeTa
(
c
->
»¶y
,
	`ü—‹Objeù
(
REDIS_STRING
,
NULL
));

429  
	`li¡La¡
(
c
->
»¶y
);

430 
	}
}

433 
	$£tDeã¼edMuÉiBulkL’gth
(
»disCl›Á
 *
c
, *
node
, 
Ëngth
) {

434 
li¡Node
 *
Ê
 = (li¡Node*)
node
;

435 
robj
 *
Ën
, *
Ãxt
;

438 ià(
node
 =ğ
NULL
) ;

440 
Ën
 = 
	`li¡NodeV®ue
(
Ê
);

441 
Ën
->
±r
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"*%ld\r\n",
Ëngth
);

442 
Ën
->
’codšg
 = 
REDIS_ENCODING_RAW
;

443 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(
Ën
->
±r
);

444 ià(
Ê
->
Ãxt
 !ğ
NULL
) {

445 
Ãxt
 = 
	`li¡NodeV®ue
(
Ê
->next);

448 ià(
Ãxt
->
±r
 !ğ
NULL
) {

449 
c
->
»¶y_by‹s
 -ğ
	`zm®loc_size_sds
(
Ën
->
±r
);

450 
c
->
»¶y_by‹s
 -ğ
	`g‘SŒšgObjeùSdsU£dMemÜy
(
Ãxt
);

451 
Ën
->
±r
 = 
	`sdsÿ’
Ö’->±r,
Ãxt
->±r,
	`sd¦’
(next->ptr));

452 
c
->
»¶y_by‹s
 +ğ
	`zm®loc_size_sds
(
Ën
->
±r
);

453 
	`li¡D–Node
(
c
->
»¶y
,
Ê
->
Ãxt
);

456 
	`asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
c
);

457 
	}
}

460 
	$addR•lyDoubË
(
»disCl›Á
 *
c
, 
d
) {

461 
dbuf
[128], 
sbuf
[128];

462 
dËn
, 
¦’
;

463 ià(
	`isšf
(
d
)) {

466 
	`addR•lyBulkCSŒšg
(
c
, 
d
 > 0 ? "inf" : "-inf");

468 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

469 
¦’
 = 
	`¢´štf
(
sbuf
,(sbuf),"$%d\r\n%s\r\n",
dËn
,
dbuf
);

470 
	`addR•lySŒšg
(
c
,
sbuf
,
¦’
);

472 
	}
}

476 
	$addR•lyLÚgLÚgW™hP»fix
(
»disCl›Á
 *
c
, 
Î
, 
´efix
) {

477 
buf
[128];

478 
Ën
;

483 ià(
´efix
 =ğ'*' && 
Î
 < 
REDIS_SHARED_BULKHDR_LEN
) {

484 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Î
]);

486 } ià(
´efix
 =ğ'$' && 
Î
 < 
REDIS_SHARED_BULKHDR_LEN
) {

487 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Î
]);

491 
buf
[0] = 
´efix
;

492 
Ën
 = 
	`Î2¡ršg
(
buf
+1,(buf)-1,
Î
);

493 
buf
[
Ën
+1] = '\r';

494 
buf
[
Ën
+2] = '\n';

495 
	`addR•lySŒšg
(
c
,
buf
,
Ën
+3);

496 
	}
}

498 
	$addR•lyLÚgLÚg
(
»disCl›Á
 *
c
, 
Î
) {

499 ià(
Î
 == 0)

500 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

501 ià(
Î
 == 1)

502 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

504 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Î
,':');

505 
	}
}

507 
	$addR•lyMuÉiBulkL’
(
»disCl›Á
 *
c
, 
Ëngth
) {

508 ià(
Ëngth
 < 
REDIS_SHARED_BULKHDR_LEN
)

509 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[
Ëngth
]);

511 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ëngth
,'*');

512 
	}
}

515 
	$addR•lyBulkL’
(
»disCl›Á
 *
c
, 
robj
 *
obj
) {

516 
size_t
 
Ën
;

518 ià(
	`sdsEncodedObjeù
(
obj
)) {

519 
Ën
 = 
	`sd¦’
(
obj
->
±r
);

521 
n
 = ()
obj
->
±r
;

524 
Ën
 = 1;

525 ià(
n
 < 0) {

526 
Ën
++;

527 
n
 = -n;

529 (
n
 =‚/10) != 0) {

530 
Ën
++;

534 ià(
Ën
 < 
REDIS_SHARED_BULKHDR_LEN
)

535 
	`addR•ly
(
c
,
sh¬ed
.
bulkhdr
[
Ën
]);

537 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

538 
	}
}

541 
	$addR•lyBulk
(
»disCl›Á
 *
c
, 
robj
 *
obj
) {

542 
	`addR•lyBulkL’
(
c
,
obj
);

543 
	`addR•ly
(
c
,
obj
);

544 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

545 
	}
}

548 
	$addR•lyBulkCBufãr
(
»disCl›Á
 *
c
, *
p
, 
size_t
 
Ën
) {

549 
	`addR•lyLÚgLÚgW™hP»fix
(
c
,
Ën
,'$');

550 
	`addR•lySŒšg
(
c
,
p
,
Ën
);

551 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

552 
	}
}

555 
	$addR•lyBulkCSŒšg
(
»disCl›Á
 *
c
, *
s
) {

556 ià(
s
 =ğ
NULL
) {

557 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

559 
	`addR•lyBulkCBufãr
(
c
,
s
,
	`¡¾’
(s));

561 
	}
}

564 
	$addR•lyBulkLÚgLÚg
(
»disCl›Á
 *
c
, 
Î
) {

565 
buf
[64];

566 
Ën
;

568 
Ën
 = 
	`Î2¡ršg
(
buf
,64,
Î
);

569 
	`addR•lyBulkCBufãr
(
c
,
buf
,
Ën
);

570 
	}
}

575 
	$cİyCl›ÁOuutBufãr
(
»disCl›Á
 *
d¡
,„edisCl›Á *
¤c
) {

576 
	`li¡R–—£
(
d¡
->
»¶y
);

577 
d¡
->
»¶y
 = 
	`li¡Dup
(
¤c
->reply);

578 
	`memıy
(
d¡
->
buf
,
¤c
->buf,¤c->
buåos
);

579 
d¡
->
buåos
 = 
¤c
->bufpos;

580 
d¡
->
»¶y_by‹s
 = 
¤c
->reply_bytes;

581 
	}
}

583 
	#MAX_ACCEPTS_PER_CALL
 1000

	)

584 
	$acû±CommÚHªdËr
(
fd
, 
æags
) {

585 
»disCl›Á
 *
c
;

586 ià((
c
 = 
	`ü—‹Cl›Á
(
fd
)è=ğ
NULL
) {

587 
	`»disLog
(
REDIS_WARNING
,

589 
	`¡»¼Ü
(
”ºo
),
fd
);

590 
	`şo£
(
fd
);

597 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás
è> s”v”.
maxş›Ás
) {

598 *
”r
 = "-ERR max‚umber of clients„eached\r\n";

601 ià(
	`wr™e
(
c
->
fd
,
”r
,
	`¡¾’
(err)) == -1) {

604 
£rv”
.
¡©_»jeùed_cÚn
++;

605 
	`ä“Cl›Á
(
c
);

608 
£rv”
.
¡©_numcÚÃùiÚs
++;

609 
c
->
æags
 |= flags;

610 
	}
}

612 
	$acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

613 
ıÜt
, 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

614 
c
[
REDIS_IP_STR_LEN
];

615 
	`REDIS_NOTUSED
(
–
);

616 
	`REDIS_NOTUSED
(
mask
);

617 
	`REDIS_NOTUSED
(
´ivd©a
);

619 
max
--) {

620 
cfd
 = 
	`ª‘TıAcû±
(
£rv”
.
Ã‹¼
, 
fd
, 
c
, (c), &
ıÜt
);

621 ià(
cfd
 =ğ
ANET_ERR
) {

622 ià(
”ºo
 !ğ
EWOULDBLOCK
)

623 
	`»disLog
(
REDIS_WARNING
,

624 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

627 
	`»disLog
(
REDIS_VERBOSE
,"Acû±ed %s:%d", 
c
, 
ıÜt
);

628 
	`acû±CommÚHªdËr
(
cfd
,0);

630 
	}
}

632 
	$acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

633 
cfd
, 
max
 = 
MAX_ACCEPTS_PER_CALL
;

634 
	`REDIS_NOTUSED
(
–
);

635 
	`REDIS_NOTUSED
(
mask
);

636 
	`REDIS_NOTUSED
(
´ivd©a
);

638 
max
--) {

639 
cfd
 = 
	`ª‘UnixAcû±
(
£rv”
.
Ã‹¼
, 
fd
);

640 ià(
cfd
 =ğ
ANET_ERR
) {

641 ià(
”ºo
 !ğ
EWOULDBLOCK
)

642 
	`»disLog
(
REDIS_WARNING
,

643 "Acû±šg cl›Á cÚÃùiÚ: %s", 
£rv”
.
Ã‹¼
);

646 
	`»disLog
(
REDIS_VERBOSE
,"Acû±ed cÚÃùiÚØ%s", 
£rv”
.
unixsock‘
);

647 
	`acû±CommÚHªdËr
(
cfd
,
REDIS_UNIX_SOCKET
);

649 
	}
}

651 
	$ä“Cl›ÁArgv
(
»disCl›Á
 *
c
) {

652 
j
;

653 
j
 = 0; j < 
c
->
¬gc
; j++)

654 
	`deüRefCouÁ
(
c
->
¬gv
[
j
]);

655 
c
->
¬gc
 = 0;

656 
c
->
cmd
 = 
NULL
;

657 
	}
}

662 
	$discÚÃùSÏves
() {

663 
	`li¡L’gth
(
£rv”
.
¦aves
)) {

664 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
¦aves
);

665 
	`ä“Cl›Á
((
»disCl›Á
*)
Ê
->
v®ue
);

667 
	}
}

671 
	$»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
() {

672 
£rv”
.
ma¡”
 = 
NULL
;

673 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

674 
£rv”
.
»¶_down_sšû
 = s”v”.
unixtime
;

680 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
è
	`discÚÃùSÏves
();

681 
	}
}

683 
	$ä“Cl›Á
(
»disCl›Á
 *
c
) {

684 
li¡Node
 *
Ê
;

687 ià(
£rv”
.
cu¼’t_ş›Á
 =ğ
c
è£rv”.cu¼’t_ş›Á = 
NULL
;

694 ià(
£rv”
.
ma¡”
 && 
c
->
æags
 & 
REDIS_MASTER
) {

695 
	`»disLog
(
REDIS_WARNING
,"Connection with master†ost.");

696 ià(!(
c
->
æags
 & (
REDIS_CLOSE_AFTER_REPLY
|

697 
REDIS_CLOSE_ASAP
|

698 
REDIS_BLOCKED
|

699 
REDIS_UNBLOCKED
)))

701 
	`»¶iÿtiÚCacheMa¡”
(
c
);

707 ià((
c
->
æags
 & 
REDIS_SLAVE
è&& !(c->æag & 
REDIS_MONITOR
)) {

708 
	`»disLog
(
REDIS_WARNING
,"Connection with slave %s†ost.",

709 
	`»¶iÿtiÚG‘SÏveName
(
c
));

713 
	`sdsä“
(
c
->
qu”ybuf
);

714 
c
->
qu”ybuf
 = 
NULL
;

717 ià(
c
->
æags
 & 
REDIS_BLOCKED
è
	`unblockCl›Á
(c);

718 
	`diùR–—£
(
c
->
bpİ
.
keys
);

721 
	`unw©chAÎKeys
(
c
);

722 
	`li¡R–—£
(
c
->
w©ched_keys
);

725 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,0);

726 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,0);

727 
	`diùR–—£
(
c
->
pubsub_chªÃls
);

728 
	`li¡R–—£
(
c
->
pubsub_·‰”ns
);

732 ià(
c
->
fd
 != -1) {

733 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
);

734 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

735 
	`şo£
(
c
->
fd
);

737 
	`li¡R–—£
(
c
->
»¶y
);

738 
	`ä“Cl›ÁArgv
(
c
);

741 ià(
c
->
fd
 != -1) {

742 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás
,
c
);

743 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

744 
	`li¡D–Node
(
£rv”
.
ş›Ás
,
Ê
);

749 ià(
c
->
æags
 & 
REDIS_UNBLOCKED
) {

750 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
unblocked_ş›Ás
,
c
);

751 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

752 
	`li¡D–Node
(
£rv”
.
unblocked_ş›Ás
,
Ê
);

757 ià(
c
->
æags
 & 
REDIS_SLAVE
) {

758 ià(
c
->
»¶¡©e
 =ğ
REDIS_REPL_SEND_BULK
) {

759 ià(
c
->
»¶dbfd
 !ğ-1è
	`şo£
(c->repldbfd);

760 ià(
c
->
»¶´—mbË
è
	`sdsä“
(c->replpreamble);

762 
li¡
 *
l
 = (
c
->
æags
 & 
REDIS_MONITOR
è? 
£rv”
.
mÚ™Üs
 : s”v”.
¦aves
;

763 
Ê
 = 
	`li¡S—rchKey
(
l
,
c
);

764 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

765 
	`li¡D–Node
(
l
,
Ê
);

769 ià(
c
->
æags
 & 
REDIS_SLAVE
 && 
	`li¡L’gth
(
£rv”
.
¦aves
) == 0)

770 
£rv”
.
»¶_no_¦aves_sšû
 = s”v”.
unixtime
;

771 
	`»äeshGoodSÏvesCouÁ
();

776 ià(
c
->
æags
 & 
REDIS_MASTER
è
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

780 ià(
c
->
æags
 & 
REDIS_CLOSE_ASAP
) {

781 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_to_şo£
,
c
);

782 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

783 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

788 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

789 
	`zä“
(
c
->
¬gv
);

790 
	`ä“Cl›ÁMuÉiS‹
(
c
);

791 
	`sdsä“
(
c
->
³”id
);

792 
	`zä“
(
c
);

793 
	}
}

799 
	$ä“Cl›ÁAsync
(
»disCl›Á
 *
c
) {

800 ià(
c
->
æags
 & 
REDIS_CLOSE_ASAP
) ;

801 
c
->
æags
 |ğ
REDIS_CLOSE_ASAP
;

802 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_to_şo£
,
c
);

803 
	}
}

805 
	$ä“Cl›ÁsInAsyncF»eQueue
() {

806 
	`li¡L’gth
(
£rv”
.
ş›Ás_to_şo£
)) {

807 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás_to_şo£
);

808 
»disCl›Á
 *
c
 = 
	`li¡NodeV®ue
(
Ê
);

810 
c
->
æags
 &ğ~
REDIS_CLOSE_ASAP
;

811 
	`ä“Cl›Á
(
c
);

812 
	`li¡D–Node
(
£rv”
.
ş›Ás_to_şo£
,
Ê
);

814 
	}
}

816 
	$£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

817 
»disCl›Á
 *
c
 = 
´ivd©a
;

818 
nwr™‹n
 = 0, 
tÙwr™‹n
 = 0, 
objËn
;

819 
size_t
 
objmem
;

820 
robj
 *
o
;

821 
	`REDIS_NOTUSED
(
–
);

822 
	`REDIS_NOTUSED
(
mask
);

824 
c
->
buåos
 > 0 || 
	`li¡L’gth
(c->
»¶y
)) {

825 ià(
c
->
buåos
 > 0) {

826 
nwr™‹n
 = 
	`wr™e
(
fd
,
c
->
buf
+c->
£ÁËn
,c->
buåos
-c->sentlen);

827 ià(
nwr™‹n
 <= 0) ;

828 
c
->
£ÁËn
 +ğ
nwr™‹n
;

829 
tÙwr™‹n
 +ğ
nwr™‹n
;

833 ià(
c
->
£ÁËn
 =ğc->
buåos
) {

834 
c
->
buåos
 = 0;

835 
c
->
£ÁËn
 = 0;

838 
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

839 
objËn
 = 
	`sd¦’
(
o
->
±r
);

840 
objmem
 = 
	`g‘SŒšgObjeùSdsU£dMemÜy
(
o
);

842 ià(
objËn
 == 0) {

843 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

844 
c
->
»¶y_by‹s
 -ğ
objmem
;

848 
nwr™‹n
 = 
	`wr™e
(
fd
, ((*)
o
->
±r
)+
c
->
£ÁËn
,
objËn
-c->sentlen);

849 ià(
nwr™‹n
 <= 0) ;

850 
c
->
£ÁËn
 +ğ
nwr™‹n
;

851 
tÙwr™‹n
 +ğ
nwr™‹n
;

854 ià(
c
->
£ÁËn
 =ğ
objËn
) {

855 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

856 
c
->
£ÁËn
 = 0;

857 
c
->
»¶y_by‹s
 -ğ
objmem
;

868 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
tÙwr™‹n
;

869 ià(
tÙwr™‹n
 > 
REDIS_MAX_WRITE_PER_EVENT
 &&

870 (
£rv”
.
maxmemÜy
 == 0 ||

871 
	`zm®loc_u£d_memÜy
(è< 
£rv”
.
maxmemÜy
)) ;

873 ià(
nwr™‹n
 == -1) {

874 ià(
”ºo
 =ğ
EAGAIN
) {

875 
nwr™‹n
 = 0;

877 
	`»disLog
(
REDIS_VERBOSE
,

878 "E¼Ü wr™šgØş›Á: %s", 
	`¡»¼Ü
(
”ºo
));

879 
	`ä“Cl›Á
(
c
);

883 ià(
tÙwr™‹n
 > 0) {

888 ià(!(
c
->
æags
 & 
REDIS_MASTER
)èc->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

890 ià(
c
->
buåos
 =ğ0 && 
	`li¡L’gth
(c->
»¶y
) == 0) {

891 
c
->
£ÁËn
 = 0;

892 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

895 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
è
	`ä“Cl›Á
(c);

897 
	}
}

900 
	$»£tCl›Á
(
»disCl›Á
 *
c
) {

901 
»disCommªdProc
 *
´evcmd
 = 
c
->
cmd
 ? c->cmd->
´oc
 : 
NULL
;

903 
	`ä“Cl›ÁArgv
(
c
);

904 
c
->
»qty³
 = 0;

905 
c
->
muÉibulkËn
 = 0;

906 
c
->
bulkËn
 = -1;

909 ià(!(
c
->
æags
 & 
REDIS_MULTI
è&& 
´evcmd
 !ğ
askšgCommªd
)

910 
c
->
æags
 &ğ(~
REDIS_ASKING
);

911 
	}
}

913 
	$´oûssIÆšeBufãr
(
»disCl›Á
 *
c
) {

914 *
Ãwlše
;

915 
¬gc
, 
j
;

916 
sds
 *
¬gv
, 
aux
;

917 
size_t
 
qu”yËn
;

920 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\n');

923 ià(
Ãwlše
 =ğ
NULL
) {

924 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
REDIS_INLINE_MAX_SIZE
) {

925 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big inline„equest");

926 
	`£tPrÙocŞE¼Ü
(
c
,0);

928  
REDIS_ERR
;

932 ià(
Ãwlše
 &&‚ewlš!ğ
c
->
qu”ybuf
 && *(newline-1) == '\r')

933 
Ãwlše
--;

936 
qu”yËn
 = 
Ãwlše
-(
c
->
qu”ybuf
);

937 
aux
 = 
	`sd¢ewËn
(
c
->
qu”ybuf
,
qu”yËn
);

938 
¬gv
 = 
	`sds¥l™¬gs
(
aux
,&
¬gc
);

939 
	`sdsä“
(
aux
);

940 ià(
¬gv
 =ğ
NULL
) {

941 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: unbalanced quotes in„equest");

942 
	`£tPrÙocŞE¼Ü
(
c
,0);

943  
REDIS_ERR
;

949 ià(
qu”yËn
 =ğ0 && 
c
->
æags
 & 
REDIS_SLAVE
)

950 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

953 
	`sd¤ªge
(
c
->
qu”ybuf
,
qu”yËn
+2,-1);

956 ià(
¬gc
) {

957 ià(
c
->
¬gv
è
	`zä“
(c->argv);

958 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

962 
c
->
¬gc
 = 0, 
j
 = 0; j <‡rgc; j++) {

963 ià(
	`sd¦’
(
¬gv
[
j
])) {

964 
c
->
¬gv
[c->
¬gc
] = 
	`ü—‹Objeù
(
REDIS_STRING
,¬gv[
j
]);

965 
c
->
¬gc
++;

967 
	`sdsä“
(
¬gv
[
j
]);

970 
	`zä“
(
¬gv
);

971  
REDIS_OK
;

972 
	}
}

976 
	$£tPrÙocŞE¼Ü
(
»disCl›Á
 *
c
, 
pos
) {

977 ià(
£rv”
.
v”bos™y
 >ğ
REDIS_VERBOSE
) {

978 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

979 
	`»disLog
(
REDIS_VERBOSE
,

980 "PrÙocŞƒ¼Ü from cl›Á: %s", 
ş›Á
);

981 
	`sdsä“
(
ş›Á
);

983 
c
->
æags
 |ğ
REDIS_CLOSE_AFTER_REPLY
;

984 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

985 
	}
}

987 
	$´oûssMuÉibulkBufãr
(
»disCl›Á
 *
c
) {

988 *
Ãwlše
 = 
NULL
;

989 
pos
 = 0, 
ok
;

990 
Î
;

992 ià(
c
->
muÉibulkËn
 == 0) {

994 
	`»disAs£¹W™hInfo
(
c
,
NULL
,c->
¬gc
 == 0);

997 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
,'\r');

998 ià(
Ãwlše
 =ğ
NULL
) {

999 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
REDIS_INLINE_MAX_SIZE
) {

1000 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror:oo big mbulk count string");

1001 
	`£tPrÙocŞE¼Ü
(
c
,0);

1003  
REDIS_ERR
;

1007 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1008  
REDIS_ERR
;

1012 
	`»disAs£¹W™hInfo
(
c
,
NULL
,c->
qu”ybuf
[0] == '*');

1013 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+1,
Ãwlše
-(c->qu”ybuf+1),&
Î
);

1014 ià(!
ok
 || 
Î
 > 1024*1024) {

1015 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid multibulk†ength");

1016 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1017  
REDIS_ERR
;

1020 
pos
 = (
Ãwlše
-
c
->
qu”ybuf
)+2;

1021 ià(
Î
 <= 0) {

1022 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1023  
REDIS_OK
;

1026 
c
->
muÉibulkËn
 = 
Î
;

1029 ià(
c
->
¬gv
è
	`zä“
(c->argv);

1030 
c
->
¬gv
 = 
	`zm®loc
((
robj
*)*c->
muÉibulkËn
);

1033 
	`»disAs£¹W™hInfo
(
c
,
NULL
,c->
muÉibulkËn
 > 0);

1034 
c
->
muÉibulkËn
) {

1036 ià(
c
->
bulkËn
 == -1) {

1037 
Ãwlše
 = 
	`¡rchr
(
c
->
qu”ybuf
+
pos
,'\r');

1038 ià(
Ãwlše
 =ğ
NULL
) {

1039 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
REDIS_INLINE_MAX_SIZE
) {

1040 
	`addR•lyE¼Ü
(
c
,

1042 
	`£tPrÙocŞE¼Ü
(
c
,0);

1043  
REDIS_ERR
;

1049 ià(
Ãwlše
-(
c
->
qu”ybuf
è> ((sigÃd)
	`sd¦’
(c->querybuf)-2))

1052 ià(
c
->
qu”ybuf
[
pos
] != '$') {

1053 
	`addR•lyE¼ÜFÜm©
(
c
,

1055 
c
->
qu”ybuf
[
pos
]);

1056 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1057  
REDIS_ERR
;

1060 
ok
 = 
	`¡ršg2Î
(
c
->
qu”ybuf
+
pos
+1,
Ãwlše
-(c->qu”ybuf+pos+1),&
Î
);

1061 ià(!
ok
 || 
Î
 < 0 ||†l > 512*1024*1024) {

1062 
	`addR•lyE¼Ü
(
c
,"Protocolƒrror: invalid bulk†ength");

1063 
	`£tPrÙocŞE¼Ü
(
c
,
pos
);

1064  
REDIS_ERR
;

1067 
pos
 +ğ
Ãwlše
-(
c
->
qu”ybuf
+pos)+2;

1068 ià(
Î
 >ğ
REDIS_MBULK_BIG_ARG
) {

1069 
size_t
 
qbËn
;

1075 
	`sd¤ªge
(
c
->
qu”ybuf
,
pos
,-1);

1076 
pos
 = 0;

1077 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1080 ià(
qbËn
 < (
size_t
)
Î
+2)

1081 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,
Î
+2-
qbËn
);

1083 
c
->
bulkËn
 = 
Î
;

1087 ià(
	`sd¦’
(
c
->
qu”ybuf
)-
pos
 < ()(c->
bulkËn
+2)) {

1094 ià(
pos
 == 0 &&

1095 
c
->
bulkËn
 >ğ
REDIS_MBULK_BIG_ARG
 &&

1096 (sigÃdè
	`sd¦’
(
c
->
qu”ybuf
è=ğc->
bulkËn
+2)

1098 
c
->
¬gv
[c->
¬gc
++] = 
	`ü—‹Objeù
(
REDIS_STRING
,c->
qu”ybuf
);

1099 
	`sdsInüL’
(
c
->
qu”ybuf
,-2);

1100 
c
->
qu”ybuf
 = 
	`sd£m±y
();

1103 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf,c->
bulkËn
+2);

1104 
pos
 = 0;

1106 
c
->
¬gv
[c->
¬gc
++] =

1107 
	`ü—‹SŒšgObjeù
(
c
->
qu”ybuf
+
pos
,c->
bulkËn
);

1108 
pos
 +ğ
c
->
bulkËn
+2;

1110 
c
->
bulkËn
 = -1;

1111 
c
->
muÉibulkËn
--;

1116 ià(
pos
è
	`sd¤ªge
(
c
->
qu”ybuf
,pos,-1);

1119 ià(
c
->
muÉibulkËn
 =ğ0è 
REDIS_OK
;

1122  
REDIS_ERR
;

1123 
	}
}

1125 
	$´oûssIÅutBufãr
(
»disCl›Á
 *
c
) {

1127 
	`sd¦’
(
c
->
qu”ybuf
)) {

1129 ià(!(
c
->
æags
 & 
REDIS_SLAVE
è&& 
	`ş›ÁsA»Pau£d
()) ;

1132 ià(
c
->
æags
 & 
REDIS_BLOCKED
) ;

1137 ià(
c
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
) ;

1140 ià(!
c
->
»qty³
) {

1141 ià(
c
->
qu”ybuf
[0] == '*') {

1142 
c
->
»qty³
 = 
REDIS_REQ_MULTIBULK
;

1144 
c
->
»qty³
 = 
REDIS_REQ_INLINE
;

1148 ià(
c
->
»qty³
 =ğ
REDIS_REQ_INLINE
) {

1149 ià(
	`´oûssIÆšeBufãr
(
c
è!ğ
REDIS_OK
) ;

1150 } ià(
c
->
»qty³
 =ğ
REDIS_REQ_MULTIBULK
) {

1151 ià(
	`´oûssMuÉibulkBufãr
(
c
è!ğ
REDIS_OK
) ;

1153 
	`»disPªic
("Unknown„equestype");

1157 ià(
c
->
¬gc
 == 0) {

1158 
	`»£tCl›Á
(
c
);

1161 ià(
	`´oûssCommªd
(
c
è=ğ
REDIS_OK
)

1162 
	`»£tCl›Á
(
c
);

1165 
	}
}

1167 
	$»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1168 
»disCl›Á
 *
c
 = (»disCl›Á*è
´ivd©a
;

1169 
Ä—d
, 
»adËn
;

1170 
size_t
 
qbËn
;

1171 
	`REDIS_NOTUSED
(
–
);

1172 
	`REDIS_NOTUSED
(
mask
);

1174 
£rv”
.
cu¼’t_ş›Á
 = 
c
;

1175 
»adËn
 = 
REDIS_IOBUF_LEN
;

1182 ià(
c
->
»qty³
 =ğ
REDIS_REQ_MULTIBULK
 && c->
muÉibulkËn
 && c->
bulkËn
 != -1

1183 && 
c
->
bulkËn
 >ğ
REDIS_MBULK_BIG_ARG
)

1185 
»maššg
 = ()(
c
->
bulkËn
+2)-
	`sd¦’
(c->
qu”ybuf
);

1187 ià(
»maššg
 < 
»adËn
)„eadlen =„emaining;

1190 
qbËn
 = 
	`sd¦’
(
c
->
qu”ybuf
);

1191 ià(
c
->
qu”ybuf_³ak
 < 
qbËn
) c->querybuf_peak = qblen;

1192 
c
->
qu”ybuf
 = 
	`sdsMakeRoomFÜ
(c->qu”ybuf, 
»adËn
);

1193 
Ä—d
 = 
	`»ad
(
fd
, 
c
->
qu”ybuf
+
qbËn
, 
»adËn
);

1194 ià(
Ä—d
 == -1) {

1195 ià(
”ºo
 =ğ
EAGAIN
) {

1196 
Ä—d
 = 0;

1198 
	`»disLog
(
REDIS_VERBOSE
, "R—dšg from cl›Á: %s",
	`¡»¼Ü
(
”ºo
));

1199 
	`ä“Cl›Á
(
c
);

1202 } ià(
Ä—d
 == 0) {

1203 
	`»disLog
(
REDIS_VERBOSE
, "Client closed connection");

1204 
	`ä“Cl›Á
(
c
);

1207 ià(
Ä—d
) {

1208 
	`sdsInüL’
(
c
->
qu”ybuf
,
Ä—d
);

1209 
c
->
Ï¡š‹¿ùiÚ
 = 
£rv”
.
unixtime
;

1210 ià(
c
->
æags
 & 
REDIS_MASTER
èc->
»¶off
 +ğ
Ä—d
;

1211 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

1213 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1216 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
£rv”
.
ş›Á_max_qu”ybuf_Ën
) {

1217 
sds
 
ci
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
), 
by‹s
 = sdsempty();

1219 
by‹s
 = 
	`sdsÿŒ•r
(by‹s,
c
->
qu”ybuf
,64);

1220 
	`»disLog
(
REDIS_WARNING
,"Closšg cl›Áh©„—ched max qu”y bufã¸Ëngth: % (qbuàš™ŸÈby‹s: %s)", 
ci
, 
by‹s
);

1221 
	`sdsä“
(
ci
);

1222 
	`sdsä“
(
by‹s
);

1223 
	`ä“Cl›Á
(
c
);

1226 
	`´oûssIÅutBufãr
(
c
);

1227 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1228 
	}
}

1230 
	$g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1231 *
bigge¡_šput_bufãr
) {

1232 
»disCl›Á
 *
c
;

1233 
li¡Node
 *
Ê
;

1234 
li¡I‹r
 
li
;

1235 
lŞ
 = 0, 
bib
 = 0;

1237 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1238 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1239 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1241 ià(
	`li¡L’gth
(
c
->
»¶y
è> 
lŞ
)†ol =†istLength(c->reply);

1242 ià(
	`sd¦’
(
c
->
qu”ybuf
è> 
bib
) bib = sdslen(c->querybuf);

1244 *
lÚge¡_ouut_li¡
 = 
lŞ
;

1245 *
bigge¡_šput_bufãr
 = 
bib
;

1246 
	}
}

1252 
	$fÜm©P“rId
(*
³”id
, 
size_t
 
³”id_Ën
, *

, 
pÜt
) {

1253 ià(
	`¡rchr
(

,':'))

1254 
	`¢´štf
(
³”id
,
³”id_Ën
,"[%s]:%d",

,
pÜt
);

1256 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:%d",

,
pÜt
);

1257 
	}
}

1272 
	$g’Cl›ÁP“rId
(
»disCl›Á
 *
ş›Á
, *
³”id
, 
size_t
 
³”id_Ën
) {

1273 

[
REDIS_IP_STR_LEN
];

1274 
pÜt
;

1276 ià(
ş›Á
->
æags
 & 
REDIS_UNIX_SOCKET
) {

1278 
	`¢´štf
(
³”id
,
³”id_Ën
,"%s:0",
£rv”
.
unixsock‘
);

1279  
REDIS_OK
;

1282 
»tv®
 = 
	`ª‘P“rToSŒšg
(
ş›Á
->
fd
,

,(),&
pÜt
);

1283 
	`fÜm©P“rId
(
³”id
,
³”id_Ën
,

,
pÜt
);

1284  (
»tv®
 =ğ-1è? 
REDIS_ERR
 : 
REDIS_OK
;

1286 
	}
}

1292 *
	$g‘Cl›ÁP“rId
(
»disCl›Á
 *
c
) {

1293 
³”id
[
REDIS_PEER_ID_LEN
];

1295 ià(
c
->
³”id
 =ğ
NULL
) {

1296 
	`g’Cl›ÁP“rId
(
c
,
³”id
,(peerid));

1297 
c
->
³”id
 = 
	`sd¢ew
(peerid);

1299  
c
->
³”id
;

1300 
	}
}

1304 
sds
 
	$ÿtCl›ÁInfoSŒšg
(
sds
 
s
, 
»disCl›Á
 *
ş›Á
) {

1305 
æags
[16], 
ev’ts
[3], *
p
;

1306 
emask
;

1308 
p
 = 
æags
;

1309 ià(
ş›Á
->
æags
 & 
REDIS_SLAVE
) {

1310 ià(
ş›Á
->
æags
 & 
REDIS_MONITOR
)

1311 *
p
++ = 'O';

1313 *
p
++ = 'S';

1315 ià(
ş›Á
->
æags
 & 
REDIS_MASTER
è*
p
++ = 'M';

1316 ià(
ş›Á
->
æags
 & 
REDIS_MULTI
è*
p
++ = 'x';

1317 ià(
ş›Á
->
æags
 & 
REDIS_BLOCKED
è*
p
++ = 'b';

1318 ià(
ş›Á
->
æags
 & 
REDIS_DIRTY_CAS
è*
p
++ = 'd';

1319 ià(
ş›Á
->
æags
 & 
REDIS_CLOSE_AFTER_REPLY
è*
p
++ = 'c';

1320 ià(
ş›Á
->
æags
 & 
REDIS_UNBLOCKED
è*
p
++ = 'u';

1321 ià(
ş›Á
->
æags
 & 
REDIS_CLOSE_ASAP
è*
p
++ = 'A';

1322 ià(
ş›Á
->
æags
 & 
REDIS_UNIX_SOCKET
è*
p
++ = 'U';

1323 ià(
ş›Á
->
æags
 & 
REDIS_READONLY
è*
p
++ = 'r';

1324 ià(
p
 =ğ
æags
) *p++ = 'N';

1325 *
p
++ = '\0';

1327 
emask
 = 
ş›Á
->
fd
 =ğ-1 ? 0 : 
	`«G‘FeEv’ts
(
£rv”
.
–
,client->fd);

1328 
p
 = 
ev’ts
;

1329 ià(
emask
 & 
AE_READABLE
è*
p
++ = 'r';

1330 ià(
emask
 & 
AE_WRITABLE
è*
p
++ = 'w';

1331 *
p
 = '\0';

1332  
	`sdsÿtfmt
(
s
,

1334 (è
ş›Á
->
id
,

1335 
	`g‘Cl›ÁP“rId
(
ş›Á
),

1336 
ş›Á
->
fd
,

1337 
ş›Á
->
Çme
 ? (*)ş›Á->Çme->
±r
 : "",

1338 ()(
£rv”
.
unixtime
 - 
ş›Á
->
ùime
),

1339 ()(
£rv”
.
unixtime
 - 
ş›Á
->
Ï¡š‹¿ùiÚ
),

1340 
æags
,

1341 
ş›Á
->
db
->
id
,

1342 (è
	`diùSize
(
ş›Á
->
pubsub_chªÃls
),

1343 (è
	`li¡L’gth
(
ş›Á
->
pubsub_·‰”ns
),

1344 (
ş›Á
->
æags
 & 
REDIS_MULTI
è? cl›Á->
m¡©e
.
couÁ
 : -1,

1345 (è
	`sd¦’
(
ş›Á
->
qu”ybuf
),

1346 (è
	`sd§va
(
ş›Á
->
qu”ybuf
),

1347 (è
ş›Á
->
buåos
,

1348 (è
	`li¡L’gth
(
ş›Á
->
»¶y
),

1349 (è
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
ş›Á
),

1350 
ev’ts
,

1351 
ş›Á
->
Ï¡cmd
 ? cl›Á->Ï¡cmd->
Çme
 : "NULL");

1352 
	}
}

1354 
sds
 
	$g‘AÎCl›ÁsInfoSŒšg
() {

1355 
li¡Node
 *
Ê
;

1356 
li¡I‹r
 
li
;

1357 
»disCl›Á
 *
ş›Á
;

1358 
sds
 
o
 = 
	`sd£m±y
();

1360 
o
 = 
	`sdsMakeRoomFÜ
(o,200*
	`li¡L’gth
(
£rv”
.
ş›Ás
));

1361 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1362 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1363 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1364 
o
 = 
	`ÿtCl›ÁInfoSŒšg
(o,
ş›Á
);

1365 
o
 = 
	`sdsÿ’
(o,"\n",1);

1367  
o
;

1368 
	}
}

1370 
	$ş›ÁCommªd
(
»disCl›Á
 *
c
) {

1371 
li¡Node
 *
Ê
;

1372 
li¡I‹r
 
li
;

1373 
»disCl›Á
 *
ş›Á
;

1375 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"li¡"è&& c->
¬gc
 == 2) {

1377 
sds
 
o
 = 
	`g‘AÎCl›ÁsInfoSŒšg
();

1378 
	`addR•lyBulkCBufãr
(
c
,
o
,
	`sd¦’
(o));

1379 
	`sdsä“
(
o
);

1380 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"kill")) {

1383 *
addr
 = 
NULL
;

1384 
ty³
 = -1;

1385 
ušt64_t
 
id
 = 0;

1386 
skme
 = 1;

1387 
kËd
 = 0, 
şo£_this_ş›Á
 = 0;

1389 ià(
c
->
¬gc
 == 3) {

1391 
addr
 = 
c
->
¬gv
[2]->
±r
;

1392 
skme
 = 0;

1393 } ià(
c
->
¬gc
 > 3) {

1394 
i
 = 2;

1397 
i
 < 
c
->
¬gc
) {

1398 
mÜ—rgs
 = 
c
->
¬gc
 > 
i
+1;

1400 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"id"è&& 
mÜ—rgs
) {

1401 
tmp
;

1403 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
i
+1],&
tmp
,
NULL
)

1404 !ğ
REDIS_OK
) ;

1405 
id
 = 
tmp
;

1406 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"ty³"è&& 
mÜ—rgs
) {

1407 
ty³
 = 
	`g‘Cl›ÁTy³ByName
(
c
->
¬gv
[
i
+1]->
±r
);

1408 ià(
ty³
 == -1) {

1409 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown clientype '%s'",

1410 (*è
c
->
¬gv
[
i
+1]->
±r
);

1413 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"addr"è&& 
mÜ—rgs
) {

1414 
addr
 = 
c
->
¬gv
[
i
+1]->
±r
;

1415 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
]->
±r
,"skme"è&& 
mÜ—rgs
) {

1416 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"yes")) {

1417 
skme
 = 1;

1418 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
i
+1]->
±r
,"no")) {

1419 
skme
 = 0;

1421 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1425 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1428 
i
 += 2;

1431 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1436 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1437 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1438 
ş›Á
 = 
	`li¡NodeV®ue
(
Ê
);

1439 ià(
addr
 && 
	`¡rcmp
(
	`g‘Cl›ÁP“rId
(
ş›Á
),addr) != 0) ;

1440 ià(
ty³
 != -1 &&

1441 (
ş›Á
->
æags
 & 
REDIS_MASTER
 ||

1442 
	`g‘Cl›ÁTy³
(
ş›Á
è!ğ
ty³
)) ;

1443 ià(
id
 !ğ0 && 
ş›Á
->id != id) ;

1444 ià(
c
 =ğ
ş›Á
 && 
skme
) ;

1447 ià(
c
 =ğ
ş›Á
) {

1448 
şo£_this_ş›Á
 = 1;

1450 
	`ä“Cl›Á
(
ş›Á
);

1452 
kËd
++;

1456 ià(
c
->
¬gc
 == 3) {

1457 ià(
kËd
 == 0)

1458 
	`addR•lyE¼Ü
(
c
,"No such client");

1460 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1462 
	`addR•lyLÚgLÚg
(
c
,
kËd
);

1467 ià(
şo£_this_ş›Á
è
c
->
æags
 |ğ
REDIS_CLOSE_AFTER_REPLY
;

1468 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"£Šame"è&& c->
¬gc
 == 3) {

1469 
j
, 
Ën
 = 
	`sd¦’
(
c
->
¬gv
[2]->
±r
);

1470 *
p
 = 
c
->
¬gv
[2]->
±r
;

1474 ià(
Ën
 == 0) {

1475 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1476 
c
->
Çme
 = 
NULL
;

1477 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1484 
j
 = 0; j < 
Ën
; j++) {

1485 ià(
p
[
j
] < '!' ||…[j] > '~') {

1486 
	`addR•lyE¼Ü
(
c
,

1492 ià(
c
->
Çme
è
	`deüRefCouÁ
(c->name);

1493 
c
->
Çme
 = c->
¬gv
[2];

1494 
	`šüRefCouÁ
(
c
->
Çme
);

1495 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1496 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘Çme"è&& c->
¬gc
 == 2) {

1497 ià(
c
->
Çme
)

1498 
	`addR•lyBulk
(
c
,c->
Çme
);

1500 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

1501 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"·u£"è&& c->
¬gc
 == 3) {

1502 
du¿tiÚ
;

1504 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
du¿tiÚ
,
UNIT_MILLISECONDS
)

1505 !ğ
REDIS_OK
) ;

1506 
	`·u£Cl›Ás
(
du¿tiÚ
);

1507 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1509 
	`addR•lyE¼Ü
(
c
, "Syntaxƒrror,ry CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)");

1511 
	}
}

1516 
	$»wr™eCl›ÁCommªdVeùÜ
(
»disCl›Á
 *
c
, 
¬gc
, ...) {

1517 
va_li¡
 
­
;

1518 
j
;

1519 
robj
 **
¬gv
;

1521 
¬gv
 = 
	`zm®loc
((
robj
*)*
¬gc
);

1522 
	`va_¡¬t
(
­
,
¬gc
);

1523 
j
 = 0; j < 
¬gc
; j++) {

1524 
robj
 *
a
;

1526 
a
 = 
	`va_¬g
(
­
, 
robj
*);

1527 
¬gv
[
j
] = 
a
;

1528 
	`šüRefCouÁ
(
a
);

1533 
j
 = 0; j < 
c
->
¬gc
; j++è
	`deüRefCouÁ
(c->
¬gv
[j]);

1534 
	`zä“
(
c
->
¬gv
);

1536 
c
->
¬gv
 =‡rgv;

1537 
c
->
¬gc
 =‡rgc;

1538 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1539 
	`»disAs£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1540 
	`va_’d
(
­
);

1541 
	}
}

1545 
	$»wr™eCl›ÁCommªdArgum’t
(
»disCl›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
) {

1546 
robj
 *
Şdv®
;

1548 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
i
 < c->
¬gc
);

1549 
Şdv®
 = 
c
->
¬gv
[
i
];

1550 
c
->
¬gv
[
i
] = 
Ãwv®
;

1551 
	`šüRefCouÁ
(
Ãwv®
);

1552 
	`deüRefCouÁ
(
Şdv®
);

1555 ià(
i
 == 0) {

1556 
c
->
cmd
 = 
	`lookupCommªdOrOrigš®
(c->
¬gv
[0]->
±r
);

1557 
	`»disAs£¹W™hInfo
(
c
,
NULL
,c->
cmd
 != NULL);

1559 
	}
}

1574 
	$g‘Cl›ÁOuutBufãrMemÜyU§ge
(
»disCl›Á
 *
c
) {

1575 
li¡_™em_size
 = (
li¡Node
)+(
robj
);

1577  
c
->
»¶y_by‹s
 + (
li¡_™em_size
*
	`li¡L’gth
(c->
»¶y
));

1578 
	}
}

1588 
	$g‘Cl›ÁTy³
(
»disCl›Á
 *
c
) {

1589 ià((
c
->
æags
 & 
REDIS_SLAVE
è&& !(c->æag & 
REDIS_MONITOR
))

1590  
REDIS_CLIENT_TYPE_SLAVE
;

1591 ià(
c
->
æags
 & 
REDIS_PUBSUB
)

1592  
REDIS_CLIENT_TYPE_PUBSUB
;

1593  
REDIS_CLIENT_TYPE_NORMAL
;

1594 
	}
}

1596 
	$g‘Cl›ÁTy³ByName
(*
Çme
) {

1597 ià(!
	`¡rÿ£cmp
(
Çme
,"nÜm®")è 
REDIS_CLIENT_TYPE_NORMAL
;

1598 ià(!
	`¡rÿ£cmp
(
Çme
,"¦ave")è 
REDIS_CLIENT_TYPE_SLAVE
;

1599 ià(!
	`¡rÿ£cmp
(
Çme
,"pubsub")è 
REDIS_CLIENT_TYPE_PUBSUB
;

1601 
	}
}

1603 *
	$g‘Cl›ÁTy³Name
(
şass
) {

1604 
şass
) {

1605 
REDIS_CLIENT_TYPE_NORMAL
:  "normal";

1606 
REDIS_CLIENT_TYPE_SLAVE
:  "slave";

1607 
REDIS_CLIENT_TYPE_PUBSUB
:  "pubsub";

1608 :  
NULL
;

1610 
	}
}

1618 
	$checkCl›ÁOuutBufãrLim™s
(
»disCl›Á
 *
c
) {

1619 
soá
 = 0, 
h¬d
 = 0, 
şass
;

1620 
u£d_mem
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
c
);

1622 
şass
 = 
	`g‘Cl›ÁTy³
(
c
);

1623 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
 &&

1624 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
h¬d_lim™_by‹s
)

1625 
h¬d
 = 1;

1626 ià(
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
 &&

1627 
u£d_mem
 >ğ
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_by‹s
)

1628 
soá
 = 1;

1632 ià(
soá
) {

1633 ià(
c
->
obuf_soá_lim™_»ached_time
 == 0) {

1634 
c
->
obuf_soá_lim™_»ached_time
 = 
£rv”
.
unixtime
;

1635 
soá
 = 0;

1637 
time_t
 
–­£d
 = 
£rv”
.
unixtime
 - 
c
->
obuf_soá_lim™_»ached_time
;

1639 ià(
–­£d
 <=

1640 
£rv”
.
ş›Á_obuf_lim™s
[
şass
].
soá_lim™_£cÚds
) {

1641 
soá
 = 0;

1647 
c
->
obuf_soá_lim™_»ached_time
 = 0;

1649  
soá
 || 
h¬d
;

1650 
	}
}

1659 
	$asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
»disCl›Á
 *
c
) {

1660 
	`»disAs£¹
(
c
->
»¶y_by‹s
 < 
ULONG_MAX
-(1024*64));

1661 ià(
c
->
»¶y_by‹s
 =ğ0 || c->
æags
 & 
REDIS_CLOSE_ASAP
) ;

1662 ià(
	`checkCl›ÁOuutBufãrLim™s
(
c
)) {

1663 
sds
 
ş›Á
 = 
	`ÿtCl›ÁInfoSŒšg
(
	`sd£m±y
(),
c
);

1665 
	`ä“Cl›ÁAsync
(
c
);

1666 
	`»disLog
(
REDIS_WARNING
,"Cl›Á % scheduËdØbşo£d ASAP fÜ ov”comšg oàouuˆbufã¸lim™s.", 
ş›Á
);

1667 
	`sdsä“
(
ş›Á
);

1669 
	}
}

1673 
	$æushSÏvesOuutBufãrs
() {

1674 
li¡I‹r
 
li
;

1675 
li¡Node
 *
Ê
;

1677 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1678 (
Ê
 = 
	`li¡Next
(&
li
))) {

1679 
»disCl›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

1680 
ev’ts
;

1682 
ev’ts
 = 
	`«G‘FeEv’ts
(
£rv”
.
–
,
¦ave
->
fd
);

1683 ià(
ev’ts
 & 
AE_WRITABLE
 &&

1684 
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_ONLINE
 &&

1685 
	`li¡L’gth
(
¦ave
->
»¶y
))

1687 
	`£ndR•lyToCl›Á
(
£rv”
.
–
,
¦ave
->
fd
,slave,0);

1690 
	}
}

1709 
	$·u£Cl›Ás
(
m¡ime_t
 
’d
) {

1710 ià(!
£rv”
.
ş›Ás_·u£d
 || 
’d
 > s”v”.
ş›Ás_·u£_’d_time
)

1711 
£rv”
.
ş›Ás_·u£_’d_time
 = 
’d
;

1712 
£rv”
.
ş›Ás_·u£d
 = 1;

1713 
	}
}

1717 
	$ş›ÁsA»Pau£d
() {

1718 ià(
£rv”
.
ş›Ás_·u£d
 &&

1719 
£rv”
.
ş›Ás_·u£_’d_time
 < s”v”.
m¡ime
)

1721 
li¡Node
 *
Ê
;

1722 
li¡I‹r
 
li
;

1723 
»disCl›Á
 *
c
;

1725 
£rv”
.
ş›Ás_·u£d
 = 0;

1729 
	`li¡Rewšd
(
£rv”
.
ş›Ás
,&
li
);

1730 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

1731 
c
 = 
	`li¡NodeV®ue
(
Ê
);

1735 ià(
c
->
æags
 & (
REDIS_SLAVE
|
REDIS_BLOCKED
)) ;

1736 
c
->
æags
 |ğ
REDIS_UNBLOCKED
;

1737 
	`li¡AddNodeTa
(
£rv”
.
unblocked_ş›Ás
,
c
);

1740  
£rv”
.
ş›Ás_·u£d
;

1741 
	}
}

1755 
	$´oûssEv’tsWheBlocked
() {

1756 
™”©iÚs
 = 4;

1757 
couÁ
 = 0;

1758 
™”©iÚs
--) {

1759 
ev’ts
 = 
	`«ProûssEv’ts
(
£rv”
.
–
, 
AE_FILE_EVENTS
|
AE_DONT_WAIT
);

1760 ià(!
ev’ts
) ;

1761 
couÁ
 +ğ
ev’ts
;

1763  
couÁ
;

1764 
	}
}

	@notify.c

30 
	~"»dis.h
"

40 
	$key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
) {

41 *
p
 = 
şas£s
;

42 
c
, 
æags
 = 0;

44 (
c
 = *
p
++) != '\0') {

45 
c
) {

46 'A': 
æags
 |ğ
REDIS_NOTIFY_ALL
; ;

47 'g': 
æags
 |ğ
REDIS_NOTIFY_GENERIC
; ;

48 '$': 
æags
 |ğ
REDIS_NOTIFY_STRING
; ;

49 'l': 
æags
 |ğ
REDIS_NOTIFY_LIST
; ;

50 's': 
æags
 |ğ
REDIS_NOTIFY_SET
; ;

51 'h': 
æags
 |ğ
REDIS_NOTIFY_HASH
; ;

52 'z': 
æags
 |ğ
REDIS_NOTIFY_ZSET
; ;

53 'x': 
æags
 |ğ
REDIS_NOTIFY_EXPIRED
; ;

54 'e': 
æags
 |ğ
REDIS_NOTIFY_EVICTED
; ;

55 'K': 
æags
 |ğ
REDIS_NOTIFY_KEYSPACE
; ;

56 'E': 
æags
 |ğ
REDIS_NOTIFY_KEYEVENT
; ;

60  
æags
;

61 
	}
}

67 
sds
 
	$key¥aûEv’tsFÏgsToSŒšg
(
æags
) {

68 
sds
 
»s
;

70 
»s
 = 
	`sd£m±y
();

71 ià((
æags
 & 
REDIS_NOTIFY_ALL
) == REDIS_NOTIFY_ALL) {

72 
»s
 = 
	`sdsÿ’
(res,"A",1);

74 ià(
æags
 & 
REDIS_NOTIFY_GENERIC
è
»s
 = 
	`sdsÿ’
(res,"g",1);

75 ià(
æags
 & 
REDIS_NOTIFY_STRING
è
»s
 = 
	`sdsÿ’
(res,"$",1);

76 ià(
æags
 & 
REDIS_NOTIFY_LIST
è
»s
 = 
	`sdsÿ’
(res,"l",1);

77 ià(
æags
 & 
REDIS_NOTIFY_SET
è
»s
 = 
	`sdsÿ’
(res,"s",1);

78 ià(
æags
 & 
REDIS_NOTIFY_HASH
è
»s
 = 
	`sdsÿ’
(res,"h",1);

79 ià(
æags
 & 
REDIS_NOTIFY_ZSET
è
»s
 = 
	`sdsÿ’
(res,"z",1);

80 ià(
æags
 & 
REDIS_NOTIFY_EXPIRED
è
»s
 = 
	`sdsÿ’
(res,"x",1);

81 ià(
æags
 & 
REDIS_NOTIFY_EVICTED
è
»s
 = 
	`sdsÿ’
(res,"e",1);

83 ià(
æags
 & 
REDIS_NOTIFY_KEYSPACE
è
»s
 = 
	`sdsÿ’
(res,"K",1);

84 ià(
æags
 & 
REDIS_NOTIFY_KEYEVENT
è
»s
 = 
	`sdsÿ’
(res,"E",1);

85  
»s
;

86 
	}
}

95 
	$nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
) {

96 
sds
 
chª
;

97 
robj
 *
chªobj
, *
ev’tobj
;

98 
Ën
 = -1;

99 
buf
[24];

102 ià(!(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
ty³
)) ;

104 
ev’tobj
 = 
	`ü—‹SŒšgObjeù
(
ev’t
,
	`¡¾’
(event));

107 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
REDIS_NOTIFY_KEYSPACE
) {

108 
chª
 = 
	`sd¢ewËn
("__keyspace@",11);

109 
Ën
 = 
	`Î2¡ršg
(
buf
,(buf),
dbid
);

110 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

111 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

112 
chª
 = 
	`sdsÿtsds
(chª, 
key
->
±r
);

113 
chªobj
 = 
	`ü—‹Objeù
(
REDIS_STRING
, 
chª
);

114 
	`pubsubPublishMes§ge
(
chªobj
, 
ev’tobj
);

115 
	`deüRefCouÁ
(
chªobj
);

119 ià(
£rv”
.
nÙify_key¥aû_ev’ts
 & 
REDIS_NOTIFY_KEYEVENT
) {

120 
chª
 = 
	`sd¢ewËn
("__keyevent@",11);

121 ià(
Ën
 =ğ-1èËÀğ
	`Î2¡ršg
(
buf
,(buf),
dbid
);

122 
chª
 = 
	`sdsÿ’
(chª, 
buf
, 
Ën
);

123 
chª
 = 
	`sdsÿ’
(chan, "__:", 3);

124 
chª
 = 
	`sdsÿtsds
(chª, 
ev’tobj
->
±r
);

125 
chªobj
 = 
	`ü—‹Objeù
(
REDIS_STRING
, 
chª
);

126 
	`pubsubPublishMes§ge
(
chªobj
, 
key
);

127 
	`deüRefCouÁ
(
chªobj
);

129 
	`deüRefCouÁ
(
ev’tobj
);

130 
	}
}

	@object.c

31 
	~"»dis.h
"

32 
	~<m©h.h
>

33 
	~<ùy³.h
>

35 #ifdeà
__CYGWIN__


36 
	#¡¹Şd
(
a
,
b
è(()
	`¡¹od
(×),(b)))

	)

39 
robj
 *
	$ü—‹Objeù
(
ty³
, *
±r
) {

40 
robj
 *
o
 = 
	`zm®loc
((*o));

41 
o
->
ty³
 =ype;

42 
o
->
’codšg
 = 
REDIS_ENCODING_RAW
;

43 
o
->
±r
 =…tr;

44 
o
->
»fcouÁ
 = 1;

47 
o
->
Ìu
 = 
	`LRU_CLOCK
();

48  
o
;

49 
	}
}

53 
robj
 *
	$ü—‹RawSŒšgObjeù
(*
±r
, 
size_t
 
Ën
) {

54  
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ewËn
(
±r
,
Ën
));

55 
	}
}

60 
robj
 *
	$ü—‹EmbeddedSŒšgObjeù
(*
±r
, 
size_t
 
Ën
) {

61 
robj
 *
o
 = 
	`zm®loc
(Ôobj)+(
sdshdr
)+
Ën
+1);

62 
sdshdr
 *
sh
 = (*)(
o
+1);

64 
o
->
ty³
 = 
REDIS_STRING
;

65 
o
->
’codšg
 = 
REDIS_ENCODING_EMBSTR
;

66 
o
->
±r
 = 
sh
+1;

67 
o
->
»fcouÁ
 = 1;

68 
o
->
Ìu
 = 
	`LRU_CLOCK
();

70 
sh
->
Ën
 =†en;

71 
sh
->
ä“
 = 0;

72 ià(
±r
) {

73 
	`memıy
(
sh
->
buf
,
±r
,
Ën
);

74 
sh
->
buf
[
Ën
] = '\0';

76 
	`mem£t
(
sh
->
buf
,0,
Ën
+1);

78  
o
;

79 
	}
}

87 
	#REDIS_ENCODING_EMBSTR_SIZE_LIMIT
 39

	)

88 
robj
 *
	$ü—‹SŒšgObjeù
(*
±r
, 
size_t
 
Ën
) {

89 ià(
Ën
 <ğ
REDIS_ENCODING_EMBSTR_SIZE_LIMIT
)

90  
	`ü—‹EmbeddedSŒšgObjeù
(
±r
,
Ën
);

92  
	`ü—‹RawSŒšgObjeù
(
±r
,
Ën
);

93 
	}
}

95 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
) {

96 
robj
 *
o
;

97 ià(
v®ue
 >ğ0 && v®u< 
REDIS_SHARED_INTEGERS
) {

98 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

99 
o
 = 
sh¬ed
.
š‹g”s
[
v®ue
];

101 ià(
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
) {

102 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
, 
NULL
);

103 
o
->
’codšg
 = 
REDIS_ENCODING_INT
;

104 
o
->
±r
 = (*)(()
v®ue
);

106 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sdsäomlÚglÚg
(
v®ue
));

109  
o
;

110 
	}
}

118 
robj
 *
	$ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
) {

119 
buf
[256];

120 
Ën
;

122 ià(
	`isšf
(
v®ue
)) {

125 ià(
v®ue
 > 0) {

126 
	`memıy
(
buf
,"inf",3);

127 
Ën
 = 3;

129 
	`memıy
(
buf
,"-inf",4);

130 
Ën
 = 4;

132 } ià(
humªä›ndly
) {

138 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lf", 
v®ue
);

140 ià(
	`¡rchr
(
buf
,'.'è!ğ
NULL
) {

141 *
p
 = 
buf
+
Ën
-1;

142 *
p
 == '0') {

143 
p
--;

144 
Ën
--;

146 ià(*
p
 =ğ'.'è
Ën
--;

149 
Ën
 = 
	`¢´štf
(
buf
,(buf),"%.17Lg", 
v®ue
);

151  
	`ü—‹SŒšgObjeù
(
buf
,
Ën
);

152 
	}
}

162 
robj
 *
	$dupSŒšgObjeù
(
robj
 *
o
) {

163 
robj
 *
d
;

165 
	`»disAs£¹
(
o
->
ty³
 =ğ
REDIS_STRING
);

167 
o
->
’codšg
) {

168 
REDIS_ENCODING_RAW
:

169  
	`ü—‹RawSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

170 
REDIS_ENCODING_EMBSTR
:

171  
	`ü—‹EmbeddedSŒšgObjeù
(
o
->
±r
,
	`sd¦’
(o->ptr));

172 
REDIS_ENCODING_INT
:

173 
d
 = 
	`ü—‹Objeù
(
REDIS_STRING
, 
NULL
);

174 
d
->
’codšg
 = 
REDIS_ENCODING_INT
;

175 
d
->
±r
 = 
o
->ptr;

176  
d
;

178 
	`»disPªic
("Wrongƒncoding.");

181 
	}
}

183 
robj
 *
	$ü—‹Li¡Objeù
() {

184 
li¡
 *
l
 = 
	`li¡C»©e
();

185 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_LIST
,
l
);

186 
	`li¡S‘F»eM‘hod
(
l
,
deüRefCouÁVoid
);

187 
o
->
’codšg
 = 
REDIS_ENCODING_LINKEDLIST
;

188  
o
;

189 
	}
}

191 
robj
 *
	$ü—‹Zli¡Objeù
() {

192 *
zl
 = 
	`zli¡New
();

193 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_LIST
,
zl
);

194 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

195  
o
;

196 
	}
}

198 
robj
 *
	$ü—‹S‘Objeù
() {

199 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

200 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_SET
,
d
);

201 
o
->
’codšg
 = 
REDIS_ENCODING_HT
;

202  
o
;

203 
	}
}

205 
robj
 *
	$ü—‹IÁ£tObjeù
() {

206 
št£t
 *
is
 = 
	`št£tNew
();

207 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_SET
,
is
);

208 
o
->
’codšg
 = 
REDIS_ENCODING_INTSET
;

209  
o
;

210 
	}
}

212 
robj
 *
	$ü—‹HashObjeù
() {

213 *
zl
 = 
	`zli¡New
();

214 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_HASH
, 
zl
);

215 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

216  
o
;

217 
	}
}

219 
robj
 *
	$ü—‹Z£tObjeù
() {

220 
z£t
 *
zs
 = 
	`zm®loc
((*zs));

221 
robj
 *
o
;

223 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

224 
zs
->
z¦
 = 
	`z¦C»©e
();

225 
o
 = 
	`ü—‹Objeù
(
REDIS_ZSET
,
zs
);

226 
o
->
’codšg
 = 
REDIS_ENCODING_SKIPLIST
;

227  
o
;

228 
	}
}

230 
robj
 *
	$ü—‹Z£tZli¡Objeù
() {

231 *
zl
 = 
	`zli¡New
();

232 
robj
 *
o
 = 
	`ü—‹Objeù
(
REDIS_ZSET
,
zl
);

233 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

234  
o
;

235 
	}
}

237 
	$ä“SŒšgObjeù
(
robj
 *
o
) {

238 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_RAW
) {

239 
	`sdsä“
(
o
->
±r
);

241 
	}
}

243 
	$ä“Li¡Objeù
(
robj
 *
o
) {

244 
o
->
’codšg
) {

245 
REDIS_ENCODING_LINKEDLIST
:

246 
	`li¡R–—£
((
li¡
*è
o
->
±r
);

248 
REDIS_ENCODING_ZIPLIST
:

249 
	`zä“
(
o
->
±r
);

252 
	`»disPªic
("Unknown†istƒncodingype");

254 
	}
}

256 
	$ä“S‘Objeù
(
robj
 *
o
) {

257 
o
->
’codšg
) {

258 
REDIS_ENCODING_HT
:

259 
	`diùR–—£
((
diù
*è
o
->
±r
);

261 
REDIS_ENCODING_INTSET
:

262 
	`zä“
(
o
->
±r
);

265 
	`»disPªic
("Unknown setƒncodingype");

267 
	}
}

269 
	$ä“Z£tObjeù
(
robj
 *
o
) {

270 
z£t
 *
zs
;

271 
o
->
’codšg
) {

272 
REDIS_ENCODING_SKIPLIST
:

273 
zs
 = 
o
->
±r
;

274 
	`diùR–—£
(
zs
->
diù
);

275 
	`z¦F»e
(
zs
->
z¦
);

276 
	`zä“
(
zs
);

278 
REDIS_ENCODING_ZIPLIST
:

279 
	`zä“
(
o
->
±r
);

282 
	`»disPªic
("Unknown sorted setƒncoding");

284 
	}
}

286 
	$ä“HashObjeù
(
robj
 *
o
) {

287 
o
->
’codšg
) {

288 
REDIS_ENCODING_HT
:

289 
	`diùR–—£
((
diù
*è
o
->
±r
);

291 
REDIS_ENCODING_ZIPLIST
:

292 
	`zä“
(
o
->
±r
);

295 
	`»disPªic
("Unknown hashƒncodingype");

298 
	}
}

300 
	$šüRefCouÁ
(
robj
 *
o
) {

301 
o
->
»fcouÁ
++;

302 
	}
}

304 
	$deüRefCouÁ
(
robj
 *
o
) {

305 ià(
o
->
»fcouÁ
 <ğ0è
	`»disPªic
("decrRefCount‡gainst„efcount <= 0");

306 ià(
o
->
»fcouÁ
 == 1) {

307 
o
->
ty³
) {

308 
REDIS_STRING
: 
	`ä“SŒšgObjeù
(
o
); ;

309 
REDIS_LIST
: 
	`ä“Li¡Objeù
(
o
); ;

310 
REDIS_SET
: 
	`ä“S‘Objeù
(
o
); ;

311 
REDIS_ZSET
: 
	`ä“Z£tObjeù
(
o
); ;

312 
REDIS_HASH
: 
	`ä“HashObjeù
(
o
); ;

313 : 
	`»disPªic
("Unknown objectype"); ;

315 
	`zä“
(
o
);

317 
o
->
»fcouÁ
--;

319 
	}
}

324 
	$deüRefCouÁVoid
(*
o
) {

325 
	`deüRefCouÁ
(
o
);

326 
	}
}

340 
robj
 *
	$»£tRefCouÁ
(
robj
 *
obj
) {

341 
obj
->
»fcouÁ
 = 0;

342  
obj
;

343 
	}
}

345 
	$checkTy³
(
»disCl›Á
 *
c
, 
robj
 *
o
, 
ty³
) {

346 ià(
o
->
ty³
 !=ype) {

347 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

351 
	}
}

353 
	$isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
Îv®
) {

354 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

355 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

356 ià(
Îv®
è*Îv® = (è
o
->
±r
;

357  
REDIS_OK
;

359  
	`¡ršg2Î
(
o
->
±r
,
	`sd¦’
(o->±r),
Îv®
è? 
REDIS_OK
 : 
REDIS_ERR
;

361 
	}
}

364 
robj
 *
	$ŒyObjeùEncodšg
(
robj
 *
o
) {

365 
v®ue
;

366 
sds
 
s
 = 
o
->
±r
;

367 
size_t
 
Ën
;

373 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

378 ià(!
	`sdsEncodedObjeù
(
o
))  o;

383 ià(
o
->
»fcouÁ
 > 1)  o;

388 
Ën
 = 
	`sd¦’
(
s
);

389 ià(
Ën
 <ğ21 && 
	`¡ršg2l
(
s
,Ën,&
v®ue
)) {

394 ià((
£rv”
.
maxmemÜy
 == 0 ||

395 (
£rv”
.
maxmemÜy_pŞicy
 !ğ
REDIS_MAXMEMORY_VOLATILE_LRU
 &&

396 
£rv”
.
maxmemÜy_pŞicy
 !ğ
REDIS_MAXMEMORY_ALLKEYS_LRU
)) &&

397 
v®ue
 >= 0 &&

398 
v®ue
 < 
REDIS_SHARED_INTEGERS
)

400 
	`deüRefCouÁ
(
o
);

401 
	`šüRefCouÁ
(
sh¬ed
.
š‹g”s
[
v®ue
]);

402  
sh¬ed
.
š‹g”s
[
v®ue
];

404 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_RAW
è
	`sdsä“
(o->
±r
);

405 
o
->
’codšg
 = 
REDIS_ENCODING_INT
;

406 
o
->
±r
 = (*è
v®ue
;

407  
o
;

415 ià(
Ën
 <ğ
REDIS_ENCODING_EMBSTR_SIZE_LIMIT
) {

416 
robj
 *
emb
;

418 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_EMBSTR
)  o;

419 
emb
 = 
	`ü—‹EmbeddedSŒšgObjeù
(
s
,
	`sd¦’
(s));

420 
	`deüRefCouÁ
(
o
);

421  
emb
;

433 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_RAW
 &&

434 
	`sd§va
(
s
è> 
Ën
/10)

436 
o
->
±r
 = 
	`sdsRemoveF»eS·û
(o->ptr);

440  
o
;

441 
	}
}

445 
robj
 *
	$g‘DecodedObjeù
(
robj
 *
o
) {

446 
robj
 *
dec
;

448 ià(
	`sdsEncodedObjeù
(
o
)) {

449 
	`šüRefCouÁ
(
o
);

450  
o
;

452 ià(
o
->
ty³
 =ğ
REDIS_STRING
 && o->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

453 
buf
[32];

455 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

456 
dec
 = 
	`ü—‹SŒšgObjeù
(
buf
,
	`¡¾’
(buf));

457  
dec
;

459 
	`»disPªic
("Unknownƒncodingype");

461 
	}
}

471 
	#REDIS_COMPARE_BINARY
 (1<<0)

	)

472 
	#REDIS_COMPARE_COLL
 (1<<1)

	)

474 
	$com·»SŒšgObjeùsW™hFÏgs
(
robj
 *
a
,„obj *
b
, 
æags
) {

475 
	`»disAs£¹W™hInfo
(
NULL
,
a
,a->
ty³
 =ğ
REDIS_STRING
 && 
b
->type == REDIS_STRING);

476 
buç
[128], 
bufb
[128], *
a¡r
, *
b¡r
;

477 
size_t
 
®’
, 
bËn
, 
mšËn
;

479 ià(
a
 =ğ
b
)  0;

480 ià(
	`sdsEncodedObjeù
(
a
)) {

481 
a¡r
 = 
a
->
±r
;

482 
®’
 = 
	`sd¦’
(
a¡r
);

484 
®’
 = 
	`Î2¡ršg
(
buç
,(buç),(è
a
->
±r
);

485 
a¡r
 = 
buç
;

487 ià(
	`sdsEncodedObjeù
(
b
)) {

488 
b¡r
 = 
b
->
±r
;

489 
bËn
 = 
	`sd¦’
(
b¡r
);

491 
bËn
 = 
	`Î2¡ršg
(
bufb
,(bufb),(è
b
->
±r
);

492 
b¡r
 = 
bufb
;

494 ià(
æags
 & 
REDIS_COMPARE_COLL
) {

495  
	`¡rcŞl
(
a¡r
,
b¡r
);

497 
cmp
;

499 
mšËn
 = (
®’
 < 
bËn
) ?‡len : blen;

500 
cmp
 = 
	`memcmp
(
a¡r
,
b¡r
,
mšËn
);

501 ià(
cmp
 =ğ0è 
®’
-
bËn
;

502  
cmp
;

504 
	}
}

507 
	$com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

508  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_BINARY
);

509 
	}
}

512 
	$cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

513  
	`com·»SŒšgObjeùsW™hFÏgs
(
a
,
b
,
REDIS_COMPARE_COLL
);

514 
	}
}

520 
	$equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
) {

521 ià(
a
->
’codšg
 =ğ
REDIS_ENCODING_INT
 &&

522 
b
->
’codšg
 =ğ
REDIS_ENCODING_INT
){

525  
a
->
±r
 =ğ
b
->ptr;

527  
	`com·»SŒšgObjeùs
(
a
,
b
) == 0;

529 
	}
}

531 
size_t
 
	$¡ršgObjeùL’
(
robj
 *
o
) {

532 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

533 ià(
	`sdsEncodedObjeù
(
o
)) {

534  
	`sd¦’
(
o
->
±r
);

536 
buf
[32];

538  
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

540 
	}
}

542 
	$g‘DoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

543 
v®ue
;

544 *
•Œ
;

546 ià(
o
 =ğ
NULL
) {

547 
v®ue
 = 0;

549 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

550 ià(
	`sdsEncodedObjeù
(
o
)) {

551 
”ºo
 = 0;

552 
v®ue
 = 
	`¡¹od
(
o
->
±r
, &
•Œ
);

553 ià(
	`is¥aû
(((*)
o
->
±r
)[0]) ||

554 
•Œ
[0] != '\0' ||

555 (
”ºo
 =ğ
ERANGE
 &&

556 (
v®ue
 =ğ
HUGE_VAL
 || value == -HUGE_VAL || value == 0)) ||

557 
”ºo
 =ğ
EINVAL
 ||

558 
	`i¢ª
(
v®ue
))

559  
REDIS_ERR
;

560 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

561 
v®ue
 = ()
o
->
±r
;

563 
	`»disPªic
("Unknown stringƒncoding");

566 *
rg‘
 = 
v®ue
;

567  
REDIS_OK
;

568 
	}
}

570 
	$g‘DoubËFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

571 
v®ue
;

572 ià(
	`g‘DoubËFromObjeù
(
o
, &
v®ue
è!ğ
REDIS_OK
) {

573 ià(
msg
 !ğ
NULL
) {

574 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

576 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

578  
REDIS_ERR
;

580 *
rg‘
 = 
v®ue
;

581  
REDIS_OK
;

582 
	}
}

584 
	$g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
) {

585 
v®ue
;

586 *
•Œ
;

588 ià(
o
 =ğ
NULL
) {

589 
v®ue
 = 0;

591 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

592 ià(
	`sdsEncodedObjeù
(
o
)) {

593 
”ºo
 = 0;

594 
v®ue
 = 
	`¡¹Şd
(
o
->
±r
, &
•Œ
);

595 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

596 
”ºo
 =ğ
ERANGE
 || 
	`i¢ª
(
v®ue
))

597  
REDIS_ERR
;

598 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

599 
v®ue
 = ()
o
->
±r
;

601 
	`»disPªic
("Unknown stringƒncoding");

604 *
rg‘
 = 
v®ue
;

605  
REDIS_OK
;

606 
	}
}

608 
	$g‘LÚgDoubËFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

609 
v®ue
;

610 ià(
	`g‘LÚgDoubËFromObjeù
(
o
, &
v®ue
è!ğ
REDIS_OK
) {

611 ià(
msg
 !ğ
NULL
) {

612 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

614 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡ valid float");

616  
REDIS_ERR
;

618 *
rg‘
 = 
v®ue
;

619  
REDIS_OK
;

620 
	}
}

622 
	$g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
) {

623 
v®ue
;

624 *
•Œ
;

626 ià(
o
 =ğ
NULL
) {

627 
v®ue
 = 0;

629 
	`»disAs£¹W™hInfo
(
NULL
,
o
,o->
ty³
 =ğ
REDIS_STRING
);

630 ià(
	`sdsEncodedObjeù
(
o
)) {

631 
”ºo
 = 0;

632 
v®ue
 = 
	`¡¹Şl
(
o
->
±r
, &
•Œ
, 10);

633 ià(
	`is¥aû
(((*)
o
->
±r
)[0]è|| 
•Œ
[0] != '\0' ||

634 
”ºo
 =ğ
ERANGE
)

635  
REDIS_ERR
;

636 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

637 
v®ue
 = ()
o
->
±r
;

639 
	`»disPªic
("Unknown stringƒncoding");

642 ià(
rg‘
è*rg‘ = 
v®ue
;

643  
REDIS_OK
;

644 
	}
}

646 
	$g‘LÚgLÚgFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

647 
v®ue
;

648 ià(
	`g‘LÚgLÚgFromObjeù
(
o
, &
v®ue
è!ğ
REDIS_OK
) {

649 ià(
msg
 !ğ
NULL
) {

650 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

652 
	`addR•lyE¼Ü
(
c
,"value is‚ot‡n integer or out of„ange");

654  
REDIS_ERR
;

656 *
rg‘
 = 
v®ue
;

657  
REDIS_OK
;

658 
	}
}

660 
	$g‘LÚgFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
) {

661 
v®ue
;

663 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
o
, &
v®ue
, 
msg
è!ğ
REDIS_OK
è 
REDIS_ERR
;

664 ià(
v®ue
 < 
LONG_MIN
 || v®u> 
LONG_MAX
) {

665 ià(
msg
 !ğ
NULL
) {

666 
	`addR•lyE¼Ü
(
c
,(*)
msg
);

668 
	`addR•lyE¼Ü
(
c
,"value is out of„ange");

670  
REDIS_ERR
;

672 *
rg‘
 = 
v®ue
;

673  
REDIS_OK
;

674 
	}
}

676 *
	$¡rEncodšg
(
’codšg
) {

677 
’codšg
) {

678 
REDIS_ENCODING_RAW
:  "raw";

679 
REDIS_ENCODING_INT
:  "int";

680 
REDIS_ENCODING_HT
:  "hashtable";

681 
REDIS_ENCODING_LINKEDLIST
:  "linkedlist";

682 
REDIS_ENCODING_ZIPLIST
:  "ziplist";

683 
REDIS_ENCODING_INTSET
:  "intset";

684 
REDIS_ENCODING_SKIPLIST
:  "skiplist";

685 
REDIS_ENCODING_EMBSTR
:  "embstr";

688 
	}
}

692 
	$e¡im©eObjeùIdËTime
(
robj
 *
o
) {

693 
Ìuşock
 = 
	`LRU_CLOCK
();

694 ià(
Ìuşock
 >ğ
o
->
Ìu
) {

695  (
Ìuşock
 - 
o
->
Ìu
è* 
REDIS_LRU_CLOCK_RESOLUTION
;

697  (
Ìuşock
 + (
REDIS_LRU_CLOCK_MAX
 - 
o
->
Ìu
)) *

698 
REDIS_LRU_CLOCK_RESOLUTION
;

700 
	}
}

704 
robj
 *
	$objeùCommªdLookup
(
»disCl›Á
 *
c
, 
robj
 *
key
) {

705 
diùEÁry
 *
de
;

707 ià((
de
 = 
	`diùFšd
(
c
->
db
->
diù
,
key
->
±r
)è=ğ
NULL
)  NULL;

708  (
robj
*è
	`diùG‘V®
(
de
);

709 
	}
}

711 
robj
 *
	$objeùCommªdLookupOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
key
,„obj *
»¶y
) {

712 
robj
 *
o
 = 
	`objeùCommªdLookup
(
c
,
key
);

714 ià(!
o
è
	`addR•ly
(
c
, 
»¶y
);

715  
o
;

716 
	}
}

720 
	$objeùCommªd
(
»disCl›Á
 *
c
) {

721 
robj
 *
o
;

723 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"»fcouÁ"è&& c->
¬gc
 == 3) {

724 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

725 =ğ
NULL
) ;

726 
	`addR•lyLÚgLÚg
(
c
,
o
->
»fcouÁ
);

727 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"’codšg"è&& c->
¬gc
 == 3) {

728 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

729 =ğ
NULL
) ;

730 
	`addR•lyBulkCSŒšg
(
c
,
	`¡rEncodšg
(
o
->
’codšg
));

731 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"idËtime"è&& c->
¬gc
 == 3) {

732 ià((
o
 = 
	`objeùCommªdLookupOrR•ly
(
c
,c->
¬gv
[2],
sh¬ed
.
nuÎbulk
))

733 =ğ
NULL
) ;

734 
	`addR•lyLÚgLÚg
(
c
,
	`e¡im©eObjeùIdËTime
(
o
)/1000);

736 
	`addR•lyE¼Ü
(
c
,"Syntaxƒrror. Try OBJECT (refcount|encoding|idletime)");

738 
	}
}

	@pqsort.c

40 
	~<sys/ty³s.h
>

42 
	~<”ºo.h
>

43 
	~<¡dlib.h
>

45 
šlše
 *
med3
 (*, *, *,

47 
šlše
 
	`sw­func
 (*, *, 
size_t
, );

49 
	#mš
(
a
, 
b
è×è< (bè?‡ : 
	)
b

54 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) { \

55 
size_t
 
i
 = (
n
è/  (
TYPE
); \

56 
TYPE
 *
pi
 = (TYPE *)(*)(
·rmi
); \

57 
TYPE
 *
pj
 = (TYPE *)(*)(
·rmj
); \

59 
TYPE
 
t
 = *
pi
; \

60 *
pi
++ = *
pj
; \

61 *
pj
++ = 
t
; \

62 } --
i
 > 0); \

63 
	}

	)
}

65 
	#SWAPINIT
(
a
, 
es
è
sw­ty³
 = ((*)a - (*)0) % () || \

66 
es
 % (è? 2 :ƒ =ğ()? 0 : 1;

	)

68 
šlše
 

69 
	$sw­func
(*
a
, *
b
, 
size_t
 
n
, 
sw­ty³
)

72 ià(
sw­ty³
 <= 1)

73 
	`sw­code
(, 
a
, 
b
, 
n
)

75 
	`sw­code
(, 
a
, 
b
, 
n
)

76 
	}
}

78 
	#sw­
(
a
, 
b
) \

79 ià(
sw­ty³
 == 0) { \

80 
t
 = *(*)(*)(
a
); \

81 *(*)(*)(
a
èğ*(*)(*)(
b
); \

82 *(*)(*)(
b
èğ
t
; \

84 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
)

	)

86 
	#vecsw­
(
a
, 
b
, 
n
èià(Òè> 0è
	`sw­func
(×), (b), (
size_t
)Ò), 
sw­ty³
)

	)

88 
šlše
 *

89 
med3
(*
a
, *
b
, *
c
,

90 (*
cmp
) (const *, const *))

93  
	`cmp
(
a
, 
b
) < 0 ?

94 (
	`cmp
(
b
, 
c
è< 0 ? b : (cmp(
a
, c) < 0 ? c :‡ ))

95 :(
	`cmp
(
b
, 
c
è> 0 ? b : (cmp(
a
, c) < 0 ?‡ : c ));

96 
	}
}

99 
_pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

100 (*
cmp
è(cÚ¡ *, cÚ¡ *), *
Ìªge
, *
¼ªge
)

102 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

103 
size_t
 
d
, 
r
;

104 
sw­ty³
, 
cmp_»suÉ
;

106 
loİ
: 
	`SWAPINIT
(
a
, 
es
);

107 ià(
n
 < 7) {

108 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

109 
¶
 = 
pm
;…È> (*è
a
 && 
	`cmp
ÕÈ- 
es
,…l) > 0;

110 
¶
 -ğ
es
)

111 
	`sw­
(
¶
,…È- 
es
);

114 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

115 ià(
n
 > 7) {

116 
¶
 = (*è
a
;

117 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

118 ià(
n
 > 40) {

119 
d
 = (
n
 / 8è* 
es
;

120 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
);

121 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
);

122 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
);

124 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
);

126 
	`sw­
(
a
, 
pm
);

127 
·
 = 
pb
 = (*è
a
 + 
es
;

129 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

131 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õb, 
a
)) <= 0) {

132 ià(
cmp_»suÉ
 == 0) {

133 
	`sw­
(
·
, 
pb
);

134 
·
 +ğ
es
;

136 
pb
 +ğ
es
;

138 
pb
 <ğ
pc
 && (
cmp_»suÉ
 = 
	`cmp
Õc, 
a
)) >= 0) {

139 ià(
cmp_»suÉ
 == 0) {

140 
	`sw­
(
pc
, 
pd
);

141 
pd
 -ğ
es
;

143 
pc
 -ğ
es
;

145 ià(
pb
 > 
pc
)

147 
	`sw­
(
pb
, 
pc
);

148 
pb
 +ğ
es
;

149 
pc
 -ğ
es
;

152 
²
 = (*è
a
 + 
n
 * 
es
;

153 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

154 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

155 
r
 = 
	`mš
((
size_t
)(
pd
 - 
pc
), 
²
 -…d - 
es
);

156 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

157 ià((
r
 = 
pb
 - 
·
è> 
es
) {

158 *
_l
 = 
a
, *
_r
 = ((*ï)+
r
-1;

159 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

160 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

161 
	`_pqsÜt
(
a
, 
r
 / 
es
,ƒs, 
cmp
, 
Ìªge
, 
¼ªge
);

163 ià((
r
 = 
pd
 - 
pc
è> 
es
) {

164 *
_l
, *
_r
;

167 
a
 = 
²
 - 
r
;

168 
n
 = 
r
 / 
es
;

170 
_l
 = 
a
;

171 
_r
 = ((*)
a
)+
r
-1;

172 ià(!((
Ìªge
 < 
_l
 && 
¼ªge
 < _l) ||

173 (
Ìªge
 > 
_r
 && 
¼ªge
 > _r)))

174 
loİ
;

177 
	}
}

180 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

181 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
)

183 
	`_pqsÜt
(
a
,
n
,
es
,
cmp
,((*ï)+(
Ìªge
*es),

184 ((*)
a
)+((
¼ªge
+1)*
es
)-1);

185 
	}
}

	@pqsort.h

33 #iâdeà
__PQSORT_H


34 
	#__PQSORT_H


	)

37 
pqsÜt
(*
a
, 
size_t
 
n
, size_ˆ
es
,

38 (*
cmp
è(cÚ¡ *, cÚ¡ *), 
size_t
 
Ìªge
, size_ˆ
¼ªge
);

	@pubsub.c

30 
	~"»dis.h
"

36 
	$ä“PubsubP©‹º
(*
p
) {

37 
pubsubP©‹º
 *
·t
 = 
p
;

39 
	`deüRefCouÁ
(
·t
->
·‰”n
);

40 
	`zä“
(
·t
);

41 
	}
}

43 
	$li¡M©chPubsubP©‹º
(*
a
, *
b
) {

44 
pubsubP©‹º
 *
·
 = 
a
, *
pb
 = 
b
;

46  (
·
->
ş›Á
 =ğ
pb
->client) &&

47 (
	`equ®SŒšgObjeùs
(
·
->
·‰”n
,
pb
->pattern));

48 
	}
}

51 
	$ş›ÁSubsütiÚsCouÁ
(
»disCl›Á
 *
c
) {

52  
	`diùSize
(
c
->
pubsub_chªÃls
)+

53 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
);

54 
	}
}

58 
	$pubsubSubsüibeChªÃl
(
»disCl›Á
 *
c
, 
robj
 *
chªÃl
) {

59 
diùEÁry
 *
de
;

60 
li¡
 *
ş›Ás
 = 
NULL
;

61 
»tv®
 = 0;

64 ià(
	`diùAdd
(
c
->
pubsub_chªÃls
,
chªÃl
,
NULL
è=ğ
DICT_OK
) {

65 
»tv®
 = 1;

66 
	`šüRefCouÁ
(
chªÃl
);

68 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

69 ià(
de
 =ğ
NULL
) {

70 
ş›Ás
 = 
	`li¡C»©e
();

71 
	`diùAdd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
,
ş›Ás
);

72 
	`šüRefCouÁ
(
chªÃl
);

74 
ş›Ás
 = 
	`diùG‘V®
(
de
);

76 
	`li¡AddNodeTa
(
ş›Ás
,
c
);

79 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

80 
	`addR•ly
(
c
,
sh¬ed
.
subsüibebulk
);

81 
	`addR•lyBulk
(
c
,
chªÃl
);

82 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

83  
»tv®
;

84 
	}
}

88 
	$pubsubUnsubsüibeChªÃl
(
»disCl›Á
 *
c
, 
robj
 *
chªÃl
, 
nÙify
) {

89 
diùEÁry
 *
de
;

90 
li¡
 *
ş›Ás
;

91 
li¡Node
 *
Ê
;

92 
»tv®
 = 0;

95 
	`šüRefCouÁ
(
chªÃl
);

97 ià(
	`diùD–‘e
(
c
->
pubsub_chªÃls
,
chªÃl
è=ğ
DICT_OK
) {

98 
»tv®
 = 1;

100 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

101 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
de
 != NULL);

102 
ş›Ás
 = 
	`diùG‘V®
(
de
);

103 
Ê
 = 
	`li¡S—rchKey
(
ş›Ás
,
c
);

104 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
Ê
 != NULL);

105 
	`li¡D–Node
(
ş›Ás
,
Ê
);

106 ià(
	`li¡L’gth
(
ş›Ás
) == 0) {

110 
	`diùD–‘e
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

114 ià(
nÙify
) {

115 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

116 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

117 
	`addR•lyBulk
(
c
,
chªÃl
);

118 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

119 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

122 
	`deüRefCouÁ
(
chªÃl
);

123  
»tv®
;

124 
	}
}

127 
	$pubsubSubsüibeP©‹º
(
»disCl›Á
 *
c
, 
robj
 *
·‰”n
) {

128 
»tv®
 = 0;

130 ià(
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
è=ğ
NULL
) {

131 
»tv®
 = 1;

132 
pubsubP©‹º
 *
·t
;

133 
	`li¡AddNodeTa
(
c
->
pubsub_·‰”ns
,
·‰”n
);

134 
	`šüRefCouÁ
(
·‰”n
);

135 
·t
 = 
	`zm®loc
((*pat));

136 
·t
->
·‰”n
 = 
	`g‘DecodedObjeù
(pattern);

137 
·t
->
ş›Á
 = 
c
;

138 
	`li¡AddNodeTa
(
£rv”
.
pubsub_·‰”ns
,
·t
);

141 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

142 
	`addR•ly
(
c
,
sh¬ed
.
psubsüibebulk
);

143 
	`addR•lyBulk
(
c
,
·‰”n
);

144 
	`addR•lyLÚgLÚg
(
c
,
	`ş›ÁSubsütiÚsCouÁ
(c));

145  
»tv®
;

146 
	}
}

150 
	$pubsubUnsubsüibeP©‹º
(
»disCl›Á
 *
c
, 
robj
 *
·‰”n
, 
nÙify
) {

151 
li¡Node
 *
Ê
;

152 
pubsubP©‹º
 
·t
;

153 
»tv®
 = 0;

155 
	`šüRefCouÁ
(
·‰”n
);

156 ià((
Ê
 = 
	`li¡S—rchKey
(
c
->
pubsub_·‰”ns
,
·‰”n
)è!ğ
NULL
) {

157 
»tv®
 = 1;

158 
	`li¡D–Node
(
c
->
pubsub_·‰”ns
,
Ê
);

159 
·t
.
ş›Á
 = 
c
;

160 
·t
.
·‰”n
 =…attern;

161 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
pubsub_·‰”ns
,&
·t
);

162 
	`li¡D–Node
(
£rv”
.
pubsub_·‰”ns
,
Ê
);

165 ià(
nÙify
) {

166 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

167 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

168 
	`addR•lyBulk
(
c
,
·‰”n
);

169 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

170 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

172 
	`deüRefCouÁ
(
·‰”n
);

173  
»tv®
;

174 
	}
}

178 
	$pubsubUnsubsüibeAÎChªÃls
(
»disCl›Á
 *
c
, 
nÙify
) {

179 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘SaãI‹¿tÜ
(
c
->
pubsub_chªÃls
);

180 
diùEÁry
 *
de
;

181 
couÁ
 = 0;

183 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

184 
robj
 *
chªÃl
 = 
	`diùG‘Key
(
de
);

186 
couÁ
 +ğ
	`pubsubUnsubsüibeChªÃl
(
c
,
chªÃl
,
nÙify
);

189 ià(
nÙify
 && 
couÁ
 == 0) {

190 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

191 
	`addR•ly
(
c
,
sh¬ed
.
unsubsüibebulk
);

192 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

193 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

194 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

196 
	`diùR–—£I‹¿tÜ
(
di
);

197  
couÁ
;

198 
	}
}

202 
	$pubsubUnsubsüibeAÎP©‹ºs
(
»disCl›Á
 *
c
, 
nÙify
) {

203 
li¡Node
 *
Ê
;

204 
li¡I‹r
 
li
;

205 
couÁ
 = 0;

207 
	`li¡Rewšd
(
c
->
pubsub_·‰”ns
,&
li
);

208 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

209 
robj
 *
·‰”n
 = 
Ê
->
v®ue
;

211 
couÁ
 +ğ
	`pubsubUnsubsüibeP©‹º
(
c
,
·‰”n
,
nÙify
);

213 ià(
nÙify
 && 
couÁ
 == 0) {

215 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

216 
	`addR•ly
(
c
,
sh¬ed
.
punsubsüibebulk
);

217 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

218 
	`addR•lyLÚgLÚg
(
c
,
	`diùSize
(c->
pubsub_chªÃls
)+

219 
	`li¡L’gth
(
c
->
pubsub_·‰”ns
));

221  
couÁ
;

222 
	}
}

225 
	$pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
) {

226 
»ûiv”s
 = 0;

227 
diùEÁry
 *
de
;

228 
li¡Node
 *
Ê
;

229 
li¡I‹r
 
li
;

232 
de
 = 
	`diùFšd
(
£rv”
.
pubsub_chªÃls
,
chªÃl
);

233 ià(
de
) {

234 
li¡
 *li¡ = 
	`diùG‘V®
(
de
);

235 
li¡Node
 *
Ê
;

236 
li¡I‹r
 
li
;

238 
	`li¡Rewšd
(
li¡
,&
li
);

239 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

240 
»disCl›Á
 *
c
 = 
Ê
->
v®ue
;

242 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[3]);

243 
	`addR•ly
(
c
,
sh¬ed
.
mes§gebulk
);

244 
	`addR•lyBulk
(
c
,
chªÃl
);

245 
	`addR•lyBulk
(
c
,
mes§ge
);

246 
»ûiv”s
++;

250 ià(
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
)) {

251 
	`li¡Rewšd
(
£rv”
.
pubsub_·‰”ns
,&
li
);

252 
chªÃl
 = 
	`g‘DecodedObjeù
(channel);

253 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

254 
pubsubP©‹º
 *
·t
 = 
Ê
->
v®ue
;

256 ià(
	`¡ršgm©chËn
((*)
·t
->
·‰”n
->
±r
,

257 
	`sd¦’
(
·t
->
·‰”n
->
±r
),

258 (*)
chªÃl
->
±r
,

259 
	`sd¦’
(
chªÃl
->
±r
),0)) {

260 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
mbulkhdr
[4]);

261 
	`addR•ly
(
·t
->
ş›Á
,
sh¬ed
.
pmes§gebulk
);

262 
	`addR•lyBulk
(
·t
->
ş›Á
,·t->
·‰”n
);

263 
	`addR•lyBulk
(
·t
->
ş›Á
,
chªÃl
);

264 
	`addR•lyBulk
(
·t
->
ş›Á
,
mes§ge
);

265 
»ûiv”s
++;

268 
	`deüRefCouÁ
(
chªÃl
);

270  
»ûiv”s
;

271 
	}
}

277 
	$subsüibeCommªd
(
»disCl›Á
 *
c
) {

278 
j
;

280 
j
 = 1; j < 
c
->
¬gc
; j++)

281 
	`pubsubSubsüibeChªÃl
(
c
,c->
¬gv
[
j
]);

282 
c
->
æags
 |ğ
REDIS_PUBSUB
;

283 
	}
}

285 
	$unsubsüibeCommªd
(
»disCl›Á
 *
c
) {

286 ià(
c
->
¬gc
 == 1) {

287 
	`pubsubUnsubsüibeAÎChªÃls
(
c
,1);

289 
j
;

291 
j
 = 1; j < 
c
->
¬gc
; j++)

292 
	`pubsubUnsubsüibeChªÃl
(
c
,c->
¬gv
[
j
],1);

294 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
REDIS_PUBSUB
;

295 
	}
}

297 
	$psubsüibeCommªd
(
»disCl›Á
 *
c
) {

298 
j
;

300 
j
 = 1; j < 
c
->
¬gc
; j++)

301 
	`pubsubSubsüibeP©‹º
(
c
,c->
¬gv
[
j
]);

302 
c
->
æags
 |ğ
REDIS_PUBSUB
;

303 
	}
}

305 
	$punsubsüibeCommªd
(
»disCl›Á
 *
c
) {

306 ià(
c
->
¬gc
 == 1) {

307 
	`pubsubUnsubsüibeAÎP©‹ºs
(
c
,1);

309 
j
;

311 
j
 = 1; j < 
c
->
¬gc
; j++)

312 
	`pubsubUnsubsüibeP©‹º
(
c
,c->
¬gv
[
j
],1);

314 ià(
	`ş›ÁSubsütiÚsCouÁ
(
c
è=ğ0èc->
æags
 &ğ~
REDIS_PUBSUB
;

315 
	}
}

317 
	$publishCommªd
(
»disCl›Á
 *
c
) {

318 
»ûiv”s
 = 
	`pubsubPublishMes§ge
(
c
->
¬gv
[1],c->argv[2]);

319 ià(
£rv”
.
şu¡”_’abËd
)

320 
	`şu¡”Prİag©ePublish
(
c
->
¬gv
[1],c->argv[2]);

322 
	`fÜûCommªdPrİag©iÚ
(
c
,
REDIS_PROPAGATE_REPL
);

323 
	`addR•lyLÚgLÚg
(
c
,
»ûiv”s
);

324 
	}
}

327 
	$pubsubCommªd
(
»disCl›Á
 *
c
) {

328 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"channels") &&

329 (
c
->
¬gc
 == 2 || c->argc ==3))

332 
sds
 
·t
 = (
c
->
¬gc
 =ğ2è? 
NULL
 : c->
¬gv
[2]->
±r
;

333 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
pubsub_chªÃls
);

334 
diùEÁry
 *
de
;

335 
mbËn
 = 0;

336 *
»¶yËn
;

338 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

339 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

340 
robj
 *
cobj
 = 
	`diùG‘Key
(
de
);

341 
sds
 
chªÃl
 = 
cobj
->
±r
;

343 ià(!
·t
 || 
	`¡ršgm©chËn
Õ©, 
	`sd¦’
(pat),

344 
chªÃl
, 
	`sd¦’
(channel),0))

346 
	`addR•lyBulk
(
c
,
cobj
);

347 
mbËn
++;

350 
	`diùR–—£I‹¿tÜ
(
di
);

351 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbËn
);

352 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"numsub"è&& c->
¬gc
 >= 2) {

354 
j
;

356 
	`addR•lyMuÉiBulkL’
(
c
,(c->
¬gc
-2)*2);

357 
j
 = 2; j < 
c
->
¬gc
; j++) {

358 
li¡
 *
l
 = 
	`diùF‘chV®ue
(
£rv”
.
pubsub_chªÃls
,
c
->
¬gv
[
j
]);

360 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

361 
	`addR•lyLÚgLÚg
(
c
,
l
 ? 
	`li¡L’gth
(l) : 0);

363 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"num·t"è&& c->
¬gc
 == 2) {

365 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
));

367 
	`addR•lyE¼ÜFÜm©
(
c
,

369 (*)
c
->
¬gv
[1]->
±r
);

371 
	}
}

	@rand.c

44 
	~<¡dšt.h
>

46 
	#N
 16

	)

47 
	#MASK
 ((1 << (
N
 - 1)è+ (1 << (N - 1)è- 1)

	)

48 
	#LOW
(
x
è(()(xè& 
MASK
)

	)

49 
	#HIGH
(
x
è
	`LOW
((xè>> 
N
)

	)

50 
	#MUL
(
x
, 
y
, 
z
è{ 
št32_t
 
l
 = ()(x) * ()(y); \

51 (
z
)[0] = 
	`LOW
(
l
); (z)[1] = 
	`HIGH
Ö); }

	)

52 
	#CARRY
(
x
, 
y
è((
št32_t
)(xè+ ()(yè> 
MASK
)

	)

53 
	#ADDEQU
(
x
, 
y
, 
z
è(z = 
	`CARRY
(x, (y)), x = 
	`LOW
(x + (y)))

	)

54 
	#X0
 0x330E

	)

55 
	#X1
 0xABCD

	)

56 
	#X2
 0x1234

	)

57 
	#A0
 0xE66D

	)

58 
	#A1
 0xDEEC

	)

59 
	#A2
 0x5

	)

60 
	#C
 0xB

	)

61 
	#SET3
(
x
, 
x0
, 
x1
, 
x2
è((x)[0] = (x0), (x)[1] = (x1), (x)[2] = (x2))

	)

62 
	#SETLOW
(
x
, 
y
, 
n
è
	`SET3
(x, 
	`LOW
((y)[n]), LOW((y)[Ò)+1]), LOW((y)[Ò)+2]))

	)

63 
	#SEED
(
x0
, 
x1
, 
x2
è(
	`SET3
(
x
, x0, x1, x2), SET3(
a
, 
A0
, 
A1
, 
A2
), 
c
 = 
C
)

	)

64 
	#REST
(
v
è
i
 = 0; i < 3; i++è{ 
xsubi
[i] = 
x
[i]; x[i] = 
‹mp
[i]; } \

65  (
v
);

	)

66 
	#HI_BIT
 (1L << (2 * 
N
 - 1))

	)

68 
ušt32_t
 
	gx
[3] = { 
X0
, 
X1
, 
X2
 }, 
	ga
[3] = { 
A0
, 
A1
, 
A2
 }, 
	gc
 = 
C
;

69 
Ãxt
();

71 
št32_t
 
	$»disL¿nd48
() {

72 
	`Ãxt
();

73  (((
št32_t
)
x
[2] << (
N
 - 1)) + (x[1] >> 1));

74 
	}
}

76 
	$»disS¿nd48
(
št32_t
 
£edv®
) {

77 
	`SEED
(
X0
, 
	`LOW
(
£edv®
), 
	`HIGH
(seedval));

78 
	}
}

80 
	$Ãxt
() {

81 
ušt32_t
 
p
[2], 
q
[2], 
r
[2], 
ÿ¼y0
, 
ÿ¼y1
;

83 
	`MUL
(
a
[0], 
x
[0], 
p
);

84 
	`ADDEQU
(
p
[0], 
c
, 
ÿ¼y0
);

85 
	`ADDEQU
(
p
[1], 
ÿ¼y0
, 
ÿ¼y1
);

86 
	`MUL
(
a
[0], 
x
[1], 
q
);

87 
	`ADDEQU
(
p
[1], 
q
[0], 
ÿ¼y0
);

88 
	`MUL
(
a
[1], 
x
[0], 
r
);

89 
x
[2] = 
	`LOW
(
ÿ¼y0
 + 
ÿ¼y1
 + 
	`CARRY
(
p
[1], 
r
[0]è+ 
q
[1] +„[1] +

90 
a
[0] * 
x
[2] +‡[1] * x[1] +‡[2] * x[0]);

91 
x
[1] = 
	`LOW
(
p
[1] + 
r
[0]);

92 
x
[0] = 
	`LOW
(
p
[0]);

93 
	}
}

	@rand.h

30 #iâdeà
REDIS_RANDOM_H


31 
	#REDIS_RANDOM_H


	)

33 
št32_t
 
»disL¿nd48
();

34 
»disS¿nd48
(
št32_t
 
£edv®
);

36 
	#REDIS_LRAND48_MAX
 
INT32_MAX


	)

	@rdb.c

30 
	~"»dis.h
"

31 
	~"lzf.h
"

32 
	~"zm­.h
"

33 
	~"’dŸncÚv.h
"

35 
	~<m©h.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/time.h
>

38 
	~<sys/»sourû.h
>

39 
	~<sys/wa™.h
>

40 
	~<¬·/š‘.h
>

41 
	~<sys/¡©.h
>

43 
	$rdbWr™eRaw
(
rio
 *
rdb
, *
p
, 
size_t
 
Ën
) {

44 ià(
rdb
 && 
	`rioWr™e
Ôdb,
p
,
Ën
) == 0)

46  
Ën
;

47 
	}
}

49 
	$rdbSaveTy³
(
rio
 *
rdb
, 
ty³
) {

50  
	`rdbWr™eRaw
(
rdb
,&
ty³
,1);

51 
	}
}

56 
	$rdbLßdTy³
(
rio
 *
rdb
) {

57 
ty³
;

58 ià(
	`rioR—d
(
rdb
,&
ty³
,1) == 0)  -1;

59  
ty³
;

60 
	}
}

62 
time_t
 
	$rdbLßdTime
(
rio
 *
rdb
) {

63 
št32_t
 
t32
;

64 ià(
	`rioR—d
(
rdb
,&
t32
,4) == 0)  -1;

65  (
time_t
)
t32
;

66 
	}
}

68 
	$rdbSaveMli£cÚdTime
(
rio
 *
rdb
, 
t
) {

69 
št64_t
 
t64
 = (št64_tè
t
;

70  
	`rdbWr™eRaw
(
rdb
,&
t64
,8);

71 
	}
}

73 
	$rdbLßdMli£cÚdTime
(
rio
 *
rdb
) {

74 
št64_t
 
t64
;

75 ià(
	`rioR—d
(
rdb
,&
t64
,8) == 0)  -1;

76  ()
t64
;

77 
	}
}

82 
	$rdbSaveL’
(
rio
 *
rdb
, 
ušt32_t
 
Ën
) {

83 
buf
[2];

84 
size_t
 
nwr™‹n
;

86 ià(
Ën
 < (1<<6)) {

88 
buf
[0] = (
Ën
&0xFF)|(
REDIS_RDB_6BITLEN
<<6);

89 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

90 
nwr™‹n
 = 1;

91 } ià(
Ën
 < (1<<14)) {

93 
buf
[0] = ((
Ën
>>8)&0xFF)|(
REDIS_RDB_14BITLEN
<<6);

94 
buf
[1] = 
Ën
&0xFF;

95 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,2) == -1)  -1;

96 
nwr™‹n
 = 2;

99 
buf
[0] = (
REDIS_RDB_32BITLEN
<<6);

100 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,1) == -1)  -1;

101 
Ën
 = 
	`htÚl
(len);

102 ià(
	`rdbWr™eRaw
(
rdb
,&
Ën
,4) == -1)  -1;

103 
nwr™‹n
 = 1+4;

105  
nwr™‹n
;

106 
	}
}

111 
ušt32_t
 
	$rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
) {

112 
buf
[2];

113 
ušt32_t
 
Ën
;

114 
ty³
;

116 ià(
i£ncoded
) *isencoded = 0;

117 ià(
	`rioR—d
(
rdb
,
buf
,1è=ğ0è 
REDIS_RDB_LENERR
;

118 
ty³
 = (
buf
[0]&0xC0)>>6;

119 ià(
ty³
 =ğ
REDIS_RDB_ENCVAL
) {

121 ià(
i£ncoded
) *isencoded = 1;

122  
buf
[0]&0x3F;

123 } ià(
ty³
 =ğ
REDIS_RDB_6BITLEN
) {

125  
buf
[0]&0x3F;

126 } ià(
ty³
 =ğ
REDIS_RDB_14BITLEN
) {

128 ià(
	`rioR—d
(
rdb
,
buf
+1,1è=ğ0è 
REDIS_RDB_LENERR
;

129  ((
buf
[0]&0x3F)<<8)|buf[1];

132 ià(
	`rioR—d
(
rdb
,&
Ën
,4è=ğ0è 
REDIS_RDB_LENERR
;

133  
	`Áohl
(
Ën
);

135 
	}
}

141 
	$rdbEncodeIÁeg”
(
v®ue
, *
’c
) {

142 ià(
v®ue
 >= -(1<<7) && value <= (1<<7)-1) {

143 
’c
[0] = (
REDIS_RDB_ENCVAL
<<6)|
REDIS_RDB_ENC_INT8
;

144 
’c
[1] = 
v®ue
&0xFF;

146 } ià(
v®ue
 >= -(1<<15) && value <= (1<<15)-1) {

147 
’c
[0] = (
REDIS_RDB_ENCVAL
<<6)|
REDIS_RDB_ENC_INT16
;

148 
’c
[1] = 
v®ue
&0xFF;

149 
’c
[2] = (
v®ue
>>8)&0xFF;

151 } ià(
v®ue
 >= -(()1<<31) && value <= (()1<<31)-1) {

152 
’c
[0] = (
REDIS_RDB_ENCVAL
<<6)|
REDIS_RDB_ENC_INT32
;

153 
’c
[1] = 
v®ue
&0xFF;

154 
’c
[2] = (
v®ue
>>8)&0xFF;

155 
’c
[3] = (
v®ue
>>16)&0xFF;

156 
’c
[4] = (
v®ue
>>24)&0xFF;

161 
	}
}

166 
robj
 *
	$rdbLßdIÁeg”Objeù
(
rio
 *
rdb
, 
’ùy³
, 
’code
) {

167 
’c
[4];

168 
v®
;

170 ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT8
) {

171 ià(
	`rioR—d
(
rdb
,
’c
,1è=ğ0è 
NULL
;

172 
v®
 = (sigÃd )
’c
[0];

173 } ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT16
) {

174 
ušt16_t
 
v
;

175 ià(
	`rioR—d
(
rdb
,
’c
,2è=ğ0è 
NULL
;

176 
v
 = 
’c
[0]|(enc[1]<<8);

177 
v®
 = (
št16_t
)
v
;

178 } ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT32
) {

179 
ušt32_t
 
v
;

180 ià(
	`rioR—d
(
rdb
,
’c
,4è=ğ0è 
NULL
;

181 
v
 = 
’c
[0]|(enc[1]<<8)|(enc[2]<<16)|(enc[3]<<24);

182 
v®
 = (
št32_t
)
v
;

184 
v®
 = 0;

185 
	`»disPªic
("Unknown RDB integerƒncodingype");

187 ià(
’code
)

188  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®
);

190  
	`ü—‹Objeù
(
REDIS_STRING
,
	`sdsäomlÚglÚg
(
v®
));

191 
	}
}

196 
	$rdbTryIÁeg”Encodšg
(*
s
, 
size_t
 
Ën
, *
’c
) {

197 
v®ue
;

198 *
’d±r
, 
buf
[32];

201 
v®ue
 = 
	`¡¹Şl
(
s
, &
’d±r
, 10);

202 ià(
’d±r
[0] != '\0')  0;

203 
	`Î2¡ršg
(
buf
,32,
v®ue
);

207 ià(
	`¡¾’
(
buf
è!ğ
Ën
 || 
	`memcmp
(buf,
s
,len))  0;

209  
	`rdbEncodeIÁeg”
(
v®ue
,
’c
);

210 
	}
}

212 
	$rdbSaveLzfSŒšgObjeù
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

213 
size_t
 
com´Ën
, 
ou’
;

214 
by‹
;

215 
n
, 
nwr™‹n
 = 0;

216 *
out
;

219 ià(
Ën
 <= 4)  0;

220 
ou’
 = 
Ën
-4;

221 ià((
out
 = 
	`zm®loc
(
ou’
+1)è=ğ
NULL
)  0;

222 
com´Ën
 = 
	`lzf_com´ess
(
s
, 
Ën
, 
out
, 
ou’
);

223 ià(
com´Ën
 == 0) {

224 
	`zä“
(
out
);

228 
by‹
 = (
REDIS_RDB_ENCVAL
<<6)|
REDIS_RDB_ENC_LZF
;

229 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,&
by‹
,1)è=ğ-1è
wr™“¼
;

230 
nwr™‹n
 +ğ
n
;

232 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
com´Ën
)è=ğ-1è
wr™“¼
;

233 
nwr™‹n
 +ğ
n
;

235 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Ën
)è=ğ-1è
wr™“¼
;

236 
nwr™‹n
 +ğ
n
;

238 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
out
,
com´Ën
)è=ğ-1è
wr™“¼
;

239 
nwr™‹n
 +ğ
n
;

241 
	`zä“
(
out
);

242  
nwr™‹n
;

244 
wr™“¼
:

245 
	`zä“
(
out
);

247 
	}
}

249 
robj
 *
	$rdbLßdLzfSŒšgObjeù
(
rio
 *
rdb
) {

250 
Ën
, 
ş’
;

251 *
c
 = 
NULL
;

252 
sds
 
v®
 = 
NULL
;

254 ià((
ş’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

255 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

256 ià((
c
 = 
	`zm®loc
(
ş’
)è=ğ
NULL
è
”r
;

257 ià((
v®
 = 
	`sd¢ewËn
(
NULL
,
Ën
)è=ğNULLè
”r
;

258 ià(
	`rioR—d
(
rdb
,
c
,
ş’
è=ğ0è
”r
;

259 ià(
	`lzf_decom´ess
(
c
,
ş’
,
v®
,
Ën
è=ğ0è
”r
;

260 
	`zä“
(
c
);

261  
	`ü—‹Objeù
(
REDIS_STRING
,
v®
);

262 
”r
:

263 
	`zä“
(
c
);

264 
	`sdsä“
(
v®
);

265  
NULL
;

266 
	}
}

270 
	$rdbSaveRawSŒšg
(
rio
 *
rdb
, *
s
, 
size_t
 
Ën
) {

271 
’ş’
;

272 
n
, 
nwr™‹n
 = 0;

275 ià(
Ën
 <= 11) {

276 
buf
[5];

277 ià((
’ş’
 = 
	`rdbTryIÁeg”Encodšg
((*)
s
,
Ën
,
buf
)) > 0) {

278 ià(
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
) == -1)  -1;

279  
’ş’
;

285 ià(
£rv”
.
rdb_com´essiÚ
 && 
Ën
 > 20) {

286 
n
 = 
	`rdbSaveLzfSŒšgObjeù
(
rdb
,
s
,
Ën
);

287 ià(
n
 == -1)  -1;

288 ià(
n
 > 0) ‚;

293 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
Ën
)) == -1)  -1;

294 
nwr™‹n
 +ğ
n
;

295 ià(
Ën
 > 0) {

296 ià(
	`rdbWr™eRaw
(
rdb
,
s
,
Ën
) == -1)  -1;

297 
nwr™‹n
 +ğ
Ën
;

299  
nwr™‹n
;

300 
	}
}

303 
	$rdbSaveLÚgLÚgAsSŒšgObjeù
(
rio
 *
rdb
, 
v®ue
) {

304 
buf
[32];

305 
n
, 
nwr™‹n
 = 0;

306 
’ş’
 = 
	`rdbEncodeIÁeg”
(
v®ue
,
buf
);

307 ià(
’ş’
 > 0) {

308  
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
);

311 
’ş’
 = 
	`Î2¡ršg
((*)
buf
,32,
v®ue
);

312 
	`»disAs£¹
(
’ş’
 < 32);

313 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
’ş’
)) == -1)  -1;

314 
nwr™‹n
 +ğ
n
;

315 ià((
n
 = 
	`rdbWr™eRaw
(
rdb
,
buf
,
’ş’
)) == -1)  -1;

316 
nwr™‹n
 +ğ
n
;

318  
nwr™‹n
;

319 
	}
}

322 
	$rdbSaveSŒšgObjeù
(
rio
 *
rdb
, 
robj
 *
obj
) {

325 ià(
obj
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

326  
	`rdbSaveLÚgLÚgAsSŒšgObjeù
(
rdb
,()
obj
->
±r
);

328 
	`»disAs£¹W™hInfo
(
NULL
,
obj
,
	`sdsEncodedObjeù
(obj));

329  
	`rdbSaveRawSŒšg
(
rdb
,
obj
->
±r
,
	`sd¦’
(obj->ptr));

331 
	}
}

333 
robj
 *
	$rdbG’”icLßdSŒšgObjeù
(
rio
 *
rdb
, 
’code
) {

334 
i£ncoded
;

335 
ušt32_t
 
Ën
;

336 
robj
 *
o
;

338 
Ën
 = 
	`rdbLßdL’
(
rdb
,&
i£ncoded
);

339 ià(
i£ncoded
) {

340 
Ën
) {

341 
REDIS_RDB_ENC_INT8
:

342 
REDIS_RDB_ENC_INT16
:

343 
REDIS_RDB_ENC_INT32
:

344  
	`rdbLßdIÁeg”Objeù
(
rdb
,
Ën
,
’code
);

345 
REDIS_RDB_ENC_LZF
:

346  
	`rdbLßdLzfSŒšgObjeù
(
rdb
);

348 
	`»disPªic
("Unknown RDBƒncodingype");

352 ià(
Ën
 =ğ
REDIS_RDB_LENERR
è 
NULL
;

353 
o
 = 
’code
 ? 
	`ü—‹SŒšgObjeù
(
NULL
,
Ën
) :

354 
	`ü—‹RawSŒšgObjeù
(
NULL
,
Ën
);

355 ià(
Ën
 && 
	`rioR—d
(
rdb
,
o
->
±r
,len) == 0) {

356 
	`deüRefCouÁ
(
o
);

357  
NULL
;

359  
o
;

360 
	}
}

362 
robj
 *
	$rdbLßdSŒšgObjeù
(
rio
 *
rdb
) {

363  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,0);

364 
	}
}

366 
robj
 *
	$rdbLßdEncodedSŒšgObjeù
(
rio
 *
rdb
) {

367  
	`rdbG’”icLßdSŒšgObjeù
(
rdb
,1);

368 
	}
}

378 
	$rdbSaveDoubËV®ue
(
rio
 *
rdb
, 
v®
) {

379 
buf
[128];

380 
Ën
;

382 ià(
	`i¢ª
(
v®
)) {

383 
buf
[0] = 253;

384 
Ën
 = 1;

385 } ià(!
	`isfš™e
(
v®
)) {

386 
Ën
 = 1;

387 
buf
[0] = (
v®
 < 0) ? 255 : 254;

389 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

399 
mš
 = -4503599627370495;

400 
max
 = 4503599627370496;

401 ià(
v®
 > 
mš
 && v® < 
max
 && val == (()(()val)))

402 
	`Î2¡ršg
((*)
buf
+1,(buf)-1,()
v®
);

405 
	`¢´štf
((*)
buf
+1,(buf)-1,"%.17g",
v®
);

406 
buf
[0] = 
	`¡¾’
((*)buf+1);

407 
Ën
 = 
buf
[0]+1;

409  
	`rdbWr™eRaw
(
rdb
,
buf
,
Ën
);

410 
	}
}

413 
	$rdbLßdDoubËV®ue
(
rio
 *
rdb
, *
v®
) {

414 
buf
[256];

415 
Ën
;

417 ià(
	`rioR—d
(
rdb
,&
Ën
,1) == 0)  -1;

418 
Ën
) {

419 255: *
v®
 = 
R_NegInf
;  0;

420 254: *
v®
 = 
R_PosInf
;  0;

421 253: *
v®
 = 
R_Nª
;  0;

423 ià(
	`rioR—d
(
rdb
,
buf
,
Ën
) == 0)  -1;

424 
buf
[
Ën
] = '\0';

425 
	`ssÿnf
(
buf
, "%lg", 
v®
);

428 
	}
}

431 
	$rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
) {

432 
o
->
ty³
) {

433 
REDIS_STRING
:

434  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_STRING
);

435 
REDIS_LIST
:

436 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
)

437  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_LIST_ZIPLIST
);

438 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
)

439  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_LIST
);

441 
	`»disPªic
("Unknown†istƒncoding");

442 
REDIS_SET
:

443 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
)

444  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_SET_INTSET
);

445 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
)

446  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_SET
);

448 
	`»disPªic
("Unknown setƒncoding");

449 
REDIS_ZSET
:

450 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
)

451  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_ZSET_ZIPLIST
);

452 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
)

453  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_ZSET
);

455 
	`»disPªic
("Unknown sorted setƒncoding");

456 
REDIS_HASH
:

457 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
)

458  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_HASH_ZIPLIST
);

459 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
)

460  
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_TYPE_HASH
);

462 
	`»disPªic
("Unknown hashƒncoding");

464 
	`»disPªic
("Unknown objectype");

467 
	}
}

471 
	$rdbLßdObjeùTy³
(
rio
 *
rdb
) {

472 
ty³
;

473 ià((
ty³
 = 
	`rdbLßdTy³
(
rdb
)) == -1)  -1;

474 ià(!
	`rdbIsObjeùTy³
(
ty³
))  -1;

475  
ty³
;

476 
	}
}

479 
	$rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
) {

480 
n
, 
nwr™‹n
 = 0;

482 ià(
o
->
ty³
 =ğ
REDIS_STRING
) {

484 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
o
)) == -1)  -1;

485 
nwr™‹n
 +ğ
n
;

486 } ià(
o
->
ty³
 =ğ
REDIS_LIST
) {

488 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

489 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

491 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

492 
nwr™‹n
 +ğ
n
;

493 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

494 
li¡
 *li¡ = 
o
->
±r
;

495 
li¡I‹r
 
li
;

496 
li¡Node
 *
Ê
;

498 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`li¡L’gth
(
li¡
))) == -1)  -1;

499 
nwr™‹n
 +ğ
n
;

501 
	`li¡Rewšd
(
li¡
,&
li
);

502 (
Ê
 = 
	`li¡Next
(&
li
))) {

503 
robj
 *
–eobj
 = 
	`li¡NodeV®ue
(
Ê
);

504 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
–eobj
)) == -1)  -1;

505 
nwr™‹n
 +ğ
n
;

508 
	`»disPªic
("Unknown†istƒncoding");

510 } ià(
o
->
ty³
 =ğ
REDIS_SET
) {

512 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

513 
diù
 *
£t
 = 
o
->
±r
;

514 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

515 
diùEÁry
 *
de
;

517 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
£t
))) == -1)  -1;

518 
nwr™‹n
 +ğ
n
;

520 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

521 
robj
 *
–eobj
 = 
	`diùG‘Key
(
de
);

522 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
–eobj
)) == -1)  -1;

523 
nwr™‹n
 +ğ
n
;

525 
	`diùR–—£I‹¿tÜ
(
di
);

526 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

527 
size_t
 
l
 = 
	`št£tBlobL’
((
št£t
*)
o
->
±r
);

529 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

530 
nwr™‹n
 +ğ
n
;

532 
	`»disPªic
("Unknown setƒncoding");

534 } ià(
o
->
ty³
 =ğ
REDIS_ZSET
) {

536 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

537 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

539 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

540 
nwr™‹n
 +ğ
n
;

541 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

542 
z£t
 *
zs
 = 
o
->
±r
;

543 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
zs
->
diù
);

544 
diùEÁry
 *
de
;

546 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
(
zs
->
diù
))) == -1)  -1;

547 
nwr™‹n
 +ğ
n
;

549 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

550 
robj
 *
–eobj
 = 
	`diùG‘Key
(
de
);

551 *
scÜe
 = 
	`diùG‘V®
(
de
);

553 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
–eobj
)) == -1)  -1;

554 
nwr™‹n
 +ğ
n
;

555 ià((
n
 = 
	`rdbSaveDoubËV®ue
(
rdb
,*
scÜe
)) == -1)  -1;

556 
nwr™‹n
 +ğ
n
;

558 
	`diùR–—£I‹¿tÜ
(
di
);

560 
	`»disPªic
("Unknown sorted setƒncoding");

562 } ià(
o
->
ty³
 =ğ
REDIS_HASH
) {

564 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

565 
size_t
 
l
 = 
	`zli¡BlobL’
((*)
o
->
±r
);

567 ià((
n
 = 
	`rdbSaveRawSŒšg
(
rdb
,
o
->
±r
,
l
)) == -1)  -1;

568 
nwr™‹n
 +ğ
n
;

570 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

571 
diùI‹¿tÜ
 *
di
 = 
	`diùG‘I‹¿tÜ
(
o
->
±r
);

572 
diùEÁry
 *
de
;

574 ià((
n
 = 
	`rdbSaveL’
(
rdb
,
	`diùSize
((
diù
*)
o
->
±r
))) == -1)  -1;

575 
nwr™‹n
 +ğ
n
;

577 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

578 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

579 
robj
 *
v®
 = 
	`diùG‘V®
(
de
);

581 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
key
)) == -1)  -1;

582 
nwr™‹n
 +ğ
n
;

583 ià((
n
 = 
	`rdbSaveSŒšgObjeù
(
rdb
,
v®
)) == -1)  -1;

584 
nwr™‹n
 +ğ
n
;

586 
	`diùR–—£I‹¿tÜ
(
di
);

589 
	`»disPªic
("Unknown hashƒncoding");

593 
	`»disPªic
("Unknown objectype");

595  
nwr™‹n
;

596 
	}
}

602 
off_t
 
	$rdbSavedObjeùL’
(
robj
 *
o
) {

603 
Ën
 = 
	`rdbSaveObjeù
(
NULL
,
o
);

604 
	`»disAs£¹W™hInfo
(
NULL
,
o
,
Ën
 != -1);

605  
Ën
;

606 
	}
}

612 
	$rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
,

613 
expœ‘ime
, 
now
)

616 ià(
expœ‘ime
 != -1) {

618 ià(
expœ‘ime
 < 
now
)  0;

619 ià(
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_OPCODE_EXPIRETIME_MS
) == -1)  -1;

620 ià(
	`rdbSaveMli£cÚdTime
(
rdb
,
expœ‘ime
) == -1)  -1;

624 ià(
	`rdbSaveObjeùTy³
(
rdb
,
v®
) == -1)  -1;

625 ià(
	`rdbSaveSŒšgObjeù
(
rdb
,
key
) == -1)  -1;

626 ià(
	`rdbSaveObjeù
(
rdb
,
v®
) == -1)  -1;

628 
	}
}

638 
	$rdbSaveRio
(
rio
 *
rdb
, *
”rÜ
) {

639 
diùI‹¿tÜ
 *
di
 = 
NULL
;

640 
diùEÁry
 *
de
;

641 
magic
[10];

642 
j
;

643 
now
 = 
	`m¡ime
();

644 
ušt64_t
 
cksum
;

646 ià(
£rv”
.
rdb_checksum
)

647 
rdb
->
upd©e_cksum
 = 
rioG’”icUpd©eChecksum
;

648 
	`¢´štf
(
magic
,(magic),"REDIS%04d",
REDIS_RDB_VERSION
);

649 ià(
	`rdbWr™eRaw
(
rdb
,
magic
,9è=ğ-1è
w”r
;

651 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

652 
»disDb
 *
db
 = 
£rv”
.db+
j
;

653 
diù
 *
d
 = 
db
->dict;

654 ià(
	`diùSize
(
d
) == 0) ;

655 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
d
);

656 ià(!
di
è 
REDIS_ERR
;

659 ià(
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_OPCODE_SELECTDB
è=ğ-1è
w”r
;

660 ià(
	`rdbSaveL’
(
rdb
,
j
è=ğ-1è
w”r
;

663 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

664 
sds
 
key¡r
 = 
	`diùG‘Key
(
de
);

665 
robj
 
key
, *
o
 = 
	`diùG‘V®
(
de
);

666 
expœe
;

668 
	`š™SticSŒšgObjeù
(
key
,
key¡r
);

669 
expœe
 = 
	`g‘Expœe
(
db
,&
key
);

670 ià(
	`rdbSaveKeyV®uePaœ
(
rdb
,&
key
,
o
,
expœe
,
now
è=ğ-1è
w”r
;

672 
	`diùR–—£I‹¿tÜ
(
di
);

674 
di
 = 
NULL
;

677 ià(
	`rdbSaveTy³
(
rdb
,
REDIS_RDB_OPCODE_EOF
è=ğ-1è
w”r
;

681 
cksum
 = 
rdb
->cksum;

682 
	`mem»v64ifbe
(&
cksum
);

683 ià(
	`rioWr™e
(
rdb
,&
cksum
,8è=ğ0è
w”r
;

684  
REDIS_OK
;

686 
w”r
:

687 ià(
”rÜ
è*”rÜ = 
”ºo
;

688 ià(
di
è
	`diùR–—£I‹¿tÜ
(di);

689  
REDIS_ERR
;

690 
	}
}

700 
	$rdbSaveRioW™hEOFM¬k
(
rio
 *
rdb
, *
”rÜ
) {

701 
eofm¬k
[
REDIS_EOF_MARK_SIZE
];

703 
	`g‘RªdomHexCh¬s
(
eofm¬k
,
REDIS_EOF_MARK_SIZE
);

704 ià(
”rÜ
) *error = 0;

705 ià(
	`rioWr™e
(
rdb
,"$EOF:",5è=ğ0è
w”r
;

706 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
REDIS_EOF_MARK_SIZE
è=ğ0è
w”r
;

707 ià(
	`rioWr™e
(
rdb
,"\r\n",2è=ğ0è
w”r
;

708 ià(
	`rdbSaveRio
(
rdb
,
”rÜ
è=ğ
REDIS_ERR
è
w”r
;

709 ià(
	`rioWr™e
(
rdb
,
eofm¬k
,
REDIS_EOF_MARK_SIZE
è=ğ0è
w”r
;

710  
REDIS_OK
;

712 
w”r
:

714 ià(
”rÜ
 && *”rÜ =ğ0è*”rÜ = 
”ºo
;

715  
REDIS_ERR
;

716 
	}
}

719 
	$rdbSave
(*
f’ame
) {

720 
tmpfe
[256];

721 
FILE
 *
å
;

722 
rio
 
rdb
;

723 
”rÜ
;

725 
	`¢´štf
(
tmpfe
,256,"‹mp-%d.rdb", (è
	`g‘pid
());

726 
å
 = 
	`fİ’
(
tmpfe
,"w");

727 ià(!
å
) {

728 
	`»disLog
(
REDIS_WARNING
, "Failed opening .rdb for saving: %s",

729 
	`¡»¼Ü
(
”ºo
));

730  
REDIS_ERR
;

733 
	`rioIn™W™hFe
(&
rdb
,
å
);

734 ià(
	`rdbSaveRio
(&
rdb
,&
”rÜ
è=ğ
REDIS_ERR
) {

735 
”ºo
 = 
”rÜ
;

736 
w”r
;

740 ià(
	`fæush
(
å
è=ğ
EOF
è
w”r
;

741 ià(
	`fsync
(
	`f’o
(
å
)è=ğ-1è
w”r
;

742 ià(
	`fşo£
(
å
è=ğ
EOF
è
w”r
;

746 ià(
	`»Çme
(
tmpfe
,
f’ame
) == -1) {

747 
	`»disLog
(
REDIS_WARNING
,"E¼Ü movšgem°DB fÚhfš® de¡š©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

748 
	`uÆšk
(
tmpfe
);

749  
REDIS_ERR
;

751 
	`»disLog
(
REDIS_NOTICE
,"DB saved on disk");

752 
£rv”
.
dœty
 = 0;

753 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

754 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_OK
;

755  
REDIS_OK
;

757 
w”r
:

758 
	`fşo£
(
å
);

759 
	`uÆšk
(
tmpfe
);

760 
	`»disLog
(
REDIS_WARNING
,"Wr™”rÜ savšg DB oÀdisk: %s", 
	`¡»¼Ü
(
”ºo
));

761  
REDIS_ERR
;

762 
	}
}

764 
	$rdbSaveBackground
(*
f’ame
) {

765 
pid_t
 
chdpid
;

766 
¡¬t
;

768 ià(
£rv”
.
rdb_chd_pid
 !ğ-1è 
REDIS_ERR
;

770 
£rv”
.
dœty_befÜe_bg§ve
 = s”v”.
dœty
;

771 
£rv”
.
Ï¡bg§ve_Œy
 = 
	`time
(
NULL
);

773 
¡¬t
 = 
	`u¡ime
();

774 ià((
chdpid
 = 
	`fÜk
()) == 0) {

775 
»tv®
;

778 
	`şo£Li¡’šgSock‘s
(0);

779 
	`»disS‘ProcT™Ë
("redis-rdb-bgsave");

780 
»tv®
 = 
	`rdbSave
(
f’ame
);

781 ià(
»tv®
 =ğ
REDIS_OK
) {

782 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

784 ià(
´iv©e_dœty
) {

785 
	`»disLog
(
REDIS_NOTICE
,

787 
´iv©e_dœty
/(1024*1024));

790 
	`ex™FromChd
((
»tv®
 =ğ
REDIS_OK
) ? 0 : 1);

793 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

794 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

795 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

796 ià(
chdpid
 == -1) {

797 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_ERR
;

798 
	`»disLog
(
REDIS_WARNING
,"Can't save in background: fork: %s",

799 
	`¡»¼Ü
(
”ºo
));

800  
REDIS_ERR
;

802 
	`»disLog
(
REDIS_NOTICE
,"Background savšg s¹ed by…id %d",
chdpid
);

803 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

804 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

805 
£rv”
.
rdb_chd_ty³
 = 
REDIS_RDB_CHILD_TYPE_DISK
;

806 
	`upd©eDiùResizePŞicy
();

807  
REDIS_OK
;

809  
REDIS_OK
;

810 
	}
}

812 
	$rdbRemoveTempFe
(
pid_t
 
chdpid
) {

813 
tmpfe
[256];

815 
	`¢´štf
(
tmpfe
,Ñmpfe),"‹mp-%d.rdb", (è
chdpid
);

816 
	`uÆšk
(
tmpfe
);

817 
	}
}

821 
robj
 *
	$rdbLßdObjeù
(
rdbty³
, 
rio
 *
rdb
) {

822 
robj
 *
o
, *
–e
, *
dec
;

823 
size_t
 
Ën
;

824 
i
;

826 ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_STRING
) {

828 ià((
o
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

829 
o
 = 
	`ŒyObjeùEncodšg
(o);

830 } ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_LIST
) {

832 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

835 ià(
Ën
 > 
£rv”
.
li¡_max_zli¡_’Œ›s
) {

836 
o
 = 
	`ü—‹Li¡Objeù
();

838 
o
 = 
	`ü—‹Zli¡Objeù
();

842 
Ën
--) {

843 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

847 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
 &&

848 
	`sdsEncodedObjeù
(
–e
) &&

849 
	`sd¦’
(
–e
->
±r
è> 
£rv”
.
li¡_max_zli¡_v®ue
)

850 
	`li¡Ty³CÚv”t
(
o
,
REDIS_ENCODING_LINKEDLIST
);

852 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

853 
dec
 = 
	`g‘DecodedObjeù
(
–e
);

854 
o
->
±r
 = 
	`zli¡Push
(o->±r,
dec
->±r,
	`sd¦’
(dec->±r),
REDIS_TAIL
);

855 
	`deüRefCouÁ
(
dec
);

856 
	`deüRefCouÁ
(
–e
);

858 
–e
 = 
	`ŒyObjeùEncodšg
(ele);

859 
	`li¡AddNodeTa
(
o
->
±r
,
–e
);

862 } ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_SET
) {

864 ià((
Ën
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

867 ià(
Ën
 > 
£rv”
.
£t_max_št£t_’Œ›s
) {

868 
o
 = 
	`ü—‹S‘Objeù
();

871 ià(
Ën
 > 
DICT_HT_INITIAL_SIZE
)

872 
	`diùEx·nd
(
o
->
±r
,
Ën
);

874 
o
 = 
	`ü—‹IÁ£tObjeù
();

878 
i
 = 0; i < 
Ën
; i++) {

879 
Îv®
;

880 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

881 
–e
 = 
	`ŒyObjeùEncodšg
(ele);

883 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

885 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
–e
,&
Îv®
è=ğ
REDIS_OK
) {

886 
o
->
±r
 = 
	`št£tAdd
(o->±r,
Îv®
,
NULL
);

888 
	`£tTy³CÚv”t
(
o
,
REDIS_ENCODING_HT
);

889 
	`diùEx·nd
(
o
->
±r
,
Ën
);

895 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

896 
	`diùAdd
((
diù
*)
o
->
±r
,
–e
,
NULL
);

898 
	`deüRefCouÁ
(
–e
);

901 } ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_ZSET
) {

903 
size_t
 
z£’
;

904 
size_t
 
max––’
 = 0;

905 
z£t
 *
zs
;

907 ià((
z£’
 = 
	`rdbLßdL’
(
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

908 
o
 = 
	`ü—‹Z£tObjeù
();

909 
zs
 = 
o
->
±r
;

912 
z£’
--) {

913 
robj
 *
–e
;

914 
scÜe
;

915 
zskli¡Node
 *
znode
;

917 ià((
–e
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
)è=ğ
NULL
)  NULL;

918 
–e
 = 
	`ŒyObjeùEncodšg
(ele);

919 ià(
	`rdbLßdDoubËV®ue
(
rdb
,&
scÜe
è=ğ-1è 
NULL
;

922 ià(
	`sdsEncodedObjeù
(
–e
è&& 
	`sd¦’
ÓË->
±r
è> 
max––’
)

923 
max––’
 = 
	`sd¦’
(
–e
->
±r
);

925 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

926 
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
);

927 
	`šüRefCouÁ
(
–e
);

931 ià(
	`z£tL’gth
(
o
è<ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

932 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

933 
	`z£tCÚv”t
(
o
,
REDIS_ENCODING_ZIPLIST
);

934 } ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_HASH
) {

935 
size_t
 
Ën
;

936 
»t
;

938 
Ën
 = 
	`rdbLßdL’
(
rdb
, 
NULL
);

939 ià(
Ën
 =ğ
REDIS_RDB_LENERR
è 
NULL
;

941 
o
 = 
	`ü—‹HashObjeù
();

944 ià(
Ën
 > 
£rv”
.
hash_max_zli¡_’Œ›s
)

945 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

948 
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
 && 
Ën
 > 0) {

949 
robj
 *
f›ld
, *
v®ue
;

951 
Ën
--;

953 
f›ld
 = 
	`rdbLßdSŒšgObjeù
(
rdb
);

954 ià(
f›ld
 =ğ
NULL
)  NULL;

955 
	`»disAs£¹
(
	`sdsEncodedObjeù
(
f›ld
));

956 
v®ue
 = 
	`rdbLßdSŒšgObjeù
(
rdb
);

957 ià(
v®ue
 =ğ
NULL
)  NULL;

958 
	`»disAs£¹
(
	`sdsEncodedObjeù
(
v®ue
));

961 
o
->
±r
 = 
	`zli¡Push
(o->±r, 
f›ld
->±r, 
	`sd¦’
(f›ld->±r), 
ZIPLIST_TAIL
);

962 
o
->
±r
 = 
	`zli¡Push
(o->±r, 
v®ue
->±r, 
	`sd¦’
(v®ue->±r), 
ZIPLIST_TAIL
);

964 ià(
	`sd¦’
(
f›ld
->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
 ||

965 
	`sd¦’
(
v®ue
->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

967 
	`deüRefCouÁ
(
f›ld
);

968 
	`deüRefCouÁ
(
v®ue
);

969 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

972 
	`deüRefCouÁ
(
f›ld
);

973 
	`deüRefCouÁ
(
v®ue
);

977 
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
 && 
Ën
 > 0) {

978 
robj
 *
f›ld
, *
v®ue
;

980 
Ën
--;

982 
f›ld
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
);

983 ià(
f›ld
 =ğ
NULL
)  NULL;

984 
v®ue
 = 
	`rdbLßdEncodedSŒšgObjeù
(
rdb
);

985 ià(
v®ue
 =ğ
NULL
)  NULL;

987 
f›ld
 = 
	`ŒyObjeùEncodšg
(field);

988 
v®ue
 = 
	`ŒyObjeùEncodšg
(value);

991 
»t
 = 
	`diùAdd
((
diù
*)
o
->
±r
, 
f›ld
, 
v®ue
);

992 
	`»disAs£¹
(
»t
 =ğ
DICT_OK
);

996 
	`»disAs£¹
(
Ën
 == 0);

998 } ià(
rdbty³
 =ğ
REDIS_RDB_TYPE_HASH_ZIPMAP
 ||

999 
rdbty³
 =ğ
REDIS_RDB_TYPE_LIST_ZIPLIST
 ||

1000 
rdbty³
 =ğ
REDIS_RDB_TYPE_SET_INTSET
 ||

1001 
rdbty³
 =ğ
REDIS_RDB_TYPE_ZSET_ZIPLIST
 ||

1002 
rdbty³
 =ğ
REDIS_RDB_TYPE_HASH_ZIPLIST
)

1004 
robj
 *
aux
 = 
	`rdbLßdSŒšgObjeù
(
rdb
);

1006 ià(
aux
 =ğ
NULL
)  NULL;

1007 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
NULL
);

1008 
o
->
±r
 = 
	`zm®loc
(
	`sd¦’
(
aux
->ptr));

1009 
	`memıy
(
o
->
±r
,
aux
->±r,
	`sd¦’
(aux->ptr));

1010 
	`deüRefCouÁ
(
aux
);

1018 
rdbty³
) {

1019 
REDIS_RDB_TYPE_HASH_ZIPMAP
:

1023 *
zl
 = 
	`zli¡New
();

1024 *
zi
 = 
	`zm­Rewšd
(
o
->
±r
);

1025 *
f¡r
, *
v¡r
;

1026 
æ’
, 
vËn
;

1027 
maxËn
 = 0;

1029 (
zi
 = 
	`zm­Next
(zi, &
f¡r
, &
æ’
, &
v¡r
, &
vËn
)è!ğ
NULL
) {

1030 ià(
æ’
 > 
maxËn
) maxlen = flen;

1031 ià(
vËn
 > 
maxËn
) maxlen = vlen;

1032 
zl
 = 
	`zli¡Push
(zl, 
f¡r
, 
æ’
, 
ZIPLIST_TAIL
);

1033 
zl
 = 
	`zli¡Push
(zl, 
v¡r
, 
vËn
, 
ZIPLIST_TAIL
);

1036 
	`zä“
(
o
->
±r
);

1037 
o
->
±r
 = 
zl
;

1038 
o
->
ty³
 = 
REDIS_HASH
;

1039 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

1041 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
 ||

1042 
maxËn
 > 
£rv”
.
hash_max_zli¡_v®ue
)

1044 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

1048 
REDIS_RDB_TYPE_LIST_ZIPLIST
:

1049 
o
->
ty³
 = 
REDIS_LIST
;

1050 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

1051 ià(
	`zli¡L’
(
o
->
±r
è> 
£rv”
.
li¡_max_zli¡_’Œ›s
)

1052 
	`li¡Ty³CÚv”t
(
o
,
REDIS_ENCODING_LINKEDLIST
);

1054 
REDIS_RDB_TYPE_SET_INTSET
:

1055 
o
->
ty³
 = 
REDIS_SET
;

1056 
o
->
’codšg
 = 
REDIS_ENCODING_INTSET
;

1057 ià(
	`št£tL’
(
o
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

1058 
	`£tTy³CÚv”t
(
o
,
REDIS_ENCODING_HT
);

1060 
REDIS_RDB_TYPE_ZSET_ZIPLIST
:

1061 
o
->
ty³
 = 
REDIS_ZSET
;

1062 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

1063 ià(
	`z£tL’gth
(
o
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1064 
	`z£tCÚv”t
(
o
,
REDIS_ENCODING_SKIPLIST
);

1066 
REDIS_RDB_TYPE_HASH_ZIPLIST
:

1067 
o
->
ty³
 = 
REDIS_HASH
;

1068 
o
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

1069 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

1070 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

1073 
	`»disPªic
("Unknownƒncoding");

1077 
	`»disPªic
("Unknown objectype");

1079  
o
;

1080 
	}
}

1084 
	$¡¬tLßdšg
(
FILE
 *
å
) {

1085 
¡©
 
sb
;

1088 
£rv”
.
lßdšg
 = 1;

1089 
£rv”
.
lßdšg_¡¬t_time
 = 
	`time
(
NULL
);

1090 
£rv”
.
lßdšg_lßded_by‹s
 = 0;

1091 ià(
	`f¡©
(
	`f’o
(
å
), &
sb
) == -1) {

1092 
£rv”
.
lßdšg_tÙ®_by‹s
 = 0;

1094 
£rv”
.
lßdšg_tÙ®_by‹s
 = 
sb
.
¡_size
;

1096 
	}
}

1099 
	$lßdšgProg»ss
(
off_t
 
pos
) {

1100 
£rv”
.
lßdšg_lßded_by‹s
 = 
pos
;

1101 ià(
£rv”
.
¡©_³ak_memÜy
 < 
	`zm®loc_u£d_memÜy
())

1102 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

1103 
	}
}

1106 
	$¡İLßdšg
() {

1107 
£rv”
.
lßdšg
 = 0;

1108 
	}
}

1112 
	$rdbLßdProg»ssC®lback
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1113 ià(
£rv”
.
rdb_checksum
)

1114 
	`rioG’”icUpd©eChecksum
(
r
, 
buf
, 
Ën
);

1115 ià(
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 &&

1116 (
r
->
´oûs£d_by‹s
 + 
Ën
)/
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 >„->processed_bytes/server.loading_process_events_interval_bytes)

1121 
	`upd©eCachedTime
();

1122 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
)

1123 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1124 
	`lßdšgProg»ss
(
r
->
´oûs£d_by‹s
);

1125 
	`´oûssEv’tsWheBlocked
();

1127 
	}
}

1129 
	$rdbLßd
(*
f’ame
) {

1130 
ušt32_t
 
dbid
;

1131 
ty³
, 
rdbv”
;

1132 
»disDb
 *
db
 = 
£rv”
.db+0;

1133 
buf
[1024];

1134 
expœ‘ime
, 
now
 = 
	`m¡ime
();

1135 
FILE
 *
å
;

1136 
rio
 
rdb
;

1138 ià((
å
 = 
	`fİ’
(
f’ame
,"r")è=ğ
NULL
è 
REDIS_ERR
;

1140 
	`rioIn™W™hFe
(&
rdb
,
å
);

1141 
rdb
.
upd©e_cksum
 = 
rdbLßdProg»ssC®lback
;

1142 
rdb
.
max_´oûssšg_chunk
 = 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

1143 ià(
	`rioR—d
(&
rdb
,
buf
,9è=ğ0è
eoã¼
;

1144 
buf
[9] = '\0';

1145 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

1146 
	`fşo£
(
å
);

1147 
	`»disLog
(
REDIS_WARNING
,"Wrong signatureryingo†oad DB from file");

1148 
”ºo
 = 
EINVAL
;

1149  
REDIS_ERR
;

1151 
rdbv”
 = 
	`©oi
(
buf
+5);

1152 ià(
rdbv”
 < 1 ||„dbv” > 
REDIS_RDB_VERSION
) {

1153 
	`fşo£
(
å
);

1154 
	`»disLog
(
REDIS_WARNING
,"Cª'ˆhªdË RDB fÜm© v”siÚ %d",
rdbv”
);

1155 
”ºo
 = 
EINVAL
;

1156  
REDIS_ERR
;

1159 
	`¡¬tLßdšg
(
å
);

1161 
robj
 *
key
, *
v®
;

1162 
expœ‘ime
 = -1;

1165 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1166 ià(
ty³
 =ğ
REDIS_RDB_OPCODE_EXPIRETIME
) {

1167 ià((
expœ‘ime
 = 
	`rdbLßdTime
(&
rdb
)è=ğ-1è
eoã¼
;

1169 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1172 
expœ‘ime
 *= 1000;

1173 } ià(
ty³
 =ğ
REDIS_RDB_OPCODE_EXPIRETIME_MS
) {

1176 ià((
expœ‘ime
 = 
	`rdbLßdMli£cÚdTime
(&
rdb
)è=ğ-1è
eoã¼
;

1178 ià((
ty³
 = 
	`rdbLßdTy³
(&
rdb
)è=ğ-1è
eoã¼
;

1181 ià(
ty³
 =ğ
REDIS_RDB_OPCODE_EOF
)

1185 ià(
ty³
 =ğ
REDIS_RDB_OPCODE_SELECTDB
) {

1186 ià((
dbid
 = 
	`rdbLßdL’
(&
rdb
,
NULL
)è=ğ
REDIS_RDB_LENERR
)

1187 
eoã¼
;

1188 ià(
dbid
 >ğ()
£rv”
.
dbnum
) {

1189 
	`»disLog
(
REDIS_WARNING
,"FATAL: D©¨fwa ü—‹d w™h‡ Redi £rv” cÚfigu»dØhªdË mÜthª %d d©aba£s. Ex™šg\n", 
£rv”
.
dbnum
);

1190 
	`ex™
(1);

1192 
db
 = 
£rv”
.db+
dbid
;

1196 ià((
key
 = 
	`rdbLßdSŒšgObjeù
(&
rdb
)è=ğ
NULL
è
eoã¼
;

1198 ià((
v®
 = 
	`rdbLßdObjeù
(
ty³
,&
rdb
)è=ğ
NULL
è
eoã¼
;

1204 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 && 
expœ‘ime
 !ğ-1 &&ƒxpœ‘im< 
now
) {

1205 
	`deüRefCouÁ
(
key
);

1206 
	`deüRefCouÁ
(
v®
);

1210 
	`dbAdd
(
db
,
key
,
v®
);

1213 ià(
expœ‘ime
 !ğ-1è
	`£tExpœe
(
db
,
key
,expiretime);

1215 
	`deüRefCouÁ
(
key
);

1218 ià(
rdbv”
 >ğ5 && 
£rv”
.
rdb_checksum
) {

1219 
ušt64_t
 
cksum
, 
ex³ùed
 = 
rdb
.cksum;

1221 ià(
	`rioR—d
(&
rdb
,&
cksum
,8è=ğ0è
eoã¼
;

1222 
	`mem»v64ifbe
(&
cksum
);

1223 ià(
cksum
 == 0) {

1224 
	`»disLog
(
REDIS_WARNING
,"RDB file was saved with checksum disabled:‚o check…erformed.");

1225 } ià(
cksum
 !ğ
ex³ùed
) {

1226 
	`»disLog
(
REDIS_WARNING
,"Wrong RDB checksum. Aborting‚ow.");

1227 
	`ex™
(1);

1231 
	`fşo£
(
å
);

1232 
	`¡İLßdšg
();

1233  
REDIS_OK
;

1235 
eoã¼
:

1236 
	`»disLog
(
REDIS_WARNING
,"Short„ead or OOM†oading DB. Unrecoverableƒrror,‡borting‚ow.");

1237 
	`ex™
(1);

1238  
REDIS_ERR
;

1239 
	}
}

1243 
	$backgroundSaveDÚeHªdËrDisk
(
ex™code
, 
bysigÇl
) {

1244 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1245 
	`»disLog
(
REDIS_NOTICE
,

1247 
£rv”
.
dœty
 = s”v”.dœty - s”v”.
dœty_befÜe_bg§ve
;

1248 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1249 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_OK
;

1250 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1251 
	`»disLog
(
REDIS_WARNING
, "Background savingƒrror");

1252 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_ERR
;

1254 
m¡ime_t
 
Ï‹ncy
;

1256 
	`»disLog
(
REDIS_WARNING
,

1257 "Background savšg”mš©ed by sigÇÈ%d", 
bysigÇl
);

1258 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

1259 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

1260 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

1261 
	`Ï‹ncyAddSam¶eIfN“ded
("rdb-uÆšk-‹mp-fe",
Ï‹ncy
);

1264 ià(
bysigÇl
 !ğ
SIGUSR1
)

1265 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_ERR
;

1267 
£rv”
.
rdb_chd_pid
 = -1;

1268 
£rv”
.
rdb_chd_ty³
 = 
REDIS_RDB_CHILD_TYPE_NONE
;

1269 
£rv”
.
rdb_§ve_time_Ï¡
 = 
	`time
(
NULL
)-£rv”.
rdb_§ve_time_¡¬t
;

1270 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1273 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
REDIS_OK
 : 
REDIS_ERR
, 
REDIS_RDB_CHILD_TYPE_DISK
);

1274 
	}
}

1279 
	$backgroundSaveDÚeHªdËrSock‘
(
ex™code
, 
bysigÇl
) {

1280 
ušt64_t
 *
ok_¦aves
;

1282 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1283 
	`»disLog
(
REDIS_NOTICE
,

1285 } ià(!
bysigÇl
 && 
ex™code
 != 0) {

1286 
	`»disLog
(
REDIS_WARNING
, "Backgroundransferƒrror");

1288 
	`»disLog
(
REDIS_WARNING
,

1289 "Background¿nsã¸‹rmš©ed by sigÇÈ%d", 
bysigÇl
);

1291 
£rv”
.
rdb_chd_pid
 = -1;

1292 
£rv”
.
rdb_chd_ty³
 = 
REDIS_RDB_CHILD_TYPE_NONE
;

1293 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1302 
ok_¦aves
 = 
	`zm®loc
((
ušt64_t
));

1303 
ok_¦aves
[0] = 0;

1304 ià(!
bysigÇl
 && 
ex™code
 == 0) {

1305 
»adËn
 = (
ušt64_t
);

1307 ià(
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
, 
»adËn
) ==

1308 
»adËn
)

1310 
»adËn
 = 
ok_¦aves
[0]*(
ušt64_t
)*2;

1314 
ok_¦aves
 = 
	`z»®loc
(ok_¦aves,(
ušt64_t
)+
»adËn
);

1315 ià(
»adËn
 &&

1316 
	`»ad
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
, 
ok_¦aves
+1,

1317 
»adËn
) !=„eadlen)

1319 
ok_¦aves
[0] = 0;

1324 
	`şo£
(
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
);

1325 
	`şo£
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
);

1329 
li¡Node
 *
Ê
;

1330 
li¡I‹r
 
li
;

1332 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1333 (
Ê
 = 
	`li¡Next
(&
li
))) {

1334 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1336 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_END
) {

1337 
ušt64_t
 
j
;

1338 
”rÜcode
 = 0;

1343 
j
 = 0; j < 
ok_¦aves
[0]; j++) {

1344 ià(
¦ave
->
id
 =ğ
ok_¦aves
[2*
j
+1]) {

1345 
”rÜcode
 = 
ok_¦aves
[2*
j
+2];

1349 ià(
j
 =ğ
ok_¦aves
[0] || 
”rÜcode
 != 0) {

1350 
	`»disLog
(
REDIS_WARNING
,

1352 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
),

1353 (
”rÜcode
 == 0) ? "RDBransfer child‡borted"

1354 : 
	`¡»¼Ü
(
”rÜcode
));

1355 
	`ä“Cl›Á
(
¦ave
);

1357 
	`»disLog
(
REDIS_WARNING
,

1359 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

1361 
	`ª‘NÚBlock
(
NULL
,
¦ave
->
fd
);

1362 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,0);

1366 
	`zä“
(
ok_¦aves
);

1368 
	`upd©eSÏvesWa™šgBg§ve
((!
bysigÇl
 && 
ex™code
 =ğ0è? 
REDIS_OK
 : 
REDIS_ERR
, 
REDIS_RDB_CHILD_TYPE_SOCKET
);

1369 
	}
}

1372 
	$backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
) {

1373 
£rv”
.
rdb_chd_ty³
) {

1374 
REDIS_RDB_CHILD_TYPE_DISK
:

1375 
	`backgroundSaveDÚeHªdËrDisk
(
ex™code
,
bysigÇl
);

1377 
REDIS_RDB_CHILD_TYPE_SOCKET
:

1378 
	`backgroundSaveDÚeHªdËrSock‘
(
ex™code
,
bysigÇl
);

1381 
	`»disPªic
("Unknown RDB childype.");

1384 
	}
}

1388 
	$rdbSaveToSÏvesSock‘s
() {

1389 *
fds
;

1390 
ušt64_t
 *
ş›Áids
;

1391 
numfds
;

1392 
li¡Node
 *
Ê
;

1393 
li¡I‹r
 
li
;

1394 
pid_t
 
chdpid
;

1395 
¡¬t
;

1396 
pefds
[2];

1398 ià(
£rv”
.
rdb_chd_pid
 !ğ-1è 
REDIS_ERR
;

1403 ià(
	`pe
(
pefds
è=ğ-1è 
REDIS_ERR
;

1404 
£rv”
.
rdb_pe_»ad_»suÉ_äom_chd
 = 
pefds
[0];

1405 
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
 = 
pefds
[1];

1409 
fds
 = 
	`zm®loc
(()*
	`li¡L’gth
(
£rv”
.
¦aves
));

1413 
ş›Áids
 = 
	`zm®loc
((
ušt64_t
)*
	`li¡L’gth
(
£rv”
.
¦aves
));

1414 
numfds
 = 0;

1416 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1417 (
Ê
 = 
	`li¡Next
(&
li
))) {

1418 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1420 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
) {

1421 
ş›Áids
[
numfds
] = 
¦ave
->
id
;

1422 
fds
[
numfds
++] = 
¦ave
->
fd
;

1423 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_END
;

1427 
	`ª‘Block
(
NULL
,
¦ave
->
fd
);

1428 
	`ª‘S’dTimeout
(
NULL
,
¦ave
->
fd
,
£rv”
.
»¶_timeout
*1000);

1433 
¡¬t
 = 
	`u¡ime
();

1434 ià((
chdpid
 = 
	`fÜk
()) == 0) {

1436 
»tv®
;

1437 
rio
 
¦ave_sock‘s
;

1439 
	`rioIn™W™hFd£t
(&
¦ave_sock‘s
,
fds
,
numfds
);

1440 
	`zä“
(
fds
);

1442 
	`şo£Li¡’šgSock‘s
(0);

1443 
	`»disS‘ProcT™Ë
("redis-rdb-to-slaves");

1445 
»tv®
 = 
	`rdbSaveRioW™hEOFM¬k
(&
¦ave_sock‘s
,
NULL
);

1446 ià(
»tv®
 =ğ
REDIS_OK
 && 
	`rioFlush
(&
¦ave_sock‘s
) == 0)

1447 
»tv®
 = 
REDIS_ERR
;

1449 ià(
»tv®
 =ğ
REDIS_OK
) {

1450 
size_t
 
´iv©e_dœty
 = 
	`zm®loc_g‘_´iv©e_dœty
();

1452 ià(
´iv©e_dœty
) {

1453 
	`»disLog
(
REDIS_NOTICE
,

1455 
´iv©e_dœty
/(1024*1024));

1473 *
msg
 = 
	`zm®loc
((
ušt64_t
)*(1+2*
numfds
));

1474 
ušt64_t
 *
Ën
 = 
msg
;

1475 
ušt64_t
 *
ids
 = 
Ën
+1;

1476 
j
, 
msgËn
;

1478 *
Ën
 = 
numfds
;

1479 
j
 = 0; j < 
numfds
; j++) {

1480 *
ids
++ = 
ş›Áids
[
j
];

1481 *
ids
++ = 
¦ave_sock‘s
.
io
.
fd£t
.
¡©e
[
j
];

1488 
msgËn
 = (
ušt64_t
)*(1+2*
numfds
);

1489 ià(*
Ën
 == 0 ||

1490 
	`wr™e
(
£rv”
.
rdb_pe_wr™e_»suÉ_to_·»Á
,
msg
,
msgËn
)

1491 !ğ
msgËn
)

1493 
»tv®
 = 
REDIS_ERR
;

1495 
	`zä“
(
msg
);

1497 
	`zä“
(
ş›Áids
);

1498 
	`ex™FromChd
((
»tv®
 =ğ
REDIS_OK
) ? 0 : 1);

1501 
	`zä“
(
ş›Áids
);

1502 
£rv”
.
¡©_fÜk_time
 = 
	`u¡ime
()-
¡¬t
;

1503 
£rv”
.
¡©_fÜk_¿‹
 = (è
	`zm®loc_u£d_memÜy
(è* 1000000 / s”v”.
¡©_fÜk_time
 / (1024*1024*1024);

1504 
	`Ï‹ncyAddSam¶eIfN“ded
("fÜk",
£rv”
.
¡©_fÜk_time
/1000);

1505 ià(
chdpid
 == -1) {

1506 
	`»disLog
(
REDIS_WARNING
,"Can't save in background: fork: %s",

1507 
	`¡»¼Ü
(
”ºo
));

1508 
	`zä“
(
fds
);

1509 
	`şo£
(
pefds
[0]);

1510 
	`şo£
(
pefds
[1]);

1511  
REDIS_ERR
;

1513 
	`»disLog
(
REDIS_NOTICE
,"Background RDB¿nsã¸¡¬‹d by…id %d",
chdpid
);

1514 
£rv”
.
rdb_§ve_time_¡¬t
 = 
	`time
(
NULL
);

1515 
£rv”
.
rdb_chd_pid
 = 
chdpid
;

1516 
£rv”
.
rdb_chd_ty³
 = 
REDIS_RDB_CHILD_TYPE_SOCKET
;

1517 
	`upd©eDiùResizePŞicy
();

1518 
	`zä“
(
fds
);

1519  
REDIS_OK
;

1521  
REDIS_OK
;

1522 
	}
}

1524 
	$§veCommªd
(
»disCl›Á
 *
c
) {

1525 ià(
£rv”
.
rdb_chd_pid
 != -1) {

1526 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

1529 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è=ğ
REDIS_OK
) {

1530 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1532 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1534 
	}
}

1536 
	$bg§veCommªd
(
»disCl›Á
 *
c
) {

1537 ià(
£rv”
.
rdb_chd_pid
 != -1) {

1538 
	`addR•lyE¼Ü
(
c
,"Background save‡lready in…rogress");

1539 } ià(
£rv”
.
aof_chd_pid
 != -1) {

1540 
	`addR•lyE¼Ü
(
c
,"Can't BGSAVE while AOF†og„ewriting is in…rogress");

1541 } ià(
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
è=ğ
REDIS_OK
) {

1542 
	`addR•lyStus
(
c
,"Background saving started");

1544 
	`addR•ly
(
c
,
sh¬ed
.
”r
);

1546 
	}
}

	@rdb.h

30 #iâdeà
__REDIS_RDB_H


31 
	#__REDIS_RDB_H


	)

33 
	~<¡dio.h
>

34 
	~"rio.h
"

37 
	~"»dis.h
"

41 
	#REDIS_RDB_VERSION
 6

	)

56 
	#REDIS_RDB_6BITLEN
 0

	)

57 
	#REDIS_RDB_14BITLEN
 1

	)

58 
	#REDIS_RDB_32BITLEN
 2

	)

59 
	#REDIS_RDB_ENCVAL
 3

	)

60 
	#REDIS_RDB_LENERR
 
UINT_MAX


	)

65 
	#REDIS_RDB_ENC_INT8
 0

	)

66 
	#REDIS_RDB_ENC_INT16
 1

	)

67 
	#REDIS_RDB_ENC_INT32
 2

	)

68 
	#REDIS_RDB_ENC_LZF
 3

	)

72 
	#REDIS_RDB_TYPE_STRING
 0

	)

73 
	#REDIS_RDB_TYPE_LIST
 1

	)

74 
	#REDIS_RDB_TYPE_SET
 2

	)

75 
	#REDIS_RDB_TYPE_ZSET
 3

	)

76 
	#REDIS_RDB_TYPE_HASH
 4

	)

79 
	#REDIS_RDB_TYPE_HASH_ZIPMAP
 9

	)

80 
	#REDIS_RDB_TYPE_LIST_ZIPLIST
 10

	)

81 
	#REDIS_RDB_TYPE_SET_INTSET
 11

	)

82 
	#REDIS_RDB_TYPE_ZSET_ZIPLIST
 12

	)

83 
	#REDIS_RDB_TYPE_HASH_ZIPLIST
 13

	)

86 
	#rdbIsObjeùTy³
(
t
è(Ñ >ğ0 && <ğ4è|| (ˆ>ğ9 && <ğ13))

	)

89 
	#REDIS_RDB_OPCODE_EXPIRETIME_MS
 252

	)

90 
	#REDIS_RDB_OPCODE_EXPIRETIME
 253

	)

91 
	#REDIS_RDB_OPCODE_SELECTDB
 254

	)

92 
	#REDIS_RDB_OPCODE_EOF
 255

	)

94 
rdbSaveTy³
(
rio
 *
rdb
, 
ty³
);

95 
rdbLßdTy³
(
rio
 *
rdb
);

96 
rdbSaveTime
(
rio
 *
rdb
, 
time_t
 
t
);

97 
time_t
 
rdbLßdTime
(
rio
 *
rdb
);

98 
rdbSaveL’
(
rio
 *
rdb
, 
ušt32_t
 
Ën
);

99 
ušt32_t
 
rdbLßdL’
(
rio
 *
rdb
, *
i£ncoded
);

100 
rdbSaveObjeùTy³
(
rio
 *
rdb
, 
robj
 *
o
);

101 
rdbLßdObjeùTy³
(
rio
 *
rdb
);

102 
rdbLßd
(*
f’ame
);

103 
rdbSaveBackground
(*
f’ame
);

104 
rdbSaveToSÏvesSock‘s
();

105 
rdbRemoveTempFe
(
pid_t
 
chdpid
);

106 
rdbSave
(*
f’ame
);

107 
rdbSaveObjeù
(
rio
 *
rdb
, 
robj
 *
o
);

108 
off_t
 
rdbSavedObjeùL’
(
robj
 *
o
);

109 
off_t
 
rdbSavedObjeùPages
(
robj
 *
o
);

110 
robj
 *
rdbLßdObjeù
(
ty³
, 
rio
 *
rdb
);

111 
backgroundSaveDÚeHªdËr
(
ex™code
, 
bysigÇl
);

112 
rdbSaveKeyV®uePaœ
(
rio
 *
rdb
, 
robj
 *
key
,„obj *
v®
, 
expœ‘ime
, 
now
);

113 
robj
 *
rdbLßdSŒšgObjeù
(
rio
 *
rdb
);

	@redis-benchmark.c

31 
	~"fmaüos.h
"

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<¡dlib.h
>

36 
	~<uni¡d.h
>

37 
	~<”ºo.h
>

38 
	~<time.h
>

39 
	~<sys/time.h
>

40 
	~<sigÇl.h
>

41 
	~<as£¹.h
>

43 
	~"«.h
"

44 
	~"hœedis.h
"

45 
	~"sds.h
"

46 
	~"adli¡.h
"

47 
	~"zm®loc.h
"

49 
	#REDIS_NOTUSED
(
V
è((èV)

	)

50 
	#RANDPTR_INITIAL_SIZE
 8

	)

52 
	scÚfig
 {

53 
«Ev’tLoİ
 *
	m–
;

54 cÚ¡ *
	mho¡
;

55 
	mho¡pÜt
;

56 cÚ¡ *
	mho¡sock‘
;

57 
	mnumş›Ás
;

58 
	mliveş›Ás
;

59 
	m»que¡s
;

60 
	m»que¡s_issued
;

61 
	m»que¡s_fšished
;

62 
	mkeysize
;

63 
	md©asize
;

64 
	m¿ndomkeys
;

65 
	m¿ndomkeys_key¥aûËn
;

66 
	mk“·live
;

67 
	mp–še
;

68 
	m¡¬t
;

69 
	mtÙÏ‹ncy
;

70 *
	mÏ‹ncy
;

71 cÚ¡ *
	mt™Ë
;

72 
li¡
 *
	mş›Ás
;

73 
	mqu›t
;

74 
	mcsv
;

75 
	mloİ
;

76 
	midËmode
;

77 
	mdbnum
;

78 
sds
 
	mdbnum¡r
;

79 *
	m‹¡s
;

80 *
	mauth
;

81 } 
	gcÚfig
;

83 
	s_ş›Á
 {

84 
»disCÚ‹xt
 *
	mcÚ‹xt
;

85 
sds
 
	mobuf
;

86 **
	m¿nd±r
;

87 
size_t
 
	m¿ndËn
;

88 
size_t
 
	m¿ndä“
;

89 
	mwr™‹n
;

90 
	m¡¬t
;

91 
	mÏ‹ncy
;

92 
	m³ndšg
;

93 
	m´efix_³ndšg
;

96 
	m´efixËn
;

97 } *
	tş›Á
;

100 
wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

101 
ü—‹MissšgCl›Ás
(
ş›Á
 
c
);

104 
	$u¡ime
() {

105 
timev®
 
tv
;

106 
u¡
;

108 
	`g‘timeofday
(&
tv
, 
NULL
);

109 
u¡
 = (()
tv
.
tv_£c
)*1000000;

110 
u¡
 +ğ
tv
.
tv_u£c
;

111  
u¡
;

112 
	}
}

114 
	$m¡ime
() {

115 
timev®
 
tv
;

116 
m¡
;

118 
	`g‘timeofday
(&
tv
, 
NULL
);

119 
m¡
 = (()
tv
.
tv_£c
)*1000;

120 
m¡
 +ğ
tv
.
tv_u£c
/1000;

121  
m¡
;

122 
	}
}

124 
	$ä“Cl›Á
(
ş›Á
 
c
) {

125 
li¡Node
 *
Ê
;

126 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

127 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

128 
	`»disF»e
(
c
->
cÚ‹xt
);

129 
	`sdsä“
(
c
->
obuf
);

130 
	`zä“
(
c
->
¿nd±r
);

131 
	`zä“
(
c
);

132 
cÚfig
.
liveş›Ás
--;

133 
Ê
 = 
	`li¡S—rchKey
(
cÚfig
.
ş›Ás
,
c
);

134 
	`as£¹
(
Ê
 !ğ
NULL
);

135 
	`li¡D–Node
(
cÚfig
.
ş›Ás
,
Ê
);

136 
	}
}

138 
	$ä“AÎCl›Ás
() {

139 
li¡Node
 *
Ê
 = 
cÚfig
.
ş›Ás
->
h—d
, *
Ãxt
;

141 
Ê
) {

142 
Ãxt
 = 
Ê
->next;

143 
	`ä“Cl›Á
(
Ê
->
v®ue
);

144 
Ê
 = 
Ãxt
;

146 
	}
}

148 
	$»£tCl›Á
(
ş›Á
 
c
) {

149 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

150 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
);

151 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

152 
c
->
wr™‹n
 = 0;

153 
c
->
³ndšg
 = 
cÚfig
.
p–še
;

154 
	}
}

156 
	$¿ndomizeCl›ÁKey
(
ş›Á
 
c
) {

157 
size_t
 
i
;

159 
i
 = 0; i < 
c
->
¿ndËn
; i++) {

160 *
p
 = 
c
->
¿nd±r
[
i
]+11;

161 
size_t
 
r
 = 
	`¿ndom
(è% 
cÚfig
.
¿ndomkeys_key¥aûËn
;

162 
size_t
 
j
;

164 
j
 = 0; j < 12; j++) {

165 *
p
 = '0'+
r
%10;

166 
r
/=10;

167 
p
--;

170 
	}
}

172 
	$ş›ÁDÚe
(
ş›Á
 
c
) {

173 ià(
cÚfig
.
»que¡s_fšished
 =ğcÚfig.
»que¡s
) {

174 
	`ä“Cl›Á
(
c
);

175 
	`«Stİ
(
cÚfig
.
–
);

178 ià(
cÚfig
.
k“·live
) {

179 
	`»£tCl›Á
(
c
);

181 
cÚfig
.
liveş›Ás
--;

182 
	`ü—‹MissšgCl›Ás
(
c
);

183 
cÚfig
.
liveş›Ás
++;

184 
	`ä“Cl›Á
(
c
);

186 
	}
}

188 
	$»adHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

189 
ş›Á
 
c
 = 
´ivd©a
;

190 *
»¶y
 = 
NULL
;

191 
	`REDIS_NOTUSED
(
–
);

192 
	`REDIS_NOTUSED
(
fd
);

193 
	`REDIS_NOTUSED
(
mask
);

198 ià(
c
->
Ï‹ncy
 < 0èc->Ï‹ncy = 
	`u¡ime
()-(c->
¡¬t
);

200 ià(
	`»disBufãrR—d
(
c
->
cÚ‹xt
è!ğ
REDIS_OK
) {

201 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

202 
	`ex™
(1);

204 
c
->
³ndšg
) {

205 ià(
	`»disG‘R•ly
(
c
->
cÚ‹xt
,&
»¶y
è!ğ
REDIS_OK
) {

206 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
c
->
cÚ‹xt
->
”r¡r
);

207 
	`ex™
(1);

209 ià(
»¶y
 !ğ
NULL
) {

210 ià(
»¶y
 =ğ(*)
REDIS_REPLY_ERROR
) {

211 
	`årštf
(
¡d”r
,"Unexpectedƒrror„eply,ƒxiting...\n");

212 
	`ex™
(1);

215 
	`ä“R•lyObjeù
(
»¶y
);

217 ià(
c
->
´efix_³ndšg
 > 0) {

218 
c
->
´efix_³ndšg
--;

219 
c
->
³ndšg
--;

221 ià(
c
->
´efixËn
 > 0) {

222 
size_t
 
j
;

223 
	`sd¤ªge
(
c
->
obuf
, c->
´efixËn
, -1);

226 
j
 = 0; j < 
c
->
¿ndËn
; j++)

227 
c
->
¿nd±r
[
j
] -ğc->
´efixËn
;

228 
c
->
´efixËn
 = 0;

233 ià(
cÚfig
.
»que¡s_fšished
 < cÚfig.
»que¡s
)

234 
cÚfig
.
Ï‹ncy
[cÚfig.
»que¡s_fšished
++] = 
c
->latency;

235 
c
->
³ndšg
--;

236 ià(
c
->
³ndšg
 == 0) {

237 
	`ş›ÁDÚe
(
c
);

245 
	}
}

247 
	$wr™eHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

248 
ş›Á
 
c
 = 
´ivd©a
;

249 
	`REDIS_NOTUSED
(
–
);

250 
	`REDIS_NOTUSED
(
fd
);

251 
	`REDIS_NOTUSED
(
mask
);

254 ià(
c
->
wr™‹n
 == 0) {

256 ià(
cÚfig
.
»que¡s_issued
++ >ğcÚfig.
»que¡s
) {

257 
	`ä“Cl›Á
(
c
);

262 ià(
cÚfig
.
¿ndomkeys
è
	`¿ndomizeCl›ÁKey
(
c
);

263 
c
->
¡¬t
 = 
	`u¡ime
();

264 
c
->
Ï‹ncy
 = -1;

267 ià(
	`sd¦’
(
c
->
obuf
è> c->
wr™‹n
) {

268 *
±r
 = 
c
->
obuf
+c->
wr™‹n
;

269 
nwr™‹n
 = 
	`wr™e
(
c
->
cÚ‹xt
->
fd
,
±r
,
	`sd¦’
(c->
obuf
)-c->
wr™‹n
);

270 ià(
nwr™‹n
 == -1) {

271 ià(
”ºo
 !ğ
EPIPE
)

272 
	`årštf
(
¡d”r
, "Wr™šgØsock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

273 
	`ä“Cl›Á
(
c
);

276 
c
->
wr™‹n
 +ğ
nwr™‹n
;

277 ià(
	`sd¦’
(
c
->
obuf
è=ğc->
wr™‹n
) {

278 
	`«D–‘eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
);

279 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_READABLE
,
»adHªdËr
,c);

282 
	}
}

305 
ş›Á
 
	$ü—‹Cl›Á
(*
cmd
, 
size_t
 
Ën
, 
ş›Á
 
äom
) {

306 
j
;

307 
ş›Á
 
c
 = 
	`zm®loc
((
_ş›Á
));

309 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

310 
c
->
cÚ‹xt
 = 
	`»disCÚÃùNÚBlock
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

312 
c
->
cÚ‹xt
 = 
	`»disCÚÃùUnixNÚBlock
(
cÚfig
.
ho¡sock‘
);

314 ià(
c
->
cÚ‹xt
->
”r
) {

315 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

316 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

317 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
c
->
cÚ‹xt
->
”r¡r
);

319 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
c
->
cÚ‹xt
->
”r¡r
);

320 
	`ex™
(1);

323 
c
->
cÚ‹xt
->
»ad”
->
maxbuf
 = 0;

328 
c
->
obuf
 = 
	`sd£m±y
();

332 
c
->
´efix_³ndšg
 = 0;

333 ià(
cÚfig
.
auth
) {

334 *
buf
 = 
NULL
;

335 
Ën
 = 
	`»disFÜm©Commªd
(&
buf
, "AUTH %s", 
cÚfig
.
auth
);

336 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf, 
buf
, 
Ën
);

337 
	`ä“
(
buf
);

338 
c
->
´efix_³ndšg
++;

345 ià(
cÚfig
.
dbnum
 != 0) {

346 
c
->
obuf
 = 
	`sdsÿrštf
(c->obuf,"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n",

347 ()
	`sd¦’
(
cÚfig
.
dbnum¡r
),config.dbnumstr);

348 
c
->
´efix_³ndšg
++;

350 
c
->
´efixËn
 = 
	`sd¦’
(c->
obuf
);

352 ià(
äom
) {

353 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,

354 
äom
->
obuf
+äom->
´efixËn
,

355 
	`sd¦’
(
äom
->
obuf
)-äom->
´efixËn
);

357 
j
 = 0; j < 
cÚfig
.
p–še
; j++)

358 
c
->
obuf
 = 
	`sdsÿ’
(c->obuf,
cmd
,
Ën
);

361 
c
->
wr™‹n
 = 0;

362 
c
->
³ndšg
 = 
cÚfig
.
p–še
+c->
´efix_³ndšg
;

363 
c
->
¿nd±r
 = 
NULL
;

364 
c
->
¿ndËn
 = 0;

367 ià(
cÚfig
.
¿ndomkeys
) {

368 ià(
äom
) {

369 
c
->
¿ndËn
 = 
äom
->randlen;

370 
c
->
¿ndä“
 = 0;

371 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndËn
);

373 
j
 = 0; j < ()
c
->
¿ndËn
; j++) {

374 
c
->
¿nd±r
[
j
] = c->
obuf
 + (
äom
->randptr[j]-from->obuf);

376 
c
->
¿nd±r
[
j
] +ğc->
´efixËn
 - 
äom
->prefixlen;

379 *
p
 = 
c
->
obuf
;

381 
c
->
¿ndËn
 = 0;

382 
c
->
¿ndä“
 = 
RANDPTR_INITIAL_SIZE
;

383 
c
->
¿nd±r
 = 
	`zm®loc
((*)*c->
¿ndä“
);

384 (
p
 = 
	`¡r¡r
Õ,"__¿nd_št__")è!ğ
NULL
) {

385 ià(
c
->
¿ndä“
 == 0) {

386 
c
->
¿nd±r
 = 
	`z»®loc
(c->¿nd±r,(*)*c->
¿ndËn
*2);

387 
c
->
¿ndä“
 +ğc->
¿ndËn
;

389 
c
->
¿nd±r
[c->
¿ndËn
++] = 
p
;

390 
c
->
¿ndä“
--;

391 
p
 += 12;

395 ià(
cÚfig
.
idËmode
 == 0)

396 
	`«C»©eFeEv’t
(
cÚfig
.
–
,
c
->
cÚ‹xt
->
fd
,
AE_WRITABLE
,
wr™eHªdËr
,c);

397 
	`li¡AddNodeTa
(
cÚfig
.
ş›Ás
,
c
);

398 
cÚfig
.
liveş›Ás
++;

399  
c
;

400 
	}
}

402 
	$ü—‹MissšgCl›Ás
(
ş›Á
 
c
) {

403 
n
 = 0;

405 
cÚfig
.
liveş›Ás
 < cÚfig.
numş›Ás
) {

406 
	`ü—‹Cl›Á
(
NULL
,0,
c
);

409 ià(++
n
 > 64) {

410 
	`u¦“p
(50000);

411 
n
 = 0;

414 
	}
}

416 
	$com·»L©’cy
(cÚ¡ *
a
, cÚ¡ *
b
) {

417  (*(*)
a
)-(*(*)
b
);

418 
	}
}

420 
	$showL©’cyR•Üt
() {

421 
i
, 
cu¾©
 = 0;

422 
³rc
, 
»q³r£c
;

424 
»q³r£c
 = ()
cÚfig
.
»que¡s_fšished
/(()cÚfig.
tÙÏ‹ncy
/1000);

425 ià(!
cÚfig
.
qu›t
 && !cÚfig.
csv
) {

426 
	`´štf
("=====ğ% ======\n", 
cÚfig
.
t™Ë
);

427 
	`´štf
(" %d„eque¡ com¶‘ed iÀ%.2à£cÚds\n", 
cÚfig
.
»que¡s_fšished
,

428 ()
cÚfig
.
tÙÏ‹ncy
/1000);

429 
	`´štf
(" %d…¬®ËÈş›Ás\n", 
cÚfig
.
numş›Ás
);

430 
	`´štf
(" %d by‹ ·ylßd\n", 
cÚfig
.
d©asize
);

431 
	`´štf
(" k“°®ive: %d\n", 
cÚfig
.
k“·live
);

432 
	`´štf
("\n");

434 
	`qsÜt
(
cÚfig
.
Ï‹ncy
,cÚfig.
»que¡s
,(),
com·»L©’cy
);

435 
i
 = 0; i < 
cÚfig
.
»que¡s
; i++) {

436 ià(
cÚfig
.
Ï‹ncy
[
i
]/1000 !ğ
cu¾©
 || i =ğ(cÚfig.
»que¡s
-1)) {

437 
cu¾©
 = 
cÚfig
.
Ï‹ncy
[
i
]/1000;

438 
³rc
 = (()(
i
+1)*100)/
cÚfig
.
»que¡s
;

439 
	`´štf
("%.2f%% <ğ%d mli£cÚds\n", 
³rc
, 
cu¾©
);

442 
	`´štf
("%.2à»que¡ ³¸£cÚd\n\n", 
»q³r£c
);

443 } ià(
cÚfig
.
csv
) {

444 
	`´štf
("\"%s\",\"%.2f\"\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

446 
	`´štf
("%s: %.2à»que¡ ³¸£cÚd\n", 
cÚfig
.
t™Ë
, 
»q³r£c
);

448 
	}
}

450 
	$b’chm¬k
(*
t™Ë
, *
cmd
, 
Ën
) {

451 
ş›Á
 
c
;

453 
cÚfig
.
t™Ë
 =itle;

454 
cÚfig
.
»que¡s_issued
 = 0;

455 
cÚfig
.
»que¡s_fšished
 = 0;

457 
c
 = 
	`ü—‹Cl›Á
(
cmd
,
Ën
,
NULL
);

458 
	`ü—‹MissšgCl›Ás
(
c
);

460 
cÚfig
.
¡¬t
 = 
	`m¡ime
();

461 
	`«Maš
(
cÚfig
.
–
);

462 
cÚfig
.
tÙÏ‹ncy
 = 
	`m¡ime
()-cÚfig.
¡¬t
;

464 
	`showL©’cyR•Üt
();

465 
	`ä“AÎCl›Ás
();

466 
	}
}

469 
	$·r£O±iÚs
(
¬gc
, cÚ¡ **
¬gv
) {

470 
i
;

471 
Ï¡¬g
;

472 
ex™_¡©us
 = 1;

474 
i
 = 1; i < 
¬gc
; i++) {

475 
Ï¡¬g
 = (
i
 =ğ(
¬gc
-1));

477 ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

478 ià(
Ï¡¬g
è
šv®id
;

479 
cÚfig
.
numş›Ás
 = 
	`©oi
(
¬gv
[++
i
]);

480 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n")) {

481 ià(
Ï¡¬g
è
šv®id
;

482 
cÚfig
.
»que¡s
 = 
	`©oi
(
¬gv
[++
i
]);

483 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-k")) {

484 ià(
Ï¡¬g
è
šv®id
;

485 
cÚfig
.
k“·live
 = 
	`©oi
(
¬gv
[++
i
]);

486 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h")) {

487 ià(
Ï¡¬g
è
šv®id
;

488 
cÚfig
.
ho¡
 = 
	`¡rdup
(
¬gv
[++
i
]);

489 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p")) {

490 ià(
Ï¡¬g
è
šv®id
;

491 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

492 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s")) {

493 ià(
Ï¡¬g
è
šv®id
;

494 
cÚfig
.
ho¡sock‘
 = 
	`¡rdup
(
¬gv
[++
i
]);

495 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a") ) {

496 ià(
Ï¡¬g
è
šv®id
;

497 
cÚfig
.
auth
 = 
	`¡rdup
(
¬gv
[++
i
]);

498 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d")) {

499 ià(
Ï¡¬g
è
šv®id
;

500 
cÚfig
.
d©asize
 = 
	`©oi
(
¬gv
[++
i
]);

501 ià(
cÚfig
.
d©asize
 < 1) config.datasize=1;

502 ià(
cÚfig
.
d©asize
 > 1024*1024*1024) config.datasize = 1024*1024*1024;

503 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-P")) {

504 ià(
Ï¡¬g
è
šv®id
;

505 
cÚfig
.
p–še
 = 
	`©oi
(
¬gv
[++
i
]);

506 ià(
cÚfig
.
p–še
 <= 0) config.pipeline=1;

507 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r")) {

508 ià(
Ï¡¬g
è
šv®id
;

509 
cÚfig
.
¿ndomkeys
 = 1;

510 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 
	`©oi
(
¬gv
[++
i
]);

511 ià(
cÚfig
.
¿ndomkeys_key¥aûËn
 < 0)

512 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

513 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-q")) {

514 
cÚfig
.
qu›t
 = 1;

515 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

516 
cÚfig
.
csv
 = 1;

517 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-l")) {

518 
cÚfig
.
loİ
 = 1;

519 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-I")) {

520 
cÚfig
.
idËmode
 = 1;

521 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-t")) {

522 ià(
Ï¡¬g
è
šv®id
;

528 
cÚfig
.
‹¡s
 = 
	`sd¢ew
(",");

529 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(cÚfig.‹¡s,(*)
¬gv
[++
i
]);

530 
cÚfig
.
‹¡s
 = 
	`sdsÿt
(config.tests,",");

531 
	`sd¡Şow”
(
cÚfig
.
‹¡s
);

532 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--dbnum")) {

533 ià(
Ï¡¬g
è
šv®id
;

534 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

535 
cÚfig
.
dbnum¡r
 = 
	`sdsäomlÚglÚg
(cÚfig.
dbnum
);

536 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

537 
ex™_¡©us
 = 0;

538 
u§ge
;

543 ià(
¬gv
[
i
][0] =ğ'-'è
šv®id
;

544  
i
;

548  
i
;

550 
šv®id
:

551 
	`´štf
("Inv®id o±iÚ \"%s\" o¸İtiÚ‡rgum’ˆmissšg\n\n",
¬gv
[
i
]);

553 
u§ge
:

554 
	`´štf
(

594 
	`ex™
(
ex™_¡©us
);

595 
	}
}

597 
	$showThroughput
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

598 
	`REDIS_NOTUSED
(
ev’tLoİ
);

599 
	`REDIS_NOTUSED
(
id
);

600 
	`REDIS_NOTUSED
(
ş›ÁD©a
);

602 ià(
cÚfig
.
liveş›Ás
 == 0) {

603 
	`årštf
(
¡d”r
,"All clients disconnected...‡borting.\n");

604 
	`ex™
(1);

606 ià(
cÚfig
.
csv
)  250;

607 ià(
cÚfig
.
idËmode
 == 1) {

608 
	`´štf
("ş›Ás: %d\r", 
cÚfig
.
liveş›Ás
);

609 
	`fæush
(
¡dout
);

612 
dt
 = ()(
	`m¡ime
()-
cÚfig
.
¡¬t
)/1000.0;

613 
½s
 = ()
cÚfig
.
»que¡s_fšished
/
dt
;

614 
	`´štf
("%s: %.2f\r", 
cÚfig
.
t™Ë
, 
½s
);

615 
	`fæush
(
¡dout
);

617 
	}
}

621 
	$‹¡_is_£Ëùed
(*
Çme
) {

622 
buf
[256];

623 
l
 = 
	`¡¾’
(
Çme
);

625 ià(
cÚfig
.
‹¡s
 =ğ
NULL
)  1;

626 
buf
[0] = ',';

627 
	`memıy
(
buf
+1,
Çme
,
l
);

628 
buf
[
l
+1] = ',';

629 
buf
[
l
+2] = '\0';

630  
	`¡r¡r
(
cÚfig
.
‹¡s
,
buf
è!ğ
NULL
;

631 
	}
}

633 
	$maš
(
¬gc
, cÚ¡ **
¬gv
) {

634 
i
;

635 *
d©a
, *
cmd
;

636 
Ën
;

638 
ş›Á
 
c
;

640 
	`¤ªdom
(
	`time
(
NULL
));

641 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

642 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

644 
cÚfig
.
numş›Ás
 = 50;

645 
cÚfig
.
»que¡s
 = 100000;

646 
cÚfig
.
liveş›Ás
 = 0;

647 
cÚfig
.
–
 = 
	`«C»©eEv’tLoİ
(1024*10);

648 
	`«C»©eTimeEv’t
(
cÚfig
.
–
,1,
showThroughput
,
NULL
,NULL);

649 
cÚfig
.
k“·live
 = 1;

650 
cÚfig
.
d©asize
 = 3;

651 
cÚfig
.
p–še
 = 1;

652 
cÚfig
.
¿ndomkeys
 = 0;

653 
cÚfig
.
¿ndomkeys_key¥aûËn
 = 0;

654 
cÚfig
.
qu›t
 = 0;

655 
cÚfig
.
csv
 = 0;

656 
cÚfig
.
loİ
 = 0;

657 
cÚfig
.
idËmode
 = 0;

658 
cÚfig
.
Ï‹ncy
 = 
NULL
;

659 
cÚfig
.
ş›Ás
 = 
	`li¡C»©e
();

660 
cÚfig
.
ho¡
 = "127.0.0.1";

661 
cÚfig
.
ho¡pÜt
 = 6379;

662 
cÚfig
.
ho¡sock‘
 = 
NULL
;

663 
cÚfig
.
‹¡s
 = 
NULL
;

664 
cÚfig
.
dbnum
 = 0;

665 
cÚfig
.
auth
 = 
NULL
;

667 
i
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

668 
¬gc
 -ğ
i
;

669 
¬gv
 +ğ
i
;

671 
cÚfig
.
Ï‹ncy
 = 
	`zm®loc
(()*cÚfig.
»que¡s
);

673 ià(
cÚfig
.
k“·live
 == 0) {

674 
	`´štf
("WARNING: keepalive disabled, you…robably‚eed 'echo 1 > /proc/sys/net/ipv4/tcp_tw_reuse' for Linux‡nd 'sudo sysctl -w‚et.inet.tcp.msl=1000' for Mac OS X in ordero use‡†ot of clients/requests\n");

677 ià(
cÚfig
.
idËmode
) {

678 
	`´štf
("C»©šg %d idË cÚÃùiÚ ªd wa™šg fÜev” (CŒl+C wh’ dÚe)\n", 
cÚfig
.
numş›Ás
);

679 
c
 = 
	`ü—‹Cl›Á
("",0,
NULL
);

680 
	`ü—‹MissšgCl›Ás
(
c
);

681 
	`«Maš
(
cÚfig
.
–
);

686 ià(
¬gc
) {

687 
sds
 
t™Ë
 = 
	`sd¢ew
(
¬gv
[0]);

688 
i
 = 1; i < 
¬gc
; i++) {

689 
t™Ë
 = 
	`sdsÿ’
(title, " ", 1);

690 
t™Ë
 = 
	`sdsÿ’
Ñ™Ë, (*)
¬gv
[
i
], 
	`¡¾’
(argv[i]));

694 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,
¬gc
,
¬gv
,
NULL
);

695 
	`b’chm¬k
(
t™Ë
,
cmd
,
Ën
);

696 
	`ä“
(
cmd
);

697 } 
cÚfig
.
loİ
);

703 
d©a
 = 
	`zm®loc
(
cÚfig
.
d©asize
+1);

705 
	`mem£t
(
d©a
,'x',
cÚfig
.
d©asize
);

706 
d©a
[
cÚfig
.
d©asize
] = '\0';

708 ià(
	`‹¡_is_£Ëùed
("ping_inline") ||est_is_selected("ping"))

709 
	`b’chm¬k
("PING_INLINE","PING\r\n",6);

711 ià(
	`‹¡_is_£Ëùed
("ping_mbulk") ||est_is_selected("ping")) {

712 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"PING");

713 
	`b’chm¬k
("PING_BULK",
cmd
,
Ën
);

714 
	`ä“
(
cmd
);

717 ià(
	`‹¡_is_£Ëùed
("set")) {

718 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SET key:__¿nd_št__ %s",
d©a
);

719 
	`b’chm¬k
("SET",
cmd
,
Ën
);

720 
	`ä“
(
cmd
);

723 ià(
	`‹¡_is_£Ëùed
("get")) {

724 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"GET key:__rand_int__");

725 
	`b’chm¬k
("GET",
cmd
,
Ën
);

726 
	`ä“
(
cmd
);

729 ià(
	`‹¡_is_£Ëùed
("incr")) {

730 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"INCR counter:__rand_int__");

731 
	`b’chm¬k
("INCR",
cmd
,
Ën
);

732 
	`ä“
(
cmd
);

735 ià(
	`‹¡_is_£Ëùed
("lpush")) {

736 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

737 
	`b’chm¬k
("LPUSH",
cmd
,
Ën
);

738 
	`ä“
(
cmd
);

741 ià(
	`‹¡_is_£Ëùed
("lpop")) {

742 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPOP mylist");

743 
	`b’chm¬k
("LPOP",
cmd
,
Ën
);

744 
	`ä“
(
cmd
);

747 ià(
	`‹¡_is_£Ëùed
("sadd")) {

748 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,

750 
	`b’chm¬k
("SADD",
cmd
,
Ën
);

751 
	`ä“
(
cmd
);

754 ià(
	`‹¡_is_£Ëùed
("spop")) {

755 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"SPOP myset");

756 
	`b’chm¬k
("SPOP",
cmd
,
Ën
);

757 
	`ä“
(
cmd
);

760 ià(
	`‹¡_is_£Ëùed
("lrange") ||

761 
	`‹¡_is_£Ëùed
("lrange_100") ||

762 
	`‹¡_is_£Ëùed
("lrange_300") ||

763 
	`‹¡_is_£Ëùed
("lrange_500") ||

764 
	`‹¡_is_£Ëùed
("lrange_600"))

766 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LPUSH myli¡ %s",
d©a
);

767 
	`b’chm¬k
("LPUSH (ÃededØb’chm¬k LRANGE)",
cmd
,
Ën
);

768 
	`ä“
(
cmd
);

771 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_100")) {

772 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 99");

773 
	`b’chm¬k
("LRANGE_100 (fœ¡ 100ƒËm’ts)",
cmd
,
Ën
);

774 
	`ä“
(
cmd
);

777 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_300")) {

778 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 299");

779 
	`b’chm¬k
("LRANGE_300 (fœ¡ 300ƒËm’ts)",
cmd
,
Ën
);

780 
	`ä“
(
cmd
);

783 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_500")) {

784 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 449");

785 
	`b’chm¬k
("LRANGE_500 (fœ¡ 450ƒËm’ts)",
cmd
,
Ën
);

786 
	`ä“
(
cmd
);

789 ià(
	`‹¡_is_£Ëùed
("lrange") ||est_is_selected("lrange_600")) {

790 
Ën
 = 
	`»disFÜm©Commªd
(&
cmd
,"LRANGE mylist 0 599");

791 
	`b’chm¬k
("LRANGE_600 (fœ¡ 600ƒËm’ts)",
cmd
,
Ën
);

792 
	`ä“
(
cmd
);

795 ià(
	`‹¡_is_£Ëùed
("mset")) {

796 cÚ¡ *
¬gv
[21];

797 
¬gv
[0] = "MSET";

798 
i
 = 1; i < 21; i += 2) {

799 
¬gv
[
i
] = "key:__rand_int__";

800 
¬gv
[
i
+1] = 
d©a
;

802 
Ën
 = 
	`»disFÜm©CommªdArgv
(&
cmd
,21,
¬gv
,
NULL
);

803 
	`b’chm¬k
("MSET (10 keys)",
cmd
,
Ën
);

804 
	`ä“
(
cmd
);

807 ià(!
cÚfig
.
csv
è
	`´štf
("\n");

808 } 
cÚfig
.
loİ
);

811 
	}
}

	@redis-check-aof.c

31 
	~"fmaüos.h
"

32 
	~<¡dlib.h
>

33 
	~<¡dio.h
>

34 
	~<¡ršg.h
>

35 
	~<uni¡d.h
>

36 
	~<sys/¡©.h
>

37 
	~"cÚfig.h
"

39 
	#ERROR
(...) { \

40 
__buf
[1024]; \

41 
	`¥rštf
(
__buf
, 
__VA_ARGS__
); \

42 
	`¥rštf
(
”rÜ
, "0x%16Îx: %s", ()
•os
, 
__buf
); \

43 }

	)

45 
	g”rÜ
[1024];

46 
off_t
 
	g•os
;

48 
	$cÚsumeNewlše
(*
buf
) {

49 ià(
	`¡ºcmp
(
buf
,"\r\n",2) != 0) {

50 
	`ERROR
("Ex³ùed \\r\\n, gÙ: %02x%02x",
buf
[0],buf[1]);

54 
	}
}

56 
	$»adLÚg
(
FILE
 *
å
, 
´efix
, *
rg‘
) {

57 
buf
[128], *
•Œ
;

58 
•os
 = 
	`á–lo
(
å
);

59 ià(
	`fg‘s
(
buf
,(buf),
å
è=ğ
NULL
) {

62 ià(
buf
[0] !ğ
´efix
) {

63 
	`ERROR
("Ex³ùed…»fix '%c', gÙ: '%c'",
buf
[0],
´efix
);

66 *
rg‘
 = 
	`¡¹Ş
(
buf
+1,&
•Œ
,10);

67  
	`cÚsumeNewlše
(
•Œ
);

68 
	}
}

70 
	$»adBy‹s
(
FILE
 *
å
, *
rg‘
, 
Ëngth
) {

71 
»®
;

72 
•os
 = 
	`á–lo
(
å
);

73 
»®
 = 
	`ä—d
(
rg‘
,1,
Ëngth
,
å
);

74 ià(
»®
 !ğ
Ëngth
) {

75 
	`ERROR
("Ex³ùedØ»ad %ld by‹s, gÙ %ld by‹s",
Ëngth
,
»®
);

79 
	}
}

81 
	$»adSŒšg
(
FILE
 *
å
, ** 
rg‘
) {

82 
Ën
;

83 *
rg‘
 = 
NULL
;

84 ià(!
	`»adLÚg
(
å
,'$',&
Ën
)) {

89 
Ën
 += 2;

90 *
rg‘
 = (*)
	`m®loc
(
Ën
);

91 ià(!
	`»adBy‹s
(
å
,*
rg‘
,
Ën
)) {

94 ià(!
	`cÚsumeNewlše
(*
rg‘
+
Ën
-2)) {

97 (*
rg‘
)[
Ën
-2] = '\0';

99 
	}
}

101 
	$»adArgc
(
FILE
 *
å
, *
rg‘
) {

102  
	`»adLÚg
(
å
,'*',
rg‘
);

103 
	}
}

105 
off_t
 
	$´oûss
(
FILE
 *
å
) {

106 
¬gc
;

107 
off_t
 
pos
 = 0;

108 
i
, 
muÉi
 = 0;

109 *
¡r
;

112 ià(!
muÉi
è
pos
 = 
	`á–lo
(
å
);

113 ià(!
	`»adArgc
(
å
, &
¬gc
)) ;

115 
i
 = 0; i < 
¬gc
; i++) {

116 ià(!
	`»adSŒšg
(
å
,&
¡r
)) ;

117 ià(
i
 == 0) {

118 ià(
	`¡rÿ£cmp
(
¡r
, "multi") == 0) {

119 ià(
muÉi
++) {

120 
	`ERROR
("Unexpected MULTI");

123 } ià(
	`¡rÿ£cmp
(
¡r
, "exec") == 0) {

124 ià(--
muÉi
) {

125 
	`ERROR
("Unexpected EXEC");

130 
	`ä“
(
¡r
);

134 ià(
i
 < 
¬gc
) {

135 ià(
¡r
è
	`ä“
(str);

140 ià(
	`ãof
(
å
è&& 
muÉi
 && 
	`¡¾’
(
”rÜ
) == 0) {

141 
	`ERROR
("Reached EOF before„eading EXEC for MULTI");

143 ià(
	`¡¾’
(
”rÜ
) > 0) {

144 
	`´štf
("%s\n", 
”rÜ
);

146  
pos
;

147 
	}
}

149 
	$maš
(
¬gc
, **
¬gv
) {

150 *
f’ame
;

151 
fix
 = 0;

153 ià(
¬gc
 < 2) {

154 
	`´štf
("U§ge: % [--fix] <fe.aof>\n", 
¬gv
[0]);

155 
	`ex™
(1);

156 } ià(
¬gc
 == 2) {

157 
f’ame
 = 
¬gv
[1];

158 } ià(
¬gc
 == 3) {

159 ià(
	`¡rcmp
(
¬gv
[1],"--fix") != 0) {

160 
	`´štf
("Inv®id‡rgum’t: %s\n", 
¬gv
[1]);

161 
	`ex™
(1);

163 
f’ame
 = 
¬gv
[2];

164 
fix
 = 1;

166 
	`´štf
("Invalid‡rguments\n");

167 
	`ex™
(1);

170 
FILE
 *
å
 = 
	`fİ’
(
f’ame
,"r+");

171 ià(
å
 =ğ
NULL
) {

172 
	`´štf
("CªnÙ o³Àfe: %s\n", 
f’ame
);

173 
	`ex™
(1);

176 
»dis_¡©
 
sb
;

177 ià(
	`»dis_f¡©
(
	`f’o
(
å
),&
sb
) == -1) {

178 
	`´štf
("CªnÙ sˆfe: %s\n", 
f’ame
);

179 
	`ex™
(1);

182 
off_t
 
size
 = 
sb
.
¡_size
;

183 ià(
size
 == 0) {

184 
	`´štf
("Em±y fe: %s\n", 
f’ame
);

185 
	`ex™
(1);

188 
off_t
 
pos
 = 
	`´oûss
(
å
);

189 
off_t
 
diff
 = 
size
-
pos
;

190 
	`´štf
("AOF‡nalyzed: size=%lld, ok_up_to=%lld, diff=%lld\n",

191 (è
size
, (è
pos
, (è
diff
);

192 ià(
diff
 > 0) {

193 ià(
fix
) {

194 
buf
[2];

195 
	`´štf
("Thi wÈshrškhAOF from %Îd by‹s, w™h %Îd by‹s,Ø%Îd by‹s\n",()
size
,()
diff
,()
pos
);

196 
	`´štf
("Continue? [y/N]: ");

197 ià(
	`fg‘s
(
buf
,(buf),
¡dš
è=ğ
NULL
 ||

198 
	`¡ºÿ£cmp
(
buf
,"y",1) != 0) {

199 
	`´štf
("Aborting...\n");

200 
	`ex™
(1);

202 ià(
	`árunÿ‹
(
	`f’o
(
å
), 
pos
) == -1) {

203 
	`´štf
("Failedoruncate AOF\n");

204 
	`ex™
(1);

206 
	`´štf
("Successfullyruncated AOF\n");

209 
	`´štf
("AOF is‚ot valid\n");

210 
	`ex™
(1);

213 
	`´štf
("AOF is valid\n");

216 
	`fşo£
(
å
);

218 
	}
}

	@redis-check-dump.c

32 
	~<¡dlib.h
>

33 
	~<¡dio.h
>

34 
	~<uni¡d.h
>

35 
	~<fú.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/mmª.h
>

38 
	~<¡ršg.h
>

39 
	~<¬·/š‘.h
>

40 
	~<¡dšt.h
>

41 
	~<lim™s.h
>

42 
	~"lzf.h
"

43 
	~"üc64.h
"

46 
	#REDIS_STRING
 0

	)

47 
	#REDIS_LIST
 1

	)

48 
	#REDIS_SET
 2

	)

49 
	#REDIS_ZSET
 3

	)

50 
	#REDIS_HASH
 4

	)

51 
	#REDIS_HASH_ZIPMAP
 9

	)

52 
	#REDIS_LIST_ZIPLIST
 10

	)

53 
	#REDIS_SET_INTSET
 11

	)

54 
	#REDIS_ZSET_ZIPLIST
 12

	)

55 
	#REDIS_HASH_ZIPLIST
 13

	)

60 
	#REDIS_ENCODING_RAW
 0

	)

61 
	#REDIS_ENCODING_INT
 1

	)

62 
	#REDIS_ENCODING_ZIPMAP
 2

	)

63 
	#REDIS_ENCODING_HT
 3

	)

66 
	#REDIS_EXPIRETIME_MS
 252

	)

67 
	#REDIS_EXPIRETIME
 253

	)

68 
	#REDIS_SELECTDB
 254

	)

69 
	#REDIS_EOF
 255

	)

84 
	#REDIS_RDB_6BITLEN
 0

	)

85 
	#REDIS_RDB_14BITLEN
 1

	)

86 
	#REDIS_RDB_32BITLEN
 2

	)

87 
	#REDIS_RDB_ENCVAL
 3

	)

88 
	#REDIS_RDB_LENERR
 
UINT_MAX


	)

93 
	#REDIS_RDB_ENC_INT8
 0

	)

94 
	#REDIS_RDB_ENC_INT16
 1

	)

95 
	#REDIS_RDB_ENC_INT32
 2

	)

96 
	#REDIS_RDB_ENC_LZF
 3

	)

98 
	#ERROR
(...) { \

99 
	`´štf
(
__VA_ARGS__
); \

100 
	`ex™
(1); \

101 }

	)

105 *
	md©a
;

106 
size_t
 
	msize
;

107 
size_t
 
	moff£t
;

108 } 
	tpos
;

110 
	gËv–
 = 0;

111 
pos
 
	gpos™iÚs
[16];

113 
	#CURR_OFFSET
 (
pos™iÚs
[
Ëv–
].
off£t
)

	)

117 
	m”rÜ
[16][1024];

118 
size_t
 
	moff£t
[16];

119 
size_t
 
	mËv–
;

120 } 
	t”rÜs_t
;

121 
”rÜs_t
 
	g”rÜs
;

123 
	#SHIFT_ERROR
(
´ovided_off£t
, ...) { \

124 
	`¥rštf
(
”rÜs
.
”rÜ
[”rÜs.
Ëv–
], 
__VA_ARGS__
); \

125 
”rÜs
.
off£t
[”rÜs.
Ëv–
] = 
´ovided_off£t
; \

126 
”rÜs
.
Ëv–
++; \

127 }

	)

131 * 
	mkey
;

132 
	mty³
;

133 
	msucûss
;

134 } 
	t’Œy
;

139 
	gR_Z”o
, 
	gR_PosInf
, 
	gR_NegInf
, 
	gR_Nª
;

141 
	#MAX_TYPES_NUM
 256

	)

142 
	#MAX_TYPE_NAME_LEN
 16

	)

144 
	gty³s
[
MAX_TYPES_NUM
][
MAX_TYPE_NAME_LEN
];

147 
	$checkTy³
(
t
) {

151 (
t
 >ğ
REDIS_HASH_ZIPMAP
 && <ğ
REDIS_HASH_ZIPLIST
) ||

152 
t
 <ğ
REDIS_HASH
 ||

153 
t
 >ğ
REDIS_EXPIRETIME_MS
;

154 
	}
}

157 
	$»adBy‹s
(*
rg‘
, 
num
) {

158 
³ek
 = (
num
 < 0) ? 1 : 0;

159 
num
 = (num < 0) ? -num :‚um;

161 
pos
 
p
 = 
pos™iÚs
[
Ëv–
];

162 ià(
p
.
off£t
 + 
num
 >….
size
) {

165 
	`memıy
(
rg‘
, (*)((
size_t
)
p
.
d©a
 +….
off£t
), 
num
);

166 ià(!
³ek
è
pos™iÚs
[
Ëv–
].
off£t
 +ğ
num
;

169 
	}
}

171 
	$´oûssH—d”
() {

172 
buf
[10] = "_________";

173 
dump_v”siÚ
;

175 ià(!
	`»adBy‹s
(
buf
, 9)) {

176 
	`ERROR
("Cannot„ead header\n");

180 ià(
	`memcmp
(
buf
,"REDIS",5) != 0) {

181 
	`ERROR
("Wrong signature in header\n");

184 
dump_v”siÚ
 = ()
	`¡¹Ş
(
buf
 + 5, 
NULL
, 10);

185 ià(
dump_v”siÚ
 < 1 || dump_version > 6) {

186 
	`ERROR
("UnknowÀRDB fÜm© v”siÚ: %d\n", 
dump_v”siÚ
);

188  
dump_v”siÚ
;

189 
	}
}

191 
	$lßdTy³
(
’Œy
 *
e
) {

192 
ušt32_t
 
off£t
 = 
CURR_OFFSET
;

195 
t
;

196 ià(
	`»adBy‹s
(&
t
, 1)) {

197 ià(
	`checkTy³
(
t
)) {

198 
e
->
ty³
 = 
t
;

201 
	`SHIFT_ERROR
(
off£t
, "UnknowÀty³ (0x%02x)", 
t
);

204 
	`SHIFT_ERROR
(
off£t
, "Could‚ot„eadype");

209 
	}
}

211 
	$³ekTy³
() {

212 
t
;

213 ià(
	`»adBy‹s
(&
t
, -1è&& (
	`checkTy³
(t)))

214  
t
;

216 
	}
}

219 
	$´oûssTime
(
ty³
) {

220 
ušt32_t
 
off£t
 = 
CURR_OFFSET
;

221 
t
[8];

222 
tim–’
 = (
ty³
 =ğ
REDIS_EXPIRETIME_MS
) ? 8 : 4;

224 ià(
	`»adBy‹s
(
t
,
tim–’
)) {

227 
	`SHIFT_ERROR
(
off£t
, "Could‚ot„eadime");

232 
	}
}

234 
ušt32_t
 
	$lßdL’gth
(*
i£ncoded
) {

235 
buf
[2];

236 
ušt32_t
 
Ën
;

237 
ty³
;

239 ià(
i£ncoded
) *isencoded = 0;

240 ià(!
	`»adBy‹s
(
buf
, 1)è 
REDIS_RDB_LENERR
;

241 
ty³
 = (
buf
[0] & 0xC0) >> 6;

242 ià(
ty³
 =ğ
REDIS_RDB_6BITLEN
) {

244  
buf
[0] & 0x3F;

245 } ià(
ty³
 =ğ
REDIS_RDB_ENCVAL
) {

247 ià(
i£ncoded
) *isencoded = 1;

248  
buf
[0] & 0x3F;

249 } ià(
ty³
 =ğ
REDIS_RDB_14BITLEN
) {

251 ià(!
	`»adBy‹s
(
buf
+1,1)è 
REDIS_RDB_LENERR
;

252  ((
buf
[0] & 0x3F) << 8) | buf[1];

255 ià(!
	`»adBy‹s
(&
Ën
, 4)è 
REDIS_RDB_LENERR
;

256  ()
	`Áohl
(
Ën
);

258 
	}
}

260 *
	$lßdIÁeg”Objeù
(
’ùy³
) {

261 
ušt32_t
 
off£t
 = 
CURR_OFFSET
;

262 
’c
[4];

263 
v®
;

265 ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT8
) {

266 
ušt8_t
 
v
;

267 ià(!
	`»adBy‹s
(
’c
, 1)è 
NULL
;

268 
v
 = 
’c
[0];

269 
v®
 = (
št8_t
)
v
;

270 } ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT16
) {

271 
ušt16_t
 
v
;

272 ià(!
	`»adBy‹s
(
’c
, 2)è 
NULL
;

273 
v
 = 
’c
[0]|(enc[1]<<8);

274 
v®
 = (
št16_t
)
v
;

275 } ià(
’ùy³
 =ğ
REDIS_RDB_ENC_INT32
) {

276 
ušt32_t
 
v
;

277 ià(!
	`»adBy‹s
(
’c
, 4)è 
NULL
;

278 
v
 = 
’c
[0]|(enc[1]<<8)|(enc[2]<<16)|(enc[3]<<24);

279 
v®
 = (
št32_t
)
v
;

281 
	`SHIFT_ERROR
(
off£t
, "UnknowÀš‹g”ƒncodšg (0x%02x)", 
’ùy³
);

282  
NULL
;

286 *
buf
;

287 
buf
 = 
	`m®loc
(() * 128);

288 
	`¥rštf
(
buf
, "%Îd", 
v®
);

289  
buf
;

290 
	}
}

292 * 
	$lßdLzfSŒšgObjeù
() {

293 
¦’
, 
ş’
;

294 *
c
, *
s
;

296 ià((
ş’
 = 
	`lßdL’gth
(
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

297 ià((
¦’
 = 
	`lßdL’gth
(
NULL
)è=ğ
REDIS_RDB_LENERR
)  NULL;

299 
c
 = 
	`m®loc
(
ş’
);

300 ià(!
	`»adBy‹s
(
c
, 
ş’
)) {

301 
	`ä“
(
c
);

302  
NULL
;

305 
s
 = 
	`m®loc
(
¦’
+1);

306 ià(
	`lzf_decom´ess
(
c
,
ş’
,
s
,
¦’
) == 0) {

307 
	`ä“
(
c
); f»e(
s
);

308  
NULL
;

311 
	`ä“
(
c
);

312  
s
;

313 
	}
}

316 * 
	$lßdSŒšgObjeù
() {

317 
ušt32_t
 
off£t
 = 
CURR_OFFSET
;

318 
i£ncoded
;

319 
ušt32_t
 
Ën
;

321 
Ën
 = 
	`lßdL’gth
(&
i£ncoded
);

322 ià(
i£ncoded
) {

323 
Ën
) {

324 
REDIS_RDB_ENC_INT8
:

325 
REDIS_RDB_ENC_INT16
:

326 
REDIS_RDB_ENC_INT32
:

327  
	`lßdIÁeg”Objeù
(
Ën
);

328 
REDIS_RDB_ENC_LZF
:

329  
	`lßdLzfSŒšgObjeù
();

332 
	`SHIFT_ERROR
(
off£t
, "UnknowÀ¡ršgƒncodšg (0x%02x)", 
Ën
);

333  
NULL
;

337 ià(
Ën
 =ğ
REDIS_RDB_LENERR
è 
NULL
;

339 *
buf
 = 
	`m®loc
((è* (
Ën
+1));

340 ià(
buf
 =ğ
NULL
)  NULL;

341 
buf
[
Ën
] = '\0';

342 ià(!
	`»adBy‹s
(
buf
, 
Ën
)) {

343 
	`ä“
(
buf
);

344  
NULL
;

346  
buf
;

347 
	}
}

349 
	$´oûssSŒšgObjeù
(** 
¡Üe
) {

350 
off£t
 = 
CURR_OFFSET
;

351 *
key
 = 
	`lßdSŒšgObjeù
();

352 ià(
key
 =ğ
NULL
) {

353 
	`SHIFT_ERROR
(
off£t
, "Error„eading string object");

354 
	`ä“
(
key
);

358 ià(
¡Üe
 !ğ
NULL
) {

359 *
¡Üe
 = 
key
;

361 
	`ä“
(
key
);

364 
	}
}

366 * 
	$lßdDoubËV®ue
() {

367 
buf
[256];

368 
Ën
;

369 * 
v®
;

371 ià(!
	`»adBy‹s
(&
Ën
,1)è 
NULL
;

373 
v®
 = 
	`m®loc
(());

374 
Ën
) {

375 255: *
v®
 = 
R_NegInf
;  val;

376 254: *
v®
 = 
R_PosInf
;  val;

377 253: *
v®
 = 
R_Nª
;  val;

379 ià(!
	`»adBy‹s
(
buf
, 
Ën
)) {

380 
	`ä“
(
v®
);

381  
NULL
;

383 
buf
[
Ën
] = '\0';

384 
	`ssÿnf
(
buf
, "%lg", 
v®
);

385  
v®
;

387 
	}
}

389 
	$´oûssDoubËV®ue
(** 
¡Üe
) {

390 
off£t
 = 
CURR_OFFSET
;

391 *
v®
 = 
	`lßdDoubËV®ue
();

392 ià(
v®
 =ğ
NULL
) {

393 
	`SHIFT_ERROR
(
off£t
, "Error„eading double value");

394 
	`ä“
(
v®
);

398 ià(
¡Üe
 !ğ
NULL
) {

399 *
¡Üe
 = 
v®
;

401 
	`ä“
(
v®
);

404 
	}
}

406 
	$lßdPaœ
(
’Œy
 *
e
) {

407 
ušt32_t
 
off£t
 = 
CURR_OFFSET
;

408 
ušt32_t
 
i
;

411 *
key
;

412 ià(
	`´oûssSŒšgObjeù
(&
key
)) {

413 
e
->
key
 = key;

415 
	`SHIFT_ERROR
(
off£t
, "Error„eadingƒntry key");

419 
ušt32_t
 
Ëngth
 = 0;

420 ià(
e
->
ty³
 =ğ
REDIS_LIST
 ||

421 
e
->
ty³
 =ğ
REDIS_SET
 ||

422 
e
->
ty³
 =ğ
REDIS_ZSET
 ||

423 
e
->
ty³
 =ğ
REDIS_HASH
) {

424 ià((
Ëngth
 = 
	`lßdL’gth
(
NULL
)è=ğ
REDIS_RDB_LENERR
) {

425 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšg % Ëngth", 
ty³s
[
e
->
ty³
]);

430 
e
->
ty³
) {

431 
REDIS_STRING
:

432 
REDIS_HASH_ZIPMAP
:

433 
REDIS_LIST_ZIPLIST
:

434 
REDIS_SET_INTSET
:

435 
REDIS_ZSET_ZIPLIST
:

436 
REDIS_HASH_ZIPLIST
:

437 ià(!
	`´oûssSŒšgObjeù
(
NULL
)) {

438 
	`SHIFT_ERROR
(
off£t
, "Error„eadingƒntry value");

442 
REDIS_LIST
:

443 
REDIS_SET
:

444 
i
 = 0; i < 
Ëngth
; i++) {

445 
off£t
 = 
CURR_OFFSET
;

446 ià(!
	`´oûssSŒšgObjeù
(
NULL
)) {

447 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšgƒËm’ˆ© index %d (Ëngth: %d)", 
i
, 
Ëngth
);

452 
REDIS_ZSET
:

453 
i
 = 0; i < 
Ëngth
; i++) {

454 
off£t
 = 
CURR_OFFSET
;

455 ià(!
	`´oûssSŒšgObjeù
(
NULL
)) {

456 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšgƒËm’ˆkey‡ˆšdex %d (Ëngth: %d)", 
i
, 
Ëngth
);

459 
off£t
 = 
CURR_OFFSET
;

460 ià(!
	`´oûssDoubËV®ue
(
NULL
)) {

461 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšgƒËm’ˆv®u© index %d (Ëngth: %d)", 
i
, 
Ëngth
);

466 
REDIS_HASH
:

467 
i
 = 0; i < 
Ëngth
; i++) {

468 
off£t
 = 
CURR_OFFSET
;

469 ià(!
	`´oûssSŒšgObjeù
(
NULL
)) {

470 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšgƒËm’ˆkey‡ˆšdex %d (Ëngth: %d)", 
i
, 
Ëngth
);

473 
off£t
 = 
CURR_OFFSET
;

474 ià(!
	`´oûssSŒšgObjeù
(
NULL
)) {

475 
	`SHIFT_ERROR
(
off£t
, "E¼Ü„—dšgƒËm’ˆv®u© index %d (Ëngth: %d)", 
i
, 
Ëngth
);

481 
	`SHIFT_ERROR
(
off£t
, "Type‚ot implemented");

485 
e
->
sucûss
 = 1;

487 
	}
}

489 
’Œy
 
	$lßdEÁry
() {

490 
’Œy
 
e
 = { 
NULL
, -1, 0 };

491 
ušt32_t
 
Ëngth
, 
off£t
[4];

494 
”rÜs
.
Ëv–
 = 0;

496 
off£t
[0] = 
CURR_OFFSET
;

497 ià(!
	`lßdTy³
(&
e
)) {

498  
e
;

501 
off£t
[1] = 
CURR_OFFSET
;

502 ià(
e
.
ty³
 =ğ
REDIS_SELECTDB
) {

503 ià((
Ëngth
 = 
	`lßdL’gth
(
NULL
)è=ğ
REDIS_RDB_LENERR
) {

504 
	`SHIFT_ERROR
(
off£t
[1], "Error„eading database‚umber");

505  
e
;

507 ià(
Ëngth
 > 63) {

508 
	`SHIFT_ERROR
(
off£t
[1], "D©aba£‚umb” ouˆoà¿ng(%d)", 
Ëngth
);

509  
e
;

511 } ià(
e
.
ty³
 =ğ
REDIS_EOF
) {

512 ià(
pos™iÚs
[
Ëv–
].
off£t
 <…os™iÚs[Ëv–].
size
) {

513 
	`SHIFT_ERROR
(
off£t
[0], "Unexpected EOF");

515 
e
.
sucûss
 = 1;

517  
e
;

520 ià(
e
.
ty³
 =ğ
REDIS_EXPIRETIME
 ||

521 
e
.
ty³
 =ğ
REDIS_EXPIRETIME_MS
) {

522 ià(!
	`´oûssTime
(
e
.
ty³
)) ƒ;

523 ià(!
	`lßdTy³
(&
e
)) ƒ;

526 
off£t
[1] = 
CURR_OFFSET
;

527 ià(!
	`lßdPaœ
(&
e
)) {

528 
	`SHIFT_ERROR
(
off£t
[1], "E¼Ü fÜy³ %s", 
ty³s
[
e
.
ty³
]);

529  
e
;

535 
off£t
[2] = 
CURR_OFFSET
;

536 ià(
	`³ekTy³
() == -1) {

537 
	`SHIFT_ERROR
(
off£t
[2], "Followed by invalidype");

538 
	`SHIFT_ERROR
(
off£t
[0], "E¼Ü fÜy³ %s", 
ty³s
[
e
.
ty³
]);

539 
e
.
sucûss
 = 0;

541 
e
.
sucûss
 = 1;

544  
e
;

545 
	}
}

547 
	$´štC’‹»d
(
šd’t
, 
width
, * 
body
) {

548 
h—d
[256], 

[256];

549 
	`mem£t
(
h—d
, '\0', 256);

550 
	`mem£t
(

, '\0', 256);

552 
	`mem£t
(
h—d
, '=', 
šd’t
);

553 
	`mem£t
(

, '=', 
width
 - 2 - 
šd’t
 - 
	`¡¾’
(
body
));

554 
	`´štf
("% % %s\n", 
h—d
, 
body
, 

);

555 
	}
}

557 
	$´štV®id
(
ušt64_t
 
İs
, ušt64_ˆ
by‹s
) {

558 
body
[80];

559 
	`¥rštf
(
body
, "Processed %llu valid opcodes (in %llu bytes)",

560 (è
İs
, (è
by‹s
);

561 
	`´štC’‹»d
(4, 80, 
body
);

562 
	}
}

564 
	$´štSk³d
(
ušt64_t
 
by‹s
, ušt64_ˆ
off£t
) {

565 
body
[80];

566 
	`¥rštf
(
body
, "Skipped %llu bytes (resuming‡t 0x%08llx)",

567 (è
by‹s
, (è
off£t
);

568 
	`´štC’‹»d
(4, 80, 
body
);

569 
	}
}

571 
	$´štE¼ÜSck
(
’Œy
 *
e
) {

572 
i
;

573 
body
[64];

575 ià(
e
->
ty³
 == -1) {

576 
	`¥rštf
(
body
, "Errorrace");

577 } ià(
e
->
ty³
 >= 253) {

578 
	`¥rštf
(
body
, "E¼Ü¿û (%s)", 
ty³s
[
e
->
ty³
]);

579 } ià(!
e
->
key
) {

580 
	`¥rštf
(
body
, "E¼Ü¿û (%s: (unknown))", 
ty³s
[
e
->
ty³
]);

582 
tmp
[41];

583 
	`¡ºıy
(
tmp
, 
e
->
key
, 40);

586 ià(
	`¡¾’
(
e
->
key
) > 40) {

587 
	`mem£t
(&
tmp
[37], '.', 3);

591 
i
 = 0; i < 
	`¡¾’
(
tmp
); i++) {

592 ià(
tmp
[
i
] <= 32)mp[i] = '?';

594 
	`¥rštf
(
body
, "E¼Ü¿û (%s: %s)", 
ty³s
[
e
->
ty³
], 
tmp
);

597 
	`´štC’‹»d
(4, 80, 
body
);

600 
i
 = 0; i < 
”rÜs
.
Ëv–
; i++) {

601 
	`´štf
("0x%08lx - %s\n",

602 (è
”rÜs
.
off£t
[
i
],ƒ¼Üs.
”rÜ
[i]);

604 
	}
}

606 
	$´oûss
() {

607 
ušt64_t
 
num_”rÜs
 = 0, 
num_v®id_İs
 = 0, 
num_v®id_by‹s
 = 0;

608 
’Œy
ƒntry;

609 
dump_v”siÚ
 = 
	`´oûssH—d”
();

612 ià(
dump_v”siÚ
 >= 5) {

613 ià(
pos™iÚs
[0].
size
 < 8) {

614 
	`´štf
("RDB version >= 5 but‚o„oom for checksum.\n");

615 
	`ex™
(1);

617 
pos™iÚs
[0].
size
 -= 8;

620 
Ëv–
 = 1;

621 
pos™iÚs
[0].
off£t
 <…os™iÚs[0].
size
) {

622 
pos™iÚs
[1] =…ositions[0];

624 
’Œy
 = 
	`lßdEÁry
();

625 ià(!
’Œy
.
sucûss
) {

626 
	`´štV®id
(
num_v®id_İs
, 
num_v®id_by‹s
);

627 
	`´štE¼ÜSck
(&
’Œy
);

628 
num_”rÜs
++;

629 
num_v®id_İs
 = 0;

630 
num_v®id_by‹s
 = 0;

633 
ušt64_t
 
off£t
 = 
pos™iÚs
[0].offset + 1;

634 
i
 = 0;

636 !
’Œy
.
sucûss
 && 
off£t
 < 
pos™iÚs
[0].
size
) {

637 
pos™iÚs
[1].
off£t
 = offset;

640 
i
 = 0; i < 3; i++) {

641 
’Œy
 = 
	`lßdEÁry
();

642 ià(!
’Œy
.
sucûss
) ;

645 ià(
i
 < 3) {

646 
off£t
++;

651 ià(
off£t
 < 
pos™iÚs
[0].
size
) {

652 
	`´štSk³d
(
off£t
 - 
pos™iÚs
[0].offset, offset);

655 
pos™iÚs
[0].
off£t
 = offset;

657 
num_v®id_İs
++;

658 
num_v®id_by‹s
 +ğ
pos™iÚs
[1].
off£t
 -…ositions[0].offset;

661 
pos™iÚs
[0] =…ositions[1];

663 
	`ä“
(
’Œy
.
key
);

668 
	`´štV®id
(
num_v®id_İs
, 
num_v®id_by‹s
);

671 ià(
’Œy
.
ty³
 !ğ
REDIS_EOF
) {

673 
”rÜs
.
Ëv–
 = 0;

674 
	`SHIFT_ERROR
(
pos™iÚs
[0].
off£t
, "Ex³ùed EOF, gÙ %s", 
ty³s
[
’Œy
.
ty³
]);

677 
’Œy
.
ty³
 = -1;

678 
	`´štE¼ÜSck
(&
’Œy
);

680 
num_”rÜs
++;

684 ià(
dump_v”siÚ
 >= 5) {

685 
ušt64_t
 
üc
 = 
	`üc64
(0,
pos™iÚs
[0].
d©a
,pos™iÚs[0].
size
);

686 
ušt64_t
 
üc2
;

687 *
p
 = (*)
pos™iÚs
[0].
d©a
+pos™iÚs[0].
size
;

688 
üc2
 = ((
ušt64_t
)
p
[0] << 0) |

689 ((
ušt64_t
)
p
[1] << 8) |

690 ((
ušt64_t
)
p
[2] << 16) |

691 ((
ušt64_t
)
p
[3] << 24) |

692 ((
ušt64_t
)
p
[4] << 32) |

693 ((
ušt64_t
)
p
[5] << 40) |

694 ((
ušt64_t
)
p
[6] << 48) |

695 ((
ušt64_t
)
p
[7] << 56);

696 ià(
üc
 !ğ
üc2
) {

697 
	`SHIFT_ERROR
(
pos™iÚs
[0].
off£t
, "RDB CRC64 does‚ot match.");

699 
	`´štf
("CRC64 checksum is OK\n");

704 ià(
num_”rÜs
) {

705 
	`´štf
("\n");

706 
	`´štf
("Total unprocessable opcodes: %llu\n",

707 (è
num_”rÜs
);

709 
	}
}

711 
	$maš
(
¬gc
, **
¬gv
) {

713 ià(
¬gc
 <= 1) {

714 
	`´štf
("U§ge: % <dump.rdb>\n", 
¬gv
[0]);

715 
	`ex™
(0);

718 
fd
;

719 
off_t
 
size
;

720 
¡©
 stat;

721 *
d©a
;

723 
fd
 = 
	`İ’
(
¬gv
[1], 
O_RDONLY
);

724 ià(
fd
 < 1) {

725 
	`ERROR
("CªnÙ o³Àfe: %s\n", 
¬gv
[1]);

727 ià(
	`f¡©
(
fd
, &
¡©
) == -1) {

728 
	`ERROR
("CªnÙ st: %s\n", 
¬gv
[1]);

730 
size
 = 
¡©
.
¡_size
;

733 ià((
size_t
è=ğ(
št32_t
è&& 
size
 >ğ
INT_MAX
) {

734 
	`ERROR
("Cannot check dump files >2GB on‡ 32-bit…latform\n");

737 
d©a
 = 
	`mm­
(
NULL
, 
size
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 0);

738 ià(
d©a
 =ğ
MAP_FAILED
) {

739 
	`ERROR
("CªnÙ mm­: %s\n", 
¬gv
[1]);

743 
pos™iÚs
[0].
d©a
 = data;

744 
pos™iÚs
[0].
size
 = size;

745 
pos™iÚs
[0].
off£t
 = 0;

746 
”rÜs
.
Ëv–
 = 0;

749 
	`¥rštf
(
ty³s
[
REDIS_STRING
], "STRING");

750 
	`¥rštf
(
ty³s
[
REDIS_LIST
], "LIST");

751 
	`¥rštf
(
ty³s
[
REDIS_SET
], "SET");

752 
	`¥rštf
(
ty³s
[
REDIS_ZSET
], "ZSET");

753 
	`¥rštf
(
ty³s
[
REDIS_HASH
], "HASH");

756 
	`¥rštf
(
ty³s
[
REDIS_EXPIRETIME
], "EXPIRETIME");

757 
	`¥rštf
(
ty³s
[
REDIS_SELECTDB
], "SELECTDB");

758 
	`¥rštf
(
ty³s
[
REDIS_EOF
], "EOF");

761 
R_Z”o
 = 0.0;

762 
R_PosInf
 = 1.0/
R_Z”o
;

763 
R_NegInf
 = -1.0/
R_Z”o
;

764 
R_Nª
 = 
R_Z”o
/R_Zero;

766 
	`´oûss
();

768 
	`munm­
(
d©a
, 
size
);

769 
	`şo£
(
fd
);

771 
	}
}

	@redis-cli.c

31 
	~"fmaüos.h
"

32 
	~"v”siÚ.h
"

34 
	~<¡dio.h
>

35 
	~<¡ršg.h
>

36 
	~<¡dlib.h
>

37 
	~<sigÇl.h
>

38 
	~<uni¡d.h
>

39 
	~<time.h
>

40 
	~<ùy³.h
>

41 
	~<”ºo.h
>

42 
	~<sys/¡©.h
>

43 
	~<sys/time.h
>

44 
	~<as£¹.h
>

45 
	~<fú.h
>

46 
	~<lim™s.h
>

47 
	~<m©h.h
>

49 
	~"hœedis.h
"

50 
	~"sds.h
"

51 
	~"zm®loc.h
"

52 
	~"lš’oi£.h
"

53 
	~"h–p.h
"

54 
	~"ª‘.h
"

55 
	~"«.h
"

57 
	#REDIS_NOTUSED
(
V
è((èV)

	)

59 
	#OUTPUT_STANDARD
 0

	)

60 
	#OUTPUT_RAW
 1

	)

61 
	#OUTPUT_CSV
 2

	)

62 
	#REDIS_CLI_KEEPALIVE_INTERVAL
 15

	)

63 
	#REDIS_CLI_DEFAULT_PIPE_TIMEOUT
 30

	)

64 
	#REDIS_CLI_HISTFILE_ENV
 "REDISCLI_HISTFILE"

	)

65 
	#REDIS_CLI_HISTFILE_DEFAULT
 ".»disşi_hi¡Üy"

	)

68 
	g¥eùrum_·Ë‰e_cŞÜ_size
 = 19;

69 
	g¥eùrum_·Ë‰e_cŞÜ
[] = {0,233,234,235,237,239,241,243,245,247,144,143,142,184,226,214,208,202,196};

71 
	g¥eùrum_·Ë‰e_mÚo_size
 = 13;

72 
	g¥eùrum_·Ë‰e_mÚo
[] = {0,233,234,235,237,239,241,243,245,247,249,251,253};

75 *
	g¥eùrum_·Ë‰e
;

76 
	g¥eùrum_·Ë‰e_size
;

78 
»disCÚ‹xt
 *
	gcÚ‹xt
;

79 
	scÚfig
 {

80 *
	mho¡
;

81 
	mho¡pÜt
;

82 *
	mho¡sock‘
;

83 
	m»³©
;

84 
	mš‹rv®
;

85 
	mdbnum
;

86 
	mš‹¿ùive
;

87 
	mshutdown
;

88 
	mmÚ™Ü_mode
;

89 
	mpubsub_mode
;

90 
	mÏ‹ncy_mode
;

91 
	mÏ‹ncy_di¡_mode
;

92 
	mÏ‹ncy_hi¡Üy
;

93 
	mÌu_‹¡_mode
;

94 
	mÌu_‹¡_§m¶e_size
;

95 
	mşu¡”_mode
;

96 
	mşu¡”_»issue_commªd
;

97 
	m¦ave_mode
;

98 
	mpe_mode
;

99 
	mpe_timeout
;

100 
	mg‘rdb_mode
;

101 
	m¡©_mode
;

102 
	msÿn_mode
;

103 
	mšŒšsic_Ï‹ncy_mode
;

104 
	mšŒšsic_Ï‹ncy_du¿tiÚ
;

105 *
	m·‰”n
;

106 *
	mrdb_f’ame
;

107 
	mbigkeys
;

108 
	m¡dš¬g
;

109 *
	mauth
;

110 
	mouut
;

111 
sds
 
	mmb_d–im
;

112 
	m´om±
[128];

113 *
	mev®
;

114 
	mÏ¡_cmd_ty³
;

115 } 
	gcÚfig
;

117 vŞ©
sig_©omic_t
 
	gfÜû_ÿnûl_loİ
 = 0;

118 
u§ge
();

119 
¦aveMode
();

120 *
»disG™SHA1
();

121 *
»disG™Dœty
();

127 
	$u¡ime
() {

128 
timev®
 
tv
;

129 
u¡
;

131 
	`g‘timeofday
(&
tv
, 
NULL
);

132 
u¡
 = (()
tv
.
tv_£c
)*1000000;

133 
u¡
 +ğ
tv
.
tv_u£c
;

134  
u¡
;

135 
	}
}

137 
	$m¡ime
() {

138  
	`u¡ime
()/1000;

139 
	}
}

141 
	$şiReäeshProm±
() {

142 
Ën
;

144 ià(
cÚfig
.
ho¡sock‘
 !ğ
NULL
)

145 
Ën
 = 
	`¢´štf
(
cÚfig
.
´om±
,(config.prompt),"redis %s",

146 
cÚfig
.
ho¡sock‘
);

148 
Ën
 = 
	`¢´štf
(
cÚfig
.
´om±
,(config.prompt),

149 
	`¡rchr
(
cÚfig
.
ho¡
,':') ? "[%s]:%d" : "%s:%d",

150 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

152 ià(
cÚfig
.
dbnum
 !ğ0 && cÚfig.
Ï¡_cmd_ty³
 !ğ
REDIS_REPLY_ERROR
)

153 
Ën
 +ğ
	`¢´štf
(
cÚfig
.
´om±
+len,(config.prompt)-len,"[%d]",

154 
cÚfig
.
dbnum
);

155 
	`¢´štf
(
cÚfig
.
´om±
+
Ën
,(config.prompt)-len,"> ");

156 
	}
}

158 
sds
 
	$g‘Hi¡ÜyP©h
() {

159 *
·th
 = 
NULL
;

160 
sds
 
hi¡ÜyP©h
 = 
NULL
;

163 
·th
 = 
	`g‘’v
(
REDIS_CLI_HISTFILE_ENV
);

164 ià(
·th
 !ğ
NULL
 && *path != '\0') {

165 ià(!
	`¡rcmp
("/dev/nuÎ", 
·th
)) {

166  
NULL
;

170 
hi¡ÜyP©h
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s", 
·th
);

172 *
home
 = 
	`g‘’v
("HOME");

173 ià(
home
 !ğ
NULL
 && *home != '\0') {

175 
hi¡ÜyP©h
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s/%s", 
home
, 
REDIS_CLI_HISTFILE_DEFAULT
);

179  
hi¡ÜyP©h
;

180 
	}
}

186 
	#CLI_HELP_COMMAND
 1

	)

187 
	#CLI_HELP_GROUP
 2

	)

190 
	mty³
;

191 
	m¬gc
;

192 
sds
 *
	m¬gv
;

193 
sds
 
	mfuÎ
;

196 
commªdH–p
 *
	mÜg
;

197 } 
	th–pEÁry
;

199 
h–pEÁry
 *
	gh–pEÁr›s
;

200 
	gh–pEÁr›sL’
;

202 
sds
 
	$şiV”siÚ
() {

203 
sds
 
v”siÚ
;

204 
v”siÚ
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s", 
REDIS_VERSION
);

207 ià(
	`¡¹Şl
(
	`»disG™SHA1
(),
NULL
,16)) {

208 
v”siÚ
 = 
	`sdsÿrštf
(v”siÚ, " (g™:%s", 
	`»disG™SHA1
());

209 ià(
	`¡¹Şl
(
	`»disG™Dœty
(),
NULL
,10))

210 
v”siÚ
 = 
	`sdsÿrštf
(version, "-dirty");

211 
v”siÚ
 = 
	`sdsÿt
(version, ")");

213  
v”siÚ
;

214 
	}
}

216 
	$şiIn™H–p
() {

217 
commªd¦’
 = (
commªdH–p
)/(commandHelp);

218 
group¦’
 = (
commªdGroups
)/(*);

219 
i
, 
Ën
, 
pos
 = 0;

220 
h–pEÁry
 
tmp
;

222 
h–pEÁr›sL’
 = 
Ën
 = 
commªd¦’
+
group¦’
;

223 
h–pEÁr›s
 = 
	`m®loc
((
h–pEÁry
)*
Ën
);

225 
i
 = 0; i < 
group¦’
; i++) {

226 
tmp
.
¬gc
 = 1;

227 
tmp
.
¬gv
 = 
	`m®loc
((
sds
));

228 
tmp
.
¬gv
[0] = 
	`sdsÿrštf
(
	`sd£m±y
(),"@%s",
commªdGroups
[
i
]);

229 
tmp
.
fuÎ
 =mp.
¬gv
[0];

230 
tmp
.
ty³
 = 
CLI_HELP_GROUP
;

231 
tmp
.
Üg
 = 
NULL
;

232 
h–pEÁr›s
[
pos
++] = 
tmp
;

235 
i
 = 0; i < 
commªd¦’
; i++) {

236 
tmp
.
¬gv
 = 
	`sds¥l™¬gs
(
commªdH–p
[
i
].
Çme
,&tmp.
¬gc
);

237 
tmp
.
fuÎ
 = 
	`sd¢ew
(
commªdH–p
[
i
].
Çme
);

238 
tmp
.
ty³
 = 
CLI_HELP_COMMAND
;

239 
tmp
.
Üg
 = &
commªdH–p
[
i
];

240 
h–pEÁr›s
[
pos
++] = 
tmp
;

242 
	}
}

245 
	$şiOuutCommªdH–p
(
commªdH–p
 *
h–p
, 
group
) {

246 
	`´štf
("\r\À \x1b[1m%s\x1b[0m \x1b[90m%s\x1b[0m\r\n", 
h–p
->
Çme
, h–p->
·¿ms
);

247 
	`´štf
(" \x1b[33msumm¬y:\x1b[0m %s\r\n", 
h–p
->
summ¬y
);

248 
	`´štf
(" \x1b[33msšû:\x1b[0m %s\r\n", 
h–p
->
sšû
);

249 ià(
group
) {

250 
	`´štf
(" \x1b[33mgroup:\x1b[0m %s\r\n", 
commªdGroups
[
h–p
->
group
]);

252 
	}
}

255 
	$şiOuutG’”icH–p
() {

256 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

257 
	`´štf
(

263 
v”siÚ


265 
	`sdsä“
(
v”siÚ
);

266 
	}
}

269 
	$şiOuutH–p
(
¬gc
, **
¬gv
) {

270 
i
, 
j
, 
Ën
;

271 
group
 = -1;

272 
h–pEÁry
 *
’Œy
;

273 
commªdH–p
 *
h–p
;

275 ià(
¬gc
 == 0) {

276 
	`şiOuutG’”icH–p
();

278 } ià(
¬gc
 > 0 && 
¬gv
[0][0] == '@') {

279 
Ën
 = (
commªdGroups
)/(*);

280 
i
 = 0; i < 
Ën
; i++) {

281 ià(
	`¡rÿ£cmp
(
¬gv
[0]+1,
commªdGroups
[
i
]) == 0) {

282 
group
 = 
i
;

288 
	`as£¹
(
¬gc
 > 0);

289 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

290 
’Œy
 = &
h–pEÁr›s
[
i
];

291 ià(
’Œy
->
ty³
 !ğ
CLI_HELP_COMMAND
) ;

293 
h–p
 = 
’Œy
->
Üg
;

294 ià(
group
 == -1) {

296 ià(
¬gc
 =ğ
’Œy
->argc) {

297 
j
 = 0; j < 
¬gc
; j++) {

298 ià(
	`¡rÿ£cmp
(
¬gv
[
j
],
’Œy
->argv[j]) != 0) ;

300 ià(
j
 =ğ
¬gc
) {

301 
	`şiOuutCommªdH–p
(
h–p
,1);

305 ià(
group
 =ğ
h–p
->group) {

306 
	`şiOuutCommªdH–p
(
h–p
,0);

310 
	`´štf
("\r\n");

311 
	}
}

313 
	$com¶‘iÚC®lback
(cÚ¡ *
buf
, 
lš’oi£Com¶‘iÚs
 *
lc
) {

314 
size_t
 
¡¬os
 = 0;

315 
mask
;

316 
i
;

317 
size_t
 
m©chËn
;

318 
sds
 
tmp
;

320 ià(
	`¡ºÿ£cmp
(
buf
,"help ",5) == 0) {

321 
¡¬os
 = 5;

322 
	`is¥aû
(
buf
[
¡¬os
])) startpos++;

323 
mask
 = 
CLI_HELP_COMMAND
 | 
CLI_HELP_GROUP
;

325 
mask
 = 
CLI_HELP_COMMAND
;

328 
i
 = 0; i < 
h–pEÁr›sL’
; i++) {

329 ià(!(
h–pEÁr›s
[
i
].
ty³
 & 
mask
)) ;

331 
m©chËn
 = 
	`¡¾’
(
buf
+
¡¬os
);

332 ià(
	`¡ºÿ£cmp
(
buf
+
¡¬os
,
h–pEÁr›s
[
i
].
fuÎ
,
m©chËn
) == 0) {

333 
tmp
 = 
	`sd¢ewËn
(
buf
,
¡¬os
);

334 
tmp
 = 
	`sdsÿt
Ñmp,
h–pEÁr›s
[
i
].
fuÎ
);

335 
	`lš’oi£AddCom¶‘iÚ
(
lc
,
tmp
);

336 
	`sdsä“
(
tmp
);

339 
	}
}

346 
	$şiAuth
() {

347 
»disR•ly
 *
»¶y
;

348 ià(
cÚfig
.
auth
 =ğ
NULL
è 
REDIS_OK
;

350 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"AUTH %s",
cÚfig
.
auth
);

351 ià(
»¶y
 !ğ
NULL
) {

352 
	`ä“R•lyObjeù
(
»¶y
);

353  
REDIS_OK
;

355  
REDIS_ERR
;

356 
	}
}

359 
	$şiS–eù
() {

360 
»disR•ly
 *
»¶y
;

361 ià(
cÚfig
.
dbnum
 =ğ0è 
REDIS_OK
;

363 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SELECT %d",
cÚfig
.
dbnum
);

364 ià(
»¶y
 !ğ
NULL
) {

365 
»suÉ
 = 
REDIS_OK
;

366 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
è
»suÉ
 = 
REDIS_ERR
;

367 
	`ä“R•lyObjeù
(
»¶y
);

368  
»suÉ
;

370  
REDIS_ERR
;

371 
	}
}

375 
	$şiCÚÃù
(
fÜû
) {

376 ià(
cÚ‹xt
 =ğ
NULL
 || 
fÜû
) {

377 ià(
cÚ‹xt
 !ğ
NULL
)

378 
	`»disF»e
(
cÚ‹xt
);

380 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
) {

381 
cÚ‹xt
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

383 
cÚ‹xt
 = 
	`»disCÚÃùUnix
(
cÚfig
.
ho¡sock‘
);

386 ià(
cÚ‹xt
->
”r
) {

387 
	`årštf
(
¡d”r
,"Could‚ot connecto Redis‡t ");

388 ià(
cÚfig
.
ho¡sock‘
 =ğ
NULL
)

389 
	`årštf
(
¡d”r
,"%s:%d: %s\n",
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
,
cÚ‹xt
->
”r¡r
);

391 
	`årštf
(
¡d”r
,"%s: %s\n",
cÚfig
.
ho¡sock‘
,
cÚ‹xt
->
”r¡r
);

392 
	`»disF»e
(
cÚ‹xt
);

393 
cÚ‹xt
 = 
NULL
;

394  
REDIS_ERR
;

401 
	`ª‘K“pAlive
(
NULL
, 
cÚ‹xt
->
fd
, 
REDIS_CLI_KEEPALIVE_INTERVAL
);

404 ià(
	`şiAuth
(è!ğ
REDIS_OK
)

405  
REDIS_ERR
;

406 ià(
	`şiS–eù
(è!ğ
REDIS_OK
)

407  
REDIS_ERR
;

409  
REDIS_OK
;

410 
	}
}

412 
	$şiPrštCÚ‹xtE¼Ü
() {

413 ià(
cÚ‹xt
 =ğ
NULL
) ;

414 
	`årštf
(
¡d”r
,"E¼Ü: %s\n",
cÚ‹xt
->
”r¡r
);

415 
	}
}

417 
sds
 
	$şiFÜm©R•lyTTY
(
»disR•ly
 *
r
, *
´efix
) {

418 
sds
 
out
 = 
	`sd£m±y
();

419 
r
->
ty³
) {

420 
REDIS_REPLY_ERROR
:

421 
out
 = 
	`sdsÿrštf
(out,"Ó¼Üè%s\n", 
r
->
¡r
);

423 
REDIS_REPLY_STATUS
:

424 
out
 = 
	`sdsÿt
(out,
r
->
¡r
);

425 
out
 = 
	`sdsÿt
(out,"\n");

427 
REDIS_REPLY_INTEGER
:

428 
out
 = 
	`sdsÿrštf
(out,"(š‹g”è%Îd\n",
r
->
š‹g”
);

430 
REDIS_REPLY_STRING
:

433 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

434 
out
 = 
	`sdsÿt
(out,"\n");

436 
REDIS_REPLY_NIL
:

437 
out
 = 
	`sdsÿt
(out,"(nil)\n");

439 
REDIS_REPLY_ARRAY
:

440 ià(
r
->
–em’ts
 == 0) {

441 
out
 = 
	`sdsÿt
(out,"(empty†ist or set)\n");

443 
i
, 
idxËn
 = 0;

444 
_´efixËn
[16];

445 
_´efixfmt
[16];

446 
sds
 
_´efix
;

447 
sds
 
tmp
;

450 
i
 = 
r
->
–em’ts
;

452 
idxËn
++;

453 
i
 /= 10;

454 } 
i
);

457 
	`mem£t
(
_´efixËn
,' ',
idxËn
+2);

458 
_´efixËn
[
idxËn
+2] = '\0';

459 
_´efix
 = 
	`sdsÿt
(
	`sd¢ew
(
´efix
),
_´efixËn
);

462 
	`¢´štf
(
_´efixfmt
,(_´efixfmt),"%%s%%%ddè",
idxËn
);

464 
i
 = 0; i < 
r
->
–em’ts
; i++) {

467 
out
 = 
	`sdsÿrštf
(out,
_´efixfmt
,
i
 =ğ0 ? "" : 
´efix
,i+1);

470 
tmp
 = 
	`şiFÜm©R•lyTTY
(
r
->
–em’t
[
i
],
_´efix
);

471 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

472 
	`sdsä“
(
tmp
);

474 
	`sdsä“
(
_´efix
);

478 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

479 
	`ex™
(1);

481  
out
;

482 
	}
}

484 
sds
 
	$şiFÜm©R•lyRaw
(
»disR•ly
 *
r
) {

485 
sds
 
out
 = 
	`sd£m±y
(), 
tmp
;

486 
size_t
 
i
;

488 
r
->
ty³
) {

489 
REDIS_REPLY_NIL
:

492 
REDIS_REPLY_ERROR
:

493 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

494 
out
 = 
	`sdsÿ’
(out,"\n",1);

496 
REDIS_REPLY_STATUS
:

497 
REDIS_REPLY_STRING
:

498 
out
 = 
	`sdsÿ’
(out,
r
->
¡r
,r->
Ën
);

500 
REDIS_REPLY_INTEGER
:

501 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

503 
REDIS_REPLY_ARRAY
:

504 
i
 = 0; i < 
r
->
–em’ts
; i++) {

505 ià(
i
 > 0è
out
 = 
	`sdsÿt
(out,
cÚfig
.
mb_d–im
);

506 
tmp
 = 
	`şiFÜm©R•lyRaw
(
r
->
–em’t
[
i
]);

507 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

508 
	`sdsä“
(
tmp
);

512 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

513 
	`ex™
(1);

515  
out
;

516 
	}
}

518 
sds
 
	$şiFÜm©R•lyCSV
(
»disR•ly
 *
r
) {

519 
i
;

521 
sds
 
out
 = 
	`sd£m±y
();

522 
r
->
ty³
) {

523 
REDIS_REPLY_ERROR
:

524 
out
 = 
	`sdsÿt
(out,"ERROR,");

525 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,
	`¡¾’
(r->str));

527 
REDIS_REPLY_STATUS
:

528 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

530 
REDIS_REPLY_INTEGER
:

531 
out
 = 
	`sdsÿrštf
(out,"%Îd",
r
->
š‹g”
);

533 
REDIS_REPLY_STRING
:

534 
out
 = 
	`sdsÿŒ•r
(out,
r
->
¡r
,r->
Ën
);

536 
REDIS_REPLY_NIL
:

537 
out
 = 
	`sdsÿt
(out,"NIL");

539 
REDIS_REPLY_ARRAY
:

540 
i
 = 0; i < 
r
->
–em’ts
; i++) {

541 
sds
 
tmp
 = 
	`şiFÜm©R•lyCSV
(
r
->
–em’t
[
i
]);

542 
out
 = 
	`sdsÿ’
(out,
tmp
,
	`sd¦’
(tmp));

543 ià(
i
 !ğ
r
->
–em’ts
-1è
out
 = 
	`sdsÿt
(out,",");

544 
	`sdsä“
(
tmp
);

548 
	`årštf
(
¡d”r
,"UnknowÀ»¶yy³: %d\n", 
r
->
ty³
);

549 
	`ex™
(1);

551  
out
;

552 
	}
}

554 
	$şiR—dR•ly
(
ouut_¿w_¡ršgs
) {

555 *
_»¶y
;

556 
»disR•ly
 *
»¶y
;

557 
sds
 
out
 = 
NULL
;

558 
ouut
 = 1;

560 ià(
	`»disG‘R•ly
(
cÚ‹xt
,&
_»¶y
è!ğ
REDIS_OK
) {

561 ià(
cÚfig
.
shutdown
) {

562 
	`»disF»e
(
cÚ‹xt
);

563 
cÚ‹xt
 = 
NULL
;

564  
REDIS_OK
;

566 ià(
cÚfig
.
š‹¿ùive
) {

568 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_IO
 &&

569 (
”ºo
 =ğ
ECONNRESET
 ||ƒ¼nØ=ğ
EPIPE
))

570  
REDIS_ERR
;

571 ià(
cÚ‹xt
->
”r
 =ğ
REDIS_ERR_EOF
)

572  
REDIS_ERR
;

574 
	`şiPrštCÚ‹xtE¼Ü
();

575 
	`ex™
(1);

576  
REDIS_ERR
;

579 
»¶y
 = (
»disR•ly
*)
_»¶y
;

581 
cÚfig
.
Ï¡_cmd_ty³
 = 
»¶y
->
ty³
;

585 ià(
cÚfig
.
şu¡”_mode
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
 &&

586 (!
	`¡ºcmp
(
»¶y
->
¡r
,"MOVED",5è|| !
	`¡rcmp
(reply->str,"ASK")))

588 *
p
 = 
»¶y
->
¡r
, *
s
;

589 
¦Ù
;

591 
ouut
 = 0;

597 
s
 = 
	`¡rchr
(
p
,' ');

598 
p
 = 
	`¡rchr
(
s
+1,' ');

599 *
p
 = '\0';

600 
¦Ù
 = 
	`©oi
(
s
+1);

601 
s
 = 
	`¡rchr
(
p
+1,':');

602 *
s
 = '\0';

603 
	`sdsä“
(
cÚfig
.
ho¡
);

604 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
p
+1);

605 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
s
+1);

606 ià(
cÚfig
.
š‹¿ùive
)

607 
	`´štf
("-> Redirectedo slot [%d]†ocated‡t %s:%d\n",

608 
¦Ù
, 
cÚfig
.
ho¡
, cÚfig.
ho¡pÜt
);

609 
cÚfig
.
şu¡”_»issue_commªd
 = 1;

610 
	`şiReäeshProm±
();

613 ià(
ouut
) {

614 ià(
ouut_¿w_¡ršgs
) {

615 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

617 ià(
cÚfig
.
ouut
 =ğ
OUTPUT_RAW
) {

618 
out
 = 
	`şiFÜm©R•lyRaw
(
»¶y
);

619 
out
 = 
	`sdsÿt
(out,"\n");

620 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_STANDARD
) {

621 
out
 = 
	`şiFÜm©R•lyTTY
(
»¶y
,"");

622 } ià(
cÚfig
.
ouut
 =ğ
OUTPUT_CSV
) {

623 
out
 = 
	`şiFÜm©R•lyCSV
(
»¶y
);

624 
out
 = 
	`sdsÿt
(out,"\n");

627 
	`fwr™e
(
out
,
	`sd¦’
(out),1,
¡dout
);

628 
	`sdsä“
(
out
);

630 
	`ä“R•lyObjeù
(
»¶y
);

631  
REDIS_OK
;

632 
	}
}

634 
	$şiS’dCommªd
(
¬gc
, **
¬gv
, 
»³©
) {

635 *
commªd
 = 
¬gv
[0];

636 
size_t
 *
¬gvËn
;

637 
j
, 
ouut_¿w
;

639 ià(!
	`¡rÿ£cmp
(
commªd
,"help") || !strcasecmp(command,"?")) {

640 
	`şiOuutH–p
(--
¬gc
, ++
¬gv
);

641  
REDIS_OK
;

644 ià(
cÚ‹xt
 =ğ
NULL
è 
REDIS_ERR
;

646 
ouut_¿w
 = 0;

647 ià(!
	`¡rÿ£cmp
(
commªd
,"info") ||

648 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"cluster") &&

649 (!
	`¡rÿ£cmp
(
¬gv
[1],"nodes") ||

650 !
	`¡rÿ£cmp
(
¬gv
[1],"info"))) ||

651 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"client") &&

652 !
	`¡rÿ£cmp
(
¬gv
[1],"list")) ||

653 (
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

654 !
	`¡rÿ£cmp
(
¬gv
[1],"graph")) ||

655 (
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(
commªd
,"latency") &&

656 !
	`¡rÿ£cmp
(
¬gv
[1],"doctor")))

658 
ouut_¿w
 = 1;

661 ià(!
	`¡rÿ£cmp
(
commªd
,"shutdown")è
cÚfig
.
shutdown
 = 1;

662 ià(!
	`¡rÿ£cmp
(
commªd
,"mÚ™Ü")è
cÚfig
.
mÚ™Ü_mode
 = 1;

663 ià(!
	`¡rÿ£cmp
(
commªd
,"subscribe") ||

664 !
	`¡rÿ£cmp
(
commªd
,"psubsüibe")è
cÚfig
.
pubsub_mode
 = 1;

665 ià(!
	`¡rÿ£cmp
(
commªd
,"sync") ||

666 !
	`¡rÿ£cmp
(
commªd
,"psync")è
cÚfig
.
¦ave_mode
 = 1;

669 
¬gvËn
 = 
	`m®loc
(
¬gc
*(
size_t
));

670 
j
 = 0; j < 
¬gc
; j++)

671 
¬gvËn
[
j
] = 
	`sd¦’
(
¬gv
[j]);

673 
»³©
--) {

674 
	`»disAµ’dCommªdArgv
(
cÚ‹xt
,
¬gc
,(cÚ¡ **)
¬gv
,
¬gvËn
);

675 
cÚfig
.
mÚ™Ü_mode
) {

676 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

677 
	`fæush
(
¡dout
);

680 ià(
cÚfig
.
pubsub_mode
) {

681 ià(
cÚfig
.
ouut
 !ğ
OUTPUT_RAW
)

682 
	`´štf
("Reading messages... (press Ctrl-Co quit)\n");

684 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
è
	`ex™
(1);

688 ià(
cÚfig
.
¦ave_mode
) {

689 
	`´štf
("Entering slave output mode... (press Ctrl-Co quit)\n");

690 
	`¦aveMode
();

691 
cÚfig
.
¦ave_mode
 = 0;

692 
	`ä“
(
¬gvËn
);

693  
REDIS_ERR
;

696 ià(
	`şiR—dR•ly
(
ouut_¿w
è!ğ
REDIS_OK
) {

697 
	`ä“
(
¬gvËn
);

698  
REDIS_ERR
;

701 ià(!
	`¡rÿ£cmp
(
commªd
,"£Ëù"è&& 
¬gc
 == 2) {

702 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[1]);

703 
	`şiReäeshProm±
();

704 } ià(!
	`¡rÿ£cmp
(
commªd
,"auth"è&& 
¬gc
 == 2) {

705 
	`şiS–eù
();

708 ià(
cÚfig
.
š‹rv®
è
	`u¦“p
(config.interval);

709 
	`fæush
(
¡dout
);

712 
	`ä“
(
¬gvËn
);

713  
REDIS_OK
;

714 
	}
}

717 
»disR•ly
 *
	$»cÚÃùšgRedisCommªd
(
»disCÚ‹xt
 *
c
, cÚ¡ *
fmt
, ...) {

718 
»disR•ly
 *
»¶y
 = 
NULL
;

719 
Œ›s
 = 0;

720 
va_li¡
 
­
;

722 
	`as£¹
(!
c
->
”r
);

723 
»¶y
 =ğ
NULL
) {

724 
c
->
”r
 & (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
)) {

725 
	`´štf
("\r\x1b[0K");

726 
	`´štf
("RecÚÃùšg... %d\r", ++
Œ›s
);

727 
	`fæush
(
¡dout
);

729 
	`»disF»e
(
c
);

730 
c
 = 
	`»disCÚÃù
(
cÚfig
.
ho¡
,cÚfig.
ho¡pÜt
);

731 
	`u¦“p
(1000000);

734 
	`va_¡¬t
(
­
,
fmt
);

735 
»¶y
 = 
	`»disvCommªd
(
c
,
fmt
,
­
);

736 
	`va_’d
(
­
);

738 ià(
c
->
”r
 && !(c->”¸& (
REDIS_ERR_IO
 | 
REDIS_ERR_EOF
))) {

739 
	`årštf
(
¡d”r
, "E¼Ü: %s\n", 
c
->
”r¡r
);

740 
	`ex™
(1);

741 } ià(
Œ›s
 > 0) {

742 
	`´štf
("\r\x1b[0K");

746 
cÚ‹xt
 = 
c
;

747  
»¶y
;

748 
	}
}

754 
	$·r£O±iÚs
(
¬gc
, **
¬gv
) {

755 
i
;

757 
i
 = 1; i < 
¬gc
; i++) {

758 
Ï¡¬g
 = 
i
==
¬gc
-1;

760 ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& !
Ï¡¬g
) {

761 
	`sdsä“
(
cÚfig
.
ho¡
);

762 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[++
i
]);

763 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-h"è&& 
Ï¡¬g
) {

764 
	`u§ge
();

765 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--help")) {

766 
	`u§ge
();

767 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-x")) {

768 
cÚfig
.
¡dš¬g
 = 1;

769 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-p"è&& !
Ï¡¬g
) {

770 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[++
i
]);

771 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-s"è&& !
Ï¡¬g
) {

772 
cÚfig
.
ho¡sock‘
 = 
¬gv
[++
i
];

773 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-r"è&& !
Ï¡¬g
) {

774 
cÚfig
.
»³©
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

775 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-i"è&& !
Ï¡¬g
) {

776 
£cÚds
 = 
	`©of
(
¬gv
[++
i
]);

777 
cÚfig
.
š‹rv®
 = 
£cÚds
*1000000;

778 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-n"è&& !
Ï¡¬g
) {

779 
cÚfig
.
dbnum
 = 
	`©oi
(
¬gv
[++
i
]);

780 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-a"è&& !
Ï¡¬g
) {

781 
cÚfig
.
auth
 = 
¬gv
[++
i
];

782 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--raw")) {

783 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

784 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--no-raw")) {

785 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

786 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--csv")) {

787 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

788 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency")) {

789 
cÚfig
.
Ï‹ncy_mode
 = 1;

790 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-dist")) {

791 
cÚfig
.
Ï‹ncy_di¡_mode
 = 1;

792 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--mono")) {

793 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_mÚo
;

794 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_mÚo_size
;

795 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--latency-history")) {

796 
cÚfig
.
Ï‹ncy_mode
 = 1;

797 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 1;

798 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--Ìu-‹¡"è&& !
Ï¡¬g
) {

799 
cÚfig
.
Ìu_‹¡_mode
 = 1;

800 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 
	`¡¹Şl
(
¬gv
[++
i
],
NULL
,10);

801 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--slave")) {

802 
cÚfig
.
¦ave_mode
 = 1;

803 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--stat")) {

804 
cÚfig
.
¡©_mode
 = 1;

805 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--scan")) {

806 
cÚfig
.
sÿn_mode
 = 1;

807 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--·‰”n"è&& !
Ï¡¬g
) {

808 
cÚfig
.
·‰”n
 = 
¬gv
[++
i
];

809 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--šŒšsic-Ï‹ncy"è&& !
Ï¡¬g
) {

810 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 1;

811 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
 = 
	`©oi
(
¬gv
[++
i
]);

812 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--rdb"è&& !
Ï¡¬g
) {

813 
cÚfig
.
g‘rdb_mode
 = 1;

814 
cÚfig
.
rdb_f’ame
 = 
¬gv
[++
i
];

815 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pipe")) {

816 
cÚfig
.
pe_mode
 = 1;

817 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--pe-timeout"è&& !
Ï¡¬g
) {

818 
cÚfig
.
pe_timeout
 = 
	`©oi
(
¬gv
[++
i
]);

819 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--bigkeys")) {

820 
cÚfig
.
bigkeys
 = 1;

821 } ià(!
	`¡rcmp
(
¬gv
[
i
],"--ev®"è&& !
Ï¡¬g
) {

822 
cÚfig
.
ev®
 = 
¬gv
[++
i
];

823 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-c")) {

824 
cÚfig
.
şu¡”_mode
 = 1;

825 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-d"è&& !
Ï¡¬g
) {

826 
	`sdsä“
(
cÚfig
.
mb_d–im
);

827 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
(
¬gv
[++
i
]);

828 } ià(!
	`¡rcmp
(
¬gv
[
i
],"-v") || !strcmp(argv[i], "--version")) {

829 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

830 
	`´štf
("»dis-ş˜%s\n", 
v”siÚ
);

831 
	`sdsä“
(
v”siÚ
);

832 
	`ex™
(0);

834 ià(
¬gv
[
i
][0] == '-') {

835 
	`årštf
(
¡d”r
,

837 
¬gv
[
i
]);

838 
	`ex™
(1);

845  
i
;

846 
	}
}

848 
sds
 
	$»adArgFromStdš
() {

849 
buf
[1024];

850 
sds
 
¬g
 = 
	`sd£m±y
();

853 
Ä—d
 = 
	`»ad
(
	`f’o
(
¡dš
),
buf
,1024);

855 ià(
Ä—d
 == 0) ;

856 ià(
Ä—d
 == -1) {

857 
	`³¼Ü
("Reading from standard input");

858 
	`ex™
(1);

860 
¬g
 = 
	`sdsÿ’
×rg,
buf
,
Ä—d
);

862  
¬g
;

863 
	}
}

865 
	$u§ge
() {

866 
sds
 
v”siÚ
 = 
	`şiV”siÚ
();

867 
	`årštf
(
¡d”r
,

921 
v”siÚ
, 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
);

922 
	`sdsä“
(
v”siÚ
);

923 
	`ex™
(1);

924 
	}
}

927 **
	$cÚv”tToSds
(
couÁ
, ** 
¬gs
) {

928 
j
;

929 **
sds
 = 
	`zm®loc
((*)*
couÁ
);

931 
j
 = 0; j < 
couÁ
; j++)

932 
sds
[
j
] = 
	`sd¢ew
(
¬gs
[j]);

934  
sds
;

935 
	}
}

937 
	$issueCommªdR•—t
(
¬gc
, **
¬gv
, 
»³©
) {

939 
cÚfig
.
şu¡”_»issue_commªd
 = 0;

940 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

941 
	`şiCÚÃù
(1);

945 ià(
	`şiS’dCommªd
(
¬gc
,
¬gv
,
»³©
è!ğ
REDIS_OK
) {

946 
	`şiPrštCÚ‹xtE¼Ü
();

947  
REDIS_ERR
;

951 ià(
cÚfig
.
şu¡”_mode
 && cÚfig.
şu¡”_»issue_commªd
) {

952 
	`şiCÚÃù
(1);

957  
REDIS_OK
;

958 
	}
}

960 
	$issueCommªd
(
¬gc
, **
¬gv
) {

961  
	`issueCommªdR•—t
(
¬gc
, 
¬gv
, 
cÚfig
.
»³©
);

962 
	}
}

964 
	$»¶
() {

965 
sds
 
hi¡Üyfe
 = 
NULL
;

966 
hi¡Üy
 = 0;

967 *
lše
;

968 
¬gc
;

969 
sds
 *
¬gv
;

971 
cÚfig
.
š‹¿ùive
 = 1;

972 
	`lš’oi£S‘MuÉiLše
(1);

973 
	`lš’oi£S‘Com¶‘iÚC®lback
(
com¶‘iÚC®lback
);

976 ià(
	`i§‰y
(
	`f’o
(
¡dš
))) {

977 
hi¡Üyfe
 = 
	`g‘Hi¡ÜyP©h
();

978 ià(
hi¡Üyfe
 !ğ
NULL
) {

979 
hi¡Üy
 = 1;

980 
	`lš’oi£Hi¡ÜyLßd
(
hi¡Üyfe
);

984 
	`şiReäeshProm±
();

985 (
lše
 = 
	`lš’oi£
(
cÚ‹xt
 ? 
cÚfig
.
´om±
 : "nÙ cÚÃùed> ")è!ğ
NULL
) {

986 ià(
lše
[0] != '\0') {

987 
¬gv
 = 
	`sds¥l™¬gs
(
lše
,&
¬gc
);

988 ià(
hi¡Üy
è
	`lš’oi£Hi¡ÜyAdd
(
lše
);

989 ià(
hi¡Üyfe
è
	`lš’oi£Hi¡ÜySave
(historyfile);

991 ià(
¬gv
 =ğ
NULL
) {

992 
	`´štf
("Invalid‡rgument(s)\n");

993 
	`ä“
(
lše
);

995 } ià(
¬gc
 > 0) {

996 ià(
	`¡rÿ£cmp
(
¬gv
[0],"quit") == 0 ||

997 
	`¡rÿ£cmp
(
¬gv
[0],"exit") == 0)

999 
	`ex™
(0);

1000 } ià(
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(
¬gv
[0],"connect")) {

1001 
	`sdsä“
(
cÚfig
.
ho¡
);

1002 
cÚfig
.
ho¡
 = 
	`sd¢ew
(
¬gv
[1]);

1003 
cÚfig
.
ho¡pÜt
 = 
	`©oi
(
¬gv
[2]);

1004 
	`şiReäeshProm±
();

1005 
	`şiCÚÃù
(1);

1006 } ià(
¬gc
 =ğ1 && !
	`¡rÿ£cmp
(
¬gv
[0],"clear")) {

1007 
	`lš’oi£CË¬Sü“n
();

1009 
¡¬t_time
 = 
	`m¡ime
(), 
–­£d
;

1010 
»³©
, 
sk¬gs
 = 0;

1012 
»³©
 = 
	`©oi
(
¬gv
[0]);

1013 ià(
¬gc
 > 1 && 
»³©
) {

1014 
sk¬gs
 = 1;

1016 
»³©
 = 1;

1019 
	`issueCommªdR•—t
(
¬gc
-
sk¬gs
, 
¬gv
+sk¬gs, 
»³©
);

1021 
–­£d
 = 
	`m¡ime
()-
¡¬t_time
;

1022 ià(
–­£d
 >= 500) {

1023 
	`´štf
("(%.2fs)\n",()
–­£d
/1000);

1028 
	`sdsä“¥l™»s
(
¬gv
,
¬gc
);

1031 
	`ä“
(
lše
);

1033 
	`ex™
(0);

1034 
	}
}

1036 
	$nÚš‹¿ùive
(
¬gc
, **
¬gv
) {

1037 
»tv®
 = 0;

1038 ià(
cÚfig
.
¡dš¬g
) {

1039 
¬gv
 = 
	`z»®loc
×rgv, (
¬gc
+1)*(*));

1040 
¬gv
[
¬gc
] = 
	`»adArgFromStdš
();

1041 
»tv®
 = 
	`issueCommªd
(
¬gc
+1, 
¬gv
);

1043 
»tv®
 = 
	`issueCommªd
(
¬gc
, 
¬gv
);

1045  
»tv®
;

1046 
	}
}

1052 
	$ev®Mode
(
¬gc
, **
¬gv
) {

1053 
sds
 
süt
 = 
	`sd£m±y
();

1054 
FILE
 *
å
;

1055 
buf
[1024];

1056 
size_t
 
Ä—d
;

1057 **
¬gv2
;

1058 
j
, 
gÙ_comma
 = 0, 
keys
 = 0;

1061 
å
 = 
	`fİ’
(
cÚfig
.
ev®
,"r");

1062 ià(!
å
) {

1063 
	`årštf
(
¡d”r
,

1064 "Cª'ˆİ’ f'%s': %s\n", 
cÚfig
.
ev®
, 
	`¡»¼Ü
(
”ºo
));

1065 
	`ex™
(1);

1067 (
Ä—d
 = 
	`ä—d
(
buf
,1,(buf),
å
)) != 0) {

1068 
süt
 = 
	`sdsÿ’
(süt,
buf
,
Ä—d
);

1070 
	`fşo£
(
å
);

1073 
¬gv2
 = 
	`zm®loc
((
sds
)*(
¬gc
+3));

1074 
¬gv2
[0] = 
	`sd¢ew
("EVAL");

1075 
¬gv2
[1] = 
süt
;

1076 
j
 = 0; j < 
¬gc
; j++) {

1077 ià(!
gÙ_comma
 && 
¬gv
[
j
][0] == ',' &&‡rgv[j][1] == 0) {

1078 
gÙ_comma
 = 1;

1081 
¬gv2
[
j
+3-
gÙ_comma
] = 
	`sd¢ew
(
¬gv
[j]);

1082 ià(!
gÙ_comma
è
keys
++;

1084 
¬gv2
[2] = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",
keys
);

1087  
	`issueCommªd
(
¬gc
+3-
gÙ_comma
, 
¬gv2
);

1088 
	}
}

1094 
	#LATENCY_SAMPLE_RATE
 10

	)

1095 
	#LATENCY_HISTORY_DEFAULT_INTERVAL
 15000

	)

1096 
	$Ï‹ncyMode
() {

1097 
»disR•ly
 *
»¶y
;

1098 
¡¬t
, 
Ï‹ncy
, 
mš
 = 0, 
max
 = 0, 
tÙ
 = 0, 
couÁ
 = 0;

1099 
hi¡Üy_š‹rv®
 =

1100 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1101 
LATENCY_HISTORY_DEFAULT_INTERVAL
;

1102 
avg
;

1103 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1105 ià(!
cÚ‹xt
è
	`ex™
(1);

1107 
¡¬t
 = 
	`m¡ime
();

1108 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1109 ià(
»¶y
 =ğ
NULL
) {

1110 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1111 
	`ex™
(1);

1113 
Ï‹ncy
 = 
	`m¡ime
()-
¡¬t
;

1114 
	`ä“R•lyObjeù
(
»¶y
);

1115 
couÁ
++;

1116 ià(
couÁ
 == 1) {

1117 
mš
 = 
max
 = 
tÙ
 = 
Ï‹ncy
;

1118 
avg
 = (è
Ï‹ncy
;

1120 ià(
Ï‹ncy
 < 
mš
) min =†atency;

1121 ià(
Ï‹ncy
 > 
max
) max =†atency;

1122 
tÙ
 +ğ
Ï‹ncy
;

1123 
avg
 = (è
tÙ
/
couÁ
;

1125 
	`´štf
("\x1b[0G\x1b[2Kmin: %lld, max: %lld,‡vg: %.2f (%lld samples)",

1126 
mš
, 
max
, 
avg
, 
couÁ
);

1127 
	`fæush
(
¡dout
);

1128 ià(
cÚfig
.
Ï‹ncy_hi¡Üy
 && 
	`m¡ime
()-
hi¡Üy_¡¬t
 > 
hi¡Üy_š‹rv®
)

1130 
	`´štf
(" -- %.2à£cÚd ¿nge\n", ()(
	`m¡ime
()-
hi¡Üy_¡¬t
)/1000);

1131 
hi¡Üy_¡¬t
 = 
	`m¡ime
();

1132 
mš
 = 
max
 = 
tÙ
 = 
couÁ
 = 0;

1134 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1136 
	}
}

1142 
	#LATENCY_DIST_DEFAULT_INTERVAL
 1000

	)

1145 
	sdi¡§m¶es
 {

1146 
	mmax
;

1147 
	mcouÁ
;

1148 
	mch¬aù”
;

1162 
	$showL©’cyDi¡Sam¶es
(
di¡§m¶es
 *
§m¶es
, 
tÙ
) {

1163 
j
;

1170 
	`´štf
("\033[38;5;0m");

1171 
j
 = 0; ; j++) {

1172 
cŞÜidx
 =

1173 
	`û
((è
§m¶es
[
j
].
couÁ
 / 
tÙ
 * (
¥eùrum_·Ë‰e_size
-1));

1174 
cŞÜ
 = 
¥eùrum_·Ë‰e
[
cŞÜidx
];

1175 
	`´štf
("\033[48;5;%dm%c", ()
cŞÜ
, 
§m¶es
[
j
].
ch¬aù”
);

1176 
§m¶es
[
j
].
couÁ
 = 0;

1177 ià(
§m¶es
[
j
].
max
 == 0) ;

1179 
	`´štf
("\033[0m\n");

1180 
	`fæush
(
¡dout
);

1181 
	}
}

1185 
	$showL©’cyDi¡Leg’d
() {

1186 
j
;

1188 
	`´štf
("---------------------------------------------\n");

1189 
	`´štf
(". - * # .01 .125 .25 .5 milliseconds\n");

1190 
	`´štf
("1,2,3,...,9 from 1o 9 milliseconds\n");

1191 
	`´štf
("A,B,C,D,E 10,20,30,40,50 milliseconds\n");

1192 
	`´štf
("F,G,H,I,J .1,.2,.3,.4,.5 seconds\n");

1193 
	`´štf
("K,L,M,N,O,P,Q,? 1,2,4,8,16,30,60,>60 seconds\n");

1194 
	`´štf
("From 0o 100%%: ");

1195 
j
 = 0; j < 
¥eùrum_·Ë‰e_size
; j++) {

1196 
	`´štf
("\033[48;5;%dm ", 
¥eùrum_·Ë‰e
[
j
]);

1198 
	`´štf
("\033[0m\n");

1199 
	`´štf
("---------------------------------------------\n");

1200 
	}
}

1202 
	$Ï‹ncyDi¡Mode
() {

1203 
»disR•ly
 *
»¶y
;

1204 
¡¬t
, 
Ï‹ncy
, 
couÁ
 = 0;

1205 
hi¡Üy_š‹rv®
 =

1206 
cÚfig
.
š‹rv®
 ? config.interval/1000 :

1207 
LATENCY_DIST_DEFAULT_INTERVAL
;

1208 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1209 
j
, 
ouuts
 = 0;

1211 
di¡§m¶es
 
§m¶es
[] = {

1248 ià(!
cÚ‹xt
è
	`ex™
(1);

1250 
¡¬t
 = 
	`u¡ime
();

1251 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"PING");

1252 ià(
»¶y
 =ğ
NULL
) {

1253 
	`årštf
(
¡d”r
,"\nI/Oƒrror\n");

1254 
	`ex™
(1);

1256 
Ï‹ncy
 = 
	`u¡ime
()-
¡¬t
;

1257 
	`ä“R•lyObjeù
(
»¶y
);

1258 
couÁ
++;

1261 
j
 = 0; ; j++) {

1262 ià(
§m¶es
[
j
].
max
 =ğ0 || 
Ï‹ncy
 <= samples[j].max) {

1263 
§m¶es
[
j
].
couÁ
++;

1269 ià(
couÁ
 && (
	`u¡ime
()-
hi¡Üy_¡¬t
)/1000 > 
hi¡Üy_š‹rv®
) {

1270 ià((
ouuts
++ % 20) == 0)

1271 
	`showL©’cyDi¡Leg’d
();

1272 
	`showL©’cyDi¡Sam¶es
(
§m¶es
,
couÁ
);

1273 
hi¡Üy_¡¬t
 = 
	`u¡ime
();

1274 
couÁ
 = 0;

1276 
	`u¦“p
(
LATENCY_SAMPLE_RATE
 * 1000);

1278 
	}
}

1286 
	$£ndSync
(
fd
) {

1291 
buf
[4096], *
p
;

1292 
ssize_t
 
Ä—d
;

1295 ià(
	`wr™e
(
fd
,"SYNC\r\n",6) != 6) {

1296 
	`årštf
(
¡d”r
,"Error writingo master\n");

1297 
	`ex™
(1);

1301 
p
 = 
buf
;

1303 
Ä—d
 = 
	`»ad
(
fd
,
p
,1);

1304 ià(
Ä—d
 <= 0) {

1305 
	`årštf
(
¡d”r
,"Error„eading bulk†ength while SYNCing\n");

1306 
	`ex™
(1);

1308 ià(*
p
 =ğ'\n' &&… !ğ
buf
) ;

1309 ià(*
p
 != '\n')…++;

1311 *
p
 = '\0';

1312 ià(
buf
[0] == '-') {

1313 
	`´štf
("SYNC w™h ma¡” faed: %s\n", 
buf
);

1314 
	`ex™
(1);

1316  
	`¡¹ouÎ
(
buf
+1,
NULL
,10);

1317 
	}
}

1319 
	$¦aveMode
() {

1320 
fd
 = 
cÚ‹xt
->fd;

1321 
·ylßd
 = 
	`£ndSync
(
fd
);

1322 
buf
[1024];

1323 
Üigš®_ouut
 = 
cÚfig
.
ouut
;

1325 
	`årštf
(
¡d”r
,"SYNC with master, discarding %llu "

1326 "by‹ oàbulk¿nsãr...\n", 
·ylßd
);

1329 
·ylßd
) {

1330 
ssize_t
 
Ä—d
;

1332 
Ä—d
 = 
	`»ad
(
fd
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1333 ià(
Ä—d
 <= 0) {

1334 
	`årštf
(
¡d”r
,"Error„eading RDB…ayload while SYNCing\n");

1335 
	`ex™
(1);

1337 
·ylßd
 -ğ
Ä—d
;

1339 
	`årštf
(
¡d”r
,"SYNC done. Logging commands from master.\n");

1342 
cÚfig
.
ouut
 = 
OUTPUT_CSV
;

1343 
	`şiR—dR•ly
(0è=ğ
REDIS_OK
);

1344 
cÚfig
.
ouut
 = 
Üigš®_ouut
;

1345 
	}
}

1353 
	$g‘RDB
() {

1354 
s
 = 
cÚ‹xt
->
fd
;

1355 
fd
;

1356 
·ylßd
 = 
	`£ndSync
(
s
);

1357 
buf
[4096];

1359 
	`årštf
(
¡d”r
,"SYNC sento master, writing %llu byteso '%s'\n",

1360 
·ylßd
, 
cÚfig
.
rdb_f’ame
);

1363 ià(!
	`¡rcmp
(
cÚfig
.
rdb_f’ame
,"-")) {

1364 
fd
 = 
STDOUT_FILENO
;

1366 
fd
 = 
	`İ’
(
cÚfig
.
rdb_f’ame
, 
O_CREAT
|
O_WRONLY
, 0644);

1367 ià(
fd
 == -1) {

1368 
	`årštf
(
¡d”r
, "E¼Ü o³nšg '%s': %s\n", 
cÚfig
.
rdb_f’ame
,

1369 
	`¡»¼Ü
(
”ºo
));

1370 
	`ex™
(1);

1374 
·ylßd
) {

1375 
ssize_t
 
Ä—d
, 
nwr™‹n
;

1377 
Ä—d
 = 
	`»ad
(
s
,
buf
,(
·ylßd
 > (buf)) ? (buf) :…ayload);

1378 ià(
Ä—d
 <= 0) {

1379 
	`årštf
(
¡d”r
,"I/O Error„eading RDB…ayload from socket\n");

1380 
	`ex™
(1);

1382 
nwr™‹n
 = 
	`wr™e
(
fd
, 
buf
, 
Ä—d
);

1383 ià(
nwr™‹n
 !ğ
Ä—d
) {

1384 
	`årštf
(
¡d”r
,"Error writing datao file: %s\n",

1385 
	`¡»¼Ü
(
”ºo
));

1386 
	`ex™
(1);

1388 
·ylßd
 -ğ
Ä—d
;

1390 
	`şo£
(
s
);

1391 
	`fsync
(
fd
);

1392 
	`årštf
(
¡d”r
,"Transfer finished with success.\n");

1393 
	`ex™
(0);

1394 
	}
}

1400 
	$peMode
() {

1401 
fd
 = 
cÚ‹xt
->fd;

1402 
”rÜs
 = 0, 
»¶›s
 = 0, 
obuf_Ën
 = 0, 
obuf_pos
 = 0;

1403 
ibuf
[1024*16], 
obuf
[1024*16];

1404 
ª‘”r
[
ANET_ERR_LEN
];

1405 
»disR—d”
 *
»ad”
 = 
	`»disR—d”C»©e
();

1406 
»disR•ly
 *
»¶y
;

1407 
eof
 = 0;

1408 
dÚe
 = 0;

1409 
magic
[20];

1410 
time_t
 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1412 
	`¤ªd
(
	`time
(
NULL
));

1415 ià(
	`ª‘NÚBlock
(
ª‘”r
,
fd
è=ğ
ANET_ERR
) {

1416 
	`årštf
(
¡d”r
, "Can't sethe socket in‚on blocking mode: %s\n",

1417 
ª‘”r
);

1418 
	`ex™
(1);

1423 !
dÚe
) {

1424 
mask
 = 
AE_READABLE
;

1426 ià(!
eof
 || 
obuf_Ën
 !ğ0è
mask
 |ğ
AE_WRITABLE
;

1427 
mask
 = 
	`«Wa™
(
fd
,mask,1000);

1430 ià(
mask
 & 
AE_READABLE
) {

1431 
ssize_t
 
Ä—d
;

1435 
Ä—d
 = 
	`»ad
(
fd
,
ibuf
,(ibuf));

1436 ià(
Ä—d
 =ğ-1 && 
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1437 
	`årštf
(
¡d”r
, "Error„eading fromhe server: %s\n",

1438 
	`¡»¼Ü
(
”ºo
));

1439 
	`ex™
(1);

1441 ià(
Ä—d
 > 0) {

1442 
	`»disR—d”F“d
(
»ad”
,
ibuf
,
Ä—d
);

1443 
Ï¡_»ad_time
 = 
	`time
(
NULL
);

1445 } 
Ä—d
 > 0);

1449 ià(
	`»disR—d”G‘R•ly
(
»ad”
,(**)&
»¶y
è=ğ
REDIS_ERR
) {

1450 
	`årštf
(
¡d”r
, "Error„eading„eplies from server\n");

1451 
	`ex™
(1);

1453 ià(
»¶y
) {

1454 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1455 
	`årštf
(
¡d”r
,"%s\n", 
»¶y
->
¡r
);

1456 
”rÜs
++;

1457 } ià(
eof
 && 
»¶y
->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

1458 
»¶y
->
Ën
 == 20) {

1462 ià(
	`memcmp
(
»¶y
->
¡r
,
magic
,20) == 0) {

1463 
	`´štf
("Last„eply„eceived from server.\n");

1464 
dÚe
 = 1;

1465 
»¶›s
--;

1468 
»¶›s
++;

1469 
	`ä“R•lyObjeù
(
»¶y
);

1471 } 
»¶y
);

1475 ià(
mask
 & 
AE_WRITABLE
) {

1478 ià(
obuf_Ën
 != 0) {

1479 
ssize_t
 
nwr™‹n
 = 
	`wr™e
(
fd
,
obuf
+
obuf_pos
,
obuf_Ën
);

1481 ià(
nwr™‹n
 == -1) {

1482 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EINTR
) {

1483 
	`årštf
(
¡d”r
, "Error writingohe server: %s\n",

1484 
	`¡»¼Ü
(
”ºo
));

1485 
	`ex™
(1);

1487 
nwr™‹n
 = 0;

1490 
obuf_Ën
 -ğ
nwr™‹n
;

1491 
obuf_pos
 +ğ
nwr™‹n
;

1492 ià(
obuf_Ën
 != 0) ;

1495 ià(
obuf_Ën
 =ğ0 && !
eof
) {

1496 
ssize_t
 
Ä—d
 = 
	`»ad
(
STDIN_FILENO
,
obuf
,(obuf));

1498 ià(
Ä—d
 == 0) {

1503 
echo
[] =

1505 
j
;

1507 
eof
 = 1;

1511 
j
 = 0; j < 20; j++)

1512 
magic
[
j
] = 
	`¿nd
() & 0xff;

1513 
	`memıy
(
echo
+21,
magic
,20);

1514 
	`memıy
(
obuf
,
echo
,(echo)-1);

1515 
obuf_Ën
 = (
echo
)-1;

1516 
obuf_pos
 = 0;

1517 
	`´štf
("All dataransferred. Waiting forhe†ast„eply...\n");

1518 } ià(
Ä—d
 == -1) {

1519 
	`årštf
(
¡d”r
, "Error„eading from stdin: %s\n",

1520 
	`¡»¼Ü
(
”ºo
));

1521 
	`ex™
(1);

1523 
obuf_Ën
 = 
Ä—d
;

1524 
obuf_pos
 = 0;

1527 ià(
obuf_Ën
 =ğ0 && 
eof
) ;

1534 ià(
eof
 && 
cÚfig
.
pe_timeout
 > 0 &&

1535 
	`time
(
NULL
)-
Ï¡_»ad_time
 > 
cÚfig
.
pe_timeout
)

1537 
	`årštf
(
¡d”r
,"No„eplies for %d seconds:ƒxiting.\n",

1538 
cÚfig
.
pe_timeout
);

1539 
”rÜs
++;

1543 
	`»disR—d”F»e
(
»ad”
);

1544 
	`´štf
("”rÜs: %Îd,„•l›s: %Îd\n", 
”rÜs
, 
»¶›s
);

1545 ià(
”rÜs
)

1546 
	`ex™
(1);

1548 
	`ex™
(0);

1549 
	}
}

1555 
	#TYPE_STRING
 0

	)

1556 
	#TYPE_LIST
 1

	)

1557 
	#TYPE_SET
 2

	)

1558 
	#TYPE_HASH
 3

	)

1559 
	#TYPE_ZSET
 4

	)

1560 
	#TYPE_NONE
 5

	)

1562 
»disR•ly
 *
	$£ndSÿn
(*
™
) {

1563 
»disR•ly
 *
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "SCAN %Îu", *
™
);

1566 if(
»¶y
 =ğ
NULL
) {

1567 
	`årštf
(
¡d”r
, "\nI/Oƒrror\n");

1568 
	`ex™
(1);

1569 } if(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1570 
	`årštf
(
¡d”r
, "SCANƒ¼Ü: %s\n", 
»¶y
->
¡r
);

1571 
	`ex™
(1);

1572 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_ARRAY
) {

1573 
	`årštf
(
¡d”r
, "Non ARRAY„esponse from SCAN!\n");

1574 
	`ex™
(1);

1575 } if(
»¶y
->
–em’ts
 != 2) {

1576 
	`årštf
(
¡d”r
, "Invalidƒlement count from SCAN!\n");

1577 
	`ex™
(1);

1581 
	`as£¹
(
»¶y
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_STRING
);

1582 
	`as£¹
(
»¶y
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_ARRAY
);

1585 *
™
 = 
	`©oi
(
»¶y
->
–em’t
[0]->
¡r
);

1587  
»¶y
;

1588 
	}
}

1590 
	$g‘DbSize
() {

1591 
»disR•ly
 *
»¶y
;

1592 
size
;

1594 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
, "DBSIZE");

1596 if(
»¶y
 =ğ
NULL
 ||„•ly->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1597 
	`årštf
(
¡d”r
, "Couldn't determine DBSIZE!\n");

1598 
	`ex™
(1);

1602 
size
 = 
»¶y
->
š‹g”
;

1603 
	`ä“R•lyObjeù
(
»¶y
);

1605  
size
;

1606 
	}
}

1608 
	$toIÁTy³
(*
key
, *
ty³
) {

1609 if(!
	`¡rcmp
(
ty³
, "string")) {

1610  
TYPE_STRING
;

1611 } if(!
	`¡rcmp
(
ty³
, "list")) {

1612  
TYPE_LIST
;

1613 } if(!
	`¡rcmp
(
ty³
, "set")) {

1614  
TYPE_SET
;

1615 } if(!
	`¡rcmp
(
ty³
, "hash")) {

1616  
TYPE_HASH
;

1617 } if(!
	`¡rcmp
(
ty³
, "zset")) {

1618  
TYPE_ZSET
;

1619 } if(!
	`¡rcmp
(
ty³
, "none")) {

1620  
TYPE_NONE
;

1622 
	`årštf
(
¡d”r
, "UnknowÀty³ '%s' fÜ key '%s'\n", 
ty³
, 
key
);

1623 
	`ex™
(1);

1625 
	}
}

1627 
	$g‘KeyTy³s
(
»disR•ly
 *
keys
, *
ty³s
) {

1628 
»disR•ly
 *
»¶y
;

1629 
i
;

1632 
i
=0;i<
keys
->
–em’ts
;i++) {

1633 
	`»disAµ’dCommªd
(
cÚ‹xt
, "TYPE %s", 
keys
->
–em’t
[
i
]->
¡r
);

1637 
i
=0;i<
keys
->
–em’ts
;i++) {

1638 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

1639 
	`årštf
(
¡d”r
, "Error gettingype for key '%s' (%d: %s)\n",

1640 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

1641 
	`ex™
(1);

1642 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_STATUS
) {

1643 
	`årštf
(
¡d”r
, "Invalid„eplyype (%d) for TYPE on key '%s'!\n",

1644 
»¶y
->
ty³
, 
keys
->
–em’t
[
i
]->
¡r
);

1645 
	`ex™
(1);

1648 
ty³s
[
i
] = 
	`toIÁTy³
(
keys
->
–em’t
[i]->
¡r
, 
»¶y
->str);

1649 
	`ä“R•lyObjeù
(
»¶y
);

1651 
	}
}

1653 
	$g‘KeySizes
(
»disR•ly
 *
keys
, *
ty³s
,

1654 *
sizes
)

1656 
»disR•ly
 *
»¶y
;

1657 *
sizecmds
[] = {"STRLEN","LLEN","SCARD","HLEN","ZCARD"};

1658 
i
;

1661 
i
=0;i<
keys
->
–em’ts
;i++) {

1663 if(
ty³s
[
i
]==
TYPE_NONE
)

1666 
	`»disAµ’dCommªd
(
cÚ‹xt
, "% %s", 
sizecmds
[
ty³s
[
i
]],

1667 
keys
->
–em’t
[
i
]->
¡r
);

1671 
i
=0;i<
keys
->
–em’ts
;i++) {

1673 if(
ty³s
[
i
] =ğ
TYPE_NONE
) {

1674 
sizes
[
i
] = 0;

1679 if(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
)!=
REDIS_OK
) {

1680 
	`årštf
(
¡d”r
, "Error getting size for key '%s' (%d: %s)\n",

1681 
keys
->
–em’t
[
i
]->
¡r
, 
cÚ‹xt
->
”r
, cÚ‹xt->
”r¡r
);

1682 
	`ex™
(1);

1683 } if(
»¶y
->
ty³
 !ğ
REDIS_REPLY_INTEGER
) {

1686 
	`årštf
(
¡d”r
,

1688 
sizecmds
[
ty³s
[
i
]], 
keys
->
–em’t
[i]->
¡r
);

1689 
sizes
[
i
] = 0;

1691 
sizes
[
i
] = 
»¶y
->
š‹g”
;

1694 
	`ä“R•lyObjeù
(
»¶y
);

1696 
	}
}

1698 
	$fšdBigKeys
() {

1699 
bigge¡
[5] = {0}, 
couÁs
[5] = {0}, 
tÙ®size
[5] = {0};

1700 
§m¶ed
 = 0, 
tÙ®_keys
, 
tÙËn
=0, *
sizes
=
NULL
, 
™
=0;

1701 
sds
 
maxkeys
[5] = {0};

1702 *
ty³Çme
[] = {"string","list","set","hash","zset"};

1703 *
ty³un™
[] = {"bytes","items","members","fields","members"};

1704 
»disR•ly
 *
»¶y
, *
keys
;

1705 
¬rsize
=0, 
i
;

1706 
ty³
, *
ty³s
=
NULL
;

1707 
pù
;

1710 
tÙ®_keys
 = 
	`g‘DbSize
();

1713 
	`´štf
("\n# Scanningheƒntire keyspaceo find biggest keys‡s well‡s\n");

1714 
	`´štf
("#‡verage sizes…er keyype. You can use -i 0.1o sleep 0.1 sec\n");

1715 
	`´štf
("#…er 100 SCAN commands (not usually‚eeded).\n\n");

1718 
i
=0;i<
TYPE_NONE
; i++) {

1719 
maxkeys
[
i
] = 
	`sd£m±y
();

1720 if(!
maxkeys
[
i
]) {

1721 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for†argest key‚ames!\n");

1722 
	`ex™
(1);

1729 
pù
 = 100 * ()
§m¶ed
/
tÙ®_keys
;

1732 
»¶y
 = 
	`£ndSÿn
(&
™
);

1733 
keys
 = 
»¶y
->
–em’t
[1];

1736 if(
keys
->
–em’ts
 > 
¬rsize
) {

1737 
ty³s
 = 
	`z»®loc
Ñy³s, ()*
keys
->
–em’ts
);

1738 
sizes
 = 
	`z»®loc
(sizes, ()*
keys
->
–em’ts
);

1740 if(!
ty³s
 || !
sizes
) {

1741 
	`årštf
(
¡d”r
, "Failedo‡llocate storage for keys!\n");

1742 
	`ex™
(1);

1745 
¬rsize
 = 
keys
->
–em’ts
;

1749 
	`g‘KeyTy³s
(
keys
, 
ty³s
);

1750 
	`g‘KeySizes
(
keys
, 
ty³s
, 
sizes
);

1753 
i
=0;i<
keys
->
–em’ts
;i++) {

1754 if((
ty³
 = 
ty³s
[
i
]è=ğ
TYPE_NONE
)

1757 
tÙ®size
[
ty³
] +ğ
sizes
[
i
];

1758 
couÁs
[
ty³
]++;

1759 
tÙËn
 +ğ
keys
->
–em’t
[
i
]->
Ën
;

1760 
§m¶ed
++;

1762 if(
bigge¡
[
ty³
]<
sizes
[
i
]) {

1763 
	`´štf
(

1765 
pù
, 
ty³Çme
[
ty³
], 
keys
->
–em’t
[
i
]->
¡r
, 
sizes
[i],

1766 
ty³un™
[
ty³
]);

1769 
maxkeys
[
ty³
] = 
	`sdsıy
(maxkeys[ty³], 
keys
->
–em’t
[
i
]->
¡r
);

1770 if(!
maxkeys
[
ty³
]) {

1771 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for key!\n");

1772 
	`ex™
(1);

1776 
bigge¡
[
ty³
] = 
sizes
[
i
];

1780 if(
§m¶ed
 % 1000000 == 0) {

1781 
	`´štf
("[%05.2f%%] Sam¶ed %Îu key sØçr\n", 
pù
, 
§m¶ed
);

1786 if(
§m¶ed
 && (§m¶ed %100è=ğ0 && 
cÚfig
.
š‹rv®
) {

1787 
	`u¦“p
(
cÚfig
.
š‹rv®
);

1790 
	`ä“R•lyObjeù
(
»¶y
);

1791 } 
™
 != 0);

1793 if(
ty³s
è
	`zä“
(types);

1794 if(
sizes
è
	`zä“
(sizes);

1797 
	`´štf
("\n-------- summary -------\n\n");

1799 
	`´štf
("Sam¶ed %Îu key šhkey¥aû!\n", 
§m¶ed
);

1800 
	`´štf
("Total key†ength in bytes is %llu (avg†en %.2f)\n\n",

1801 
tÙËn
,ÙËÀ? (éÙËn/
§m¶ed
 : 0);

1804 
i
=0;i<
TYPE_NONE
;i++) {

1805 if(
	`sd¦’
(
maxkeys
[
i
])>0) {

1806 
	`´štf
("Bigge¡ %6 found '%s' ha %Îu %s\n", 
ty³Çme
[
i
], 
maxkeys
[i],

1807 
bigge¡
[
i
], 
ty³un™
[i]);

1811 
	`´štf
("\n");

1813 
i
=0;i<
TYPE_NONE
;i++) {

1814 
	`´štf
("%llu %ss with %llu %s (%05.2f%% of keys,‡vg size %.2f)\n",

1815 
couÁs
[
i
], 
ty³Çme
[i], 
tÙ®size
[i], 
ty³un™
[i],

1816 
§m¶ed
 ? 100 * ()
couÁs
[
i
]/sampled : 0,

1817 
couÁs
[
i
] ? ()
tÙ®size
[i]/counts[i] : 0);

1821 
i
=0;i<
TYPE_NONE
;i++) {

1822 
	`sdsä“
(
maxkeys
[
i
]);

1826 
	`ex™
(0);

1827 
	}
}

1836 *
	$g‘InfoF›ld
(*
šfo
, *
f›ld
) {

1837 *
p
 = 
	`¡r¡r
(
šfo
,
f›ld
);

1838 *
n1
, *
n2
;

1839 *
»suÉ
;

1841 ià(!
p
è 
NULL
;

1842 
p
 +ğ
	`¡¾’
(
f›ld
)+1;

1843 
n1
 = 
	`¡rchr
(
p
,'\r');

1844 
n2
 = 
	`¡rchr
(
p
,',');

1845 ià(
n2
 &&‚2 < 
n1
)‚1 =‚2;

1846 
»suÉ
 = 
	`m®loc
(()*(
n1
-
p
)+1);

1847 
	`memıy
(
»suÉ
,
p
,(
n1
-p));

1848 
»suÉ
[
n1
-
p
] = '\0';

1849  
»suÉ
;

1850 
	}
}

1854 
	$g‘LÚgInfoF›ld
(*
šfo
, *
f›ld
) {

1855 *
v®ue
 = 
	`g‘InfoF›ld
(
šfo
,
f›ld
);

1856 
l
;

1858 ià(!
v®ue
è 
LONG_MIN
;

1859 
l
 = 
	`¡¹Ş
(
v®ue
,
NULL
,10);

1860 
	`ä“
(
v®ue
);

1861  
l
;

1862 
	}
}

1866 
	$by‹sToHumª
(*
s
, 
n
) {

1867 
d
;

1869 ià(
n
 < 0) {

1870 *
s
 = '-';

1871 
s
++;

1872 
n
 = -n;

1874 ià(
n
 < 1024) {

1876 
	`¥rštf
(
s
,"%ÎuB",
n
);

1878 } ià(
n
 < (1024*1024)) {

1879 
d
 = ()
n
/(1024);

1880 
	`¥rštf
(
s
,"%.2fK",
d
);

1881 } ià(
n
 < (1024LL*1024*1024)) {

1882 
d
 = ()
n
/(1024*1024);

1883 
	`¥rštf
(
s
,"%.2fM",
d
);

1884 } ià(
n
 < (1024LL*1024*1024*1024)) {

1885 
d
 = ()
n
/(1024LL*1024*1024);

1886 
	`¥rštf
(
s
,"%.2fG",
d
);

1888 
	}
}

1890 
	$¡©Mode
() {

1891 
»disR•ly
 *
»¶y
;

1892 
aux
, 
»que¡s
 = 0;

1893 
i
 = 0;

1896 
buf
[64];

1897 
j
;

1899 
»¶y
 = 
	`»cÚÃùšgRedisCommªd
(
cÚ‹xt
,"INFO");

1900 ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1901 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

1902 
	`ex™
(1);

1905 ià((
i
++ % 20) == 0) {

1906 
	`´štf
(

1912 
aux
 = 0;

1913 
j
 = 0; j < 20; j++) {

1914 
k
;

1916 
	`¥rštf
(
buf
,"db%d:keys",
j
);

1917 
k
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,
buf
);

1918 ià(
k
 =ğ
LONG_MIN
) ;

1919 
aux
 +ğ
k
;

1921 
	`¥rštf
(
buf
,"%ld",
aux
);

1922 
	`´štf
("%-11s",
buf
);

1925 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"used_memory");

1926 
	`by‹sToHumª
(
buf
,
aux
);

1927 
	`´štf
("%-8s",
buf
);

1930 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"connected_clients");

1931 
	`¥rštf
(
buf
,"%ld",
aux
);

1932 
	`´štf
(" %-8s",
buf
);

1935 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"blocked_clients");

1936 
	`¥rštf
(
buf
,"%ld",
aux
);

1937 
	`´štf
("%-8s",
buf
);

1940 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_commands_processed");

1941 
	`¥rštf
(
buf
,"%ld (+%ld)",
aux
,
»que¡s
 == 0 ? 0 :‡ux-requests);

1942 
	`´štf
("%-19s",
buf
);

1943 
»que¡s
 = 
aux
;

1946 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"total_connections_received");

1947 
	`¥rštf
(
buf
,"%ld",
aux
);

1948 
	`´štf
(" %-12s",
buf
);

1951 
aux
 = 
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"bgsave_in_progress");

1952 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"aof_rewrite_in_progress") << 1;

1953 
aux
 |ğ
	`g‘LÚgInfoF›ld
(
»¶y
->
¡r
,"loading") << 2;

1954 
aux
) {

1957 
	`´štf
("SAVE");

1960 
	`´štf
("AOF");

1963 
	`´štf
("SAVE+AOF");

1966 
	`´štf
("LOAD");

1970 
	`´štf
("\n");

1971 
	`ä“R•lyObjeù
(
»¶y
);

1972 
	`u¦“p
(
cÚfig
.
š‹rv®
);

1974 
	}
}

1980 
	$sÿnMode
() {

1981 
»disR•ly
 *
»¶y
;

1982 
cur
 = 0;

1985 ià(
cÚfig
.
·‰”n
)

1986 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %llu MATCH %s",

1987 
cur
,
cÚfig
.
·‰”n
);

1989 
»¶y
 = 
	`»disCommªd
(
cÚ‹xt
,"SCAN %Îu",
cur
);

1990 ià(
»¶y
 =ğ
NULL
) {

1991 
	`´štf
("I/Oƒrror\n");

1992 
	`ex™
(1);

1993 } ià(
»¶y
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

1994 
	`´štf
("ERROR: %s\n", 
»¶y
->
¡r
);

1995 
	`ex™
(1);

1997 
j
;

1999 
cur
 = 
	`¡¹ouÎ
(
»¶y
->
–em’t
[0]->
¡r
,
NULL
,10);

2000 
j
 = 0; j < 
»¶y
->
–em’t
[1]->
–em’ts
; j++)

2001 
	`´štf
("%s\n", 
»¶y
->
–em’t
[1]->–em’t[
j
]->
¡r
);

2003 
	`ä“R•lyObjeù
(
»¶y
);

2004 } 
cur
 != 0);

2006 
	`ex™
(0);

2007 
	}
}

2019 
	$pow”LawRªd
(
mš
, 
max
, 
®pha
) {

2020 
¶
, 
r
;

2022 
max
 += 1;

2023 
r
 = (()
	`¿nd
()è/ 
RAND_MAX
;

2024 
¶
 = 
	`pow
(

2025 ((
	`pow
(
max
,
®pha
+1è-…ow(
mš
,®pha+1))*
r
 +…ow(min,alpha+1)),

2026 (1.0/(
®pha
+1)));

2027  (
max
-1-()
¶
)+
mš
;

2028 
	}
}

2032 
	$LRUTe¡G’Key
(*
buf
, 
size_t
 
buæ’
) {

2033 
	`¢´štf
(
buf
, 
buæ’
, "lru:%lld\n",

2034 
	`pow”LawRªd
(1, 
cÚfig
.
Ìu_‹¡_§m¶e_size
, 6.2));

2035 
	}
}

2037 
	#LRU_CYCLE_PERIOD
 1000

	)

2038 
	#LRU_CYCLE_PIPELINE_SIZE
 250

	)

2039 
	$LRUTe¡Mode
() {

2040 
»disR•ly
 *
»¶y
;

2041 
key
[128];

2042 
¡¬t_cyşe
;

2043 
j
;

2045 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

2050 
¡¬t_cyşe
 = 
	`m¡ime
();

2051 
h™s
 = 0, 
mis£s
 = 0;

2052 
	`m¡ime
(è- 
¡¬t_cyşe
 < 1000) {

2054 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2055 
	`LRUTe¡G’Key
(
key
,(key));

2056 
	`»disAµ’dCommªd
(
cÚ‹xt
, "SET % v®",
key
);

2058 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++)

2059 
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
);

2062 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2063 
	`LRUTe¡G’Key
(
key
,(key));

2064 
	`»disAµ’dCommªd
(
cÚ‹xt
, "GET %s",
key
);

2066 
j
 = 0; j < 
LRU_CYCLE_PIPELINE_SIZE
; j++) {

2067 ià(
	`»disG‘R•ly
(
cÚ‹xt
, (**)&
»¶y
è=ğ
REDIS_OK
) {

2068 
»¶y
->
ty³
) {

2069 
REDIS_REPLY_ERROR
:

2070 
	`´štf
("%s\n", 
»¶y
->
¡r
);

2072 
REDIS_REPLY_NIL
:

2073 
mis£s
++;

2076 
h™s
++;

2082 ià(
cÚ‹xt
->
”r
) {

2083 
	`årštf
(
¡d”r
,"I/Oƒrror during LRUest\n");

2084 
	`ex™
(1);

2088 
	`´štf
(

2090 
h™s
+
mis£s
,

2091 
h™s
, ()h™s/(h™s+
mis£s
)*100,

2092 
mis£s
, ()mis£s/(
h™s
+misses)*100);

2094 
	`ex™
(0);

2095 
	}
}

2108 
	$compu‹_som‘hšg_ç¡
() {

2109 
s
[256], 
i
, 
j
, 
t
;

2110 
couÁ
 = 1000, 
k
;

2111 
ouut
 = 0;

2113 
k
 = 0; k < 256; k++è
s
[k] = k;

2115 
i
 = 0;

2116 
j
 = 0;

2117 
couÁ
--) {

2118 
i
++;

2119 
j
 = j + 
s
[
i
];

2120 
t
 = 
s
[
i
];

2121 
s
[
i
] = s[
j
];

2122 
s
[
j
] = 
t
;

2123 
ouut
 +ğ
s
[(s[
i
]+s[
j
])&255];

2125  
ouut
;

2126 
	}
}

2128 
	$šŒšsicL©’cyModeStİ
(
s
) {

2129 
	`REDIS_NOTUSED
(
s
);

2130 
fÜû_ÿnûl_loİ
 = 1;

2131 
	}
}

2133 
	$šŒšsicL©’cyMode
() {

2134 
‹¡_’d
, 
run_time
, 
max_Ï‹ncy
 = 0, 
runs
 = 0;

2136 
run_time
 = 
cÚfig
.
šŒšsic_Ï‹ncy_du¿tiÚ
*1000000;

2137 
‹¡_’d
 = 
	`u¡ime
(è+ 
run_time
;

2138 
	`sigÇl
(
SIGINT
, 
šŒšsicL©’cyModeStİ
);

2141 
¡¬t
, 
’d
, 
Ï‹ncy
;

2143 
¡¬t
 = 
	`u¡ime
();

2144 
	`compu‹_som‘hšg_ç¡
();

2145 
’d
 = 
	`u¡ime
();

2146 
Ï‹ncy
 = 
’d
-
¡¬t
;

2147 
runs
++;

2148 ià(
Ï‹ncy
 <= 0) ;

2151 ià(
Ï‹ncy
 > 
max_Ï‹ncy
) {

2152 
max_Ï‹ncy
 = 
Ï‹ncy
;

2153 
	`´štf
("Max†©’cy sØçr: %Îd miüo£cÚds.\n", 
max_Ï‹ncy
);

2156 
avg_us
 = ()
run_time
/
runs
;

2157 
avg_ns
 = 
avg_us
 * 10e3;

2158 ià(
fÜû_ÿnûl_loİ
 || 
’d
 > 
‹¡_’d
) {

2159 
	`´štf
("\n%lldotal„uns "

2162 
runs
, 
avg_us
, 
avg_ns
);

2163 
	`´štf
("Worst„unook %.0fx†ongerhanhe‡verage†atency.\n",

2164 
max_Ï‹ncy
 / 
avg_us
);

2165 
	`ex™
(0);

2168 
	}
}

2174 
	$maš
(
¬gc
, **
¬gv
) {

2175 
fœ¡¬g
;

2177 
cÚfig
.
ho¡
 = 
	`sd¢ew
("127.0.0.1");

2178 
cÚfig
.
ho¡pÜt
 = 6379;

2179 
cÚfig
.
ho¡sock‘
 = 
NULL
;

2180 
cÚfig
.
»³©
 = 1;

2181 
cÚfig
.
š‹rv®
 = 0;

2182 
cÚfig
.
dbnum
 = 0;

2183 
cÚfig
.
š‹¿ùive
 = 0;

2184 
cÚfig
.
shutdown
 = 0;

2185 
cÚfig
.
mÚ™Ü_mode
 = 0;

2186 
cÚfig
.
pubsub_mode
 = 0;

2187 
cÚfig
.
Ï‹ncy_mode
 = 0;

2188 
cÚfig
.
Ï‹ncy_di¡_mode
 = 0;

2189 
cÚfig
.
Ï‹ncy_hi¡Üy
 = 0;

2190 
cÚfig
.
Ìu_‹¡_mode
 = 0;

2191 
cÚfig
.
Ìu_‹¡_§m¶e_size
 = 0;

2192 
cÚfig
.
şu¡”_mode
 = 0;

2193 
cÚfig
.
¦ave_mode
 = 0;

2194 
cÚfig
.
g‘rdb_mode
 = 0;

2195 
cÚfig
.
¡©_mode
 = 0;

2196 
cÚfig
.
sÿn_mode
 = 0;

2197 
cÚfig
.
šŒšsic_Ï‹ncy_mode
 = 0;

2198 
cÚfig
.
·‰”n
 = 
NULL
;

2199 
cÚfig
.
rdb_f’ame
 = 
NULL
;

2200 
cÚfig
.
pe_mode
 = 0;

2201 
cÚfig
.
pe_timeout
 = 
REDIS_CLI_DEFAULT_PIPE_TIMEOUT
;

2202 
cÚfig
.
bigkeys
 = 0;

2203 
cÚfig
.
¡dš¬g
 = 0;

2204 
cÚfig
.
auth
 = 
NULL
;

2205 
cÚfig
.
ev®
 = 
NULL
;

2206 
cÚfig
.
Ï¡_cmd_ty³
 = -1;

2208 
¥eùrum_·Ë‰e
 = 
¥eùrum_·Ë‰e_cŞÜ
;

2209 
¥eùrum_·Ë‰e_size
 = 
¥eùrum_·Ë‰e_cŞÜ_size
;

2211 ià(!
	`i§‰y
(
	`f’o
(
¡dout
)è&& (
	`g‘’v
("FAKETTY"è=ğ
NULL
))

2212 
cÚfig
.
ouut
 = 
OUTPUT_RAW
;

2214 
cÚfig
.
ouut
 = 
OUTPUT_STANDARD
;

2215 
cÚfig
.
mb_d–im
 = 
	`sd¢ew
("\n");

2216 
	`şiIn™H–p
();

2218 
fœ¡¬g
 = 
	`·r£O±iÚs
(
¬gc
,
¬gv
);

2219 
¬gc
 -ğ
fœ¡¬g
;

2220 
¬gv
 +ğ
fœ¡¬g
;

2223 ià(
cÚfig
.
Ï‹ncy_mode
) {

2224 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2225 
	`Ï‹ncyMode
();

2229 ià(
cÚfig
.
Ï‹ncy_di¡_mode
) {

2230 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2231 
	`Ï‹ncyDi¡Mode
();

2235 ià(
cÚfig
.
¦ave_mode
) {

2236 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2237 
	`¦aveMode
();

2241 ià(
cÚfig
.
g‘rdb_mode
) {

2242 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2243 
	`g‘RDB
();

2247 ià(
cÚfig
.
pe_mode
) {

2248 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2249 
	`peMode
();

2253 ià(
cÚfig
.
bigkeys
) {

2254 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2255 
	`fšdBigKeys
();

2259 ià(
cÚfig
.
¡©_mode
) {

2260 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2261 ià(
cÚfig
.
š‹rv®
 == 0) config.interval = 1000000;

2262 
	`¡©Mode
();

2266 ià(
cÚfig
.
sÿn_mode
) {

2267 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2268 
	`sÿnMode
();

2272 ià(
cÚfig
.
Ìu_‹¡_mode
) {

2273 ià(
	`şiCÚÃù
(0è=ğ
REDIS_ERR
è
	`ex™
(1);

2274 
	`LRUTe¡Mode
();

2278 ià(
cÚfig
.
šŒšsic_Ï‹ncy_mode
è
	`šŒšsicL©’cyMode
();

2281 ià(
¬gc
 =ğ0 && !
cÚfig
.
ev®
) {

2283 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

2287 
	`şiCÚÃù
(0);

2288 
	`»¶
();

2292 ià(
	`şiCÚÃù
(0è!ğ
REDIS_OK
è
	`ex™
(1);

2293 ià(
cÚfig
.
ev®
) {

2294  
	`ev®Mode
(
¬gc
,
¬gv
);

2296  
	`nÚš‹¿ùive
(
¬gc
,
	`cÚv”tToSds
×rgc,
¬gv
));

2298 
	}
}

	@redis.c

30 
	~"»dis.h
"

31 
	~"şu¡”.h
"

32 
	~"¦owlog.h
"

33 
	~"bio.h
"

34 
	~"Ï‹ncy.h
"

36 
	~<time.h
>

37 
	~<sigÇl.h
>

38 
	~<sys/wa™.h
>

39 
	~<”ºo.h
>

40 
	~<as£¹.h
>

41 
	~<ùy³.h
>

42 
	~<¡d¬g.h
>

43 
	~<¬·/š‘.h
>

44 
	~<sys/¡©.h
>

45 
	~<fú.h
>

46 
	~<sys/time.h
>

47 
	~<sys/»sourû.h
>

48 
	~<sys/uio.h
>

49 
	~<lim™s.h
>

50 
	~<æßt.h
>

51 
	~<m©h.h
>

52 
	~<sys/»sourû.h
>

53 
	~<sys/ut¢ame.h
>

54 
	~<loÿË.h
>

56 
	#HETEROMEM


	)

57 
	~<mig¿tiÚ.h
>

61 
sh¬edObjeùsSŒuù
 
	gsh¬ed
;

67 
	gR_Z”o
, 
	gR_PosInf
, 
	gR_NegInf
, 
	gR_Nª
;

72 
»disS”v”
 
	g£rv”
;

126 
»disCommªd
 
	g»disCommªdTabË
[] = {

127 {"g‘",
g‘Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

128 {"£t",
£tCommªd
,-3,"wm",0,
NULL
,1,1,1,0,0},

129 {"£Šx",
£ŠxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

130 {"£‹x",
£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

131 {"p£‹x",
p£‹xCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

132 {"­³nd",
­³ndCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

133 {"¡¾’",
¡¾’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

134 {"d–",
d–Commªd
,-2,"w",0,
NULL
,1,-1,1,0,0},

135 {"exi¡s",
exi¡sCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

136 {"£tb™",
£tb™Commªd
,4,"wm",0,
NULL
,1,1,1,0,0},

137 {"g‘b™",
g‘b™Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

138 {"£Œªge",
£ŒªgeCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

139 {"g‘¿nge",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

140 {"sub¡r",
g‘¿ngeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

141 {"šü",
šüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

142 {"deü",
deüCommªd
,2,"wmF",0,
NULL
,1,1,1,0,0},

143 {"mg‘",
mg‘Commªd
,-2,"r",0,
NULL
,1,-1,1,0,0},

144 {"½ush",
½ushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

145 {"Íush",
ÍushCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

146 {"½ushx",
½ushxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

147 {"Íushx",
ÍushxCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

148 {"lš£¹",
lš£¹Commªd
,5,"wm",0,
NULL
,1,1,1,0,0},

149 {"½İ",
½İCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

150 {"Íİ",
ÍİCommªd
,2,"wF",0,
NULL
,1,1,1,0,0},

151 {"b½İ",
b½İCommªd
,-3,"ws",0,
NULL
,1,1,1,0,0},

152 {"b½İÍush",
b½İÍushCommªd
,4,"wms",0,
NULL
,1,2,1,0,0},

153 {"bÍİ",
bÍİCommªd
,-3,"ws",0,
NULL
,1,-2,1,0,0},

154 {"Î’",
Î’Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

155 {"lšdex",
lšdexCommªd
,3,"r",0,
NULL
,1,1,1,0,0},

156 {"l£t",
l£tCommªd
,4,"wm",0,
NULL
,1,1,1,0,0},

157 {"Ìªge",
ÌªgeCommªd
,4,"r",0,
NULL
,1,1,1,0,0},

158 {"Érim",
ÉrimCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

159 {"Ìem",
ÌemCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

160 {"½İÍush",
½İÍushCommªd
,3,"wm",0,
NULL
,1,2,1,0,0},

161 {"§dd",
§ddCommªd
,-3,"wmF",0,
NULL
,1,1,1,0,0},

162 {"¤em",
¤emCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

163 {"smove",
smoveCommªd
,4,"wF",0,
NULL
,1,2,1,0,0},

164 {"sismemb”",
sismemb”Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

165 {"sÿrd",
sÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

166 {"¥İ",
¥İCommªd
,2,"wRsF",0,
NULL
,1,1,1,0,0},

167 {"¤ªdmemb”",
¤ªdmemb”Commªd
,-2,"rR",0,
NULL
,1,1,1,0,0},

168 {"sš‹r",
sš‹rCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

169 {"sš‹r¡Üe",
sš‹r¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

170 {"suniÚ",
suniÚCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

171 {"suniÚ¡Üe",
suniÚ¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

172 {"sdiff",
sdiffCommªd
,-2,"rS",0,
NULL
,1,-1,1,0,0},

173 {"sdiff¡Üe",
sdiff¡ÜeCommªd
,-3,"wm",0,
NULL
,1,-1,1,0,0},

174 {"smemb”s",
sš‹rCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

175 {"ssÿn",
ssÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

176 {"zadd",
zaddCommªd
,-4,"wmF",0,
NULL
,1,1,1,0,0},

177 {"zšüby",
zšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

178 {"z»m",
z»mCommªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

179 {"z»m¿ngebyscÜe",
z»m¿ngebyscÜeCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

180 {"z»m¿ngeby¿nk",
z»m¿ngeby¿nkCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

181 {"z»m¿ngebyËx",
z»m¿ngebyËxCommªd
,4,"w",0,
NULL
,1,1,1,0,0},

182 {"zuniÚ¡Üe",
zuniÚ¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

183 {"zš‹r¡Üe",
zš‹r¡ÜeCommªd
,-4,"wm",0,
zuniÚIÁ”G‘Keys
,0,0,0,0,0},

184 {"z¿nge",
z¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

185 {"z¿ngebyscÜe",
z¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

186 {"z»v¿ngebyscÜe",
z»v¿ngebyscÜeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

187 {"z¿ngebyËx",
z¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

188 {"z»v¿ngebyËx",
z»v¿ngebyËxCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

189 {"zcouÁ",
zcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

190 {"zËxcouÁ",
zËxcouÁCommªd
,4,"rF",0,
NULL
,1,1,1,0,0},

191 {"z»v¿nge",
z»v¿ngeCommªd
,-4,"r",0,
NULL
,1,1,1,0,0},

192 {"zÿrd",
zÿrdCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

193 {"zscÜe",
zscÜeCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

194 {"z¿nk",
z¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

195 {"z»v¿nk",
z»v¿nkCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

196 {"zsÿn",
zsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

197 {"h£t",
h£tCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

198 {"h£Šx",
h£ŠxCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

199 {"hg‘",
hg‘Commªd
,3,"rF",0,
NULL
,1,1,1,0,0},

200 {"hm£t",
hm£tCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

201 {"hmg‘",
hmg‘Commªd
,-3,"r",0,
NULL
,1,1,1,0,0},

202 {"hšüby",
hšübyCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

203 {"hšübyæßt",
hšübyæßtCommªd
,4,"wmF",0,
NULL
,1,1,1,0,0},

204 {"hd–",
hd–Commªd
,-3,"wF",0,
NULL
,1,1,1,0,0},

205 {"hËn",
hËnCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

206 {"hkeys",
hkeysCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

207 {"hv®s",
hv®sCommªd
,2,"rS",0,
NULL
,1,1,1,0,0},

208 {"hg‘®l",
hg‘®lCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

209 {"hexi¡s",
hexi¡sCommªd
,3,"rF",0,
NULL
,1,1,1,0,0},

210 {"hsÿn",
hsÿnCommªd
,-3,"rR",0,
NULL
,1,1,1,0,0},

211 {"šüby",
šübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

212 {"deüby",
deübyCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

213 {"šübyæßt",
šübyæßtCommªd
,3,"wmF",0,
NULL
,1,1,1,0,0},

214 {"g‘£t",
g‘£tCommªd
,3,"wm",0,
NULL
,1,1,1,0,0},

215 {"m£t",
m£tCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

216 {"m£Šx",
m£ŠxCommªd
,-3,"wm",0,
NULL
,1,-1,2,0,0},

217 {"¿ndomkey",
¿ndomkeyCommªd
,1,"rR",0,
NULL
,0,0,0,0,0},

218 {"£Ëù",
£ËùCommªd
,2,"¾F",0,
NULL
,0,0,0,0,0},

219 {"move",
moveCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

220 {"»Çme",
»ÇmeCommªd
,3,"w",0,
NULL
,1,2,1,0,0},

221 {"»Çm’x",
»Çm’xCommªd
,3,"wF",0,
NULL
,1,2,1,0,0},

222 {"expœe",
expœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

223 {"expœ—t",
expœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

224 {"³xpœe",
³xpœeCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

225 {"³xpœ—t",
³xpœ—tCommªd
,3,"wF",0,
NULL
,1,1,1,0,0},

226 {"keys",
keysCommªd
,2,"rS",0,
NULL
,0,0,0,0,0},

227 {"sÿn",
sÿnCommªd
,-2,"rR",0,
NULL
,0,0,0,0,0},

228 {"dbsize",
dbsizeCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

229 {"auth",
authCommªd
,2,"r¦tF",0,
NULL
,0,0,0,0,0},

230 {"pšg",
pšgCommªd
,-1,"¹F",0,
NULL
,0,0,0,0,0},

231 {"echo",
echoCommªd
,2,"rF",0,
NULL
,0,0,0,0,0},

232 {"§ve",
§veCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

233 {"bg§ve",
bg§veCommªd
,1,"¬",0,
NULL
,0,0,0,0,0},

234 {"bg»wr™—of",
bg»wr™—ofCommªd
,1,"¬",0,
NULL
,0,0,0,0,0},

235 {"shutdown",
shutdownCommªd
,-1,"¬É",0,
NULL
,0,0,0,0,0},

236 {"Ï¡§ve",
Ï¡§veCommªd
,1,"rRF",0,
NULL
,0,0,0,0,0},

237 {"ty³",
ty³Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

238 {"muÉi",
muÉiCommªd
,1,"rsF",0,
NULL
,0,0,0,0,0},

239 {"exec",
execCommªd
,1,"sM",0,
NULL
,0,0,0,0,0},

240 {"disÿrd",
disÿrdCommªd
,1,"rsF",0,
NULL
,0,0,0,0,0},

241 {"sync",
syncCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

242 {"psync",
syncCommªd
,3,"¬s",0,
NULL
,0,0,0,0,0},

243 {"»¶cÚf",
»¶cÚfCommªd
,-1,"¬¦t",0,
NULL
,0,0,0,0,0},

244 {"æushdb",
æushdbCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

245 {"æush®l",
æush®lCommªd
,1,"w",0,
NULL
,0,0,0,0,0},

246 {"sÜt",
sÜtCommªd
,-2,"wm",0,
sÜtG‘Keys
,1,1,1,0,0},

247 {"šfo",
šfoCommªd
,-1,"¾t",0,
NULL
,0,0,0,0,0},

248 {"mÚ™Ü",
mÚ™ÜCommªd
,1,"¬s",0,
NULL
,0,0,0,0,0},

249 {"‰l",
‰lCommªd
,2,"rF",0,
NULL
,1,1,1,0,0},

250 {"±",
±Commªd
,2,"rF",0,
NULL
,1,1,1,0,0},

251 {"³rsi¡",
³rsi¡Commªd
,2,"wF",0,
NULL
,1,1,1,0,0},

252 {"¦aveof",
¦aveofCommªd
,3,"a¡",0,
NULL
,0,0,0,0,0},

253 {"rŞe",
rŞeCommªd
,1,"l¡",0,
NULL
,0,0,0,0,0},

254 {"debug",
debugCommªd
,-2,"as",0,
NULL
,0,0,0,0,0},

255 {"cÚfig",
cÚfigCommªd
,-2,"¬t",0,
NULL
,0,0,0,0,0},

256 {"subsüibe",
subsüibeCommªd
,-2,"½¦t",0,
NULL
,0,0,0,0,0},

257 {"unsubsüibe",
unsubsüibeCommªd
,-1,"½¦t",0,
NULL
,0,0,0,0,0},

258 {"psubsüibe",
psubsüibeCommªd
,-2,"½¦t",0,
NULL
,0,0,0,0,0},

259 {"punsubsüibe",
punsubsüibeCommªd
,-1,"½¦t",0,
NULL
,0,0,0,0,0},

260 {"publish",
publishCommªd
,3,"¶ŒF",0,
NULL
,0,0,0,0,0},

261 {"pubsub",
pubsubCommªd
,-2,"¶ŒR",0,
NULL
,0,0,0,0,0},

262 {"w©ch",
w©chCommªd
,-2,"rsF",0,
NULL
,1,-1,1,0,0},

263 {"unw©ch",
unw©chCommªd
,1,"rsF",0,
NULL
,0,0,0,0,0},

264 {"şu¡”",
şu¡”Commªd
,-2,"¬",0,
NULL
,0,0,0,0,0},

265 {"»¡Üe",
»¡ÜeCommªd
,-4,"wm",0,
NULL
,1,1,1,0,0},

266 {"»¡Üe-askšg",
»¡ÜeCommªd
,-4,"wmk",0,
NULL
,1,1,1,0,0},

267 {"mig¿‹",
mig¿‹Commªd
,-6,"w",0,
NULL
,0,0,0,0,0},

268 {"askšg",
askšgCommªd
,1,"r",0,
NULL
,0,0,0,0,0},

269 {"»adÚly",
»adÚlyCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

270 {"»adwr™e",
»adwr™eCommªd
,1,"rF",0,
NULL
,0,0,0,0,0},

271 {"dump",
dumpCommªd
,2,"r",0,
NULL
,1,1,1,0,0},

272 {"objeù",
objeùCommªd
,3,"r",0,
NULL
,2,2,2,0,0},

273 {"ş›Á",
ş›ÁCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

274 {"ev®",
ev®Commªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

275 {"ev®sha",
ev®ShaCommªd
,-3,"s",0,
ev®G‘Keys
,0,0,0,0,0},

276 {"¦owlog",
¦owlogCommªd
,-2,"r",0,
NULL
,0,0,0,0,0},

277 {"süt",
sütCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

278 {"time",
timeCommªd
,1,"rRF",0,
NULL
,0,0,0,0,0},

279 {"b™İ",
b™İCommªd
,-4,"wm",0,
NULL
,2,-1,1,0,0},

280 {"b™couÁ",
b™couÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

281 {"b™pos",
b™posCommªd
,-3,"r",0,
NULL
,1,1,1,0,0},

282 {"wa™",
wa™Commªd
,3,"rs",0,
NULL
,0,0,0,0,0},

283 {"commªd",
commªdCommªd
,0,"¾t",0,
NULL
,0,0,0,0,0},

284 {"pf£láe¡",
pf£láe¡Commªd
,1,"r",0,
NULL
,0,0,0,0,0},

285 {"pçdd",
pçddCommªd
,-2,"wmF",0,
NULL
,1,1,1,0,0},

286 {"pfcouÁ",
pfcouÁCommªd
,-2,"r",0,
NULL
,1,1,1,0,0},

287 {"pfm”ge",
pfm”geCommªd
,-2,"wm",0,
NULL
,1,-1,1,0,0},

288 {"pfdebug",
pfdebugCommªd
,-3,"w",0,
NULL
,0,0,0,0,0},

289 {"Ï‹ncy",
Ï‹ncyCommªd
,-2,"¬¦t",0,
NULL
,0,0,0,0,0}

292 
eviùiÚPoŞEÁry
 *
eviùiÚPoŞAÎoc
();

298 
	$»disLogRaw
(
Ëv–
, cÚ¡ *
msg
) {

299 cÚ¡ 
sy¦ogLev–M­
[] = { 
LOG_DEBUG
, 
LOG_INFO
, 
LOG_NOTICE
, 
LOG_WARNING
 };

300 cÚ¡ *
c
 = ".-*#";

301 
FILE
 *
å
;

302 
buf
[64];

303 
¿wmode
 = (
Ëv–
 & 
REDIS_LOG_RAW
);

304 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

306 
Ëv–
 &= 0xff;

307 ià(
Ëv–
 < 
£rv”
.
v”bos™y
) ;

309 
å
 = 
log_to_¡dout
 ? 
¡dout
 : 
	`fİ’
(
£rv”
.
logfe
,"a");

310 ià(!
å
) ;

312 ià(
¿wmode
) {

313 
	`årštf
(
å
,"%s",
msg
);

315 
off
;

316 
timev®
 
tv
;

317 
rŞe_ch¬
;

318 
pid_t
 
pid
 = 
	`g‘pid
();

320 
	`g‘timeofday
(&
tv
,
NULL
);

321 
off
 = 
	`¡ráime
(
buf
,(buf),"%d %b %H:%M:%S.",
	`loÿÉime
(&
tv
.
tv_£c
));

322 
	`¢´štf
(
buf
+
off
,(buf)-off,"%03d",()
tv
.
tv_u£c
/1000);

323 ià(
£rv”
.
£Áš–_mode
) {

324 
rŞe_ch¬
 = 'X';

325 } ià(
pid
 !ğ
£rv”
.pid) {

326 
rŞe_ch¬
 = 'C';

328 
rŞe_ch¬
 = (
£rv”
.
ma¡”ho¡
 ? 'S':'M');

330 
	`årštf
(
å
,"%d:%c %s %c %s\n",

331 ()
	`g‘pid
(),
rŞe_ch¬
, 
buf
,
c
[
Ëv–
],
msg
);

333 
	`fæush
(
å
);

335 ià(!
log_to_¡dout
è
	`fşo£
(
å
);

336 ià(
£rv”
.
sy¦og_’abËd
è
	`sy¦og
(
sy¦ogLev–M­
[
Ëv–
], "%s", 
msg
);

337 
	}
}

342 
	$»disLog
(
Ëv–
, cÚ¡ *
fmt
, ...) {

343 
va_li¡
 
­
;

344 
msg
[
REDIS_MAX_LOGMSG_LEN
];

346 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
) ;

348 
	`va_¡¬t
(
­
, 
fmt
);

349 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

350 
	`va_’d
(
­
);

352 
	`»disLogRaw
(
Ëv–
,
msg
);

353 
	}
}

361 
	$»disLogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
) {

362 
fd
;

363 
log_to_¡dout
 = 
£rv”
.
logfe
[0] == '\0';

364 
buf
[64];

366 ià((
Ëv–
&0xffè< 
£rv”
.
v”bos™y
 || (
log_to_¡dout
 && s”v”.
d«mÚize
))

368 
fd
 = 
log_to_¡dout
 ? 
STDOUT_FILENO
 :

369 
	`İ’
(
£rv”
.
logfe
, 
O_APPEND
|
O_CREAT
|
O_WRONLY
, 0644);

370 ià(
fd
 == -1) ;

371 
	`Î2¡ršg
(
buf
,(buf),
	`g‘pid
());

372 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

373 ià(
	`wr™e
(
fd
,":sigÇl-hªdË¸(",17è=ğ-1è
”r
;

374 
	`Î2¡ršg
(
buf
,(buf),
	`time
(
NULL
));

375 ià(
	`wr™e
(
fd
,
buf
,
	`¡¾’
(buf)è=ğ-1è
”r
;

376 ià(
	`wr™e
(
fd
,"è",2è=ğ-1è
”r
;

377 ià(
	`wr™e
(
fd
,
msg
,
	`¡¾’
(msg)è=ğ-1è
”r
;

378 ià(
	`wr™e
(
fd
,"\n",1è=ğ-1è
”r
;

379 
”r
:

380 ià(!
log_to_¡dout
è
	`şo£
(
fd
);

381 
	}
}

384 
	$u¡ime
() {

385 
timev®
 
tv
;

386 
u¡
;

388 
	`g‘timeofday
(&
tv
, 
NULL
);

389 
u¡
 = (()
tv
.
tv_£c
)*1000000;

390 
u¡
 +ğ
tv
.
tv_u£c
;

391  
u¡
;

392 
	}
}

395 
	$m¡ime
() {

396  
	`u¡ime
()/1000;

397 
	}
}

403 
	$ex™FromChd
(
»tcode
) {

404 #ifdeà
COVERAGE_TEST


405 
	`ex™
(
»tcode
);

407 
	`_ex™
(
»tcode
);

409 
	}
}

417 
	$diùVªÏF»e
(*
´ivd©a
, *
v®
)

419 
	`DICT_NOTUSED
(
´ivd©a
);

420 
	`zä“
(
v®
);

421 
	}
}

423 
	$diùLi¡De¡ruùÜ
(*
´ivd©a
, *
v®
)

425 
	`DICT_NOTUSED
(
´ivd©a
);

426 
	`li¡R–—£
((
li¡
*)
v®
);

427 
	}
}

429 
	$diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

430 cÚ¡ *
key2
)

432 
l1
,
l2
;

433 
	`DICT_NOTUSED
(
´ivd©a
);

435 
l1
 = 
	`sd¦’
((
sds
)
key1
);

436 
l2
 = 
	`sd¦’
((
sds
)
key2
);

437 ià(
l1
 !ğ
l2
)  0;

438  
	`memcmp
(
key1
, 
key2
, 
l1
) == 0;

439 
	}
}

443 
	$diùSdsKeyCa£Com·»
(*
´ivd©a
, cÚ¡ *
key1
,

444 cÚ¡ *
key2
)

446 
	`DICT_NOTUSED
(
´ivd©a
);

448  
	`¡rÿ£cmp
(
key1
, 
key2
) == 0;

449 
	}
}

451 
	$diùRedisObjeùDe¡ruùÜ
(*
´ivd©a
, *
v®
)

453 
	`DICT_NOTUSED
(
´ivd©a
);

455 ià(
v®
 =ğ
NULL
) ;

456 
	`deüRefCouÁ
(
v®
);

457 
	}
}

459 
	$diùSdsDe¡ruùÜ
(*
´ivd©a
, *
v®
)

461 
	`DICT_NOTUSED
(
´ivd©a
);

463 
	`sdsä“
(
v®
);

464 
	}
}

466 
	$diùObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

467 cÚ¡ *
key2
)

469 cÚ¡ 
robj
 *
o1
 = 
key1
, *
o2
 = 
key2
;

470  
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

471 
	}
}

473 
	$diùObjHash
(cÚ¡ *
key
) {

474 cÚ¡ 
robj
 *
o
 = 
key
;

475  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

476 
	}
}

478 
	$diùSdsHash
(cÚ¡ *
key
) {

479  
	`diùG’HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

480 
	}
}

482 
	$diùSdsCa£Hash
(cÚ¡ *
key
) {

483  
	`diùG’Ca£HashFunùiÚ
((*)
key
, 
	`sd¦’
((*)key));

484 
	}
}

486 
	$diùEncObjKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
,

487 cÚ¡ *
key2
)

489 
robj
 *
o1
 = (robj*è
key1
, *
o2
 = (robj*è
key2
;

490 
cmp
;

492 ià(
o1
->
’codšg
 =ğ
REDIS_ENCODING_INT
 &&

493 
o2
->
’codšg
 =ğ
REDIS_ENCODING_INT
)

494  
o1
->
±r
 =ğ
o2
->ptr;

496 
o1
 = 
	`g‘DecodedObjeù
(o1);

497 
o2
 = 
	`g‘DecodedObjeù
(o2);

498 
cmp
 = 
	`diùSdsKeyCom·»
(
´ivd©a
,
o1
->
±r
,
o2
->ptr);

499 
	`deüRefCouÁ
(
o1
);

500 
	`deüRefCouÁ
(
o2
);

501  
cmp
;

502 
	}
}

504 
	$diùEncObjHash
(cÚ¡ *
key
) {

505 
robj
 *
o
 = (robj*è
key
;

507 ià(
	`sdsEncodedObjeù
(
o
)) {

508  
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

510 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

511 
buf
[32];

512 
Ën
;

514 
Ën
 = 
	`Î2¡ršg
(
buf
,32,()
o
->
±r
);

515  
	`diùG’HashFunùiÚ
((*)
buf
, 
Ën
);

517 
hash
;

519 
o
 = 
	`g‘DecodedObjeù
(o);

520 
hash
 = 
	`diùG’HashFunùiÚ
(
o
->
±r
, 
	`sd¦’
((
sds
)o->ptr));

521 
	`deüRefCouÁ
(
o
);

522  
hash
;

525 
	}
}

528 
diùTy³
 
	g£tDiùTy³
 = {

529 
diùEncObjHash
,

530 
NULL
,

531 
NULL
,

532 
diùEncObjKeyCom·»
,

533 
diùRedisObjeùDe¡ruùÜ
,

534 
NULL


538 
diùTy³
 
	gz£tDiùTy³
 = {

539 
diùEncObjHash
,

540 
NULL
,

541 
NULL
,

542 
diùEncObjKeyCom·»
,

543 
diùRedisObjeùDe¡ruùÜ
,

544 
NULL


548 
diùTy³
 
	gdbDiùTy³
 = {

549 
diùSdsHash
,

550 
NULL
,

551 
NULL
,

552 
diùSdsKeyCom·»
,

553 
diùSdsDe¡ruùÜ
,

554 
diùRedisObjeùDe¡ruùÜ


558 
diùTy³
 
	gshaSütObjeùDiùTy³
 = {

559 
diùSdsCa£Hash
,

560 
NULL
,

561 
NULL
,

562 
diùSdsKeyCa£Com·»
,

563 
diùSdsDe¡ruùÜ
,

564 
diùRedisObjeùDe¡ruùÜ


568 
diùTy³
 
	gkey±rDiùTy³
 = {

569 
diùSdsHash
,

570 
NULL
,

571 
NULL
,

572 
diùSdsKeyCom·»
,

573 
NULL
,

574 
NULL


578 
diùTy³
 
	gcommªdTabËDiùTy³
 = {

579 
diùSdsCa£Hash
,

580 
NULL
,

581 
NULL
,

582 
diùSdsKeyCa£Com·»
,

583 
diùSdsDe¡ruùÜ
,

584 
NULL


588 
diùTy³
 
	ghashDiùTy³
 = {

589 
diùEncObjHash
,

590 
NULL
,

591 
NULL
,

592 
diùEncObjKeyCom·»
,

593 
diùRedisObjeùDe¡ruùÜ
,

594 
diùRedisObjeùDe¡ruùÜ


600 
diùTy³
 
	gkeyli¡DiùTy³
 = {

601 
diùObjHash
,

602 
NULL
,

603 
NULL
,

604 
diùObjKeyCom·»
,

605 
diùRedisObjeùDe¡ruùÜ
,

606 
diùLi¡De¡ruùÜ


611 
diùTy³
 
	gşu¡”NodesDiùTy³
 = {

612 
diùSdsHash
,

613 
NULL
,

614 
NULL
,

615 
diùSdsKeyCom·»
,

616 
diùSdsDe¡ruùÜ
,

617 
NULL


623 
diùTy³
 
	gşu¡”NodesBÏckLi¡DiùTy³
 = {

624 
diùSdsCa£Hash
,

625 
NULL
,

626 
NULL
,

627 
diùSdsKeyCa£Com·»
,

628 
diùSdsDe¡ruùÜ
,

629 
NULL


633 
diùTy³
 
	gmig¿‹CacheDiùTy³
 = {

634 
diùSdsHash
,

635 
NULL
,

636 
NULL
,

637 
diùSdsKeyCom·»
,

638 
diùSdsDe¡ruùÜ
,

639 
NULL


645 
diùTy³
 
	g»¶SütCacheDiùTy³
 = {

646 
diùSdsCa£Hash
,

647 
NULL
,

648 
NULL
,

649 
diùSdsKeyCa£Com·»
,

650 
diùSdsDe¡ruùÜ
,

651 
NULL


654 
	$htN“dsResize
(
diù
 *dict) {

655 
size
, 
u£d
;

657 
size
 = 
	`diùSlÙs
(
diù
);

658 
u£d
 = 
	`diùSize
(
diù
);

659  (
size
 && 
u£d
 && siz> 
DICT_HT_INITIAL_SIZE
 &&

660 (
u£d
*100/
size
 < 
REDIS_HT_MINFILL
));

661 
	}
}

665 
	$ŒyResizeHashTabËs
(
dbid
) {

666 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
diù
))

667 
	`diùResize
(
£rv”
.
db
[
dbid
].
diù
);

668 ià(
	`htN“dsResize
(
£rv”
.
db
[
dbid
].
expœes
))

669 
	`diùResize
(
£rv”
.
db
[
dbid
].
expœes
);

670 
	}
}

679 
	$šüem’ÎyRehash
(
dbid
) {

681 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
diù
)) {

682 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
diù
,1);

686 ià(
	`diùIsRehashšg
(
£rv”
.
db
[
dbid
].
expœes
)) {

687 
	`diùRehashMli£cÚds
(
£rv”
.
db
[
dbid
].
expœes
,1);

691 
	}
}

699 
	$upd©eDiùResizePŞicy
() {

700 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1)

701 
	`diùEÇbËResize
();

703 
	`diùDi§bËResize
();

704 
	}
}

719 
	$aùiveExpœeCyşeTryExpœe
(
»disDb
 *
db
, 
diùEÁry
 *
de
, 
now
) {

720 
t
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
);

721 ià(
now
 > 
t
) {

722 
sds
 
key
 = 
	`diùG‘Key
(
de
);

723 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
key
,
	`sd¦’
(key));

725 
	`´İag©eExpœe
(
db
,
keyobj
);

726 
	`dbD–‘e
(
db
,
keyobj
);

727 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_EXPIRED
,

728 "expœed",
keyobj
,
db
->
id
);

729 
	`deüRefCouÁ
(
keyobj
);

730 
£rv”
.
¡©_expœedkeys
++;

735 
	}
}

759 
	$aùiveExpœeCyşe
(
ty³
) {

762 
cu¼’t_db
 = 0;

763 
tim–im™_ex™
 = 0;

764 
Ï¡_ç¡_cyşe
 = 0;

766 
j
, 
™”©iÚ
 = 0;

767 
dbs_³r_ÿÎ
 = 
REDIS_DBCRON_DBS_PER_CALL
;

768 
¡¬t
 = 
	`u¡ime
(), 
tim–im™
;

770 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
) {

774 ià(!
tim–im™_ex™
) ;

775 ià(
¡¬t
 < 
Ï¡_ç¡_cyşe
 + 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
*2) ;

776 
Ï¡_ç¡_cyşe
 = 
¡¬t
;

786 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
 || 
tim–im™_ex™
)

787 
dbs_³r_ÿÎ
 = 
£rv”
.
dbnum
;

793 
tim–im™
 = 1000000*
ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
/
£rv”
.
hz
/100;

794 
tim–im™_ex™
 = 0;

795 ià(
tim–im™
 <= 0)imelimit = 1;

797 ià(
ty³
 =ğ
ACTIVE_EXPIRE_CYCLE_FAST
)

798 
tim–im™
 = 
ACTIVE_EXPIRE_CYCLE_FAST_DURATION
;

800 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

801 
expœed
;

802 
»disDb
 *
db
 = 
£rv”
.db+(
cu¼’t_db
 % s”v”.
dbnum
);

807 
cu¼’t_db
++;

812 
num
, 
¦Ùs
;

813 
now
, 
‰l_sum
;

814 
‰l_§m¶es
;

817 ià((
num
 = 
	`diùSize
(
db
->
expœes
)) == 0) {

818 
db
->
avg_‰l
 = 0;

821 
¦Ùs
 = 
	`diùSlÙs
(
db
->
expœes
);

822 
now
 = 
	`m¡ime
();

827 ià(
num
 && 
¦Ùs
 > 
DICT_HT_INITIAL_SIZE
 &&

828 (
num
*100/
¦Ùs
 < 1)) ;

832 
expœed
 = 0;

833 
‰l_sum
 = 0;

834 
‰l_§m¶es
 = 0;

836 ià(
num
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
)

837 
num
 = 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
;

839 
num
--) {

840 
diùEÁry
 *
de
;

841 
‰l
;

843 ià((
de
 = 
	`diùG‘RªdomKey
(
db
->
expœes
)è=ğ
NULL
) ;

844 
‰l
 = 
	`diùG‘SigÃdIÁeg”V®
(
de
)-
now
;

845 ià(
	`aùiveExpœeCyşeTryExpœe
(
db
,
de
,
now
)è
expœed
++;

846 ià(
‰l
 < 0)tl = 0;

847 
‰l_sum
 +ğ
‰l
;

848 
‰l_§m¶es
++;

852 ià(
‰l_§m¶es
) {

853 
avg_‰l
 = 
‰l_sum
/
‰l_§m¶es
;

855 ià(
db
->
avg_‰l
 == 0) db->avg_ttl =‡vg_ttl;

857 
db
->
avg_‰l
 = (db->avg_ttl+avg_ttl)/2;

863 
™”©iÚ
++;

864 ià((
™”©iÚ
 & 0xf) == 0) {

865 
–­£d
 = 
	`u¡ime
()-
¡¬t
;

867 
	`Ï‹ncyAddSam¶eIfN“ded
("expœe-cyşe",
–­£d
/1000);

868 ià(
–­£d
 > 
tim–im™
è
tim–im™_ex™
 = 1;

870 ià(
tim–im™_ex™
) ;

873 } 
expœed
 > 
ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
/4);

875 
	}
}

877 
	$g‘LRUClock
() {

878  (
	`m¡ime
()/
REDIS_LRU_CLOCK_RESOLUTION
è& 
REDIS_LRU_CLOCK_MAX
;

879 
	}
}

882 
	$ŒackIn¡ªÃousM‘ric
(
m‘ric
, 
cu¼’t_»adšg
) {

883 
t
 = 
	`m¡ime
(è- 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
;

884 
İs
 = 
cu¼’t_»adšg
 -

885 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
;

886 
İs_£c
;

888 
İs_£c
 = 
t
 > 0 ? (
İs
*1000/t) : 0;

890 
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[£rv”.š¡_m‘ric[m‘ric].
idx
] =

891 
İs_£c
;

892 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
++;

893 
£rv”
.
š¡_m‘ric
[
m‘ric
].
idx
 %ğ
REDIS_METRIC_SAMPLES
;

894 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

895 
£rv”
.
š¡_m‘ric
[
m‘ric
].
Ï¡_§m¶e_couÁ
 = 
cu¼’t_»adšg
;

896 
	}
}

899 
	$g‘In¡ªÃousM‘ric
(
m‘ric
) {

900 
j
;

901 
sum
 = 0;

903 
j
 = 0; j < 
REDIS_METRIC_SAMPLES
; j++)

904 
sum
 +ğ
£rv”
.
š¡_m‘ric
[
m‘ric
].
§m¶es
[
j
];

905  
sum
 / 
REDIS_METRIC_SAMPLES
;

906 
	}
}

909 
	$ş›ÁsCrÚHªdËTimeout
(
»disCl›Á
 *
c
) {

910 
time_t
 
now
 = 
£rv”
.
unixtime
;

912 ià(
£rv”
.
maxidËtime
 &&

913 !(
c
->
æags
 & 
REDIS_SLAVE
) &&

914 !(
c
->
æags
 & 
REDIS_MASTER
) &&

915 !(
c
->
æags
 & 
REDIS_BLOCKED
) &&

916 !(
c
->
æags
 & 
REDIS_PUBSUB
) &&

917 (
now
 - 
c
->
Ï¡š‹¿ùiÚ
 > 
£rv”
.
maxidËtime
))

919 
	`»disLog
(
REDIS_VERBOSE
,"Closing idle client");

920 
	`ä“Cl›Á
(
c
);

922 } ià(
c
->
æags
 & 
REDIS_BLOCKED
) {

926 
m¡ime_t
 
now_ms
 = 
	`m¡ime
();

928 ià(
c
->
bpİ
.
timeout
 !ğ0 && c->bpİ.timeouˆ< 
now_ms
) {

930 
	`»¶yToBlockedCl›ÁTimedOut
(
c
);

931 
	`unblockCl›Á
(
c
);

932 } ià(
£rv”
.
şu¡”_’abËd
) {

935 ià(
	`şu¡”RedœeùBlockedCl›ÁIfN“ded
(
c
))

936 
	`unblockCl›Á
(
c
);

940 
	}
}

946 
	$ş›ÁsCrÚResizeQu”yBufãr
(
»disCl›Á
 *
c
) {

947 
size_t
 
qu”ybuf_size
 = 
	`sdsAÎocSize
(
c
->
qu”ybuf
);

948 
time_t
 
idËtime
 = 
£rv”
.
unixtime
 - 
c
->
Ï¡š‹¿ùiÚ
;

953 ià(((
qu”ybuf_size
 > 
REDIS_MBULK_BIG_ARG
) &&

954 (
qu”ybuf_size
/(
c
->
qu”ybuf_³ak
+1)) > 2) ||

955 (
qu”ybuf_size
 > 1024 && 
idËtime
 > 2))

958 ià(
	`sd§va
(
c
->
qu”ybuf
) > 1024) {

959 
c
->
qu”ybuf
 = 
	`sdsRemoveF»eS·û
(c->querybuf);

964 
c
->
qu”ybuf_³ak
 = 0;

966 
	}
}

968 
	$ş›ÁsCrÚ
() {

974 
numş›Ás
 = 
	`li¡L’gth
(
£rv”
.
ş›Ás
);

975 
™”©iÚs
 = 
numş›Ás
/(
£rv”
.
hz
*10);

977 ià(
™”©iÚs
 < 50)

978 
™”©iÚs
 = (
numş›Ás
 < 50) ?‚umclients : 50;

979 
	`li¡L’gth
(
£rv”
.
ş›Ás
è&& 
™”©iÚs
--) {

980 
»disCl›Á
 *
c
;

981 
li¡Node
 *
h—d
;

986 
	`li¡RÙ©e
(
£rv”
.
ş›Ás
);

987 
h—d
 = 
	`li¡Fœ¡
(
£rv”
.
ş›Ás
);

988 
c
 = 
	`li¡NodeV®ue
(
h—d
);

992 ià(
	`ş›ÁsCrÚHªdËTimeout
(
c
)) ;

993 ià(
	`ş›ÁsCrÚResizeQu”yBufãr
(
c
)) ;

995 
	}
}

1000 
	$d©aba£sCrÚ
() {

1003 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

1004 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_SLOW
);

1009 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

1013 
»size_db
 = 0;

1014 
»hash_db
 = 0;

1015 
dbs_³r_ÿÎ
 = 
REDIS_DBCRON_DBS_PER_CALL
;

1016 
j
;

1019 ià(
dbs_³r_ÿÎ
 > 
£rv”
.
dbnum
) dbs_per_call = server.dbnum;

1022 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1023 
	`ŒyResizeHashTabËs
(
»size_db
 % 
£rv”
.
dbnum
);

1024 
»size_db
++;

1028 ià(
£rv”
.
aùiv”ehashšg
) {

1029 
j
 = 0; j < 
dbs_³r_ÿÎ
; j++) {

1030 
wÜk_dÚe
 = 
	`šüem’ÎyRehash
(
»hash_db
 % 
£rv”
.
dbnum
);

1031 
»hash_db
++;

1032 ià(
wÜk_dÚe
) {

1040 
	}
}

1046 
	$upd©eCachedTime
() {

1047 
£rv”
.
unixtime
 = 
	`time
(
NULL
);

1048 
£rv”
.
m¡ime
 = 
	`m¡ime
();

1049 
	}
}

1070 
	$£rv”CrÚ
(
«Ev’tLoİ
 *
ev’tLoİ
, 
id
, *
ş›ÁD©a
) {

1071 
j
;

1072 
	`REDIS_NOTUSED
(
ev’tLoİ
);

1073 
	`REDIS_NOTUSED
(
id
);

1074 
	`REDIS_NOTUSED
(
ş›ÁD©a
);

1078 ià(
£rv”
.
w©chdog_³riod
è
	`w©chdogScheduËSigÇl
(server.watchdog_period);

1081 
	`upd©eCachedTime
();

1083 
	`run_w™h_³riod
(100) {

1084 
	`ŒackIn¡ªÃousM‘ric
(
REDIS_METRIC_COMMAND
,
£rv”
.
¡©_numcommªds
);

1085 
	`ŒackIn¡ªÃousM‘ric
(
REDIS_METRIC_NET_INPUT
,

1086 
£rv”
.
¡©_Ãt_šput_by‹s
);

1087 
	`ŒackIn¡ªÃousM‘ric
(
REDIS_METRIC_NET_OUTPUT
,

1088 
£rv”
.
¡©_Ãt_ouut_by‹s
);

1102 
£rv”
.
Ìuşock
 = 
	`g‘LRUClock
();

1105 ià(
	`zm®loc_u£d_memÜy
(è> 
£rv”
.
¡©_³ak_memÜy
)

1106 
£rv”
.
¡©_³ak_memÜy
 = 
	`zm®loc_u£d_memÜy
();

1109 
£rv”
.
»sid’t_£t_size
 = 
	`zm®loc_g‘_rss
();

1113 ià(
£rv”
.
shutdown_a§p
) {

1114 ià(
	`´•¬eFÜShutdown
(0è=ğ
REDIS_OK
è
	`ex™
(0);

1115 
	`»disLog
(
REDIS_WARNING
,"SIGTERM„eceived butƒrrorsryingo shut downhe server, checkhe†ogs for more information");

1116 
£rv”
.
shutdown_a§p
 = 0;

1120 
	`run_w™h_³riod
(5000) {

1121 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1122 
size
, 
u£d
, 
vkeys
;

1124 
size
 = 
	`diùSlÙs
(
£rv”
.
db
[
j
].
diù
);

1125 
u£d
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

1126 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

1127 ià(
u£d
 || 
vkeys
) {

1128 
	`»disLog
(
REDIS_VERBOSE
,"DB %d: %Îd key (%Îd vŞ©eèš %Îd slÙ HT.",
j
,
u£d
,
vkeys
,
size
);

1135 ià(!
£rv”
.
£Áš–_mode
) {

1136 
	`run_w™h_³riod
(5000) {

1137 
	`»disLog
(
REDIS_VERBOSE
,

1139 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

1140 
	`li¡L’gth
(
£rv”
.
¦aves
),

1141 
	`zm®loc_u£d_memÜy
());

1146 
	`ş›ÁsCrÚ
();

1149 
	`d©aba£sCrÚ
();

1153 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1 &&

1154 
£rv”
.
aof_»wr™e_scheduËd
)

1156 
	`»wr™eAµ’dOÆyFeBackground
();

1160 ià(
£rv”
.
rdb_chd_pid
 !ğ-1 || s”v”.
aof_chd_pid
 != -1) {

1161 
¡©loc
;

1162 
pid_t
 
pid
;

1164 ià((
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) != 0) {

1165 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

1166 
bysigÇl
 = 0;

1168 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

1170 ià(
pid
 =ğ
£rv”
.
rdb_chd_pid
) {

1171 
	`backgroundSaveDÚeHªdËr
(
ex™code
,
bysigÇl
);

1172 } ià(
pid
 =ğ
£rv”
.
aof_chd_pid
) {

1173 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
,
bysigÇl
);

1175 
	`»disLog
(
REDIS_WARNING
,

1177 ()
pid
);

1179 
	`upd©eDiùResizePŞicy
();

1184 
j
 = 0; j < 
£rv”
.
§v•¬am¦’
; j++) {

1185 
§v•¬am
 *
¥
 = 
£rv”
.
§v•¬ams
+
j
;

1191 ià(
£rv”
.
dœty
 >ğ
¥
->
chªges
 &&

1192 
£rv”
.
unixtime
-£rv”.
Ï¡§ve
 > 
¥
->
£cÚds
 &&

1193 (
£rv”
.
unixtime
-£rv”.
Ï¡bg§ve_Œy
 >

1194 
REDIS_BGSAVE_RETRY_DELAY
 ||

1195 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
REDIS_OK
))

1197 
	`»disLog
(
REDIS_NOTICE
,"%d changes in %d seconds. Saving...",

1198 
¥
->
chªges
, ()¥->
£cÚds
);

1199 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
);

1205 ià(
£rv”
.
rdb_chd_pid
 == -1 &&

1206 
£rv”
.
aof_chd_pid
 == -1 &&

1207 
£rv”
.
aof_»wr™e_³rc
 &&

1208 
£rv”
.
aof_cu¼’t_size
 > s”v”.
aof_»wr™e_mš_size
)

1210 
ba£
 = 
£rv”
.
aof_»wr™e_ba£_size
 ?

1211 
£rv”
.
aof_»wr™e_ba£_size
 : 1;

1212 
growth
 = (
£rv”
.
aof_cu¼’t_size
*100/
ba£
) - 100;

1213 ià(
growth
 >ğ
£rv”
.
aof_»wr™e_³rc
) {

1214 
	`»disLog
(
REDIS_NOTICE
,"S¹šg‡utom©iø»wr™šg oàAOF oÀ%Îd%% growth",
growth
);

1215 
	`»wr™eAµ’dOÆyFeBackground
();

1223 ià(
£rv”
.
aof_æush_po¡pÚed_¡¬t
è
	`æushAµ’dOÆyFe
(0);

1229 
	`run_w™h_³riod
(1000) {

1230 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
REDIS_ERR
)

1231 
	`æushAµ’dOÆyFe
(0);

1235 
	`ä“Cl›ÁsInAsyncF»eQueue
();

1238 
	`ş›ÁsA»Pau£d
();

1242 
	`run_w™h_³riod
(1000è
	`»¶iÿtiÚCrÚ
();

1245 
	`run_w™h_³riod
(100) {

1246 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”CrÚ
();

1250 
	`run_w™h_³riod
(100) {

1251 ià(
£rv”
.
£Áš–_mode
è
	`£Áš–Tim”
();

1255 
	`run_w™h_³riod
(1000) {

1256 
	`mig¿‹Clo£TimedoutSock‘s
();

1259 
£rv”
.
üÚloİs
++;

1260  1000/
£rv”
.
hz
;

1261 
	}
}

1266 
	$befÜeSË•
(
«Ev’tLoİ
 *
ev’tLoİ
) {

1267 
	`REDIS_NOTUSED
(
ev’tLoİ
);

1273 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”BefÜeSË•
();

1277 ià(
£rv”
.
aùive_expœe_’abËd
 && s”v”.
ma¡”ho¡
 =ğ
NULL
)

1278 
	`aùiveExpœeCyşe
(
ACTIVE_EXPIRE_CYCLE_FAST
);

1282 ià(
£rv”
.
g‘_ack_äom_¦aves
) {

1283 
robj
 *
¬gv
[3];

1285 
¬gv
[0] = 
	`ü—‹SŒšgObjeù
("REPLCONF",8);

1286 
¬gv
[1] = 
	`ü—‹SŒšgObjeù
("GETACK",6);

1287 
¬gv
[2] = 
	`ü—‹SŒšgObjeù
("*",1);

1288 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
, 
¬gv
, 3);

1289 
	`deüRefCouÁ
(
¬gv
[0]);

1290 
	`deüRefCouÁ
(
¬gv
[1]);

1291 
	`deüRefCouÁ
(
¬gv
[2]);

1292 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1297 ià(
	`li¡L’gth
(
£rv”
.
ş›Ás_wa™šg_acks
))

1298 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1301 ià(
	`li¡L’gth
(
£rv”
.
unblocked_ş›Ás
))

1302 
	`´oûssUnblockedCl›Ás
();

1305 
	`æushAµ’dOÆyFe
(0);

1306 
	}
}

1310 
	$ü—‹Sh¬edObjeùs
() {

1311 
j
;

1313 
sh¬ed
.
ülf
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("\r\n"));

1314 
sh¬ed
.
ok
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("+OK\r\n"));

1315 
sh¬ed
.
”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("-ERR\r\n"));

1316 
sh¬ed
.
em±ybulk
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("$0\r\n\r\n"));

1317 
sh¬ed
.
cz”o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(":0\r\n"));

1318 
sh¬ed
.
cÚe
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(":1\r\n"));

1319 
sh¬ed
.
úegÚe
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(":-1\r\n"));

1320 
sh¬ed
.
nuÎbulk
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("$-1\r\n"));

1321 
sh¬ed
.
nuÎmuÉibulk
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("*-1\r\n"));

1322 
sh¬ed
.
em±ymuÉibulk
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("*0\r\n"));

1323 
sh¬ed
.
pÚg
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("+PONG\r\n"));

1324 
sh¬ed
.
queued
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("+QUEUED\r\n"));

1325 
sh¬ed
.
em±ysÿn
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("*2\r\n$1\r\n0\r\n*0\r\n"));

1326 
sh¬ed
.
wrÚgty³”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1328 
sh¬ed
.
nokey”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1330 
sh¬ed
.
syÁax”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1332 
sh¬ed
.
§meobjeù”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1334 
sh¬ed
.
outoäªg“¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1336 
sh¬ed
.
nosü‹¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1338 
sh¬ed
.
lßdšg”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1340 
sh¬ed
.
¦owsü‹¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1342 
sh¬ed
.
ma¡”dowÃ¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1344 
sh¬ed
.
bg§v“¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1346 
sh¬ed
.
ro¦av“¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1348 
sh¬ed
.
nßuth”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1350 
sh¬ed
.
oom”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1352 
sh¬ed
.
exeÿbÜ‹¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1354 
sh¬ed
.
nÜ•liÿ£¼
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1356 
sh¬ed
.
busykey”r
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(

1358 
sh¬ed
.
¥aû
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(" "));

1359 
sh¬ed
.
cŞÚ
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
(":"));

1360 
sh¬ed
.
¶us
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd¢ew
("+"));

1362 
j
 = 0; j < 
REDIS_SHARED_SELECT_CMDS
; j++) {

1363 
diùid_¡r
[64];

1364 
diùid_Ën
;

1366 
diùid_Ën
 = 
	`Î2¡ršg
(
diùid_¡r
,(diùid_¡r),
j
);

1367 
sh¬ed
.
£Ëù
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,

1368 
	`sdsÿrštf
(
	`sd£m±y
(),

1370 
diùid_Ën
, 
diùid_¡r
));

1372 
sh¬ed
.
mes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$7\r\nmessage\r\n",13);

1373 
sh¬ed
.
pmes§gebulk
 = 
	`ü—‹SŒšgObjeù
("$8\r\npmessage\r\n",14);

1374 
sh¬ed
.
subsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$9\r\nsubscribe\r\n",15);

1375 
sh¬ed
.
unsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$11\r\nunsubscribe\r\n",18);

1376 
sh¬ed
.
psubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$10\r\npsubscribe\r\n",17);

1377 
sh¬ed
.
punsubsüibebulk
 = 
	`ü—‹SŒšgObjeù
("$12\r\npunsubscribe\r\n",19);

1378 
sh¬ed
.
d–
 = 
	`ü—‹SŒšgObjeù
("DEL",3);

1379 
sh¬ed
.
½İ
 = 
	`ü—‹SŒšgObjeù
("RPOP",4);

1380 
sh¬ed
.
Íİ
 = 
	`ü—‹SŒšgObjeù
("LPOP",4);

1381 
sh¬ed
.
Íush
 = 
	`ü—‹SŒšgObjeù
("LPUSH",5);

1382 
j
 = 0; j < 
REDIS_SHARED_INTEGERS
; j++) {

1383 
sh¬ed
.
š‹g”s
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,(*)()j);

1384 
sh¬ed
.
š‹g”s
[
j
]->
’codšg
 = 
REDIS_ENCODING_INT
;

1386 
j
 = 0; j < 
REDIS_SHARED_BULKHDR_LEN
; j++) {

1387 
sh¬ed
.
mbulkhdr
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,

1388 
	`sdsÿrštf
(
	`sd£m±y
(),"*%d\r\n",
j
));

1389 
sh¬ed
.
bulkhdr
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,

1390 
	`sdsÿrštf
(
	`sd£m±y
(),"$%d\r\n",
j
));

1396 
sh¬ed
.
mš¡ršg
 = 
	`ü—‹SŒšgObjeù
("minstring",9);

1397 
sh¬ed
.
max¡ršg
 = 
	`ü—‹SŒšgObjeù
("maxstring",9);

1398 
	}
}

1400 
	$š™S”v”CÚfig
() {

1401 
j
;

1403 
	`g‘RªdomHexCh¬s
(
£rv”
.
runid
,
REDIS_RUN_ID_SIZE
);

1404 
£rv”
.
cÚfigfe
 = 
NULL
;

1405 
£rv”
.
hz
 = 
REDIS_DEFAULT_HZ
;

1406 
£rv”
.
runid
[
REDIS_RUN_ID_SIZE
] = '\0';

1407 
£rv”
.
¬ch_b™s
 = (() == 8) ? 64 : 32;

1408 
£rv”
.
pÜt
 = 
REDIS_SERVERPORT
;

1409 
£rv”
.
tı_backlog
 = 
REDIS_TCP_BACKLOG
;

1410 
£rv”
.
bšdaddr_couÁ
 = 0;

1411 
£rv”
.
unixsock‘
 = 
NULL
;

1412 
£rv”
.
unixsock‘³rm
 = 
REDIS_DEFAULT_UNIX_SOCKET_PERM
;

1413 
£rv”
.
fd_couÁ
 = 0;

1414 
£rv”
.
sofd
 = -1;

1415 
£rv”
.
dbnum
 = 
REDIS_DEFAULT_DBNUM
;

1416 
£rv”
.
v”bos™y
 = 
REDIS_DEFAULT_VERBOSITY
;

1417 
£rv”
.
maxidËtime
 = 
REDIS_MAXIDLETIME
;

1418 
£rv”
.
tık“·live
 = 
REDIS_DEFAULT_TCP_KEEPALIVE
;

1419 
£rv”
.
aùive_expœe_’abËd
 = 1;

1420 
£rv”
.
ş›Á_max_qu”ybuf_Ën
 = 
REDIS_MAX_QUERYBUF_LEN
;

1421 
£rv”
.
§v•¬ams
 = 
NULL
;

1422 
£rv”
.
lßdšg
 = 0;

1423 
£rv”
.
logfe
 = 
	`z¡rdup
(
REDIS_DEFAULT_LOGFILE
);

1424 
£rv”
.
sy¦og_’abËd
 = 
REDIS_DEFAULT_SYSLOG_ENABLED
;

1425 
£rv”
.
sy¦og_id’t
 = 
	`z¡rdup
(
REDIS_DEFAULT_SYSLOG_IDENT
);

1426 
£rv”
.
sy¦og_çc™y
 = 
LOG_LOCAL0
;

1427 
£rv”
.
d«mÚize
 = 
REDIS_DEFAULT_DAEMONIZE
;

1428 
£rv”
.
aof_¡©e
 = 
REDIS_AOF_OFF
;

1429 
£rv”
.
aof_fsync
 = 
REDIS_DEFAULT_AOF_FSYNC
;

1430 
£rv”
.
aof_no_fsync_Ú_»wr™e
 = 
REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
;

1431 
£rv”
.
aof_»wr™e_³rc
 = 
REDIS_AOF_REWRITE_PERC
;

1432 
£rv”
.
aof_»wr™e_mš_size
 = 
REDIS_AOF_REWRITE_MIN_SIZE
;

1433 
£rv”
.
aof_»wr™e_ba£_size
 = 0;

1434 
£rv”
.
aof_»wr™e_scheduËd
 = 0;

1435 
£rv”
.
aof_Ï¡_fsync
 = 
	`time
(
NULL
);

1436 
£rv”
.
aof_»wr™e_time_Ï¡
 = -1;

1437 
£rv”
.
aof_»wr™e_time_¡¬t
 = -1;

1438 
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 = 
REDIS_OK
;

1439 
£rv”
.
aof_d–ayed_fsync
 = 0;

1440 
£rv”
.
aof_fd
 = -1;

1441 
£rv”
.
aof_£Ëùed_db
 = -1;

1442 
£rv”
.
aof_æush_po¡pÚed_¡¬t
 = 0;

1443 
£rv”
.
aof_»wr™e_šüem’l_fsync
 = 
REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
;

1444 
£rv”
.
aof_lßd_Œunÿ‹d
 = 
REDIS_DEFAULT_AOF_LOAD_TRUNCATED
;

1445 
£rv”
.
pidfe
 = 
	`z¡rdup
(
REDIS_DEFAULT_PID_FILE
);

1446 
£rv”
.
rdb_f’ame
 = 
	`z¡rdup
(
REDIS_DEFAULT_RDB_FILENAME
);

1447 
£rv”
.
aof_f’ame
 = 
	`z¡rdup
(
REDIS_DEFAULT_AOF_FILENAME
);

1448 
£rv”
.
»quœ•ass
 = 
NULL
;

1449 
£rv”
.
rdb_com´essiÚ
 = 
REDIS_DEFAULT_RDB_COMPRESSION
;

1450 
£rv”
.
rdb_checksum
 = 
REDIS_DEFAULT_RDB_CHECKSUM
;

1451 
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 = 
REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
;

1452 
£rv”
.
aùiv”ehashšg
 = 
REDIS_DEFAULT_ACTIVE_REHASHING
;

1453 
£rv”
.
nÙify_key¥aû_ev’ts
 = 0;

1454 
£rv”
.
maxş›Ás
 = 
REDIS_MAX_CLIENTS
;

1455 
£rv”
.
bpİ_blocked_ş›Ás
 = 0;

1456 
£rv”
.
maxmemÜy
 = 
REDIS_DEFAULT_MAXMEMORY
;

1457 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_DEFAULT_MAXMEMORY_POLICY
;

1458 
£rv”
.
maxmemÜy_§m¶es
 = 
REDIS_DEFAULT_MAXMEMORY_SAMPLES
;

1459 
£rv”
.
hash_max_zli¡_’Œ›s
 = 
REDIS_HASH_MAX_ZIPLIST_ENTRIES
;

1460 
£rv”
.
hash_max_zli¡_v®ue
 = 
REDIS_HASH_MAX_ZIPLIST_VALUE
;

1461 
£rv”
.
li¡_max_zli¡_’Œ›s
 = 
REDIS_LIST_MAX_ZIPLIST_ENTRIES
;

1462 
£rv”
.
li¡_max_zli¡_v®ue
 = 
REDIS_LIST_MAX_ZIPLIST_VALUE
;

1463 
£rv”
.
£t_max_št£t_’Œ›s
 = 
REDIS_SET_MAX_INTSET_ENTRIES
;

1464 
£rv”
.
z£t_max_zli¡_’Œ›s
 = 
REDIS_ZSET_MAX_ZIPLIST_ENTRIES
;

1465 
£rv”
.
z£t_max_zli¡_v®ue
 = 
REDIS_ZSET_MAX_ZIPLIST_VALUE
;

1466 
£rv”
.
hÎ_¥¬£_max_by‹s
 = 
REDIS_DEFAULT_HLL_SPARSE_MAX_BYTES
;

1467 
£rv”
.
shutdown_a§p
 = 0;

1468 
£rv”
.
»¶_pšg_¦ave_³riod
 = 
REDIS_REPL_PING_SLAVE_PERIOD
;

1469 
£rv”
.
»¶_timeout
 = 
REDIS_REPL_TIMEOUT
;

1470 
£rv”
.
»¶_mš_¦aves_to_wr™e
 = 
REDIS_DEFAULT_MIN_SLAVES_TO_WRITE
;

1471 
£rv”
.
»¶_mš_¦aves_max_Ïg
 = 
REDIS_DEFAULT_MIN_SLAVES_MAX_LAG
;

1472 
£rv”
.
şu¡”_’abËd
 = 0;

1473 
£rv”
.
şu¡”_node_timeout
 = 
REDIS_CLUSTER_DEFAULT_NODE_TIMEOUT
;

1474 
£rv”
.
şu¡”_mig¿tiÚ_b¬r›r
 = 
REDIS_CLUSTER_DEFAULT_MIGRATION_BARRIER
;

1475 
£rv”
.
şu¡”_¦ave_v®id™y_çùÜ
 = 
REDIS_CLUSTER_DEFAULT_SLAVE_VALIDITY
;

1476 
£rv”
.
şu¡”_»quœe_fuÎ_cov”age
 = 
REDIS_CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE
;

1477 
£rv”
.
şu¡”_cÚfigfe
 = 
	`z¡rdup
(
REDIS_DEFAULT_CLUSTER_CONFIG_FILE
);

1478 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

1479 
£rv”
.
lua_time_lim™
 = 
REDIS_LUA_TIME_LIMIT
;

1480 
£rv”
.
lua_ş›Á
 = 
NULL
;

1481 
£rv”
.
lua_timedout
 = 0;

1482 
£rv”
.
mig¿‹_ÿched_sock‘s
 = 
	`diùC»©e
(&
mig¿‹CacheDiùTy³
,
NULL
);

1483 
£rv”
.
Ãxt_ş›Á_id
 = 1;

1484 
£rv”
.
lßdšg_´oûss_ev’ts_š‹rv®_by‹s
 = (1024*1024*2);

1486 
£rv”
.
Ìuşock
 = 
	`g‘LRUClock
();

1487 
	`»£tS”v”SaveP¬ams
();

1489 
	`­³ndS”v”SaveP¬ams
(60*60,1);

1490 
	`­³ndS”v”SaveP¬ams
(300,100);

1491 
	`­³ndS”v”SaveP¬ams
(60,10000);

1493 
£rv”
.
ma¡”auth
 = 
NULL
;

1494 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1495 
£rv”
.
ma¡”pÜt
 = 6379;

1496 
£rv”
.
ma¡”
 = 
NULL
;

1497 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1498 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = -1;

1499 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_NONE
;

1500 
£rv”
.
»¶_syncio_timeout
 = 
REDIS_REPL_SYNCIO_TIMEOUT
;

1501 
£rv”
.
»¶_£rve_¡®e_d©a
 = 
REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA
;

1502 
£rv”
.
»¶_¦ave_ro
 = 
REDIS_DEFAULT_SLAVE_READ_ONLY
;

1503 
£rv”
.
»¶_down_sšû
 = 0;

1504 
£rv”
.
»¶_di§bË_tı_nod–ay
 = 
REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY
;

1505 
£rv”
.
»¶_diskËss_sync
 = 
REDIS_DEFAULT_REPL_DISKLESS_SYNC
;

1506 
£rv”
.
»¶_diskËss_sync_d–ay
 = 
REDIS_DEFAULT_REPL_DISKLESS_SYNC_DELAY
;

1507 
£rv”
.
¦ave_´iÜ™y
 = 
REDIS_DEFAULT_SLAVE_PRIORITY
;

1508 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1511 
£rv”
.
»¶_backlog
 = 
NULL
;

1512 
£rv”
.
»¶_backlog_size
 = 
REDIS_DEFAULT_REPL_BACKLOG_SIZE
;

1513 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

1514 
£rv”
.
»¶_backlog_idx
 = 0;

1515 
£rv”
.
»¶_backlog_off
 = 0;

1516 
£rv”
.
»¶_backlog_time_lim™
 = 
REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT
;

1517 
£rv”
.
»¶_no_¦aves_sšû
 = 
	`time
(
NULL
);

1520 
j
 = 0; j < 
REDIS_CLIENT_TYPE_COUNT
; j++)

1521 
£rv”
.
ş›Á_obuf_lim™s
[
j
] = 
ş›ÁBufãrLim™sDeçuÉs
[j];

1524 
R_Z”o
 = 0.0;

1525 
R_PosInf
 = 1.0/
R_Z”o
;

1526 
R_NegInf
 = -1.0/
R_Z”o
;

1527 
R_Nª
 = 
R_Z”o
/R_Zero;

1532 
£rv”
.
commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1533 
£rv”
.
Üig_commªds
 = 
	`diùC»©e
(&
commªdTabËDiùTy³
,
NULL
);

1534 
	`pİuÏ‹CommªdTabË
();

1535 
£rv”
.
d–Commªd
 = 
	`lookupCommªdByCSŒšg
("del");

1536 
£rv”
.
muÉiCommªd
 = 
	`lookupCommªdByCSŒšg
("multi");

1537 
£rv”
.
ÍushCommªd
 = 
	`lookupCommªdByCSŒšg
("lpush");

1538 
£rv”
.
ÍİCommªd
 = 
	`lookupCommªdByCSŒšg
("lpop");

1539 
£rv”
.
½İCommªd
 = 
	`lookupCommªdByCSŒšg
("rpop");

1542 
£rv”
.
¦owlog_log_¦ow”_thª
 = 
REDIS_SLOWLOG_LOG_SLOWER_THAN
;

1543 
£rv”
.
¦owlog_max_Ën
 = 
REDIS_SLOWLOG_MAX_LEN
;

1546 
£rv”
.
Ï‹ncy_mÚ™Ü_th»shŞd
 = 
REDIS_DEFAULT_LATENCY_MONITOR_THRESHOLD
;

1549 
£rv”
.
as£¹_çed
 = "<no‡ssertion failed>";

1550 
£rv”
.
as£¹_fe
 = "<no file>";

1551 
£rv”
.
as£¹_lše
 = 0;

1552 
£rv”
.
bug_»pÜt_¡¬t
 = 0;

1553 
£rv”
.
w©chdog_³riod
 = 0;

1554 
	}
}

1564 
	$adju¡O³nFesLim™
() {

1565 
¾im_t
 
maxfes
 = 
£rv”
.
maxş›Ás
+
REDIS_MIN_RESERVED_FDS
;

1566 
¾im™
 
lim™
;

1568 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
,&
lim™
) == -1) {

1569 
	`»disLog
(
REDIS_WARNING
,"Unableo obtainhe current NOFILE†imit (%s),‡ssuming 1024‡nd settinghe max clients configuration‡ccordingly.",

1570 
	`¡»¼Ü
(
”ºo
));

1571 
£rv”
.
maxş›Ás
 = 1024-
REDIS_MIN_RESERVED_FDS
;

1573 
¾im_t
 
Şdlim™
 = 
lim™
.
¾im_cur
;

1577 ià(
Şdlim™
 < 
maxfes
) {

1578 
¾im_t
 
be¡lim™
;

1579 
£Œlim™_”rÜ
 = 0;

1583 
be¡lim™
 = 
maxfes
;

1584 
be¡lim™
 > 
Şdlim™
) {

1585 
¾im_t
 
deü_¡•
 = 16;

1587 
lim™
.
¾im_cur
 = 
be¡lim™
;

1588 
lim™
.
¾im_max
 = 
be¡lim™
;

1589 ià(
	`£Œlim™
(
RLIMIT_NOFILE
,&
lim™
) != -1) ;

1590 
£Œlim™_”rÜ
 = 
”ºo
;

1594 ià(
be¡lim™
 < 
deü_¡•
) ;

1595 
be¡lim™
 -ğ
deü_¡•
;

1600 ià(
be¡lim™
 < 
Şdlim™
) bestlimit = oldlimit;

1602 ià(
be¡lim™
 < 
maxfes
) {

1603 
Şd_maxş›Ás
 = 
£rv”
.
maxş›Ás
;

1604 
£rv”
.
maxş›Ás
 = 
be¡lim™
-
REDIS_MIN_RESERVED_FDS
;

1605 ià(
£rv”
.
maxş›Ás
 < 1) {

1606 
	`»disLog
(
REDIS_WARNING
,"Your current 'ulimit -n' "

1610 (è
Şdlim™
,

1611 (è
maxfes
);

1612 
	`ex™
(1);

1614 
	`»disLog
(
REDIS_WARNING
,"You„equested maxclients of %d "

1616 
Şd_maxş›Ás
,

1617 (è
maxfes
);

1618 
	`»disLog
(
REDIS_WARNING
,"Redis can't set maximum open files "

1620 (è
maxfes
, 
	`¡»¼Ü
(
£Œlim™_”rÜ
));

1621 
	`»disLog
(
REDIS_WARNING
,"Current maximum open files is %llu. "

1625 (è
be¡lim™
, 
£rv”
.
maxş›Ás
);

1627 
	`»disLog
(
REDIS_NOTICE
,"Increased maximum‚umber of open files "

1629 (è
maxfes
,

1630 (è
Şdlim™
);

1634 
	}
}

1638 
	$checkTıBacklogS‘tšgs
() {

1639 #ifdeà
HAVE_PROC_SOMAXCONN


1640 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/net/core/somaxconn","r");

1641 
buf
[1024];

1642 ià(!
å
) ;

1643 ià(
	`fg‘s
(
buf
,(buf),
å
è!ğ
NULL
) {

1644 
somaxcÚn
 = 
	`©oi
(
buf
);

1645 ià(
somaxcÚn
 > 0 && somaxcÚÀ< 
£rv”
.
tı_backlog
) {

1646 
	`»disLog
(
REDIS_WARNING
,"WARNING: ThTCP backlog s‘tšg oà%d cªnÙ b’fÜûd beÿu£ /´oc/sys/Ãt/cÜe/somaxcÚÀi £ˆtØthlow” v®uoà%d.", 
£rv”
.
tı_backlog
, 
somaxcÚn
);

1649 
	`fşo£
(
å
);

1651 
	}
}

1671 
	$li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
) {

1672 
j
;

1676 ià(
£rv”
.
bšdaddr_couÁ
 =ğ0è£rv”.
bšdaddr
[0] = 
NULL
;

1677 
j
 = 0; j < 
£rv”
.
bšdaddr_couÁ
 || j == 0; j++) {

1678 ià(
£rv”
.
bšdaddr
[
j
] =ğ
NULL
) {

1681 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1682 
£rv”
.
tı_backlog
);

1683 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1684 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1685 (*
couÁ
)++;

1687 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,
NULL
,

1688 
£rv”
.
tı_backlog
);

1689 ià(
fds
[*
couÁ
] !ğ
ANET_ERR
) {

1690 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1691 (*
couÁ
)++;

1696 ià(*
couÁ
) ;

1697 } ià(
	`¡rchr
(
£rv”
.
bšdaddr
[
j
],':')) {

1699 
fds
[*
couÁ
] = 
	`ª‘Tı6S”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1700 
£rv”
.
tı_backlog
);

1703 
fds
[*
couÁ
] = 
	`ª‘TıS”v”
(
£rv”
.
Ã‹¼
,
pÜt
,£rv”.
bšdaddr
[
j
],

1704 
£rv”
.
tı_backlog
);

1706 ià(
fds
[*
couÁ
] =ğ
ANET_ERR
) {

1707 
	`»disLog
(
REDIS_WARNING
,

1709 
£rv”
.
bšdaddr
[
j
] ? server.bindaddr[j] : "*",

1710 
pÜt
, 
£rv”
.
Ã‹¼
);

1711  
REDIS_ERR
;

1713 
	`ª‘NÚBlock
(
NULL
,
fds
[*
couÁ
]);

1714 (*
couÁ
)++;

1716  
REDIS_OK
;

1717 
	}
}

1722 
	$»£tS”v”Sts
() {

1723 
j
;

1725 
£rv”
.
¡©_numcommªds
 = 0;

1726 
£rv”
.
¡©_numcÚÃùiÚs
 = 0;

1727 
£rv”
.
¡©_expœedkeys
 = 0;

1728 
£rv”
.
¡©_eviùedkeys
 = 0;

1729 
£rv”
.
¡©_key¥aû_mis£s
 = 0;

1730 
£rv”
.
¡©_key¥aû_h™s
 = 0;

1731 
£rv”
.
¡©_fÜk_time
 = 0;

1732 
£rv”
.
¡©_fÜk_¿‹
 = 0;

1733 
£rv”
.
¡©_»jeùed_cÚn
 = 0;

1734 
£rv”
.
¡©_sync_fuÎ
 = 0;

1735 
£rv”
.
¡©_sync_·¹Ÿl_ok
 = 0;

1736 
£rv”
.
¡©_sync_·¹Ÿl_”r
 = 0;

1737 
j
 = 0; j < 
REDIS_METRIC_COUNT
; j++) {

1738 
£rv”
.
š¡_m‘ric
[
j
].
idx
 = 0;

1739 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_time
 = 
	`m¡ime
();

1740 
£rv”
.
š¡_m‘ric
[
j
].
Ï¡_§m¶e_couÁ
 = 0;

1741 
	`mem£t
(
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
,0,

1742 (
£rv”
.
š¡_m‘ric
[
j
].
§m¶es
));

1744 
£rv”
.
¡©_Ãt_šput_by‹s
 = 0;

1745 
£rv”
.
¡©_Ãt_ouut_by‹s
 = 0;

1746 
	}
}

1748 
	$š™S”v”
() {

1749 
j
;

1751 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1752 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1753 
	`£tupSigÇlHªdËrs
();

1755 ià(
£rv”
.
sy¦og_’abËd
) {

1756 
	`İ’log
(
£rv”
.
sy¦og_id’t
, 
LOG_PID
 | 
LOG_NDELAY
 | 
LOG_NOWAIT
,

1757 
£rv”
.
sy¦og_çc™y
);

1760 
£rv”
.
pid
 = 
	`g‘pid
();

1761 
£rv”
.
cu¼’t_ş›Á
 = 
NULL
;

1762 
£rv”
.
ş›Ás
 = 
	`li¡C»©e
();

1763 
£rv”
.
ş›Ás_to_şo£
 = 
	`li¡C»©e
();

1764 
£rv”
.
¦aves
 = 
	`li¡C»©e
();

1765 
£rv”
.
mÚ™Üs
 = 
	`li¡C»©e
();

1766 
£rv”
.
¦ave£ldb
 = -1;

1767 
£rv”
.
unblocked_ş›Ás
 = 
	`li¡C»©e
();

1768 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

1769 
£rv”
.
ş›Ás_wa™šg_acks
 = 
	`li¡C»©e
();

1770 
£rv”
.
g‘_ack_äom_¦aves
 = 0;

1771 
£rv”
.
ş›Ás_·u£d
 = 0;

1773 
	`ü—‹Sh¬edObjeùs
();

1774 
	`adju¡O³nFesLim™
();

1775 
£rv”
.
–
 = 
	`«C»©eEv’tLoİ
(£rv”.
maxş›Ás
+
REDIS_EVENTLOOP_FDSET_INCR
);

1776 
£rv”
.
db
 = 
	`zm®loc
((
»disDb
)*£rv”.
dbnum
);

1779 ià(
£rv”
.
pÜt
 != 0 &&

1780 
	`li¡’ToPÜt
(
£rv”
.
pÜt
,£rv”.
fd
,&£rv”.
fd_couÁ
è=ğ
REDIS_ERR
)

1781 
	`ex™
(1);

1784 ià(
£rv”
.
unixsock‘
 !ğ
NULL
) {

1785 
	`uÆšk
(
£rv”
.
unixsock‘
);

1786 
£rv”
.
sofd
 = 
	`ª‘UnixS”v”
(£rv”.
Ã‹¼
,£rv”.
unixsock‘
,

1787 
£rv”
.
unixsock‘³rm
, s”v”.
tı_backlog
);

1788 ià(
£rv”
.
sofd
 =ğ
ANET_ERR
) {

1789 
	`»disLog
(
REDIS_WARNING
, "O³nšg Unix sock‘: %s", 
£rv”
.
Ã‹¼
);

1790 
	`ex™
(1);

1792 
	`ª‘NÚBlock
(
NULL
,
£rv”
.
sofd
);

1796 ià(
£rv”
.
fd_couÁ
 =ğ0 && s”v”.
sofd
 < 0) {

1797 
	`»disLog
(
REDIS_WARNING
, "Configuredo‚ot†isten‡nywhere,ƒxiting.");

1798 
	`ex™
(1);

1802 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

1803 
£rv”
.
db
[
j
].
diù
 = 
	`diùC»©e
(&
dbDiùTy³
,
NULL
);

1804 
£rv”
.
db
[
j
].
expœes
 = 
	`diùC»©e
(&
key±rDiùTy³
,
NULL
);

1805 
£rv”
.
db
[
j
].
blockšg_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1806 
£rv”
.
db
[
j
].
»ady_keys
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

1807 
£rv”
.
db
[
j
].
w©ched_keys
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1808 
£rv”
.
db
[
j
].
eviùiÚ_poŞ
 = 
	`eviùiÚPoŞAÎoc
();

1809 
£rv”
.
db
[
j
].
id
 = j;

1810 
£rv”
.
db
[
j
].
avg_‰l
 = 0;

1812 
£rv”
.
pubsub_chªÃls
 = 
	`diùC»©e
(&
keyli¡DiùTy³
,
NULL
);

1813 
£rv”
.
pubsub_·‰”ns
 = 
	`li¡C»©e
();

1814 
	`li¡S‘F»eM‘hod
(
£rv”
.
pubsub_·‰”ns
,
ä“PubsubP©‹º
);

1815 
	`li¡S‘M©chM‘hod
(
£rv”
.
pubsub_·‰”ns
,
li¡M©chPubsubP©‹º
);

1816 
£rv”
.
üÚloİs
 = 0;

1817 
£rv”
.
rdb_chd_pid
 = -1;

1818 
£rv”
.
aof_chd_pid
 = -1;

1819 
£rv”
.
rdb_chd_ty³
 = 
REDIS_RDB_CHILD_TYPE_NONE
;

1820 
	`aofRewr™eBufãrRe£t
();

1821 
£rv”
.
aof_buf
 = 
	`sd£m±y
();

1822 
£rv”
.
Ï¡§ve
 = 
	`time
(
NULL
);

1823 
£rv”
.
Ï¡bg§ve_Œy
 = 0;

1824 
£rv”
.
rdb_§ve_time_Ï¡
 = -1;

1825 
£rv”
.
rdb_§ve_time_¡¬t
 = -1;

1826 
£rv”
.
dœty
 = 0;

1827 
	`»£tS”v”Sts
();

1829 
£rv”
.
¡©_¡¬‰ime
 = 
	`time
(
NULL
);

1830 
£rv”
.
¡©_³ak_memÜy
 = 0;

1831 
£rv”
.
»sid’t_£t_size
 = 0;

1832 
£rv”
.
Ï¡bg§ve_¡©us
 = 
REDIS_OK
;

1833 
£rv”
.
aof_Ï¡_wr™e_¡©us
 = 
REDIS_OK
;

1834 
£rv”
.
aof_Ï¡_wr™e_”ºo
 = 0;

1835 
£rv”
.
»¶_good_¦aves_couÁ
 = 0;

1836 
	`upd©eCachedTime
();

1840 if(
	`«C»©eTimeEv’t
(
£rv”
.
–
, 1, 
£rv”CrÚ
, 
NULL
, NULLè=ğ
AE_ERR
) {

1841 
	`»disPªic
("Can't createhe serverCronimeƒvent.");

1842 
	`ex™
(1);

1847 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++) {

1848 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, s”v”.
fd
[
j
], 
AE_READABLE
,

1849 
acû±TıHªdËr
,
NULL
è=ğ
AE_ERR
)

1851 
	`»disPªic
(

1855 ià(
£rv”
.
sofd
 > 0 && 
	`«C»©eFeEv’t
(£rv”.
–
,£rv”.sofd,
AE_READABLE
,

1856 
acû±UnixHªdËr
,
NULL
è=ğ
AE_ERR
è
	`»disPªic
("Unrecoverableƒrror creating server.sofd fileƒvent.");

1859 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_ON
) {

1860 
£rv”
.
aof_fd
 = 
	`İ’
(£rv”.
aof_f’ame
,

1861 
O_WRONLY
|
O_APPEND
|
O_CREAT
,0644);

1862 ià(
£rv”
.
aof_fd
 == -1) {

1863 
	`»disLog
(
REDIS_WARNING
, "Can't openhe‡ppend-only file: %s",

1864 
	`¡»¼Ü
(
”ºo
));

1865 
	`ex™
(1);

1873 ià(
£rv”
.
¬ch_b™s
 =ğ32 && s”v”.
maxmemÜy
 == 0) {

1874 
	`»disLog
(
REDIS_WARNING
,"Warning: 32 bit instance detected but‚o memory†imit set. Setting 3 GB maxmemory†imit with 'noeviction'…olicy‚ow.");

1875 
£rv”
.
maxmemÜy
 = 3072LL*(1024*1024);

1876 
£rv”
.
maxmemÜy_pŞicy
 = 
REDIS_MAXMEMORY_NO_EVICTION
;

1879 ià(
£rv”
.
şu¡”_’abËd
è
	`şu¡”In™
();

1880 
	`»¶iÿtiÚSütCacheIn™
();

1881 
	`sütšgIn™
();

1882 
	`¦owlogIn™
();

1883 
	`Ï‹ncyMÚ™ÜIn™
();

1884 
	`bioIn™
();

1885 
	}
}

1889 
	$pİuÏ‹CommªdTabË
() {

1890 
j
;

1891 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1893 
j
 = 0; j < 
numcommªds
; j++) {

1894 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1895 *
f
 = 
c
->
sæags
;

1896 
»tv®1
, 
»tv®2
;

1898 *
f
 != '\0') {

1899 *
f
) {

1900 'w': 
c
->
æags
 |ğ
REDIS_CMD_WRITE
; ;

1901 'r': 
c
->
æags
 |ğ
REDIS_CMD_READONLY
; ;

1902 'm': 
c
->
æags
 |ğ
REDIS_CMD_DENYOOM
; ;

1903 'a': 
c
->
æags
 |ğ
REDIS_CMD_ADMIN
; ;

1904 'p': 
c
->
æags
 |ğ
REDIS_CMD_PUBSUB
; ;

1905 's': 
c
->
æags
 |ğ
REDIS_CMD_NOSCRIPT
; ;

1906 'R': 
c
->
æags
 |ğ
REDIS_CMD_RANDOM
; ;

1907 'S': 
c
->
æags
 |ğ
REDIS_CMD_SORT_FOR_SCRIPT
; ;

1908 'l': 
c
->
æags
 |ğ
REDIS_CMD_LOADING
; ;

1909 't': 
c
->
æags
 |ğ
REDIS_CMD_STALE
; ;

1910 'M': 
c
->
æags
 |ğ
REDIS_CMD_SKIP_MONITOR
; ;

1911 'k': 
c
->
æags
 |ğ
REDIS_CMD_ASKING
; ;

1912 'F': 
c
->
æags
 |ğ
REDIS_CMD_FAST
; ;

1913 : 
	`»disPªic
("Unsupported command flag"); ;

1915 
f
++;

1918 
»tv®1
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1921 
»tv®2
 = 
	`diùAdd
(
£rv”
.
Üig_commªds
, 
	`sd¢ew
(
c
->
Çme
), c);

1922 
	`»disAs£¹
(
»tv®1
 =ğ
DICT_OK
 && 
»tv®2
 == DICT_OK);

1924 
	}
}

1926 
	$»£tCommªdTabËSts
() {

1927 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

1928 
j
;

1930 
j
 = 0; j < 
numcommªds
; j++) {

1931 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

1933 
c
->
miüo£cÚds
 = 0;

1934 
c
->
ÿÎs
 = 0;

1936 
	}
}

1940 
	$»disOpA¼ayIn™
(
»disOpA¼ay
 *
ß
) {

1941 
ß
->
İs
 = 
NULL
;

1942 
ß
->
numİs
 = 0;

1943 
	}
}

1945 
	$»disOpA¼ayAµ’d
(
»disOpA¼ay
 *
ß
, 
»disCommªd
 *
cmd
, 
dbid
,

1946 
robj
 **
¬gv
, 
¬gc
, 
rg‘
)

1948 
»disOp
 *
İ
;

1950 
ß
->
İs
 = 
	`z»®loc
(ß->İs,(
»disOp
)*(ß->
numİs
+1));

1951 
İ
 = 
ß
->
İs
+ß->
numİs
;

1952 
İ
->
cmd
 = cmd;

1953 
İ
->
dbid
 = dbid;

1954 
İ
->
¬gv
 =‡rgv;

1955 
İ
->
¬gc
 =‡rgc;

1956 
İ
->
rg‘
 =arget;

1957 
ß
->
numİs
++;

1958  
ß
->
numİs
;

1959 
	}
}

1961 
	$»disOpA¼ayF»e
(
»disOpA¼ay
 *
ß
) {

1962 
ß
->
numİs
) {

1963 
j
;

1964 
»disOp
 *
İ
;

1966 
ß
->
numİs
--;

1967 
İ
 = 
ß
->
İs
+ß->
numİs
;

1968 
j
 = 0; j < 
İ
->
¬gc
; j++)

1969 
	`deüRefCouÁ
(
İ
->
¬gv
[
j
]);

1970 
	`zä“
(
İ
->
¬gv
);

1972 
	`zä“
(
ß
->
İs
);

1973 
	}
}

1977 
»disCommªd
 *
	$lookupCommªd
(
sds
 
Çme
) {

1978  
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

1979 
	}
}

1981 
»disCommªd
 *
	$lookupCommªdByCSŒšg
(*
s
) {

1982 
»disCommªd
 *
cmd
;

1983 
sds
 
Çme
 = 
	`sd¢ew
(
s
);

1985 
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

1986 
	`sdsä“
(
Çme
);

1987  
cmd
;

1988 
	}
}

1997 
»disCommªd
 *
	$lookupCommªdOrOrigš®
(
sds
 
Çme
) {

1998 
»disCommªd
 *
cmd
 = 
	`diùF‘chV®ue
(
£rv”
.
commªds
, 
Çme
);

2000 ià(!
cmd
ècmd = 
	`diùF‘chV®ue
(
£rv”
.
Üig_commªds
,
Çme
);

2001  
cmd
;

2002 
	}
}

2012 
	$´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2013 
æags
)

2015 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
 && 
æags
 & 
REDIS_PROPAGATE_AOF
)

2016 
	`ãedAµ’dOÆyFe
(
cmd
,
dbid
,
¬gv
,
¬gc
);

2017 ià(
æags
 & 
REDIS_PROPAGATE_REPL
)

2018 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
,
dbid
,
¬gv
,
¬gc
);

2019 
	}
}

2023 
	$®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
,

2024 
rg‘
)

2026 
	`»disOpA¼ayAµ’d
(&
£rv”
.
®so_´İag©e
,
cmd
,
dbid
,
¬gv
,
¬gc
,
rg‘
);

2027 
	}
}

2032 
	$fÜûCommªdPrİag©iÚ
(
»disCl›Á
 *
c
, 
æags
) {

2033 ià(
æags
 & 
REDIS_PROPAGATE_REPL
è
c
->æag |ğ
REDIS_FORCE_REPL
;

2034 ià(
æags
 & 
REDIS_PROPAGATE_AOF
è
c
->æag |ğ
REDIS_FORCE_AOF
;

2035 
	}
}

2038 
	$ÿÎ
(
»disCl›Á
 *
c
, 
æags
) {

2039 
dœty
, 
¡¬t
, 
du¿tiÚ
;

2040 
ş›Á_Şd_æags
 = 
c
->
æags
;

2044 ià(
	`li¡L’gth
(
£rv”
.
mÚ™Üs
) &&

2045 !
£rv”
.
lßdšg
 &&

2046 !(
c
->
cmd
->
æags
 & (
REDIS_CMD_SKIP_MONITOR
|
REDIS_CMD_ADMIN
)))

2048 
	`»¶iÿtiÚF“dMÚ™Üs
(
c
,
£rv”
.
mÚ™Üs
,c->
db
->
id
,c->
¬gv
,c->
¬gc
);

2052 
c
->
æags
 &ğ~(
REDIS_FORCE_AOF
|
REDIS_FORCE_REPL
);

2053 
	`»disOpA¼ayIn™
(&
£rv”
.
®so_´İag©e
);

2054 
dœty
 = 
£rv”
.dirty;

2055 
¡¬t
 = 
	`u¡ime
();

2056 
c
->
cmd
->
	`´oc
(c);

2057 
du¿tiÚ
 = 
	`u¡ime
()-
¡¬t
;

2058 
dœty
 = 
£rv”
.dirty-dirty;

2059 ià(
dœty
 < 0) dirty = 0;

2063 ià(
£rv”
.
lßdšg
 && 
c
->
æags
 & 
REDIS_LUA_CLIENT
)

2064 
æags
 &ğ~(
REDIS_CALL_SLOWLOG
 | 
REDIS_CALL_STATS
);

2069 ià(
c
->
æags
 & 
REDIS_LUA_CLIENT
 && 
£rv”
.
lua_ÿÎ”
) {

2070 ià(
c
->
æags
 & 
REDIS_FORCE_REPL
)

2071 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
REDIS_FORCE_REPL
;

2072 ià(
c
->
æags
 & 
REDIS_FORCE_AOF
)

2073 
£rv”
.
lua_ÿÎ”
->
æags
 |ğ
REDIS_FORCE_AOF
;

2078 ià(
æags
 & 
REDIS_CALL_SLOWLOG
 && 
c
->
cmd
->
´oc
 !ğ
execCommªd
) {

2079 *
Ï‹ncy_ev’t
 = (
c
->
cmd
->
æags
 & 
REDIS_CMD_FAST
) ?

2081 
	`Ï‹ncyAddSam¶eIfN“ded
(
Ï‹ncy_ev’t
,
du¿tiÚ
/1000);

2082 
	`¦owlogPushEÁryIfN“ded
(
c
->
¬gv
,c->
¬gc
,
du¿tiÚ
);

2084 ià(
æags
 & 
REDIS_CALL_STATS
) {

2085 
c
->
cmd
->
miüo£cÚds
 +ğ
du¿tiÚ
;

2086 
c
->
cmd
->
ÿÎs
++;

2090 ià(
æags
 & 
REDIS_CALL_PROPAGATE
) {

2091 
æags
 = 
REDIS_PROPAGATE_NONE
;

2093 ià(
c
->
æags
 & 
REDIS_FORCE_REPL
èæag |ğ
REDIS_PROPAGATE_REPL
;

2094 ià(
c
->
æags
 & 
REDIS_FORCE_AOF
èæag |ğ
REDIS_PROPAGATE_AOF
;

2095 ià(
dœty
)

2096 
æags
 |ğ(
REDIS_PROPAGATE_REPL
 | 
REDIS_PROPAGATE_AOF
);

2097 ià(
æags
 !ğ
REDIS_PROPAGATE_NONE
)

2098 
	`´İag©e
(
c
->
cmd
,c->
db
->
id
,c->
¬gv
,c->
¬gc
,
æags
);

2103 
c
->
æags
 &ğ~(
REDIS_FORCE_AOF
|
REDIS_FORCE_REPL
);

2104 
c
->
æags
 |ğ
ş›Á_Şd_æags
 & (
REDIS_FORCE_AOF
|
REDIS_FORCE_REPL
);

2108 ià(
£rv”
.
®so_´İag©e
.
numİs
) {

2109 
j
;

2110 
»disOp
 *
rİ
;

2112 
j
 = 0; j < 
£rv”
.
®so_´İag©e
.
numİs
; j++) {

2113 
rİ
 = &
£rv”
.
®so_´İag©e
.
İs
[
j
];

2114 
	`´İag©e
(
rİ
->
cmd
,„İ->
dbid
,„İ->
¬gv
,„İ->
¬gc
,„İ->
rg‘
);

2116 
	`»disOpA¼ayF»e
(&
£rv”
.
®so_´İag©e
);

2118 
£rv”
.
¡©_numcommªds
++;

2119 
	}
}

2129 
	$´oûssCommªd
(
»disCl›Á
 *
c
) {

2134 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"quit")) {

2135 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2136 
c
->
æags
 |ğ
REDIS_CLOSE_AFTER_REPLY
;

2137  
REDIS_ERR
;

2142 
c
->
cmd
 = c->
Ï¡cmd
 = 
	`lookupCommªd
(c->
¬gv
[0]->
±r
);

2143 ià(!
c
->
cmd
) {

2144 
	`æagT¿n§ùiÚ
(
c
);

2145 
	`addR•lyE¼ÜFÜm©
(
c
,"unknown command '%s'",

2146 (*)
c
->
¬gv
[0]->
±r
);

2147  
REDIS_OK
;

2148 } ià((
c
->
cmd
->
¬™y
 > 0 && c->cmd->¬™y !ğc->
¬gc
) ||

2149 (
c
->
¬gc
 < -c->
cmd
->
¬™y
)) {

2150 
	`æagT¿n§ùiÚ
(
c
);

2151 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2152 
c
->
cmd
->
Çme
);

2153  
REDIS_OK
;

2157 ià(
£rv”
.
»quœ•ass
 && !
c
->
auth’tiÿ‹d
 && c->
cmd
->
´oc
 !ğ
authCommªd
)

2159 
	`æagT¿n§ùiÚ
(
c
);

2160 
	`addR•ly
(
c
,
sh¬ed
.
nßuth”r
);

2161  
REDIS_OK
;

2168 ià(
£rv”
.
şu¡”_’abËd
 &&

2169 !(
c
->
æags
 & 
REDIS_MASTER
) &&

2170 !(
c
->
æags
 & 
REDIS_LUA_CLIENT
 &&

2171 
£rv”
.
lua_ÿÎ”
->
æags
 & 
REDIS_MASTER
) &&

2172 !(
c
->
cmd
->
g‘keys_´oc
 =ğ
NULL
 && c->cmd->
fœ¡key
 == 0))

2174 
hash¦Ù
;

2176 ià(
£rv”
.
şu¡”
->
¡©e
 !ğ
REDIS_CLUSTER_OK
) {

2177 
	`æagT¿n§ùiÚ
(
c
);

2178 
	`şu¡”RedœeùCl›Á
(
c
,
NULL
,0,
REDIS_CLUSTER_REDIR_DOWN_STATE
);

2179  
REDIS_OK
;

2181 
”rÜ_code
;

2182 
şu¡”Node
 *
n
 = 
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,&
hash¦Ù
,&
”rÜ_code
);

2183 ià(
n
 =ğ
NULL
 ||‚ !ğ
£rv”
.
şu¡”
->
my£lf
) {

2184 
	`æagT¿n§ùiÚ
(
c
);

2185 
	`şu¡”RedœeùCl›Á
(
c
,
n
,
hash¦Ù
,
”rÜ_code
);

2186  
REDIS_OK
;

2196 ià(
£rv”
.
maxmemÜy
) {

2197 
»tv®
 = 
	`ä“MemÜyIfN“ded
();

2198 ià((
c
->
cmd
->
æags
 & 
REDIS_CMD_DENYOOM
è&& 
»tv®
 =ğ
REDIS_ERR
) {

2199 
	`æagT¿n§ùiÚ
(
c
);

2200 
	`addR•ly
(
c
, 
sh¬ed
.
oom”r
);

2201  
REDIS_OK
;

2207 ià(((
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

2208 
£rv”
.
§v•¬am¦’
 > 0 &&

2209 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
REDIS_ERR
) ||

2210 
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
REDIS_ERR
) &&

2211 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2212 (
c
->
cmd
->
æags
 & 
REDIS_CMD_WRITE
 ||

2213 
c
->
cmd
->
´oc
 =ğ
pšgCommªd
))

2215 
	`æagT¿n§ùiÚ
(
c
);

2216 ià(
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
REDIS_OK
)

2217 
	`addR•ly
(
c
, 
sh¬ed
.
bg§v“¼
);

2219 
	`addR•lySds
(
c
,

2220 
	`sdsÿrštf
(
	`sd£m±y
(),

2222 
	`¡»¼Ü
(
£rv”
.
aof_Ï¡_wr™e_”ºo
)));

2223  
REDIS_OK
;

2228 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
 &&

2229 
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

2230 
£rv”
.
»¶_mš_¦aves_max_Ïg
 &&

2231 
c
->
cmd
->
æags
 & 
REDIS_CMD_WRITE
 &&

2232 
£rv”
.
»¶_good_¦aves_couÁ
 < s”v”.
»¶_mš_¦aves_to_wr™e
)

2234 
	`æagT¿n§ùiÚ
(
c
);

2235 
	`addR•ly
(
c
, 
sh¬ed
.
nÜ•liÿ£¼
);

2236  
REDIS_OK
;

2241 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

2242 !(
c
->
æags
 & 
REDIS_MASTER
) &&

2243 
c
->
cmd
->
æags
 & 
REDIS_CMD_WRITE
)

2245 
	`addR•ly
(
c
, 
sh¬ed
.
ro¦av“¼
);

2246  
REDIS_OK
;

2250 ià(
c
->
æags
 & 
REDIS_PUBSUB
 &&

2251 
c
->
cmd
->
´oc
 !ğ
pšgCommªd
 &&

2252 
c
->
cmd
->
´oc
 !ğ
subsüibeCommªd
 &&

2253 
c
->
cmd
->
´oc
 !ğ
unsubsüibeCommªd
 &&

2254 
c
->
cmd
->
´oc
 !ğ
psubsüibeCommªd
 &&

2255 
c
->
cmd
->
´oc
 !ğ
punsubsüibeCommªd
) {

2256 
	`addR•lyE¼Ü
(
c
,"only (P)SUBSCRIBE / (P)UNSUBSCRIBE / QUIT‡llowed inhis context");

2257  
REDIS_OK
;

2262 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REDIS_REPL_CONNECTED
 &&

2263 
£rv”
.
»¶_£rve_¡®e_d©a
 == 0 &&

2264 !(
c
->
cmd
->
æags
 & 
REDIS_CMD_STALE
))

2266 
	`æagT¿n§ùiÚ
(
c
);

2267 
	`addR•ly
(
c
, 
sh¬ed
.
ma¡”dowÃ¼
);

2268  
REDIS_OK
;

2273 ià(
£rv”
.
lßdšg
 && !(
c
->
cmd
->
æags
 & 
REDIS_CMD_LOADING
)) {

2274 
	`addR•ly
(
c
, 
sh¬ed
.
lßdšg”r
);

2275  
REDIS_OK
;

2279 ià(
£rv”
.
lua_timedout
 &&

2280 
c
->
cmd
->
´oc
 !ğ
authCommªd
 &&

2281 
c
->
cmd
->
´oc
 !ğ
»¶cÚfCommªd
 &&

2282 !(
c
->
cmd
->
´oc
 =ğ
shutdownCommªd
 &&

2283 
c
->
¬gc
 == 2 &&

2284 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'n') &&

2285 !(
c
->
cmd
->
´oc
 =ğ
sütCommªd
 &&

2286 
c
->
¬gc
 == 2 &&

2287 
	`tŞow”
(((*)
c
->
¬gv
[1]->
±r
)[0]) == 'k'))

2289 
	`æagT¿n§ùiÚ
(
c
);

2290 
	`addR•ly
(
c
, 
sh¬ed
.
¦owsü‹¼
);

2291  
REDIS_OK
;

2295 ià(
c
->
æags
 & 
REDIS_MULTI
 &&

2296 
c
->
cmd
->
´oc
 !ğ
execCommªd
 && c->cmd->´oø!ğ
disÿrdCommªd
 &&

2297 
c
->
cmd
->
´oc
 !ğ
muÉiCommªd
 && c->cmd->´oø!ğ
w©chCommªd
)

2299 
	`queueMuÉiCommªd
(
c
);

2300 
	`addR•ly
(
c
,
sh¬ed
.
queued
);

2302 
	`ÿÎ
(
c
,
REDIS_CALL_FULL
);

2303 
c
->
woff
 = 
£rv”
.
ma¡”_»¶_off£t
;

2304 ià(
	`li¡L’gth
(
£rv”
.
»ady_keys
))

2305 
	`hªdËCl›ÁsBlockedOnLi¡s
();

2307  
REDIS_OK
;

2308 
	}
}

2314 
	$şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
) {

2315 
j
;

2317 
j
 = 0; j < 
£rv”
.
fd_couÁ
; j++è
	`şo£
(£rv”.
fd
[j]);

2318 ià(
£rv”
.
sofd
 !ğ-1è
	`şo£
(server.sofd);

2319 ià(
£rv”
.
şu¡”_’abËd
)

2320 
j
 = 0; j < 
£rv”
.
cfd_couÁ
; j++è
	`şo£
(£rv”.
cfd
[j]);

2321 ià(
uÆšk_unix_sock‘
 && 
£rv”
.
unixsock‘
) {

2322 
	`»disLog
(
REDIS_NOTICE
,"Removinghe unix socket file.");

2323 
	`uÆšk
(
£rv”
.
unixsock‘
);

2325 
	}
}

2327 
	$´•¬eFÜShutdown
(
æags
) {

2328 
§ve
 = 
æags
 & 
REDIS_SHUTDOWN_SAVE
;

2329 
no§ve
 = 
æags
 & 
REDIS_SHUTDOWN_NOSAVE
;

2331 
	`»disLog
(
REDIS_WARNING
,"User„equested shutdown...");

2335 ià(
£rv”
.
rdb_chd_pid
 != -1) {

2336 
	`»disLog
(
REDIS_WARNING
,"There is‡ child saving‡n .rdb. Killing it!");

2337 
	`kl
(
£rv”
.
rdb_chd_pid
,
SIGUSR1
);

2338 
	`rdbRemoveTempFe
(
£rv”
.
rdb_chd_pid
);

2340 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
) {

2343 ià(
£rv”
.
aof_chd_pid
 != -1) {

2346 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_WAIT_REWRITE
) {

2347 
	`»disLog
(
REDIS_WARNING
, "Writing initial AOF, can'tƒxit.");

2348  
REDIS_ERR
;

2350 
	`»disLog
(
REDIS_WARNING
,

2352 
	`kl
(
£rv”
.
aof_chd_pid
,
SIGUSR1
);

2355 
	`»disLog
(
REDIS_NOTICE
,"Calling fsync() onhe AOF file.");

2356 
	`aof_fsync
(
£rv”
.
aof_fd
);

2358 ià((
£rv”
.
§v•¬am¦’
 > 0 && !
no§ve
è|| 
§ve
) {

2359 
	`»disLog
(
REDIS_NOTICE
,"Savinghe final RDB snapshot beforeƒxiting.");

2361 ià(
	`rdbSave
(
£rv”
.
rdb_f’ame
è!ğ
REDIS_OK
) {

2367 
	`»disLog
(
REDIS_WARNING
,"Errorryingo savehe DB, can'tƒxit.");

2368  
REDIS_ERR
;

2371 ià(
£rv”
.
d«mÚize
) {

2372 
	`»disLog
(
REDIS_NOTICE
,"Removinghe…id file.");

2373 
	`uÆšk
(
£rv”
.
pidfe
);

2376 
	`şo£Li¡’šgSock‘s
(1);

2377 
	`»disLog
(
REDIS_WARNING
,"%s is‚ow„eadyoƒxit, bye bye...",

2378 
£rv”
.
£Áš–_mode
 ? "Sentinel" : "Redis");

2379  
REDIS_OK
;

2380 
	}
}

2393 
	$time_šd•’d’t_¡rcmp
(*
a
, *
b
) {

2394 
buç
[
REDIS_AUTHPASS_MAX_LEN
], 
bufb
[REDIS_AUTHPASS_MAX_LEN];

2399 
®’
 = 
	`¡¾’
(
a
);

2400 
bËn
 = 
	`¡¾’
(
b
);

2401 
j
;

2402 
diff
 = 0;

2407 ià(
®’
 > (
buç
è|| 
bËn
 > (
bufb
))  1;

2409 
	`mem£t
(
buç
,0,(bufa));

2410 
	`mem£t
(
bufb
,0,(bufb));

2413 
	`memıy
(
buç
,
a
,
®’
);

2414 
	`memıy
(
bufb
,
b
,
bËn
);

2418 
j
 = 0; j < (
buç
); j++) {

2419 
diff
 |ğ(
buç
[
j
] ^ 
bufb
[j]);

2422 
diff
 |ğ
®’
 ^ 
bËn
;

2423  
diff
;

2424 
	}
}

2426 
	$authCommªd
(
»disCl›Á
 *
c
) {

2427 ià(!
£rv”
.
»quœ•ass
) {

2428 
	`addR•lyE¼Ü
(
c
,"Client sent AUTH, but‚o…assword is set");

2429 } ià(!
	`time_šd•’d’t_¡rcmp
(
c
->
¬gv
[1]->
±r
, 
£rv”
.
»quœ•ass
)) {

2430 
c
->
auth’tiÿ‹d
 = 1;

2431 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2433 
c
->
auth’tiÿ‹d
 = 0;

2434 
	`addR•lyE¼Ü
(
c
,"invalid…assword");

2436 
	}
}

2440 
	$pšgCommªd
(
»disCl›Á
 *
c
) {

2442 ià(
c
->
¬gc
 > 2) {

2443 
	`addR•lyE¼ÜFÜm©
(
c
,"wrong‚umber of‡rguments for '%s' command",

2444 
c
->
cmd
->
Çme
);

2448 ià(
c
->
æags
 & 
REDIS_PUBSUB
) {

2449 
	`addR•ly
(
c
,
sh¬ed
.
mbulkhdr
[2]);

2450 
	`addR•lyBulkCBufãr
(
c
,"pong",4);

2451 ià(
c
->
¬gc
 == 1)

2452 
	`addR•lyBulkCBufãr
(
c
,"",0);

2454 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2456 ià(
c
->
¬gc
 == 1)

2457 
	`addR•ly
(
c
,
sh¬ed
.
pÚg
);

2459 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2461 
	}
}

2463 
	$echoCommªd
(
»disCl›Á
 *
c
) {

2464 
	`addR•lyBulk
(
c
,c->
¬gv
[1]);

2465 
	}
}

2467 
	$timeCommªd
(
»disCl›Á
 *
c
) {

2468 
timev®
 
tv
;

2472 
	`g‘timeofday
(&
tv
,
NULL
);

2473 
	`addR•lyMuÉiBulkL’
(
c
,2);

2474 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_£c
);

2475 
	`addR•lyBulkLÚgLÚg
(
c
,
tv
.
tv_u£c
);

2476 
	}
}

2480 
	$addR•lyCommªdFÏg
(
»disCl›Á
 *
c
, 
»disCommªd
 *
cmd
, 
f
, *
»¶y
) {

2481 ià(
cmd
->
æags
 & 
f
) {

2482 
	`addR•lyStus
(
c
, 
»¶y
);

2486 
	}
}

2489 
	$addR•lyCommªd
(
»disCl›Á
 *
c
, 
»disCommªd
 *
cmd
) {

2490 ià(!
cmd
) {

2491 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

2494 
	`addR•lyMuÉiBulkL’
(
c
, 6);

2495 
	`addR•lyBulkCSŒšg
(
c
, 
cmd
->
Çme
);

2496 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
¬™y
);

2498 
æagcouÁ
 = 0;

2499 *
æagËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2500 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_WRITE
, "write");

2501 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_READONLY
, "readonly");

2502 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_DENYOOM
, "denyoom");

2503 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_ADMIN
, "admin");

2504 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_PUBSUB
, "pubsub");

2505 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_NOSCRIPT
, "noscript");

2506 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_RANDOM
, "random");

2507 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_SORT_FOR_SCRIPT
,"sort_for_script");

2508 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_LOADING
, "loading");

2509 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_STALE
, "stale");

2510 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_SKIP_MONITOR
, "skip_monitor");

2511 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_ASKING
, "asking");

2512 
æagcouÁ
 +ğ
	`addR•lyCommªdFÏg
(
c
,
cmd
,
REDIS_CMD_FAST
, "fast");

2513 ià(
cmd
->
g‘keys_´oc
) {

2514 
	`addR•lyStus
(
c
, "movablekeys");

2515 
æagcouÁ
 += 1;

2517 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
æagËn
, 
æagcouÁ
);

2519 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
fœ¡key
);

2520 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
Ï¡key
);

2521 
	`addR•lyLÚgLÚg
(
c
, 
cmd
->
key¡•
);

2523 
	}
}

2526 
	$commªdCommªd
(
»disCl›Á
 *
c
) {

2527 
diùI‹¿tÜ
 *
di
;

2528 
diùEÁry
 *
de
;

2530 ià(
c
->
¬gc
 == 1) {

2531 
	`addR•lyMuÉiBulkL’
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2532 
di
 = 
	`diùG‘I‹¿tÜ
(
£rv”
.
commªds
);

2533 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2534 
	`addR•lyCommªd
(
c
, 
	`diùG‘V®
(
de
));

2536 
	`diùR–—£I‹¿tÜ
(
di
);

2537 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "info")) {

2538 
i
;

2539 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

2540 
i
 = 2; i < 
c
->
¬gc
; i++) {

2541 
	`addR•lyCommªd
(
c
, 
	`diùF‘chV®ue
(
£rv”
.
commªds
, c->
¬gv
[
i
]->
±r
));

2543 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
, "couÁ"è&& c->
¬gc
 == 2) {

2544 
	`addR•lyLÚgLÚg
(
c
, 
	`diùSize
(
£rv”
.
commªds
));

2545 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"g‘keys"è&& c->
¬gc
 >= 3) {

2546 
»disCommªd
 *
cmd
 = 
	`lookupCommªd
(
c
->
¬gv
[2]->
±r
);

2547 *
keys
, 
numkeys
, 
j
;

2549 ià(!
cmd
) {

2550 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid command specified");

2552 } ià((
cmd
->
¬™y
 > 0 && cmd->¬™y !ğ
c
->
¬gc
-2) ||

2553 ((
c
->
¬gc
-2è< -
cmd
->
¬™y
))

2555 
	`addR•lyE¼Ü
(
c
,"Invalid‚umber of‡rguments specified for command");

2559 
keys
 = 
	`g‘KeysFromCommªd
(
cmd
,
c
->
¬gv
+2,c->
¬gc
-2,&
numkeys
);

2560 
	`addR•lyMuÉiBulkL’
(
c
,
numkeys
);

2561 
j
 = 0; j < 
numkeys
; j++è
	`addR•lyBulk
(
c
,c->
¬gv
[
keys
[j]+2]);

2562 
	`g‘KeysF»eResuÉ
(
keys
);

2564 
	`addR•lyE¼Ü
(
c
, "Unknown subcommand or wrong‚umber of‡rguments.");

2567 
	}
}

2571 
	$by‹sToHumª
(*
s
, 
n
) {

2572 
d
;

2574 ià(
n
 < 1024) {

2576 
	`¥rštf
(
s
,"%ÎuB",
n
);

2578 } ià(
n
 < (1024*1024)) {

2579 
d
 = ()
n
/(1024);

2580 
	`¥rštf
(
s
,"%.2fK",
d
);

2581 } ià(
n
 < (1024LL*1024*1024)) {

2582 
d
 = ()
n
/(1024*1024);

2583 
	`¥rštf
(
s
,"%.2fM",
d
);

2584 } ià(
n
 < (1024LL*1024*1024*1024)) {

2585 
d
 = ()
n
/(1024LL*1024*1024);

2586 
	`¥rštf
(
s
,"%.2fG",
d
);

2587 } ià(
n
 < (1024LL*1024*1024*1024*1024)) {

2588 
d
 = ()
n
/(1024LL*1024*1024*1024);

2589 
	`¥rštf
(
s
,"%.2fT",
d
);

2590 } ià(
n
 < (1024LL*1024*1024*1024*1024*1024)) {

2591 
d
 = ()
n
/(1024LL*1024*1024*1024*1024);

2592 
	`¥rštf
(
s
,"%.2fP",
d
);

2595 
	`¥rštf
(
s
,"%ÎuB",
n
);

2597 
	}
}

2602 
sds
 
	$g’RedisInfoSŒšg
(*
£ùiÚ
) {

2603 
sds
 
šfo
 = 
	`sd£m±y
();

2604 
time_t
 
u±ime
 = 
£rv”
.
unixtime
-£rv”.
¡©_¡¬‰ime
;

2605 
j
, 
numcommªds
;

2606 
ru§ge
 
£lf_ru
, 
c_ru
;

2607 
lŞ
, 
bib
;

2608 
®l£ùiÚs
 = 0, 
def£ùiÚs
 = 0;

2609 
£ùiÚs
 = 0;

2611 ià(
£ùiÚ
 =ğ
NULL
) section = "default";

2612 
®l£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"all") == 0;

2613 
def£ùiÚs
 = 
	`¡rÿ£cmp
(
£ùiÚ
,"default") == 0;

2615 
	`g‘ru§ge
(
RUSAGE_SELF
, &
£lf_ru
);

2616 
	`g‘ru§ge
(
RUSAGE_CHILDREN
, &
c_ru
);

2617 
	`g‘Cl›ÁsMaxBufãrs
(&
lŞ
,&
bib
);

2620 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"server")) {

2621 
ÿÎ_uÇme
 = 1;

2622 
ut¢ame
 
Çme
;

2623 *
mode
;

2625 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

2626 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

2627 
mode
 = "standalone";

2629 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2631 ià(
ÿÎ_uÇme
) {

2633 
	`uÇme
(&
Çme
);

2634 
ÿÎ_uÇme
 = 0;

2637 
šfo
 = 
	`sdsÿrštf
(info,

2656 
REDIS_VERSION
,

2657 
	`»disG™SHA1
(),

2658 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

2659 (è
	`»disBudId
(),

2660 
mode
,

2661 
Çme
.
sy¢ame
,‚ame.
»Ëa£
,‚ame.
machše
,

2662 
£rv”
.
¬ch_b™s
,

2663 
	`«G‘ApiName
(),

2664 #ifdeà
__GNUC__


2665 
__GNUC__
,
__GNUC_MINOR__
,
__GNUC_PATCHLEVEL__
,

2669 (è
	`g‘pid
(),

2670 
£rv”
.
runid
,

2671 
£rv”
.
pÜt
,

2672 (
štmax_t
)
u±ime
,

2673 (
štmax_t
)(
u±ime
/(3600*24)),

2674 
£rv”
.
hz
,

2675 (è
£rv”
.
Ìuşock
,

2676 
£rv”
.
cÚfigfe
 ? server.configfile : "");

2680 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"clients")) {

2681 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2682 
šfo
 = 
	`sdsÿrštf
(info,

2688 
	`li¡L’gth
(
£rv”
.
ş›Ás
)-li¡L’gth(£rv”.
¦aves
),

2689 
lŞ
, 
bib
,

2690 
£rv”
.
bpİ_blocked_ş›Ás
);

2694 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"memory")) {

2695 
hmem
[64];

2696 
³ak_hmem
[64];

2697 
size_t
 
zm®loc_u£d
 = 
	`zm®loc_u£d_memÜy
();

2703 ià(
zm®loc_u£d
 > 
£rv”
.
¡©_³ak_memÜy
)

2704 
£rv”
.
¡©_³ak_memÜy
 = 
zm®loc_u£d
;

2706 
	`by‹sToHumª
(
hmem
,
zm®loc_u£d
);

2707 
	`by‹sToHumª
(
³ak_hmem
,
£rv”
.
¡©_³ak_memÜy
);

2708 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2709 
šfo
 = 
	`sdsÿrštf
(info,

2719 
zm®loc_u£d
,

2720 
hmem
,

2721 
£rv”
.
»sid’t_£t_size
,

2722 
£rv”
.
¡©_³ak_memÜy
,

2723 
³ak_hmem
,

2724 (()
	`lua_gc
(
£rv”
.
lua
,
LUA_GCCOUNT
,0))*1024LL,

2725 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
£rv”
.
»sid’t_£t_size
),

2726 
ZMALLOC_LIB


2731 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"persistence")) {

2732 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2733 
šfo
 = 
	`sdsÿrštf
(info,

2749 
£rv”
.
lßdšg
,

2750 
£rv”
.
dœty
,

2751 
£rv”
.
rdb_chd_pid
 != -1,

2752 (
štmax_t
)
£rv”
.
Ï¡§ve
,

2753 (
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
REDIS_OK
) ? "ok" : "err",

2754 (
štmax_t
)
£rv”
.
rdb_§ve_time_Ï¡
,

2755 (
štmax_t
)((
£rv”
.
rdb_chd_pid
 == -1) ?

2756 -1 : 
	`time
(
NULL
)-
£rv”
.
rdb_§ve_time_¡¬t
),

2757 
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
,

2758 
£rv”
.
aof_chd_pid
 != -1,

2759 
£rv”
.
aof_»wr™e_scheduËd
,

2760 (
štmax_t
)
£rv”
.
aof_»wr™e_time_Ï¡
,

2761 (
štmax_t
)((
£rv”
.
aof_chd_pid
 == -1) ?

2762 -1 : 
	`time
(
NULL
)-
£rv”
.
aof_»wr™e_time_¡¬t
),

2763 (
£rv”
.
aof_Ï¡bg»wr™e_¡©us
 =ğ
REDIS_OK
) ? "ok" : "err",

2764 (
£rv”
.
aof_Ï¡_wr™e_¡©us
 =ğ
REDIS_OK
) ? "ok" : "err");

2766 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
) {

2767 
šfo
 = 
	`sdsÿrštf
(info,

2775 (è
£rv”
.
aof_cu¼’t_size
,

2776 (è
£rv”
.
aof_»wr™e_ba£_size
,

2777 
£rv”
.
aof_»wr™e_scheduËd
,

2778 
	`sd¦’
(
£rv”
.
aof_buf
),

2779 
	`aofRewr™eBufãrSize
(),

2780 
	`bioP’dšgJobsOfTy³
(
REDIS_BIO_AOF_FSYNC
),

2781 
£rv”
.
aof_d–ayed_fsync
);

2784 ià(
£rv”
.
lßdšg
) {

2785 
³rc
;

2786 
time_t
 
‘a
, 
–­£d
;

2787 
off_t
 
»maššg_by‹s
 = 
£rv”
.
lßdšg_tÙ®_by‹s
-

2788 
£rv”
.
lßdšg_lßded_by‹s
;

2790 
³rc
 = (()
£rv”
.
lßdšg_lßded_by‹s
 /

2791 (
£rv”
.
lßdšg_tÙ®_by‹s
+1)) * 100;

2793 
–­£d
 = 
	`time
(
NULL
)-
£rv”
.
lßdšg_¡¬t_time
;

2794 ià(
–­£d
 == 0) {

2795 
‘a
 = 1;

2798 
‘a
 = (
–­£d
*
»maššg_by‹s
)/(
£rv”
.
lßdšg_lßded_by‹s
+1);

2801 
šfo
 = 
	`sdsÿrštf
(info,

2807 (
štmax_t
è
£rv”
.
lßdšg_¡¬t_time
,

2808 (è
£rv”
.
lßdšg_tÙ®_by‹s
,

2809 (è
£rv”
.
lßdšg_lßded_by‹s
,

2810 
³rc
,

2811 (
štmax_t
)
‘a


2817 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"stats")) {

2818 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2819 
šfo
 = 
	`sdsÿrštf
(info,

2840 
£rv”
.
¡©_numcÚÃùiÚs
,

2841 
£rv”
.
¡©_numcommªds
,

2842 
	`g‘In¡ªÃousM‘ric
(
REDIS_METRIC_COMMAND
),

2843 
£rv”
.
¡©_Ãt_šput_by‹s
,

2844 
£rv”
.
¡©_Ãt_ouut_by‹s
,

2845 ()
	`g‘In¡ªÃousM‘ric
(
REDIS_METRIC_NET_INPUT
)/1024,

2846 ()
	`g‘In¡ªÃousM‘ric
(
REDIS_METRIC_NET_OUTPUT
)/1024,

2847 
£rv”
.
¡©_»jeùed_cÚn
,

2848 
£rv”
.
¡©_sync_fuÎ
,

2849 
£rv”
.
¡©_sync_·¹Ÿl_ok
,

2850 
£rv”
.
¡©_sync_·¹Ÿl_”r
,

2851 
£rv”
.
¡©_expœedkeys
,

2852 
£rv”
.
¡©_eviùedkeys
,

2853 
£rv”
.
¡©_key¥aû_h™s
,

2854 
£rv”
.
¡©_key¥aû_mis£s
,

2855 
	`diùSize
(
£rv”
.
pubsub_chªÃls
),

2856 
	`li¡L’gth
(
£rv”
.
pubsub_·‰”ns
),

2857 
£rv”
.
¡©_fÜk_time
,

2858 
	`diùSize
(
£rv”
.
mig¿‹_ÿched_sock‘s
));

2862 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"replication")) {

2863 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2864 
šfo
 = 
	`sdsÿrštf
(info,

2867 
£rv”
.
ma¡”ho¡
 =ğ
NULL
 ? "master" : "slave");

2868 ià(
£rv”
.
ma¡”ho¡
) {

2869 
¦ave_»¶_off£t
 = 1;

2871 ià(
£rv”
.
ma¡”
)

2872 
¦ave_»¶_off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

2873 ià(
£rv”
.
ÿched_ma¡”
)

2874 
¦ave_»¶_off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

2876 
šfo
 = 
	`sdsÿrštf
(info,

2883 ,
£rv”
.
ma¡”ho¡
,

2884 
£rv”
.
ma¡”pÜt
,

2885 (
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTED
) ?

2887 
£rv”
.
ma¡”
 ?

2888 (()(
£rv”
.
unixtime
-£rv”.
ma¡”
->
Ï¡š‹¿ùiÚ
)) : -1,

2889 
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
,

2890 
¦ave_»¶_off£t


2893 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
) {

2894 
šfo
 = 
	`sdsÿrštf
(info,

2898 (
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
),

2899 ()(
£rv”
.
unixtime
-£rv”.
»¶_Œªsãr_Ï¡io
)

2903 ià(
£rv”
.
»¶_¡©e
 !ğ
REDIS_REPL_CONNECTED
) {

2904 
šfo
 = 
	`sdsÿrštf
(info,

2906 (
štmax_t
)
£rv”
.
unixtime
-£rv”.
»¶_down_sšû
);

2908 
šfo
 = 
	`sdsÿrštf
(info,

2911 
£rv”
.
¦ave_´iÜ™y
,

2912 
£rv”
.
»¶_¦ave_ro
);

2915 
šfo
 = 
	`sdsÿrštf
(info,

2917 
	`li¡L’gth
(
£rv”
.
¦aves
));

2921 ià(
£rv”
.
»¶_mš_¦aves_to_wr™e
 &&

2922 
£rv”
.
»¶_mš_¦aves_max_Ïg
) {

2923 
šfo
 = 
	`sdsÿrštf
(info,

2925 
£rv”
.
»¶_good_¦aves_couÁ
);

2928 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

2929 
¦aveid
 = 0;

2930 
li¡Node
 *
Ê
;

2931 
li¡I‹r
 
li
;

2933 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2934 (
Ê
 = 
	`li¡Next
(&
li
))) {

2935 
»disCl›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

2936 *
¡©e
 = 
NULL
;

2937 

[
REDIS_IP_STR_LEN
];

2938 
pÜt
;

2939 
Ïg
 = 0;

2941 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),&
pÜt
) == -1) ;

2942 
¦ave
->
»¶¡©e
) {

2943 
REDIS_REPL_WAIT_BGSAVE_START
:

2944 
REDIS_REPL_WAIT_BGSAVE_END
:

2945 
¡©e
 = "wait_bgsave";

2947 
REDIS_REPL_SEND_BULK
:

2948 
¡©e
 = "send_bulk";

2950 
REDIS_REPL_ONLINE
:

2951 
¡©e
 = "online";

2954 ià(
¡©e
 =ğ
NULL
) ;

2955 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_ONLINE
)

2956 
Ïg
 = 
	`time
(
NULL
è- 
¦ave
->
»¶_ack_time
;

2958 
šfo
 = 
	`sdsÿrštf
(info,

2961 
¦aveid
,

,
¦ave
->
¦ave_li¡’šg_pÜt
,
¡©e
,

2962 
¦ave
->
»¶_ack_off
, 
Ïg
);

2963 
¦aveid
++;

2966 
šfo
 = 
	`sdsÿrštf
(info,

2972 
£rv”
.
ma¡”_»¶_off£t
,

2973 
£rv”
.
»¶_backlog
 !ğ
NULL
,

2974 
£rv”
.
»¶_backlog_size
,

2975 
£rv”
.
»¶_backlog_off
,

2976 
£rv”
.
»¶_backlog_hi¡Ën
);

2980 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cpu")) {

2981 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2982 
šfo
 = 
	`sdsÿrštf
(info,

2988 ()
£lf_ru
.
ru_¡ime
.
tv_£c
+()£lf_ru.ru_¡ime.
tv_u£c
/1000000,

2989 ()
£lf_ru
.
ru_utime
.
tv_£c
+()£lf_ru.ru_utime.
tv_u£c
/1000000,

2990 ()
c_ru
.
ru_¡ime
.
tv_£c
+()c_ru.ru_¡ime.
tv_u£c
/1000000,

2991 ()
c_ru
.
ru_utime
.
tv_£c
+()c_ru.ru_utime.
tv_u£c
/1000000);

2995 ià(
®l£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"commandstats")) {

2996 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2997 
šfo
 = 
	`sdsÿrštf
(info, "# Commandstats\r\n");

2998 
numcommªds
 = (
»disCommªdTabË
)/(
»disCommªd
);

2999 
j
 = 0; j < 
numcommªds
; j++) {

3000 
»disCommªd
 *
c
 = 
»disCommªdTabË
+
j
;

3002 ià(!
c
->
ÿÎs
) ;

3003 
šfo
 = 
	`sdsÿrštf
(info,

3005 
c
->
Çme
, c->
ÿÎs
, c->
miüo£cÚds
,

3006 (
c
->
ÿÎs
 =ğ0è? 0 : (()c->
miüo£cÚds
/c->calls));

3011 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"cluster")) {

3012 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3013 
šfo
 = 
	`sdsÿrštf
(info,

3016 
£rv”
.
şu¡”_’abËd
);

3020 ià(
®l£ùiÚs
 || 
def£ùiÚs
 || !
	`¡rÿ£cmp
(
£ùiÚ
,"keyspace")) {

3021 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

3022 
šfo
 = 
	`sdsÿrštf
(info, "# Keyspace\r\n");

3023 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

3024 
keys
, 
vkeys
;

3026 
keys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
diù
);

3027 
vkeys
 = 
	`diùSize
(
£rv”
.
db
[
j
].
expœes
);

3028 ià(
keys
 || 
vkeys
) {

3029 
šfo
 = 
	`sdsÿrštf
(info,

3031 
j
, 
keys
, 
vkeys
, 
£rv”
.
db
[j].
avg_‰l
);

3035  
šfo
;

3036 
	}
}

3038 
	$šfoCommªd
(
»disCl›Á
 *
c
) {

3039 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

3041 ià(
c
->
¬gc
 > 2) {

3042 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

3045 
sds
 
šfo
 = 
	`g’RedisInfoSŒšg
(
£ùiÚ
);

3046 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

3047 ()
	`sd¦’
(
šfo
)));

3048 
	`addR•lySds
(
c
,
šfo
);

3049 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

3050 
	}
}

3052 
	$mÚ™ÜCommªd
(
»disCl›Á
 *
c
) {

3054 ià(
c
->
æags
 & 
REDIS_SLAVE
) ;

3056 
c
->
æags
 |ğ(
REDIS_SLAVE
|
REDIS_MONITOR
);

3057 
	`li¡AddNodeTa
(
£rv”
.
mÚ™Üs
,
c
);

3058 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

3059 
	}
}

3102 
eviùiÚPoŞEÁry
 *
	$eviùiÚPoŞAÎoc
() {

3103 
eviùiÚPoŞEÁry
 *
•
;

3104 
j
;

3106 
•
 = 
	`zm®loc
((*•)*
REDIS_EVICTION_POOL_SIZE
);

3107 
j
 = 0; j < 
REDIS_EVICTION_POOL_SIZE
; j++) {

3108 
•
[
j
].
idË
 = 0;

3109 
•
[
j
].
key
 = 
NULL
;

3111  
•
;

3112 
	}
}

3123 
	#EVICTION_SAMPLES_ARRAY_SIZE
 16

	)

3124 
	$eviùiÚPoŞPİuÏ‹
(
diù
 *
§m¶ediù
, diù *
keydiù
, 
eviùiÚPoŞEÁry
 *
poŞ
) {

3125 
j
, 
k
, 
couÁ
;

3126 
diùEÁry
 *
_§m¶es
[
EVICTION_SAMPLES_ARRAY_SIZE
];

3127 
diùEÁry
 **
§m¶es
;

3131 ià(
£rv”
.
maxmemÜy_§m¶es
 <ğ
EVICTION_SAMPLES_ARRAY_SIZE
) {

3132 
§m¶es
 = 
_§m¶es
;

3134 
§m¶es
 = 
	`zm®loc
((§m¶es[0])*
£rv”
.
maxmemÜy_§m¶es
);

3137 
couÁ
 = 
	`diùG‘SomeKeys
(
§m¶ediù
,
§m¶es
,
£rv”
.
maxmemÜy_§m¶es
);

3138 
j
 = 0; j < 
couÁ
; j++) {

3139 
idË
;

3140 
sds
 
key
;

3141 
robj
 *
o
;

3142 
diùEÁry
 *
de
;

3144 
de
 = 
§m¶es
[
j
];

3145 
key
 = 
	`diùG‘Key
(
de
);

3149 ià(
§m¶ediù
 !ğ
keydiù
è
de
 = 
	`diùFšd
(keydiù, 
key
);

3150 
o
 = 
	`diùG‘V®
(
de
);

3151 
idË
 = 
	`e¡im©eObjeùIdËTime
(
o
);

3156 
k
 = 0;

3157 
k
 < 
REDIS_EVICTION_POOL_SIZE
 &&

3158 
poŞ
[
k
].
key
 &&

3159 
poŞ
[
k
].
idË
 < idle) k++;

3160 ià(
k
 =ğ0 && 
poŞ
[
REDIS_EVICTION_POOL_SIZE
-1].
key
 !ğ
NULL
) {

3164 } ià(
k
 < 
REDIS_EVICTION_POOL_SIZE
 && 
poŞ
[k].
key
 =ğ
NULL
) {

3169 ià(
poŞ
[
REDIS_EVICTION_POOL_SIZE
-1].
key
 =ğ
NULL
) {

3172 
	`memmove
(
poŞ
+
k
+1,pool+k,

3173 (
poŞ
[0])*(
REDIS_EVICTION_POOL_SIZE
-
k
-1));

3176 
k
--;

3179 
	`sdsä“
(
poŞ
[0].
key
);

3180 
	`memmove
(
poŞ
,poŞ+1,ÕoŞ[0])*
k
);

3183 
poŞ
[
k
].
key
 = 
	`sdsdup
(key);

3184 
poŞ
[
k
].
idË
 = idle;

3186 ià(
§m¶es
 !ğ
_§m¶es
è
	`zä“
(samples);

3187 
	}
}

3189 
	$ä“MemÜyIfN“ded
() {

3190 
size_t
 
mem_u£d
, 
mem_toä“
, 
mem_ä“d
;

3191 
¦aves
 = 
	`li¡L’gth
(
£rv”
.slaves);

3192 
m¡ime_t
 
Ï‹ncy
, 
eviùiÚ_Ï‹ncy
;

3196 
mem_u£d
 = 
	`zm®loc_u£d_memÜy
();

3197 ià(
¦aves
) {

3198 
li¡I‹r
 
li
;

3199 
li¡Node
 *
Ê
;

3201 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

3202 (
Ê
 = 
	`li¡Next
(&
li
))) {

3203 
»disCl›Á
 *
¦ave
 = 
	`li¡NodeV®ue
(
Ê
);

3204 
obuf_by‹s
 = 
	`g‘Cl›ÁOuutBufãrMemÜyU§ge
(
¦ave
);

3205 ià(
obuf_by‹s
 > 
mem_u£d
)

3206 
mem_u£d
 = 0;

3208 
mem_u£d
 -ğ
obuf_by‹s
;

3211 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
) {

3212 
mem_u£d
 -ğ
	`sd¦’
(
£rv”
.
aof_buf
);

3213 
mem_u£d
 -ğ
	`aofRewr™eBufãrSize
();

3217 ià(
mem_u£d
 <ğ
£rv”
.
maxmemÜy
è 
REDIS_OK
;

3219 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_NO_EVICTION
)

3220  
REDIS_ERR
;

3223 
mem_toä“
 = 
mem_u£d
 - 
£rv”
.
maxmemÜy
;

3224 
mem_ä“d
 = 0;

3225 
	`Ï‹ncyS¹MÚ™Ü
(
Ï‹ncy
);

3226 
mem_ä“d
 < 
mem_toä“
) {

3227 
j
, 
k
, 
keys_ä“d
 = 0;

3229 
j
 = 0; j < 
£rv”
.
dbnum
; j++) {

3230 
be¡v®
 = 0;

3231 
sds
 
be¡key
 = 
NULL
;

3232 
diùEÁry
 *
de
;

3233 
»disDb
 *
db
 = 
£rv”
.db+
j
;

3234 
diù
 *dict;

3236 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_ALLKEYS_LRU
 ||

3237 
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_ALLKEYS_RANDOM
)

3239 
diù
 = 
£rv”
.
db
[
j
].dict;

3241 
diù
 = 
£rv”
.
db
[
j
].
expœes
;

3243 ià(
	`diùSize
(
diù
) == 0) ;

3246 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_ALLKEYS_RANDOM
 ||

3247 
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_VOLATILE_RANDOM
)

3249 
de
 = 
	`diùG‘RªdomKey
(
diù
);

3250 
be¡key
 = 
	`diùG‘Key
(
de
);

3254 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_ALLKEYS_LRU
 ||

3255 
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_VOLATILE_LRU
)

3257 
eviùiÚPoŞEÁry
 *
poŞ
 = 
db
->
eviùiÚ_poŞ
;

3259 
be¡key
 =ğ
NULL
) {

3260 
	`eviùiÚPoŞPİuÏ‹
(
diù
, 
db
->diù, db->
eviùiÚ_poŞ
);

3262 
k
 = 
REDIS_EVICTION_POOL_SIZE
-1; k >= 0; k--) {

3263 ià(
poŞ
[
k
].
key
 =ğ
NULL
) ;

3264 
de
 = 
	`diùFšd
(
diù
,
poŞ
[
k
].
key
);

3267 
	`sdsä“
(
poŞ
[
k
].
key
);

3269 
	`memmove
(
poŞ
+
k
,pool+k+1,

3270 (
poŞ
[0])*(
REDIS_EVICTION_POOL_SIZE
-
k
-1));

3273 
poŞ
[
REDIS_EVICTION_POOL_SIZE
-1].
key
 = 
NULL
;

3274 
poŞ
[
REDIS_EVICTION_POOL_SIZE
-1].
idË
 = 0;

3278 ià(
de
) {

3279 
be¡key
 = 
	`diùG‘Key
(
de
);

3290 ià(
£rv”
.
maxmemÜy_pŞicy
 =ğ
REDIS_MAXMEMORY_VOLATILE_TTL
) {

3291 
k
 = 0; k < 
£rv”
.
maxmemÜy_§m¶es
; k++) {

3292 
sds
 
thiskey
;

3293 
thisv®
;

3295 
de
 = 
	`diùG‘RªdomKey
(
diù
);

3296 
thiskey
 = 
	`diùG‘Key
(
de
);

3297 
thisv®
 = (è
	`diùG‘V®
(
de
);

3301 ià(
be¡key
 =ğ
NULL
 || 
thisv®
 < 
be¡v®
) {

3302 
be¡key
 = 
thiskey
;

3303 
be¡v®
 = 
thisv®
;

3309 ià(
be¡key
) {

3310 
d–
;

3312 
robj
 *
keyobj
 = 
	`ü—‹SŒšgObjeù
(
be¡key
,
	`sd¦’
(bestkey));

3313 
	`´İag©eExpœe
(
db
,
keyobj
);

3322 
d–
 = (è
	`zm®loc_u£d_memÜy
();

3323 
	`Ï‹ncyS¹MÚ™Ü
(
eviùiÚ_Ï‹ncy
);

3324 
	`dbD–‘e
(
db
,
keyobj
);

3325 
	`Ï‹ncyEndMÚ™Ü
(
eviùiÚ_Ï‹ncy
);

3326 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-d–",
eviùiÚ_Ï‹ncy
);

3327 
	`Ï‹ncyRemoveNe¡edEv’t
(
Ï‹ncy
,
eviùiÚ_Ï‹ncy
);

3328 
d–
 -ğ(è
	`zm®loc_u£d_memÜy
();

3329 
mem_ä“d
 +ğ
d–
;

3330 
£rv”
.
¡©_eviùedkeys
++;

3331 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_EVICTED
, "evicted",

3332 
keyobj
, 
db
->
id
);

3333 
	`deüRefCouÁ
(
keyobj
);

3334 
keys_ä“d
++;

3340 ià(
¦aves
è
	`æushSÏvesOuutBufãrs
();

3343 ià(!
keys_ä“d
) {

3344 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

3345 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

3346  
REDIS_ERR
;

3349 
	`Ï‹ncyEndMÚ™Ü
(
Ï‹ncy
);

3350 
	`Ï‹ncyAddSam¶eIfN“ded
("eviùiÚ-cyşe",
Ï‹ncy
);

3351  
REDIS_OK
;

3352 
	}
}

3356 #ifdeà
__lšux__


3357 
	$lšuxOv”comm™MemÜyV®ue
() {

3358 
FILE
 *
å
 = 
	`fİ’
("/proc/sys/vm/overcommit_memory","r");

3359 
buf
[64];

3361 ià(!
å
)  -1;

3362 ià(
	`fg‘s
(
buf
,64,
å
è=ğ
NULL
) {

3363 
	`fşo£
(
å
);

3366 
	`fşo£
(
å
);

3368  
	`©oi
(
buf
);

3369 
	}
}

3371 
	$lšuxMemÜyW¬nšgs
() {

3372 ià(
	`lšuxOv”comm™MemÜyV®ue
() == 0) {

3373 
	`»disLog
(
REDIS_WARNING
,"WARNING overcommit_memory is seto 0! Background save may fail under†ow memory condition. To fixhis issue‡dd 'vm.overcommit_memory = 1'o /etc/sysctl.conf‡ndhen„eboot or„unhe command 'sysctl vm.overcommit_memory=1' forhisoakeƒffect.");

3375 ià(
	`THPIsEÇbËd
()) {

3376 
	`»disLog
(
REDIS_WARNING
,"WARNING you have Transparent Huge Pages (THP) supportƒnabled in your kernel. This will create†atency‡nd memory usage issues with Redis. To fixhis issue„unhe command 'echo‚ever > /sys/kernel/mm/transparent_hugepage/enabled'‡s„oot,‡nd‡dd ito your /etc/rc.local in ordero„etainhe setting‡fter‡„eboot. Redis must be„estarted‡fter THP is disabled.");

3378 
	}
}

3381 
	$ü—‹PidFe
() {

3383 
FILE
 *
å
 = 
	`fİ’
(
£rv”
.
pidfe
,"w");

3384 ià(
å
) {

3385 
	`årštf
(
å
,"%d\n",()
	`g‘pid
());

3386 
	`fşo£
(
å
);

3388 
	}
}

3390 
	$d«mÚize
() {

3391 
fd
;

3393 ià(
	`fÜk
(è!ğ0è
	`ex™
(0);

3394 
	`£tsid
();

3399 ià((
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1) {

3400 
	`dup2
(
fd
, 
STDIN_FILENO
);

3401 
	`dup2
(
fd
, 
STDOUT_FILENO
);

3402 
	`dup2
(
fd
, 
STDERR_FILENO
);

3403 ià(
fd
 > 
STDERR_FILENO
è
	`şo£
(fd);

3405 
	}
}

3407 
	$v”siÚ
() {

3408 
	`´štf
("Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n",

3409 
REDIS_VERSION
,

3410 
	`»disG™SHA1
(),

3411 
	`©oi
(
	`»disG™Dœty
()) > 0,

3412 
ZMALLOC_LIB
,

3414 (è
	`»disBudId
());

3415 
	`ex™
(0);

3416 
	}
}

3418 
	$u§ge
() {

3419 
	`årštf
(
¡d”r
,"Usage: ./redis-server [/path/to/redis.conf] [options]\n");

3420 
	`årštf
(
¡d”r
," ./redis-server - (read config from stdin)\n");

3421 
	`årštf
(
¡d”r
," ./redis-server -v or --version\n");

3422 
	`årštf
(
¡d”r
," ./redis-server -h or --help\n");

3423 
	`årštf
(
¡d”r
," ./redis-server --test-memory <megabytes>\n\n");

3424 
	`årštf
(
¡d”r
,"Examples:\n");

3425 
	`årštf
(
¡d”r
," ./redis-server (runhe server with default conf)\n");

3426 
	`årštf
(
¡d”r
," ./redis-server /etc/redis/6379.conf\n");

3427 
	`årštf
(
¡d”r
," ./redis-server --port 7777\n");

3428 
	`årštf
(
¡d”r
," ./redis-server --port 7777 --slaveof 127.0.0.1 8888\n");

3429 
	`årštf
(
¡d”r
," ./redis-server /etc/myredis.conf --loglevel verbose\n\n");

3430 
	`årštf
(
¡d”r
,"Sentinel mode:\n");

3431 
	`årštf
(
¡d”r
," ./redis-server /etc/sentinel.conf --sentinel\n");

3432 
	`ex™
(1);

3433 
	}
}

3435 
	$»disAsciiA¹
() {

3436 
	~"asciogo.h
"

3437 *
buf
 = 
	`zm®loc
(1024*16);

3438 *
mode
;

3440 ià(
£rv”
.
şu¡”_’abËd
è
mode
 = "cluster";

3441 ià(
£rv”
.
£Áš–_mode
è
mode
 = "sentinel";

3442 
mode
 = "standalone";

3444 ià(
£rv”
.
sy¦og_’abËd
) {

3445 
	`»disLog
(
REDIS_NOTICE
,

3447 
REDIS_VERSION
,

3448 
	`»disG™SHA1
(),

3449 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3451 
mode
, 
£rv”
.
pÜt
,

3452 (è
	`g‘pid
()

3455 
	`¢´štf
(
buf
,1024*16,
ascii_logo
,

3456 
REDIS_VERSION
,

3457 
	`»disG™SHA1
(),

3458 
	`¡¹Ş
(
	`»disG™Dœty
(),
NULL
,10) > 0,

3460 
mode
, 
£rv”
.
pÜt
,

3461 (è
	`g‘pid
()

3463 
	`»disLogRaw
(
REDIS_NOTICE
|
REDIS_LOG_RAW
,
buf
);

3465 
	`zä“
(
buf
);

3466 
	}
}

3468 
	$sigShutdownHªdËr
(
sig
) {

3469 *
msg
;

3471 
sig
) {

3472 
SIGINT
:

3473 
msg
 = "Received SIGINT scheduling shutdown...";

3475 
SIGTERM
:

3476 
msg
 = "Received SIGTERM scheduling shutdown...";

3479 
msg
 = "Received shutdown signal, scheduling shutdown...";

3486 ià(
£rv”
.
shutdown_a§p
 && 
sig
 =ğ
SIGINT
) {

3487 
	`»disLogFromHªdËr
(
REDIS_WARNING
, "You insist...ƒxiting‚ow.");

3488 
	`rdbRemoveTempFe
(
	`g‘pid
());

3489 
	`ex™
(1);

3490 } ià(
£rv”
.
lßdšg
) {

3491 
	`ex™
(0);

3494 
	`»disLogFromHªdËr
(
REDIS_WARNING
, 
msg
);

3495 
£rv”
.
shutdown_a§p
 = 1;

3496 
	}
}

3498 
	$£tupSigÇlHªdËrs
() {

3499 
sigaùiÚ
 
aù
;

3503 
	`sigem±y£t
(&
aù
.
§_mask
);

3504 
aù
.
§_æags
 = 0;

3505 
aù
.
§_hªdËr
 = 
sigShutdownHªdËr
;

3506 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

3507 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

3509 #ifdeà
HAVE_BACKTRACE


3510 
	`sigem±y£t
(&
aù
.
§_mask
);

3511 
aù
.
§_æags
 = 
SA_NODEFER
 | 
SA_RESETHAND
 | 
SA_SIGINFO
;

3512 
aù
.
§_sigaùiÚ
 = 
sig£gvHªdËr
;

3513 
	`sigaùiÚ
(
SIGSEGV
, &
aù
, 
NULL
);

3514 
	`sigaùiÚ
(
SIGBUS
, &
aù
, 
NULL
);

3515 
	`sigaùiÚ
(
SIGFPE
, &
aù
, 
NULL
);

3516 
	`sigaùiÚ
(
SIGILL
, &
aù
, 
NULL
);

3519 
	}
}

3521 
mem‹¡
(
size_t
 
megaby‹s
, 
·s£s
);

3525 
	$checkFÜS’tš–Mode
(
¬gc
, **
¬gv
) {

3526 
j
;

3528 ià(
	`¡r¡r
(
¬gv
[0],"»dis-£Áš–"è!ğ
NULL
)  1;

3529 
j
 = 1; j < 
¬gc
; j++)

3530 ià(!
	`¡rcmp
(
¬gv
[
j
],"--sentinel"))  1;

3532 
	}
}

3535 
	$lßdD©aFromDisk
() {

3536 
¡¬t
 = 
	`u¡ime
();

3537 ià(
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_ON
) {

3538 ià(
	`lßdAµ’dOÆyFe
(
£rv”
.
aof_f’ame
è=ğ
REDIS_OK
)

3539 
	`»disLog
(
REDIS_NOTICE
,"DB†ßded from‡µ’d oÆy fe: %.3à£cÚds",()(
	`u¡ime
()-
¡¬t
)/1000000);

3541 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è=ğ
REDIS_OK
) {

3542 
	`»disLog
(
REDIS_NOTICE
,"DB†oaded from disk: %.3f seconds",

3543 ()(
	`u¡ime
()-
¡¬t
)/1000000);

3544 } ià(
”ºo
 !ğ
ENOENT
) {

3545 
	`»disLog
(
REDIS_WARNING
,"F©®ƒ¼Ü†ßdšghDB: %s. Ex™šg.",
	`¡»¼Ü
(
”ºo
));

3546 
	`ex™
(1);

3549 
	}
}

3551 
	$»disOutOfMemÜyHªdËr
(
size_t
 
®loÿtiÚ_size
) {

3552 
	`»disLog
(
REDIS_WARNING
,"Out Of Memory‡llocating %zu bytes!",

3553 
®loÿtiÚ_size
);

3554 
	`»disPªic
("Redis‡borting for OUT OF MEMORY");

3555 
	}
}

3557 
	$»disS‘ProcT™Ë
(*
t™Ë
) {

3558 #ifdeà
USE_SETPROCTITLE


3559 *
£rv”_mode
 = "";

3560 ià(
£rv”
.
şu¡”_’abËd
è
£rv”_mode
 = " [cluster]";

3561 ià(
£rv”
.
£Áš–_mode
è
£rv”_mode
 = " [sentinel]";

3563 
	`£roù™Ë
("%s %s:%d%s",

3564 
t™Ë
,

3565 
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : "*",

3566 
£rv”
.
pÜt
,

3567 
£rv”_mode
);

3569 
	`REDIS_NOTUSED
(
t™Ë
);

3571 
	}
}

3573 
	$maš
(
¬gc
, **
¬gv
) {

3574 
timev®
 
tv
;

3576 #ifdeà
HETEROMEM


3577 
	`š™_®locs
();

3581 #ifdeà
INIT_SETPROCTITLE_REPLACEMENT


3582 
	`¥t_š™
(
¬gc
, 
¬gv
);

3584 
	`£oÿË
(
LC_COLLATE
,"");

3585 
	`zm®loc_’abË_th»ad_§ãÃss
();

3586 
	`zm®loc_£t_oom_hªdËr
(
»disOutOfMemÜyHªdËr
);

3587 
	`¤ªd
(
	`time
(
NULL
)^
	`g‘pid
());

3588 
	`g‘timeofday
(&
tv
,
NULL
);

3589 
	`diùS‘HashFunùiÚS“d
(
tv
.
tv_£c
^tv.
tv_u£c
^
	`g‘pid
());

3590 
£rv”
.
£Áš–_mode
 = 
	`checkFÜS’tš–Mode
(
¬gc
,
¬gv
);

3591 
	`š™S”v”CÚfig
();

3596 ià(
£rv”
.
£Áš–_mode
) {

3597 
	`š™S’tš–CÚfig
();

3598 
	`š™S’tš–
();

3601 ià(
¬gc
 >= 2) {

3602 
j
 = 1;

3603 
sds
 
İtiÚs
 = 
	`sd£m±y
();

3604 *
cÚfigfe
 = 
NULL
;

3607 ià(
	`¡rcmp
(
¬gv
[1], "-v") == 0 ||

3608 
	`¡rcmp
(
¬gv
[1], "--v”siÚ"è=ğ0è
	`v”siÚ
();

3609 ià(
	`¡rcmp
(
¬gv
[1], "--help") == 0 ||

3610 
	`¡rcmp
(
¬gv
[1], "-h"è=ğ0è
	`u§ge
();

3611 ià(
	`¡rcmp
(
¬gv
[1], "--test-memory") == 0) {

3612 ià(
¬gc
 == 3) {

3613 
	`mem‹¡
(
	`©oi
(
¬gv
[2]),50);

3614 
	`ex™
(0);

3616 
	`årštf
(
¡d”r
,"Please specifyhe‡mount of memoryoest in megabytes.\n");

3617 
	`årštf
(
¡d”r
,"Example: ./redis-server --test-memory 4096\n\n");

3618 
	`ex™
(1);

3623 ià(
¬gv
[
j
][0] != '-' ||‡rgv[j][1] != '-')

3624 
cÚfigfe
 = 
¬gv
[
j
++];

3629 
j
 !ğ
¬gc
) {

3630 ià(
¬gv
[
j
][0] == '-' &&‡rgv[j][1] == '-') {

3632 ià(
	`sd¦’
(
İtiÚs
)èİtiÚ ğ
	`sdsÿt
(options,"\n");

3633 
İtiÚs
 = 
	`sdsÿt
(İtiÚs,
¬gv
[
j
]+2);

3634 
İtiÚs
 = 
	`sdsÿt
(options," ");

3637 
İtiÚs
 = 
	`sdsÿŒ•r
(İtiÚs,
¬gv
[
j
],
	`¡¾’
(argv[j]));

3638 
İtiÚs
 = 
	`sdsÿt
(options," ");

3640 
j
++;

3642 ià(
£rv”
.
£Áš–_mode
 && 
cÚfigfe
 && *configfile == '-') {

3643 
	`»disLog
(
REDIS_WARNING
,

3645 
	`»disLog
(
REDIS_WARNING
,

3647 
	`ex™
(1);

3649 ià(
cÚfigfe
è
£rv”
.cÚfigfğ
	`g‘AbsŞu‹P©h
(configfile);

3650 
	`»£tS”v”SaveP¬ams
();

3651 
	`lßdS”v”CÚfig
(
cÚfigfe
,
İtiÚs
);

3652 
	`sdsä“
(
İtiÚs
);

3654 
	`»disLog
(
REDIS_WARNING
, "W¬nšg:‚ØcÚfig f¥ecif›d, usšghdeçuÉ cÚfig. IÀÜd”Ø¥ecify‡ cÚfig fu£ % /·th/to/%s.cÚf", 
¬gv
[0], 
£rv”
.
£Áš–_mode
 ? "sentinel" : "redis");

3656 ià(
£rv”
.
d«mÚize
è
	`d«mÚize
();

3657 
	`š™S”v”
();

3658 ià(
£rv”
.
d«mÚize
è
	`ü—‹PidFe
();

3659 
	`»disS‘ProcT™Ë
(
¬gv
[0]);

3660 
	`»disAsciiA¹
();

3662 ià(!
£rv”
.
£Áš–_mode
) {

3664 
	`»disLog
(
REDIS_WARNING
,"S”v” s¹ed, Redi v”siÚ " 
REDIS_VERSION
);

3665 #ifdeà
__lšux__


3666 
	`lšuxMemÜyW¬nšgs
();

3668 
	`checkTıBacklogS‘tšgs
();

3669 
	`lßdD©aFromDisk
();

3670 ià(
£rv”
.
şu¡”_’abËd
) {

3671 ià(
	`v”ifyClu¡”CÚfigW™hD©a
(è=ğ
REDIS_ERR
) {

3672 
	`»disLog
(
REDIS_WARNING
,

3675 
	`ex™
(1);

3678 ià(
£rv”
.
fd_couÁ
 > 0)

3679 
	`»disLog
(
REDIS_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ Ú…Üˆ%d", 
£rv”
.
pÜt
);

3680 ià(
£rv”
.
sofd
 > 0)

3681 
	`»disLog
(
REDIS_NOTICE
,"Th£rv” i now„—dyØacû± cÚÃùiÚ © %s", 
£rv”
.
unixsock‘
);

3683 
	`£Áš–IsRuÂšg
();

3687 ià(
£rv”
.
maxmemÜy
 > 0 && server.maxmemory < 1024*1024) {

3688 
	`»disLog
(
REDIS_WARNING
,"WARNING: You s³cif›d‡ maxmemÜy v®uth© i Ës thª 1MB (cu¼’ˆv®ui %Îu by‹s). A» you su»hi i wh© you„—Îy wªt?", 
£rv”
.
maxmemÜy
);

3691 
	`«S‘BefÜeSË•Proc
(
£rv”
.
–
,
befÜeSË•
);

3692 
	`«Maš
(
£rv”
.
–
);

3693 
	`«D–‘eEv’tLoİ
(
£rv”
.
–
);

3695 
	}
}

	@redis.h

30 #iâdeà
__REDIS_H


31 
	#__REDIS_H


	)

33 
	~"fmaüos.h
"

34 
	~"cÚfig.h
"

35 
	~"sŞ¬isfixes.h
"

37 
	~<¡dio.h
>

38 
	~<¡dlib.h
>

39 
	~<¡ršg.h
>

40 
	~<time.h
>

41 
	~<lim™s.h
>

42 
	~<uni¡d.h
>

43 
	~<”ºo.h
>

44 
	~<š‰y³s.h
>

45 
	~<±h»ad.h
>

46 
	~<sy¦og.h
>

47 
	~<Ãtš‘/š.h
>

48 
	~<lua.h
>

49 
	~<sigÇl.h
>

51 
	tm¡ime_t
;

53 
	~"«.h
"

54 
	~"sds.h
"

55 
	~"diù.h
"

56 
	~"adli¡.h
"

57 
	~"zm®loc.h
"

58 
	~"ª‘.h
"

59 
	~"zli¡.h
"

60 
	~"št£t.h
"

61 
	~"v”siÚ.h
"

62 
	~"ut.h
"

63 
	~"Ï‹ncy.h
"

64 
	~"¥¬klše.h
"

67 
	#REDIS_OK
 0

	)

68 
	#REDIS_ERR
 -1

	)

71 
	#REDIS_DEFAULT_HZ
 10

	)

72 
	#REDIS_MIN_HZ
 1

	)

73 
	#REDIS_MAX_HZ
 500

	)

74 
	#REDIS_SERVERPORT
 6379

	)

75 
	#REDIS_TCP_BACKLOG
 511

	)

76 
	#REDIS_MAXIDLETIME
 0

	)

77 
	#REDIS_DEFAULT_DBNUM
 16

	)

78 
	#REDIS_CONFIGLINE_MAX
 1024

	)

79 
	#REDIS_DBCRON_DBS_PER_CALL
 16

	)

80 
	#REDIS_MAX_WRITE_PER_EVENT
 (1024*64)

	)

81 
	#REDIS_SHARED_SELECT_CMDS
 10

	)

82 
	#REDIS_SHARED_INTEGERS
 10000

	)

83 
	#REDIS_SHARED_BULKHDR_LEN
 32

	)

84 
	#REDIS_MAX_LOGMSG_LEN
 1024

	)

85 
	#REDIS_AOF_REWRITE_PERC
 100

	)

86 
	#REDIS_AOF_REWRITE_MIN_SIZE
 (64*1024*1024)

	)

87 
	#REDIS_AOF_REWRITE_ITEMS_PER_CMD
 64

	)

88 
	#REDIS_SLOWLOG_LOG_SLOWER_THAN
 10000

	)

89 
	#REDIS_SLOWLOG_MAX_LEN
 128

	)

90 
	#REDIS_MAX_CLIENTS
 10000

	)

91 
	#REDIS_AUTHPASS_MAX_LEN
 512

	)

92 
	#REDIS_DEFAULT_SLAVE_PRIORITY
 100

	)

93 
	#REDIS_REPL_TIMEOUT
 60

	)

94 
	#REDIS_REPL_PING_SLAVE_PERIOD
 10

	)

95 
	#REDIS_RUN_ID_SIZE
 40

	)

96 
	#REDIS_EOF_MARK_SIZE
 40

	)

97 
	#REDIS_DEFAULT_REPL_BACKLOG_SIZE
 (1024*1024è

	)

98 
	#REDIS_DEFAULT_REPL_BACKLOG_TIME_LIMIT
 (60*60è

	)

99 
	#REDIS_REPL_BACKLOG_MIN_SIZE
 (1024*16è

	)

100 
	#REDIS_BGSAVE_RETRY_DELAY
 5

	)

101 
	#REDIS_DEFAULT_PID_FILE
 "/v¬/run/»dis.pid"

	)

102 
	#REDIS_DEFAULT_SYSLOG_IDENT
 "»dis"

	)

103 
	#REDIS_DEFAULT_CLUSTER_CONFIG_FILE
 "nodes.cÚf"

	)

104 
	#REDIS_DEFAULT_DAEMONIZE
 0

	)

105 
	#REDIS_DEFAULT_UNIX_SOCKET_PERM
 0

	)

106 
	#REDIS_DEFAULT_TCP_KEEPALIVE
 0

	)

107 
	#REDIS_DEFAULT_LOGFILE
 ""

	)

108 
	#REDIS_DEFAULT_SYSLOG_ENABLED
 0

	)

109 
	#REDIS_DEFAULT_STOP_WRITES_ON_BGSAVE_ERROR
 1

	)

110 
	#REDIS_DEFAULT_RDB_COMPRESSION
 1

	)

111 
	#REDIS_DEFAULT_RDB_CHECKSUM
 1

	)

112 
	#REDIS_DEFAULT_RDB_FILENAME
 "dump.rdb"

	)

113 
	#REDIS_DEFAULT_REPL_DISKLESS_SYNC
 0

	)

114 
	#REDIS_DEFAULT_REPL_DISKLESS_SYNC_DELAY
 5

	)

115 
	#REDIS_DEFAULT_SLAVE_SERVE_STALE_DATA
 1

	)

116 
	#REDIS_DEFAULT_SLAVE_READ_ONLY
 1

	)

117 
	#REDIS_DEFAULT_REPL_DISABLE_TCP_NODELAY
 0

	)

118 
	#REDIS_DEFAULT_MAXMEMORY
 0

	)

119 
	#REDIS_DEFAULT_MAXMEMORY_SAMPLES
 5

	)

120 
	#REDIS_DEFAULT_AOF_FILENAME
 "­³ndÚly.aof"

	)

121 
	#REDIS_DEFAULT_AOF_NO_FSYNC_ON_REWRITE
 0

	)

122 
	#REDIS_DEFAULT_AOF_LOAD_TRUNCATED
 1

	)

123 
	#REDIS_DEFAULT_ACTIVE_REHASHING
 1

	)

124 
	#REDIS_DEFAULT_AOF_REWRITE_INCREMENTAL_FSYNC
 1

	)

125 
	#REDIS_DEFAULT_MIN_SLAVES_TO_WRITE
 0

	)

126 
	#REDIS_DEFAULT_MIN_SLAVES_MAX_LAG
 10

	)

127 
	#REDIS_IP_STR_LEN
 46

	)

128 
	#REDIS_PEER_ID_LEN
 (
REDIS_IP_STR_LEN
+32è

	)

129 
	#REDIS_BINDADDR_MAX
 16

	)

130 
	#REDIS_MIN_RESERVED_FDS
 32

	)

131 
	#REDIS_DEFAULT_LATENCY_MONITOR_THRESHOLD
 0

	)

133 
	#ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP
 20

	)

134 
	#ACTIVE_EXPIRE_CYCLE_FAST_DURATION
 1000

	)

135 
	#ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC
 25

	)

136 
	#ACTIVE_EXPIRE_CYCLE_SLOW
 0

	)

137 
	#ACTIVE_EXPIRE_CYCLE_FAST
 1

	)

140 
	#REDIS_METRIC_SAMPLES
 16

	)

141 
	#REDIS_METRIC_COMMAND
 0

	)

142 
	#REDIS_METRIC_NET_INPUT
 1

	)

143 
	#REDIS_METRIC_NET_OUTPUT
 2

	)

144 
	#REDIS_METRIC_COUNT
 3

	)

147 
	#REDIS_MAX_QUERYBUF_LEN
 (1024*1024*1024è

	)

148 
	#REDIS_IOBUF_LEN
 (1024*16è

	)

149 
	#REDIS_REPLY_CHUNK_BYTES
 (16*1024è

	)

150 
	#REDIS_INLINE_MAX_SIZE
 (1024*64è

	)

151 
	#REDIS_MBULK_BIG_ARG
 (1024*32)

	)

152 
	#REDIS_LONGSTR_SIZE
 21

	)

153 
	#REDIS_AOF_AUTOSYNC_BYTES
 (1024*1024*32è

	)

157 
	#REDIS_EVENTLOOP_FDSET_INCR
 (
REDIS_MIN_RESERVED_FDS
+96)

	)

160 
	#REDIS_HT_MINFILL
 10

	)

164 
	#REDIS_CMD_WRITE
 1

	)

165 
	#REDIS_CMD_READONLY
 2

	)

166 
	#REDIS_CMD_DENYOOM
 4

	)

167 
	#REDIS_CMD_NOT_USED_1
 8

	)

168 
	#REDIS_CMD_ADMIN
 16

	)

169 
	#REDIS_CMD_PUBSUB
 32

	)

170 
	#REDIS_CMD_NOSCRIPT
 64

	)

171 
	#REDIS_CMD_RANDOM
 128

	)

172 
	#REDIS_CMD_SORT_FOR_SCRIPT
 256

	)

173 
	#REDIS_CMD_LOADING
 512

	)

174 
	#REDIS_CMD_STALE
 1024

	)

175 
	#REDIS_CMD_SKIP_MONITOR
 2048

	)

176 
	#REDIS_CMD_ASKING
 4096

	)

177 
	#REDIS_CMD_FAST
 8192

	)

180 
	#REDIS_STRING
 0

	)

181 
	#REDIS_LIST
 1

	)

182 
	#REDIS_SET
 2

	)

183 
	#REDIS_ZSET
 3

	)

184 
	#REDIS_HASH
 4

	)

189 
	#REDIS_ENCODING_RAW
 0

	)

190 
	#REDIS_ENCODING_INT
 1

	)

191 
	#REDIS_ENCODING_HT
 2

	)

192 
	#REDIS_ENCODING_ZIPMAP
 3

	)

193 
	#REDIS_ENCODING_LINKEDLIST
 4

	)

194 
	#REDIS_ENCODING_ZIPLIST
 5

	)

195 
	#REDIS_ENCODING_INTSET
 6

	)

196 
	#REDIS_ENCODING_SKIPLIST
 7

	)

197 
	#REDIS_ENCODING_EMBSTR
 8

	)

212 
	#REDIS_RDB_6BITLEN
 0

	)

213 
	#REDIS_RDB_14BITLEN
 1

	)

214 
	#REDIS_RDB_32BITLEN
 2

	)

215 
	#REDIS_RDB_ENCVAL
 3

	)

216 
	#REDIS_RDB_LENERR
 
UINT_MAX


	)

221 
	#REDIS_RDB_ENC_INT8
 0

	)

222 
	#REDIS_RDB_ENC_INT16
 1

	)

223 
	#REDIS_RDB_ENC_INT32
 2

	)

224 
	#REDIS_RDB_ENC_LZF
 3

	)

227 
	#REDIS_AOF_OFF
 0

	)

228 
	#REDIS_AOF_ON
 1

	)

229 
	#REDIS_AOF_WAIT_REWRITE
 2

	)

232 
	#REDIS_SLAVE
 (1<<0è

	)

233 
	#REDIS_MASTER
 (1<<1è

	)

234 
	#REDIS_MONITOR
 (1<<2è

	)

235 
	#REDIS_MULTI
 (1<<3è

	)

236 
	#REDIS_BLOCKED
 (1<<4è

	)

237 
	#REDIS_DIRTY_CAS
 (1<<5è

	)

238 
	#REDIS_CLOSE_AFTER_REPLY
 (1<<6è

	)

239 
	#REDIS_UNBLOCKED
 (1<<7è

	)

241 
	#REDIS_LUA_CLIENT
 (1<<8è

	)

242 
	#REDIS_ASKING
 (1<<9è

	)

243 
	#REDIS_CLOSE_ASAP
 (1<<10)

	)

244 
	#REDIS_UNIX_SOCKET
 (1<<11è

	)

245 
	#REDIS_DIRTY_EXEC
 (1<<12è

	)

246 
	#REDIS_MASTER_FORCE_REPLY
 (1<<13è

	)

247 
	#REDIS_FORCE_AOF
 (1<<14è

	)

248 
	#REDIS_FORCE_REPL
 (1<<15è

	)

249 
	#REDIS_PRE_PSYNC
 (1<<16è

	)

250 
	#REDIS_READONLY
 (1<<17è

	)

251 
	#REDIS_PUBSUB
 (1<<18è

	)

255 
	#REDIS_BLOCKED_NONE
 0

	)

256 
	#REDIS_BLOCKED_LIST
 1

	)

257 
	#REDIS_BLOCKED_WAIT
 2

	)

260 
	#REDIS_REQ_INLINE
 1

	)

261 
	#REDIS_REQ_MULTIBULK
 2

	)

265 
	#REDIS_CLIENT_TYPE_NORMAL
 0

	)

266 
	#REDIS_CLIENT_TYPE_SLAVE
 1

	)

267 
	#REDIS_CLIENT_TYPE_PUBSUB
 2

	)

268 
	#REDIS_CLIENT_TYPE_COUNT
 3

	)

271 
	#REDIS_REPL_NONE
 0

	)

272 
	#REDIS_REPL_CONNECT
 1

	)

273 
	#REDIS_REPL_CONNECTING
 2

	)

274 
	#REDIS_REPL_RECEIVE_PONG
 3

	)

275 
	#REDIS_REPL_TRANSFER
 4

	)

276 
	#REDIS_REPL_CONNECTED
 5

	)

282 
	#REDIS_REPL_WAIT_BGSAVE_START
 6

	)

283 
	#REDIS_REPL_WAIT_BGSAVE_END
 7

	)

284 
	#REDIS_REPL_SEND_BULK
 8

	)

285 
	#REDIS_REPL_ONLINE
 9

	)

288 
	#REDIS_REPL_SYNCIO_TIMEOUT
 5

	)

291 
	#REDIS_HEAD
 0

	)

292 
	#REDIS_TAIL
 1

	)

295 
	#REDIS_SORT_GET
 0

	)

296 
	#REDIS_SORT_ASC
 1

	)

297 
	#REDIS_SORT_DESC
 2

	)

298 
	#REDIS_SORTKEY_MAX
 1024

	)

301 
	#REDIS_DEBUG
 0

	)

302 
	#REDIS_VERBOSE
 1

	)

303 
	#REDIS_NOTICE
 2

	)

304 
	#REDIS_WARNING
 3

	)

305 
	#REDIS_LOG_RAW
 (1<<10è

	)

306 
	#REDIS_DEFAULT_VERBOSITY
 
REDIS_NOTICE


	)

309 
	#REDIS_NOTUSED
(
V
è((èV)

	)

311 
	#ZSKIPLIST_MAXLEVEL
 32

	)

312 
	#ZSKIPLIST_P
 0.25

	)

315 
	#AOF_FSYNC_NO
 0

	)

316 
	#AOF_FSYNC_ALWAYS
 1

	)

317 
	#AOF_FSYNC_EVERYSEC
 2

	)

318 
	#REDIS_DEFAULT_AOF_FSYNC
 
AOF_FSYNC_EVERYSEC


	)

321 
	#REDIS_HASH_MAX_ZIPLIST_ENTRIES
 512

	)

322 
	#REDIS_HASH_MAX_ZIPLIST_VALUE
 64

	)

323 
	#REDIS_LIST_MAX_ZIPLIST_ENTRIES
 512

	)

324 
	#REDIS_LIST_MAX_ZIPLIST_VALUE
 64

	)

325 
	#REDIS_SET_MAX_INTSET_ENTRIES
 512

	)

326 
	#REDIS_ZSET_MAX_ZIPLIST_ENTRIES
 128

	)

327 
	#REDIS_ZSET_MAX_ZIPLIST_VALUE
 64

	)

330 
	#REDIS_DEFAULT_HLL_SPARSE_MAX_BYTES
 3000

	)

333 
	#REDIS_OP_UNION
 0

	)

334 
	#REDIS_OP_DIFF
 1

	)

335 
	#REDIS_OP_INTER
 2

	)

338 
	#REDIS_MAXMEMORY_VOLATILE_LRU
 0

	)

339 
	#REDIS_MAXMEMORY_VOLATILE_TTL
 1

	)

340 
	#REDIS_MAXMEMORY_VOLATILE_RANDOM
 2

	)

341 
	#REDIS_MAXMEMORY_ALLKEYS_LRU
 3

	)

342 
	#REDIS_MAXMEMORY_ALLKEYS_RANDOM
 4

	)

343 
	#REDIS_MAXMEMORY_NO_EVICTION
 5

	)

344 
	#REDIS_DEFAULT_MAXMEMORY_POLICY
 
REDIS_MAXMEMORY_NO_EVICTION


	)

347 
	#REDIS_LUA_TIME_LIMIT
 5000

	)

350 
	#UNIT_SECONDS
 0

	)

351 
	#UNIT_MILLISECONDS
 1

	)

354 
	#REDIS_SHUTDOWN_SAVE
 1

	)

356 
	#REDIS_SHUTDOWN_NOSAVE
 2

	)

359 
	#REDIS_CALL_NONE
 0

	)

360 
	#REDIS_CALL_SLOWLOG
 1

	)

361 
	#REDIS_CALL_STATS
 2

	)

362 
	#REDIS_CALL_PROPAGATE
 4

	)

363 
	#REDIS_CALL_FULL
 (
REDIS_CALL_SLOWLOG
 | 
REDIS_CALL_STATS
 | 
REDIS_CALL_PROPAGATE
)

	)

366 
	#REDIS_PROPAGATE_NONE
 0

	)

367 
	#REDIS_PROPAGATE_AOF
 1

	)

368 
	#REDIS_PROPAGATE_REPL
 2

	)

371 
	#REDIS_RDB_CHILD_TYPE_NONE
 0

	)

372 
	#REDIS_RDB_CHILD_TYPE_DISK
 1

	)

373 
	#REDIS_RDB_CHILD_TYPE_SOCKET
 2

	)

377 
	#REDIS_NOTIFY_KEYSPACE
 (1<<0è

	)

378 
	#REDIS_NOTIFY_KEYEVENT
 (1<<1è

	)

379 
	#REDIS_NOTIFY_GENERIC
 (1<<2è

	)

380 
	#REDIS_NOTIFY_STRING
 (1<<3è

	)

381 
	#REDIS_NOTIFY_LIST
 (1<<4è

	)

382 
	#REDIS_NOTIFY_SET
 (1<<5è

	)

383 
	#REDIS_NOTIFY_HASH
 (1<<6è

	)

384 
	#REDIS_NOTIFY_ZSET
 (1<<7è

	)

385 
	#REDIS_NOTIFY_EXPIRED
 (1<<8è

	)

386 
	#REDIS_NOTIFY_EVICTED
 (1<<9è

	)

387 
	#REDIS_NOTIFY_ALL
 (
REDIS_NOTIFY_GENERIC
 | 
REDIS_NOTIFY_STRING
 | 
REDIS_NOTIFY_LIST
 | 
REDIS_NOTIFY_SET
 | 
REDIS_NOTIFY_HASH
 | 
REDIS_NOTIFY_ZSET
 | 
REDIS_NOTIFY_EXPIRED
 | 
REDIS_NOTIFY_EVICTED
è

	)

390 
	#REDIS_BIND_ADDR
 (
£rv”
.
bšdaddr_couÁ
 ? s”v”.
bšdaddr
[0] : 
NULL
)

	)

395 
	#run_w™h_³riod
(
_ms_
èià((_ms_ <ğ1000/
£rv”
.
hz
è|| !(£rv”.
üÚloİs
%((_ms_)/(1000/£rv”.hz))))

	)

398 
	#»disAs£¹W™hInfo
(
_c
,
_o
,
_e
è((_e)?()0 : (
	`_»disAs£¹W™hInfo
(_c,_o,#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

399 
	#»disAs£¹
(
_e
è((_e)?()0 : (
	`_»disAs£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

400 
	#»disPªic
(
_e
è
	`_»disPªic
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)

	)

409 
	#REDIS_LRU_BITS
 24

	)

410 
	#REDIS_LRU_CLOCK_MAX
 ((1<<
REDIS_LRU_BITS
)-1è

	)

411 
	#REDIS_LRU_CLOCK_RESOLUTION
 1000

	)

412 
	s»disObjeù
 {

413 
	mty³
:4;

414 
	m’codšg
:4;

415 
	mÌu
:
REDIS_LRU_BITS
;

416 
	m»fcouÁ
;

417 *
	m±r
;

418 } 
	trobj
;

424 
	#LRU_CLOCK
(è((1000/
£rv”
.
hz
 <ğ
REDIS_LRU_CLOCK_RESOLUTION
è? s”v”.
Ìuşock
 : 
	`g‘LRUClock
())

	)

430 
	#š™SticSŒšgObjeù
(
_v¬
,
_±r
) do { \

431 
_v¬
.
»fcouÁ
 = 1; \

432 
_v¬
.
ty³
 = 
REDIS_STRING
; \

433 
_v¬
.
’codšg
 = 
REDIS_ENCODING_RAW
; \

434 
_v¬
.
±r
 = 
_±r
; \

435 } 0);

	)

444 
	#REDIS_EVICTION_POOL_SIZE
 16

	)

445 
	seviùiÚPoŞEÁry
 {

446 
	midË
;

447 
sds
 
	mkey
;

453 
	s»disDb
 {

454 
diù
 *
	mdiù
;

455 
diù
 *
	mexpœes
;

456 
diù
 *
	mblockšg_keys
;

457 
diù
 *
	m»ady_keys
;

458 
diù
 *
	mw©ched_keys
;

459 
eviùiÚPoŞEÁry
 *
	meviùiÚ_poŞ
;

460 
	mid
;

461 
	mavg_‰l
;

462 } 
	t»disDb
;

465 
	smuÉiCmd
 {

466 
robj
 **
	m¬gv
;

467 
	m¬gc
;

468 
»disCommªd
 *
	mcmd
;

469 } 
	tmuÉiCmd
;

471 
	smuÉiS‹
 {

472 
muÉiCmd
 *
	mcommªds
;

473 
	mcouÁ
;

474 
	mmš»¶iÿs
;

475 
time_t
 
	mmš»¶iÿs_timeout
;

476 } 
	tmuÉiS‹
;

480 
	sblockšgS‹
 {

482 
m¡ime_t
 
	mtimeout
;

486 
diù
 *
	mkeys
;

488 
robj
 *
	mrg‘
;

492 
	mnum»¶iÿs
;

493 
	m»¶off£t
;

494 } 
	tblockšgS‹
;

507 
	s»adyLi¡
 {

508 
»disDb
 *
	mdb
;

509 
robj
 *
	mkey
;

510 } 
	t»adyLi¡
;

514 
	s»disCl›Á
 {

515 
ušt64_t
 
	mid
;

516 
	mfd
;

517 
»disDb
 *
	mdb
;

518 
	mdiùid
;

519 
robj
 *
	mÇme
;

520 
sds
 
	mqu”ybuf
;

521 
size_t
 
	mqu”ybuf_³ak
;

522 
	m¬gc
;

523 
robj
 **
	m¬gv
;

524 
»disCommªd
 *
	mcmd
, *
	mÏ¡cmd
;

525 
	m»qty³
;

526 
	mmuÉibulkËn
;

527 
	mbulkËn
;

528 
li¡
 *
	m»¶y
;

529 
	m»¶y_by‹s
;

530 
	m£ÁËn
;

532 
time_t
 
	mùime
;

533 
time_t
 
	mÏ¡š‹¿ùiÚ
;

534 
time_t
 
	mobuf_soá_lim™_»ached_time
;

535 
	mæags
;

536 
	mauth’tiÿ‹d
;

537 
	m»¶¡©e
;

538 
	m»¶_put_Úlše_Ú_ack
;

539 
	m»¶dbfd
;

540 
off_t
 
	m»¶dboff
;

541 
off_t
 
	m»¶dbsize
;

542 
sds
 
	m»¶´—mbË
;

543 
	m»¶off
;

544 
	m»¶_ack_off
;

545 
	m»¶_ack_time
;

546 
	m»¶runid
[
REDIS_RUN_ID_SIZE
+1];

547 
	m¦ave_li¡’šg_pÜt
;

548 
muÉiS‹
 
	mm¡©e
;

549 
	mbty³
;

550 
blockšgS‹
 
	mbpİ
;

551 
	mwoff
;

552 
li¡
 *
	mw©ched_keys
;

553 
diù
 *
	mpubsub_chªÃls
;

554 
li¡
 *
	mpubsub_·‰”ns
;

555 
sds
 
	m³”id
;

558 
	mbuåos
;

559 
	mbuf
[
REDIS_REPLY_CHUNK_BYTES
];

560 } 
	t»disCl›Á
;

562 
	s§v•¬am
 {

563 
time_t
 
	m£cÚds
;

564 
	mchªges
;

567 
	ssh¬edObjeùsSŒuù
 {

568 
robj
 *
	mülf
, *
	mok
, *
	m”r
, *
	mem±ybulk
, *
	mcz”o
, *
	mcÚe
, *
	múegÚe
, *
	mpÚg
, *
	m¥aû
,

569 *
	mcŞÚ
, *
	mnuÎbulk
, *
	mnuÎmuÉibulk
, *
	mqueued
,

570 *
	mem±ymuÉibulk
, *
	mwrÚgty³”r
, *
	mnokey”r
, *
	msyÁax”r
, *
	m§meobjeù”r
,

571 *
	moutoäªg“¼
, *
	mnosü‹¼
, *
	mlßdšg”r
, *
	m¦owsü‹¼
, *
	mbg§v“¼
,

572 *
	mma¡”dowÃ¼
, *
	mro¦av“¼
, *
	mexeÿbÜ‹¼
, *
	mnßuth”r
, *
	mnÜ•liÿ£¼
,

573 *
	mbusykey”r
, *
	moom”r
, *
	m¶us
, *
	mmes§gebulk
, *
	mpmes§gebulk
, *
	msubsüibebulk
,

574 *
	munsubsüibebulk
, *
	mpsubsüibebulk
, *
	mpunsubsüibebulk
, *
	md–
, *
	m½İ
, *
	mÍİ
,

575 *
	mÍush
, *
	mem±ysÿn
, *
	mmš¡ršg
, *
	mmax¡ršg
,

576 *
	m£Ëù
[
REDIS_SHARED_SELECT_CMDS
],

577 *
	mš‹g”s
[
REDIS_SHARED_INTEGERS
],

578 *
	mmbulkhdr
[
REDIS_SHARED_BULKHDR_LEN
],

579 *
	mbulkhdr
[
REDIS_SHARED_BULKHDR_LEN
];

583 
	szskli¡Node
 {

584 
robj
 *
	mobj
;

585 
	mscÜe
;

586 
zskli¡Node
 *
	mbackw¬d
;

587 
	szskli¡Lev–
 {

588 
zskli¡Node
 *
	mfÜw¬d
;

589 
	m¥ª
;

590 } 
	mËv–
[];

591 } 
	tzskli¡Node
;

593 
	szskli¡
 {

594 
zskli¡Node
 *
	mh—d”
, *
	m
;

595 
	mËngth
;

596 
	mËv–
;

597 } 
	tzskli¡
;

599 
	sz£t
 {

600 
diù
 *
	mdiù
;

601 
zskli¡
 *
	mz¦
;

602 } 
	tz£t
;

604 
	sş›ÁBufãrLim™sCÚfig
 {

605 
	mh¬d_lim™_by‹s
;

606 
	msoá_lim™_by‹s
;

607 
time_t
 
	msoá_lim™_£cÚds
;

608 } 
	tş›ÁBufãrLim™sCÚfig
;

610 
ş›ÁBufãrLim™sCÚfig
 
ş›ÁBufãrLim™sDeçuÉs
[
REDIS_CLIENT_TYPE_COUNT
];

618 
	s»disOp
 {

619 
robj
 **
	m¬gv
;

620 
	m¬gc
, 
	mdbid
, 
	mrg‘
;

621 
»disCommªd
 *
	mcmd
;

622 } 
	t»disOp
;

631 
	s»disOpA¼ay
 {

632 
»disOp
 *
	mİs
;

633 
	mnumİs
;

634 } 
	t»disOpA¼ay
;

640 
	gşu¡”S‹
;

644 #ifdeà
_AIX


645 #undeà
hz


648 
	s»disS”v”
 {

650 
pid_t
 
	mpid
;

651 *
	mcÚfigfe
;

652 
	mhz
;

653 
»disDb
 *
	mdb
;

654 
diù
 *
	mcommªds
;

655 
diù
 *
	mÜig_commªds
;

656 
«Ev’tLoİ
 *
	m–
;

657 
	mÌuşock
:
REDIS_LRU_BITS
;

658 
	mshutdown_a§p
;

659 
	maùiv”ehashšg
;

660 *
	m»quœ•ass
;

661 *
	mpidfe
;

662 
	m¬ch_b™s
;

663 
	müÚloİs
;

664 
	mrunid
[
REDIS_RUN_ID_SIZE
+1];

665 
	m£Áš–_mode
;

667 
	mpÜt
;

668 
	mtı_backlog
;

669 *
	mbšdaddr
[
REDIS_BINDADDR_MAX
];

670 
	mbšdaddr_couÁ
;

671 *
	munixsock‘
;

672 
mode_t
 
	munixsock‘³rm
;

673 
	mfd
[
REDIS_BINDADDR_MAX
];

674 
	mfd_couÁ
;

675 
	msofd
;

676 
	mcfd
[
REDIS_BINDADDR_MAX
];

677 
	mcfd_couÁ
;

678 
li¡
 *
	mş›Ás
;

679 
li¡
 *
	mş›Ás_to_şo£
;

680 
li¡
 *
	m¦aves
, *
	mmÚ™Üs
;

681 
»disCl›Á
 *
	mcu¼’t_ş›Á
;

682 
	mş›Ás_·u£d
;

683 
m¡ime_t
 
	mş›Ás_·u£_’d_time
;

684 
	mÃ‹¼
[
ANET_ERR_LEN
];

685 
diù
 *
	mmig¿‹_ÿched_sock‘s
;

686 
ušt64_t
 
	mÃxt_ş›Á_id
;

688 
	mlßdšg
;

689 
off_t
 
	mlßdšg_tÙ®_by‹s
;

690 
off_t
 
	mlßdšg_lßded_by‹s
;

691 
time_t
 
	mlßdšg_¡¬t_time
;

692 
off_t
 
	mlßdšg_´oûss_ev’ts_š‹rv®_by‹s
;

694 
»disCommªd
 *
	md–Commªd
, *
	mmuÉiCommªd
, *
	mÍushCommªd
, *
	mÍİCommªd
,

695 *
	m½İCommªd
;

697 
time_t
 
	m¡©_¡¬‰ime
;

698 
	m¡©_numcommªds
;

699 
	m¡©_numcÚÃùiÚs
;

700 
	m¡©_expœedkeys
;

701 
	m¡©_eviùedkeys
;

702 
	m¡©_key¥aû_h™s
;

703 
	m¡©_key¥aû_mis£s
;

704 
size_t
 
	m¡©_³ak_memÜy
;

705 
	m¡©_fÜk_time
;

706 
	m¡©_fÜk_¿‹
;

707 
	m¡©_»jeùed_cÚn
;

708 
	m¡©_sync_fuÎ
;

709 
	m¡©_sync_·¹Ÿl_ok
;

710 
	m¡©_sync_·¹Ÿl_”r
;

711 
li¡
 *
	m¦owlog
;

712 
	m¦owlog_’Œy_id
;

713 
	m¦owlog_log_¦ow”_thª
;

714 
	m¦owlog_max_Ën
;

715 
size_t
 
	m»sid’t_£t_size
;

716 
	m¡©_Ãt_šput_by‹s
;

717 
	m¡©_Ãt_ouut_by‹s
;

721 
	mÏ¡_§m¶e_time
;

722 
	mÏ¡_§m¶e_couÁ
;

723 
	m§m¶es
[
REDIS_METRIC_SAMPLES
];

724 
	midx
;

725 } 
	mš¡_m‘ric
[
REDIS_METRIC_COUNT
];

727 
	mv”bos™y
;

728 
	mmaxidËtime
;

729 
	mtık“·live
;

730 
	maùive_expœe_’abËd
;

731 
size_t
 
	mş›Á_max_qu”ybuf_Ën
;

732 
	mdbnum
;

733 
	md«mÚize
;

734 
ş›ÁBufãrLim™sCÚfig
 
	mş›Á_obuf_lim™s
[
REDIS_CLIENT_TYPE_COUNT
];

736 
	maof_¡©e
;

737 
	maof_fsync
;

738 *
	maof_f’ame
;

739 
	maof_no_fsync_Ú_»wr™e
;

740 
	maof_»wr™e_³rc
;

741 
off_t
 
	maof_»wr™e_mš_size
;

742 
off_t
 
	maof_»wr™e_ba£_size
;

743 
off_t
 
	maof_cu¼’t_size
;

744 
	maof_»wr™e_scheduËd
;

745 
pid_t
 
	maof_chd_pid
;

746 
li¡
 *
	maof_»wr™e_buf_blocks
;

747 
sds
 
	maof_buf
;

748 
	maof_fd
;

749 
	maof_£Ëùed_db
;

750 
time_t
 
	maof_æush_po¡pÚed_¡¬t
;

751 
time_t
 
	maof_Ï¡_fsync
;

752 
time_t
 
	maof_»wr™e_time_Ï¡
;

753 
time_t
 
	maof_»wr™e_time_¡¬t
;

754 
	maof_Ï¡bg»wr™e_¡©us
;

755 
	maof_d–ayed_fsync
;

756 
	maof_»wr™e_šüem’l_fsync
;

757 
	maof_Ï¡_wr™e_¡©us
;

758 
	maof_Ï¡_wr™e_”ºo
;

759 
	maof_lßd_Œunÿ‹d
;

761 
	maof_pe_wr™e_d©a_to_chd
;

762 
	maof_pe_»ad_d©a_äom_·»Á
;

763 
	maof_pe_wr™e_ack_to_·»Á
;

764 
	maof_pe_»ad_ack_äom_chd
;

765 
	maof_pe_wr™e_ack_to_chd
;

766 
	maof_pe_»ad_ack_äom_·»Á
;

767 
	maof_¡İ_£ndšg_diff
;

769 
sds
 
	maof_chd_diff
;

771 
	mdœty
;

772 
	mdœty_befÜe_bg§ve
;

773 
pid_t
 
	mrdb_chd_pid
;

774 
§v•¬am
 *
	m§v•¬ams
;

775 
	m§v•¬am¦’
;

776 *
	mrdb_f’ame
;

777 
	mrdb_com´essiÚ
;

778 
	mrdb_checksum
;

779 
time_t
 
	mÏ¡§ve
;

780 
time_t
 
	mÏ¡bg§ve_Œy
;

781 
time_t
 
	mrdb_§ve_time_Ï¡
;

782 
time_t
 
	mrdb_§ve_time_¡¬t
;

783 
	mrdb_chd_ty³
;

784 
	mÏ¡bg§ve_¡©us
;

785 
	m¡İ_wr™es_Ú_bg§ve_”r
;

786 
	mrdb_pe_wr™e_»suÉ_to_·»Á
;

787 
	mrdb_pe_»ad_»suÉ_äom_chd
;

789 
»disOpA¼ay
 
	m®so_´İag©e
;

791 *
	mlogfe
;

792 
	msy¦og_’abËd
;

793 *
	msy¦og_id’t
;

794 
	msy¦og_çc™y
;

796 
	m¦ave£ldb
;

797 
	mma¡”_»¶_off£t
;

798 
	m»¶_pšg_¦ave_³riod
;

799 *
	m»¶_backlog
;

800 
	m»¶_backlog_size
;

801 
	m»¶_backlog_hi¡Ën
;

802 
	m»¶_backlog_idx
;

803 
	m»¶_backlog_off
;

805 
time_t
 
	m»¶_backlog_time_lim™
;

807 
time_t
 
	m»¶_no_¦aves_sšû
;

809 
	m»¶_mš_¦aves_to_wr™e
;

810 
	m»¶_mš_¦aves_max_Ïg
;

811 
	m»¶_good_¦aves_couÁ
;

812 
	m»¶_diskËss_sync
;

813 
	m»¶_diskËss_sync_d–ay
;

815 *
	mma¡”auth
;

816 *
	mma¡”ho¡
;

817 
	mma¡”pÜt
;

818 
	m»¶_timeout
;

819 
»disCl›Á
 *
	mma¡”
;

820 
»disCl›Á
 *
	mÿched_ma¡”
;

821 
	m»¶_syncio_timeout
;

822 
	m»¶_¡©e
;

823 
off_t
 
	m»¶_Œªsãr_size
;

824 
off_t
 
	m»¶_Œªsãr_»ad
;

825 
off_t
 
	m»¶_Œªsãr_Ï¡_fsync_off
;

826 
	m»¶_Œªsãr_s
;

827 
	m»¶_Œªsãr_fd
;

828 *
	m»¶_Œªsãr_tmpfe
;

829 
time_t
 
	m»¶_Œªsãr_Ï¡io
;

830 
	m»¶_£rve_¡®e_d©a
;

831 
	m»¶_¦ave_ro
;

832 
time_t
 
	m»¶_down_sšû
;

833 
	m»¶_di§bË_tı_nod–ay
;

834 
	m¦ave_´iÜ™y
;

835 
	m»¶_ma¡”_runid
[
REDIS_RUN_ID_SIZE
+1];

836 
	m»¶_ma¡”_š™Ÿl_off£t
;

838 
diù
 *
	m»¶_sütÿche_diù
;

839 
li¡
 *
	m»¶_sütÿche_fifo
;

840 
	m»¶_sütÿche_size
;

842 
li¡
 *
	mş›Ás_wa™šg_acks
;

843 
	mg‘_ack_äom_¦aves
;

845 
	mmaxş›Ás
;

846 
	mmaxmemÜy
;

847 
	mmaxmemÜy_pŞicy
;

848 
	mmaxmemÜy_§m¶es
;

850 
	mbpİ_blocked_ş›Ás
;

851 
li¡
 *
	munblocked_ş›Ás
;

852 
li¡
 *
	m»ady_keys
;

855 
	msÜt_desc
;

856 
	msÜt_®pha
;

857 
	msÜt_by·‰”n
;

858 
	msÜt_¡Üe
;

860 
size_t
 
	mhash_max_zli¡_’Œ›s
;

861 
size_t
 
	mhash_max_zli¡_v®ue
;

862 
size_t
 
	mli¡_max_zli¡_’Œ›s
;

863 
size_t
 
	mli¡_max_zli¡_v®ue
;

864 
size_t
 
	m£t_max_št£t_’Œ›s
;

865 
size_t
 
	mz£t_max_zli¡_’Œ›s
;

866 
size_t
 
	mz£t_max_zli¡_v®ue
;

867 
size_t
 
	mhÎ_¥¬£_max_by‹s
;

868 
time_t
 
	munixtime
;

869 
	mm¡ime
;

871 
diù
 *
	mpubsub_chªÃls
;

872 
li¡
 *
	mpubsub_·‰”ns
;

873 
	mnÙify_key¥aû_ev’ts
;

876 
	mşu¡”_’abËd
;

877 
m¡ime_t
 
	mşu¡”_node_timeout
;

878 *
	mşu¡”_cÚfigfe
;

879 
şu¡”S‹
 *
	mşu¡”
;

880 
	mşu¡”_mig¿tiÚ_b¬r›r
;

881 
	mşu¡”_¦ave_v®id™y_çùÜ
;

882 
	mşu¡”_»quœe_fuÎ_cov”age
;

885 
lua_S‹
 *
	mlua
;

886 
»disCl›Á
 *
	mlua_ş›Á
;

887 
»disCl›Á
 *
	mlua_ÿÎ”
;

888 
diù
 *
	mlua_süts
;

889 
m¡ime_t
 
	mlua_time_lim™
;

890 
m¡ime_t
 
	mlua_time_¡¬t
;

891 
	mlua_wr™e_dœty
;

893 
	mlua_¿ndom_dœty
;

895 
	mlua_timedout
;

897 
	mlua_kl
;

899 
	mÏ‹ncy_mÚ™Ü_th»shŞd
;

900 
diù
 *
	mÏ‹ncy_ev’ts
;

902 *
	mas£¹_çed
;

903 *
	mas£¹_fe
;

904 
	mas£¹_lše
;

905 
	mbug_»pÜt_¡¬t
;

906 
	mw©chdog_³riod
;

909 
	spubsubP©‹º
 {

910 
»disCl›Á
 *
	mş›Á
;

911 
robj
 *
	m·‰”n
;

912 } 
	tpubsubP©‹º
;

914 
	t»disCommªdProc
(
	t»disCl›Á
 *
	tc
);

915 *
	t»disG‘KeysProc
(
	t»disCommªd
 *
	tcmd
, 
	trobj
 **
	t¬gv
, 
	t¬gc
, *
	tnumkeys
);

916 
	s»disCommªd
 {

917 *
	mÇme
;

918 
»disCommªdProc
 *
	m´oc
;

919 
	m¬™y
;

920 *
	msæags
;

921 
	mæags
;

924 
»disG‘KeysProc
 *
	mg‘keys_´oc
;

926 
	mfœ¡key
;

927 
	mÏ¡key
;

928 
	mkey¡•
;

929 
	mmiüo£cÚds
, 
	mÿÎs
;

932 
	s»disFunùiÚSym
 {

933 *
	mÇme
;

934 
	mpoš‹r
;

937 
	s_»disSÜtObjeù
 {

938 
robj
 *
	mobj
;

940 
	mscÜe
;

941 
robj
 *
	mcmpobj
;

942 } 
	mu
;

943 } 
	t»disSÜtObjeù
;

945 
	s_»disSÜtO³¿tiÚ
 {

946 
	mty³
;

947 
robj
 *
	m·‰”n
;

948 } 
	t»disSÜtO³¿tiÚ
;

952 
robj
 *
	msubjeù
;

953 
	m’codšg
;

954 
	mdœeùiÚ
;

955 *
	mzi
;

956 
li¡Node
 *
	mÊ
;

957 } 
	tli¡Ty³I‹¿tÜ
;

961 
li¡Ty³I‹¿tÜ
 *
	mli
;

962 *
	mzi
;

963 
li¡Node
 *
	mÊ
;

964 } 
	tli¡Ty³EÁry
;

968 
robj
 *
	msubjeù
;

969 
	m’codšg
;

970 
	mii
;

971 
diùI‹¿tÜ
 *
	mdi
;

972 } 
	t£tTy³I‹¿tÜ
;

979 
robj
 *
	msubjeù
;

980 
	m’codšg
;

982 *
	måŒ
, *
	mv±r
;

984 
diùI‹¿tÜ
 *
	mdi
;

985 
diùEÁry
 *
	mde
;

986 } 
	thashTy³I‹¿tÜ
;

988 
	#REDIS_HASH_KEY
 1

	)

989 
	#REDIS_HASH_VALUE
 2

	)

995 
»disS”v”
 
£rv”
;

996 
sh¬edObjeùsSŒuù
 
sh¬ed
;

997 
diùTy³
 
£tDiùTy³
;

998 
diùTy³
 
z£tDiùTy³
;

999 
diùTy³
 
şu¡”NodesDiùTy³
;

1000 
diùTy³
 
şu¡”NodesBÏckLi¡DiùTy³
;

1001 
diùTy³
 
dbDiùTy³
;

1002 
diùTy³
 
shaSütObjeùDiùTy³
;

1003 
R_Z”o
, 
R_PosInf
, 
R_NegInf
, 
R_Nª
;

1004 
diùTy³
 
hashDiùTy³
;

1005 
diùTy³
 
»¶SütCacheDiùTy³
;

1012 
u¡ime
();

1013 
m¡ime
();

1014 
g‘RªdomHexCh¬s
(*
p
, 
Ën
);

1015 
ušt64_t
 
üc64
(ušt64_ˆ
üc
, cÚ¡ *
s
, ušt64_ˆ
l
);

1016 
ex™FromChd
(
»tcode
);

1017 
size_t
 
»disPİcouÁ
(*
s
, 
couÁ
);

1018 
»disS‘ProcT™Ë
(*
t™Ë
);

1021 
»disCl›Á
 *
ü—‹Cl›Á
(
fd
);

1022 
şo£TimedoutCl›Ás
();

1023 
ä“Cl›Á
(
»disCl›Á
 *
c
);

1024 
ä“Cl›ÁAsync
(
»disCl›Á
 *
c
);

1025 
»£tCl›Á
(
»disCl›Á
 *
c
);

1026 
£ndR•lyToCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1027 *
addDeã¼edMuÉiBulkL’gth
(
»disCl›Á
 *
c
);

1028 
£tDeã¼edMuÉiBulkL’gth
(
»disCl›Á
 *
c
, *
node
, 
Ëngth
);

1029 
´oûssIÅutBufãr
(
»disCl›Á
 *
c
);

1030 
acû±HªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1031 
acû±TıHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1032 
acû±UnixHªdËr
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1033 
»adQu”yFromCl›Á
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
);

1034 
addR•lyBulk
(
»disCl›Á
 *
c
, 
robj
 *
obj
);

1035 
addR•lyBulkCSŒšg
(
»disCl›Á
 *
c
, *
s
);

1036 
addR•lyBulkCBufãr
(
»disCl›Á
 *
c
, *
p
, 
size_t
 
Ën
);

1037 
addR•lyBulkLÚgLÚg
(
»disCl›Á
 *
c
, 
Î
);

1038 
addR•ly
(
»disCl›Á
 *
c
, 
robj
 *
obj
);

1039 
addR•lySds
(
»disCl›Á
 *
c
, 
sds
 
s
);

1040 
addR•lyE¼Ü
(
»disCl›Á
 *
c
, *
”r
);

1041 
addR•lyStus
(
»disCl›Á
 *
c
, *
¡©us
);

1042 
addR•lyDoubË
(
»disCl›Á
 *
c
, 
d
);

1043 
addR•lyLÚgLÚg
(
»disCl›Á
 *
c
, 
Î
);

1044 
addR•lyMuÉiBulkL’
(
»disCl›Á
 *
c
, 
Ëngth
);

1045 
cİyCl›ÁOuutBufãr
(
»disCl›Á
 *
d¡
,„edisCl›Á *
¤c
);

1046 *
dupCl›ÁR•lyV®ue
(*
o
);

1047 
g‘Cl›ÁsMaxBufãrs
(*
lÚge¡_ouut_li¡
,

1048 *
bigge¡_šput_bufãr
);

1049 
fÜm©P“rId
(*
³”id
, 
size_t
 
³”id_Ën
, *

, 
pÜt
);

1050 *
g‘Cl›ÁP“rId
(
»disCl›Á
 *
ş›Á
);

1051 
sds
 
ÿtCl›ÁInfoSŒšg
(sd 
s
, 
»disCl›Á
 *
ş›Á
);

1052 
sds
 
g‘AÎCl›ÁsInfoSŒšg
();

1053 
»wr™eCl›ÁCommªdVeùÜ
(
»disCl›Á
 *
c
, 
¬gc
, ...);

1054 
»wr™eCl›ÁCommªdArgum’t
(
»disCl›Á
 *
c
, 
i
, 
robj
 *
Ãwv®
);

1055 
g‘Cl›ÁOuutBufãrMemÜyU§ge
(
»disCl›Á
 *
c
);

1056 
ä“Cl›ÁsInAsyncF»eQueue
();

1057 
asyncClo£Cl›ÁOnOuutBufãrLim™R—ched
(
»disCl›Á
 *
c
);

1058 
g‘Cl›ÁTy³
(
»disCl›Á
 *
c
);

1059 
g‘Cl›ÁTy³ByName
(*
Çme
);

1060 *
g‘Cl›ÁTy³Name
(
şass
);

1061 
æushSÏvesOuutBufãrs
();

1062 
discÚÃùSÏves
();

1063 
li¡’ToPÜt
(
pÜt
, *
fds
, *
couÁ
);

1064 
·u£Cl›Ás
(
m¡ime_t
 
du¿tiÚ
);

1065 
ş›ÁsA»Pau£d
();

1066 
´oûssEv’tsWheBlocked
();

1068 #ifdeà
__GNUC__


1069 
	$addR•lyE¼ÜFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...)

1070 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1071 
	$addR•lyStusFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...)

1072 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1074 
	`addR•lyE¼ÜFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...);

1075 
	`addR•lyStusFÜm©
(
»disCl›Á
 *
c
, cÚ¡ *
fmt
, ...);

1079 
	`li¡Ty³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj *
v®ue
);

1080 
	`li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
);

1081 
robj
 *
	`li¡Ty³Pİ
Ôobj *
subjeù
, 
wh”e
);

1082 
	`li¡Ty³L’gth
(
robj
 *
subjeù
);

1083 
li¡Ty³I‹¿tÜ
 *
	`li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
);

1084 
	`li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
);

1085 
	`li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
);

1086 
robj
 *
	`li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
);

1087 
	`li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
);

1088 
	`li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
);

1089 
	`li¡Ty³D–‘e
(
li¡Ty³EÁry
 *
’Œy
);

1090 
	`li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1091 
	`unblockCl›ÁWa™šgD©a
(
»disCl›Á
 *
c
);

1092 
	`hªdËCl›ÁsBlockedOnLi¡s
();

1093 
	`pİG’”icCommªd
(
»disCl›Á
 *
c
, 
wh”e
);

1094 
	`sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
);

1097 
	`unw©chAÎKeys
(
»disCl›Á
 *
c
);

1098 
	`š™Cl›ÁMuÉiS‹
(
»disCl›Á
 *
c
);

1099 
	`ä“Cl›ÁMuÉiS‹
(
»disCl›Á
 *
c
);

1100 
	`queueMuÉiCommªd
(
»disCl›Á
 *
c
);

1101 
	`touchW©chedKey
(
»disDb
 *
db
, 
robj
 *
key
);

1102 
	`touchW©chedKeysOnFlush
(
dbid
);

1103 
	`disÿrdT¿n§ùiÚ
(
»disCl›Á
 *
c
);

1104 
	`æagT¿n§ùiÚ
(
»disCl›Á
 *
c
);

1107 
	`deüRefCouÁ
(
robj
 *
o
);

1108 
	`deüRefCouÁVoid
(*
o
);

1109 
	`šüRefCouÁ
(
robj
 *
o
);

1110 
robj
 *
	`»£tRefCouÁ
Ôobj *
obj
);

1111 
	`ä“SŒšgObjeù
(
robj
 *
o
);

1112 
	`ä“Li¡Objeù
(
robj
 *
o
);

1113 
	`ä“S‘Objeù
(
robj
 *
o
);

1114 
	`ä“Z£tObjeù
(
robj
 *
o
);

1115 
	`ä“HashObjeù
(
robj
 *
o
);

1116 
robj
 *
	`ü—‹Objeù
(
ty³
, *
±r
);

1117 
robj
 *
	`ü—‹SŒšgObjeù
(*
±r
, 
size_t
 
Ën
);

1118 
robj
 *
	`ü—‹RawSŒšgObjeù
(*
±r
, 
size_t
 
Ën
);

1119 
robj
 *
	`ü—‹EmbeddedSŒšgObjeù
(*
±r
, 
size_t
 
Ën
);

1120 
robj
 *
	`dupSŒšgObjeù
Ôobj *
o
);

1121 
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
robj
 *
o
, *
ÎÚgv®
);

1122 
robj
 *
	`ŒyObjeùEncodšg
Ôobj *
o
);

1123 
robj
 *
	`g‘DecodedObjeù
Ôobj *
o
);

1124 
size_t
 
	`¡ršgObjeùL’
(
robj
 *
o
);

1125 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

1126 
robj
 *
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
, 
humªä›ndly
);

1127 
robj
 *
	`ü—‹Li¡Objeù
();

1128 
robj
 *
	`ü—‹Zli¡Objeù
();

1129 
robj
 *
	`ü—‹S‘Objeù
();

1130 
robj
 *
	`ü—‹IÁ£tObjeù
();

1131 
robj
 *
	`ü—‹HashObjeù
();

1132 
robj
 *
	`ü—‹Z£tObjeù
();

1133 
robj
 *
	`ü—‹Z£tZli¡Objeù
();

1134 
	`g‘LÚgFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1135 
	`checkTy³
(
»disCl›Á
 *
c
, 
robj
 *
o
, 
ty³
);

1136 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1137 
	`g‘DoubËFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1138 
	`g‘LÚgLÚgFromObjeù
(
robj
 *
o
, *
rg‘
);

1139 
	`g‘LÚgDoubËFromObjeù
(
robj
 *
o
, *
rg‘
);

1140 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
rg‘
, cÚ¡ *
msg
);

1141 *
	`¡rEncodšg
(
’codšg
);

1142 
	`com·»SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1143 
	`cŞÏ‹SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1144 
	`equ®SŒšgObjeùs
(
robj
 *
a
,„obj *
b
);

1145 
	`e¡im©eObjeùIdËTime
(
robj
 *
o
);

1146 
	#sdsEncodedObjeù
(
obj±r
è(obj±r->
’codšg
 =ğ
REDIS_ENCODING_RAW
 || obj±r->’codšg =ğ
REDIS_ENCODING_EMBSTR
)

	)

1149 
ssize_t
 
	`syncWr™e
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1150 
ssize_t
 
	`syncR—d
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1151 
ssize_t
 
	`syncR—dLše
(
fd
, *
±r
, ssize_ˆ
size
, 
timeout
);

1154 
	`»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1155 
	`»¶iÿtiÚF“dMÚ™Üs
(
»disCl›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1156 
	`upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
);

1157 
	`»¶iÿtiÚCrÚ
();

1158 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1159 
	`»¶iÿtiÚCacheMa¡”
(
»disCl›Á
 *
c
);

1160 
	`»sizeR•liÿtiÚBacklog
(
Ãwsize
);

1161 
	`»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
);

1162 
	`»¶iÿtiÚUn£tMa¡”
();

1163 
	`»äeshGoodSÏvesCouÁ
();

1164 
	`»¶iÿtiÚSütCacheIn™
();

1165 
	`»¶iÿtiÚSütCacheFlush
();

1166 
	`»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
);

1167 
	`»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
);

1168 
	`´oûssCl›ÁsWa™šgR•liÿs
();

1169 
	`unblockCl›ÁWa™šgR•liÿs
(
»disCl›Á
 *
c
);

1170 
	`»¶iÿtiÚCouÁAcksByOff£t
(
off£t
);

1171 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

1172 
	`»¶iÿtiÚG‘SÏveOff£t
();

1173 *
	`»¶iÿtiÚG‘SÏveName
(
»disCl›Á
 *
c
);

1176 
	`¡¬tLßdšg
(
FILE
 *
å
);

1177 
	`lßdšgProg»ss
(
off_t
 
pos
);

1178 
	`¡İLßdšg
();

1181 
	~"rdb.h
"

1184 
	`æushAµ’dOÆyFe
(
fÜû
);

1185 
	`ãedAµ’dOÆyFe
(
»disCommªd
 *
cmd
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
);

1186 
	`aofRemoveTempFe
(
pid_t
 
chdpid
);

1187 
	`»wr™eAµ’dOÆyFeBackground
();

1188 
	`lßdAµ’dOÆyFe
(*
f’ame
);

1189 
	`¡İAµ’dOÆy
();

1190 
	`¡¬tAµ’dOÆy
();

1191 
	`backgroundRewr™eDÚeHªdËr
(
ex™code
, 
bysigÇl
);

1192 
	`aofRewr™eBufãrRe£t
();

1193 
	`aofRewr™eBufãrSize
();

1199 
mš
, 
max
;

1200 
mšex
, 
maxex
;

1201 } 
	tz¿nge¥ec
;

1205 
robj
 *
mš
, *
max
;

1206 
mšex
, 
maxex
;

1207 } 
	tzËx¿nge¥ec
;

1209 
zskli¡
 *
	`z¦C»©e
();

1210 
	`z¦F»e
(
zskli¡
 *
z¦
);

1211 
zskli¡Node
 *
	`z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

1212 *
	`zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
);

1213 
	`z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
);

1214 
zskli¡Node
 *
	`z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1215 
zskli¡Node
 *
	`z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
);

1216 
	`zzlG‘ScÜe
(*
¥Œ
);

1217 
	`zzlNext
(*
zl
, **
•Œ
, **
¥Œ
);

1218 
	`zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
);

1219 
	`z£tL’gth
(
robj
 *
zobj
);

1220 
	`z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
);

1221 
	`z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
);

1224 
	`ä“MemÜyIfN“ded
();

1225 
	`´oûssCommªd
(
»disCl›Á
 *
c
);

1226 
	`£tupSigÇlHªdËrs
();

1227 
»disCommªd
 *
	`lookupCommªd
(
sds
 
Çme
);

1228 
»disCommªd
 *
	`lookupCommªdByCSŒšg
(*
s
);

1229 
»disCommªd
 *
	`lookupCommªdOrOrigš®
(
sds
 
Çme
);

1230 
	`ÿÎ
(
»disCl›Á
 *
c
, 
æags
);

1231 
	`´İag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
æags
);

1232 
	`®soPrİag©e
(
»disCommªd
 *
cmd
, 
dbid
, 
robj
 **
¬gv
, 
¬gc
, 
rg‘
);

1233 
	`fÜûCommªdPrİag©iÚ
(
»disCl›Á
 *
c
, 
æags
);

1234 
	`´•¬eFÜShutdown
();

1235 #ifdeà
__GNUC__


1236 
	$»disLog
(
Ëv–
, cÚ¡ *
fmt
, ...)

1237 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

1239 
	`»disLog
(
Ëv–
, cÚ¡ *
fmt
, ...);

1241 
	`»disLogRaw
(
Ëv–
, cÚ¡ *
msg
);

1242 
	`»disLogFromHªdËr
(
Ëv–
, cÚ¡ *
msg
);

1243 
	`u§ge
();

1244 
	`upd©eDiùResizePŞicy
();

1245 
	`htN“dsResize
(
diù
 *dict);

1246 
	`oom
(cÚ¡ *
msg
);

1247 
	`pİuÏ‹CommªdTabË
();

1248 
	`»£tCommªdTabËSts
();

1249 
	`adju¡O³nFesLim™
();

1250 
	`şo£Li¡’šgSock‘s
(
uÆšk_unix_sock‘
);

1251 
	`upd©eCachedTime
();

1252 
	`»£tS”v”Sts
();

1253 
	`g‘LRUClock
();

1256 
robj
 *
	`£tTy³C»©e
Ôobj *
v®ue
);

1257 
	`£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
);

1258 
	`£tTy³Remove
(
robj
 *
subjeù
,„obj *
v®ue
);

1259 
	`£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
);

1260 
£tTy³I‹¿tÜ
 *
	`£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1261 
	`£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
);

1262 
	`£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
);

1263 
robj
 *
	`£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
);

1264 
	`£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
);

1265 
	`£tTy³Size
(
robj
 *
subjeù
);

1266 
	`£tTy³CÚv”t
(
robj
 *
subjeù
, 
’c
);

1269 
	`hashTy³CÚv”t
(
robj
 *
o
, 
’c
);

1270 
	`hashTy³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj **
¬gv
, 
¡¬t
, 
’d
);

1271 
	`hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
);

1272 
robj
 *
	`hashTy³G‘Objeù
Ôobj *
o
,„obj *
key
);

1273 
	`hashTy³Exi¡s
(
robj
 *
o
,„obj *
key
);

1274 
	`hashTy³S‘
(
robj
 *
o
,„obj *
key
,„obj *
v®ue
);

1275 
	`hashTy³D–‘e
(
robj
 *
o
,„obj *
key
);

1276 
	`hashTy³L’gth
(
robj
 *
o
);

1277 
hashTy³I‹¿tÜ
 *
	`hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
);

1278 
	`hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
);

1279 
	`hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
);

1280 
	`hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

1281 **
v¡r
,

1282 *
vËn
,

1283 *
vÎ
);

1284 
	`hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
);

1285 
robj
 *
	`hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
);

1286 
robj
 *
	`hashTy³LookupWr™eOrC»©e
(
»disCl›Á
 *
c
,„obj *
key
);

1289 
	`pubsubUnsubsüibeAÎChªÃls
(
»disCl›Á
 *
c
, 
nÙify
);

1290 
	`pubsubUnsubsüibeAÎP©‹ºs
(
»disCl›Á
 *
c
, 
nÙify
);

1291 
	`ä“PubsubP©‹º
(*
p
);

1292 
	`li¡M©chPubsubP©‹º
(*
a
, *
b
);

1293 
	`pubsubPublishMes§ge
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1296 
	`nÙifyKey¥aûEv’t
(
ty³
, *
ev’t
, 
robj
 *
key
, 
dbid
);

1297 
	`key¥aûEv’tsSŒšgToFÏgs
(*
şas£s
);

1298 
sds
 
	`key¥aûEv’tsFÏgsToSŒšg
(
æags
);

1301 
	`lßdS”v”CÚfig
(*
f’ame
, *
İtiÚs
);

1302 
	`­³ndS”v”SaveP¬ams
(
time_t
 
£cÚds
, 
chªges
);

1303 
	`»£tS”v”SaveP¬ams
();

1304 
»wr™eCÚfigS‹
;

1305 
	`»wr™eCÚfigRewr™eLše
(
»wr™eCÚfigS‹
 *
¡©e
, *
İtiÚ
, 
sds
 
lše
, 
fÜû
);

1306 
	`»wr™eCÚfig
(*
·th
);

1309 
	`»moveExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1310 
	`´İag©eExpœe
(
»disDb
 *
db
, 
robj
 *
key
);

1311 
	`expœeIfN“ded
(
»disDb
 *
db
, 
robj
 *
key
);

1312 
	`g‘Expœe
(
»disDb
 *
db
, 
robj
 *
key
);

1313 
	`£tExpœe
(
»disDb
 *
db
, 
robj
 *
key
, 
wh’
);

1314 
robj
 *
	`lookupKey
(
»disDb
 *
db
,„obj *
key
);

1315 
robj
 *
	`lookupKeyR—d
(
»disDb
 *
db
,„obj *
key
);

1316 
robj
 *
	`lookupKeyWr™e
(
»disDb
 *
db
,„obj *
key
);

1317 
robj
 *
	`lookupKeyR—dOrR•ly
(
»disCl›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1318 
robj
 *
	`lookupKeyWr™eOrR•ly
(
»disCl›Á
 *
c
,„obj *
key
,„obj *
»¶y
);

1319 
	`dbAdd
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1320 
	`dbOv”wr™e
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1321 
	`£tKey
(
»disDb
 *
db
, 
robj
 *
key
,„obj *
v®
);

1322 
	`dbExi¡s
(
»disDb
 *
db
, 
robj
 *
key
);

1323 
robj
 *
	`dbRªdomKey
(
»disDb
 *
db
);

1324 
	`dbD–‘e
(
»disDb
 *
db
, 
robj
 *
key
);

1325 
robj
 *
	`dbUnsh¬eSŒšgV®ue
(
»disDb
 *
db
,„obj *
key
,„obj *
o
);

1326 
	`em±yDb
((
ÿÎback
)(*));

1327 
	`£ËùDb
(
»disCl›Á
 *
c
, 
id
);

1328 
	`sigÇlModif›dKey
(
»disDb
 *
db
, 
robj
 *
key
);

1329 
	`sigÇlFlushedDb
(
dbid
);

1330 
	`g‘KeysInSlÙ
(
hash¦Ù
, 
robj
 **
keys
, 
couÁ
);

1331 
	`couÁKeysInSlÙ
(
hash¦Ù
);

1332 
	`d–KeysInSlÙ
(
hash¦Ù
);

1333 
	`v”ifyClu¡”CÚfigW™hD©a
();

1334 
	`sÿnG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 *
o
, 
cursÜ
);

1335 
	`·r£SÿnCursÜOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
cursÜ
);

1338 *
	`g‘KeysFromCommªd
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1339 
	`g‘KeysF»eResuÉ
(*
»suÉ
);

1340 *
	`zuniÚIÁ”G‘Keys
(
»disCommªd
 *
cmd
,
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1341 *
	`ev®G‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1342 *
	`sÜtG‘Keys
(
»disCommªd
 *
cmd
, 
robj
 **
¬gv
, 
¬gc
, *
numkeys
);

1345 
	`şu¡”In™
();

1346 
	`üc16
(cÚ¡ *
buf
, 
Ën
);

1347 
	`keyHashSlÙ
(*
key
, 
keyËn
);

1348 
	`şu¡”CrÚ
();

1349 
	`şu¡”Prİag©ePublish
(
robj
 *
chªÃl
,„obj *
mes§ge
);

1350 
	`mig¿‹Clo£TimedoutSock‘s
();

1351 
	`şu¡”BefÜeSË•
();

1354 
	`š™S’tš–CÚfig
();

1355 
	`š™S’tš–
();

1356 
	`£Áš–Tim”
();

1357 *
	`£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
);

1358 
	`£Áš–IsRuÂšg
();

1361 
	`sütšgIn™
();

1364 
	`´oûssUnblockedCl›Ás
();

1365 
	`blockCl›Á
(
»disCl›Á
 *
c
, 
bty³
);

1366 
	`unblockCl›Á
(
»disCl›Á
 *
c
);

1367 
	`»¶yToBlockedCl›ÁTimedOut
(
»disCl›Á
 *
c
);

1368 
	`g‘TimeoutFromObjeùOrR•ly
(
»disCl›Á
 *
c
, 
robj
 *
objeù
, 
m¡ime_t
 *
timeout
, 
un™
);

1369 
	`discÚÃùAÎBlockedCl›Ás
();

1372 *
	`»disG™SHA1
();

1373 *
	`»disG™Dœty
();

1374 
ušt64_t
 
	`»disBudId
();

1377 
	`authCommªd
(
»disCl›Á
 *
c
);

1378 
	`pšgCommªd
(
»disCl›Á
 *
c
);

1379 
	`echoCommªd
(
»disCl›Á
 *
c
);

1380 
	`commªdCommªd
(
»disCl›Á
 *
c
);

1381 
	`£tCommªd
(
»disCl›Á
 *
c
);

1382 
	`£ŠxCommªd
(
»disCl›Á
 *
c
);

1383 
	`£‹xCommªd
(
»disCl›Á
 *
c
);

1384 
	`p£‹xCommªd
(
»disCl›Á
 *
c
);

1385 
	`g‘Commªd
(
»disCl›Á
 *
c
);

1386 
	`d–Commªd
(
»disCl›Á
 *
c
);

1387 
	`exi¡sCommªd
(
»disCl›Á
 *
c
);

1388 
	`£tb™Commªd
(
»disCl›Á
 *
c
);

1389 
	`g‘b™Commªd
(
»disCl›Á
 *
c
);

1390 
	`£ŒªgeCommªd
(
»disCl›Á
 *
c
);

1391 
	`g‘¿ngeCommªd
(
»disCl›Á
 *
c
);

1392 
	`šüCommªd
(
»disCl›Á
 *
c
);

1393 
	`deüCommªd
(
»disCl›Á
 *
c
);

1394 
	`šübyCommªd
(
»disCl›Á
 *
c
);

1395 
	`deübyCommªd
(
»disCl›Á
 *
c
);

1396 
	`šübyæßtCommªd
(
»disCl›Á
 *
c
);

1397 
	`£ËùCommªd
(
»disCl›Á
 *
c
);

1398 
	`¿ndomkeyCommªd
(
»disCl›Á
 *
c
);

1399 
	`keysCommªd
(
»disCl›Á
 *
c
);

1400 
	`sÿnCommªd
(
»disCl›Á
 *
c
);

1401 
	`dbsizeCommªd
(
»disCl›Á
 *
c
);

1402 
	`Ï¡§veCommªd
(
»disCl›Á
 *
c
);

1403 
	`§veCommªd
(
»disCl›Á
 *
c
);

1404 
	`bg§veCommªd
(
»disCl›Á
 *
c
);

1405 
	`bg»wr™—ofCommªd
(
»disCl›Á
 *
c
);

1406 
	`shutdownCommªd
(
»disCl›Á
 *
c
);

1407 
	`moveCommªd
(
»disCl›Á
 *
c
);

1408 
	`»ÇmeCommªd
(
»disCl›Á
 *
c
);

1409 
	`»Çm’xCommªd
(
»disCl›Á
 *
c
);

1410 
	`ÍushCommªd
(
»disCl›Á
 *
c
);

1411 
	`½ushCommªd
(
»disCl›Á
 *
c
);

1412 
	`ÍushxCommªd
(
»disCl›Á
 *
c
);

1413 
	`½ushxCommªd
(
»disCl›Á
 *
c
);

1414 
	`lš£¹Commªd
(
»disCl›Á
 *
c
);

1415 
	`ÍİCommªd
(
»disCl›Á
 *
c
);

1416 
	`½İCommªd
(
»disCl›Á
 *
c
);

1417 
	`Î’Commªd
(
»disCl›Á
 *
c
);

1418 
	`lšdexCommªd
(
»disCl›Á
 *
c
);

1419 
	`ÌªgeCommªd
(
»disCl›Á
 *
c
);

1420 
	`ÉrimCommªd
(
»disCl›Á
 *
c
);

1421 
	`ty³Commªd
(
»disCl›Á
 *
c
);

1422 
	`l£tCommªd
(
»disCl›Á
 *
c
);

1423 
	`§ddCommªd
(
»disCl›Á
 *
c
);

1424 
	`¤emCommªd
(
»disCl›Á
 *
c
);

1425 
	`smoveCommªd
(
»disCl›Á
 *
c
);

1426 
	`sismemb”Commªd
(
»disCl›Á
 *
c
);

1427 
	`sÿrdCommªd
(
»disCl›Á
 *
c
);

1428 
	`¥İCommªd
(
»disCl›Á
 *
c
);

1429 
	`¤ªdmemb”Commªd
(
»disCl›Á
 *
c
);

1430 
	`sš‹rCommªd
(
»disCl›Á
 *
c
);

1431 
	`sš‹r¡ÜeCommªd
(
»disCl›Á
 *
c
);

1432 
	`suniÚCommªd
(
»disCl›Á
 *
c
);

1433 
	`suniÚ¡ÜeCommªd
(
»disCl›Á
 *
c
);

1434 
	`sdiffCommªd
(
»disCl›Á
 *
c
);

1435 
	`sdiff¡ÜeCommªd
(
»disCl›Á
 *
c
);

1436 
	`ssÿnCommªd
(
»disCl›Á
 *
c
);

1437 
	`syncCommªd
(
»disCl›Á
 *
c
);

1438 
	`æushdbCommªd
(
»disCl›Á
 *
c
);

1439 
	`æush®lCommªd
(
»disCl›Á
 *
c
);

1440 
	`sÜtCommªd
(
»disCl›Á
 *
c
);

1441 
	`ÌemCommªd
(
»disCl›Á
 *
c
);

1442 
	`½İÍushCommªd
(
»disCl›Á
 *
c
);

1443 
	`šfoCommªd
(
»disCl›Á
 *
c
);

1444 
	`mg‘Commªd
(
»disCl›Á
 *
c
);

1445 
	`mÚ™ÜCommªd
(
»disCl›Á
 *
c
);

1446 
	`expœeCommªd
(
»disCl›Á
 *
c
);

1447 
	`expœ—tCommªd
(
»disCl›Á
 *
c
);

1448 
	`³xpœeCommªd
(
»disCl›Á
 *
c
);

1449 
	`³xpœ—tCommªd
(
»disCl›Á
 *
c
);

1450 
	`g‘£tCommªd
(
»disCl›Á
 *
c
);

1451 
	`‰lCommªd
(
»disCl›Á
 *
c
);

1452 
	`±Commªd
(
»disCl›Á
 *
c
);

1453 
	`³rsi¡Commªd
(
»disCl›Á
 *
c
);

1454 
	`¦aveofCommªd
(
»disCl›Á
 *
c
);

1455 
	`rŞeCommªd
(
»disCl›Á
 *
c
);

1456 
	`debugCommªd
(
»disCl›Á
 *
c
);

1457 
	`m£tCommªd
(
»disCl›Á
 *
c
);

1458 
	`m£ŠxCommªd
(
»disCl›Á
 *
c
);

1459 
	`zaddCommªd
(
»disCl›Á
 *
c
);

1460 
	`zšübyCommªd
(
»disCl›Á
 *
c
);

1461 
	`z¿ngeCommªd
(
»disCl›Á
 *
c
);

1462 
	`z¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
);

1463 
	`z»v¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
);

1464 
	`z¿ngebyËxCommªd
(
»disCl›Á
 *
c
);

1465 
	`z»v¿ngebyËxCommªd
(
»disCl›Á
 *
c
);

1466 
	`zcouÁCommªd
(
»disCl›Á
 *
c
);

1467 
	`zËxcouÁCommªd
(
»disCl›Á
 *
c
);

1468 
	`z»v¿ngeCommªd
(
»disCl›Á
 *
c
);

1469 
	`zÿrdCommªd
(
»disCl›Á
 *
c
);

1470 
	`z»mCommªd
(
»disCl›Á
 *
c
);

1471 
	`zscÜeCommªd
(
»disCl›Á
 *
c
);

1472 
	`z»m¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
);

1473 
	`z»m¿ngebyËxCommªd
(
»disCl›Á
 *
c
);

1474 
	`muÉiCommªd
(
»disCl›Á
 *
c
);

1475 
	`execCommªd
(
»disCl›Á
 *
c
);

1476 
	`disÿrdCommªd
(
»disCl›Á
 *
c
);

1477 
	`bÍİCommªd
(
»disCl›Á
 *
c
);

1478 
	`b½İCommªd
(
»disCl›Á
 *
c
);

1479 
	`b½İÍushCommªd
(
»disCl›Á
 *
c
);

1480 
	`­³ndCommªd
(
»disCl›Á
 *
c
);

1481 
	`¡¾’Commªd
(
»disCl›Á
 *
c
);

1482 
	`z¿nkCommªd
(
»disCl›Á
 *
c
);

1483 
	`z»v¿nkCommªd
(
»disCl›Á
 *
c
);

1484 
	`h£tCommªd
(
»disCl›Á
 *
c
);

1485 
	`h£ŠxCommªd
(
»disCl›Á
 *
c
);

1486 
	`hg‘Commªd
(
»disCl›Á
 *
c
);

1487 
	`hm£tCommªd
(
»disCl›Á
 *
c
);

1488 
	`hmg‘Commªd
(
»disCl›Á
 *
c
);

1489 
	`hd–Commªd
(
»disCl›Á
 *
c
);

1490 
	`hËnCommªd
(
»disCl›Á
 *
c
);

1491 
	`z»m¿ngeby¿nkCommªd
(
»disCl›Á
 *
c
);

1492 
	`zuniÚ¡ÜeCommªd
(
»disCl›Á
 *
c
);

1493 
	`zš‹r¡ÜeCommªd
(
»disCl›Á
 *
c
);

1494 
	`zsÿnCommªd
(
»disCl›Á
 *
c
);

1495 
	`hkeysCommªd
(
»disCl›Á
 *
c
);

1496 
	`hv®sCommªd
(
»disCl›Á
 *
c
);

1497 
	`hg‘®lCommªd
(
»disCl›Á
 *
c
);

1498 
	`hexi¡sCommªd
(
»disCl›Á
 *
c
);

1499 
	`hsÿnCommªd
(
»disCl›Á
 *
c
);

1500 
	`cÚfigCommªd
(
»disCl›Á
 *
c
);

1501 
	`hšübyCommªd
(
»disCl›Á
 *
c
);

1502 
	`hšübyæßtCommªd
(
»disCl›Á
 *
c
);

1503 
	`subsüibeCommªd
(
»disCl›Á
 *
c
);

1504 
	`unsubsüibeCommªd
(
»disCl›Á
 *
c
);

1505 
	`psubsüibeCommªd
(
»disCl›Á
 *
c
);

1506 
	`punsubsüibeCommªd
(
»disCl›Á
 *
c
);

1507 
	`publishCommªd
(
»disCl›Á
 *
c
);

1508 
	`pubsubCommªd
(
»disCl›Á
 *
c
);

1509 
	`w©chCommªd
(
»disCl›Á
 *
c
);

1510 
	`unw©chCommªd
(
»disCl›Á
 *
c
);

1511 
	`şu¡”Commªd
(
»disCl›Á
 *
c
);

1512 
	`»¡ÜeCommªd
(
»disCl›Á
 *
c
);

1513 
	`mig¿‹Commªd
(
»disCl›Á
 *
c
);

1514 
	`askšgCommªd
(
»disCl›Á
 *
c
);

1515 
	`»adÚlyCommªd
(
»disCl›Á
 *
c
);

1516 
	`»adwr™eCommªd
(
»disCl›Á
 *
c
);

1517 
	`dumpCommªd
(
»disCl›Á
 *
c
);

1518 
	`objeùCommªd
(
»disCl›Á
 *
c
);

1519 
	`ş›ÁCommªd
(
»disCl›Á
 *
c
);

1520 
	`ev®Commªd
(
»disCl›Á
 *
c
);

1521 
	`ev®ShaCommªd
(
»disCl›Á
 *
c
);

1522 
	`sütCommªd
(
»disCl›Á
 *
c
);

1523 
	`timeCommªd
(
»disCl›Á
 *
c
);

1524 
	`b™İCommªd
(
»disCl›Á
 *
c
);

1525 
	`b™couÁCommªd
(
»disCl›Á
 *
c
);

1526 
	`b™posCommªd
(
»disCl›Á
 *
c
);

1527 
	`»¶cÚfCommªd
(
»disCl›Á
 *
c
);

1528 
	`wa™Commªd
(
»disCl›Á
 *
c
);

1529 
	`pf£láe¡Commªd
(
»disCl›Á
 *
c
);

1530 
	`pçddCommªd
(
»disCl›Á
 *
c
);

1531 
	`pfcouÁCommªd
(
»disCl›Á
 *
c
);

1532 
	`pfm”geCommªd
(
»disCl›Á
 *
c
);

1533 
	`pfdebugCommªd
(
»disCl›Á
 *
c
);

1534 
	`Ï‹ncyCommªd
(
»disCl›Á
 *
c
);

1536 #ià
	`defšed
(
__GNUC__
)

1537 *
	$ÿÎoc
(
size_t
 
couÁ
, size_ˆ
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1538 
	$ä“
(*
±r
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1539 *
	$m®loc
(
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1540 *
	$»®loc
(*
±r
, 
size_t
 
size
è
	`__©Œibu‹__
 ((
d•»ÿ‹d
));

1544 
	`_»disAs£¹W™hInfo
(
»disCl›Á
 *
c
, 
robj
 *
o
, *
e¡r
, *
fe
, 
lše
);

1545 
	`_»disAs£¹
(*
e¡r
, *
fe
, 
lše
);

1546 
	`_»disPªic
(*
msg
, *
fe
, 
lše
);

1547 
	`bugR•ÜtS¹
();

1548 
	`»disLogObjeùDebugInfo
(
robj
 *
o
);

1549 
	`sig£gvHªdËr
(
sig
, 
sigšfo_t
 *
šfo
, *
£ü‘
);

1550 
sds
 
	`g’RedisInfoSŒšg
(*
£ùiÚ
);

1551 
	`’abËW©chdog
(
³riod
);

1552 
	`di§bËW©chdog
();

1553 
	`w©chdogScheduËSigÇl
(
³riod
);

1554 
	`»disLogHexDump
(
Ëv–
, *
desü
, *
v®ue
, 
size_t
 
Ën
);

1556 
	#»disDebug
(
fmt
, ...) \

1557 
	`´štf
("DEBUG %s:%d > " 
fmt
 "\n", 
__FILE__
, 
__LINE__
, 
__VA_ARGS__
)

	)

1558 
	#»disDebugM¬k
() \

1559 
	`´štf
("-- MARK %s:%d --\n", 
__FILE__
, 
__LINE__
)

	)

	@redisassert.h

38 #iâdeà
__REDIS_ASSERT_H__


39 
	#__REDIS_ASSERT_H__


	)

41 
	~<uni¡d.h
>

43 
	#as£¹
(
_e
è((_e)?()0 : (
	`_»disAs£¹
(#_e,
__FILE__
,
__LINE__
),
	`_ex™
(1)))

	)

45 
_»disAs£¹
(*
e¡r
, *
fe
, 
lše
);

	@release.c

34 
	~<¡ršg.h
>

36 
	~"»Ëa£.h
"

37 
	~"v”siÚ.h
"

38 
	~"üc64.h
"

40 *
	$»disG™SHA1
() {

41  
REDIS_GIT_SHA1
;

42 
	}
}

44 *
	$»disG™Dœty
() {

45  
REDIS_GIT_DIRTY
;

46 
	}
}

48 
ušt64_t
 
	$»disBudId
() {

49 *
budid
 = 
REDIS_VERSION
 
REDIS_BUILD_ID
 
REDIS_GIT_DIRTY
 
REDIS_GIT_SHA1
;

51  
	`üc64
(0,(*)
budid
,
	`¡¾’
(buildid));

52 
	}
}

	@release.h

1 
	#REDIS_GIT_SHA1
 "1a7a372a"

	)

2 
	#REDIS_GIT_DIRTY
 "175591"

	)

3 
	#REDIS_BUILD_ID
 "vm1-1104792376"

	)

	@replication.c

32 
	~"»dis.h
"

34 
	~<sys/time.h
>

35 
	~<uni¡d.h
>

36 
	~<fú.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

40 
»¶iÿtiÚDisÿrdCachedMa¡”
();

41 
»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
);

42 
»¶iÿtiÚS’dAck
();

43 
putSÏveOÆše
(
»disCl›Á
 *
¦ave
);

51 *
	$»¶iÿtiÚG‘SÏveName
(
»disCl›Á
 *
c
) {

52 
buf
[
REDIS_PEER_ID_LEN
];

53 

[
REDIS_IP_STR_LEN
];

55 

[0] = '\0';

56 
buf
[0] = '\0';

57 ià(
	`ª‘P“rToSŒšg
(
c
->
fd
,

,(),
NULL
) != -1) {

58 ià(
c
->
¦ave_li¡’šg_pÜt
)

59 
	`¢´štf
(
buf
,(buf),"%s:%d",

,
c
->
¦ave_li¡’šg_pÜt
);

61 
	`¢´štf
(
buf
,(buf),"%s:<unknown-¦ave-pÜt>",

);

63 
	`¢´štf
(
buf
,(buf),"client id #%llu",

64 (è
c
->
id
);

66  
buf
;

67 
	}
}

71 
	$ü—‹R•liÿtiÚBacklog
() {

72 
	`»disAs£¹
(
£rv”
.
»¶_backlog
 =ğ
NULL
);

73 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

74 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

75 
£rv”
.
»¶_backlog_idx
 = 0;

80 
£rv”
.
ma¡”_»¶_off£t
++;

85 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

86 
	}
}

94 
	$»sizeR•liÿtiÚBacklog
(
Ãwsize
) {

95 ià(
Ãwsize
 < 
REDIS_REPL_BACKLOG_MIN_SIZE
)

96 
Ãwsize
 = 
REDIS_REPL_BACKLOG_MIN_SIZE
;

97 ià(
£rv”
.
»¶_backlog_size
 =ğ
Ãwsize
) ;

99 
£rv”
.
»¶_backlog_size
 = 
Ãwsize
;

100 ià(
£rv”
.
»¶_backlog
 !ğ
NULL
) {

106 
	`zä“
(
£rv”
.
»¶_backlog
);

107 
£rv”
.
»¶_backlog
 = 
	`zm®loc
(£rv”.
»¶_backlog_size
);

108 
£rv”
.
»¶_backlog_hi¡Ën
 = 0;

109 
£rv”
.
»¶_backlog_idx
 = 0;

111 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
+1;

113 
	}
}

115 
	$ä“R•liÿtiÚBacklog
() {

116 
	`»disAs£¹
(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0);

117 
	`zä“
(
£rv”
.
»¶_backlog
);

118 
£rv”
.
»¶_backlog
 = 
NULL
;

119 
	}
}

125 
	$ãedR•liÿtiÚBacklog
(*
±r
, 
size_t
 
Ën
) {

126 *
p
 = 
±r
;

128 
£rv”
.
ma¡”_»¶_off£t
 +ğ
Ën
;

132 
Ën
) {

133 
size_t
 
thi¦’
 = 
£rv”
.
»¶_backlog_size
 - s”v”.
»¶_backlog_idx
;

134 ià(
thi¦’
 > 
Ën
)hislen =†en;

135 
	`memıy
(
£rv”
.
»¶_backlog
+£rv”.
»¶_backlog_idx
,
p
,
thi¦’
);

136 
£rv”
.
»¶_backlog_idx
 +ğ
thi¦’
;

137 ià(
£rv”
.
»¶_backlog_idx
 =ğ£rv”.
»¶_backlog_size
)

138 
£rv”
.
»¶_backlog_idx
 = 0;

139 
Ën
 -ğ
thi¦’
;

140 
p
 +ğ
thi¦’
;

141 
£rv”
.
»¶_backlog_hi¡Ën
 +ğ
thi¦’
;

143 ià(
£rv”
.
»¶_backlog_hi¡Ën
 > s”v”.
»¶_backlog_size
)

144 
£rv”
.
»¶_backlog_hi¡Ën
 = s”v”.
»¶_backlog_size
;

146 
£rv”
.
»¶_backlog_off
 = s”v”.
ma¡”_»¶_off£t
 -

147 
£rv”
.
»¶_backlog_hi¡Ën
 + 1;

148 
	}
}

152 
	$ãedR•liÿtiÚBacklogW™hObjeù
(
robj
 *
o
) {

153 
Î¡r
[
REDIS_LONGSTR_SIZE
];

154 *
p
;

155 
size_t
 
Ën
;

157 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

158 
Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),()
o
->
±r
);

159 
p
 = 
Î¡r
;

161 
Ën
 = 
	`sd¦’
(
o
->
±r
);

162 
p
 = 
o
->
±r
;

164 
	`ãedR•liÿtiÚBacklog
(
p
,
Ën
);

165 
	}
}

167 
	$»¶iÿtiÚF“dSÏves
(
li¡
 *
¦aves
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

168 
li¡Node
 *
Ê
;

169 
li¡I‹r
 
li
;

170 
j
, 
Ën
;

171 
Î¡r
[
REDIS_LONGSTR_SIZE
];

175 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
 && 
	`li¡L’gth
(
¦aves
) == 0) ;

178 
	`»disAs£¹
(!(
	`li¡L’gth
(
¦aves
è!ğ0 && 
£rv”
.
»¶_backlog
 =ğ
NULL
));

181 ià(
£rv”
.
¦ave£ldb
 !ğ
diùid
) {

182 
robj
 *
£Ëùcmd
;

185 ià(
diùid
 >ğ0 && diùid < 
REDIS_SHARED_SELECT_CMDS
) {

186 
£Ëùcmd
 = 
sh¬ed
.
£Ëù
[
diùid
];

188 
diùid_Ën
;

190 
diùid_Ën
 = 
	`Î2¡ršg
(
Î¡r
,Öl¡r),
diùid
);

191 
£Ëùcmd
 = 
	`ü—‹Objeù
(
REDIS_STRING
,

192 
	`sdsÿrštf
(
	`sd£m±y
(),

194 
diùid_Ën
, 
Î¡r
));

198 ià(
£rv”
.
»¶_backlog
è
	`ãedR•liÿtiÚBacklogW™hObjeù
(
£Ëùcmd
);

201 
	`li¡Rewšd
(
¦aves
,&
li
);

202 (
Ê
 = 
	`li¡Next
(&
li
))) {

203 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

204 
	`addR•ly
(
¦ave
,
£Ëùcmd
);

207 ià(
diùid
 < 0 || diùid >ğ
REDIS_SHARED_SELECT_CMDS
)

208 
	`deüRefCouÁ
(
£Ëùcmd
);

210 
£rv”
.
¦ave£ldb
 = 
diùid
;

213 ià(
£rv”
.
»¶_backlog
) {

214 
aux
[
REDIS_LONGSTR_SIZE
+3];

217 
aux
[0] = '*';

218 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
¬gc
);

219 
aux
[
Ën
+1] = '\r';

220 
aux
[
Ën
+2] = '\n';

221 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

223 
j
 = 0; j < 
¬gc
; j++) {

224 
objËn
 = 
	`¡ršgObjeùL’
(
¬gv
[
j
]);

229 
aux
[0] = '$';

230 
Ën
 = 
	`Î2¡ršg
(
aux
+1,×ux)-1,
objËn
);

231 
aux
[
Ën
+1] = '\r';

232 
aux
[
Ën
+2] = '\n';

233 
	`ãedR•liÿtiÚBacklog
(
aux
,
Ën
+3);

234 
	`ãedR•liÿtiÚBacklogW™hObjeù
(
¬gv
[
j
]);

235 
	`ãedR•liÿtiÚBacklog
(
aux
+
Ën
+1,2);

240 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

241 (
Ê
 = 
	`li¡Next
(&
li
))) {

242 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

245 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
) ;

252 
	`addR•lyMuÉiBulkL’
(
¦ave
,
¬gc
);

256 
j
 = 0; j < 
¬gc
; j++)

257 
	`addR•lyBulk
(
¦ave
,
¬gv
[
j
]);

259 
	}
}

261 
	$»¶iÿtiÚF“dMÚ™Üs
(
»disCl›Á
 *
c
, 
li¡
 *
mÚ™Üs
, 
diùid
, 
robj
 **
¬gv
, 
¬gc
) {

262 
li¡Node
 *
Ê
;

263 
li¡I‹r
 
li
;

264 
j
;

265 
sds
 
cmd»´
 = 
	`sd¢ew
("+");

266 
robj
 *
cmdobj
;

267 
timev®
 
tv
;

269 
	`g‘timeofday
(&
tv
,
NULL
);

270 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"%ld.%06ld ",()
tv
.
tv_£c
,(év.
tv_u£c
);

271 ià(
c
->
æags
 & 
REDIS_LUA_CLIENT
) {

272 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d†ua] ",
diùid
);

273 } ià(
c
->
æags
 & 
REDIS_UNIX_SOCKET
) {

274 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d unix:%s] ",
diùid
,
£rv”
.
unixsock‘
);

276 
cmd»´
 = 
	`sdsÿrštf
(cmd»´,"[%d %s] ",
diùid
,
	`g‘Cl›ÁP“rId
(
c
));

279 
j
 = 0; j < 
¬gc
; j++) {

280 ià(
¬gv
[
j
]->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

281 
cmd»´
 = 
	`sdsÿrštf
(cmd»´, "\"%ld\"", ()
¬gv
[
j
]->
±r
);

283 
cmd»´
 = 
	`sdsÿŒ•r
(cmd»´,(*)
¬gv
[
j
]->
±r
,

284 
	`sd¦’
(
¬gv
[
j
]->
±r
));

286 ià(
j
 !ğ
¬gc
-1)

287 
cmd»´
 = 
	`sdsÿ’
(cmdrepr," ",1);

289 
cmd»´
 = 
	`sdsÿ’
(cmdrepr,"\r\n",2);

290 
cmdobj
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
cmd»´
);

292 
	`li¡Rewšd
(
mÚ™Üs
,&
li
);

293 (
Ê
 = 
	`li¡Next
(&
li
))) {

294 
»disCl›Á
 *
mÚ™Ü
 = 
Ê
->
v®ue
;

295 
	`addR•ly
(
mÚ™Ü
,
cmdobj
);

297 
	`deüRefCouÁ
(
cmdobj
);

298 
	}
}

302 
	$addR•lyR•liÿtiÚBacklog
(
»disCl›Á
 *
c
, 
off£t
) {

303 
j
, 
sk
, 
Ën
;

305 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] SÏv»que¡ off£t: %Îd", 
off£t
);

307 ià(
£rv”
.
»¶_backlog_hi¡Ën
 == 0) {

308 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] Backlog history†en is zero");

312 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] Backlog size: %lld",

313 
£rv”
.
»¶_backlog_size
);

314 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] First byte: %lld",

315 
£rv”
.
»¶_backlog_off
);

316 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] History†en: %lld",

317 
£rv”
.
»¶_backlog_hi¡Ën
);

318 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] Current index: %lld",

319 
£rv”
.
»¶_backlog_idx
);

322 
sk
 = 
off£t
 - 
£rv”
.
»¶_backlog_off
;

323 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] Skpšg: %Îd", 
sk
);

327 
j
 = (
£rv”
.
»¶_backlog_idx
 +

328 (
£rv”
.
»¶_backlog_size
-£rv”.
»¶_backlog_hi¡Ën
)) %

329 
£rv”
.
»¶_backlog_size
;

330 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] Index oàfœ¡ by‹: %Îd", 
j
);

333 
j
 = (j + 
sk
è% 
£rv”
.
»¶_backlog_size
;

337 
Ën
 = 
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

338 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC] R•lyÙ®†’gth: %Îd", 
Ën
);

339 
Ën
) {

340 
thi¦’
 =

341 ((
£rv”
.
»¶_backlog_size
 - 
j
è< 
Ën
) ?

342 (
£rv”
.
»¶_backlog_size
 - 
j
è: 
Ën
;

344 
	`»disLog
(
REDIS_DEBUG
, "[PSYNC]‡ddR•ly(èËngth: %Îd", 
thi¦’
);

345 
	`addR•lySds
(
c
,
	`sd¢ewËn
(
£rv”
.
»¶_backlog
 + 
j
, 
thi¦’
));

346 
Ën
 -ğ
thi¦’
;

347 
j
 = 0;

349  
£rv”
.
»¶_backlog_hi¡Ën
 - 
sk
;

350 
	}
}

357 
	$ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
»disCl›Á
 *
c
) {

358 
psync_off£t
, 
psync_Ën
;

359 *
ma¡”_runid
 = 
c
->
¬gv
[1]->
±r
;

360 
buf
[128];

361 
buæ’
;

366 ià(
	`¡rÿ£cmp
(
ma¡”_runid
, 
£rv”
.
runid
)) {

368 ià(
ma¡”_runid
[0] != '?') {

369 
	`»disLog
(
REDIS_NOTICE
,"Partial„esynchronization‚ot‡ccepted: "

371 
ma¡”_runid
, 
£rv”
.
runid
);

373 
	`»disLog
(
REDIS_NOTICE
,"Full„esync„equested by slave %s",

374 
	`»¶iÿtiÚG‘SÏveName
(
c
));

376 
Ãed_fuÎ_»sync
;

380 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
psync_off£t
,
NULL
) !=

381 
REDIS_OK
è
Ãed_fuÎ_»sync
;

382 ià(!
£rv”
.
»¶_backlog
 ||

383 
psync_off£t
 < 
£rv”
.
»¶_backlog_off
 ||

384 
psync_off£t
 > (
£rv”
.
»¶_backlog_off
 + s”v”.
»¶_backlog_hi¡Ën
))

386 
	`»disLog
(
REDIS_NOTICE
,

387 "UÇbËØ·¹ŸÈ»synøw™h sÏv% fÜ†ack oàbacklog (SÏv»que¡ was: %Îd).", 
	`»¶iÿtiÚG‘SÏveName
(
c
), 
psync_off£t
);

388 ià(
psync_off£t
 > 
£rv”
.
ma¡”_»¶_off£t
) {

389 
	`»disLog
(
REDIS_WARNING
,

390 "W¬nšg: sÏv% Œ›dØPSYNC w™h‡Àoff£ˆth© i g»©”hªhma¡”„•liÿtiÚ off£t.", 
	`»¶iÿtiÚG‘SÏveName
(
c
));

392 
Ãed_fuÎ_»sync
;

399 
c
->
æags
 |ğ
REDIS_SLAVE
;

400 
c
->
»¶¡©e
 = 
REDIS_REPL_ONLINE
;

401 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

402 
c
->
»¶_put_Úlše_Ú_ack
 = 0;

403 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

407 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+CONTINUE\r\n");

408 ià(
	`wr™e
(
c
->
fd
,
buf
,
buæ’
) != buflen) {

409 
	`ä“Cl›ÁAsync
(
c
);

410  
REDIS_OK
;

412 
psync_Ën
 = 
	`addR•lyR•liÿtiÚBacklog
(
c
,
psync_off£t
);

413 
	`»disLog
(
REDIS_NOTICE
,

415 
	`»¶iÿtiÚG‘SÏveName
(
c
),

416 
psync_Ën
, 
psync_off£t
);

421 
	`»äeshGoodSÏvesCouÁ
();

422  
REDIS_OK
;

424 
Ãed_fuÎ_»sync
:

426 
psync_off£t
 = 
£rv”
.
ma¡”_»¶_off£t
;

429 ià(
£rv”
.
»¶_backlog
 =ğ
NULL
è
psync_off£t
++;

431 
buæ’
 = 
	`¢´štf
(
buf
,(buf),"+FULLRESYNC %s %lld\r\n",

432 
£rv”
.
runid
,
psync_off£t
);

433 ià(
	`wr™e
(
c
->
fd
,
buf
,
buæ’
) != buflen) {

434 
	`ä“Cl›ÁAsync
(
c
);

435  
REDIS_OK
;

437  
REDIS_ERR
;

438 
	}
}

445 
	$¡¬tBg§veFÜR•liÿtiÚ
() {

446 
»tv®
;

448 
	`»disLog
(
REDIS_NOTICE
,"Starting BGSAVE for SYNC witharget: %s",

449 
£rv”
.
»¶_diskËss_sync
 ? "slaves sockets" : "disk");

451 ià(
£rv”
.
»¶_diskËss_sync
)

452 
»tv®
 = 
	`rdbSaveToSÏvesSock‘s
();

454 
»tv®
 = 
	`rdbSaveBackground
(
£rv”
.
rdb_f’ame
);

458 ià(
»tv®
 =ğ
REDIS_OK
è
	`»¶iÿtiÚSütCacheFlush
();

459  
»tv®
;

460 
	}
}

463 
	$syncCommªd
(
»disCl›Á
 *
c
) {

465 ià(
c
->
æags
 & 
REDIS_SLAVE
) ;

469 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 !ğ
REDIS_REPL_CONNECTED
) {

470 
	`addR•lyE¼Ü
(
c
,"Can't SYNC while‚ot connected with my master");

478 ià(
	`li¡L’gth
(
c
->
»¶y
è!ğ0 || c->
buåos
 != 0) {

479 
	`addR•lyE¼Ü
(
c
,"SYNC‡nd PSYNC‡re invalid with…ending output");

483 
	`»disLog
(
REDIS_NOTICE
,"Slave %s‡sks for synchronization",

484 
	`»¶iÿtiÚG‘SÏveName
(
c
));

495 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[0]->
±r
,"psync")) {

496 ià(
	`ma¡”TryP¬tŸlResynchrÚiz©iÚ
(
c
è=ğ
REDIS_OK
) {

497 
£rv”
.
¡©_sync_·¹Ÿl_ok
++;

500 *
ma¡”_runid
 = 
c
->
¬gv
[1]->
±r
;

506 ià(
ma¡”_runid
[0] !ğ'?'è
£rv”
.
¡©_sync_·¹Ÿl_”r
++;

512 
c
->
æags
 |ğ
REDIS_PRE_PSYNC
;

516 
£rv”
.
¡©_sync_fuÎ
++;

520 ià(
£rv”
.
rdb_chd_pid
 != -1 &&

521 
£rv”
.
rdb_chd_ty³
 =ğ
REDIS_RDB_CHILD_TYPE_DISK
)

526 
»disCl›Á
 *
¦ave
;

527 
li¡Node
 *
Ê
;

528 
li¡I‹r
 
li
;

530 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

531 (
Ê
 = 
	`li¡Next
(&
li
))) {

532 
¦ave
 = 
Ê
->
v®ue
;

533 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_END
) ;

535 ià(
Ê
) {

538 
	`cİyCl›ÁOuutBufãr
(
c
,
¦ave
);

539 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_END
;

540 
	`»disLog
(
REDIS_NOTICE
,"Waiting forƒnd of BGSAVE for SYNC");

544 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_START
;

545 
	`»disLog
(
REDIS_NOTICE
,"Waiting for‚ext BGSAVE for SYNC");

547 } ià(
£rv”
.
rdb_chd_pid
 != -1 &&

548 
£rv”
.
rdb_chd_ty³
 =ğ
REDIS_RDB_CHILD_TYPE_SOCKET
)

553 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_START
;

554 
	`»disLog
(
REDIS_NOTICE
,"Waiting for‚ext BGSAVE for SYNC");

556 ià(
£rv”
.
»¶_diskËss_sync
) {

560 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_START
;

561 ià(
£rv”
.
»¶_diskËss_sync_d–ay
)

562 
	`»disLog
(
REDIS_NOTICE
,"Delay‚ext BGSAVE for SYNC");

565 ià(
	`¡¬tBg§veFÜR•liÿtiÚ
(è!ğ
REDIS_OK
) {

566 
	`»disLog
(
REDIS_NOTICE
,"Replication failed, can't BGSAVE");

567 
	`addR•lyE¼Ü
(
c
,"Unableo…erform background save");

570 
c
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_END
;

574 ià(
£rv”
.
»¶_di§bË_tı_nod–ay
)

575 
	`ª‘Di§bËTıNoD–ay
(
NULL
, 
c
->
fd
);

576 
c
->
»¶dbfd
 = -1;

577 
c
->
æags
 |ğ
REDIS_SLAVE
;

578 
£rv”
.
¦ave£ldb
 = -1;

579 
	`li¡AddNodeTa
(
£rv”
.
¦aves
,
c
);

580 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ1 && s”v”.
»¶_backlog
 =ğ
NULL
)

581 
	`ü—‹R•liÿtiÚBacklog
();

583 
	}
}

597 
	$»¶cÚfCommªd
(
»disCl›Á
 *
c
) {

598 
j
;

600 ià((
c
->
¬gc
 % 2) == 0) {

603 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

608 
j
 = 1; j < 
c
->
¬gc
; j+=2) {

609 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"listening-port")) {

610 
pÜt
;

612 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
+1],

613 &
pÜt
,
NULL
è!ğ
REDIS_OK
))

615 
c
->
¦ave_li¡’šg_pÜt
 = 
pÜt
;

616 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"ack")) {

620 
off£t
;

622 ià(!(
c
->
æags
 & 
REDIS_SLAVE
)) ;

623 ià((
	`g‘LÚgLÚgFromObjeù
(
c
->
¬gv
[
j
+1], &
off£t
è!ğ
REDIS_OK
))

625 ià(
off£t
 > 
c
->
»¶_ack_off
)

626 
c
->
»¶_ack_off
 = 
off£t
;

627 
c
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

631 ià(
c
->
»¶_put_Úlše_Ú_ack
 && c->
»¶¡©e
 =ğ
REDIS_REPL_ONLINE
)

632 
	`putSÏveOÆše
(
c
);

635 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"getack")) {

638 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
è
	`»¶iÿtiÚS’dAck
();

641 
	`addR•lyE¼ÜFÜm©
(
c
,"Unrecognized REPLCONF option: %s",

642 (*)
c
->
¬gv
[
j
]->
±r
);

646 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

647 
	}
}

661 
	$putSÏveOÆše
(
»disCl›Á
 *
¦ave
) {

662 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_ONLINE
;

663 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 0;

664 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

665 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
,

666 
£ndR•lyToCl›Á
, 
¦ave
è=ğ
AE_ERR
) {

667 
	`»disLog
(
REDIS_WARNING
,"UÇbËØ»gi¡” wr™abËƒv’ˆfÜ sÏvbulk¿nsãr: %s", 
	`¡»¼Ü
(
”ºo
));

668 
	`ä“Cl›Á
(
¦ave
);

671 
	`»äeshGoodSÏvesCouÁ
();

672 
	`»disLog
(
REDIS_NOTICE
,"Synchronization with slave %s succeeded",

673 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

674 
	}
}

676 
	$£ndBulkToSÏve
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

677 
»disCl›Á
 *
¦ave
 = 
´ivd©a
;

678 
	`REDIS_NOTUSED
(
–
);

679 
	`REDIS_NOTUSED
(
mask
);

680 
buf
[
REDIS_IOBUF_LEN
];

681 
ssize_t
 
nwr™‹n
, 
buæ’
;

686 ià(
¦ave
->
»¶´—mbË
) {

687 
nwr™‹n
 = 
	`wr™e
(
fd
,
¦ave
->
»¶´—mbË
,
	`sd¦’
(slave->replpreamble));

688 ià(
nwr™‹n
 == -1) {

689 
	`»disLog
(
REDIS_VERBOSE
,"Writeƒrror sending RDB…reambleo slave: %s",

690 
	`¡»¼Ü
(
”ºo
));

691 
	`ä“Cl›Á
(
¦ave
);

694 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

695 
	`sd¤ªge
(
¦ave
->
»¶´—mbË
,
nwr™‹n
,-1);

696 ià(
	`sd¦’
(
¦ave
->
»¶´—mbË
) == 0) {

697 
	`sdsä“
(
¦ave
->
»¶´—mbË
);

698 
¦ave
->
»¶´—mbË
 = 
NULL
;

706 
	`l£ek
(
¦ave
->
»¶dbfd
,¦ave->
»¶dboff
,
SEEK_SET
);

707 
buæ’
 = 
	`»ad
(
¦ave
->
»¶dbfd
,
buf
,
REDIS_IOBUF_LEN
);

708 ià(
buæ’
 <= 0) {

709 
	`»disLog
(
REDIS_WARNING
,"Readƒrror sending DBo slave: %s",

710 (
buæ’
 =ğ0è? "´em©u» EOF" : 
	`¡»¼Ü
(
”ºo
));

711 
	`ä“Cl›Á
(
¦ave
);

714 ià((
nwr™‹n
 = 
	`wr™e
(
fd
,
buf
,
buæ’
)) == -1) {

715 ià(
”ºo
 !ğ
EAGAIN
) {

716 
	`»disLog
(
REDIS_WARNING
,"Writeƒrror sending DBo slave: %s",

717 
	`¡»¼Ü
(
”ºo
));

718 
	`ä“Cl›Á
(
¦ave
);

722 
¦ave
->
»¶dboff
 +ğ
nwr™‹n
;

723 
£rv”
.
¡©_Ãt_ouut_by‹s
 +ğ
nwr™‹n
;

724 ià(
¦ave
->
»¶dboff
 =ğ¦ave->
»¶dbsize
) {

725 
	`şo£
(
¦ave
->
»¶dbfd
);

726 
¦ave
->
»¶dbfd
 = -1;

727 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

728 
	`putSÏveOÆše
(
¦ave
);

730 
	}
}

746 
	$upd©eSÏvesWa™šgBg§ve
(
bg§v“¼
, 
ty³
) {

747 
li¡Node
 *
Ê
;

748 
¡¬tbg§ve
 = 0;

749 
li¡I‹r
 
li
;

751 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

752 (
Ê
 = 
	`li¡Next
(&
li
))) {

753 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

755 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
) {

756 
¡¬tbg§ve
 = 1;

757 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_END
;

758 } ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_END
) {

759 
»dis_¡©
 
buf
;

766 ià(
ty³
 =ğ
REDIS_RDB_CHILD_TYPE_SOCKET
) {

767 
	`»disLog
(
REDIS_NOTICE
,

769 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

775 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_ONLINE
;

776 
¦ave
->
»¶_put_Úlše_Ú_ack
 = 1;

777 
¦ave
->
»¶_ack_time
 = 
£rv”
.
unixtime
;

779 ià(
bg§v“¼
 !ğ
REDIS_OK
) {

780 
	`ä“Cl›Á
(
¦ave
);

781 
	`»disLog
(
REDIS_WARNING
,"SYNC failed. BGSAVE child„eturned‡nƒrror");

784 ià((
¦ave
->
»¶dbfd
 = 
	`İ’
(
£rv”
.
rdb_f’ame
,
O_RDONLY
)) == -1 ||

785 
	`»dis_f¡©
(
¦ave
->
»¶dbfd
,&
buf
) == -1) {

786 
	`ä“Cl›Á
(
¦ave
);

787 
	`»disLog
(
REDIS_WARNING
,"SYNC faed. Cª'ˆİ’/¡© DB‡á” BGSAVE: %s", 
	`¡»¼Ü
(
”ºo
));

790 
¦ave
->
»¶dboff
 = 0;

791 
¦ave
->
»¶dbsize
 = 
buf
.
¡_size
;

792 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_SEND_BULK
;

793 
¦ave
->
»¶´—mbË
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"$%lld\r\n",

794 (è
¦ave
->
»¶dbsize
);

796 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
¦ave
->
fd
,
AE_WRITABLE
);

797 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
¦ave
->
fd
, 
AE_WRITABLE
, 
£ndBulkToSÏve
, sÏveè=ğ
AE_ERR
) {

798 
	`ä“Cl›Á
(
¦ave
);

804 ià(
¡¬tbg§ve
) {

805 ià(
	`¡¬tBg§veFÜR•liÿtiÚ
(è!ğ
REDIS_OK
) {

806 
li¡I‹r
 
li
;

808 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

809 
	`»disLog
(
REDIS_WARNING
,"SYNC failed. BGSAVE failed");

810 (
Ê
 = 
	`li¡Next
(&
li
))) {

811 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

813 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
)

814 
	`ä“Cl›Á
(
¦ave
);

818 
	}
}

823 
	$»¶iÿtiÚAbÜtSyncT¿nsãr
() {

824 
	`»disAs£¹
(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
);

826 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
»¶_Œªsãr_s
,
AE_READABLE
);

827 
	`şo£
(
£rv”
.
»¶_Œªsãr_s
);

828 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

829 
	`uÆšk
(
£rv”
.
»¶_Œªsãr_tmpfe
);

830 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

831 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

832 
	}
}

842 
	$»¶iÿtiÚS’dNewlšeToMa¡”
() {

843 
time_t
 
Ãwlše_£Á
;

844 ià(
	`time
(
NULL
è!ğ
Ãwlše_£Á
) {

845 
Ãwlše_£Á
 = 
	`time
(
NULL
);

846 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_s
,"\n",1) == -1) {

850 
	}
}

854 
	$»¶iÿtiÚEm±yDbC®lback
(*
´ivd©a
) {

855 
	`REDIS_NOTUSED
(
´ivd©a
);

856 
	`»¶iÿtiÚS’dNewlšeToMa¡”
();

857 
	}
}

860 
	#REPL_MAX_WRITTEN_BEFORE_FSYNC
 (1024*1024*8è

	)

861 
	$»adSyncBulkPaylßd
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

862 
buf
[4096];

863 
ssize_t
 
Ä—d
, 
»adËn
;

864 
off_t
 
Ëá
;

865 
	`REDIS_NOTUSED
(
–
);

866 
	`REDIS_NOTUSED
(
´ivd©a
);

867 
	`REDIS_NOTUSED
(
mask
);

871 
eofm¬k
[
REDIS_RUN_ID_SIZE
];

872 
Ï¡by‹s
[
REDIS_RUN_ID_SIZE
];

873 
u£m¬k
 = 0;

877 ià(
£rv”
.
»¶_Œªsãr_size
 == -1) {

878 ià(
	`syncR—dLše
(
fd
,
buf
,1024,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

879 
	`»disLog
(
REDIS_WARNING
,

881 
	`¡»¼Ü
(
”ºo
));

882 
”rÜ
;

885 ià(
buf
[0] == '-') {

886 
	`»disLog
(
REDIS_WARNING
,

888 
buf
+1);

889 
”rÜ
;

890 } ià(
buf
[0] == '\0') {

894 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

896 } ià(
buf
[0] != '$') {

897 
	`»disLog
(
REDIS_WARNING
,"Bad…rÙocŞ from MASTER,hfœ¡ by‹ i nÙ '$' (w»ûived '%s'),‡» you su»hho¡‡nd…Üˆ¬right?", 
buf
);

898 
”rÜ
;

911 ià(
	`¡ºcmp
(
buf
+1,"EOF:",4è=ğ0 && 
	`¡¾’
(buf+5è>ğ
REDIS_RUN_ID_SIZE
) {

912 
u£m¬k
 = 1;

913 
	`memıy
(
eofm¬k
,
buf
+5,
REDIS_RUN_ID_SIZE
);

914 
	`mem£t
(
Ï¡by‹s
,0,
REDIS_RUN_ID_SIZE
);

917 
£rv”
.
»¶_Œªsãr_size
 = 0;

918 
	`»disLog
(
REDIS_NOTICE
,

921 
u£m¬k
 = 0;

922 
£rv”
.
»¶_Œªsãr_size
 = 
	`¡¹Ş
(
buf
+1,
NULL
,10);

923 
	`»disLog
(
REDIS_NOTICE
,

925 (è
£rv”
.
»¶_Œªsãr_size
);

931 ià(
u£m¬k
) {

932 
»adËn
 = (
buf
);

934 
Ëá
 = 
£rv”
.
»¶_Œªsãr_size
 - s”v”.
»¶_Œªsãr_»ad
;

935 
»adËn
 = (
Ëá
 < (sigÃd)(
buf
)) ?†eft : (signed)(buf);

938 
Ä—d
 = 
	`»ad
(
fd
,
buf
,
»adËn
);

939 ià(
Ä—d
 <= 0) {

940 
	`»disLog
(
REDIS_WARNING
,"I/Oƒrrorryingo sync with MASTER: %s",

941 (
Ä—d
 =ğ-1è? 
	`¡»¼Ü
(
”ºo
) : "connection†ost");

942 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

945 
£rv”
.
¡©_Ãt_šput_by‹s
 +ğ
Ä—d
;

949 
eof_»ached
 = 0;

951 ià(
u£m¬k
) {

953 ià(
Ä—d
 >ğ
REDIS_RUN_ID_SIZE
) {

954 
	`memıy
(
Ï¡by‹s
,
buf
+
Ä—d
-
REDIS_RUN_ID_SIZE
,REDIS_RUN_ID_SIZE);

956 
»m
 = 
REDIS_RUN_ID_SIZE
-
Ä—d
;

957 
	`memmove
(
Ï¡by‹s
,Ï¡by‹s+
Ä—d
,
»m
);

958 
	`memıy
(
Ï¡by‹s
+
»m
,
buf
,
Ä—d
);

960 ià(
	`memcmp
(
Ï¡by‹s
,
eofm¬k
,
REDIS_RUN_ID_SIZE
è=ğ0è
eof_»ached
 = 1;

963 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

964 ià(
	`wr™e
(
£rv”
.
»¶_Œªsãr_fd
,
buf
,
Ä—d
) !=‚read) {

965 
	`»disLog
(
REDIS_WARNING
,"Wr™”rÜ o¸shÜˆwr™wr™šgØthDB dum°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

966 
”rÜ
;

968 
£rv”
.
»¶_Œªsãr_»ad
 +ğ
Ä—d
;

971 ià(
u£m¬k
 && 
eof_»ached
) {

972 ià(
	`árunÿ‹
(
£rv”
.
»¶_Œªsãr_fd
,

973 
£rv”
.
»¶_Œªsãr_»ad
 - 
REDIS_RUN_ID_SIZE
) == -1)

975 
	`»disLog
(
REDIS_WARNING
,"E¼ÜrunÿtšghRDB f»ûived fromhma¡” fÜ SYNC: %s", 
	`¡»¼Ü
(
”ºo
));

976 
”rÜ
;

983 ià(
£rv”
.
»¶_Œªsãr_»ad
 >=

984 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 + 
REPL_MAX_WRITTEN_BEFORE_FSYNC
)

986 
off_t
 
sync_size
 = 
£rv”
.
»¶_Œªsãr_»ad
 -

987 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
;

988 
	`rdb_fsync_¿nge
(
£rv”
.
»¶_Œªsãr_fd
,

989 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
, 
sync_size
);

990 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 +ğ
sync_size
;

994 ià(!
u£m¬k
) {

995 ià(
£rv”
.
»¶_Œªsãr_»ad
 =ğ£rv”.
»¶_Œªsãr_size
)

996 
eof_»ached
 = 1;

999 ià(
eof_»ached
) {

1000 ià(
	`»Çme
(
£rv”
.
»¶_Œªsãr_tmpfe
,£rv”.
rdb_f’ame
) == -1) {

1001 
	`»disLog
(
REDIS_WARNING
,"FaedryšgØ»Çmth‹m°DB iÁØdump.rdb iÀMASTER <-> SLAVE synchrÚiz©iÚ: %s", 
	`¡»¼Ü
(
”ºo
));

1002 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1005 
	`»disLog
(
REDIS_NOTICE
, "MASTER <-> SLAVE sync: Flushing old data");

1006 
	`sigÇlFlushedDb
(-1);

1007 
	`em±yDb
(
»¶iÿtiÚEm±yDbC®lback
);

1012 
	`«D–‘eFeEv’t
(
£rv”
.
–
,£rv”.
»¶_Œªsãr_s
,
AE_READABLE
);

1013 
	`»disLog
(
REDIS_NOTICE
, "MASTER <-> SLAVE sync: Loading DB in memory");

1014 ià(
	`rdbLßd
(
£rv”
.
rdb_f’ame
è!ğ
REDIS_OK
) {

1015 
	`»disLog
(
REDIS_WARNING
,"Failedryingo†oadhe MASTER synchronization DB from disk");

1016 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1020 
	`zä“
(
£rv”
.
»¶_Œªsãr_tmpfe
);

1021 
	`şo£
(
£rv”
.
»¶_Œªsãr_fd
);

1022 
£rv”
.
ma¡”
 = 
	`ü—‹Cl›Á
(£rv”.
»¶_Œªsãr_s
);

1023 
£rv”
.
ma¡”
->
æags
 |ğ
REDIS_MASTER
;

1024 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

1025 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECTED
;

1026 
£rv”
.
ma¡”
->
»¶off
 = s”v”.
»¶_ma¡”_š™Ÿl_off£t
;

1027 
	`memıy
(
£rv”
.
ma¡”
->
»¶runid
, s”v”.
»¶_ma¡”_runid
,

1028 (
£rv”
.
»¶_ma¡”_runid
));

1031 ià(
£rv”
.
ma¡”
->
»¶off
 == -1)

1032 
£rv”
.
ma¡”
->
æags
 |ğ
REDIS_PRE_PSYNC
;

1033 
	`»disLog
(
REDIS_NOTICE
, "MASTER <-> SLAVE sync: Finished with success");

1037 ià(
£rv”
.
aof_¡©e
 !ğ
REDIS_AOF_OFF
) {

1038 
»Œy
 = 10;

1040 
	`¡İAµ’dOÆy
();

1041 
»Œy
-- && 
	`¡¬tAµ’dOÆy
(è=ğ
REDIS_ERR
) {

1042 
	`»disLog
(
REDIS_WARNING
,"Failedƒnablinghe AOF‡fter successful master synchronization! Trying it‡gain in one second.");

1043 
	`¦“p
(1);

1045 ià(!
»Œy
) {

1046 
	`»disLog
(
REDIS_WARNING
,"FATAL:his slave instance finishedhe synchronization with its master, buthe AOF can't beurned on. Exiting‚ow.");

1047 
	`ex™
(1);

1054 
”rÜ
:

1055 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1057 
	}
}

1065 *
	$£ndSynchrÚousCommªd
(
fd
, ...) {

1066 
va_li¡
 
­
;

1067 
sds
 
cmd
 = 
	`sd£m±y
();

1068 *
¬g
, 
buf
[256];

1072 
	`va_¡¬t
(
­
,
fd
);

1074 
¬g
 = 
	`va_¬g
(
­
, *);

1075 ià(
¬g
 =ğ
NULL
) ;

1077 ià(
	`sd¦’
(
cmd
è!ğ0ècmd = 
	`sdsÿ’
(cmd," ",1);

1078 
cmd
 = 
	`sdsÿt
(cmd,
¬g
);

1080 
cmd
 = 
	`sdsÿ’
(cmd,"\r\n",2);

1083 ià(
	`syncWr™e
(
fd
,
cmd
,
	`sd¦’
(cmd),
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1084 
	`sdsä“
(
cmd
);

1085  
	`sdsÿrštf
(
	`sd£m±y
(),"-Writingo master: %s",

1086 
	`¡»¼Ü
(
”ºo
));

1088 
	`sdsä“
(
cmd
);

1091 ià(
	`syncR—dLše
(
fd
,
buf
,(buf),
£rv”
.
»¶_syncio_timeout
*1000) == -1)

1093  
	`sdsÿrštf
(
	`sd£m±y
(),"-Reading from master: %s",

1094 
	`¡»¼Ü
(
”ºo
));

1096  
	`sd¢ew
(
buf
);

1097 
	}
}

1123 
	#PSYNC_CONTINUE
 0

	)

1124 
	#PSYNC_FULLRESYNC
 1

	)

1125 
	#PSYNC_NOT_SUPPORTED
 2

	)

1126 
	$¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
) {

1127 *
psync_runid
;

1128 
psync_off£t
[32];

1129 
sds
 
»¶y
;

1136 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = -1;

1138 ià(
£rv”
.
ÿched_ma¡”
) {

1139 
psync_runid
 = 
£rv”
.
ÿched_ma¡”
->
»¶runid
;

1140 
	`¢´štf
(
psync_off£t
,Õsync_off£t),"%Îd", 
£rv”
.
ÿched_ma¡”
->
»¶off
+1);

1141 
	`»disLog
(
REDIS_NOTICE
,"Tryšg‡…¬tŸÈ»synchrÚiz©iÚ (»que¡ %s:%s).", 
psync_runid
, 
psync_off£t
);

1143 
	`»disLog
(
REDIS_NOTICE
,"Partial„esynchronization‚ot…ossible (no cached master)");

1144 
psync_runid
 = "?";

1145 
	`memıy
(
psync_off£t
,"-1",3);

1149 
»¶y
 = 
	`£ndSynchrÚousCommªd
(
fd
,"PSYNC",
psync_runid
,
psync_off£t
,
NULL
);

1151 ià(!
	`¡ºcmp
(
»¶y
,"+FULLRESYNC",11)) {

1152 *
runid
 = 
NULL
, *
off£t
 = NULL;

1156 
runid
 = 
	`¡rchr
(
»¶y
,' ');

1157 ià(
runid
) {

1158 
runid
++;

1159 
off£t
 = 
	`¡rchr
(
runid
,' ');

1160 ià(
off£t
) offset++;

1162 ià(!
runid
 || !
off£t
 || (off£t-runid-1è!ğ
REDIS_RUN_ID_SIZE
) {

1163 
	`»disLog
(
REDIS_WARNING
,

1169 
	`mem£t
(
£rv”
.
»¶_ma¡”_runid
,0,
REDIS_RUN_ID_SIZE
+1);

1171 
	`memıy
(
£rv”
.
»¶_ma¡”_runid
, 
runid
, 
off£t
-runid-1);

1172 
£rv”
.
»¶_ma¡”_runid
[
REDIS_RUN_ID_SIZE
] = '\0';

1173 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
 = 
	`¡¹Şl
(
off£t
,
NULL
,10);

1174 
	`»disLog
(
REDIS_NOTICE
,"Full„esync from master: %s:%lld",

1175 
£rv”
.
»¶_ma¡”_runid
,

1176 
£rv”
.
»¶_ma¡”_š™Ÿl_off£t
);

1179 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1180 
	`sdsä“
(
»¶y
);

1181  
PSYNC_FULLRESYNC
;

1184 ià(!
	`¡ºcmp
(
»¶y
,"+CONTINUE",9)) {

1186 
	`»disLog
(
REDIS_NOTICE
,

1188 
	`sdsä“
(
»¶y
);

1189 
	`»¶iÿtiÚResu¼eùCachedMa¡”
(
fd
);

1190  
PSYNC_CONTINUE
;

1197 ià(
	`¡ºcmp
(
»¶y
,"-ERR",4)) {

1199 
	`»disLog
(
REDIS_WARNING
,

1200 "UÃx³ùed„•lyØPSYNC from ma¡”: %s", 
»¶y
);

1202 
	`»disLog
(
REDIS_NOTICE
,

1204 "”rÜ s‹ (»¶y: %s)", 
»¶y
);

1206 
	`sdsä“
(
»¶y
);

1207 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1208  
PSYNC_NOT_SUPPORTED
;

1209 
	}
}

1211 
	$syncW™hMa¡”
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

1212 
tmpfe
[256], *
”r
;

1213 
dfd
, 
maxŒ›s
 = 5;

1214 
sock”r
 = 0, 
psync_»suÉ
;

1215 
sockËn_t
 
”¾’
 = (
sock”r
);

1216 
	`REDIS_NOTUSED
(
–
);

1217 
	`REDIS_NOTUSED
(
´ivd©a
);

1218 
	`REDIS_NOTUSED
(
mask
);

1222 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_NONE
) {

1223 
	`şo£
(
fd
);

1228 ià(
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock”r
, &
”¾’
) == -1)

1229 
sock”r
 = 
”ºo
;

1230 ià(
sock”r
) {

1231 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1232 
	`»disLog
(
REDIS_WARNING
,"Error condition on socket for SYNC: %s",

1233 
	`¡»¼Ü
(
sock”r
));

1234 
”rÜ
;

1241 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTING
) {

1242 
	`»disLog
(
REDIS_NOTICE
,"Non blocking connect for SYNC firedheƒvent.");

1245 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_WRITABLE
);

1246 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_RECEIVE_PONG
;

1249 
	`syncWr™e
(
fd
,"PING\r\n",6,100);

1254 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_RECEIVE_PONG
) {

1255 
buf
[1024];

1259 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
);

1262 
buf
[0] = '\0';

1263 ià(
	`syncR—dLše
(
fd
,
buf
,(buf),

1264 
£rv”
.
»¶_syncio_timeout
*1000) == -1)

1266 
	`»disLog
(
REDIS_WARNING
,

1268 
	`¡»¼Ü
(
”ºo
));

1269 
”rÜ
;

1277 ià(
buf
[0] != '+' &&

1278 
	`¡ºcmp
(
buf
,"-NOAUTH",7) != 0 &&

1279 
	`¡ºcmp
(
buf
,"-ERR operation‚ot…ermitted",28) != 0)

1281 
	`»disLog
(
REDIS_WARNING
,"E¼Ü„•lyØPING from ma¡”: '%s'",
buf
);

1282 
”rÜ
;

1284 
	`»disLog
(
REDIS_NOTICE
,

1290 if(
£rv”
.
ma¡”auth
) {

1291 
”r
 = 
	`£ndSynchrÚousCommªd
(
fd
,"AUTH",
£rv”
.
ma¡”auth
,
NULL
);

1292 ià(
”r
[0] == '-') {

1293 
	`»disLog
(
REDIS_WARNING
,"UÇbËØAUTHØMASTER: %s",
”r
);

1294 
	`sdsä“
(
”r
);

1295 
”rÜ
;

1297 
	`sdsä“
(
”r
);

1303 
sds
 
pÜt
 = 
	`sdsäomlÚglÚg
(
£rv”
.port);

1304 
”r
 = 
	`£ndSynchrÚousCommªd
(
fd
,"REPLCONF","li¡’šg-pÜt",
pÜt
,

1305 
NULL
);

1306 
	`sdsä“
(
pÜt
);

1309 ià(
”r
[0] == '-') {

1310 
	`»disLog
(
REDIS_NOTICE
,"(NÚ cr™iÿlèMa¡” dÛ nÙ und”¡ªd REPLCONF†i¡’šg-pÜt: %s", 
”r
);

1312 
	`sdsä“
(
”r
);

1320 
psync_»suÉ
 = 
	`¦aveTryP¬tŸlResynchrÚiz©iÚ
(
fd
);

1321 ià(
psync_»suÉ
 =ğ
PSYNC_CONTINUE
) {

1322 
	`»disLog
(
REDIS_NOTICE
, "MASTER <-> SLAVE sync: Master‡ccepted‡ Partial Resynchronization.");

1329 ià(
psync_»suÉ
 =ğ
PSYNC_NOT_SUPPORTED
) {

1330 
	`»disLog
(
REDIS_NOTICE
,"Retrying with SYNC...");

1331 ià(
	`syncWr™e
(
fd
,"SYNC\r\n",6,
£rv”
.
»¶_syncio_timeout
*1000) == -1) {

1332 
	`»disLog
(
REDIS_WARNING
,"I/Oƒrror writingo MASTER: %s",

1333 
	`¡»¼Ü
(
”ºo
));

1334 
”rÜ
;

1339 
maxŒ›s
--) {

1340 
	`¢´štf
(
tmpfe
,256,

1341 "‹mp-%d.%ld.rdb",()
£rv”
.
unixtime
,()
	`g‘pid
());

1342 
dfd
 = 
	`İ’
(
tmpfe
,
O_CREAT
|
O_WRONLY
|
O_EXCL
,0644);

1343 ià(
dfd
 != -1) ;

1344 
	`¦“p
(1);

1346 ià(
dfd
 == -1) {

1347 
	`»disLog
(
REDIS_WARNING
,"O³nšgh‹m°fÃeded fÜ MASTER <-> SLAVE synchrÚiz©iÚ: %s",
	`¡»¼Ü
(
”ºo
));

1348 
”rÜ
;

1352 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
, 
AE_READABLE
,
»adSyncBulkPaylßd
,
NULL
)

1353 =ğ
AE_ERR
)

1355 
	`»disLog
(
REDIS_WARNING
,

1357 
	`¡»¼Ü
(
”ºo
),
fd
);

1358 
”rÜ
;

1361 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_TRANSFER
;

1362 
£rv”
.
»¶_Œªsãr_size
 = -1;

1363 
£rv”
.
»¶_Œªsãr_»ad
 = 0;

1364 
£rv”
.
»¶_Œªsãr_Ï¡_fsync_off
 = 0;

1365 
£rv”
.
»¶_Œªsãr_fd
 = 
dfd
;

1366 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1367 
£rv”
.
»¶_Œªsãr_tmpfe
 = 
	`z¡rdup
(
tmpfe
);

1370 
”rÜ
:

1371 
	`şo£
(
fd
);

1372 
£rv”
.
»¶_Œªsãr_s
 = -1;

1373 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

1375 
	}
}

1377 
	$cÚÃùW™hMa¡”
() {

1378 
fd
;

1380 
fd
 = 
	`ª‘TıNÚBlockBšdCÚÃù
(
NULL
,

1381 
£rv”
.
ma¡”ho¡
,£rv”.
ma¡”pÜt
,
REDIS_BIND_ADDR
);

1382 ià(
fd
 == -1) {

1383 
	`»disLog
(
REDIS_WARNING
,"Unableo connecto MASTER: %s",

1384 
	`¡»¼Ü
(
”ºo
));

1385  
REDIS_ERR
;

1388 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
,
syncW™hMa¡”
,
NULL
) ==

1389 
AE_ERR
)

1391 
	`şo£
(
fd
);

1392 
	`»disLog
(
REDIS_WARNING
,"Can't create„eadableƒvent for SYNC");

1393  
REDIS_ERR
;

1396 
£rv”
.
»¶_Œªsãr_Ï¡io
 = s”v”.
unixtime
;

1397 
£rv”
.
»¶_Œªsãr_s
 = 
fd
;

1398 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECTING
;

1399  
REDIS_OK
;

1400 
	}
}

1404 
	$undoCÚÃùW™hMa¡”
() {

1405 
fd
 = 
£rv”
.
»¶_Œªsãr_s
;

1407 
	`»disAs£¹
(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTING
 ||

1408 
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_RECEIVE_PONG
);

1409 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
fd
,
AE_READABLE
|
AE_WRITABLE
);

1410 
	`şo£
(
fd
);

1411 
£rv”
.
»¶_Œªsãr_s
 = -1;

1412 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

1413 
	}
}

1423 
	$ÿnûlR•liÿtiÚHªdshake
() {

1424 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
) {

1425 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1426 } ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTING
 ||

1427 
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_RECEIVE_PONG
)

1429 
	`undoCÚÃùW™hMa¡”
();

1434 
	}
}

1437 
	$»¶iÿtiÚS‘Ma¡”
(*

, 
pÜt
) {

1438 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1439 
£rv”
.
ma¡”ho¡
 = 
	`sd¢ew
(

);

1440 
£rv”
.
ma¡”pÜt
 = 
pÜt
;

1441 ià(
£rv”
.
ma¡”
è
	`ä“Cl›Á
(server.master);

1442 
	`discÚÃùAÎBlockedCl›Ás
();

1443 
	`discÚÃùSÏves
();

1444 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1445 
	`ä“R•liÿtiÚBacklog
();

1446 
	`ÿnûlR•liÿtiÚHªdshake
();

1447 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECT
;

1448 
£rv”
.
ma¡”_»¶_off£t
 = 0;

1449 
£rv”
.
»¶_down_sšû
 = 0;

1450 
	}
}

1453 
	$»¶iÿtiÚUn£tMa¡”
() {

1454 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) ;

1455 
	`sdsä“
(
£rv”
.
ma¡”ho¡
);

1456 
£rv”
.
ma¡”ho¡
 = 
NULL
;

1457 ià(
£rv”
.
ma¡”
) {

1458 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0) {

1463 
£rv”
.
ma¡”_»¶_off£t
 = s”v”.
ma¡”
->
»¶off
;

1464 
	`ä“R•liÿtiÚBacklog
();

1466 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

1468 
	`»¶iÿtiÚDisÿrdCachedMa¡”
();

1469 
	`ÿnûlR•liÿtiÚHªdshake
();

1470 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_NONE
;

1471 
	}
}

1473 
	$¦aveofCommªd
(
»disCl›Á
 *
c
) {

1476 ià(
£rv”
.
şu¡”_’abËd
) {

1477 
	`addR•lyE¼Ü
(
c
,"SLAVEOF‚ot‡llowed in cluster mode.");

1483 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"no") &&

1484 !
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"one")) {

1485 ià(
£rv”
.
ma¡”ho¡
) {

1486 
	`»¶iÿtiÚUn£tMa¡”
();

1487 
	`»disLog
(
REDIS_NOTICE
,"MASTER MODEƒnabled (user„equest)");

1490 
pÜt
;

1492 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
pÜt
, 
NULL
è!ğ
REDIS_OK
))

1496 ià(
£rv”
.
ma¡”ho¡
 && !
	`¡rÿ£cmp
(£rv”.ma¡”ho¡,
c
->
¬gv
[1]->
±r
)

1497 && 
£rv”
.
ma¡”pÜt
 =ğ
pÜt
) {

1498 
	`»disLog
(
REDIS_NOTICE
,"SLAVE OF would„esult into synchronization withhe master we‡re‡lready connected with. No operation…erformed.");

1499 
	`addR•lySds
(
c
,
	`sd¢ew
("+OK Already connectedo specified master\r\n"));

1504 
	`»¶iÿtiÚS‘Ma¡”
(
c
->
¬gv
[1]->
±r
, 
pÜt
);

1505 
	`»disLog
(
REDIS_NOTICE
,"SLAVE OF %s:%dƒnabled (user„equest)",

1506 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1508 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1509 
	}
}

1514 
	$rŞeCommªd
(
»disCl›Á
 *
c
) {

1515 ià(
£rv”
.
ma¡”ho¡
 =ğ
NULL
) {

1516 
li¡I‹r
 
li
;

1517 
li¡Node
 *
Ê
;

1518 *
mbcouÁ
;

1519 
¦aves
 = 0;

1521 
	`addR•lyMuÉiBulkL’
(
c
,3);

1522 
	`addR•lyBulkCBufãr
(
c
,"master",6);

1523 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”_»¶_off£t
);

1524 
mbcouÁ
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

1525 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1526 (
Ê
 = 
	`li¡Next
(&
li
))) {

1527 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1528 

[
REDIS_IP_STR_LEN
];

1530 ià(
	`ª‘P“rToSŒšg
(
¦ave
->
fd
,

,(),
NULL
) == -1) ;

1531 ià(
¦ave
->
»¶¡©e
 !ğ
REDIS_REPL_ONLINE
) ;

1532 
	`addR•lyMuÉiBulkL’
(
c
,3);

1533 
	`addR•lyBulkCSŒšg
(
c
,

);

1534 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
¦ave_li¡’šg_pÜt
);

1535 
	`addR•lyBulkLÚgLÚg
(
c
,
¦ave
->
»¶_ack_off
);

1536 
¦aves
++;

1538 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbcouÁ
,
¦aves
);

1540 *
¦ave¡©e
 = 
NULL
;

1542 
	`addR•lyMuÉiBulkL’
(
c
,5);

1543 
	`addR•lyBulkCBufãr
(
c
,"slave",5);

1544 
	`addR•lyBulkCSŒšg
(
c
,
£rv”
.
ma¡”ho¡
);

1545 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”pÜt
);

1546 
£rv”
.
»¶_¡©e
) {

1547 
REDIS_REPL_NONE
: 
¦ave¡©e
 = "none"; ;

1548 
REDIS_REPL_CONNECT
: 
¦ave¡©e
 = "connect"; ;

1549 
REDIS_REPL_CONNECTING
: 
¦ave¡©e
 = "connecting"; ;

1550 
REDIS_REPL_RECEIVE_PONG
:

1551 
REDIS_REPL_TRANSFER
: 
¦ave¡©e
 = "sync"; ;

1552 
REDIS_REPL_CONNECTED
: 
¦ave¡©e
 = "connected"; ;

1553 : 
¦ave¡©e
 = "unknown"; ;

1555 
	`addR•lyBulkCSŒšg
(
c
,
¦ave¡©e
);

1556 
	`addR•lyLÚgLÚg
(
c
,
£rv”
.
ma¡”
 ? s”v”.ma¡”->
»¶off
 : -1);

1558 
	}
}

1563 
	$»¶iÿtiÚS’dAck
() {

1564 
»disCl›Á
 *
c
 = 
£rv”
.
ma¡”
;

1566 ià(
c
 !ğ
NULL
) {

1567 
c
->
æags
 |ğ
REDIS_MASTER_FORCE_REPLY
;

1568 
	`addR•lyMuÉiBulkL’
(
c
,3);

1569 
	`addR•lyBulkCSŒšg
(
c
,"REPLCONF");

1570 
	`addR•lyBulkCSŒšg
(
c
,"ACK");

1571 
	`addR•lyBulkLÚgLÚg
(
c
,c->
»¶off
);

1572 
c
->
æags
 &ğ~
REDIS_MASTER_FORCE_REPLY
;

1574 
	}
}

1596 
	$»¶iÿtiÚCacheMa¡”
(
»disCl›Á
 *
c
) {

1597 
li¡Node
 *
Ê
;

1599 
	`»disAs£¹
(
£rv”
.
ma¡”
 !ğ
NULL
 && s”v”.
ÿched_ma¡”
 == NULL);

1600 
	`»disLog
(
REDIS_NOTICE
,"Cachinghe disconnected master state.");

1604 
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás
,
c
);

1605 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

1606 
	`li¡D–Node
(
£rv”
.
ş›Ás
,
Ê
);

1610 
£rv”
.
ÿched_ma¡”
 = s”v”.
ma¡”
;

1614 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
);

1615 
	`«D–‘eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_WRITABLE
);

1616 
	`şo£
(
c
->
fd
);

1619 
c
->
fd
 = -1;

1622 ià(
c
->
³”id
) {

1623 
	`sdsä“
(
c
->
³”id
);

1624 
c
->
³”id
 = 
NULL
;

1630 
	`»¶iÿtiÚHªdËMa¡”DiscÚÃùiÚ
();

1631 
	}
}

1635 
	$»¶iÿtiÚDisÿrdCachedMa¡”
() {

1636 ià(
£rv”
.
ÿched_ma¡”
 =ğ
NULL
) ;

1638 
	`»disLog
(
REDIS_NOTICE
,"Discarding…reviously cached master state.");

1639 
£rv”
.
ÿched_ma¡”
->
æags
 &ğ~
REDIS_MASTER
;

1640 
	`ä“Cl›Á
(
£rv”
.
ÿched_ma¡”
);

1641 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1642 
	}
}

1650 
	$»¶iÿtiÚResu¼eùCachedMa¡”
(
Ãwfd
) {

1651 
£rv”
.
ma¡”
 = s”v”.
ÿched_ma¡”
;

1652 
£rv”
.
ÿched_ma¡”
 = 
NULL
;

1653 
£rv”
.
ma¡”
->
fd
 = 
Ãwfd
;

1654 
£rv”
.
ma¡”
->
æags
 &ğ~(
REDIS_CLOSE_AFTER_REPLY
|
REDIS_CLOSE_ASAP
);

1655 
£rv”
.
ma¡”
->
auth’tiÿ‹d
 = 1;

1656 
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
 = s”v”.
unixtime
;

1657 
£rv”
.
»¶_¡©e
 = 
REDIS_REPL_CONNECTED
;

1660 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás
,£rv”.
ma¡”
);

1661 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_READABLE
,

1662 
»adQu”yFromCl›Á
, 
£rv”
.
ma¡”
)) {

1663 
	`»disLog
(
REDIS_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddh»adabË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

1664 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

1669 ià(
£rv”
.
ma¡”
->
buåos
 || 
	`li¡L’gth
(£rv”.ma¡”->
»¶y
)) {

1670 ià(
	`«C»©eFeEv’t
(
£rv”
.
–
, 
Ãwfd
, 
AE_WRITABLE
,

1671 
£ndR•lyToCl›Á
, 
£rv”
.
ma¡”
)) {

1672 
	`»disLog
(
REDIS_WARNING
,"E¼Ü„esu¼eùšghÿched ma¡”, impossibËØaddhwr™abË hªdËr: %s", 
	`¡»¼Ü
(
”ºo
));

1673 
	`ä“Cl›ÁAsync
(
£rv”
.
ma¡”
);

1676 
	}
}

1683 
	$»äeshGoodSÏvesCouÁ
() {

1684 
li¡I‹r
 
li
;

1685 
li¡Node
 *
Ê
;

1686 
good
 = 0;

1688 ià(!
£rv”
.
»¶_mš_¦aves_to_wr™e
 ||

1689 !
£rv”
.
»¶_mš_¦aves_max_Ïg
) ;

1691 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1692 (
Ê
 = 
	`li¡Next
(&
li
))) {

1693 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1694 
time_t
 
Ïg
 = 
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
;

1696 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_ONLINE
 &&

1697 
Ïg
 <ğ
£rv”
.
»¶_mš_¦aves_max_Ïg
è
good
++;

1699 
£rv”
.
»¶_good_¦aves_couÁ
 = 
good
;

1700 
	}
}

1734 
	$»¶iÿtiÚSütCacheIn™
() {

1735 
£rv”
.
»¶_sütÿche_size
 = 10000;

1736 
£rv”
.
»¶_sütÿche_diù
 = 
	`diùC»©e
(&
»¶SütCacheDiùTy³
,
NULL
);

1737 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

1738 
	}
}

1751 
	$»¶iÿtiÚSütCacheFlush
() {

1752 
	`diùEm±y
(
£rv”
.
»¶_sütÿche_diù
,
NULL
);

1753 
	`li¡R–—£
(
£rv”
.
»¶_sütÿche_fifo
);

1754 
£rv”
.
»¶_sütÿche_fifo
 = 
	`li¡C»©e
();

1755 
	}
}

1759 
	$»¶iÿtiÚSütCacheAdd
(
sds
 
sha1
) {

1760 
»tv®
;

1761 
sds
 
key
 = 
	`sdsdup
(
sha1
);

1764 ià(
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
è=ğ£rv”.
»¶_sütÿche_size
)

1766 
li¡Node
 *
Ê
 = 
	`li¡La¡
(
£rv”
.
»¶_sütÿche_fifo
);

1767 
sds
 
Şde¡
 = 
	`li¡NodeV®ue
(
Ê
);

1769 
»tv®
 = 
	`diùD–‘e
(
£rv”
.
»¶_sütÿche_diù
,
Şde¡
);

1770 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

1771 
	`li¡D–Node
(
£rv”
.
»¶_sütÿche_fifo
,
Ê
);

1775 
»tv®
 = 
	`diùAdd
(
£rv”
.
»¶_sütÿche_diù
,
key
,
NULL
);

1776 
	`li¡AddNodeH—d
(
£rv”
.
»¶_sütÿche_fifo
,
key
);

1777 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

1778 
	}
}

1782 
	$»¶iÿtiÚSütCacheExi¡s
(
sds
 
sha1
) {

1783  
	`diùFšd
(
£rv”
.
»¶_sütÿche_diù
,
sha1
è!ğ
NULL
;

1784 
	}
}

1816 
	$»¶iÿtiÚReque¡AckFromSÏves
() {

1817 
£rv”
.
g‘_ack_äom_¦aves
 = 1;

1818 
	}
}

1822 
	$»¶iÿtiÚCouÁAcksByOff£t
(
off£t
) {

1823 
li¡I‹r
 
li
;

1824 
li¡Node
 *
Ê
;

1825 
couÁ
 = 0;

1827 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

1828 (
Ê
 = 
	`li¡Next
(&
li
))) {

1829 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

1831 ià(
¦ave
->
»¶¡©e
 !ğ
REDIS_REPL_ONLINE
) ;

1832 ià(
¦ave
->
»¶_ack_off
 >ğ
off£t
è
couÁ
++;

1834  
couÁ
;

1835 
	}
}

1839 
	$wa™Commªd
(
»disCl›Á
 *
c
) {

1840 
m¡ime_t
 
timeout
;

1841 
num»¶iÿs
, 
ack»¶iÿs
;

1842 
off£t
 = 
c
->
woff
;

1845 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[1],&
num»¶iÿs
,
NULL
è!ğ
REDIS_OK
)

1847 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
timeout
,
UNIT_MILLISECONDS
)

1848 !ğ
REDIS_OK
) ;

1851 
ack»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
woff
);

1852 ià(
ack»¶iÿs
 >ğ
num»¶iÿs
 || 
c
->
æags
 & 
REDIS_MULTI
) {

1853 
	`addR•lyLÚgLÚg
(
c
,
ack»¶iÿs
);

1859 
c
->
bpİ
.
timeout
 =imeout;

1860 
c
->
bpİ
.
»¶off£t
 = 
off£t
;

1861 
c
->
bpİ
.
num»¶iÿs
 =‚umreplicas;

1862 
	`li¡AddNodeTa
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

1863 
	`blockCl›Á
(
c
,
REDIS_BLOCKED_WAIT
);

1867 
	`»¶iÿtiÚReque¡AckFromSÏves
();

1868 
	}
}

1874 
	$unblockCl›ÁWa™šgR•liÿs
(
»disCl›Á
 *
c
) {

1875 
li¡Node
 *
Ê
 = 
	`li¡S—rchKey
(
£rv”
.
ş›Ás_wa™šg_acks
,
c
);

1876 
	`»disAs£¹
(
Ê
 !ğ
NULL
);

1877 
	`li¡D–Node
(
£rv”
.
ş›Ás_wa™šg_acks
,
Ê
);

1878 
	}
}

1882 
	$´oûssCl›ÁsWa™šgR•liÿs
() {

1883 
Ï¡_off£t
 = 0;

1884 
Ï¡_num»¶iÿs
 = 0;

1886 
li¡I‹r
 
li
;

1887 
li¡Node
 *
Ê
;

1889 
	`li¡Rewšd
(
£rv”
.
ş›Ás_wa™šg_acks
,&
li
);

1890 (
Ê
 = 
	`li¡Next
(&
li
))) {

1891 
»disCl›Á
 *
c
 = 
Ê
->
v®ue
;

1897 ià(
Ï¡_off£t
 &&†a¡_off£ˆ> 
c
->
bpİ
.
»¶off£t
 &&

1898 
Ï¡_num»¶iÿs
 > 
c
->
bpİ
.
num»¶iÿs
)

1900 
	`unblockCl›Á
(
c
);

1901 
	`addR•lyLÚgLÚg
(
c
,
Ï¡_num»¶iÿs
);

1903 
num»¶iÿs
 = 
	`»¶iÿtiÚCouÁAcksByOff£t
(
c
->
bpİ
.
»¶off£t
);

1905 ià(
num»¶iÿs
 >ğ
c
->
bpİ
.numreplicas) {

1906 
Ï¡_off£t
 = 
c
->
bpİ
.
»¶off£t
;

1907 
Ï¡_num»¶iÿs
 = 
num»¶iÿs
;

1908 
	`unblockCl›Á
(
c
);

1909 
	`addR•lyLÚgLÚg
(
c
,
num»¶iÿs
);

1913 
	}
}

1917 
	$»¶iÿtiÚG‘SÏveOff£t
() {

1918 
off£t
 = 0;

1920 ià(
£rv”
.
ma¡”ho¡
 !ğ
NULL
) {

1921 ià(
£rv”
.
ma¡”
) {

1922 
off£t
 = 
£rv”
.
ma¡”
->
»¶off
;

1923 } ià(
£rv”
.
ÿched_ma¡”
) {

1924 
off£t
 = 
£rv”
.
ÿched_ma¡”
->
»¶off
;

1931 ià(
off£t
 < 0) offset = 0;

1932  
off£t
;

1933 
	}
}

1938 
	$»¶iÿtiÚCrÚ
() {

1940 ià(
£rv”
.
ma¡”ho¡
 &&

1941 (
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTING
 ||

1942 
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_RECEIVE_PONG
) &&

1943 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

1945 
	`»disLog
(
REDIS_WARNING
,"Timeout connectingohe MASTER...");

1946 
	`undoCÚÃùW™hMa¡”
();

1950 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REDIS_REPL_TRANSFER
 &&

1951 (
	`time
(
NULL
)-
£rv”
.
»¶_Œªsãr_Ï¡io
è> s”v”.
»¶_timeout
)

1953 
	`»disLog
(
REDIS_WARNING
,"Timeout„eceiving bulk data from MASTER... Ifhe…roblem…ersistsryo sethe 'repl-timeout'…arameter in„edis.confo‡†arger value.");

1954 
	`»¶iÿtiÚAbÜtSyncT¿nsãr
();

1958 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECTED
 &&

1959 (
	`time
(
NULL
)-
£rv”
.
ma¡”
->
Ï¡š‹¿ùiÚ
è> s”v”.
»¶_timeout
)

1961 
	`»disLog
(
REDIS_WARNING
,"MASTERimeout:‚o data‚or PING„eceived...");

1962 
	`ä“Cl›Á
(
£rv”
.
ma¡”
);

1966 ià(
£rv”
.
»¶_¡©e
 =ğ
REDIS_REPL_CONNECT
) {

1967 
	`»disLog
(
REDIS_NOTICE
,"Connectingo MASTER %s:%d",

1968 
£rv”
.
ma¡”ho¡
, s”v”.
ma¡”pÜt
);

1969 ià(
	`cÚÃùW™hMa¡”
(è=ğ
REDIS_OK
) {

1970 
	`»disLog
(
REDIS_NOTICE
,"MASTER <-> SLAVE sync started");

1977 ià(
£rv”
.
ma¡”ho¡
 && s”v”.
ma¡”
 &&

1978 !(
£rv”
.
ma¡”
->
æags
 & 
REDIS_PRE_PSYNC
))

1979 
	`»¶iÿtiÚS’dAck
();

1985 ià(!(
£rv”
.
üÚloİs
 % (£rv”.
»¶_pšg_¦ave_³riod
 * s”v”.
hz
))) {

1986 
li¡I‹r
 
li
;

1987 
li¡Node
 *
Ê
;

1988 
robj
 *
pšg_¬gv
[1];

1991 
pšg_¬gv
[0] = 
	`ü—‹SŒšgObjeù
("PING",4);

1992 
	`»¶iÿtiÚF“dSÏves
(
£rv”
.
¦aves
, s”v”.
¦ave£ldb
, 
pšg_¬gv
, 1);

1993 
	`deüRefCouÁ
(
pšg_¬gv
[0]);

1999 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2000 (
Ê
 = 
	`li¡Next
(&
li
))) {

2001 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2003 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
 ||

2004 (
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_END
 &&

2005 
£rv”
.
rdb_chd_ty³
 !ğ
REDIS_RDB_CHILD_TYPE_SOCKET
))

2007 ià(
	`wr™e
(
¦ave
->
fd
, "\n", 1) == -1) {

2015 ià(
	`li¡L’gth
(
£rv”
.
¦aves
)) {

2016 
li¡I‹r
 
li
;

2017 
li¡Node
 *
Ê
;

2019 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2020 (
Ê
 = 
	`li¡Next
(&
li
))) {

2021 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2023 ià(
¦ave
->
»¶¡©e
 !ğ
REDIS_REPL_ONLINE
) ;

2024 ià(
¦ave
->
æags
 & 
REDIS_PRE_PSYNC
) ;

2025 ià((
£rv”
.
unixtime
 - 
¦ave
->
»¶_ack_time
è> s”v”.
»¶_timeout
)

2027 
	`»disLog
(
REDIS_WARNING
, "Disconnectingimedout slave: %s",

2028 
	`»¶iÿtiÚG‘SÏveName
(
¦ave
));

2029 
	`ä“Cl›Á
(
¦ave
);

2036 ià(
	`li¡L’gth
(
£rv”
.
¦aves
è=ğ0 && s”v”.
»¶_backlog_time_lim™
 &&

2037 
£rv”
.
»¶_backlog
)

2039 
time_t
 
idË
 = 
£rv”
.
unixtime
 - s”v”.
»¶_no_¦aves_sšû
;

2041 ià(
idË
 > 
£rv”
.
»¶_backlog_time_lim™
) {

2042 
	`ä“R•liÿtiÚBacklog
();

2043 
	`»disLog
(
REDIS_NOTICE
,

2046 (è
£rv”
.
»¶_backlog_time_lim™
);

2053 ià(
	`li¡L’gth
(
£rv”
.
¦aves
) == 0 &&

2054 
£rv”
.
aof_¡©e
 =ğ
REDIS_AOF_OFF
 &&

2055 
	`li¡L’gth
(
£rv”
.
»¶_sütÿche_fifo
) != 0)

2057 
	`»¶iÿtiÚSütCacheFlush
();

2067 ià(
£rv”
.
rdb_chd_pid
 =ğ-1 && s”v”.
aof_chd_pid
 == -1) {

2068 
time_t
 
idË
, 
max_idË
 = 0;

2069 
¦aves_wa™šg
 = 0;

2070 
li¡Node
 *
Ê
;

2071 
li¡I‹r
 
li
;

2073 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2074 (
Ê
 = 
	`li¡Next
(&
li
))) {

2075 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2076 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
) {

2077 
idË
 = 
£rv”
.
unixtime
 - 
¦ave
->
Ï¡š‹¿ùiÚ
;

2078 ià(
idË
 > 
max_idË
) max_idle = idle;

2079 
¦aves_wa™šg
++;

2083 ià(
¦aves_wa™šg
 && 
max_idË
 > 
£rv”
.
»¶_diskËss_sync_d–ay
) {

2086 ià(
	`¡¬tBg§veFÜR•liÿtiÚ
(è=ğ
REDIS_OK
) {

2092 
	`li¡Rewšd
(
£rv”
.
¦aves
,&
li
);

2093 (
Ê
 = 
	`li¡Next
(&
li
))) {

2094 
»disCl›Á
 *
¦ave
 = 
Ê
->
v®ue
;

2095 ià(
¦ave
->
»¶¡©e
 =ğ
REDIS_REPL_WAIT_BGSAVE_START
)

2096 
¦ave
->
»¶¡©e
 = 
REDIS_REPL_WAIT_BGSAVE_END
;

2103 
	`»äeshGoodSÏvesCouÁ
();

2104 
	}
}

	@rio.c

48 
	~"fmaüos.h
"

49 
	~<¡ršg.h
>

50 
	~<¡dio.h
>

51 
	~<uni¡d.h
>

52 
	~"rio.h
"

53 
	~"ut.h
"

54 
	~"üc64.h
"

55 
	~"cÚfig.h
"

56 
	~"»dis.h
"

61 
size_t
 
	$rioBufãrWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

62 
r
->
io
.
bufãr
.
±r
 = 
	`sdsÿ’
Ô->io.bufãr.±r,(*)
buf
,
Ën
);

63 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

65 
	}
}

68 
size_t
 
	$rioBufãrR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

69 ià(
	`sd¦’
(
r
->
io
.
bufãr
.
±r
)-r->io.bufãr.
pos
 < 
Ën
)

71 
	`memıy
(
buf
,
r
->
io
.
bufãr
.
±r
+r->io.bufãr.
pos
,
Ën
);

72 
r
->
io
.
bufãr
.
pos
 +ğ
Ën
;

74 
	}
}

77 
off_t
 
	$rioBufãrT–l
(
rio
 *
r
) {

78  
r
->
io
.
bufãr
.
pos
;

79 
	}
}

83 
	$rioBufãrFlush
(
rio
 *
r
) {

84 
	`REDIS_NOTUSED
(
r
);

86 
	}
}

88 cÚ¡ 
rio
 
	grioBufãrIO
 = {

89 
rioBufãrR—d
,

90 
rioBufãrWr™e
,

91 
rioBufãrT–l
,

92 
rioBufãrFlush
,

93 
NULL
,

97 { { 
NULL
, 0 } }

100 
	$rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
) {

101 *
r
 = 
rioBufãrIO
;

102 
r
->
io
.
bufãr
.
±r
 = 
s
;

103 
r
->
io
.
bufãr
.
pos
 = 0;

104 
	}
}

109 
size_t
 
	$rioFeWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

110 
size_t
 
»tv®
;

112 
»tv®
 = 
	`fwr™e
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

113 
r
->
io
.
fe
.
bufã»d
 +ğ
Ën
;

115 ià(
r
->
io
.
fe
.
autosync
 &&

116 
r
->
io
.
fe
.
bufã»d
 >ğr->io.fe.
autosync
)

118 
	`fæush
(
r
->
io
.
fe
.
å
);

119 
	`aof_fsync
(
	`f’o
(
r
->
io
.
fe
.
å
));

120 
r
->
io
.
fe
.
bufã»d
 = 0;

122  
»tv®
;

123 
	}
}

126 
size_t
 
	$rioFeR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

127  
	`ä—d
(
buf
,
Ën
,1,
r
->
io
.
fe
.
å
);

128 
	}
}

131 
off_t
 
	$rioFeT–l
(
rio
 *
r
) {

132  
	`á–lo
(
r
->
io
.
fe
.
å
);

133 
	}
}

137 
	$rioFeFlush
(
rio
 *
r
) {

138  (
	`fæush
(
r
->
io
.
fe
.
å
) == 0) ? 1 : 0;

139 
	}
}

141 cÚ¡ 
rio
 
	grioFeIO
 = {

142 
rioFeR—d
,

143 
rioFeWr™e
,

144 
rioFeT–l
,

145 
rioFeFlush
,

146 
NULL
,

150 { { 
NULL
, 0 } }

153 
	$rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
) {

154 *
r
 = 
rioFeIO
;

155 
r
->
io
.
fe
.
å
 = fp;

156 
r
->
io
.
fe
.
bufã»d
 = 0;

157 
r
->
io
.
fe
.
autosync
 = 0;

158 
	}
}

169 
size_t
 
	$rioFd£tWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

170 
ssize_t
 
»tv®
;

171 
j
;

172 *
p
 = (*è
buf
;

173 
doæush
 = (
buf
 =ğ
NULL
 && 
Ën
 == 0);

177 ià(
Ën
) {

178 
r
->
io
.
fd£t
.
buf
 = 
	`sdsÿ’
Ô->io.fd£t.buf,buf,
Ën
);

179 
Ën
 = 0;

180 ià(
	`sd¦’
(
r
->
io
.
fd£t
.
buf
è> 
REDIS_IOBUF_LEN
è
doæush
 = 1;

183 ià(
doæush
) {

184 
p
 = (*è
r
->
io
.
fd£t
.
buf
;

185 
Ën
 = 
	`sd¦’
(
r
->
io
.
fd£t
.
buf
);

191 
Ën
) {

192 
size_t
 
couÁ
 = 
Ën
 < 1024 ?†en : 1024;

193 
brok’
 = 0;

194 
j
 = 0; j < 
r
->
io
.
fd£t
.
numfds
; j++) {

195 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] != 0) {

197 
brok’
++;

203 
size_t
 
nwr™‹n
 = 0;

204 
nwr™‹n
 !ğ
couÁ
) {

205 
»tv®
 = 
	`wr™e
(
r
->
io
.
fd£t
.
fds
[
j
],
p
+
nwr™‹n
,
couÁ
-nwritten);

206 ià(
»tv®
 <= 0) {

211 ià(
»tv®
 =ğ-1 && 
”ºo
 =ğ
EWOULDBLOCK
è”ºØğ
ETIMEDOUT
;

214 
nwr™‹n
 +ğ
»tv®
;

217 ià(
nwr™‹n
 !ğ
couÁ
) {

219 
r
->
io
.
fd£t
.
¡©e
[
j
] = 
”ºo
;

220 ià(
r
->
io
.
fd£t
.
¡©e
[
j
] =ğ0èr->io.fd£t.¡©e[j] = 
EIO
;

223 ià(
brok’
 =ğ
r
->
io
.
fd£t
.
numfds
)  0;

224 
p
 +ğ
couÁ
;

225 
Ën
 -ğ
couÁ
;

226 
r
->
io
.
fd£t
.
pos
 +ğ
couÁ
;

229 ià(
doæush
è
	`sdsş—r
(
r
->
io
.
fd£t
.
buf
);

231 
	}
}

234 
size_t
 
	$rioFd£tR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

235 
	`REDIS_NOTUSED
(
r
);

236 
	`REDIS_NOTUSED
(
buf
);

237 
	`REDIS_NOTUSED
(
Ën
);

239 
	}
}

242 
off_t
 
	$rioFd£tT–l
(
rio
 *
r
) {

243  
r
->
io
.
fd£t
.
pos
;

244 
	}
}

248 
	$rioFd£tFlush
(
rio
 *
r
) {

251  
	`rioFd£tWr™e
(
r
,
NULL
,0);

252 
	}
}

254 cÚ¡ 
rio
 
	grioFd£tIO
 = {

255 
rioFd£tR—d
,

256 
rioFd£tWr™e
,

257 
rioFd£tT–l
,

258 
rioFd£tFlush
,

259 
NULL
,

263 { { 
NULL
, 0 } }

266 
	$rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
) {

267 
j
;

269 *
r
 = 
rioFd£tIO
;

270 
r
->
io
.
fd£t
.
fds
 = 
	`zm®loc
(()*
numfds
);

271 
r
->
io
.
fd£t
.
¡©e
 = 
	`zm®loc
(()*
numfds
);

272 
	`memıy
(
r
->
io
.
fd£t
.
fds
,fds,()*
numfds
);

273 
j
 = 0; j < 
numfds
; j++è
r
->
io
.
fd£t
.
¡©e
[j] = 0;

274 
r
->
io
.
fd£t
.
numfds
 =‚umfds;

275 
r
->
io
.
fd£t
.
pos
 = 0;

276 
r
->
io
.
fd£t
.
buf
 = 
	`sd£m±y
();

277 
	}
}

279 
	$rioF»eFd£t
(
rio
 *
r
) {

280 
	`zä“
(
r
->
io
.
fd£t
.
fds
);

281 
	`zä“
(
r
->
io
.
fd£t
.
¡©e
);

282 
	`sdsä“
(
r
->
io
.
fd£t
.
buf
);

283 
	}
}

289 
	$rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

290 
r
->
cksum
 = 
	`üc64
Ô->cksum,
buf
,
Ën
);

291 
	}
}

301 
	$rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
) {

302 
	`»disAs£¹
(
r
->
»ad
 =ğ
rioFeIO
.read);

303 
r
->
io
.
fe
.
autosync
 = 
by‹s
;

304 
	}
}

312 
size_t
 
	$rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
) {

313 
cbuf
[128];

314 
ş’
;

316 
cbuf
[0] = 
´efix
;

317 
ş’
 = 1+
	`Î2¡ršg
(
cbuf
+1,(cbuf)-1,
couÁ
);

318 
cbuf
[
ş’
++] = '\r';

319 
cbuf
[
ş’
++] = '\n';

320 ià(
	`rioWr™e
(
r
,
cbuf
,
ş’
) == 0)  0;

321  
ş’
;

322 
	}
}

325 
size_t
 
	$rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

326 
size_t
 
nwr™‹n
;

328 ià((
nwr™‹n
 = 
	`rioWr™eBulkCouÁ
(
r
,'$',
Ën
)) == 0)  0;

329 ià(
Ën
 > 0 && 
	`rioWr™e
(
r
,
buf
,len) == 0)  0;

330 ià(
	`rioWr™e
(
r
,"\r\n",2) == 0)  0;

331  
nwr™‹n
+
Ën
+2;

332 
	}
}

335 
size_t
 
	$rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
) {

336 
lbuf
[32];

337 
Î’
;

339 
Î’
 = 
	`Î2¡ršg
(
lbuf
,Öbuf),
l
);

340  
	`rioWr™eBulkSŒšg
(
r
,
lbuf
,
Î’
);

341 
	}
}

344 
size_t
 
	$rioWr™eBulkDoubË
(
rio
 *
r
, 
d
) {

345 
dbuf
[128];

346 
dËn
;

348 
dËn
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",
d
);

349  
	`rioWr™eBulkSŒšg
(
r
,
dbuf
,
dËn
);

350 
	}
}

	@rio.h

32 #iâdeà
__REDIS_RIO_H


33 
	#__REDIS_RIO_H


	)

35 
	~<¡dio.h
>

36 
	~<¡dšt.h
>

37 
	~"sds.h
"

39 
	s_rio
 {

43 
size_t
 (*
»ad
)(
	m_rio
 *, *
	mbuf
, size_ˆ
	mËn
);

44 
size_t
 (*
wr™e
)(
	m_rio
 *, cÚ¡ *
	mbuf
, size_ˆ
	mËn
);

45 
off_t
 (*
‹Î
)(
	m_rio
 *);

46 (*
	mæush
)(
	m_rio
 *);

52 (*
	mupd©e_cksum
)(
	m_rio
 *, cÚ¡ *
	mbuf
, 
size_t
 
	mËn
);

55 
ušt64_t
 
	mcksum
;

58 
size_t
 
	m´oûs£d_by‹s
;

61 
size_t
 
	mmax_´oûssšg_chunk
;

67 
sds
 
	m±r
;

68 
off_t
 
	mpos
;

69 } 
	mbufãr
;

72 
FILE
 *
	må
;

73 
off_t
 
	mbufã»d
;

74 
off_t
 
	mautosync
;

75 } 
	mfe
;

78 *
	mfds
;

79 *
	m¡©e
;

80 
	mnumfds
;

81 
off_t
 
	mpos
;

82 
sds
 
	mbuf
;

83 } 
	mfd£t
;

84 } 
	mio
;

87 
_rio
 
	trio
;

93 
šlše
 
size_t
 
	$rioWr™e
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

94 
Ën
) {

95 
size_t
 
by‹s_to_wr™e
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

96 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_wr™e
);

97 ià(
r
->
	`wr™e
Ô,
buf
,
by‹s_to_wr™e
) == 0)

99 
buf
 = (*)buà+ 
by‹s_to_wr™e
;

100 
Ën
 -ğ
by‹s_to_wr™e
;

101 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_wr™e
;

104 
	}
}

106 
šlše
 
size_t
 
	$rioR—d
(
rio
 *
r
, *
buf
, 
size_t
 
Ën
) {

107 
Ën
) {

108 
size_t
 
by‹s_to_»ad
 = (
r
->
max_´oûssšg_chunk
 &&„->max_´oûssšg_chunk < 
Ën
) ?„->max_processing_chunk :†en;

109 ià(
r
->
	`»ad
Ô,
buf
,
by‹s_to_»ad
) == 0)

111 ià(
r
->
upd©e_cksum
èr->
	`upd©e_cksum
Ô,
buf
,
by‹s_to_»ad
);

112 
buf
 = (*)buà+ 
by‹s_to_»ad
;

113 
Ën
 -ğ
by‹s_to_»ad
;

114 
r
->
´oûs£d_by‹s
 +ğ
by‹s_to_»ad
;

117 
	}
}

119 
šlše
 
off_t
 
	$rioT–l
(
rio
 *
r
) {

120  
r
->
	`‹Î
(r);

121 
	}
}

123 
šlše
 
	$rioFlush
(
rio
 *
r
) {

124  
r
->
	`æush
(r);

125 
	}
}

127 
rioIn™W™hFe
(
rio
 *
r
, 
FILE
 *
å
);

128 
rioIn™W™hBufãr
(
rio
 *
r
, 
sds
 
s
);

129 
rioIn™W™hFd£t
(
rio
 *
r
, *
fds
, 
numfds
);

131 
size_t
 
rioWr™eBulkCouÁ
(
rio
 *
r
, 
´efix
, 
couÁ
);

132 
size_t
 
rioWr™eBulkSŒšg
(
rio
 *
r
, cÚ¡ *
buf
, size_ˆ
Ën
);

133 
size_t
 
rioWr™eBulkLÚgLÚg
(
rio
 *
r
, 
l
);

134 
size_t
 
rioWr™eBulkDoubË
(
rio
 *
r
, 
d
);

136 
rioG’”icUpd©eChecksum
(
rio
 *
r
, cÚ¡ *
buf
, 
size_t
 
Ën
);

137 
rioS‘AutoSync
(
rio
 *
r
, 
off_t
 
by‹s
);

	@scripting.c

30 
	~"»dis.h
"

31 
	~"sha1.h
"

32 
	~"¿nd.h
"

33 
	~"şu¡”.h
"

35 
	~<lua.h
>

36 
	~<Ïuxlib.h
>

37 
	~<lu®ib.h
>

38 
	~<ùy³.h
>

39 
	~<m©h.h
>

41 *
»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
);

42 *
»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
);

43 *
»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
);

44 *
»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
);

45 *
»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
);

46 
»dis_m©h_¿ndom
 (
lua_S‹
 *
L
);

47 
»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
);

48 
sha1hex
(*
dige¡
, *
süt
, 
size_t
 
Ën
);

69 *
	$»disPrÙocŞToLuaTy³
(
lua_S‹
 *
lua
, * 
»¶y
) {

70 *
p
 = 
»¶y
;

72 *
p
) {

74 
p
 = 
	`»disPrÙocŞToLuaTy³_IÁ
(
lua
,
»¶y
);

77 
p
 = 
	`»disPrÙocŞToLuaTy³_Bulk
(
lua
,
»¶y
);

80 
p
 = 
	`»disPrÙocŞToLuaTy³_Stus
(
lua
,
»¶y
);

83 
p
 = 
	`»disPrÙocŞToLuaTy³_E¼Ü
(
lua
,
»¶y
);

86 
p
 = 
	`»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua
,
»¶y
);

89  
p
;

90 
	}
}

92 *
	$»disPrÙocŞToLuaTy³_IÁ
(
lua_S‹
 *
lua
, *
»¶y
) {

93 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

94 
v®ue
;

96 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
v®ue
);

97 
	`lua_pushnumb”
(
lua
,(
lua_Numb”
)
v®ue
);

98  
p
+2;

99 
	}
}

101 *
	$»disPrÙocŞToLuaTy³_Bulk
(
lua_S‹
 *
lua
, *
»¶y
) {

102 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

103 
bulkËn
;

105 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
bulkËn
);

106 ià(
bulkËn
 == -1) {

107 
	`lua_pushboŞ—n
(
lua
,0);

108  
p
+2;

110 
	`lua_pushl¡ršg
(
lua
,
p
+2,
bulkËn
);

111  
p
+2+
bulkËn
+2;

113 
	}
}

115 *
	$»disPrÙocŞToLuaTy³_Stus
(
lua_S‹
 *
lua
, *
»¶y
) {

116 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

118 
	`lua_ÃwbË
(
lua
);

119 
	`lua_push¡ršg
(
lua
,"ok");

120 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

121 
	`lua_£‰abË
(
lua
,-3);

122  
p
+2;

123 
	}
}

125 *
	$»disPrÙocŞToLuaTy³_E¼Ü
(
lua_S‹
 *
lua
, *
»¶y
) {

126 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

128 
	`lua_ÃwbË
(
lua
);

129 
	`lua_push¡ršg
(
lua
,"err");

130 
	`lua_pushl¡ršg
(
lua
,
»¶y
+1,
p
-reply-1);

131 
	`lua_£‰abË
(
lua
,-3);

132  
p
+2;

133 
	}
}

135 *
	$»disPrÙocŞToLuaTy³_MuÉiBulk
(
lua_S‹
 *
lua
, *
»¶y
) {

136 *
p
 = 
	`¡rchr
(
»¶y
+1,'\r');

137 
mbulkËn
;

138 
j
 = 0;

140 
	`¡ršg2Î
(
»¶y
+1,
p
-»¶y-1,&
mbulkËn
);

141 
p
 += 2;

142 ià(
mbulkËn
 == -1) {

143 
	`lua_pushboŞ—n
(
lua
,0);

144  
p
;

146 
	`lua_ÃwbË
(
lua
);

147 
j
 = 0; j < 
mbulkËn
; j++) {

148 
	`lua_pushnumb”
(
lua
,
j
+1);

149 
p
 = 
	`»disPrÙocŞToLuaTy³
(
lua
,p);

150 
	`lua_£‰abË
(
lua
,-3);

152  
p
;

153 
	}
}

155 
	$luaPushE¼Ü
(
lua_S‹
 *
lua
, *
”rÜ
) {

156 
lua_Debug
 
dbg
;

158 
	`lua_ÃwbË
(
lua
);

159 
	`lua_push¡ršg
(
lua
,"err");

162 if(
	`lua_g‘¡ack
(
lua
, 1, &
dbg
è&& 
	`lua_g‘šfo
(lua, "nSl", &dbg)) {

163 
sds
 
msg
 = 
	`sdsÿrštf
(
	`sd£m±y
(), "%s: %d: %s",

164 
dbg
.
sourû
, dbg.
cu¼’še
, 
”rÜ
);

165 
	`lua_push¡ršg
(
lua
, 
msg
);

166 
	`sdsä“
(
msg
);

168 
	`lua_push¡ršg
(
lua
, 
”rÜ
);

170 
	`lua_£‰abË
(
lua
,-3);

171 
	}
}

179 
	$luaSÜtA¼ay
(
lua_S‹
 *
lua
) {

181 
	`lua_g‘glob®
(
lua
,"table");

182 
	`lua_push¡ršg
(
lua
,"sort");

183 
	`lua_g‘bË
(
lua
,-2);

184 
	`lua_pushv®ue
(
lua
,-3);

185 ià(
	`lua_pÿÎ
(
lua
,1,0,0)) {

192 
	`lua_pİ
(
lua
,1);

193 
	`lua_push¡ršg
(
lua
,"sort");

194 
	`lua_g‘bË
(
lua
,-2);

195 
	`lua_pushv®ue
(
lua
,-3);

196 
	`lua_g‘glob®
(
lua
,"__redis__compare_helper");

198 
	`lua_ÿÎ
(
lua
,2,0);

201 
	`lua_pİ
(
lua
,1);

202 
	}
}

204 
	#LUA_CMD_OBJCACHE_SIZE
 32

	)

205 
	#LUA_CMD_OBJCACHE_MAX_LEN
 64

	)

206 
	$luaRedisG’”icCommªd
(
lua_S‹
 *
lua
, 
¿i£_”rÜ
) {

207 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

208 
»disCommªd
 *
cmd
;

209 
»disCl›Á
 *
c
 = 
£rv”
.
lua_ş›Á
;

210 
sds
 
»¶y
;

213 
robj
 **
¬gv
 = 
NULL
;

214 
¬gv_size
 = 0;

215 
robj
 *
ÿched_objeùs
[
LUA_CMD_OBJCACHE_SIZE
];

216 
size_t
 
ÿched_objeùs_Ën
[
LUA_CMD_OBJCACHE_SIZE
];

217 
šu£
 = 0;

223 ià(
šu£
) {

224 *
»cursiÚ_w¬nšg
 =

227 
	`»disLog
(
REDIS_WARNING
,"%s",
»cursiÚ_w¬nšg
);

228 
	`luaPushE¼Ü
(
lua
,
»cursiÚ_w¬nšg
);

231 
šu£
++;

234 ià(
¬gc
 == 0) {

235 
	`luaPushE¼Ü
(
lua
,

237 
šu£
--;

242 ià(
¬gv_size
 < 
¬gc
) {

243 
¬gv
 = 
	`z»®loc
×rgv,(
robj
*)*
¬gc
);

244 
¬gv_size
 = 
¬gc
;

247 
j
 = 0; j < 
¬gc
; j++) {

248 *
obj_s
;

249 
size_t
 
obj_Ën
;

250 
dbuf
[64];

252 ià(
	`lua_ty³
(
lua
,
j
+1è=ğ
LUA_TNUMBER
) {

255 
lua_Numb”
 
num
 = 
	`lua_tÚumb”
(
lua
,
j
+1);

257 
obj_Ën
 = 
	`¢´štf
(
dbuf
,(dbuf),"%.17g",()
num
);

258 
obj_s
 = 
dbuf
;

260 
obj_s
 = (*)
	`lua_tŞ¡ršg
(
lua
,
j
+1,&
obj_Ën
);

261 ià(
obj_s
 =ğ
NULL
) ;

265 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 && 
ÿched_objeùs
[j] &&

266 
ÿched_objeùs_Ën
[
j
] >ğ
obj_Ën
)

268 *
s
 = 
ÿched_objeùs
[
j
]->
±r
;

269 
sdshdr
 *
sh
 = (*)(
s
-((sdshdr)));

271 
¬gv
[
j
] = 
ÿched_objeùs
[j];

272 
ÿched_objeùs
[
j
] = 
NULL
;

273 
	`memıy
(
s
,
obj_s
,
obj_Ën
+1);

274 
sh
->
ä“
 +ğsh->
Ën
 - 
obj_Ën
;

275 
sh
->
Ën
 = 
obj_Ën
;

277 
¬gv
[
j
] = 
	`ü—‹SŒšgObjeù
(
obj_s
, 
obj_Ën
);

284 ià(
j
 !ğ
¬gc
) {

285 
j
--;

286 
j
 >= 0) {

287 
	`deüRefCouÁ
(
¬gv
[
j
]);

288 
j
--;

290 
	`luaPushE¼Ü
(
lua
,

292 
šu£
--;

297 
c
->
¬gv
 =‡rgv;

298 
c
->
¬gc
 =‡rgc;

301 
cmd
 = 
	`lookupCommªd
(
¬gv
[0]->
±r
);

302 ià(!
cmd
 || ((cmd->
¬™y
 > 0 && cmd->¬™y !ğ
¬gc
) ||

303 (
¬gc
 < -
cmd
->
¬™y
)))

305 ià(
cmd
)

306 
	`luaPushE¼Ü
(
lua
,

309 
	`luaPushE¼Ü
(
lua
,"Unknown Redis command called from Lua script");

310 
ş—nup
;

312 
c
->
cmd
 = cmd;

315 ià(
cmd
->
æags
 & 
REDIS_CMD_NOSCRIPT
) {

316 
	`luaPushE¼Ü
(
lua
, "This Redis command is‚ot‡llowed from scripts");

317 
ş—nup
;

323 ià(
cmd
->
æags
 & 
REDIS_CMD_WRITE
) {

324 ià(
£rv”
.
lua_¿ndom_dœty
) {

325 
	`luaPushE¼Ü
(
lua
,

327 
ş—nup
;

328 } ià(
£rv”
.
ma¡”ho¡
 && s”v”.
»¶_¦ave_ro
 &&

329 !
£rv”
.
lßdšg
 &&

330 !(
£rv”
.
lua_ÿÎ”
->
æags
 & 
REDIS_MASTER
))

332 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
ro¦av“¼
->
±r
);

333 
ş—nup
;

334 } ià(
£rv”
.
¡İ_wr™es_Ú_bg§ve_”r
 &&

335 
£rv”
.
§v•¬am¦’
 > 0 &&

336 
£rv”
.
Ï¡bg§ve_¡©us
 =ğ
REDIS_ERR
)

338 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
bg§v“¼
->
±r
);

339 
ş—nup
;

347 ià(
£rv”
.
maxmemÜy
 && s”v”.
lua_wr™e_dœty
 == 0 &&

348 (
cmd
->
æags
 & 
REDIS_CMD_DENYOOM
))

350 ià(
	`ä“MemÜyIfN“ded
(è=ğ
REDIS_ERR
) {

351 
	`luaPushE¼Ü
(
lua
, 
sh¬ed
.
oom”r
->
±r
);

352 
ş—nup
;

356 ià(
cmd
->
æags
 & 
REDIS_CMD_RANDOM
è
£rv”
.
lua_¿ndom_dœty
 = 1;

357 ià(
cmd
->
æags
 & 
REDIS_CMD_WRITE
è
£rv”
.
lua_wr™e_dœty
 = 1;

362 ià(
£rv”
.
şu¡”_’abËd
 && !(£rv”.
lua_ÿÎ”
->
æags
 & 
REDIS_MASTER
)) {

364 
c
->
æags
 &ğ~(
REDIS_READONLY
|
REDIS_ASKING
);

365 
c
->
æags
 |ğ
£rv”
.
lua_ÿÎ”
->æag & (
REDIS_READONLY
|
REDIS_ASKING
);

366 ià(
	`g‘NodeByQu”y
(
c
,c->
cmd
,c->
¬gv
,c->
¬gc
,
NULL
,NULL) !=

367 
£rv”
.
şu¡”
->
my£lf
)

369 
	`luaPushE¼Ü
(
lua
,

372 
ş—nup
;

377 
	`ÿÎ
(
c
,
REDIS_CALL_SLOWLOG
 | 
REDIS_CALL_STATS
);

382 ià(
	`li¡L’gth
(
c
->
»¶y
è=ğ0 && c->
buåos
 < 
REDIS_REPLY_CHUNK_BYTES
) {

386 
c
->
buf
[c->
buåos
] = '\0';

387 
»¶y
 = 
c
->
buf
;

388 
c
->
buåos
 = 0;

390 
»¶y
 = 
	`sd¢ewËn
(
c
->
buf
,c->
buåos
);

391 
c
->
buåos
 = 0;

392 
	`li¡L’gth
(
c
->
»¶y
)) {

393 
robj
 *
o
 = 
	`li¡NodeV®ue
(
	`li¡Fœ¡
(
c
->
»¶y
));

395 
»¶y
 = 
	`sdsÿ’
Ô•ly,
o
->
±r
,
	`sd¦’
(o->ptr));

396 
	`li¡D–Node
(
c
->
»¶y
,
	`li¡Fœ¡
(c->reply));

399 ià(
¿i£_”rÜ
 && 
»¶y
[0] != '-')„aise_error = 0;

400 
	`»disPrÙocŞToLuaTy³
(
lua
,
»¶y
);

403 ià((
cmd
->
æags
 & 
REDIS_CMD_SORT_FOR_SCRIPT
) &&

404 (
»¶y
[0] == '*' &&„eply[1] != '-')) {

405 
	`luaSÜtA¼ay
(
lua
);

407 ià(
»¶y
 !ğ
c
->
buf
è
	`sdsä“
(reply);

408 
c
->
»¶y_by‹s
 = 0;

410 
ş—nup
:

413 
j
 = 0; j < 
c
->
¬gc
; j++) {

414 
robj
 *
o
 = 
c
->
¬gv
[
j
];

419 ià(
j
 < 
LUA_CMD_OBJCACHE_SIZE
 &&

420 
o
->
»fcouÁ
 == 1 &&

421 (
o
->
’codšg
 =ğ
REDIS_ENCODING_RAW
 ||

422 
o
->
’codšg
 =ğ
REDIS_ENCODING_EMBSTR
) &&

423 
	`sd¦’
(
o
->
±r
è<ğ
LUA_CMD_OBJCACHE_MAX_LEN
)

425 
sdshdr
 *
sh
 = (*)(((*)(
o
->
±r
))-((sdshdr)));

427 ià(
ÿched_objeùs
[
j
]è
	`deüRefCouÁ
(cached_objects[j]);

428 
ÿched_objeùs
[
j
] = 
o
;

429 
ÿched_objeùs_Ën
[
j
] = 
sh
->
ä“
 + sh->
Ën
;

431 
	`deüRefCouÁ
(
o
);

435 ià(
c
->
¬gv
 !=‡rgv) {

436 
	`zä“
(
c
->
¬gv
);

437 
¬gv
 = 
NULL
;

438 
¬gv_size
 = 0;

441 ià(
¿i£_”rÜ
) {

445 
	`lua_push¡ršg
(
lua
,"err");

446 
	`lua_g‘bË
(
lua
,-2);

447 
šu£
--;

448  
	`lua_”rÜ
(
lua
);

450 
šu£
--;

452 
	}
}

454 
	$luaRedisC®lCommªd
(
lua_S‹
 *
lua
) {

455  
	`luaRedisG’”icCommªd
(
lua
,1);

456 
	}
}

458 
	$luaRedisPC®lCommªd
(
lua_S‹
 *
lua
) {

459  
	`luaRedisG’”icCommªd
(
lua
,0);

460 
	}
}

464 
	$luaRedisSha1hexCommªd
(
lua_S‹
 *
lua
) {

465 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

466 
dige¡
[41];

467 
size_t
 
Ën
;

468 *
s
;

470 ià(
¬gc
 != 1) {

471 
	`luaPushE¼Ü
(
lua
, "wrong‚umber of‡rguments");

475 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,1,&
Ën
);

476 
	`sha1hex
(
dige¡
,
s
,
Ën
);

477 
	`lua_push¡ršg
(
lua
,
dige¡
);

479 
	}
}

488 
	$luaRedisR‘uºSšgËF›ldTabË
(
lua_S‹
 *
lua
, *
f›ld
) {

489 ià(
	`lua_g‘tİ
(
lua
è!ğ1 || 
	`lua_ty³
Öua,-1è!ğ
LUA_TSTRING
) {

490 
	`luaPushE¼Ü
(
lua
, "wrong‚umber orype of‡rguments");

494 
	`lua_ÃwbË
(
lua
);

495 
	`lua_push¡ršg
(
lua
, 
f›ld
);

496 
	`lua_pushv®ue
(
lua
, -3);

497 
	`lua_£‰abË
(
lua
, -3);

499 
	}
}

501 
	$luaRedisE¼ÜR•lyCommªd
(
lua_S‹
 *
lua
) {

502  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"err");

503 
	}
}

505 
	$luaRedisStusR•lyCommªd
(
lua_S‹
 *
lua
) {

506  
	`luaRedisR‘uºSšgËF›ldTabË
(
lua
,"ok");

507 
	}
}

509 
	$luaLogCommªd
(
lua_S‹
 *
lua
) {

510 
j
, 
¬gc
 = 
	`lua_g‘tİ
(
lua
);

511 
Ëv–
;

512 
sds
 
log
;

514 ià(
¬gc
 < 2) {

515 
	`luaPushE¼Ü
(
lua
, "redis.log()„equireswo‡rguments or more.");

517 } ià(!
	`lua_i¢umb”
(
lua
,-
¬gc
)) {

518 
	`luaPushE¼Ü
(
lua
, "First‡rgument must be‡‚umber (log†evel).");

521 
Ëv–
 = 
	`lua_tÚumb”
(
lua
,-
¬gc
);

522 ià(
Ëv–
 < 
REDIS_DEBUG
 ||†ev– > 
REDIS_WARNING
) {

523 
	`luaPushE¼Ü
(
lua
, "Invalid debug†evel.");

528 
log
 = 
	`sd£m±y
();

529 
j
 = 1; j < 
¬gc
; j++) {

530 
size_t
 
Ën
;

531 *
s
;

533 
s
 = (*)
	`lua_tŞ¡ršg
(
lua
,(-
¬gc
)+
j
,&
Ën
);

534 ià(
s
) {

535 ià(
j
 !ğ1è
log
 = 
	`sdsÿ’
(log," ",1);

536 
log
 = 
	`sdsÿ’
Öog,
s
,
Ën
);

539 
	`»disLogRaw
(
Ëv–
,
log
);

540 
	`sdsä“
(
log
);

542 
	}
}

544 
	$luaMaskCouÁHook
(
lua_S‹
 *
lua
, 
lua_Debug
 *
¬
) {

545 
–­£d
;

546 
	`REDIS_NOTUSED
(
¬
);

547 
	`REDIS_NOTUSED
(
lua
);

549 
–­£d
 = 
	`m¡ime
(è- 
£rv”
.
lua_time_¡¬t
;

550 ià(
–­£d
 >ğ
£rv”
.
lua_time_lim™
 && s”v”.
lua_timedout
 == 0) {

551 
	`»disLog
(
REDIS_WARNING
,"Lu¨¦ow süˆd‘eùed: stÈšƒxecutiÚ‡á” %Îd mli£cÚds. You cªry klšghsüˆusšghSCRIPT KILL commªd.",
–­£d
);

552 
£rv”
.
lua_timedout
 = 1;

558 
	`«D–‘eFeEv’t
(
£rv”
.
–
, s”v”.
lua_ÿÎ”
->
fd
, 
AE_READABLE
);

560 ià(
£rv”
.
lua_timedout
è
	`´oûssEv’tsWheBlocked
();

561 ià(
£rv”
.
lua_kl
) {

562 
	`»disLog
(
REDIS_WARNING
,"Lua script killed by user with SCRIPT KILL.");

563 
	`lua_push¡ršg
(
lua
,"Script killed by user with SCRIPT KILL...");

564 
	`lua_”rÜ
(
lua
);

566 
	}
}

568 
	$luaLßdLib
(
lua_S‹
 *
lua
, cÚ¡ *
libÇme
, 
lua_CFunùiÚ
 
luafunc
) {

569 
	`lua_pushcfunùiÚ
(
lua
, 
luafunc
);

570 
	`lua_push¡ršg
(
lua
, 
libÇme
);

571 
	`lua_ÿÎ
(
lua
, 1, 0);

572 
	}
}

574 
LUALIB_API
 (
luaİ’_cjsÚ
è(
lua_S‹
 *
L
);

575 
LUALIB_API
 (
luaİ’_¡ruù
è(
lua_S‹
 *
L
);

576 
LUALIB_API
 (
luaİ’_cmsg·ck
è(
lua_S‹
 *
L
);

577 
LUALIB_API
 (
luaİ’_b™
è(
lua_S‹
 *
L
);

579 
	$luaLßdLib¿r›s
(
lua_S‹
 *
lua
) {

580 
	`luaLßdLib
(
lua
, "", 
luaİ’_ba£
);

581 
	`luaLßdLib
(
lua
, 
LUA_TABLIBNAME
, 
luaİ’_bË
);

582 
	`luaLßdLib
(
lua
, 
LUA_STRLIBNAME
, 
luaİ’_¡ršg
);

583 
	`luaLßdLib
(
lua
, 
LUA_MATHLIBNAME
, 
luaİ’_m©h
);

584 
	`luaLßdLib
(
lua
, 
LUA_DBLIBNAME
, 
luaİ’_debug
);

585 
	`luaLßdLib
(
lua
, "cjsÚ", 
luaİ’_cjsÚ
);

586 
	`luaLßdLib
(
lua
, "¡ruù", 
luaİ’_¡ruù
);

587 
	`luaLßdLib
(
lua
, "cmsg·ck", 
luaİ’_cmsg·ck
);

588 
	`luaLßdLib
(
lua
, "b™", 
luaİ’_b™
);

591 
	`luaLßdLib
(
lua
, 
LUA_LOADLIBNAME
, 
luaİ’_·ckage
);

592 
	`luaLßdLib
(
lua
, 
LUA_OSLIBNAME
, 
luaİ’_os
);

594 
	}
}

598 
	$luaRemoveUnsuµÜ‹dFunùiÚs
(
lua_S‹
 *
lua
) {

599 
	`lua_pushn
(
lua
);

600 
	`lua_£tglob®
(
lua
,"loadfile");

601 
	}
}

608 
	$sütšgEÇbËGlob®sPrÙeùiÚ
(
lua_S‹
 *
lua
) {

609 *
s
[32];

610 
sds
 
code
 = 
	`sd£m±y
();

611 
j
 = 0;

615 
s
[
j
++]="local mt = {}\n";

616 
s
[
j
++]="setmetatable(_G, mt)\n";

617 
s
[
j
++]="mt.__newindex = function (t,‚, v)\n";

618 
s
[
j
++]=" if debug.getinfo(2)hen\n";

619 
s
[
j
++]="†ocal w = debug.getinfo(2, \"S\").what\n";

620 
s
[
j
++]=" if w ~= \"main\"‡nd w ~= \"C\"hen\n";

621 
s
[
j
++]="ƒrror(\"Script‡ttemptedo create global variable '\"..tostring(n)..\"'\", 2)\n";

622 
s
[
j
++]="ƒnd\n";

623 
s
[
j
++]="ƒnd\n";

624 
s
[
j
++]="„awset(t,‚, v)\n";

625 
s
[
j
++]="end\n";

626 
s
[
j
++]="mt.__index = function (t,‚)\n";

627 
s
[
j
++]=" if debug.getinfo(2)‡nd debug.getinfo(2, \"S\").what ~= \"C\"hen\n";

628 
s
[
j
++]="ƒrror(\"Script‡ttemptedo‡ccess unexisting global variable '\"..tostring(n)..\"'\", 2)\n";

629 
s
[
j
++]="ƒnd\n";

630 
s
[
j
++]="„eturn„awget(t,‚)\n";

631 
s
[
j
++]="end\n";

632 
s
[
j
++]=
NULL
;

634 
j
 = 0; 
s
[j] !ğ
NULL
; j++è
code
 = 
	`sdsÿ’
(code,s[j],
	`¡¾’
(s[j]));

635 
	`luaL_lßdbufãr
(
lua
,
code
,
	`sd¦’
(code),"@enable_strict_lua");

636 
	`lua_pÿÎ
(
lua
,0,0,0);

637 
	`sdsä“
(
code
);

638 
	}
}

644 
	$sütšgIn™
() {

645 
lua_S‹
 *
lua
 = 
	`lua_İ’
();

647 
	`luaLßdLib¿r›s
(
lua
);

648 
	`luaRemoveUnsuµÜ‹dFunùiÚs
(
lua
);

653 
£rv”
.
lua_süts
 = 
	`diùC»©e
(&
shaSütObjeùDiùTy³
,
NULL
);

656 
	`lua_ÃwbË
(
lua
);

659 
	`lua_push¡ršg
(
lua
,"call");

660 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisC®lCommªd
);

661 
	`lua_£‰abË
(
lua
,-3);

664 
	`lua_push¡ršg
(
lua
,"pcall");

665 
	`lua_pushcfunùiÚ
(
lua
,
luaRedisPC®lCommªd
);

666 
	`lua_£‰abË
(
lua
,-3);

669 
	`lua_push¡ršg
(
lua
,"log");

670 
	`lua_pushcfunùiÚ
(
lua
,
luaLogCommªd
);

671 
	`lua_£‰abË
(
lua
,-3);

673 
	`lua_push¡ršg
(
lua
,"LOG_DEBUG");

674 
	`lua_pushnumb”
(
lua
,
REDIS_DEBUG
);

675 
	`lua_£‰abË
(
lua
,-3);

677 
	`lua_push¡ršg
(
lua
,"LOG_VERBOSE");

678 
	`lua_pushnumb”
(
lua
,
REDIS_VERBOSE
);

679 
	`lua_£‰abË
(
lua
,-3);

681 
	`lua_push¡ršg
(
lua
,"LOG_NOTICE");

682 
	`lua_pushnumb”
(
lua
,
REDIS_NOTICE
);

683 
	`lua_£‰abË
(
lua
,-3);

685 
	`lua_push¡ršg
(
lua
,"LOG_WARNING");

686 
	`lua_pushnumb”
(
lua
,
REDIS_WARNING
);

687 
	`lua_£‰abË
(
lua
,-3);

690 
	`lua_push¡ršg
(
lua
, "sha1hex");

691 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisSha1hexCommªd
);

692 
	`lua_£‰abË
(
lua
, -3);

695 
	`lua_push¡ršg
(
lua
, "error_reply");

696 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisE¼ÜR•lyCommªd
);

697 
	`lua_£‰abË
(
lua
, -3);

698 
	`lua_push¡ršg
(
lua
, "status_reply");

699 
	`lua_pushcfunùiÚ
(
lua
, 
luaRedisStusR•lyCommªd
);

700 
	`lua_£‰abË
(
lua
, -3);

703 
	`lua_£tglob®
(
lua
,"redis");

706 
	`lua_g‘glob®
(
lua
,"math");

708 
	`lua_push¡ršg
(
lua
,"random");

709 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom
);

710 
	`lua_£‰abË
(
lua
,-3);

712 
	`lua_push¡ršg
(
lua
,"randomseed");

713 
	`lua_pushcfunùiÚ
(
lua
,
»dis_m©h_¿ndom£ed
);

714 
	`lua_£‰abË
(
lua
,-3);

716 
	`lua_£tglob®
(
lua
,"math");

721 *
com·»_func
 = "function __redis__compare_helper(a,b)\n"

726 
	`luaL_lßdbufãr
(
lua
,
com·»_func
,
	`¡¾’
(compare_func),"@cmp_func_def");

727 
	`lua_pÿÎ
(
lua
,0,0,0);

735 *
”rh_func
 = "function __redis__err__handler(err)\n"

746 
	`luaL_lßdbufãr
(
lua
,
”rh_func
,
	`¡¾’
(errh_func),"@err_handler_def");

747 
	`lua_pÿÎ
(
lua
,0,0,0);

754 ià(
£rv”
.
lua_ş›Á
 =ğ
NULL
) {

755 
£rv”
.
lua_ş›Á
 = 
	`ü—‹Cl›Á
(-1);

756 
£rv”
.
lua_ş›Á
->
æags
 |ğ
REDIS_LUA_CLIENT
;

762 
	`sütšgEÇbËGlob®sPrÙeùiÚ
(
lua
);

764 
£rv”
.
lua
 =†ua;

765 
	}
}

769 
	$sütšgR–—£
() {

770 
	`diùR–—£
(
£rv”
.
lua_süts
);

771 
	`lua_şo£
(
£rv”
.
lua
);

772 
	}
}

774 
	$sütšgRe£t
() {

775 
	`sütšgR–—£
();

776 
	`sütšgIn™
();

777 
	}
}

785 
	$sha1hex
(*
dige¡
, *
süt
, 
size_t
 
Ën
) {

786 
SHA1_CTX
 
ùx
;

787 
hash
[20];

788 *
c£t
 = "0123456789abcdef";

789 
j
;

791 
	`SHA1In™
(&
ùx
);

792 
	`SHA1Upd©e
(&
ùx
,(*)
süt
,
Ën
);

793 
	`SHA1Fš®
(
hash
,&
ùx
);

795 
j
 = 0; j < 20; j++) {

796 
dige¡
[
j
*2] = 
c£t
[((
hash
[j]&0xF0)>>4)];

797 
dige¡
[
j
*2+1] = 
c£t
[(
hash
[j]&0xF)];

799 
dige¡
[40] = '\0';

800 
	}
}

802 
	$luaR•lyToRedisR•ly
(
»disCl›Á
 *
c
, 
lua_S‹
 *
lua
) {

803 
t
 = 
	`lua_ty³
(
lua
,-1);

805 
t
) {

806 
LUA_TSTRING
:

807 
	`addR•lyBulkCBufãr
(
c
,(*)
	`lua_to¡ršg
(
lua
,-1),
	`lua_¡¾’
(lua,-1));

809 
LUA_TBOOLEAN
:

810 
	`addR•ly
(
c
,
	`lua_toboŞ—n
(
lua
,-1è? 
sh¬ed
.
cÚe
 : sh¬ed.
nuÎbulk
);

812 
LUA_TNUMBER
:

813 
	`addR•lyLÚgLÚg
(
c
,()
	`lua_tÚumb”
(
lua
,-1));

815 
LUA_TTABLE
:

819 
	`lua_push¡ršg
(
lua
,"err");

820 
	`lua_g‘bË
(
lua
,-2);

821 
t
 = 
	`lua_ty³
(
lua
,-1);

822 ià(
t
 =ğ
LUA_TSTRING
) {

823 
sds
 
”r
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

824 
	`sdsm­ch¬s
(
”r
,"\r\n"," ",2);

825 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"-%s\r\n",
”r
));

826 
	`sdsä“
(
”r
);

827 
	`lua_pİ
(
lua
,2);

831 
	`lua_pİ
(
lua
,1);

832 
	`lua_push¡ršg
(
lua
,"ok");

833 
	`lua_g‘bË
(
lua
,-2);

834 
t
 = 
	`lua_ty³
(
lua
,-1);

835 ià(
t
 =ğ
LUA_TSTRING
) {

836 
sds
 
ok
 = 
	`sd¢ew
(
	`lua_to¡ršg
(
lua
,-1));

837 
	`sdsm­ch¬s
(
ok
,"\r\n"," ",2);

838 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"+%s\r\n",
ok
));

839 
	`sdsä“
(
ok
);

840 
	`lua_pİ
(
lua
,1);

842 *
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

843 
j
 = 1, 
mbulkËn
 = 0;

845 
	`lua_pİ
(
lua
,1);

847 
	`lua_pushnumb”
(
lua
,
j
++);

848 
	`lua_g‘bË
(
lua
,-2);

849 
t
 = 
	`lua_ty³
(
lua
,-1);

850 ià(
t
 =ğ
LUA_TNIL
) {

851 
	`lua_pİ
(
lua
,1);

854 
	`luaR•lyToRedisR•ly
(
c
, 
lua
);

855 
mbulkËn
++;

857 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
mbulkËn
);

861 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

863 
	`lua_pİ
(
lua
,1);

864 
	}
}

868 
	$luaS‘Glob®A¼ay
(
lua_S‹
 *
lua
, *
v¬
, 
robj
 **
–ev
, 
–ec
) {

869 
j
;

871 
	`lua_ÃwbË
(
lua
);

872 
j
 = 0; j < 
–ec
; j++) {

873 
	`lua_pushl¡ršg
(
lua
,(*)
–ev
[
j
]->
±r
,
	`sd¦’
(elev[j]->ptr));

874 
	`lua_¿w£ti
(
lua
,-2,
j
+1);

876 
	`lua_£tglob®
(
lua
,
v¬
);

877 
	}
}

888 
	$luaC»©eFunùiÚ
(
»disCl›Á
 *
c
, 
lua_S‹
 *
lua
, *
funúame
, 
robj
 *
body
) {

889 
sds
 
funcdef
 = 
	`sd£m±y
();

891 
funcdef
 = 
	`sdsÿt
(funcdef,"function ");

892 
funcdef
 = 
	`sdsÿ’
(funcdef,
funúame
,42);

893 
funcdef
 = 
	`sdsÿ’
(funcdef,"() ",3);

894 
funcdef
 = 
	`sdsÿ’
(funcdef,
body
->
±r
,
	`sd¦’
(body->ptr));

895 
funcdef
 = 
	`sdsÿ’
(funcdef,"ƒnd",4);

897 ià(
	`luaL_lßdbufãr
(
lua
,
funcdef
,
	`sd¦’
(funcdef),"@user_script")) {

898 
	`addR•lyE¼ÜFÜm©
(
c
,"Error compiling script (new function): %s\n",

899 
	`lua_to¡ršg
(
lua
,-1));

900 
	`lua_pİ
(
lua
,1);

901 
	`sdsä“
(
funcdef
);

902  
REDIS_ERR
;

904 
	`sdsä“
(
funcdef
);

905 ià(
	`lua_pÿÎ
(
lua
,0,0,0)) {

906 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (new function): %s\n",

907 
	`lua_to¡ršg
(
lua
,-1));

908 
	`lua_pİ
(
lua
,1);

909  
REDIS_ERR
;

916 
»tv®
 = 
	`diùAdd
(
£rv”
.
lua_süts
,

917 
	`sd¢ewËn
(
funúame
+2,40),
body
);

918 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
»tv®
 =ğ
DICT_OK
);

919 
	`šüRefCouÁ
(
body
);

921  
REDIS_OK
;

922 
	}
}

924 
	$ev®G’”icCommªd
(
»disCl›Á
 *
c
, 
ev®sha
) {

925 
lua_S‹
 *
lua
 = 
£rv”
.lua;

926 
funúame
[43];

927 
numkeys
;

928 
d–hook
 = 0, 
”r
;

932 
	`»disS¿nd48
(0);

942 
£rv”
.
lua_¿ndom_dœty
 = 0;

943 
£rv”
.
lua_wr™e_dœty
 = 0;

946 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
numkeys
,
NULL
è!ğ
REDIS_OK
)

948 ià(
numkeys
 > (
c
->
¬gc
 - 3)) {

949 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be greaterhan‚umber of‡rgs");

951 } ià(
numkeys
 < 0) {

952 
	`addR•lyE¼Ü
(
c
,"Number of keys can't be‚egative");

958 
funúame
[0] = 'f';

959 
funúame
[1] = '_';

960 ià(!
ev®sha
) {

962 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[1]->
±r
,
	`sd¦’
(c->argv[1]->ptr));

965 
j
;

966 *
sha
 = 
c
->
¬gv
[1]->
±r
;

971 
j
 = 0; j < 40; j++)

972 
funúame
[
j
+2] = (
sha
[j] >= 'A' && sha[j] <= 'Z') ?

973 
sha
[
j
]+('a'-'A') : sha[j];

974 
funúame
[42] = '\0';

978 
	`lua_g‘glob®
(
lua
, "__redis__err__handler");

981 
	`lua_g‘glob®
(
lua
, 
funúame
);

982 ià(
	`lua_i¢
(
lua
,-1)) {

983 
	`lua_pİ
(
lua
,1);

987 ià(
ev®sha
) {

988 
	`lua_pİ
(
lua
,1);

989 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

992 ià(
	`luaC»©eFunùiÚ
(
c
,
lua
,
funúame
,c->
¬gv
[1]è=ğ
REDIS_ERR
) {

993 
	`lua_pİ
(
lua
,1);

999 
	`lua_g‘glob®
(
lua
, 
funúame
);

1000 
	`»disAs£¹
(!
	`lua_i¢
(
lua
,-1));

1005 
	`luaS‘Glob®A¼ay
(
lua
,"KEYS",
c
->
¬gv
+3,
numkeys
);

1006 
	`luaS‘Glob®A¼ay
(
lua
,"ARGV",
c
->
¬gv
+3+
numkeys
,c->
¬gc
-3-numkeys);

1009 
	`£ËùDb
(
£rv”
.
lua_ş›Á
,
c
->
db
->
id
);

1015 
£rv”
.
lua_ÿÎ”
 = 
c
;

1016 
£rv”
.
lua_time_¡¬t
 = 
	`m¡ime
();

1017 
£rv”
.
lua_kl
 = 0;

1018 ià(
£rv”
.
lua_time_lim™
 > 0 && s”v”.
ma¡”ho¡
 =ğ
NULL
) {

1019 
	`lua_£thook
(
lua
,
luaMaskCouÁHook
,
LUA_MASKCOUNT
,100000);

1020 
d–hook
 = 1;

1026 
”r
 = 
	`lua_pÿÎ
(
lua
,0,1,-2);

1029 ià(
d–hook
è
	`lua_£thook
(
lua
,
luaMaskCouÁHook
,0,0);

1030 ià(
£rv”
.
lua_timedout
) {

1031 
£rv”
.
lua_timedout
 = 0;

1034 
	`«C»©eFeEv’t
(
£rv”
.
–
,
c
->
fd
,
AE_READABLE
,

1035 
»adQu”yFromCl›Á
,
c
);

1037 
£rv”
.
lua_ÿÎ”
 = 
NULL
;

1045 
	#LUA_GC_CYCLE_PERIOD
 50

	)

1047 
gc_couÁ
 = 0;

1049 
gc_couÁ
++;

1050 ià(
gc_couÁ
 =ğ
LUA_GC_CYCLE_PERIOD
) {

1051 
	`lua_gc
(
lua
,
LUA_GCSTEP
,
LUA_GC_CYCLE_PERIOD
);

1052 
gc_couÁ
 = 0;

1056 ià(
”r
) {

1057 
	`addR•lyE¼ÜFÜm©
(
c
,"Error„unning script (callo %s): %s\n",

1058 
funúame
, 
	`lua_to¡ršg
(
lua
,-1));

1059 
	`lua_pİ
(
lua
,2);

1063 
	`luaR•lyToRedisR•ly
(
c
,
lua
);

1064 
	`lua_pİ
(
lua
,1);

1077 ià(
ev®sha
) {

1078 ià(!
	`»¶iÿtiÚSütCacheExi¡s
(
c
->
¬gv
[1]->
±r
)) {

1082 
robj
 *
süt
 = 
	`diùF‘chV®ue
(
£rv”
.
lua_süts
,
c
->
¬gv
[1]->
±r
);

1084 
	`»¶iÿtiÚSütCacheAdd
(
c
->
¬gv
[1]->
±r
);

1085 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
süt
 != NULL);

1086 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,

1087 
	`»£tRefCouÁ
(
	`ü—‹SŒšgObjeù
("EVAL",4)));

1088 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,1,
süt
);

1089 
	`fÜûCommªdPrİag©iÚ
(
c
,
REDIS_PROPAGATE_REPL
|
REDIS_PROPAGATE_AOF
);

1092 
	}
}

1094 
	$ev®Commªd
(
»disCl›Á
 *
c
) {

1095 
	`ev®G’”icCommªd
(
c
,0);

1096 
	}
}

1098 
	$ev®ShaCommªd
(
»disCl›Á
 *
c
) {

1099 ià(
	`sd¦’
(
c
->
¬gv
[1]->
±r
) != 40) {

1104 
	`addR•ly
(
c
, 
sh¬ed
.
nosü‹¼
);

1107 
	`ev®G’”icCommªd
(
c
,1);

1108 
	}
}

1116 
	$»dis_m©h_¿ndom
 (
lua_S‹
 *
L
) {

1119 
lua_Numb”
 
r
 = (lua_Numb”)(
	`»disL¿nd48
()%
REDIS_LRAND48_MAX
) /

1120 (
lua_Numb”
)
REDIS_LRAND48_MAX
;

1121 
	`lua_g‘tİ
(
L
)) {

1123 
	`lua_pushnumb”
(
L
, 
r
);

1127 
u
 = 
	`luaL_checkšt
(
L
, 1);

1128 
	`luaL_¬gcheck
(
L
, 1<=
u
, 1, "interval isƒmpty");

1129 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*
u
)+1);

1133 
l
 = 
	`luaL_checkšt
(
L
, 1);

1134 
u
 = 
	`luaL_checkšt
(
L
, 2);

1135 
	`luaL_¬gcheck
(
L
, 
l
<=
u
, 2, "interval isƒmpty");

1136 
	`lua_pushnumb”
(
L
, 
	`æoÜ
(
r
*(
u
-
l
+1))+l);

1139 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

1142 
	}
}

1144 
	$»dis_m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

1145 
	`»disS¿nd48
(
	`luaL_checkšt
(
L
, 1));

1147 
	}
}

1153 
	$sütCommªd
(
»disCl›Á
 *
c
) {

1154 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"flush")) {

1155 
	`sütšgRe£t
();

1156 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1157 
	`»¶iÿtiÚSütCacheFlush
();

1158 
£rv”
.
dœty
++;

1159 } ià(
c
->
¬gc
 >ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"exists")) {

1160 
j
;

1162 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

1163 
j
 = 2; j < 
c
->
¬gc
; j++) {

1164 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
c
->
¬gv
[
j
]->
±r
))

1165 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

1167 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1169 } ià(
c
->
¬gc
 =ğ3 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"load")) {

1170 
funúame
[43];

1171 
sds
 
sha
;

1173 
funúame
[0] = 'f';

1174 
funúame
[1] = '_';

1175 
	`sha1hex
(
funúame
+2,
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

1176 
sha
 = 
	`sd¢ewËn
(
funúame
+2,40);

1177 ià(
	`diùFšd
(
£rv”
.
lua_süts
,
sha
è=ğ
NULL
) {

1178 ià(
	`luaC»©eFunùiÚ
(
c
,
£rv”
.
lua
,
funúame
,c->
¬gv
[2])

1179 =ğ
REDIS_ERR
) {

1180 
	`sdsä“
(
sha
);

1184 
	`addR•lyBulkCBufãr
(
c
,
funúame
+2,40);

1185 
	`sdsä“
(
sha
);

1186 
	`fÜûCommªdPrİag©iÚ
(
c
,
REDIS_PROPAGATE_REPL
|
REDIS_PROPAGATE_AOF
);

1187 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"kill")) {

1188 ià(
£rv”
.
lua_ÿÎ”
 =ğ
NULL
) {

1189 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOTBUSY No scripts inƒxecution„ight‚ow.\r\n"));

1190 } ià(
£rv”
.
lua_wr™e_dœty
) {

1191 
	`addR•lySds
(
c
,
	`sd¢ew
("-UNKILLABLE Sorryhe script‡lreadyƒxecuted write commands‡gainsthe dataset. You canƒither waithe scriptermination or killhe server in‡ hard way usinghe SHUTDOWN NOSAVE command.\r\n"));

1193 
£rv”
.
lua_kl
 = 1;

1194 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

1197 
	`addR•lyE¼Ü
(
c
, "Unknown SCRIPT subcommand or wrong # of‡rgs.");

1199 
	}
}

	@sds.c

31 
	~<¡dio.h
>

32 
	~<¡dlib.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<as£¹.h
>

36 
	~"sds.h
"

37 
	~"zm®loc.h
"

51 
sds
 
	$sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
) {

52 
sdshdr
 *
sh
;

54 ià(
š™
) {

55 
sh
 = 
	`zm®loc
((
sdshdr
)+
š™Ën
+1);

57 
sh
 = 
	`zÿÎoc
((
sdshdr
)+
š™Ën
+1);

59 ià(
sh
 =ğ
NULL
)  NULL;

60 
sh
->
Ën
 = 
š™Ën
;

61 
sh
->
ä“
 = 0;

62 ià(
š™Ën
 && 
š™
)

63 
	`memıy
(
sh
->
buf
, 
š™
, 
š™Ën
);

64 
sh
->
buf
[
š™Ën
] = '\0';

65  (*)
sh
->
buf
;

66 
	}
}

70 
sds
 
	$sd£m±y
() {

71  
	`sd¢ewËn
("",0);

72 
	}
}

75 
sds
 
	$sd¢ew
(cÚ¡ *
š™
) {

76 
size_t
 
š™Ën
 = (
š™
 =ğ
NULL
è? 0 : 
	`¡¾’
(init);

77  
	`sd¢ewËn
(
š™
, 
š™Ën
);

78 
	}
}

81 
sds
 
	$sdsdup
(cÚ¡ 
sds
 
s
) {

82  
	`sd¢ewËn
(
s
, 
	`sd¦’
(s));

83 
	}
}

86 
	$sdsä“
(
sds
 
s
) {

87 ià(
s
 =ğ
NULL
) ;

88 
	`zä“
(
s
-(
sdshdr
));

89 
	}
}

105 
	$sdsupd©–’
(
sds
 
s
) {

106 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

107 
»®Ën
 = 
	`¡¾’
(
s
);

108 
sh
->
ä“
 +ğ(sh->
Ën
-
»®Ën
);

109 
sh
->
Ën
 = 
»®Ën
;

110 
	}
}

116 
	$sdsş—r
(
sds
 
s
) {

117 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

118 
sh
->
ä“
 +ğsh->
Ën
;

119 
sh
->
Ën
 = 0;

120 
sh
->
buf
[0] = '\0';

121 
	}
}

129 
sds
 
	$sdsMakeRoomFÜ
(
sds
 
s
, 
size_t
 
addËn
) {

130 
sdshdr
 *
sh
, *
Ãwsh
;

131 
size_t
 
ä“
 = 
	`sd§va
(
s
);

132 
size_t
 
Ën
, 
ÃwËn
;

134 ià(
ä“
 >ğ
addËn
è 
s
;

135 
Ën
 = 
	`sd¦’
(
s
);

136 
sh
 = (*è(
s
-((
sdshdr
)));

137 
ÃwËn
 = (
Ën
+
addËn
);

138 ià(
ÃwËn
 < 
SDS_MAX_PREALLOC
)

139 
ÃwËn
 *= 2;

141 
ÃwËn
 +ğ
SDS_MAX_PREALLOC
;

142 
Ãwsh
 = 
	`z»®loc
(
sh
, (
sdshdr
)+
ÃwËn
+1);

143 ià(
Ãwsh
 =ğ
NULL
)  NULL;

145 
Ãwsh
->
ä“
 = 
ÃwËn
 - 
Ën
;

146  
Ãwsh
->
buf
;

147 
	}
}

155 
sds
 
	$sdsRemoveF»eS·û
(
sds
 
s
) {

156 
sdshdr
 *
sh
;

158 
sh
 = (*è(
s
-((
sdshdr
)));

159 
sh
 = 
	`z»®loc
(sh, (
sdshdr
)+sh->
Ën
+1);

160 
sh
->
ä“
 = 0;

161  
sh
->
buf
;

162 
	}
}

171 
size_t
 
	$sdsAÎocSize
(
sds
 
s
) {

172 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

174  (*
sh
)+sh->
Ën
+sh->
ä“
+1;

175 
	}
}

200 
	$sdsInüL’
(
sds
 
s
, 
šü
) {

201 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

203 ià(
šü
 >= 0)

204 
	`as£¹
(
sh
->
ä“
 >ğ()
šü
);

206 
	`as£¹
(
sh
->
Ën
 >ğ()(-
šü
));

207 
sh
->
Ën
 +ğ
šü
;

208 
sh
->
ä“
 -ğ
šü
;

209 
s
[
sh
->
Ën
] = '\0';

210 
	}
}

217 
sds
 
	$sdsgrowz”o
(
sds
 
s
, 
size_t
 
Ën
) {

218 
sdshdr
 *
sh
 = (*)(
s
-((sdshdr)));

219 
size_t
 
tÙËn
, 
cu¾’
 = 
sh
->
Ën
;

221 ià(
Ën
 <ğ
cu¾’
è 
s
;

222 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
cu¾’
);

223 ià(
s
 =ğ
NULL
)  NULL;

226 
sh
 = (*)(
s
-((
sdshdr
)));

227 
	`mem£t
(
s
+
cu¾’
,0,(
Ën
-curlen+1));

228 
tÙËn
 = 
sh
->
Ën
+sh->
ä“
;

229 
sh
->
Ën
 =†en;

230 
sh
->
ä“
 = 
tÙËn
-sh->
Ën
;

231  
s
;

232 
	}
}

239 
sds
 
	$sdsÿ’
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

240 
sdshdr
 *
sh
;

241 
size_t
 
cu¾’
 = 
	`sd¦’
(
s
);

243 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
);

244 ià(
s
 =ğ
NULL
)  NULL;

245 
sh
 = (*è(
s
-((
sdshdr
)));

246 
	`memıy
(
s
+
cu¾’
, 
t
, 
Ën
);

247 
sh
->
Ën
 = 
cu¾’
+len;

248 
sh
->
ä“
 = sh->ä“-
Ën
;

249 
s
[
cu¾’
+
Ën
] = '\0';

250  
s
;

251 
	}
}

257 
sds
 
	$sdsÿt
(
sds
 
s
, cÚ¡ *
t
) {

258  
	`sdsÿ’
(
s
, 
t
, 
	`¡¾’
(t));

259 
	}
}

265 
sds
 
	$sdsÿtsds
(
sds
 
s
, cÚ¡ sd 
t
) {

266  
	`sdsÿ’
(
s
, 
t
, 
	`sd¦’
(t));

267 
	}
}

271 
sds
 
	$sdsıyËn
(
sds
 
s
, cÚ¡ *
t
, 
size_t
 
Ën
) {

272 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

273 
size_t
 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

275 ià(
tÙËn
 < 
Ën
) {

276 
s
 = 
	`sdsMakeRoomFÜ
(s,
Ën
-
sh
->len);

277 ià(
s
 =ğ
NULL
)  NULL;

278 
sh
 = (*è(
s
-((
sdshdr
)));

279 
tÙËn
 = 
sh
->
ä“
+sh->
Ën
;

281 
	`memıy
(
s
, 
t
, 
Ën
);

282 
s
[
Ën
] = '\0';

283 
sh
->
Ën
 =†en;

284 
sh
->
ä“
 = 
tÙËn
-
Ën
;

285  
s
;

286 
	}
}

290 
sds
 
	$sdsıy
(
sds
 
s
, cÚ¡ *
t
) {

291  
	`sdsıyËn
(
s
, 
t
, 
	`¡¾’
(t));

292 
	}
}

300 
	#SDS_LLSTR_SIZE
 21

	)

301 
	$sd¦l2¡r
(*
s
, 
v®ue
) {

302 *
p
, 
aux
;

303 
v
;

304 
size_t
 
l
;

308 
v
 = (
v®ue
 < 0) ? -value : value;

309 
p
 = 
s
;

311 *
p
++ = '0'+(
v
%10);

312 
v
 /= 10;

313 } 
v
);

314 ià(
v®ue
 < 0è*
p
++ = '-';

317 
l
 = 
p
-
s
;

318 *
p
 = '\0';

321 
p
--;

322 
s
 < 
p
) {

323 
aux
 = *
s
;

324 *
s
 = *
p
;

325 *
p
 = 
aux
;

326 
s
++;

327 
p
--;

329  
l
;

330 
	}
}

333 
	$sdsuÎ2¡r
(*
s
, 
v
) {

334 *
p
, 
aux
;

335 
size_t
 
l
;

339 
p
 = 
s
;

341 *
p
++ = '0'+(
v
%10);

342 
v
 /= 10;

343 } 
v
);

346 
l
 = 
p
-
s
;

347 *
p
 = '\0';

350 
p
--;

351 
s
 < 
p
) {

352 
aux
 = *
s
;

353 *
s
 = *
p
;

354 *
p
 = 
aux
;

355 
s
++;

356 
p
--;

358  
l
;

359 
	}
}

365 
sds
 
	$sdsäomlÚglÚg
(
v®ue
) {

366 
buf
[
SDS_LLSTR_SIZE
];

367 
Ën
 = 
	`sd¦l2¡r
(
buf
,
v®ue
);

369  
	`sd¢ewËn
(
buf
,
Ën
);

370 
	}
}

373 
sds
 
	$sdsÿtv´štf
(
sds
 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

374 
va_li¡
 
ıy
;

375 
¡©icbuf
[1024], *
buf
 = sticbuf, *
t
;

376 
size_t
 
buæ’
 = 
	`¡¾’
(
fmt
)*2;

380 ià(
buæ’
 > (
¡©icbuf
)) {

381 
buf
 = 
	`zm®loc
(
buæ’
);

382 ià(
buf
 =ğ
NULL
)  NULL;

384 
buæ’
 = (
¡©icbuf
);

390 
buf
[
buæ’
-2] = '\0';

391 
	`va_cİy
(
ıy
,
­
);

392 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
ıy
);

393 
	`va_’d
(
ıy
);

394 ià(
buf
[
buæ’
-2] != '\0') {

395 ià(
buf
 !ğ
¡©icbuf
è
	`zä“
(buf);

396 
buæ’
 *= 2;

397 
buf
 = 
	`zm®loc
(
buæ’
);

398 ià(
buf
 =ğ
NULL
)  NULL;

405 
t
 = 
	`sdsÿt
(
s
, 
buf
);

406 ià(
buf
 !ğ
¡©icbuf
è
	`zä“
(buf);

407  
t
;

408 
	}
}

426 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

427 
va_li¡
 
­
;

428 *
t
;

429 
	`va_¡¬t
(
­
, 
fmt
);

430 
t
 = 
	`sdsÿtv´štf
(
s
,
fmt
,
­
);

431 
	`va_’d
(
­
);

432  
t
;

433 
	}
}

451 
sds
 
	$sdsÿtfmt
(
sds
 
s
, cÚ¡ *
fmt
, ...) {

452 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

453 
size_t
 
š™Ën
 = 
	`sd¦’
(
s
);

454 cÚ¡ *
f
 = 
fmt
;

455 
i
;

456 
va_li¡
 
­
;

458 
	`va_¡¬t
(
­
,
fmt
);

459 
f
 = 
fmt
;

460 
i
 = 
š™Ën
;

461 *
f
) {

462 
Ãxt
, *
¡r
;

463 
l
;

464 
num
;

465 
unum
;

468 ià(
sh
->
ä“
 == 0) {

469 
s
 = 
	`sdsMakeRoomFÜ
(s,1);

470 
sh
 = (*è(
s
-((
sdshdr
)));

473 *
f
) {

475 
Ãxt
 = *(
f
+1);

476 
f
++;

477 
Ãxt
) {

480 
¡r
 = 
	`va_¬g
(
­
,*);

481 
l
 = (
Ãxt
 =ğ's'è? 
	`¡¾’
(
¡r
è: 
	`sd¦’
(str);

482 ià(
sh
->
ä“
 < 
l
) {

483 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

484 
sh
 = (*è(
s
-((
sdshdr
)));

486 
	`memıy
(
s
+
i
,
¡r
,
l
);

487 
sh
->
Ën
 +ğ
l
;

488 
sh
->
ä“
 -ğ
l
;

489 
i
 +ğ
l
;

493 ià(
Ãxt
 == 'i')

494 
num
 = 
	`va_¬g
(
­
,);

496 
num
 = 
	`va_¬g
(
­
,);

498 
buf
[
SDS_LLSTR_SIZE
];

499 
l
 = 
	`sd¦l2¡r
(
buf
,
num
);

500 ià(
sh
->
ä“
 < 
l
) {

501 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

502 
sh
 = (*è(
s
-((
sdshdr
)));

504 
	`memıy
(
s
+
i
,
buf
,
l
);

505 
sh
->
Ën
 +ğ
l
;

506 
sh
->
ä“
 -ğ
l
;

507 
i
 +ğ
l
;

512 ià(
Ãxt
 == 'u')

513 
unum
 = 
	`va_¬g
(
­
,);

515 
unum
 = 
	`va_¬g
(
­
,);

517 
buf
[
SDS_LLSTR_SIZE
];

518 
l
 = 
	`sdsuÎ2¡r
(
buf
,
unum
);

519 ià(
sh
->
ä“
 < 
l
) {

520 
s
 = 
	`sdsMakeRoomFÜ
(s,
l
);

521 
sh
 = (*è(
s
-((
sdshdr
)));

523 
	`memıy
(
s
+
i
,
buf
,
l
);

524 
sh
->
Ën
 +ğ
l
;

525 
sh
->
ä“
 -ğ
l
;

526 
i
 +ğ
l
;

530 
s
[
i
++] = 
Ãxt
;

531 
sh
->
Ën
 += 1;

532 
sh
->
ä“
 -= 1;

537 
s
[
i
++] = *
f
;

538 
sh
->
Ën
 += 1;

539 
sh
->
ä“
 -= 1;

542 
f
++;

544 
	`va_’d
(
­
);

547 
s
[
i
] = '\0';

548  
s
;

549 
	}
}

565 
sds
 
	$sd¡rim
(
sds
 
s
, cÚ¡ *
c£t
) {

566 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

567 *
¡¬t
, *
’d
, *
¥
, *
•
;

568 
size_t
 
Ën
;

570 
¥
 = 
¡¬t
 = 
s
;

571 
•
 = 
’d
 = 
s
+
	`sd¦’
(s)-1;

572 
¥
 <ğ
’d
 && 
	`¡rchr
(
c£t
, *sp)) sp++;

573 
•
 > 
¡¬t
 && 
	`¡rchr
(
c£t
, *ep))ƒp--;

574 
Ën
 = (
¥
 > 
•
) ? 0 : ((ep-sp)+1);

575 ià(
sh
->
buf
 !ğ
¥
è
	`memmove
(sh->buf, sp, 
Ën
);

576 
sh
->
buf
[
Ën
] = '\0';

577 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-len);

578 
sh
->
Ën
 =†en;

579  
s
;

580 
	}
}

598 
	$sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
) {

599 
sdshdr
 *
sh
 = (*è(
s
-((sdshdr)));

600 
size_t
 
ÃwËn
, 
Ën
 = 
	`sd¦’
(
s
);

602 ià(
Ën
 == 0) ;

603 ià(
¡¬t
 < 0) {

604 
¡¬t
 = 
Ën
+start;

605 ià(
¡¬t
 < 0) start = 0;

607 ià(
’d
 < 0) {

608 
’d
 = 
Ën
+end;

609 ià(
’d
 < 0)ƒnd = 0;

611 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

612 ià(
ÃwËn
 != 0) {

613 ià(
¡¬t
 >ğ(sigÃd)
Ën
) {

614 
ÃwËn
 = 0;

615 } ià(
’d
 >ğ(sigÃd)
Ën
) {

616 
’d
 = 
Ën
-1;

617 
ÃwËn
 = (
¡¬t
 > 
’d
) ? 0 : (end-start)+1;

620 
¡¬t
 = 0;

622 ià(
¡¬t
 && 
ÃwËn
è
	`memmove
(
sh
->
buf
, sh->buf+start,‚ewlen);

623 
sh
->
buf
[
ÃwËn
] = 0;

624 
sh
->
ä“
 = sh->ä“+(sh->
Ën
-
ÃwËn
);

625 
sh
->
Ën
 = 
ÃwËn
;

626 
	}
}

629 
	$sd¡Şow”
(
sds
 
s
) {

630 
Ën
 = 
	`sd¦’
(
s
), 
j
;

632 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`tŞow”
(s[j]);

633 
	}
}

636 
	$sd¡ouµ”
(
sds
 
s
) {

637 
Ën
 = 
	`sd¦’
(
s
), 
j
;

639 
j
 = 0; j < 
Ën
; j++è
s
[j] = 
	`touµ”
(s[j]);

640 
	}
}

653 
	$sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
) {

654 
size_t
 
l1
, 
l2
, 
mšËn
;

655 
cmp
;

657 
l1
 = 
	`sd¦’
(
s1
);

658 
l2
 = 
	`sd¦’
(
s2
);

659 
mšËn
 = (
l1
 < 
l2
) ?†1 :†2;

660 
cmp
 = 
	`memcmp
(
s1
,
s2
,
mšËn
);

661 ià(
cmp
 =ğ0è 
l1
-
l2
;

662  
cmp
;

663 
	}
}

681 
sds
 *
	$sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
) {

682 
–em’ts
 = 0, 
¦Ùs
 = 5, 
¡¬t
 = 0, 
j
;

683 
sds
 *
tok’s
;

685 ià(
£¶’
 < 1 || 
Ën
 < 0è 
NULL
;

687 
tok’s
 = 
	`zm®loc
((
sds
)*
¦Ùs
);

688 ià(
tok’s
 =ğ
NULL
)  NULL;

690 ià(
Ën
 == 0) {

691 *
couÁ
 = 0;

692  
tok’s
;

694 
j
 = 0; j < (
Ën
-(
£¶’
-1)); j++) {

696 ià(
¦Ùs
 < 
–em’ts
+2) {

697 
sds
 *
Ãwtok’s
;

699 
¦Ùs
 *= 2;

700 
Ãwtok’s
 = 
	`z»®loc
(
tok’s
,(
sds
)*
¦Ùs
);

701 ià(
Ãwtok’s
 =ğ
NULL
è
ş—nup
;

702 
tok’s
 = 
Ãwtok’s
;

705 ià((
£¶’
 =ğ1 && *(
s
+
j
è=ğ
£p
[0]è|| (
	`memcmp
(s+j,sep,seplen) == 0)) {

706 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
j
-start);

707 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

708 
–em’ts
++;

709 
¡¬t
 = 
j
+
£¶’
;

710 
j
 = j+
£¶’
-1;

714 
tok’s
[
–em’ts
] = 
	`sd¢ewËn
(
s
+
¡¬t
,
Ën
-start);

715 ià(
tok’s
[
–em’ts
] =ğ
NULL
è
ş—nup
;

716 
–em’ts
++;

717 *
couÁ
 = 
–em’ts
;

718  
tok’s
;

720 
ş—nup
:

722 
i
;

723 
i
 = 0; i < 
–em’ts
; i++è
	`sdsä“
(
tok’s
[i]);

724 
	`zä“
(
tok’s
);

725 *
couÁ
 = 0;

726  
NULL
;

728 
	}
}

731 
	$sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
) {

732 ià(!
tok’s
) ;

733 
couÁ
--)

734 
	`sdsä“
(
tok’s
[
couÁ
]);

735 
	`zä“
(
tok’s
);

736 
	}
}

744 
sds
 
	$sdsÿŒ•r
(
sds
 
s
, cÚ¡ *
p
, 
size_t
 
Ën
) {

745 
s
 = 
	`sdsÿ’
(s,"\"",1);

746 
Ën
--) {

747 *
p
) {

750 
s
 = 
	`sdsÿrštf
(s,"\\%c",*
p
);

752 '\n': 
s
 = 
	`sdsÿ’
(s,"\\n",2); ;

753 '\r': 
s
 = 
	`sdsÿ’
(s,"\\r",2); ;

754 '\t': 
s
 = 
	`sdsÿ’
(s,"\\t",2); ;

755 '\a': 
s
 = 
	`sdsÿ’
(s,"\\a",2); ;

756 '\b': 
s
 = 
	`sdsÿ’
(s,"\\b",2); ;

758 ià(
	`i¥ršt
(*
p
))

759 
s
 = 
	`sdsÿrštf
(s,"%c",*
p
);

761 
s
 = 
	`sdsÿrštf
(s,"\\x%02x",()*
p
);

764 
p
++;

766  
	`sdsÿ’
(
s
,"\"",1);

767 
	}
}

771 
	$is_hex_dig™
(
c
) {

772  (
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') ||

773 (
c
 >= 'A' && c <= 'F');

774 
	}
}

778 
	$hex_dig™_to_št
(
c
) {

779 
c
) {

798 
	}
}

819 
sds
 *
	$sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
) {

820 cÚ¡ *
p
 = 
lše
;

821 *
cu¼’t
 = 
NULL
;

822 **
veùÜ
 = 
NULL
;

824 *
¬gc
 = 0;

827 *
p
 && 
	`is¥aû
(*p))…++;

828 ià(*
p
) {

830 
šq
=0;

831 
šsq
=0;

832 
dÚe
=0;

834 ià(
cu¼’t
 =ğ
NULL
ècu¼’ˆğ
	`sd£m±y
();

835 !
dÚe
) {

836 ià(
šq
) {

837 ià(*
p
 == '\\' && *(p+1) == 'x' &&

838 
	`is_hex_dig™
(*(
p
+2)) &&

839 
	`is_hex_dig™
(*(
p
+3)))

841 
by‹
;

843 
by‹
 = (
	`hex_dig™_to_št
(*(
p
+2))*16)+

844 
	`hex_dig™_to_št
(*(
p
+3));

845 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,(*)&
by‹
,1);

846 
p
 += 3;

847 } ià(*
p
 == '\\' && *(p+1)) {

848 
c
;

850 
p
++;

851 *
p
) {

852 'n': 
c
 = '\n'; ;

853 'r': 
c
 = '\r'; ;

854 't': 
c
 = '\t'; ;

855 'b': 
c
 = '\b'; ;

856 'a': 
c
 = '\a'; ;

857 : 
c
 = *
p
; ;

859 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,&
c
,1);

860 } ià(*
p
 == '"') {

863 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

864 
dÚe
=1;

865 } ià(!*
p
) {

867 
”r
;

869 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

871 } ià(
šsq
) {

872 ià(*
p
 == '\\' && *(p+1) == '\'') {

873 
p
++;

874 
cu¼’t
 = 
	`sdsÿ’
(current,"'",1);

875 } ià(*
p
 == '\'') {

878 ià(*(
p
+1è&& !
	`is¥aû
(*Õ+1))è
”r
;

879 
dÚe
=1;

880 } ià(!*
p
) {

882 
”r
;

884 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

887 *
p
) {

893 
dÚe
=1;

896 
šq
=1;

899 
šsq
=1;

902 
cu¼’t
 = 
	`sdsÿ’
(cu¼’t,
p
,1);

906 ià(*
p
)…++;

909 
veùÜ
 = 
	`z»®loc
(veùÜ,((*
¬gc
)+1)*(*));

910 
veùÜ
[*
¬gc
] = 
cu¼’t
;

911 (*
¬gc
)++;

912 
cu¼’t
 = 
NULL
;

915 ià(
veùÜ
 =ğ
NULL
èveùÜ = 
	`zm®loc
((*));

916  
veùÜ
;

920 
”r
:

921 (*
¬gc
)--)

922 
	`sdsä“
(
veùÜ
[*
¬gc
]);

923 
	`zä“
(
veùÜ
);

924 ià(
cu¼’t
è
	`sdsä“
(current);

925 *
¬gc
 = 0;

926  
NULL
;

927 
	}
}

938 
sds
 
	$sdsm­ch¬s
(
sds
 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
) {

939 
size_t
 
j
, 
i
, 
l
 = 
	`sd¦’
(
s
);

941 
j
 = 0; j < 
l
; j++) {

942 
i
 = 0; i < 
£’
; i++) {

943 ià(
s
[
j
] =ğ
äom
[
i
]) {

944 
s
[
j
] = 
to
[
i
];

949  
s
;

950 
	}
}

954 
sds
 
	$sdsjoš
(**
¬gv
, 
¬gc
, *
£p
) {

955 
sds
 
još
 = 
	`sd£m±y
();

956 
j
;

958 
j
 = 0; j < 
¬gc
; j++) {

959 
još
 = 
	`sdsÿt
(još, 
¬gv
[
j
]);

960 ià(
j
 !ğ
¬gc
-1è
još
 = 
	`sdsÿt
(još,
£p
);

962  
još
;

963 
	}
}

965 #ifdeà
SDS_TEST_MAIN


966 
	~<¡dio.h
>

967 
	~"‹¡h–p.h
"

968 
	~"lim™s.h
"

970 
	$maš
() {

972 
sdshdr
 *
sh
;

973 
sds
 
x
 = 
	`sd¢ew
("foo"), 
y
;

975 
	`‹¡_cÚd
("Create‡ string‡nd obtainhe†ength",

976 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"foo\0",4) == 0)

978 
	`sdsä“
(
x
);

979 
x
 = 
	`sd¢ewËn
("foo",2);

980 
	`‹¡_cÚd
("Create‡ string with specified†ength",

981 
	`sd¦’
(
x
è=ğ2 && 
	`memcmp
(x,"fo\0",3) == 0)

983 
x
 = 
	`sdsÿt
(x,"bar");

984 
	`‹¡_cÚd
("Strings concatenation",

985 
	`sd¦’
(
x
è=ğ5 && 
	`memcmp
(x,"fobar\0",6) == 0);

987 
x
 = 
	`sdsıy
(x,"a");

988 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally†onger string",

989 
	`sd¦’
(
x
è=ğ1 && 
	`memcmp
(x,"a\0",2) == 0)

991 
x
 = 
	`sdsıy
(x,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk");

992 
	`‹¡_cÚd
("sdscpy()‡gainst‡n originally shorter string",

993 
	`sd¦’
(
x
) == 33 &&

994 
	`memcmp
(
x
,"xyzxxxxxxxxxxyyyyyyyyyykkkkkkkkkk\0",33) == 0)

996 
	`sdsä“
(
x
);

997 
x
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"%d",123);

998 
	`‹¡_cÚd
("sdscatprintf() seems working inhe base case",

999 
	`sd¦’
(
x
è=ğ3 && 
	`memcmp
(x,"123\0",4) == 0)

1001 
	`sdsä“
(
x
);

1002 
x
 = 
	`sd¢ew
("--");

1003 
x
 = 
	`sdsÿtfmt
(x, "H–lØ% WÜld %I,%I--", "Hi!", 
LLONG_MIN
,
LLONG_MAX
);

1004 
	`‹¡_cÚd
("sdscatfmt() seems working inhe base case",

1005 
	`sd¦’
(
x
) == 60 &&

1006 
	`memcmp
(
x
,"--Hello Hi! World -9223372036854775808,"

1009 
	`sdsä“
(
x
);

1010 
x
 = 
	`sd¢ew
("--");

1011 
x
 = 
	`sdsÿtfmt
(x, "%u,%U--", 
UINT_MAX
, 
ULLONG_MAX
);

1012 
	`‹¡_cÚd
("sdscatfmt() seems working with unsigned‚umbers",

1013 
	`sd¦’
(
x
) == 35 &&

1014 
	`memcmp
(
x
,"--4294967295,18446744073709551615--",35) == 0)

1016 
	`sdsä“
(
x
);

1017 
x
 = 
	`sd¢ew
("xxciaoyyy");

1018 
	`sd¡rim
(
x
,"xy");

1019 
	`‹¡_cÚd
("sdstrim() correctlyrims characters",

1020 
	`sd¦’
(
x
è=ğ4 && 
	`memcmp
(x,"ciao\0",5) == 0)

1022 
y
 = 
	`sdsdup
(
x
);

1023 
	`sd¤ªge
(
y
,1,1);

1024 
	`‹¡_cÚd
("sdsrange(...,1,1)",

1025 
	`sd¦’
(
y
è=ğ1 && 
	`memcmp
(y,"i\0",2) == 0)

1027 
	`sdsä“
(
y
);

1028 
y
 = 
	`sdsdup
(
x
);

1029 
	`sd¤ªge
(
y
,1,-1);

1030 
	`‹¡_cÚd
("sdsrange(...,1,-1)",

1031 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1033 
	`sdsä“
(
y
);

1034 
y
 = 
	`sdsdup
(
x
);

1035 
	`sd¤ªge
(
y
,-2,-1);

1036 
	`‹¡_cÚd
("sdsrange(...,-2,-1)",

1037 
	`sd¦’
(
y
è=ğ2 && 
	`memcmp
(y,"ao\0",3) == 0)

1039 
	`sdsä“
(
y
);

1040 
y
 = 
	`sdsdup
(
x
);

1041 
	`sd¤ªge
(
y
,2,1);

1042 
	`‹¡_cÚd
("sdsrange(...,2,1)",

1043 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1045 
	`sdsä“
(
y
);

1046 
y
 = 
	`sdsdup
(
x
);

1047 
	`sd¤ªge
(
y
,1,100);

1048 
	`‹¡_cÚd
("sdsrange(...,1,100)",

1049 
	`sd¦’
(
y
è=ğ3 && 
	`memcmp
(y,"iao\0",4) == 0)

1051 
	`sdsä“
(
y
);

1052 
y
 = 
	`sdsdup
(
x
);

1053 
	`sd¤ªge
(
y
,100,100);

1054 
	`‹¡_cÚd
("sdsrange(...,100,100)",

1055 
	`sd¦’
(
y
è=ğ0 && 
	`memcmp
(y,"\0",1) == 0)

1057 
	`sdsä“
(
y
);

1058 
	`sdsä“
(
x
);

1059 
x
 = 
	`sd¢ew
("foo");

1060 
y
 = 
	`sd¢ew
("foa");

1061 
	`‹¡_cÚd
("sdscmp(foo,fß)", 
	`sdscmp
(
x
,
y
) > 0)

1063 
	`sdsä“
(
y
);

1064 
	`sdsä“
(
x
);

1065 
x
 = 
	`sd¢ew
("bar");

1066 
y
 = 
	`sd¢ew
("bar");

1067 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) == 0)

1069 
	`sdsä“
(
y
);

1070 
	`sdsä“
(
x
);

1071 
x
 = 
	`sd¢ew
("aar");

1072 
y
 = 
	`sd¢ew
("bar");

1073 
	`‹¡_cÚd
("sdscmp(b¬,b¬)", 
	`sdscmp
(
x
,
y
) < 0)

1075 
	`sdsä“
(
y
);

1076 
	`sdsä“
(
x
);

1077 
x
 = 
	`sd¢ewËn
("\a\n\0foo\r",7);

1078 
y
 = 
	`sdsÿŒ•r
(
	`sd£m±y
(),
x
,
	`sd¦’
(x));

1079 
	`‹¡_cÚd
("sdscatrepr(...data...)",

1080 
	`memcmp
(
y
,"\"\\a\\n\\x00foo\\r\"",15) == 0)

1083 
Şdä“
;

1085 
	`sdsä“
(
x
);

1086 
x
 = 
	`sd¢ew
("0");

1087 
sh
 = (*è(
x
-((
sdshdr
)));

1088 
	`‹¡_cÚd
("sd¢ew(èä“/ËÀbufãrs", 
sh
->
Ën
 =ğ1 && sh->
ä“
 == 0);

1089 
x
 = 
	`sdsMakeRoomFÜ
(x,1);

1090 
sh
 = (*è(
x
-((
sdshdr
)));

1091 
	`‹¡_cÚd
("sdsMakeRoomFÜ()", 
sh
->
Ën
 =ğ1 && sh->
ä“
 > 0);

1092 
Şdä“
 = 
sh
->
ä“
;

1093 
x
[1] = '1';

1094 
	`sdsInüL’
(
x
,1);

1095 
	`‹¡_cÚd
("sdsInüL’(è-- cÚ‹Á", 
x
[0] == '0' && x[1] == '1');

1096 
	`‹¡_cÚd
("sdsInüL’(è--†’", 
sh
->
Ën
 == 2);

1097 
	`‹¡_cÚd
("sdsInüL’(è-- f»e", 
sh
->
ä“
 =ğ
Şdä“
-1);

1100 
	`‹¡_»pÜt
()

1102 
	}
}

	@sds.h

31 #iâdeà
__SDS_H


32 
	#__SDS_H


	)

34 
	#SDS_MAX_PREALLOC
 (1024*1024)

	)

36 
	~<sys/ty³s.h
>

37 
	~<¡d¬g.h
>

39 *
	tsds
;

41 
	ssdshdr
 {

42 
	mËn
;

43 
	mä“
;

44 
	mbuf
[];

47 
šlše
 
size_t
 
	$sd¦’
(cÚ¡ 
sds
 
s
) {

48 
sdshdr
 *
sh
 = (*)(
s
-((sdshdr)));

49  
sh
->
Ën
;

50 
	}
}

52 
šlše
 
size_t
 
	$sd§va
(cÚ¡ 
sds
 
s
) {

53 
sdshdr
 *
sh
 = (*)(
s
-((sdshdr)));

54  
sh
->
ä“
;

55 
	}
}

57 
sds
 
sd¢ewËn
(cÚ¡ *
š™
, 
size_t
 
š™Ën
);

58 
sds
 
sd¢ew
(cÚ¡ *
š™
);

59 
sds
 
sd£m±y
();

60 
size_t
 
sd¦’
(cÚ¡ 
sds
 
s
);

61 
sds
 
sdsdup
(cÚ¡ sd 
s
);

62 
sdsä“
(
sds
 
s
);

63 
size_t
 
sd§va
(cÚ¡ 
sds
 
s
);

64 
sds
 
sdsgrowz”o
(sd 
s
, 
size_t
 
Ën
);

65 
sds
 
sdsÿ’
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

66 
sds
 
sdsÿt
(sd 
s
, cÚ¡ *
t
);

67 
sds
 
sdsÿtsds
(sd 
s
, cÚ¡ sd 
t
);

68 
sds
 
sdsıyËn
(sd 
s
, cÚ¡ *
t
, 
size_t
 
Ën
);

69 
sds
 
sdsıy
(sd 
s
, cÚ¡ *
t
);

71 
sds
 
sdsÿtv´štf
(sd 
s
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

72 #ifdeà
__GNUC__


73 
sds
 
	$sdsÿrštf
(
sds
 
s
, cÚ¡ *
fmt
, ...)

74 
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

76 
sds
 
	`sdsÿrštf
(sd 
s
, cÚ¡ *
fmt
, ...);

79 
sds
 
	`sdsÿtfmt
(sd 
s
, cÚ¡ *
fmt
, ...);

80 
sds
 
	`sd¡rim
(sd 
s
, cÚ¡ *
c£t
);

81 
	`sd¤ªge
(
sds
 
s
, 
¡¬t
, 
’d
);

82 
	`sdsupd©–’
(
sds
 
s
);

83 
	`sdsş—r
(
sds
 
s
);

84 
	`sdscmp
(cÚ¡ 
sds
 
s1
, cÚ¡ sd 
s2
);

85 
sds
 *
	`sds¥l™Ën
(cÚ¡ *
s
, 
Ën
, cÚ¡ *
£p
, 
£¶’
, *
couÁ
);

86 
	`sdsä“¥l™»s
(
sds
 *
tok’s
, 
couÁ
);

87 
	`sd¡Şow”
(
sds
 
s
);

88 
	`sd¡ouµ”
(
sds
 
s
);

89 
sds
 
	`sdsäomlÚglÚg
(
v®ue
);

90 
sds
 
	`sdsÿŒ•r
(sd 
s
, cÚ¡ *
p
, 
size_t
 
Ën
);

91 
sds
 *
	`sds¥l™¬gs
(cÚ¡ *
lše
, *
¬gc
);

92 
sds
 
	`sdsm­ch¬s
(sd 
s
, cÚ¡ *
äom
, cÚ¡ *
to
, 
size_t
 
£’
);

93 
sds
 
	`sdsjoš
(**
¬gv
, 
¬gc
, *
£p
);

96 
sds
 
	`sdsMakeRoomFÜ
(sd 
s
, 
size_t
 
addËn
);

97 
	`sdsInüL’
(
sds
 
s
, 
šü
);

98 
sds
 
	`sdsRemoveF»eS·û
(sd 
s
);

99 
size_t
 
	`sdsAÎocSize
(
sds
 
s
);

	@sentinel.c

31 
	~"»dis.h
"

32 
	~"hœedis.h
"

33 
	~"async.h
"

35 
	~<ùy³.h
>

36 
	~<¬·/š‘.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/wa™.h
>

39 
	~<fú.h
>

41 **
’vœÚ
;

43 
	#REDIS_SENTINEL_PORT
 26379

	)

48 
	s£Áš–Addr
 {

49 *
	m
;

50 
	mpÜt
;

51 } 
	t£Áš–Addr
;

54 
	#SRI_MASTER
 (1<<0)

	)

55 
	#SRI_SLAVE
 (1<<1)

	)

56 
	#SRI_SENTINEL
 (1<<2)

	)

57 
	#SRI_DISCONNECTED
 (1<<3)

	)

58 
	#SRI_S_DOWN
 (1<<4è

	)

59 
	#SRI_O_DOWN
 (1<<5è

	)

60 
	#SRI_MASTER_DOWN
 (1<<6è

	)

62 
	#SRI_FAILOVER_IN_PROGRESS
 (1<<7è

	)

64 
	#SRI_PROMOTED
 (1<<8è

	)

65 
	#SRI_RECONF_SENT
 (1<<9è

	)

66 
	#SRI_RECONF_INPROG
 (1<<10è

	)

67 
	#SRI_RECONF_DONE
 (1<<11è

	)

68 
	#SRI_FORCE_FAILOVER
 (1<<12è

	)

69 
	#SRI_SCRIPT_KILL_SENT
 (1<<13è

	)

72 
	#SENTINEL_INFO_PERIOD
 10000

	)

73 
	#SENTINEL_PING_PERIOD
 1000

	)

74 
	#SENTINEL_ASK_PERIOD
 1000

	)

75 
	#SENTINEL_PUBLISH_PERIOD
 2000

	)

76 
	#SENTINEL_DEFAULT_DOWN_AFTER
 30000

	)

77 
	#SENTINEL_HELLO_CHANNEL
 "__£Áš–__:h–lo"

	)

78 
	#SENTINEL_TILT_TRIGGER
 2000

	)

79 
	#SENTINEL_TILT_PERIOD
 (
SENTINEL_PING_PERIOD
*30)

	)

80 
	#SENTINEL_DEFAULT_SLAVE_PRIORITY
 100

	)

81 
	#SENTINEL_SLAVE_RECONF_TIMEOUT
 10000

	)

82 
	#SENTINEL_DEFAULT_PARALLEL_SYNCS
 1

	)

83 
	#SENTINEL_MIN_LINK_RECONNECT_PERIOD
 15000

	)

84 
	#SENTINEL_DEFAULT_FAILOVER_TIMEOUT
 (60*3*1000)

	)

85 
	#SENTINEL_MAX_PENDING_COMMANDS
 100

	)

86 
	#SENTINEL_ELECTION_TIMEOUT
 10000

	)

87 
	#SENTINEL_MAX_DESYNC
 1000

	)

90 
	#SENTINEL_FAILOVER_STATE_NONE
 0

	)

91 
	#SENTINEL_FAILOVER_STATE_WAIT_START
 1

	)

92 
	#SENTINEL_FAILOVER_STATE_SELECT_SLAVE
 2

	)

93 
	#SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
 3

	)

94 
	#SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
 4

	)

95 
	#SENTINEL_FAILOVER_STATE_RECONF_SLAVES
 5

	)

96 
	#SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
 6

	)

98 
	#SENTINEL_MASTER_LINK_STATUS_UP
 0

	)

99 
	#SENTINEL_MASTER_LINK_STATUS_DOWN
 1

	)

104 
	#SENTINEL_NO_FLAGS
 0

	)

105 
	#SENTINEL_GENERATE_EVENT
 (1<<16)

	)

106 
	#SENTINEL_LEADER
 (1<<17)

	)

107 
	#SENTINEL_OBSERVER
 (1<<18)

	)

110 
	#SENTINEL_SCRIPT_NONE
 0

	)

111 
	#SENTINEL_SCRIPT_RUNNING
 1

	)

112 
	#SENTINEL_SCRIPT_MAX_QUEUE
 256

	)

113 
	#SENTINEL_SCRIPT_MAX_RUNNING
 16

	)

114 
	#SENTINEL_SCRIPT_MAX_RUNTIME
 60000

	)

115 
	#SENTINEL_SCRIPT_MAX_RETRY
 10

	)

116 
	#SENTINEL_SCRIPT_RETRY_DELAY
 30000

	)

118 
	s£Áš–RedisIn¡ªû
 {

119 
	mæags
;

120 *
	mÇme
;

121 *
	mrunid
;

122 
ušt64_t
 
	mcÚfig_•och
;

123 
£Áš–Addr
 *
	maddr
;

124 
»disAsyncCÚ‹xt
 *
	mcc
;

125 
»disAsyncCÚ‹xt
 *
	mpc
;

126 
	m³ndšg_commªds
;

127 
m¡ime_t
 
	mcc_cÚn_time
;

128 
m¡ime_t
 
	mpc_cÚn_time
;

129 
m¡ime_t
 
	mpc_Ï¡_aùiv™y
;

130 
m¡ime_t
 
	mÏ¡_ava_time
;

132 
m¡ime_t
 
	mÏ¡_pšg_time
;

136 
m¡ime_t
 
	mÏ¡_pÚg_time
;

139 
m¡ime_t
 
	mÏ¡_pub_time
;

140 
m¡ime_t
 
	mÏ¡_h–lo_time
;

143 
m¡ime_t
 
	mÏ¡_ma¡”_down_»¶y_time
;

145 
m¡ime_t
 
	ms_down_sšû_time
;

146 
m¡ime_t
 
	mo_down_sšû_time
;

147 
m¡ime_t
 
	mdown_aá”_³riod
;

148 
m¡ime_t
 
	mšfo_»äesh
;

155 
	mrŞe_»pÜ‹d
;

156 
m¡ime_t
 
	mrŞe_»pÜ‹d_time
;

157 
m¡ime_t
 
	m¦ave_cÚf_chªge_time
;

160 
diù
 *
	m£Áš–s
;

161 
diù
 *
	m¦aves
;

162 
	mquÜum
;

163 
	m·¿Î–_syncs
;

164 *
	mauth_·ss
;

167 
m¡ime_t
 
	mma¡”_lšk_down_time
;

168 
	m¦ave_´iÜ™y
;

169 
m¡ime_t
 
	m¦ave_»cÚf_£Á_time
;

170 
£Áš–RedisIn¡ªû
 *
	mma¡”
;

171 *
	m¦ave_ma¡”_ho¡
;

172 
	m¦ave_ma¡”_pÜt
;

173 
	m¦ave_ma¡”_lšk_¡©us
;

174 
	m¦ave_»¶_off£t
;

176 *
	mËad”
;

180 
ušt64_t
 
	mËad”_•och
;

181 
ušt64_t
 
	mçov”_•och
;

182 
	mçov”_¡©e
;

183 
m¡ime_t
 
	mçov”_¡©e_chªge_time
;

184 
m¡ime_t
 
	mçov”_¡¬t_time
;

185 
m¡ime_t
 
	mçov”_timeout
;

186 
m¡ime_t
 
	mçov”_d–ay_logged
;

188 
£Áš–RedisIn¡ªû
 *
	m´omÙed_¦ave
;

191 *
	mnÙifiÿtiÚ_süt
;

192 *
	mş›Á_»cÚfig_süt
;

193 } 
	t£Áš–RedisIn¡ªû
;

196 
	s£Áš–S‹
 {

197 
ušt64_t
 
	mcu¼’t_•och
;

198 
diù
 *
	mma¡”s
;

201 
	mtt
;

202 
	mruÂšg_süts
;

203 
m¡ime_t
 
	mtt_¡¬t_time
;

204 
m¡ime_t
 
	m´evious_time
;

205 
li¡
 *
	msüts_queue
;

206 *
	mªnounû_
;

208 
	mªnounû_pÜt
;

210 } 
	g£Áš–
;

213 
	s£Áš–SütJob
 {

214 
	mæags
;

215 
	m»Œy_num
;

216 **
	m¬gv
;

217 
m¡ime_t
 
	m¡¬t_time
;

222 
pid_t
 
	mpid
;

223 } 
	t£Áš–SütJob
;

230 
	s»disAeEv’ts
 {

231 
»disAsyncCÚ‹xt
 *
	mcÚ‹xt
;

232 
«Ev’tLoİ
 *
	mloİ
;

233 
	mfd
;

234 
	m»adšg
, 
	mwr™šg
;

235 } 
	t»disAeEv’ts
;

237 
	$»disAeR—dEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

238 (()
–
); (()
fd
); (()
mask
);

240 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

241 
	`»disAsyncHªdËR—d
(
e
->
cÚ‹xt
);

242 
	}
}

244 
	$»disAeWr™eEv’t
(
«Ev’tLoİ
 *
–
, 
fd
, *
´ivd©a
, 
mask
) {

245 (()
–
); (()
fd
); (()
mask
);

247 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

248 
	`»disAsyncHªdËWr™e
(
e
->
cÚ‹xt
);

249 
	}
}

251 
	$»disAeAddR—d
(*
´ivd©a
) {

252 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

253 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

254 ià(!
e
->
»adšg
) {

255 
e
->
»adšg
 = 1;

256 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
,
»disAeR—dEv’t
,e);

258 
	}
}

260 
	$»disAeD–R—d
(*
´ivd©a
) {

261 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

262 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

263 ià(
e
->
»adšg
) {

264 
e
->
»adšg
 = 0;

265 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_READABLE
);

267 
	}
}

269 
	$»disAeAddWr™e
(*
´ivd©a
) {

270 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

271 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

272 ià(!
e
->
wr™šg
) {

273 
e
->
wr™šg
 = 1;

274 
	`«C»©eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
,
»disAeWr™eEv’t
,e);

276 
	}
}

278 
	$»disAeD–Wr™e
(*
´ivd©a
) {

279 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

280 
«Ev’tLoİ
 *
loİ
 = 
e
->loop;

281 ià(
e
->
wr™šg
) {

282 
e
->
wr™šg
 = 0;

283 
	`«D–‘eFeEv’t
(
loİ
,
e
->
fd
,
AE_WRITABLE
);

285 
	}
}

287 
	$»disAeCËªup
(*
´ivd©a
) {

288 
»disAeEv’ts
 *
e
 = (»disAeEv’ts*)
´ivd©a
;

289 
	`»disAeD–R—d
(
´ivd©a
);

290 
	`»disAeD–Wr™e
(
´ivd©a
);

291 
	`zä“
(
e
);

292 
	}
}

294 
	$»disAeA‰ach
(
«Ev’tLoİ
 *
loİ
, 
»disAsyncCÚ‹xt
 *
ac
) {

295 
»disCÚ‹xt
 *
c
 = &(
ac
->c);

296 
»disAeEv’ts
 *
e
;

299 ià(
ac
->
ev
.
d©a
 !ğ
NULL
)

300  
REDIS_ERR
;

303 
e
 = (
»disAeEv’ts
*)
	`zm®loc
((*e));

304 
e
->
cÚ‹xt
 = 
ac
;

305 
e
->
loİ
 =†oop;

306 
e
->
fd
 = 
c
->fd;

307 
e
->
»adšg
 =ƒ->
wr™šg
 = 0;

310 
ac
->
ev
.
addR—d
 = 
»disAeAddR—d
;

311 
ac
->
ev
.
d–R—d
 = 
»disAeD–R—d
;

312 
ac
->
ev
.
addWr™e
 = 
»disAeAddWr™e
;

313 
ac
->
ev
.
d–Wr™e
 = 
»disAeD–Wr™e
;

314 
ac
->
ev
.
ş—nup
 = 
»disAeCËªup
;

315 
ac
->
ev
.
d©a
 = 
e
;

317  
REDIS_OK
;

318 
	}
}

322 
£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

323 
£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
);

324 
£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

325 
£Áš–RedisIn¡ªû
 *
£Áš–G‘Ma¡”ByName
(*
Çme
);

326 *
£Áš–G‘SubjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

327 *
£Áš–G‘ObjeùiveL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

328 
ye¢Ùoi
(*
s
);

329 
£Áš–DiscÚÃùIn¡ªûFromCÚ‹xt
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
);

330 
£Áš–KlLšk
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
);

331 cÚ¡ *
£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
);

332 
£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
);

333 
£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
fmt
, ...);

334 
£Áš–RedisIn¡ªû
 *
£Áš–S–eùSÏve
(£Áš–RedisIn¡ªû *
ma¡”
);

335 
£Áš–ScheduËSütExecutiÚ
(*
·th
, ...);

336 
£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

337 
£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
);

338 
£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
);

339 *
£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
);

340 
£Áš–FlushCÚfig
();

341 
£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

342 
£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
);

343 
£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
);

347 
diùSdsHash
(cÚ¡ *
key
);

348 
diùSdsKeyCom·»
(*
´ivd©a
, cÚ¡ *
key1
, cÚ¡ *
key2
);

349 
»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
);

351 
	$diùIn¡ªûsV®De¡ruùÜ
 (*
´ivd©a
, *
obj
) {

352 
	`REDIS_NOTUSED
(
´ivd©a
);

353 
	`»Ëa£S’tš–RedisIn¡ªû
(
obj
);

354 
	}
}

360 
diùTy³
 
	gš¡ªûsDiùTy³
 = {

361 
diùSdsHash
,

362 
NULL
,

363 
NULL
,

364 
diùSdsKeyCom·»
,

365 
NULL
,

366 
diùIn¡ªûsV®De¡ruùÜ


373 
diùTy³
 
	gËad”VÙesDiùTy³
 = {

374 
diùSdsHash
,

375 
NULL
,

376 
NULL
,

377 
diùSdsKeyCom·»
,

378 
NULL
,

379 
NULL


384 
£Áš–Commªd
(
»disCl›Á
 *
c
);

385 
£Áš–InfoCommªd
(
»disCl›Á
 *
c
);

386 
£Áš–S‘Commªd
(
»disCl›Á
 *
c
);

387 
£Áš–PublishCommªd
(
»disCl›Á
 *
c
);

388 
£Áš–RŞeCommªd
(
»disCl›Á
 *
c
);

390 
»disCommªd
 
	g£Áš–cmds
[] = {

391 {"pšg",
pšgCommªd
,1,"",0,
NULL
,0,0,0,0,0},

392 {"£Áš–",
£Áš–Commªd
,-2,"",0,
NULL
,0,0,0,0,0},

393 {"subsüibe",
subsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

394 {"unsubsüibe",
unsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

395 {"psubsüibe",
psubsüibeCommªd
,-2,"",0,
NULL
,0,0,0,0,0},

396 {"punsubsüibe",
punsubsüibeCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

397 {"publish",
£Áš–PublishCommªd
,3,"",0,
NULL
,0,0,0,0,0},

398 {"šfo",
£Áš–InfoCommªd
,-1,"",0,
NULL
,0,0,0,0,0},

399 {"rŞe",
£Áš–RŞeCommªd
,1,"l",0,
NULL
,0,0,0,0,0},

400 {"ş›Á",
ş›ÁCommªd
,-2,"rs",0,
NULL
,0,0,0,0,0},

401 {"shutdown",
shutdownCommªd
,-1,"",0,
NULL
,0,0,0,0,0}

406 
	$š™S’tš–CÚfig
() {

407 
£rv”
.
pÜt
 = 
REDIS_SENTINEL_PORT
;

408 
	}
}

411 
	$š™S’tš–
() {

412 
j
;

416 
	`diùEm±y
(
£rv”
.
commªds
,
NULL
);

417 
j
 = 0; j < (
£Áš–cmds
)/(sentinelcmds[0]); j++) {

418 
»tv®
;

419 
»disCommªd
 *
cmd
 = 
£Áš–cmds
+
j
;

421 
»tv®
 = 
	`diùAdd
(
£rv”
.
commªds
, 
	`sd¢ew
(
cmd
->
Çme
), cmd);

422 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

426 
£Áš–
.
cu¼’t_•och
 = 0;

427 
£Áš–
.
ma¡”s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

428 
£Áš–
.
tt
 = 0;

429 
£Áš–
.
tt_¡¬t_time
 = 0;

430 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

431 
£Áš–
.
ruÂšg_süts
 = 0;

432 
£Áš–
.
süts_queue
 = 
	`li¡C»©e
();

433 
£Áš–
.
ªnounû_
 = 
NULL
;

434 
£Áš–
.
ªnounû_pÜt
 = 0;

435 
	}
}

439 
	$£Áš–IsRuÂšg
() {

440 
	`»disLog
(
REDIS_WARNING
,"S’tš–„unid i %s", 
£rv”
.
runid
);

442 ià(
£rv”
.
cÚfigfe
 =ğ
NULL
) {

443 
	`»disLog
(
REDIS_WARNING
,

445 
	`ex™
(1);

446 } ià(
	`acûss
(
£rv”
.
cÚfigfe
,
W_OK
) == -1) {

447 
	`»disLog
(
REDIS_WARNING
,

449 
£rv”
.
cÚfigfe
,
	`¡»¼Ü
(
”ºo
));

450 
	`ex™
(1);

455 
	`£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
();

456 
	}
}

465 
£Áš–Addr
 *
	$ü—‹S’tš–Addr
(*
ho¡Çme
, 
pÜt
) {

466 

[
REDIS_IP_STR_LEN
];

467 
£Áš–Addr
 *
§
;

469 ià(
pÜt
 <= 0 ||…ort > 65535) {

470 
”ºo
 = 
EINVAL
;

471  
NULL
;

473 ià(
	`ª‘ResŞve
(
NULL
,
ho¡Çme
,

,()è=ğ
ANET_ERR
) {

474 
”ºo
 = 
ENOENT
;

475  
NULL
;

477 
§
 = 
	`zm®loc
((*sa));

478 
§
->

 = 
	`sd¢ew
(ip);

479 
§
->
pÜt
 =…ort;

480  
§
;

481 
	}
}

484 
£Áš–Addr
 *
	$dupS’tš–Addr
(
£Áš–Addr
 *
¤c
) {

485 
£Áš–Addr
 *
§
;

487 
§
 = 
	`zm®loc
((*sa));

488 
§
->

 = 
	`sd¢ew
(
¤c
->ip);

489 
§
->
pÜt
 = 
¤c
->port;

490  
§
;

491 
	}
}

494 
	$»Ëa£S’tš–Addr
(
£Áš–Addr
 *
§
) {

495 
	`sdsä“
(
§
->

);

496 
	`zä“
(
§
);

497 
	}
}

500 
	$£Áš–AddrIsEqu®
(
£Áš–Addr
 *
a
, s’tš–Add¸*
b
) {

501  
a
->
pÜt
 =ğ
b
->pÜˆ&& !
	`¡rÿ£cmp
×->

,b->ip);

502 
	}
}

530 
	$£Áš–Ev’t
(
Ëv–
, *
ty³
, 
£Áš–RedisIn¡ªû
 *
ri
,

531 cÚ¡ *
fmt
, ...) {

532 
va_li¡
 
­
;

533 
msg
[
REDIS_MAX_LOGMSG_LEN
];

534 
robj
 *
chªÃl
, *
·ylßd
;

537 ià(
fmt
[0] == '%' && fmt[1] == '@') {

538 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

539 
NULL
 : 
ri
->
ma¡”
;

541 ià(
ma¡”
) {

542 
	`¢´štf
(
msg
, (msg), "%s %s %s %d @ %s %s %d",

543 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

544 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
,

545 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
);

547 
	`¢´štf
(
msg
, (msg), "%s %s %s %d",

548 
	`£Áš–RedisIn¡ªûTy³SŒ
(
ri
),

549 
ri
->
Çme
,„i->
addr
->

,„i->addr->
pÜt
);

551 
fmt
 += 2;

553 
msg
[0] = '\0';

557 ià(
fmt
[0] != '\0') {

558 
	`va_¡¬t
(
­
, 
fmt
);

559 
	`v¢´štf
(
msg
+
	`¡¾’
(msg), (msg)-¡¾’(msg), 
fmt
, 
­
);

560 
	`va_’d
(
­
);

564 ià(
Ëv–
 >ğ
£rv”
.
v”bos™y
)

565 
	`»disLog
(
Ëv–
,"% %s",
ty³
,
msg
);

568 ià(
Ëv–
 !ğ
REDIS_DEBUG
) {

569 
chªÃl
 = 
	`ü—‹SŒšgObjeù
(
ty³
,
	`¡¾’
(type));

570 
·ylßd
 = 
	`ü—‹SŒšgObjeù
(
msg
,
	`¡¾’
(msg));

571 
	`pubsubPublishMes§ge
(
chªÃl
,
·ylßd
);

572 
	`deüRefCouÁ
(
chªÃl
);

573 
	`deüRefCouÁ
(
·ylßd
);

577 ià(
Ëv–
 =ğ
REDIS_WARNING
 && 
ri
 !ğ
NULL
) {

578 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?

579 
ri
 :„i->
ma¡”
;

580 ià(
ma¡”
->
nÙifiÿtiÚ_süt
) {

581 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
nÙifiÿtiÚ_süt
,

582 
ty³
,
msg
,
NULL
);

585 
	}
}

591 
	$£Áš–G’”©eIn™ŸlMÚ™ÜEv’ts
() {

592 
diùI‹¿tÜ
 *
di
;

593 
diùEÁry
 *
de
;

595 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

596 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

597 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

598 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

600 
	`diùR–—£I‹¿tÜ
(
di
);

601 
	}
}

606 
	$£Áš–R–—£SütJob
(
£Áš–SütJob
 *
sj
) {

607 
j
 = 0;

609 
sj
->
¬gv
[
j
]è
	`sdsä“
(sj->argv[j++]);

610 
	`zä“
(
sj
->
¬gv
);

611 
	`zä“
(
sj
);

612 
	}
}

614 
	#SENTINEL_SCRIPT_MAX_ARGS
 16

	)

615 
	$£Áš–ScheduËSütExecutiÚ
(*
·th
, ...) {

616 
va_li¡
 
­
;

617 *
¬gv
[
SENTINEL_SCRIPT_MAX_ARGS
+1];

618 
¬gc
 = 1;

619 
£Áš–SütJob
 *
sj
;

621 
	`va_¡¬t
(
­
, 
·th
);

622 
¬gc
 < 
SENTINEL_SCRIPT_MAX_ARGS
) {

623 
¬gv
[
¬gc
] = 
	`va_¬g
(
­
,*);

624 ià(!
¬gv
[
¬gc
]) ;

625 
¬gv
[
¬gc
] = 
	`sd¢ew
(argv[argc]);

626 
¬gc
++;

628 
	`va_’d
(
­
);

629 
¬gv
[0] = 
	`sd¢ew
(
·th
);

631 
sj
 = 
	`zm®loc
((*sj));

632 
sj
->
æags
 = 
SENTINEL_SCRIPT_NONE
;

633 
sj
->
»Œy_num
 = 0;

634 
sj
->
¬gv
 = 
	`zm®loc
((*)*(
¬gc
+1));

635 
sj
->
¡¬t_time
 = 0;

636 
sj
->
pid
 = 0;

637 
	`memıy
(
sj
->
¬gv
,¬gv,(*)*(
¬gc
+1));

639 
	`li¡AddNodeTa
(
£Áš–
.
süts_queue
,
sj
);

642 ià(
	`li¡L’gth
(
£Áš–
.
süts_queue
è> 
SENTINEL_SCRIPT_MAX_QUEUE
) {

643 
li¡Node
 *
Ê
;

644 
li¡I‹r
 
li
;

646 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

647 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

648 
sj
 = 
Ê
->
v®ue
;

650 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

652 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

653 
	`£Áš–R–—£SütJob
(
sj
);

656 
	`»disAs£¹
(
	`li¡L’gth
(
£Áš–
.
süts_queue
) <=

657 
SENTINEL_SCRIPT_MAX_QUEUE
);

659 
	}
}

663 
li¡Node
 *
	$£Áš–G‘SütLi¡NodeByPid
(
pid_t
 
pid
) {

664 
li¡Node
 *
Ê
;

665 
li¡I‹r
 
li
;

667 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

668 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

669 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

671 ià((
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
è&& sj->
pid
 ==…id)

672  
Ê
;

674  
NULL
;

675 
	}
}

679 
	$£Áš–RunP’dšgSüts
() {

680 
li¡Node
 *
Ê
;

681 
li¡I‹r
 
li
;

682 
m¡ime_t
 
now
 = 
	`m¡ime
();

686 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

687 
£Áš–
.
ruÂšg_süts
 < 
SENTINEL_SCRIPT_MAX_RUNNING
 &&

688 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
)

690 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

691 
pid_t
 
pid
;

694 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ;

697 ià(
sj
->
¡¬t_time
 && sj->¡¬t_tim> 
now
) ;

699 
sj
->
æags
 |ğ
SENTINEL_SCRIPT_RUNNING
;

700 
sj
->
¡¬t_time
 = 
	`m¡ime
();

701 
sj
->
»Œy_num
++;

702 
pid
 = 
	`fÜk
();

704 ià(
pid
 == -1) {

708 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-süt-”rÜ",
NULL
,

709 "% %d %d", 
sj
->
¬gv
[0], 99, 0);

710 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

711 
sj
->
pid
 = 0;

712 } ià(
pid
 == 0) {

714 
	`execve
(
sj
->
¬gv
[0],sj->¬gv,
’vœÚ
);

716 
	`_ex™
(2);

718 
£Áš–
.
ruÂšg_süts
++;

719 
sj
->
pid
 =…id;

720 
	`£Áš–Ev’t
(
REDIS_DEBUG
,"+süt-chd",
NULL
,"%ld",()
pid
);

723 
	}
}

732 
m¡ime_t
 
	$£Áš–SütR‘ryD–ay
(
»Œy_num
) {

733 
m¡ime_t
 
d–ay
 = 
SENTINEL_SCRIPT_RETRY_DELAY
;

735 
»Œy_num
-- > 1è
d–ay
 *= 2;

736  
d–ay
;

737 
	}
}

743 
	$£Áš–CŞËùT”mš©edSüts
() {

744 
¡©loc
;

745 
pid_t
 
pid
;

747 (
pid
 = 
	`wa™3
(&
¡©loc
,
WNOHANG
,
NULL
)) > 0) {

748 
ex™code
 = 
	`WEXITSTATUS
(
¡©loc
);

749 
bysigÇl
 = 0;

750 
li¡Node
 *
Ê
;

751 
£Áš–SütJob
 *
sj
;

753 ià(
	`WIFSIGNALED
(
¡©loc
)è
bysigÇl
 = 
	`WTERMSIG
(statloc);

754 
	`£Áš–Ev’t
(
REDIS_DEBUG
,"-süt-chd",
NULL
,"%ld %d %d",

755 ()
pid
, 
ex™code
, 
bysigÇl
);

757 
Ê
 = 
	`£Áš–G‘SütLi¡NodeByPid
(
pid
);

758 ià(
Ê
 =ğ
NULL
) {

759 
	`»disLog
(
REDIS_WARNING
,"wa™3(è»tuºed‡…id (%ldèwÿn'ˆfšd iÀou¸süt executiÚ queue!", ()
pid
);

762 
sj
 = 
Ê
->
v®ue
;

767 ià((
bysigÇl
 || 
ex™code
 == 1) &&

768 
sj
->
»Œy_num
 !ğ
SENTINEL_SCRIPT_MAX_RETRY
)

770 
sj
->
æags
 &ğ~
SENTINEL_SCRIPT_RUNNING
;

771 
sj
->
pid
 = 0;

772 
sj
->
¡¬t_time
 = 
	`m¡ime
() +

773 
	`£Áš–SütR‘ryD–ay
(
sj
->
»Œy_num
);

777 ià(
bysigÇl
 || 
ex™code
 != 0) {

778 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-süt-”rÜ",
NULL
,

779 "% %d %d", 
sj
->
¬gv
[0], 
bysigÇl
, 
ex™code
);

781 
	`li¡D–Node
(
£Áš–
.
süts_queue
,
Ê
);

782 
	`£Áš–R–—£SütJob
(
sj
);

783 
£Áš–
.
ruÂšg_süts
--;

786 
	}
}

790 
	$£Áš–KlTimedoutSüts
() {

791 
li¡Node
 *
Ê
;

792 
li¡I‹r
 
li
;

793 
m¡ime_t
 
now
 = 
	`m¡ime
();

795 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

796 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

797 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

799 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
 &&

800 (
now
 - 
sj
->
¡¬t_time
è> 
SENTINEL_SCRIPT_MAX_RUNTIME
)

802 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-süt-timeout",
NULL
,"%s %ld",

803 
sj
->
¬gv
[0], ()sj->
pid
);

804 
	`kl
(
sj
->
pid
,
SIGKILL
);

807 
	}
}

810 
	$£Áš–P’dšgSütsCommªd
(
»disCl›Á
 *
c
) {

811 
li¡Node
 *
Ê
;

812 
li¡I‹r
 
li
;

814 
	`addR•lyMuÉiBulkL’
(
c
,
	`li¡L’gth
(
£Áš–
.
süts_queue
));

815 
	`li¡Rewšd
(
£Áš–
.
süts_queue
,&
li
);

816 (
Ê
 = 
	`li¡Next
(&
li
)è!ğ
NULL
) {

817 
£Áš–SütJob
 *
sj
 = 
Ê
->
v®ue
;

818 
j
 = 0;

820 
	`addR•lyMuÉiBulkL’
(
c
,10);

822 
	`addR•lyBulkCSŒšg
(
c
,"argv");

823 
sj
->
¬gv
[
j
]) j++;

824 
	`addR•lyMuÉiBulkL’
(
c
,
j
);

825 
j
 = 0;

826 
sj
->
¬gv
[
j
]è
	`addR•lyBulkCSŒšg
(
c
,sj->argv[j++]);

828 
	`addR•lyBulkCSŒšg
(
c
,"flags");

829 
	`addR•lyBulkCSŒšg
(
c
,

830 (
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) ? "running" : "scheduled");

832 
	`addR•lyBulkCSŒšg
(
c
,"pid");

833 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
pid
);

835 ià(
sj
->
æags
 & 
SENTINEL_SCRIPT_RUNNING
) {

836 
	`addR•lyBulkCSŒšg
(
c
,"run-time");

837 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
sj
->
¡¬t_time
);

839 
m¡ime_t
 
d–ay
 = 
sj
->
¡¬t_time
 ? (sj->¡¬t_time-
	`m¡ime
()) : 0;

840 ià(
d–ay
 < 0) delay = 0;

841 
	`addR•lyBulkCSŒšg
(
c
,"run-delay");

842 
	`addR•lyBulkLÚgLÚg
(
c
,
d–ay
);

845 
	`addR•lyBulkCSŒšg
(
c
,"retry-num");

846 
	`addR•lyBulkLÚgLÚg
(
c
,
sj
->
»Œy_num
);

848 
	}
}

862 
	$£Áš–C®lCl›ÁRecÚfSüt
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
rŞe
, *
¡©e
, 
£Áš–Addr
 *
äom
, s’tš–Add¸*
to
) {

863 
äompÜt
[32], 
tİÜt
[32];

865 ià(
ma¡”
->
ş›Á_»cÚfig_süt
 =ğ
NULL
) ;

866 
	`Î2¡ršg
(
äompÜt
,(äompÜt),
äom
->
pÜt
);

867 
	`Î2¡ršg
(
tİÜt
,ÑİÜt),
to
->
pÜt
);

868 
	`£Áš–ScheduËSütExecutiÚ
(
ma¡”
->
ş›Á_»cÚfig_süt
,

869 
ma¡”
->
Çme
,

870 (
rŞe
 =ğ
SENTINEL_LEADER
) ? "leader" : "observer",

871 
¡©e
, 
äom
->

, 
äompÜt
, 
to
->, 
tİÜt
, 
NULL
);

872 
	}
}

896 
£Áš–RedisIn¡ªû
 *
	$ü—‹S’tš–RedisIn¡ªû
(*
Çme
, 
æags
, *
ho¡Çme
, 
pÜt
, 
quÜum
, 
£Áš–RedisIn¡ªû
 *
ma¡”
) {

897 
£Áš–RedisIn¡ªû
 *
ri
;

898 
£Áš–Addr
 *
addr
;

899 
diù
 *
bË
 = 
NULL
;

900 
¦av’ame
[128], *
sd¢ame
;

902 
	`»disAs£¹
(
æags
 & (
SRI_MASTER
|
SRI_SLAVE
|
SRI_SENTINEL
));

903 
	`»disAs£¹
((
æags
 & 
SRI_MASTER
è|| 
ma¡”
 !ğ
NULL
);

906 
addr
 = 
	`ü—‹S’tš–Addr
(
ho¡Çme
,
pÜt
);

907 ià(
addr
 =ğ
NULL
)  NULL;

910 ià(
æags
 & (
SRI_SLAVE
|
SRI_SENTINEL
)) {

911 
	`¢´štf
(
¦av’ame
,(slavename),

912 
	`¡rchr
(
ho¡Çme
,':') ? "[%s]:%d" : "%s:%d",

913 
ho¡Çme
,
pÜt
);

914 
Çme
 = 
¦av’ame
;

921 ià(
æags
 & 
SRI_MASTER
è
bË
 = 
£Áš–
.
ma¡”s
;

922 ià(
æags
 & 
SRI_SLAVE
è
bË
 = 
ma¡”
->
¦aves
;

923 ià(
æags
 & 
SRI_SENTINEL
è
bË
 = 
ma¡”
->
£Áš–s
;

924 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

925 ià(
	`diùFšd
(
bË
,
sd¢ame
)) {

926 
	`sdsä“
(
sd¢ame
);

927 
”ºo
 = 
EBUSY
;

928  
NULL
;

932 
ri
 = 
	`zm®loc
((*ri));

935 
ri
->
æags
 = fÏg | 
SRI_DISCONNECTED
;

936 
ri
->
Çme
 = 
sd¢ame
;

937 
ri
->
runid
 = 
NULL
;

938 
ri
->
cÚfig_•och
 = 0;

939 
ri
->
addr
 =‡ddr;

940 
ri
->
cc
 = 
NULL
;

941 
ri
->
pc
 = 
NULL
;

942 
ri
->
³ndšg_commªds
 = 0;

943 
ri
->
cc_cÚn_time
 = 0;

944 
ri
->
pc_cÚn_time
 = 0;

945 
ri
->
pc_Ï¡_aùiv™y
 = 0;

950 
ri
->
Ï¡_pšg_time
 = 
	`m¡ime
();

951 
ri
->
Ï¡_ava_time
 = 
	`m¡ime
();

952 
ri
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

953 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

954 
ri
->
Ï¡_h–lo_time
 = 
	`m¡ime
();

955 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

956 
ri
->
s_down_sšû_time
 = 0;

957 
ri
->
o_down_sšû_time
 = 0;

958 
ri
->
down_aá”_³riod
 = 
ma¡”
 ? master->down_after_period :

959 
SENTINEL_DEFAULT_DOWN_AFTER
;

960 
ri
->
ma¡”_lšk_down_time
 = 0;

961 
ri
->
auth_·ss
 = 
NULL
;

962 
ri
->
¦ave_´iÜ™y
 = 
SENTINEL_DEFAULT_SLAVE_PRIORITY
;

963 
ri
->
¦ave_»cÚf_£Á_time
 = 0;

964 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

965 
ri
->
¦ave_ma¡”_pÜt
 = 0;

966 
ri
->
¦ave_ma¡”_lšk_¡©us
 = 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

967 
ri
->
¦ave_»¶_off£t
 = 0;

968 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

969 
ri
->
quÜum
 = quorum;

970 
ri
->
·¿Î–_syncs
 = 
SENTINEL_DEFAULT_PARALLEL_SYNCS
;

971 
ri
->
ma¡”
 = master;

972 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

973 
ri
->
šfo_»äesh
 = 0;

976 
ri
->
Ëad”
 = 
NULL
;

977 
ri
->
Ëad”_•och
 = 0;

978 
ri
->
çov”_•och
 = 0;

979 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

980 
ri
->
çov”_¡©e_chªge_time
 = 0;

981 
ri
->
çov”_¡¬t_time
 = 0;

982 
ri
->
çov”_timeout
 = 
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
;

983 
ri
->
çov”_d–ay_logged
 = 0;

984 
ri
->
´omÙed_¦ave
 = 
NULL
;

985 
ri
->
nÙifiÿtiÚ_süt
 = 
NULL
;

986 
ri
->
ş›Á_»cÚfig_süt
 = 
NULL
;

989 
ri
->
rŞe_»pÜ‹d
 =„i->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
);

990 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

991 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

994 
	`diùAdd
(
bË
, 
ri
->
Çme
,„i);

995  
ri
;

996 
	}
}

1002 
	$»Ëa£S’tš–RedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1004 
	`diùR–—£
(
ri
->
£Áš–s
);

1005 
	`diùR–—£
(
ri
->
¦aves
);

1008 ià(
ri
->
cc
è
	`£Áš–KlLšk
(ri,ri->cc);

1009 ià(
ri
->
pc
è
	`£Áš–KlLšk
(ri,ri->pc);

1012 
	`sdsä“
(
ri
->
Çme
);

1013 
	`sdsä“
(
ri
->
runid
);

1014 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

1015 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

1016 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1017 
	`sdsä“
(
ri
->
Ëad”
);

1018 
	`sdsä“
(
ri
->
auth_·ss
);

1019 
	`»Ëa£S’tš–Addr
(
ri
->
addr
);

1022 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& (ri->æag & 
SRI_PROMOTED
è&&„i->
ma¡”
)

1023 
ri
->
ma¡”
->
´omÙed_¦ave
 = 
NULL
;

1025 
	`zä“
(
ri
);

1026 
	}
}

1029 
£Áš–RedisIn¡ªû
 *
	$£Áš–RedisIn¡ªûLookupSÏve
(

1030 
£Áš–RedisIn¡ªû
 *
ri
, *

, 
pÜt
)

1032 
sds
 
key
;

1033 
£Áš–RedisIn¡ªû
 *
¦ave
;

1035 
	`»disAs£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1036 
key
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1037 
	`¡rchr
(

,':') ? "[%s]:%d" : "%s:%d",

1038 

,
pÜt
);

1039 
¦ave
 = 
	`diùF‘chV®ue
(
ri
->
¦aves
,
key
);

1040 
	`sdsä“
(
key
);

1041  
¦ave
;

1042 
	}
}

1045 cÚ¡ *
	$£Áš–RedisIn¡ªûTy³SŒ
(
£Áš–RedisIn¡ªû
 *
ri
) {

1046 ià(
ri
->
æags
 & 
SRI_MASTER
)  "master";

1047 ià(
ri
->
æags
 & 
SRI_SLAVE
)  "slave";

1048 ià(
ri
->
æags
 & 
SRI_SENTINEL
)  "sentinel";

1050 
	}
}

1069 
	$»moveM©chšgS’tš–sFromMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *

, 
pÜt
, *
runid
) {

1070 
diùI‹¿tÜ
 *
di
;

1071 
diùEÁry
 *
de
;

1072 
»moved
 = 0;

1074 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
ma¡”
->
£Áš–s
);

1075 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1076 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1078 ià((
ri
->
runid
 &&„unid && 
	`¡rcmp
(ri->runid,runid) == 0) ||

1079 (

 && 
	`¡rcmp
(
ri
->
addr
->,è=ğ0 && 
pÜt
 ==„i->addr->port))

1081 
	`diùD–‘e
(
ma¡”
->
£Áš–s
,
ri
->
Çme
);

1082 
»moved
++;

1085 
	`diùR–—£I‹¿tÜ
(
di
);

1086  
»moved
;

1087 
	}
}

1095 
£Áš–RedisIn¡ªû
 *
	$g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
diù
 *
š¡ªûs
, *

, 
pÜt
, *
runid
) {

1096 
diùI‹¿tÜ
 *
di
;

1097 
diùEÁry
 *
de
;

1098 
£Áš–RedisIn¡ªû
 *
š¡ªû
 = 
NULL
;

1100 
	`»disAs£¹
(

 || 
runid
);

1101 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1102 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1103 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1105 ià(
runid
 && !
ri
->runid) ;

1106 ià((
runid
 =ğ
NULL
 || 
	`¡rcmp
(
ri
->runid,„unid) == 0) &&

1107 (

 =ğ
NULL
 || (
	`¡rcmp
(
ri
->
addr
->ip, ip) == 0 &&

1108 
ri
->
addr
->
pÜt
 ==…ort)))

1110 
š¡ªû
 = 
ri
;

1114 
	`diùR–—£I‹¿tÜ
(
di
);

1115  
š¡ªû
;

1116 
	}
}

1119 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByName
(*
Çme
) {

1120 
£Áš–RedisIn¡ªû
 *
ri
;

1121 
sds
 
sd¢ame
 = 
	`sd¢ew
(
Çme
);

1123 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
sd¢ame
);

1124 
	`sdsä“
(
sd¢ame
);

1125  
ri
;

1126 
	}
}

1129 
	$£Áš–AddFÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1130 
diùI‹¿tÜ
 *
di
;

1131 
diùEÁry
 *
de
;

1133 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1134 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1135 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1136 
ri
->
æags
 |= flags;

1138 
	`diùR–—£I‹¿tÜ
(
di
);

1139 
	}
}

1143 
	$£Áš–D–FÏgsToDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
, 
æags
) {

1144 
diùI‹¿tÜ
 *
di
;

1145 
diùEÁry
 *
de
;

1147 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

1148 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1149 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1150 
ri
->
æags
 &= ~flags;

1152 
	`diùR–—£I‹¿tÜ
(
di
);

1153 
	}
}

1164 
	#SENTINEL_RESET_NO_SENTINELS
 (1<<0)

	)

1165 
	$£Áš–Re£tMa¡”
(
£Áš–RedisIn¡ªû
 *
ri
, 
æags
) {

1166 
	`»disAs£¹
(
ri
->
æags
 & 
SRI_MASTER
);

1167 
	`diùR–—£
(
ri
->
¦aves
);

1168 
ri
->
¦aves
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1169 ià(!(
æags
 & 
SENTINEL_RESET_NO_SENTINELS
)) {

1170 
	`diùR–—£
(
ri
->
£Áš–s
);

1171 
ri
->
£Áš–s
 = 
	`diùC»©e
(&
š¡ªûsDiùTy³
,
NULL
);

1173 ià(
ri
->
cc
è
	`£Áš–KlLšk
(ri,ri->cc);

1174 ià(
ri
->
pc
è
	`£Áš–KlLšk
(ri,ri->pc);

1175 
ri
->
æags
 &ğ
SRI_MASTER
|
SRI_DISCONNECTED
;

1176 ià(
ri
->
Ëad”
) {

1177 
	`sdsä“
(
ri
->
Ëad”
);

1178 
ri
->
Ëad”
 = 
NULL
;

1180 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

1181 
ri
->
çov”_¡©e_chªge_time
 = 0;

1182 
ri
->
çov”_¡¬t_time
 = 0;

1183 
ri
->
´omÙed_¦ave
 = 
NULL
;

1184 
	`sdsä“
(
ri
->
runid
);

1185 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1186 
ri
->
runid
 = 
NULL
;

1187 
ri
->
¦ave_ma¡”_ho¡
 = 
NULL
;

1188 
ri
->
Ï¡_pšg_time
 = 
	`m¡ime
();

1189 
ri
->
Ï¡_ava_time
 = 
	`m¡ime
();

1190 
ri
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

1191 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1192 
ri
->
rŞe_»pÜ‹d
 = 
SRI_MASTER
;

1193 ià(
æags
 & 
SENTINEL_GENERATE_EVENT
)

1194 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+»£t-ma¡”",
ri
,"%@");

1195 
	}
}

1199 
	$£Áš–Re£tMa¡”sByP©‹º
(*
·‰”n
, 
æags
) {

1200 
diùI‹¿tÜ
 *
di
;

1201 
diùEÁry
 *
de
;

1202 
»£t
 = 0;

1204 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1205 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1206 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1208 ià(
ri
->
Çme
) {

1209 ià(
	`¡ršgm©ch
(
·‰”n
,
ri
->
Çme
,0)) {

1210 
	`£Áš–Re£tMa¡”
(
ri
,
æags
);

1211 
»£t
++;

1215 
	`diùR–—£I‹¿tÜ
(
di
);

1216  
»£t
;

1217 
	}
}

1226 
	$£Áš–Re£tMa¡”AndChªgeAdd»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
, *

, 
pÜt
) {

1227 
£Áš–Addr
 *
Şdaddr
, *
Ãwaddr
;

1228 
£Áš–Addr
 **
¦aves
 = 
NULL
;

1229 
num¦aves
 = 0, 
j
;

1230 
diùI‹¿tÜ
 *
di
;

1231 
diùEÁry
 *
de
;

1233 
Ãwaddr
 = 
	`ü—‹S’tš–Addr
(

,
pÜt
);

1234 ià(
Ãwaddr
 =ğ
NULL
è 
REDIS_ERR
;

1238 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1239 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1240 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

1242 ià(
	`£Áš–AddrIsEqu®
(
¦ave
->
addr
,
Ãwaddr
)) ;

1243 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1244 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
¦ave
->
addr
->

,

1245 
¦ave
->
addr
->
pÜt
);

1247 
	`diùR–—£I‹¿tÜ
(
di
);

1252 ià(!
	`£Áš–AddrIsEqu®
(
Ãwaddr
,
ma¡”
->
addr
)) {

1253 
¦aves
 = 
	`z»®loc
(¦aves,(
£Áš–Addr
*)*(
num¦aves
+1));

1254 
¦aves
[
num¦aves
++] = 
	`ü—‹S’tš–Addr
(
ma¡”
->
addr
->

,

1255 
ma¡”
->
addr
->
pÜt
);

1259 
	`£Áš–Re£tMa¡”
(
ma¡”
,
SENTINEL_RESET_NO_SENTINELS
);

1260 
Şdaddr
 = 
ma¡”
->
addr
;

1261 
ma¡”
->
addr
 = 
Ãwaddr
;

1262 
ma¡”
->
o_down_sšû_time
 = 0;

1263 
ma¡”
->
s_down_sšû_time
 = 0;

1266 
j
 = 0; j < 
num¦aves
; j++) {

1267 
£Áš–RedisIn¡ªû
 *
¦ave
;

1269 
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¦aves
[
j
]->

,

1270 
¦aves
[
j
]->
pÜt
, 
ma¡”
->
quÜum
, master);

1271 
	`»Ëa£S’tš–Addr
(
¦aves
[
j
]);

1272 ià(
¦ave
) {

1273 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave",
¦ave
,"%@");

1274 
	`£Áš–FlushCÚfig
();

1277 
	`zä“
(
¦aves
);

1281 
	`»Ëa£S’tš–Addr
(
Şdaddr
);

1282 
	`£Áš–FlushCÚfig
();

1283  
REDIS_OK
;

1284 
	}
}

1288 
	$£Áš–RedisIn¡ªûNoDownFÜ
(
£Áš–RedisIn¡ªû
 *
ri
, 
m¡ime_t
 
ms
) {

1289 
m¡ime_t
 
mo¡_»ûÁ
;

1291 
mo¡_»ûÁ
 = 
ri
->
s_down_sšû_time
;

1292 ià(
ri
->
o_down_sšû_time
 > 
mo¡_»ûÁ
)

1293 
mo¡_»ûÁ
 = 
ri
->
o_down_sšû_time
;

1294  
mo¡_»ûÁ
 =ğ0 || (
	`m¡ime
(è- mo¡_»ûÁè> 
ms
;

1295 
	}
}

1299 
£Áš–Addr
 *
	$£Áš–G‘Cu¼’tMa¡”Add»ss
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1305 ià((
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

1306 
ma¡”
->
´omÙed_¦ave
 &&

1307 
ma¡”
->
çov”_¡©e
 >ğ
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
)

1309  
ma¡”
->
´omÙed_¦ave
->
addr
;

1311  
ma¡”
->
addr
;

1313 
	}
}

1317 
	$£Áš–Prİag©eDownAá”P”iod
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1318 
diùI‹¿tÜ
 *
di
;

1319 
diùEÁry
 *
de
;

1320 
j
;

1321 
diù
 *
d
[] = {
ma¡”
->
¦aves
, ma¡”->
£Áš–s
, 
NULL
};

1323 
j
 = 0; 
d
[j]; j++) {

1324 
di
 = 
	`diùG‘I‹¿tÜ
(
d
[
j
]);

1325 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1326 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

1327 
ri
->
down_aá”_³riod
 = 
ma¡”
->down_after_period;

1329 
	`diùR–—£I‹¿tÜ
(
di
);

1331 
	}
}

1334 *
	$£Áš–HªdËCÚfigu¿tiÚ
(**
¬gv
, 
¬gc
) {

1335 
£Áš–RedisIn¡ªû
 *
ri
;

1337 ià(!
	`¡rÿ£cmp
(
¬gv
[0],"mÚ™Ü"è&& 
¬gc
 == 5) {

1339 
quÜum
 = 
	`©oi
(
¬gv
[4]);

1341 ià(
quÜum
 <= 0)  "Quorum must be 1 or greater.";

1342 ià(
	`ü—‹S’tš–RedisIn¡ªû
(
¬gv
[1],
SRI_MASTER
,argv[2],

1343 
	`©oi
(
¬gv
[3]),
quÜum
,
NULL
) == NULL)

1345 
”ºo
) {

1346 
EBUSY
:  "Duplicated master‚ame.";

1347 
ENOENT
:  "Can't„esolve master instance hostname.";

1348 
EINVAL
:  "Invalid…ort‚umber";

1351 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"down-aá”-mli£cÚds"è&& 
¬gc
 == 3) {

1353 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1354 ià(!
ri
)  "No such master with specified‚ame.";

1355 
ri
->
down_aá”_³riod
 = 
	`©oi
(
¬gv
[2]);

1356 ià(
ri
->
down_aá”_³riod
 <= 0)

1358 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

1359 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"çov”-timeout"è&& 
¬gc
 == 3) {

1361 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1362 ià(!
ri
)  "No such master with specified‚ame.";

1363 
ri
->
çov”_timeout
 = 
	`©oi
(
¬gv
[2]);

1364 ià(
ri
->
çov”_timeout
 <= 0)

1366 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"·¿Î–-syncs"è&& 
¬gc
 == 3) {

1368 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1369 ià(!
ri
)  "No such master with specified‚ame.";

1370 
ri
->
·¿Î–_syncs
 = 
	`©oi
(
¬gv
[2]);

1371 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"nÙifiÿtiÚ-süt"è&& 
¬gc
 == 3) {

1373 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1374 ià(!
ri
)  "No such master with specified‚ame.";

1375 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1377 
ri
->
nÙifiÿtiÚ_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1378 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ş›Á-»cÚfig-süt"è&& 
¬gc
 == 3) {

1380 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1381 ià(!
ri
)  "No such master with specified‚ame.";

1382 ià(
	`acûss
(
¬gv
[2],
X_OK
) == -1)

1385 
ri
->
ş›Á_»cÚfig_süt
 = 
	`sd¢ew
(
¬gv
[2]);

1386 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"auth-·ss"è&& 
¬gc
 == 3) {

1388 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1389 ià(!
ri
)  "No such master with specified‚ame.";

1390 
ri
->
auth_·ss
 = 
	`sd¢ew
(
¬gv
[2]);

1391 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cu¼’t-•och"è&& 
¬gc
 == 2) {

1393 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
¬gv
[1],
NULL
,10);

1394 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch)

1395 
£Áš–
.
cu¼’t_•och
 = current_epoch;

1396 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"cÚfig-•och"è&& 
¬gc
 == 3) {

1398 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1399 ià(!
ri
)  "No such master with specified‚ame.";

1400 
ri
->
cÚfig_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1404 ià(
ri
->
cÚfig_•och
 > 
£Áš–
.
cu¼’t_•och
)

1405 
£Áš–
.
cu¼’t_•och
 = 
ri
->
cÚfig_•och
;

1406 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"Ëad”-•och"è&& 
¬gc
 == 3) {

1408 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1409 ià(!
ri
)  "No such master with specified‚ame.";

1410 
ri
->
Ëad”_•och
 = 
	`¡¹ouÎ
(
¬gv
[2],
NULL
,10);

1411 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-¦ave"è&& 
¬gc
 == 4) {

1412 
£Áš–RedisIn¡ªû
 *
¦ave
;

1415 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1416 ià(!
ri
)  "No such master with specified‚ame.";

1417 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,
¬gv
[2],

1418 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1422 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"known-sentinel") &&

1423 (
¬gc
 == 4 ||‡rgc == 5)) {

1424 
£Áš–RedisIn¡ªû
 *
si
;

1427 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
¬gv
[1]);

1428 ià(!
ri
)  "No such master with specified‚ame.";

1429 ià((
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SENTINEL
,
¬gv
[2],

1430 
	`©oi
(
¬gv
[3]), 
ri
->
quÜum
,„i)è=ğ
NULL
)

1434 ià(
¬gc
 =ğ5è
si
->
runid
 = 
	`sd¢ew
(
¬gv
[4]);

1435 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-"è&& 
¬gc
 == 2) {

1437 ià(
	`¡¾’
(
¬gv
[1]))

1438 
£Áš–
.
ªnounû_
 = 
	`sd¢ew
(
¬gv
[1]);

1439 } ià(!
	`¡rÿ£cmp
(
¬gv
[0],"ªnounû-pÜt"è&& 
¬gc
 == 2) {

1441 
£Áš–
.
ªnounû_pÜt
 = 
	`©oi
(
¬gv
[1]);

1445  
NULL
;

1446 
	}
}

1453 
	$»wr™eCÚfigS’tš–O±iÚ
(
»wr™eCÚfigS‹
 *
¡©e
) {

1454 
diùI‹¿tÜ
 *
di
, *
di2
;

1455 
diùEÁry
 *
de
;

1456 
sds
 
lše
;

1459 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

1460 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

1461 
£Áš–RedisIn¡ªû
 *
ma¡”
, *
ri
;

1462 
£Áš–Addr
 *
ma¡”_addr
;

1465 
ma¡”
 = 
	`diùG‘V®
(
de
);

1466 
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

1467 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel monitor %s %s %d %d",

1468 
ma¡”
->
Çme
, 
ma¡”_addr
->

, ma¡”_addr->
pÜt
,

1469 
ma¡”
->
quÜum
);

1470 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1473 ià(
ma¡”
->
down_aá”_³riod
 !ğ
SENTINEL_DEFAULT_DOWN_AFTER
) {

1474 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1476 
ma¡”
->
Çme
, (èma¡”->
down_aá”_³riod
);

1477 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1481 ià(
ma¡”
->
çov”_timeout
 !ğ
SENTINEL_DEFAULT_FAILOVER_TIMEOUT
) {

1482 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1484 
ma¡”
->
Çme
, (èma¡”->
çov”_timeout
);

1485 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1489 ià(
ma¡”
->
·¿Î–_syncs
 !ğ
SENTINEL_DEFAULT_PARALLEL_SYNCS
) {

1490 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1492 
ma¡”
->
Çme
, ma¡”->
·¿Î–_syncs
);

1493 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1497 ià(
ma¡”
->
nÙifiÿtiÚ_süt
) {

1498 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1500 
ma¡”
->
Çme
, ma¡”->
nÙifiÿtiÚ_süt
);

1501 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1505 ià(
ma¡”
->
ş›Á_»cÚfig_süt
) {

1506 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1508 
ma¡”
->
Çme
, ma¡”->
ş›Á_»cÚfig_süt
);

1509 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1513 ià(
ma¡”
->
auth_·ss
) {

1514 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1516 
ma¡”
->
Çme
, ma¡”->
auth_·ss
);

1517 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1521 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1523 
ma¡”
->
Çme
, (èma¡”->
cÚfig_•och
);

1524 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1527 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1529 
ma¡”
->
Çme
, (èma¡”->
Ëad”_•och
);

1530 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1533 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

1534 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1535 
£Áš–Addr
 *
¦ave_addr
;

1537 
ri
 = 
	`diùG‘V®
(
de
);

1538 
¦ave_addr
 = 
ri
->
addr
;

1545 ià(
	`£Áš–AddrIsEqu®
(
¦ave_addr
,
ma¡”_addr
))

1546 
¦ave_addr
 = 
ma¡”
->
addr
;

1547 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1549 
ma¡”
->
Çme
, 
ri
->
addr
->

,„i->addr->
pÜt
);

1550 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1552 
	`diùR–—£I‹¿tÜ
(
di2
);

1555 
di2
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

1556 (
de
 = 
	`diùNext
(
di2
)è!ğ
NULL
) {

1557 
ri
 = 
	`diùG‘V®
(
de
);

1558 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1560 
ma¡”
->
Çme
, 
ri
->
addr
->

,„i->addr->
pÜt
,

1561 
ri
->
runid
 ? " " : "",

1562 
ri
->
runid
 ?„i->runid : "");

1563 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1565 
	`diùR–—£I‹¿tÜ
(
di2
);

1569 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),

1570 "£Áš– cu¼’t-•och %Îu", (è
£Áš–
.
cu¼’t_•och
);

1571 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1574 ià(
£Áš–
.
ªnounû_
) {

1575 
lše
 = 
	`sd¢ew
("sentinel‡nnounce-ip ");

1576 
lše
 = 
	`sdsÿŒ•r
Öše, 
£Áš–
.
ªnounû_
, 
	`sd¦’
(sentinel.announce_ip));

1577 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1581 ià(
£Áš–
.
ªnounû_pÜt
) {

1582 
lše
 = 
	`sdsÿrštf
(
	`sd£m±y
(),"sentinel‡nnounce-port %d",

1583 
£Áš–
.
ªnounû_pÜt
);

1584 
	`»wr™eCÚfigRewr™eLše
(
¡©e
,"£Áš–",
lše
,1);

1587 
	`diùR–—£I‹¿tÜ
(
di
);

1588 
	}
}

1597 
	$£Áš–FlushCÚfig
() {

1598 
fd
 = -1;

1599 
§ved_hz
 = 
£rv”
.
hz
;

1600 
»wr™e_¡©us
;

1602 
£rv”
.
hz
 = 
REDIS_DEFAULT_HZ
;

1603 
»wr™e_¡©us
 = 
	`»wr™eCÚfig
(
£rv”
.
cÚfigfe
);

1604 
£rv”
.
hz
 = 
§ved_hz
;

1606 ià(
»wr™e_¡©us
 =ğ-1è
w”r
;

1607 ià((
fd
 = 
	`İ’
(
£rv”
.
cÚfigfe
,
O_RDONLY
)è=ğ-1è
w”r
;

1608 ià(
	`fsync
(
fd
è=ğ-1è
w”r
;

1609 ià(
	`şo£
(
fd
è=ğ
EOF
è
w”r
;

1612 
w”r
:

1613 ià(
fd
 !ğ-1è
	`şo£
(fd);

1614 
	`»disLog
(
REDIS_WARNING
,"WARNING: S’tš– wa nÙ‡bËØ§vthÃw cÚfigu¿tiÚ oÀdisk!!!: %s", 
	`¡»¼Ü
(
”ºo
));

1615 
	}
}

1620 
	$£Áš–KlLšk
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
) {

1621 ià(
ri
->
cc
 =ğ
c
) {

1622 
ri
->
cc
 = 
NULL
;

1623 
ri
->
³ndšg_commªds
 = 0;

1625 ià(
ri
->
pc
 =ğ
c
èri->pøğ
NULL
;

1626 
c
->
d©a
 = 
NULL
;

1627 
ri
->
æags
 |ğ
SRI_DISCONNECTED
;

1628 
	`»disAsyncF»e
(
c
);

1629 
	}
}

1637 
	$£Áš–DiscÚÃùIn¡ªûFromCÚ‹xt
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
) {

1638 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

1639 
pubsub
;

1641 ià(
ri
 =ğ
NULL
) ;

1643 
pubsub
 = (
ri
->
pc
 =ğ
c
);

1644 
	`£Áš–Ev’t
(
REDIS_DEBUG
, 
pubsub
 ? "-pubsub-lšk" : "-cmd-lšk", 
ri
,

1645 "%@ #%s", 
c
->
”r¡r
);

1646 ià(
pubsub
)

1647 
ri
->
pc
 = 
NULL
;

1649 
ri
->
cc
 = 
NULL
;

1650 
ri
->
æags
 |ğ
SRI_DISCONNECTED
;

1651 
	}
}

1653 
	$£Áš–LškE¡ablishedC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1654 ià(
¡©us
 !ğ
REDIS_OK
) {

1655 
	`£Áš–DiscÚÃùIn¡ªûFromCÚ‹xt
(
c
);

1657 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

1658 
pubsub
 = (
ri
->
pc
 =ğ
c
);

1660 
	`£Áš–Ev’t
(
REDIS_DEBUG
, 
pubsub
 ? "+pubsub-lšk" : "+cmd-lšk", 
ri
,

1663 
	}
}

1665 
	$£Áš–DiscÚÃùC®lback
(cÚ¡ 
»disAsyncCÚ‹xt
 *
c
, 
¡©us
) {

1666 
	`REDIS_NOTUSED
(
¡©us
);

1667 
	`£Áš–DiscÚÃùIn¡ªûFromCÚ‹xt
(
c
);

1668 
	}
}

1676 
	$£Áš–S’dAuthIfN“ded
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
) {

1677 *
auth_·ss
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i->auth_pass :

1678 
ri
->
ma¡”
->
auth_·ss
;

1680 ià(
auth_·ss
) {

1681 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "AUTH %s",

1682 
auth_·ss
è=ğ
REDIS_OK
è
ri
->
³ndšg_commªds
++;

1684 
	}
}

1692 
	$£Áš–S‘Cl›ÁName
(
£Áš–RedisIn¡ªû
 *
ri
, 
»disAsyncCÚ‹xt
 *
c
, *
ty³
) {

1693 
Çme
[64];

1695 
	`¢´štf
(
Çme
,Òame),"£Áš–-%.8s-%s",
£rv”
.
runid
,
ty³
);

1696 ià(
	`»disAsyncCommªd
(
c
, 
£Áš–DisÿrdR•lyC®lback
, 
NULL
,

1697 "CLIENT SETNAME %s", 
Çme
è=ğ
REDIS_OK
)

1699 
ri
->
³ndšg_commªds
++;

1701 
	}
}

1706 
	$£Áš–RecÚÃùIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

1707 ià(!(
ri
->
æags
 & 
SRI_DISCONNECTED
)) ;

1710 ià(
ri
->
cc
 =ğ
NULL
) {

1711 
ri
->
cc
 = 
	`»disAsyncCÚÃùBšd
Ôi->
addr
->

,ri->addr->
pÜt
,
REDIS_BIND_ADDR
);

1712 ià(
ri
->
cc
->
”r
) {

1713 
	`£Áš–Ev’t
(
REDIS_DEBUG
,"-cmd-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1714 
ri
->
cc
->
”r¡r
);

1715 
	`£Áš–KlLšk
(
ri
,ri->
cc
);

1717 
ri
->
cc_cÚn_time
 = 
	`m¡ime
();

1718 
ri
->
cc
->
d©a
 =„i;

1719 
	`»disAeA‰ach
(
£rv”
.
–
,
ri
->
cc
);

1720 
	`»disAsyncS‘CÚÃùC®lback
(
ri
->
cc
,

1721 
£Áš–LškE¡ablishedC®lback
);

1722 
	`»disAsyncS‘DiscÚÃùC®lback
(
ri
->
cc
,

1723 
£Áš–DiscÚÃùC®lback
);

1724 
	`£Áš–S’dAuthIfN“ded
(
ri
,ri->
cc
);

1725 
	`£Áš–S‘Cl›ÁName
(
ri
,ri->
cc
,"cmd");

1728 
	`£Áš–S’dPšg
(
ri
);

1732 ià((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è&&„i->
pc
 =ğ
NULL
) {

1733 
ri
->
pc
 = 
	`»disAsyncCÚÃùBšd
Ôi->
addr
->

,ri->addr->
pÜt
,
REDIS_BIND_ADDR
);

1734 ià(
ri
->
pc
->
”r
) {

1735 
	`£Áš–Ev’t
(
REDIS_DEBUG
,"-pubsub-lšk-»cÚÃùiÚ",
ri
,"%@ #%s",

1736 
ri
->
pc
->
”r¡r
);

1737 
	`£Áš–KlLšk
(
ri
,ri->
pc
);

1739 
»tv®
;

1741 
ri
->
pc_cÚn_time
 = 
	`m¡ime
();

1742 
ri
->
pc
->
d©a
 =„i;

1743 
	`»disAeA‰ach
(
£rv”
.
–
,
ri
->
pc
);

1744 
	`»disAsyncS‘CÚÃùC®lback
(
ri
->
pc
,

1745 
£Áš–LškE¡ablishedC®lback
);

1746 
	`»disAsyncS‘DiscÚÃùC®lback
(
ri
->
pc
,

1747 
£Áš–DiscÚÃùC®lback
);

1748 
	`£Áš–S’dAuthIfN“ded
(
ri
,ri->
pc
);

1749 
	`£Áš–S‘Cl›ÁName
(
ri
,ri->
pc
,"pubsub");

1751 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
pc
,

1752 
£Áš–ReûiveH–loMes§ges
, 
NULL
, "SUBSCRIBE %s",

1753 
SENTINEL_HELLO_CHANNEL
);

1754 ià(
»tv®
 !ğ
REDIS_OK
) {

1757 
	`£Áš–KlLšk
(
ri
,ri->
pc
);

1764 ià(
ri
->
cc
 && (ri->
æags
 & 
SRI_SENTINEL
 ||„i->
pc
))

1765 
ri
->
æags
 &ğ~
SRI_DISCONNECTED
;

1766 
	}
}

1775 
	$£Áš–Ma¡”LooksSªe
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

1777 
ma¡”
->
æags
 & 
SRI_MASTER
 &&

1778 
ma¡”
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
 &&

1779 (
ma¡”
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
)) == 0 &&

1780 (
	`m¡ime
(è- 
ma¡”
->
šfo_»äesh
è< 
SENTINEL_INFO_PERIOD
*2;

1781 
	}
}

1784 
	$£Áš–ReäeshIn¡ªûInfo
(
£Áš–RedisIn¡ªû
 *
ri
, cÚ¡ *
šfo
) {

1785 
sds
 *
lšes
;

1786 
numlšes
, 
j
;

1787 
rŞe
 = 0;

1791 
ri
->
ma¡”_lšk_down_time
 = 0;

1794 
lšes
 = 
	`sds¥l™Ën
(
šfo
,
	`¡¾’
(šfo),"\r\n",2,&
numlšes
);

1795 
j
 = 0; j < 
numlšes
; j++) {

1796 
£Áš–RedisIn¡ªû
 *
¦ave
;

1797 
sds
 
l
 = 
lšes
[
j
];

1800 ià(
	`sd¦’
(
l
è>ğ47 && !
	`memcmp
(l,"run_id:",7)) {

1801 ià(
ri
->
runid
 =ğ
NULL
) {

1802 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

1804 ià(
	`¡ºcmp
(
ri
->
runid
,
l
+7,40) != 0) {

1805 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+»boÙ",
ri
,"%@");

1806 
	`sdsä“
(
ri
->
runid
);

1807 
ri
->
runid
 = 
	`sd¢ewËn
(
l
+7,40);

1814 ià((
ri
->
æags
 & 
SRI_MASTER
) &&

1815 
	`sd¦’
(
l
) >= 7 &&

1816 !
	`memcmp
(
l
,"¦ave",5è&& 
	`isdig™
(l[5]))

1818 *

, *
pÜt
, *
’d
;

1820 ià(
	`¡r¡r
(
l
,"="è=ğ
NULL
) {

1822 

 = 
	`¡rchr
(
l
,':'); if (!ip) ;

1823 

++;

1824 
pÜt
 = 
	`¡rchr
(

,','); if (!port) ;

1825 *
pÜt
 = '\0';

1826 
pÜt
++;

1827 
’d
 = 
	`¡rchr
(
pÜt
,','); if (!end) ;

1828 *
’d
 = '\0';

1831 

 = 
	`¡r¡r
(
l
,"ip="); if (!ip) ;

1832 

 += 3;

1833 
pÜt
 = 
	`¡r¡r
(
l
,"port="); if (!port) ;

1834 
pÜt
 += 5;

1836 
’d
 = 
	`¡rchr
(

,','); if (end) *end = '\0';

1837 
’d
 = 
	`¡rchr
(
pÜt
,','); if (end) *end = '\0';

1842 ià(
	`£Áš–RedisIn¡ªûLookupSÏve
(
ri
,

,
	`©oi
(
pÜt
)è=ğ
NULL
) {

1843 ià((
¦ave
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SLAVE
,

,

1844 
	`©oi
(
pÜt
), 
ri
->
quÜum
,„i)è!ğ
NULL
)

1846 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave",
¦ave
,"%@");

1852 ià(
	`sd¦’
(
l
) >= 32 &&

1853 !
	`memcmp
(
l
,"master_link_down_since_seconds",30))

1855 
ri
->
ma¡”_lšk_down_time
 = 
	`¡¹Şl
(
l
+31,
NULL
,10)*1000;

1859 ià(!
	`memcmp
(
l
,"rŞe:ma¡”",11)è
rŞe
 = 
SRI_MASTER
;

1860 ià(!
	`memcmp
(
l
,"rŞe:¦ave",10)è
rŞe
 = 
SRI_SLAVE
;

1862 ià(
rŞe
 =ğ
SRI_SLAVE
) {

1864 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_host:",12)) {

1865 ià(
ri
->
¦ave_ma¡”_ho¡
 =ğ
NULL
 ||

1866 
	`¡rÿ£cmp
(
l
+12,
ri
->
¦ave_ma¡”_ho¡
))

1868 
	`sdsä“
(
ri
->
¦ave_ma¡”_ho¡
);

1869 
ri
->
¦ave_ma¡”_ho¡
 = 
	`sd¢ew
(
l
+12);

1870 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1875 ià(
	`sd¦’
(
l
è>ğ12 && !
	`memcmp
(l,"master_port:",12)) {

1876 
¦ave_ma¡”_pÜt
 = 
	`©oi
(
l
+12);

1878 ià(
ri
->
¦ave_ma¡”_pÜt
 != slave_master_port) {

1879 
ri
->
¦ave_ma¡”_pÜt
 = slave_master_port;

1880 
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1885 ià(
	`sd¦’
(
l
è>ğ19 && !
	`memcmp
(l,"master_link_status:",19)) {

1886 
ri
->
¦ave_ma¡”_lšk_¡©us
 =

1887 (
	`¡rÿ£cmp
(
l
+19,"up") == 0) ?

1888 
SENTINEL_MASTER_LINK_STATUS_UP
 :

1889 
SENTINEL_MASTER_LINK_STATUS_DOWN
;

1893 ià(
	`sd¦’
(
l
è>ğ15 && !
	`memcmp
(l,"slave_priority:",15))

1894 
ri
->
¦ave_´iÜ™y
 = 
	`©oi
(
l
+15);

1897 ià(
	`sd¦’
(
l
è>ğ18 && !
	`memcmp
(l,"slave_repl_offset:",18))

1898 
ri
->
¦ave_»¶_off£t
 = 
	`¡¹ouÎ
(
l
+18,
NULL
,10);

1901 
ri
->
šfo_»äesh
 = 
	`m¡ime
();

1902 
	`sdsä“¥l™»s
(
lšes
,
numlšes
);

1909 ià(
rŞe
 !ğ
ri
->
rŞe_»pÜ‹d
) {

1910 
ri
->
rŞe_»pÜ‹d_time
 = 
	`m¡ime
();

1911 
ri
->
rŞe_»pÜ‹d
 = 
rŞe
;

1912 ià(
rŞe
 =ğ
SRI_SLAVE
è
ri
->
¦ave_cÚf_chªge_time
 = 
	`m¡ime
();

1915 
	`£Áš–Ev’t
(
REDIS_VERBOSE
,

1916 ((
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)è=ğ
rŞe
) ?

1918 
ri
, "%@‚ew„eported„ole is %s",

1919 
rŞe
 =ğ
SRI_MASTER
 ? "master" : "slave",

1920 
ri
->
æags
 & 
SRI_MASTER
 ? "master" : "slave");

1925 ià(
£Áš–
.
tt
) ;

1928 ià((
ri
->
æags
 & 
SRI_MASTER
è&& 
rŞe
 =ğ
SRI_SLAVE
) {

1935 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 =ğ
SRI_MASTER
) {

1938 ià((
ri
->
æags
 & 
SRI_PROMOTED
) &&

1939 (
ri
->
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) &&

1940 (
ri
->
ma¡”
->
çov”_¡©e
 ==

1941 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
))

1948 
ri
->
ma¡”
->
cÚfig_•och
 =„i->ma¡”->
çov”_•och
;

1949 
ri
->
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
;

1950 
ri
->
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

1951 
	`£Áš–FlushCÚfig
();

1952 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+´omÙed-¦ave",
ri
,"%@");

1953 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+failover-state-reconf-slaves",

1954 
ri
->
ma¡”
,"%@");

1955 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ri
->
ma¡”
,
SENTINEL_LEADER
,

1956 "¡¬t",
ri
->
ma¡”
->
addr
,ri->addr);

1957 
	`£Áš–FÜûH–loUpd©eFÜMa¡”
(
ri
->
ma¡”
);

1962 
m¡ime_t
 
wa™_time
 = 
SENTINEL_PUBLISH_PERIOD
*4;

1964 ià(!(
ri
->
æags
 & 
SRI_PROMOTED
) &&

1965 
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

1966 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

1967 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 > 
wa™_time
)

1969 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

1970 
ri
->
ma¡”
->
addr
->

,

1971 
ri
->
ma¡”
->
addr
->
pÜt
);

1972 ià(
»tv®
 =ğ
REDIS_OK
)

1973 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+cÚv”t-to-¦ave",
ri
,"%@");

1979 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

1980 
rŞe
 =ğ
SRI_SLAVE
 &&

1981 (
ri
->
¦ave_ma¡”_pÜt
 !ğri->
ma¡”
->
addr
->
pÜt
 ||

1982 
	`¡rÿ£cmp
(
ri
->
¦ave_ma¡”_ho¡
,ri->
ma¡”
->
addr
->

)))

1984 
m¡ime_t
 
wa™_time
 = 
ri
->
ma¡”
->
çov”_timeout
;

1988 ià(
	`£Áš–Ma¡”LooksSªe
(
ri
->
ma¡”
) &&

1989 
	`£Áš–RedisIn¡ªûNoDownFÜ
(
ri
,
wa™_time
) &&

1990 
	`m¡ime
(è- 
ri
->
¦ave_cÚf_chªge_time
 > 
wa™_time
)

1992 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
,

1993 
ri
->
ma¡”
->
addr
->

,

1994 
ri
->
ma¡”
->
addr
->
pÜt
);

1995 ià(
»tv®
 =ğ
REDIS_OK
)

1996 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+fix-¦ave-cÚfig",
ri
,"%@");

2002 ià((
ri
->
æags
 & 
SRI_SLAVE
è&& 
rŞe
 == SRI_SLAVE &&

2003 (
ri
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
)))

2006 ià((
ri
->
æags
 & 
SRI_RECONF_SENT
) &&

2007 
ri
->
¦ave_ma¡”_ho¡
 &&

2008 
	`¡rcmp
(
ri
->
¦ave_ma¡”_ho¡
,

2009 
ri
->
ma¡”
->
´omÙed_¦ave
->
addr
->

) == 0 &&

2010 
ri
->
¦ave_ma¡”_pÜt
 =ğri->
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
)

2012 
ri
->
æags
 &ğ~
SRI_RECONF_SENT
;

2013 
ri
->
æags
 |ğ
SRI_RECONF_INPROG
;

2014 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave-»cÚf-š´og",
ri
,"%@");

2018 ià((
ri
->
æags
 & 
SRI_RECONF_INPROG
) &&

2019 
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
)

2021 
ri
->
æags
 &ğ~
SRI_RECONF_INPROG
;

2022 
ri
->
æags
 |ğ
SRI_RECONF_DONE
;

2023 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave-»cÚf-dÚe",
ri
,"%@");

2026 
	}
}

2028 
	$£Áš–InfoR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2029 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

2030 
»disR•ly
 *
r
;

2031 
	`REDIS_NOTUSED
(
´ivd©a
);

2033 ià(
ri
èri->
³ndšg_commªds
--;

2034 ià(!
»¶y
 || !
ri
) ;

2035 
r
 = 
»¶y
;

2037 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STRING
) {

2038 
	`£Áš–ReäeshIn¡ªûInfo
(
ri
,
r
->
¡r
);

2040 
	}
}

2044 
	$£Áš–DisÿrdR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2045 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

2046 
	`REDIS_NOTUSED
(
»¶y
);

2047 
	`REDIS_NOTUSED
(
´ivd©a
);

2049 ià(
ri
èri->
³ndšg_commªds
--;

2050 
	}
}

2052 
	$£Áš–PšgR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2053 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

2054 
»disR•ly
 *
r
;

2055 
	`REDIS_NOTUSED
(
´ivd©a
);

2057 ià(
ri
èri->
³ndšg_commªds
--;

2058 ià(!
»¶y
 || !
ri
) ;

2059 
r
 = 
»¶y
;

2061 ià(
r
->
ty³
 =ğ
REDIS_REPLY_STATUS
 ||

2062 
r
->
ty³
 =ğ
REDIS_REPLY_ERROR
) {

2065 ià(
	`¡ºcmp
(
r
->
¡r
,"PONG",4) == 0 ||

2066 
	`¡ºcmp
(
r
->
¡r
,"LOADING",7) == 0 ||

2067 
	`¡ºcmp
(
r
->
¡r
,"MASTERDOWN",10) == 0)

2069 
ri
->
Ï¡_ava_time
 = 
	`m¡ime
();

2070 
ri
->
Ï¡_pšg_time
 = 0;

2074 ià(
	`¡ºcmp
(
r
->
¡r
,"BUSY",4) == 0 &&

2075 (
ri
->
æags
 & 
SRI_S_DOWN
) &&

2076 !(
ri
->
æags
 & 
SRI_SCRIPT_KILL_SENT
))

2078 ià(
	`»disAsyncCommªd
(
ri
->
cc
,

2079 
£Áš–DisÿrdR•lyC®lback
, 
NULL
,

2080 "SCRIPT KILL"è=ğ
REDIS_OK
)

2081 
ri
->
³ndšg_commªds
++;

2082 
ri
->
æags
 |ğ
SRI_SCRIPT_KILL_SENT
;

2086 
ri
->
Ï¡_pÚg_time
 = 
	`m¡ime
();

2087 
	}
}

2091 
	$£Áš–PublishR•lyC®lback
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2092 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

2093 
»disR•ly
 *
r
;

2094 
	`REDIS_NOTUSED
(
´ivd©a
);

2096 ià(
ri
èri->
³ndšg_commªds
--;

2097 ià(!
»¶y
 || !
ri
) ;

2098 
r
 = 
»¶y
;

2102 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ERROR
)

2103 
ri
->
Ï¡_pub_time
 = 
	`m¡ime
();

2104 
	}
}

2111 
	$£Áš–ProûssH–loMes§ge
(*
h–lo
, 
h–lo_Ën
) {

2115 
numtok’s
, 
pÜt
, 
»moved
, 
ma¡”_pÜt
;

2116 
ušt64_t
 
cu¼’t_•och
, 
ma¡”_cÚfig_•och
;

2117 **
tok’
 = 
	`sds¥l™Ën
(
h–lo
, 
h–lo_Ën
, ",", 1, &
numtok’s
);

2118 
£Áš–RedisIn¡ªû
 *
si
, *
ma¡”
;

2120 ià(
numtok’s
 == 8) {

2122 
ma¡”
 = 
	`£Áš–G‘Ma¡”ByName
(
tok’
[4]);

2123 ià(!
ma¡”
è
ş—nup
;

2126 
pÜt
 = 
	`©oi
(
tok’
[1]);

2127 
ma¡”_pÜt
 = 
	`©oi
(
tok’
[6]);

2128 
si
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(

2129 
ma¡”
->
£Áš–s
,
tok’
[0],
pÜt
,token[2]);

2130 
cu¼’t_•och
 = 
	`¡¹ouÎ
(
tok’
[3],
NULL
,10);

2131 
ma¡”_cÚfig_•och
 = 
	`¡¹ouÎ
(
tok’
[7],
NULL
,10);

2133 ià(!
si
) {

2137 
»moved
 = 
	`»moveM©chšgS’tš–sFromMa¡”
(
ma¡”
,
tok’
[0],
pÜt
,

2138 
tok’
[2]);

2139 ià(
»moved
) {

2140 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"-dup-£Áš–",
ma¡”
,

2142 
tok’
[0],
pÜt
,token[2]);

2146 
si
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
NULL
,
SRI_SENTINEL
,

2147 
tok’
[0],
pÜt
,
ma¡”
->
quÜum
,master);

2148 ià(
si
) {

2149 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+£Áš–",
si
,"%@");

2153 
si
->
runid
 = 
	`sd¢ew
(
tok’
[2]);

2154 
	`£Áš–FlushCÚfig
();

2159 ià(
cu¼’t_•och
 > 
£Áš–
.current_epoch) {

2160 
£Áš–
.
cu¼’t_•och
 = current_epoch;

2161 
	`£Áš–FlushCÚfig
();

2162 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

2163 (è
£Áš–
.
cu¼’t_•och
);

2167 ià(
ma¡”
->
cÚfig_•och
 < 
ma¡”_cÚfig_•och
) {

2168 
ma¡”
->
cÚfig_•och
 = 
ma¡”_cÚfig_•och
;

2169 ià(
ma¡”_pÜt
 !ğ
ma¡”
->
addr
->
pÜt
 ||

2170 
	`¡rcmp
(
ma¡”
->
addr
->

, 
tok’
[5]))

2172 
£Áš–Addr
 *
Şd_addr
;

2174 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+cÚfig-upd©e-äom",
si
,"%@");

2175 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+switch-master",

2176 
ma¡”
,"%s %s %d %s %d",

2177 
ma¡”
->
Çme
,

2178 
ma¡”
->
addr
->

, ma¡”->addr->
pÜt
,

2179 
tok’
[5], 
ma¡”_pÜt
);

2181 
Şd_addr
 = 
	`dupS’tš–Addr
(
ma¡”
->
addr
);

2182 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
, 
tok’
[5], 
ma¡”_pÜt
);

2183 
	`£Áš–C®lCl›ÁRecÚfSüt
(
ma¡”
,

2184 
SENTINEL_OBSERVER
,"start",

2185 
Şd_addr
,
ma¡”
->
addr
);

2186 
	`»Ëa£S’tš–Addr
(
Şd_addr
);

2191 ià(
si
èsi->
Ï¡_h–lo_time
 = 
	`m¡ime
();

2194 
ş—nup
:

2195 
	`sdsä“¥l™»s
(
tok’
,
numtok’s
);

2196 
	}
}

2201 
	$£Áš–ReûiveH–loMes§ges
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

2202 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

2203 
»disR•ly
 *
r
;

2204 
	`REDIS_NOTUSED
(
´ivd©a
);

2206 ià(!
»¶y
 || !
ri
) ;

2207 
r
 = 
»¶y
;

2212 
ri
->
pc_Ï¡_aùiv™y
 = 
	`m¡ime
();

2216 ià(
r
->
ty³
 !ğ
REDIS_REPLY_ARRAY
 ||

2217 
r
->
–em’ts
 != 3 ||

2218 
r
->
–em’t
[0]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2219 
r
->
–em’t
[1]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2220 
r
->
–em’t
[2]->
ty³
 !ğ
REDIS_REPLY_STRING
 ||

2221 
	`¡rcmp
(
r
->
–em’t
[0]->
¡r
,"message") != 0) ;

2224 ià(
	`¡r¡r
(
r
->
–em’t
[2]->
¡r
,
£rv”
.
runid
è!ğ
NULL
) ;

2226 
	`£Áš–ProûssH–loMes§ge
(
r
->
–em’t
[2]->
¡r
,„->–em’t[2]->
Ën
);

2227 
	}
}

2240 
	$£Áš–S’dH–lo
(
£Áš–RedisIn¡ªû
 *
ri
) {

2241 

[
REDIS_IP_STR_LEN
];

2242 
·ylßd
[
REDIS_IP_STR_LEN
+1024];

2243 
»tv®
;

2244 *
ªnounû_
;

2245 
ªnounû_pÜt
;

2246 
£Áš–RedisIn¡ªû
 *
ma¡”
 = (
ri
->
æags
 & 
SRI_MASTER
) ?„i :„i->master;

2247 
£Áš–Addr
 *
ma¡”_addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ma¡”
);

2249 ià(
ri
->
æags
 & 
SRI_DISCONNECTED
è 
REDIS_ERR
;

2253 ià(
£Áš–
.
ªnounû_
) {

2254 
ªnounû_
 = 
£Áš–
.announce_ip;

2256 ià(
	`ª‘SockName
(
ri
->
cc
->
c
.
fd
,

,(),
NULL
) == -1)

2257  
REDIS_ERR
;

2258 
ªnounû_
 = 

;

2260 
ªnounû_pÜt
 = 
£Áš–
.announce_port ?

2261 
£Áš–
.
ªnounû_pÜt
 : 
£rv”
.
pÜt
;

2264 
	`¢´štf
(
·ylßd
,(payload),

2267 
ªnounû_
, 
ªnounû_pÜt
, 
£rv”
.
runid
,

2268 (è
£Áš–
.
cu¼’t_•och
,

2270 
ma¡”
->
Çme
,
ma¡”_addr
->

,ma¡”_addr->
pÜt
,

2271 (è
ma¡”
->
cÚfig_•och
);

2272 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

2273 
£Áš–PublishR•lyC®lback
, 
NULL
, "PUBLISH %s %s",

2274 
SENTINEL_HELLO_CHANNEL
,
·ylßd
);

2275 ià(
»tv®
 !ğ
REDIS_OK
è 
REDIS_ERR
;

2276 
ri
->
³ndšg_commªds
++;

2277  
REDIS_OK
;

2278 
	}
}

2282 
	$£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

2283 
diùI‹¿tÜ
 *
di
;

2284 
diùEÁry
 *
de
;

2286 
di
 = 
	`diùG‘SaãI‹¿tÜ
(
š¡ªûs
);

2287 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2288 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2289 ià(
ri
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2290 
ri
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2292 
	`diùR–—£I‹¿tÜ
(
di
);

2293 
	}
}

2303 
	$£Áš–FÜûH–loUpd©eFÜMa¡”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

2304 ià(!(
ma¡”
->
æags
 & 
SRI_MASTER
)è 
REDIS_ERR
;

2305 ià(
ma¡”
->
Ï¡_pub_time
 >ğ(
SENTINEL_PUBLISH_PERIOD
+1))

2306 
ma¡”
->
Ï¡_pub_time
 -ğ(
SENTINEL_PUBLISH_PERIOD
+1);

2307 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
£Áš–s
);

2308 
	`£Áš–FÜûH–loUpd©eDiùOfRedisIn¡ªûs
(
ma¡”
->
¦aves
);

2309  
REDIS_OK
;

2310 
	}
}

2317 
	$£Áš–S’dPšg
(
£Áš–RedisIn¡ªû
 *
ri
) {

2318 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

2319 
£Áš–PšgR•lyC®lback
, 
NULL
, "PING");

2320 ià(
»tv®
 =ğ
REDIS_OK
) {

2321 
ri
->
³ndšg_commªds
++;

2325 ià(
ri
->
Ï¡_pšg_time
 =ğ0èri->Ï¡_pšg_timğ
	`m¡ime
();

2330 
	}
}

2334 
	$£Áš–S’dP”iodicCommªds
(
£Áš–RedisIn¡ªû
 *
ri
) {

2335 
m¡ime_t
 
now
 = 
	`m¡ime
();

2336 
m¡ime_t
 
šfo_³riod
, 
pšg_³riod
;

2337 
»tv®
;

2341 ià(
ri
->
æags
 & 
SRI_DISCONNECTED
) ;

2349 ià(
ri
->
³ndšg_commªds
 >ğ
SENTINEL_MAX_PENDING_COMMANDS
) ;

2355 ià((
ri
->
æags
 & 
SRI_SLAVE
) &&

2356 (
ri
->
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
))) {

2357 
šfo_³riod
 = 1000;

2359 
šfo_³riod
 = 
SENTINEL_INFO_PERIOD
;

2365 
pšg_³riod
 = 
ri
->
down_aá”_³riod
;

2366 ià(
pšg_³riod
 > 
SENTINEL_PING_PERIOD
)…ing_period = SENTINEL_PING_PERIOD;

2368 ià((
ri
->
æags
 & 
SRI_SENTINEL
) == 0 &&

2369 (
ri
->
šfo_»äesh
 == 0 ||

2370 (
now
 - 
ri
->
šfo_»äesh
è> 
šfo_³riod
))

2373 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

2374 
£Áš–InfoR•lyC®lback
, 
NULL
, "INFO");

2375 ià(
»tv®
 =ğ
REDIS_OK
è
ri
->
³ndšg_commªds
++;

2376 } ià((
now
 - 
ri
->
Ï¡_pÚg_time
è> 
pšg_³riod
) {

2378 
	`£Áš–S’dPšg
(
ri
);

2379 } ià((
now
 - 
ri
->
Ï¡_pub_time
è> 
SENTINEL_PUBLISH_PERIOD
) {

2381 
	`£Áš–S’dH–lo
(
ri
);

2383 
	}
}

2387 cÚ¡ *
	$£Áš–Faov”S‹SŒ
(
¡©e
) {

2388 
¡©e
) {

2389 
SENTINEL_FAILOVER_STATE_NONE
:  "none";

2390 
SENTINEL_FAILOVER_STATE_WAIT_START
:  "wait_start";

2391 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:  "select_slave";

2392 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:  "send_slaveof_noone";

2393 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:  "wait_promotion";

2394 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:  "reconf_slaves";

2395 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
:  "update_config";

2398 
	}
}

2401 
	$addR•lyS’tš–RedisIn¡ªû
(
»disCl›Á
 *
c
, 
£Áš–RedisIn¡ªû
 *
ri
) {

2402 *
æags
 = 
	`sd£m±y
();

2403 *
mbl
;

2404 
f›lds
 = 0;

2406 
mbl
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2408 
	`addR•lyBulkCSŒšg
(
c
,"name");

2409 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

2410 
f›lds
++;

2412 
	`addR•lyBulkCSŒšg
(
c
,"ip");

2413 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
addr
->

);

2414 
f›lds
++;

2416 
	`addR•lyBulkCSŒšg
(
c
,"port");

2417 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
addr
->
pÜt
);

2418 
f›lds
++;

2420 
	`addR•lyBulkCSŒšg
(
c
,"runid");

2421 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
runid
 ?„i->runid : "");

2422 
f›lds
++;

2424 
	`addR•lyBulkCSŒšg
(
c
,"flags");

2425 ià(
ri
->
æags
 & 
SRI_S_DOWN
èæag ğ
	`sdsÿt
(flags,"s_down,");

2426 ià(
ri
->
æags
 & 
SRI_O_DOWN
èæag ğ
	`sdsÿt
(flags,"o_down,");

2427 ià(
ri
->
æags
 & 
SRI_MASTER
èæag ğ
	`sdsÿt
(flags,"master,");

2428 ià(
ri
->
æags
 & 
SRI_SLAVE
èæag ğ
	`sdsÿt
(flags,"slave,");

2429 ià(
ri
->
æags
 & 
SRI_SENTINEL
èæag ğ
	`sdsÿt
(flags,"sentinel,");

2430 ià(
ri
->
æags
 & 
SRI_DISCONNECTED
èæag ğ
	`sdsÿt
(flags,"disconnected,");

2431 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
èæag ğ
	`sdsÿt
(flags,"master_down,");

2432 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)

2433 
æags
 = 
	`sdsÿt
(flags,"failover_in_progress,");

2434 ià(
ri
->
æags
 & 
SRI_PROMOTED
èæag ğ
	`sdsÿt
(flags,"promoted,");

2435 ià(
ri
->
æags
 & 
SRI_RECONF_SENT
èæag ğ
	`sdsÿt
(flags,"reconf_sent,");

2436 ià(
ri
->
æags
 & 
SRI_RECONF_INPROG
èæag ğ
	`sdsÿt
(flags,"reconf_inprog,");

2437 ià(
ri
->
æags
 & 
SRI_RECONF_DONE
èæag ğ
	`sdsÿt
(flags,"reconf_done,");

2439 ià(
	`sd¦’
(
æags
è!ğ0è
	`sd¤ªge
(flags,0,-2);

2440 
	`addR•lyBulkCSŒšg
(
c
,
æags
);

2441 
	`sdsä“
(
æags
);

2442 
f›lds
++;

2444 
	`addR•lyBulkCSŒšg
(
c
,"pending-commands");

2445 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
³ndšg_commªds
);

2446 
f›lds
++;

2448 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2449 
	`addR•lyBulkCSŒšg
(
c
,"failover-state");

2450 
	`addR•lyBulkCSŒšg
(
c
,(*)
	`£Áš–Faov”S‹SŒ
(
ri
->
çov”_¡©e
));

2451 
f›lds
++;

2454 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-sent");

2455 
	`addR•lyBulkLÚgLÚg
(
c
,

2456 
ri
->
Ï¡_pšg_time
 ? (
	`m¡ime
() -„i->last_ping_time) : 0);

2457 
f›lds
++;

2459 
	`addR•lyBulkCSŒšg
(
c
,"last-ok-ping-reply");

2460 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_ava_time
);

2461 
f›lds
++;

2463 
	`addR•lyBulkCSŒšg
(
c
,"last-ping-reply");

2464 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_pÚg_time
);

2465 
f›lds
++;

2467 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

2468 
	`addR•lyBulkCSŒšg
(
c
,"s-down-time");

2469 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
s_down_sšû_time
);

2470 
f›lds
++;

2473 ià(
ri
->
æags
 & 
SRI_O_DOWN
) {

2474 
	`addR•lyBulkCSŒšg
(
c
,"o-down-time");

2475 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
()-
ri
->
o_down_sšû_time
);

2476 
f›lds
++;

2479 
	`addR•lyBulkCSŒšg
(
c
,"down-after-milliseconds");

2480 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
down_aá”_³riod
);

2481 
f›lds
++;

2484 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

2485 
	`addR•lyBulkCSŒšg
(
c
,"info-refresh");

2486 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
šfo_»äesh
);

2487 
f›lds
++;

2489 
	`addR•lyBulkCSŒšg
(
c
,"role-reported");

2490 
	`addR•lyBulkCSŒšg
(
c
, (
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_MASTER
) ? "master" :

2492 
f›lds
++;

2494 
	`addR•lyBulkCSŒšg
(
c
,"role-reported-time");

2495 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
);

2496 
f›lds
++;

2500 ià(
ri
->
æags
 & 
SRI_MASTER
) {

2501 
	`addR•lyBulkCSŒšg
(
c
,"config-epoch");

2502 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
cÚfig_•och
);

2503 
f›lds
++;

2505 
	`addR•lyBulkCSŒšg
(
c
,"num-slaves");

2506 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
¦aves
));

2507 
f›lds
++;

2509 
	`addR•lyBulkCSŒšg
(
c
,"num-other-sentinels");

2510 
	`addR•lyBulkLÚgLÚg
(
c
,
	`diùSize
(
ri
->
£Áš–s
));

2511 
f›lds
++;

2513 
	`addR•lyBulkCSŒšg
(
c
,"quorum");

2514 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
quÜum
);

2515 
f›lds
++;

2517 
	`addR•lyBulkCSŒšg
(
c
,"failover-timeout");

2518 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
çov”_timeout
);

2519 
f›lds
++;

2521 
	`addR•lyBulkCSŒšg
(
c
,"parallel-syncs");

2522 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
·¿Î–_syncs
);

2523 
f›lds
++;

2525 ià(
ri
->
nÙifiÿtiÚ_süt
) {

2526 
	`addR•lyBulkCSŒšg
(
c
,"notification-script");

2527 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
nÙifiÿtiÚ_süt
);

2528 
f›lds
++;

2531 ià(
ri
->
ş›Á_»cÚfig_süt
) {

2532 
	`addR•lyBulkCSŒšg
(
c
,"client-reconfig-script");

2533 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
ş›Á_»cÚfig_süt
);

2534 
f›lds
++;

2539 ià(
ri
->
æags
 & 
SRI_SLAVE
) {

2540 
	`addR•lyBulkCSŒšg
(
c
,"master-link-down-time");

2541 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
ma¡”_lšk_down_time
);

2542 
f›lds
++;

2544 
	`addR•lyBulkCSŒšg
(
c
,"master-link-status");

2545 
	`addR•lyBulkCSŒšg
(
c
,

2546 (
ri
->
¦ave_ma¡”_lšk_¡©us
 =ğ
SENTINEL_MASTER_LINK_STATUS_UP
) ?

2548 
f›lds
++;

2550 
	`addR•lyBulkCSŒšg
(
c
,"master-host");

2551 
	`addR•lyBulkCSŒšg
(
c
,

2552 
ri
->
¦ave_ma¡”_ho¡
 ?„i->slave_master_host : "?");

2553 
f›lds
++;

2555 
	`addR•lyBulkCSŒšg
(
c
,"master-port");

2556 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_ma¡”_pÜt
);

2557 
f›lds
++;

2559 
	`addR•lyBulkCSŒšg
(
c
,"slave-priority");

2560 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_´iÜ™y
);

2561 
f›lds
++;

2563 
	`addR•lyBulkCSŒšg
(
c
,"slave-repl-offset");

2564 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
¦ave_»¶_off£t
);

2565 
f›lds
++;

2569 ià(
ri
->
æags
 & 
SRI_SENTINEL
) {

2570 
	`addR•lyBulkCSŒšg
(
c
,"last-hello-message");

2571 
	`addR•lyBulkLÚgLÚg
(
c
,
	`m¡ime
(è- 
ri
->
Ï¡_h–lo_time
);

2572 
f›lds
++;

2574 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader");

2575 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Ëad”
 ?„i->leader : "?");

2576 
f›lds
++;

2578 
	`addR•lyBulkCSŒšg
(
c
,"voted-leader-epoch");

2579 
	`addR•lyBulkLÚgLÚg
(
c
,
ri
->
Ëad”_•och
);

2580 
f›lds
++;

2583 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
mbl
,
f›lds
*2);

2584 
	}
}

2588 
	$addR•lyDiùOfRedisIn¡ªûs
(
»disCl›Á
 *
c
, 
diù
 *
š¡ªûs
) {

2589 
diùI‹¿tÜ
 *
di
;

2590 
diùEÁry
 *
de
;

2592 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

2593 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
š¡ªûs
));

2594 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2595 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2597 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2599 
	`diùR–—£I‹¿tÜ
(
di
);

2600 
	}
}

2605 
£Áš–RedisIn¡ªû
 *
	$£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
»disCl›Á
 *
c
,

2606 
robj
 *
Çme
)

2608 
£Áš–RedisIn¡ªû
 *
ri
;

2610 
ri
 = 
	`diùF‘chV®ue
(
£Áš–
.
ma¡”s
,
Çme
->
±r
);

2611 ià(!
ri
) {

2612 
	`addR•lyE¼Ü
(
c
,"No such master withhat‚ame");

2613  
NULL
;

2615  
ri
;

2616 
	}
}

2618 
	$£Áš–Commªd
(
»disCl›Á
 *
c
) {

2619 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"masters")) {

2621 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

2622 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
£Áš–
.
ma¡”s
);

2623 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"master")) {

2625 
£Áš–RedisIn¡ªû
 *
ri
;

2627 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2628 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2629 =ğ
NULL
) ;

2630 
	`addR•lyS’tš–RedisIn¡ªû
(
c
,
ri
);

2631 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"slaves")) {

2633 
£Áš–RedisIn¡ªû
 *
ri
;

2635 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2636 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2638 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
¦aves
);

2639 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"sentinels")) {

2641 
£Áš–RedisIn¡ªû
 *
ri
;

2643 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2644 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2646 
	`addR•lyDiùOfRedisIn¡ªûs
(
c
,
ri
->
£Áš–s
);

2647 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"is-master-down-by-addr")) {

2649 
£Áš–RedisIn¡ªû
 *
ri
;

2650 
»q_•och
;

2651 
ušt64_t
 
Ëad”_•och
 = 0;

2652 *
Ëad”
 = 
NULL
;

2653 
pÜt
;

2654 
isdown
 = 0;

2656 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

2657 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
pÜt
,
NULL
è!ğ
REDIS_OK
 ||

2658 
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
»q_•och
,
NULL
)

2659 !ğ
REDIS_OK
)

2661 
ri
 = 
	`g‘S’tš–RedisIn¡ªûByAddrAndRunID
(
£Áš–
.
ma¡”s
,

2662 
c
->
¬gv
[2]->
±r
,
pÜt
,
NULL
);

2666 ià(!
£Áš–
.
tt
 && 
ri
 && (ri->
æags
 & 
SRI_S_DOWN
) &&

2667 (
ri
->
æags
 & 
SRI_MASTER
))

2668 
isdown
 = 1;

2672 ià(
ri
 &&„i->
æags
 & 
SRI_MASTER
 && 
	`¡rÿ£cmp
(
c
->
¬gv
[5]->
±r
,"*")) {

2673 
Ëad”
 = 
	`£Áš–VÙeL—d”
(
ri
,(
ušt64_t
)
»q_•och
,

2674 
c
->
¬gv
[5]->
±r
,

2675 &
Ëad”_•och
);

2680 
	`addR•lyMuÉiBulkL’
(
c
,3);

2681 
	`addR•ly
(
c
, 
isdown
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

2682 
	`addR•lyBulkCSŒšg
(
c
, 
Ëad”
 ?†eader : "*");

2683 
	`addR•lyLÚgLÚg
(
c
, ()
Ëad”_•och
);

2684 ià(
Ëad”
è
	`sdsä“
(leader);

2685 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"reset")) {

2687 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2688 
	`addR•lyLÚgLÚg
(
c
,
	`£Áš–Re£tMa¡”sByP©‹º
(c->
¬gv
[2]->
±r
,
SENTINEL_GENERATE_EVENT
));

2689 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get-master-addr-by-name")) {

2691 
£Áš–RedisIn¡ªû
 *
ri
;

2693 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2694 
ri
 = 
	`£Áš–G‘Ma¡”ByName
(
c
->
¬gv
[2]->
±r
);

2695 ià(
ri
 =ğ
NULL
) {

2696 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

2698 
£Áš–Addr
 *
addr
 = 
	`£Áš–G‘Cu¼’tMa¡”Add»ss
(
ri
);

2700 
	`addR•lyMuÉiBulkL’
(
c
,2);

2701 
	`addR•lyBulkCSŒšg
(
c
,
addr
->

);

2702 
	`addR•lyBulkLÚgLÚg
(
c
,
addr
->
pÜt
);

2704 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"failover")) {

2706 
£Áš–RedisIn¡ªû
 *
ri
;

2708 ià(
c
->
¬gc
 !ğ3è
num¬g£¼
;

2709 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2])è=ğ
NULL
)

2711 ià(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
) {

2712 
	`addR•lySds
(
c
,
	`sd¢ew
("-INPROG Failover‡lready in…rogress\r\n"));

2715 ià(
	`£Áš–S–eùSÏve
(
ri
è=ğ
NULL
) {

2716 
	`addR•lySds
(
c
,
	`sd¢ew
("-NOGOODSLAVE No suitable slaveo…romote\r\n"));

2719 
	`»disLog
(
REDIS_WARNING
,"Executing user„equested FAILOVER of '%s'",

2720 
ri
->
Çme
);

2721 
	`£Áš–S¹Faov”
(
ri
);

2722 
ri
->
æags
 |ğ
SRI_FORCE_FAILOVER
;

2723 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2724 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"pending-scripts")) {

2727 ià(
c
->
¬gc
 !ğ2è
num¬g£¼
;

2728 
	`£Áš–P’dšgSütsCommªd
(
c
);

2729 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"monitor")) {

2731 
£Áš–RedisIn¡ªû
 *
ri
;

2732 
quÜum
, 
pÜt
;

2733 

[
REDIS_IP_STR_LEN
];

2735 ià(
c
->
¬gc
 !ğ6è
num¬g£¼
;

2736 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[5],&
quÜum
,"Invalid quorum")

2737 !ğ
REDIS_OK
) ;

2738 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[4],&
pÜt
,"Invalid…ort")

2739 !ğ
REDIS_OK
) ;

2743 ià(
	`ª‘ResŞveIP
(
NULL
,
c
->
¬gv
[3]->
±r
,

,()è=ğ
ANET_ERR
) {

2744 
	`addR•lyE¼Ü
(
c
,"Invalid IP‡ddress specified");

2749 
ri
 = 
	`ü—‹S’tš–RedisIn¡ªû
(
c
->
¬gv
[2]->
±r
,
SRI_MASTER
,

2750 
c
->
¬gv
[3]->
±r
,
pÜt
,
quÜum
,
NULL
);

2751 ià(
ri
 =ğ
NULL
) {

2752 
”ºo
) {

2753 
EBUSY
:

2754 
	`addR•lyE¼Ü
(
c
,"Duplicated master‚ame");

2756 
EINVAL
:

2757 
	`addR•lyE¼Ü
(
c
,"Invalid…ort‚umber");

2760 
	`addR•lyE¼Ü
(
c
,"Unspecifiedƒrror‡ddinghe instance");

2764 
	`£Áš–FlushCÚfig
();

2765 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+mÚ™Ü",
ri
,"%@ quÜum %d",ri->
quÜum
);

2766 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2768 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"remove")) {

2770 
£Áš–RedisIn¡ªû
 *
ri
;

2772 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2773 =ğ
NULL
) ;

2774 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-mÚ™Ü",
ri
,"%@");

2775 
	`diùD–‘e
(
£Áš–
.
ma¡”s
,
c
->
¬gv
[2]->
±r
);

2776 
	`£Áš–FlushCÚfig
();

2777 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2778 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"set")) {

2779 ià(
c
->
¬gc
 < 3 || c->¬gø% 2 =ğ0è
num¬g£¼
;

2780 
	`£Áš–S‘Commªd
(
c
);

2782 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown sentinel subcommand '%s'",

2783 (*)
c
->
¬gv
[1]->
±r
);

2787 
num¬g£¼
:

2788 
	`addR•lyE¼ÜFÜm©
(
c
,"Wrong‚umber of‡rguments for 'sentinel %s'",

2789 (*)
c
->
¬gv
[1]->
±r
);

2790 
	}
}

2793 
	$£Áš–InfoCommªd
(
»disCl›Á
 *
c
) {

2794 *
£ùiÚ
 = 
c
->
¬gc
 =ğ2 ? c->
¬gv
[1]->
±r
 : "default";

2795 
sds
 
šfo
 = 
	`sd£m±y
();

2796 
def£ùiÚs
 = !
	`¡rÿ£cmp
(
£ùiÚ
,"default");

2797 
£ùiÚs
 = 0;

2799 ià(
c
->
¬gc
 > 2) {

2800 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2804 ià(!
	`¡rÿ£cmp
(
£ùiÚ
,"£rv”"è|| 
def£ùiÚs
) {

2805 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2806 
sds
 
£rv”£ùiÚ
 = 
	`g’RedisInfoSŒšg
("server");

2807 
šfo
 = 
	`sdsÿ’
(šfo,
£rv”£ùiÚ
,
	`sd¦’
(serversection));

2808 
	`sdsä“
(
£rv”£ùiÚ
);

2811 ià(!
	`¡rÿ£cmp
(
£ùiÚ
,"£Áš–"è|| 
def£ùiÚs
) {

2812 
diùI‹¿tÜ
 *
di
;

2813 
diùEÁry
 *
de
;

2814 
ma¡”_id
 = 0;

2816 ià(
£ùiÚs
++è
šfo
 = 
	`sdsÿt
(info,"\r\n");

2817 
šfo
 = 
	`sdsÿrštf
(info,

2823 
	`diùSize
(
£Áš–
.
ma¡”s
),

2824 
£Áš–
.
tt
,

2825 
£Áš–
.
ruÂšg_süts
,

2826 
	`li¡L’gth
(
£Áš–
.
süts_queue
));

2828 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

2829 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2830 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2831 *
¡©us
 = "ok";

2833 ià(
ri
->
æags
 & 
SRI_O_DOWN
è
¡©us
 = "odown";

2834 ià(
ri
->
æags
 & 
SRI_S_DOWN
è
¡©us
 = "sdown";

2835 
šfo
 = 
	`sdsÿrštf
(info,

2838 
ma¡”_id
++, 
ri
->
Çme
, 
¡©us
,

2839 
ri
->
addr
->

,„i->addr->
pÜt
,

2840 
	`diùSize
(
ri
->
¦aves
),

2841 
	`diùSize
(
ri
->
£Áš–s
)+1);

2843 
	`diùR–—£I‹¿tÜ
(
di
);

2846 
	`addR•lySds
(
c
,
	`sdsÿrštf
(
	`sd£m±y
(),"$%lu\r\n",

2847 ()
	`sd¦’
(
šfo
)));

2848 
	`addR•lySds
(
c
,
šfo
);

2849 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

2850 
	}
}

2854 
	$£Áš–RŞeCommªd
(
»disCl›Á
 *
c
) {

2855 
diùI‹¿tÜ
 *
di
;

2856 
diùEÁry
 *
de
;

2858 
	`addR•lyMuÉiBulkL’
(
c
,2);

2859 
	`addR•lyBulkCBufãr
(
c
,"sentinel",8);

2860 
	`addR•lyMuÉiBulkL’
(
c
,
	`diùSize
(
£Áš–
.
ma¡”s
));

2862 
di
 = 
	`diùG‘I‹¿tÜ
(
£Áš–
.
ma¡”s
);

2863 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2864 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

2866 
	`addR•lyBulkCSŒšg
(
c
,
ri
->
Çme
);

2868 
	`diùR–—£I‹¿tÜ
(
di
);

2869 
	}
}

2872 
	$£Áš–S‘Commªd
(
»disCl›Á
 *
c
) {

2873 
£Áš–RedisIn¡ªû
 *
ri
;

2874 
j
, 
chªges
 = 0;

2875 *
İtiÚ
, *
v®ue
;

2877 ià((
ri
 = 
	`£Áš–G‘Ma¡”ByNameOrR•lyE¼Ü
(
c
,c->
¬gv
[2]))

2878 =ğ
NULL
) ;

2881 
j
 = 3; j < 
c
->
¬gc
; j += 2) {

2882 
İtiÚ
 = 
c
->
¬gv
[
j
]->
±r
;

2883 
v®ue
 = 
c
->
¬gv
[
j
+1]->
±r
;

2884 
robj
 *
o
 = 
c
->
¬gv
[
j
+1];

2885 
Î
;

2887 ià(!
	`¡rÿ£cmp
(
İtiÚ
,"down-after-milliseconds")) {

2889 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†l <= 0)

2890 
badfmt
;

2891 
ri
->
down_aá”_³riod
 = 
Î
;

2892 
	`£Áš–Prİag©eDownAá”P”iod
(
ri
);

2893 
chªges
++;

2894 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"failover-timeout")) {

2896 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†l <= 0)

2897 
badfmt
;

2898 
ri
->
çov”_timeout
 = 
Î
;

2899 
chªges
++;

2900 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"parallel-syncs")) {

2902 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†l <= 0)

2903 
badfmt
;

2904 
ri
->
·¿Î–_syncs
 = 
Î
;

2905 
chªges
++;

2906 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"notification-script")) {

2908 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

2909 
	`addR•lyE¼Ü
(
c
,

2911 ià(
chªges
è
	`£Áš–FlushCÚfig
();

2914 
	`sdsä“
(
ri
->
nÙifiÿtiÚ_süt
);

2915 
ri
->
nÙifiÿtiÚ_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

2916 
chªges
++;

2917 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"client-reconfig-script")) {

2919 ià(
	`¡¾’
(
v®ue
è&& 
	`acûss
(v®ue,
X_OK
) == -1) {

2920 
	`addR•lyE¼Ü
(
c
,

2923 ià(
chªges
è
	`£Áš–FlushCÚfig
();

2926 
	`sdsä“
(
ri
->
ş›Á_»cÚfig_süt
);

2927 
ri
->
ş›Á_»cÚfig_süt
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

2928 
chªges
++;

2929 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"auth-pass")) {

2931 
	`sdsä“
(
ri
->
auth_·ss
);

2932 
ri
->
auth_·ss
 = 
	`¡¾’
(
v®ue
è? 
	`sd¢ew
(v®ueè: 
NULL
;

2933 
chªges
++;

2934 } ià(!
	`¡rÿ£cmp
(
İtiÚ
,"quorum")) {

2936 ià(
	`g‘LÚgLÚgFromObjeù
(
o
,&
Î
è=ğ
REDIS_ERR
 ||†l <= 0)

2937 
badfmt
;

2938 
ri
->
quÜum
 = 
Î
;

2939 
chªges
++;

2941 
	`addR•lyE¼ÜFÜm©
(
c
,"Unknown option '%s' for SENTINEL SET",

2942 
İtiÚ
);

2943 ià(
chªges
è
	`£Áš–FlushCÚfig
();

2946 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+£t",
ri
,"%@ % %s",
İtiÚ
,
v®ue
);

2949 ià(
chªges
è
	`£Áš–FlushCÚfig
();

2950 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

2953 
badfmt
:

2954 ià(
chªges
è
	`£Áš–FlushCÚfig
();

2955 
	`addR•lyE¼ÜFÜm©
(
c
,"Invalid‡rgument '%s' for SENTINEL SET '%s'",

2956 
v®ue
, 
İtiÚ
);

2957 
	}
}

2965 
	$£Áš–PublishCommªd
(
»disCl›Á
 *
c
) {

2966 ià(
	`¡rcmp
(
c
->
¬gv
[1]->
±r
,
SENTINEL_HELLO_CHANNEL
)) {

2967 
	`addR•lyE¼Ü
(
c
, "Only HELLO messages‡re‡ccepted by Sentinel instances.");

2970 
	`£Áš–ProûssH–loMes§ge
(
c
->
¬gv
[2]->
±r
,
	`sd¦’
(c->argv[2]->ptr));

2971 
	`addR•lyLÚgLÚg
(
c
,1);

2972 
	}
}

2977 
	$£Áš–CheckSubjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ri
) {

2978 
m¡ime_t
 
–­£d
 = 0;

2980 ià(
ri
->
Ï¡_pšg_time
)

2981 
–­£d
 = 
	`m¡ime
(è- 
ri
->
Ï¡_pšg_time
;

2989 ià(
ri
->
cc
 &&

2990 (
	`m¡ime
(è- 
ri
->
cc_cÚn_time
è> 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

2991 
ri
->
Ï¡_pšg_time
 != 0 &&

2994 (
	`m¡ime
(è- 
ri
->
Ï¡_pšg_time
è> (ri->
down_aá”_³riod
/2) &&

2995 (
	`m¡ime
(è- 
ri
->
Ï¡_pÚg_time
è> (ri->
down_aá”_³riod
/2))

2997 
	`£Áš–KlLšk
(
ri
,ri->
cc
);

3005 ià(
ri
->
pc
 &&

3006 (
	`m¡ime
(è- 
ri
->
pc_cÚn_time
è> 
SENTINEL_MIN_LINK_RECONNECT_PERIOD
 &&

3007 (
	`m¡ime
(è- 
ri
->
pc_Ï¡_aùiv™y
è> (
SENTINEL_PUBLISH_PERIOD
*3))

3009 
	`£Áš–KlLšk
(
ri
,ri->
pc
);

3018 ià(
–­£d
 > 
ri
->
down_aá”_³riod
 ||

3019 (
ri
->
æags
 & 
SRI_MASTER
 &&

3020 
ri
->
rŞe_»pÜ‹d
 =ğ
SRI_SLAVE
 &&

3021 
	`m¡ime
(è- 
ri
->
rŞe_»pÜ‹d_time
 >

3022 (
ri
->
down_aá”_³riod
+
SENTINEL_INFO_PERIOD
*2)))

3025 ià((
ri
->
æags
 & 
SRI_S_DOWN
) == 0) {

3026 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+sdown",
ri
,"%@");

3027 
ri
->
s_down_sšû_time
 = 
	`m¡ime
();

3028 
ri
->
æags
 |ğ
SRI_S_DOWN
;

3032 ià(
ri
->
æags
 & 
SRI_S_DOWN
) {

3033 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-sdown",
ri
,"%@");

3034 
ri
->
æags
 &ğ~(
SRI_S_DOWN
|
SRI_SCRIPT_KILL_SENT
);

3037 
	}
}

3045 
	$£Áš–CheckObjeùiv–yDown
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3046 
diùI‹¿tÜ
 *
di
;

3047 
diùEÁry
 *
de
;

3048 
quÜum
 = 0, 
odown
 = 0;

3050 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
) {

3052 
quÜum
 = 1;

3054 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3055 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3056 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3058 ià(
ri
->
æags
 & 
SRI_MASTER_DOWN
è
quÜum
++;

3060 
	`diùR–—£I‹¿tÜ
(
di
);

3061 ià(
quÜum
 >ğ
ma¡”
->quÜumè
odown
 = 1;

3065 ià(
odown
) {

3066 ià((
ma¡”
->
æags
 & 
SRI_O_DOWN
) == 0) {

3067 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+odown",
ma¡”
,"%@ #quorum %d/%d",

3068 
quÜum
, 
ma¡”
->quorum);

3069 
ma¡”
->
æags
 |ğ
SRI_O_DOWN
;

3070 
ma¡”
->
o_down_sšû_time
 = 
	`m¡ime
();

3073 ià(
ma¡”
->
æags
 & 
SRI_O_DOWN
) {

3074 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-odown",
ma¡”
,"%@");

3075 
ma¡”
->
æags
 &ğ~
SRI_O_DOWN
;

3078 
	}
}

3082 
	$£Áš–ReûiveIsMa¡”DownR•ly
(
»disAsyncCÚ‹xt
 *
c
, *
»¶y
, *
´ivd©a
) {

3083 
£Áš–RedisIn¡ªû
 *
ri
 = 
c
->
d©a
;

3084 
»disR•ly
 *
r
;

3085 
	`REDIS_NOTUSED
(
´ivd©a
);

3087 ià(
ri
èri->
³ndšg_commªds
--;

3088 ià(!
»¶y
 || !
ri
) ;

3089 
r
 = 
»¶y
;

3094 ià(
r
->
ty³
 =ğ
REDIS_REPLY_ARRAY
 &&„->
–em’ts
 == 3 &&

3095 
r
->
–em’t
[0]->
ty³
 =ğ
REDIS_REPLY_INTEGER
 &&

3096 
r
->
–em’t
[1]->
ty³
 =ğ
REDIS_REPLY_STRING
 &&

3097 
r
->
–em’t
[2]->
ty³
 =ğ
REDIS_REPLY_INTEGER
)

3099 
ri
->
Ï¡_ma¡”_down_»¶y_time
 = 
	`m¡ime
();

3100 ià(
r
->
–em’t
[0]->
š‹g”
 == 1) {

3101 
ri
->
æags
 |ğ
SRI_MASTER_DOWN
;

3103 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3105 ià(
	`¡rcmp
(
r
->
–em’t
[1]->
¡r
,"*")) {

3108 
	`sdsä“
(
ri
->
Ëad”
);

3109 ià(()
ri
->
Ëad”_•och
 !ğ
r
->
–em’t
[2]->
š‹g”
)

3110 
	`»disLog
(
REDIS_WARNING
,

3111 "% vÙed fÜ % %Îu", 
ri
->
Çme
,

3112 
r
->
–em’t
[1]->
¡r
,

3113 (è
r
->
–em’t
[2]->
š‹g”
);

3114 
ri
->
Ëad”
 = 
	`sd¢ew
(
r
->
–em’t
[1]->
¡r
);

3115 
ri
->
Ëad”_•och
 = 
r
->
–em’t
[2]->
š‹g”
;

3118 
	}
}

3124 
	#SENTINEL_ASK_FORCED
 (1<<0)

	)

3125 
	$£Áš–AskMa¡”S‹ToOth”S’tš–s
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
æags
) {

3126 
diùI‹¿tÜ
 *
di
;

3127 
diùEÁry
 *
de
;

3129 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3130 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3131 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3132 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
;

3133 
pÜt
[32];

3134 
»tv®
;

3137 ià(
–­£d
 > 
SENTINEL_ASK_PERIOD
*5) {

3138 
ri
->
æags
 &ğ~
SRI_MASTER_DOWN
;

3139 
	`sdsä“
(
ri
->
Ëad”
);

3140 
ri
->
Ëad”
 = 
NULL
;

3148 ià((
ma¡”
->
æags
 & 
SRI_S_DOWN
) == 0) ;

3149 ià(
ri
->
æags
 & 
SRI_DISCONNECTED
) ;

3150 ià(!(
æags
 & 
SENTINEL_ASK_FORCED
) &&

3151 
	`m¡ime
(è- 
ri
->
Ï¡_ma¡”_down_»¶y_time
 < 
SENTINEL_ASK_PERIOD
)

3155 
	`Î2¡ršg
(
pÜt
,ÕÜt),
ma¡”
->
addr
->port);

3156 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3157 
£Áš–ReûiveIsMa¡”DownR•ly
, 
NULL
,

3159 
ma¡”
->
addr
->

, 
pÜt
,

3160 
£Áš–
.
cu¼’t_•och
,

3161 (
ma¡”
->
çov”_¡©e
 > 
SENTINEL_FAILOVER_STATE_NONE
) ?

3162 
£rv”
.
runid
 : "*");

3163 ià(
»tv®
 =ğ
REDIS_OK
è
ri
->
³ndšg_commªds
++;

3165 
	`diùR–—£I‹¿tÜ
(
di
);

3166 
	}
}

3175 *
	$£Áš–VÙeL—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
»q_•och
, *
»q_runid
, ušt64_ˆ*
Ëad”_•och
) {

3176 ià(
»q_•och
 > 
£Áš–
.
cu¼’t_•och
) {

3177 
£Áš–
.
cu¼’t_•och
 = 
»q_•och
;

3178 
	`£Áš–FlushCÚfig
();

3179 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3180 (è
£Áš–
.
cu¼’t_•och
);

3183 ià(
ma¡”
->
Ëad”_•och
 < 
»q_•och
 && 
£Áš–
.
cu¼’t_•och
 <=„eq_epoch)

3185 
	`sdsä“
(
ma¡”
->
Ëad”
);

3186 
ma¡”
->
Ëad”
 = 
	`sd¢ew
(
»q_runid
);

3187 
ma¡”
->
Ëad”_•och
 = 
£Áš–
.
cu¼’t_•och
;

3188 
	`£Áš–FlushCÚfig
();

3189 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+vÙe-fÜ-Ëad”",
ma¡”
,"%s %llu",

3190 
ma¡”
->
Ëad”
, (èma¡”->
Ëad”_•och
);

3194 ià(
	`¡rÿ£cmp
(
ma¡”
->
Ëad”
,
£rv”
.
runid
))

3195 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3198 *
Ëad”_•och
 = 
ma¡”
->leader_epoch;

3199  
ma¡”
->
Ëad”
 ? 
	`sd¢ew
(ma¡”->Ëad”è: 
NULL
;

3200 
	}
}

3202 
	s£Áš–L—d”
 {

3203 *
	mrunid
;

3204 
	mvÙes
;

3209 
	$£Áš–L—d”Inü
(
diù
 *
couÁ”s
, *
runid
) {

3210 
diùEÁry
 *
de
 = 
	`diùFšd
(
couÁ”s
,
runid
);

3211 
ušt64_t
 
Şdv®
;

3213 ià(
de
) {

3214 
Şdv®
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3215 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,
Şdv®
+1);

3216  
Şdv®
+1;

3218 
de
 = 
	`diùAddRaw
(
couÁ”s
,
runid
);

3219 
	`»disAs£¹
(
de
 !ğ
NULL
);

3220 
	`diùS‘UnsigÃdIÁeg”V®
(
de
,1);

3223 
	}
}

3231 *
	$£Áš–G‘L—d”
(
£Áš–RedisIn¡ªû
 *
ma¡”
, 
ušt64_t
 
•och
) {

3232 
diù
 *
couÁ”s
;

3233 
diùI‹¿tÜ
 *
di
;

3234 
diùEÁry
 *
de
;

3235 
vÙ”s
 = 0, 
vÙ”s_quÜum
;

3236 *
myvÙe
;

3237 *
wšÃr
 = 
NULL
;

3238 
ušt64_t
 
Ëad”_•och
;

3239 
ušt64_t
 
max_vÙes
 = 0;

3241 
	`»disAs£¹
(
ma¡”
->
æags
 & (
SRI_O_DOWN
|
SRI_FAILOVER_IN_PROGRESS
));

3242 
couÁ”s
 = 
	`diùC»©e
(&
Ëad”VÙesDiùTy³
,
NULL
);

3244 
vÙ”s
 = 
	`diùSize
(
ma¡”
->
£Áš–s
)+1;

3247 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
£Áš–s
);

3248 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3249 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3250 ià(
ri
->
Ëad”
 !ğ
NULL
 &&„i->
Ëad”_•och
 =ğ
£Áš–
.
cu¼’t_•och
)

3251 
	`£Áš–L—d”Inü
(
couÁ”s
,
ri
->
Ëad”
);

3253 
	`diùR–—£I‹¿tÜ
(
di
);

3258 
di
 = 
	`diùG‘I‹¿tÜ
(
couÁ”s
);

3259 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3260 
ušt64_t
 
vÙes
 = 
	`diùG‘UnsigÃdIÁeg”V®
(
de
);

3262 ià(
vÙes
 > 
max_vÙes
) {

3263 
max_vÙes
 = 
vÙes
;

3264 
wšÃr
 = 
	`diùG‘Key
(
de
);

3267 
	`diùR–—£I‹¿tÜ
(
di
);

3272 ià(
wšÃr
)

3273 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
wšÃr
,&
Ëad”_•och
);

3275 
myvÙe
 = 
	`£Áš–VÙeL—d”
(
ma¡”
,
•och
,
£rv”
.
runid
,&
Ëad”_•och
);

3277 ià(
myvÙe
 && 
Ëad”_•och
 =ğ
•och
) {

3278 
ušt64_t
 
vÙes
 = 
	`£Áš–L—d”Inü
(
couÁ”s
,
myvÙe
);

3280 ià(
vÙes
 > 
max_vÙes
) {

3281 
max_vÙes
 = 
vÙes
;

3282 
wšÃr
 = 
myvÙe
;

3286 
vÙ”s_quÜum
 = 
vÙ”s
/2+1;

3287 ià(
wšÃr
 && (
max_vÙes
 < 
vÙ”s_quÜum
 || max_vÙe < 
ma¡”
->
quÜum
))

3288 
wšÃr
 = 
NULL
;

3290 
wšÃr
 = wšÃ¸? 
	`sd¢ew
(wšÃrè: 
NULL
;

3291 
	`sdsä“
(
myvÙe
);

3292 
	`diùR–—£
(
couÁ”s
);

3293  
wšÃr
;

3294 
	}
}

3306 
	$£Áš–S’dSÏveOf
(
£Áš–RedisIn¡ªû
 *
ri
, *
ho¡
, 
pÜt
) {

3307 
pÜt¡r
[32];

3308 
»tv®
;

3310 
	`Î2¡ršg
(
pÜt¡r
,ÕÜt¡r),
pÜt
);

3314 ià(
ho¡
 =ğ
NULL
) {

3315 
ho¡
 = "NO";

3316 
	`memıy
(
pÜt¡r
,"ONE",4);

3329 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3330 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "MULTI");

3331 ià(
»tv®
 =ğ
REDIS_ERR
) „etval;

3332 
ri
->
³ndšg_commªds
++;

3334 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3335 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "SLAVEOF % %s", 
ho¡
, 
pÜt¡r
);

3336 ià(
»tv®
 =ğ
REDIS_ERR
) „etval;

3337 
ri
->
³ndšg_commªds
++;

3339 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3340 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "CONFIG REWRITE");

3341 ià(
»tv®
 =ğ
REDIS_ERR
) „etval;

3342 
ri
->
³ndšg_commªds
++;

3349 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3350 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "CLIENT KILL TYPE‚ormal");

3351 ià(
»tv®
 =ğ
REDIS_ERR
) „etval;

3352 
ri
->
³ndšg_commªds
++;

3354 
»tv®
 = 
	`»disAsyncCommªd
(
ri
->
cc
,

3355 
£Áš–DisÿrdR•lyC®lback
, 
NULL
, "EXEC");

3356 ià(
»tv®
 =ğ
REDIS_ERR
) „etval;

3357 
ri
->
³ndšg_commªds
++;

3359  
REDIS_OK
;

3360 
	}
}

3363 
	$£Áš–S¹Faov”
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3364 
	`»disAs£¹
(
ma¡”
->
æags
 & 
SRI_MASTER
);

3366 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_START
;

3367 
ma¡”
->
æags
 |ğ
SRI_FAILOVER_IN_PROGRESS
;

3368 
ma¡”
->
çov”_•och
 = ++
£Áš–
.
cu¼’t_•och
;

3369 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+Ãw-•och",
ma¡”
,"%llu",

3370 (è
£Áš–
.
cu¼’t_•och
);

3371 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+Œy-çov”",
ma¡”
,"%@");

3372 
ma¡”
->
çov”_¡¬t_time
 = 
	`m¡ime
()+
	`¿nd
()%
SENTINEL_MAX_DESYNC
;

3373 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3374 
	}
}

3387 
	$£Áš–S¹Faov”IfN“ded
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3389 ià(!(
ma¡”
->
æags
 & 
SRI_O_DOWN
))  0;

3392 ià(
ma¡”
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)  0;

3395 ià(
	`m¡ime
(è- 
ma¡”
->
çov”_¡¬t_time
 <

3396 
ma¡”
->
çov”_timeout
*2)

3398 ià(
ma¡”
->
çov”_d–ay_logged
 !ğma¡”->
çov”_¡¬t_time
) {

3399 
time_t
 
şock
 = (
ma¡”
->
çov”_¡¬t_time
 +

3400 
ma¡”
->
çov”_timeout
*2) / 1000;

3401 
ùimebuf
[26];

3403 
	`ùime_r
(&
şock
,
ùimebuf
);

3404 
ùimebuf
[24] = '\0';

3405 
ma¡”
->
çov”_d–ay_logged
 = ma¡”->
çov”_¡¬t_time
;

3406 
	`»disLog
(
REDIS_WARNING
,

3408 
ùimebuf
);

3413 
	`£Áš–S¹Faov”
(
ma¡”
);

3415 
	}
}

3449 
	$com·»SÏvesFÜPromÙiÚ
(cÚ¡ *
a
, cÚ¡ *
b
) {

3450 
£Áš–RedisIn¡ªû
 **
§
 = (£Áš–RedisIn¡ªû **)
a
,

3451 **
sb
 = (
£Áš–RedisIn¡ªû
 **)
b
;

3452 *
§_runid
, *
sb_runid
;

3454 ià((*
§
)->
¦ave_´iÜ™y
 !ğ(*
sb
)->slave_priority)

3455  (*
§
)->
¦ave_´iÜ™y
 - (*
sb
)->slave_priority;

3459 ià((*
§
)->
¦ave_»¶_off£t
 > (*
sb
)->slave_repl_offset) {

3461 } ià((*
§
)->
¦ave_»¶_off£t
 < (*
sb
)->slave_repl_offset) {

3469 
§_runid
 = (*
§
)->
runid
;

3470 
sb_runid
 = (*
sb
)->
runid
;

3471 ià(
§_runid
 =ğ
NULL
 && 
sb_runid
 == NULL)  0;

3472 ià(
§_runid
 =ğ
NULL
)  1;

3473 ià(
sb_runid
 =ğ
NULL
)  -1;

3474  
	`¡rÿ£cmp
(
§_runid
, 
sb_runid
);

3475 
	}
}

3477 
£Áš–RedisIn¡ªû
 *
	$£Áš–S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3478 
£Áš–RedisIn¡ªû
 **
š¡ªû
 =

3479 
	`zm®loc
((
š¡ªû
[0])*
	`diùSize
(
ma¡”
->
¦aves
));

3480 
£Áš–RedisIn¡ªû
 *
£Ëùed
 = 
NULL
;

3481 
š¡ªûs
 = 0;

3482 
diùI‹¿tÜ
 *
di
;

3483 
diùEÁry
 *
de
;

3484 
m¡ime_t
 
max_ma¡”_down_time
 = 0;

3486 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3487 
max_ma¡”_down_time
 +ğ
	`m¡ime
(è- 
ma¡”
->
s_down_sšû_time
;

3488 
max_ma¡”_down_time
 +ğ
ma¡”
->
down_aá”_³riod
 * 10;

3490 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3491 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3492 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3493 
m¡ime_t
 
šfo_v®id™y_time
;

3495 ià(
¦ave
->
æags
 & (
SRI_S_DOWN
|
SRI_O_DOWN
|
SRI_DISCONNECTED
)) ;

3496 ià(
	`m¡ime
(è- 
¦ave
->
Ï¡_ava_time
 > 
SENTINEL_PING_PERIOD
*5) ;

3497 ià(
¦ave
->
¦ave_´iÜ™y
 == 0) ;

3502 ià(
ma¡”
->
æags
 & 
SRI_S_DOWN
)

3503 
šfo_v®id™y_time
 = 
SENTINEL_PING_PERIOD
*5;

3505 
šfo_v®id™y_time
 = 
SENTINEL_INFO_PERIOD
*3;

3506 ià(
	`m¡ime
(è- 
¦ave
->
šfo_»äesh
 > 
šfo_v®id™y_time
) ;

3507 ià(
¦ave
->
ma¡”_lšk_down_time
 > 
max_ma¡”_down_time
) ;

3508 
š¡ªû
[
š¡ªûs
++] = 
¦ave
;

3510 
	`diùR–—£I‹¿tÜ
(
di
);

3511 ià(
š¡ªûs
) {

3512 
	`qsÜt
(
š¡ªû
,
š¡ªûs
,(
£Áš–RedisIn¡ªû
*),

3513 
com·»SÏvesFÜPromÙiÚ
);

3514 
£Ëùed
 = 
š¡ªû
[0];

3516 
	`zä“
(
š¡ªû
);

3517  
£Ëùed
;

3518 
	}
}

3521 
	$£Áš–Faov”Wa™S¹
(
£Áš–RedisIn¡ªû
 *
ri
) {

3522 *
Ëad”
;

3523 
i¦—d”
;

3526 
Ëad”
 = 
	`£Áš–G‘L—d”
(
ri
,„i->
çov”_•och
);

3527 
i¦—d”
 = 
Ëad”
 && 
	`¡rÿ£cmp
Ö—d”,
£rv”
.
runid
) == 0;

3528 
	`sdsä“
(
Ëad”
);

3532 ià(!
i¦—d”
 && !(
ri
->
æags
 & 
SRI_FORCE_FAILOVER
)) {

3533 
–eùiÚ_timeout
 = 
SENTINEL_ELECTION_TIMEOUT
;

3537 ià(
–eùiÚ_timeout
 > 
ri
->
çov”_timeout
)

3538 
–eùiÚ_timeout
 = 
ri
->
çov”_timeout
;

3540 ià(
	`m¡ime
(è- 
ri
->
çov”_¡¬t_time
 > 
–eùiÚ_timeout
) {

3541 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-çov”-abÜt-nÙ-–eùed",
ri
,"%@");

3542 
	`£Áš–AbÜtFaov”
(
ri
);

3546 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+–eùed-Ëad”",
ri
,"%@");

3547 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
;

3548 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3549 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+çov”-¡©e-£Ëù-¦ave",
ri
,"%@");

3550 
	}
}

3552 
	$£Áš–Faov”S–eùSÏve
(
£Áš–RedisIn¡ªû
 *
ri
) {

3553 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`£Áš–S–eùSÏve
(
ri
);

3557 ià(
¦ave
 =ğ
NULL
) {

3558 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-çov”-abÜt-no-good-¦ave",
ri
,"%@");

3559 
	`£Áš–AbÜtFaov”
(
ri
);

3561 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+£Ëùed-¦ave",
¦ave
,"%@");

3562 
¦ave
->
æags
 |ğ
SRI_PROMOTED
;

3563 
ri
->
´omÙed_¦ave
 = 
¦ave
;

3564 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
;

3565 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3566 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+failover-state-send-slaveof-noone",

3567 
¦ave
, "%@");

3569 
	}
}

3571 
	$£Áš–Faov”S’dSÏveOfNoOÃ
(
£Áš–RedisIn¡ªû
 *
ri
) {

3572 
»tv®
;

3577 ià(
ri
->
´omÙed_¦ave
->
æags
 & 
SRI_DISCONNECTED
) {

3578 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

3579 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

3580 
	`£Áš–AbÜtFaov”
(
ri
);

3589 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
ri
->
´omÙed_¦ave
,
NULL
,0);

3590 ià(
»tv®
 !ğ
REDIS_OK
) ;

3591 
	`£Áš–Ev’t
(
REDIS_NOTICE
, "+failover-state-wait-promotion",

3592 
ri
->
´omÙed_¦ave
,"%@");

3593 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
;

3594 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3595 
	}
}

3599 
	$£Áš–Faov”Wa™PromÙiÚ
(
£Áš–RedisIn¡ªû
 *
ri
) {

3602 ià(
	`m¡ime
(è- 
ri
->
çov”_¡©e_chªge_time
 >„i->
çov”_timeout
) {

3603 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-çov”-abÜt-¦ave-timeout",
ri
,"%@");

3604 
	`£Áš–AbÜtFaov”
(
ri
);

3606 
	}
}

3608 
	$£Áš–Faov”D‘eùEnd
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3609 
nÙ_»cÚfigu»d
 = 0, 
timeout
 = 0;

3610 
diùI‹¿tÜ
 *
di
;

3611 
diùEÁry
 *
de
;

3612 
m¡ime_t
 
–­£d
 = 
	`m¡ime
(è- 
ma¡”
->
çov”_¡©e_chªge_time
;

3616 ià(
ma¡”
->
´omÙed_¦ave
 =ğ
NULL
 ||

3617 
ma¡”
->
´omÙed_¦ave
->
æags
 & 
SRI_S_DOWN
) ;

3621 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3622 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3623 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3625 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

3626 ià(
¦ave
->
æags
 & 
SRI_S_DOWN
) ;

3627 
nÙ_»cÚfigu»d
++;

3629 
	`diùR–—£I‹¿tÜ
(
di
);

3632 ià(
–­£d
 > 
ma¡”
->
çov”_timeout
) {

3633 
nÙ_»cÚfigu»d
 = 0;

3634 
timeout
 = 1;

3635 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+çov”-’d-fÜ-timeout",
ma¡”
,"%@");

3638 ià(
nÙ_»cÚfigu»d
 == 0) {

3639 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+çov”-’d",
ma¡”
,"%@");

3640 
ma¡”
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
;

3641 
ma¡”
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3647 ià(
timeout
) {

3648 
diùI‹¿tÜ
 *
di
;

3649 
diùEÁry
 *
de
;

3651 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3652 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3653 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3654 
»tv®
;

3656 ià(
¦ave
->
æags
 &

3657 (
SRI_RECONF_DONE
|
SRI_RECONF_SENT
|
SRI_DISCONNECTED
)) ;

3659 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

3660 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

3661 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

3662 ià(
»tv®
 =ğ
REDIS_OK
) {

3663 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave-»cÚf-£Á-be",
¦ave
,"%@");

3664 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

3667 
	`diùR–—£I‹¿tÜ
(
di
);

3669 
	}
}

3673 
	$£Áš–Faov”RecÚfNextSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3674 
diùI‹¿tÜ
 *
di
;

3675 
diùEÁry
 *
de
;

3676 
š_´og»ss
 = 0;

3678 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3679 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3680 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3682 ià(
¦ave
->
æags
 & (
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
))

3683 
š_´og»ss
++;

3685 
	`diùR–—£I‹¿tÜ
(
di
);

3687 
di
 = 
	`diùG‘I‹¿tÜ
(
ma¡”
->
¦aves
);

3688 
š_´og»ss
 < 
ma¡”
->
·¿Î–_syncs
 &&

3689 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

3691 
£Áš–RedisIn¡ªû
 *
¦ave
 = 
	`diùG‘V®
(
de
);

3692 
»tv®
;

3695 ià(
¦ave
->
æags
 & (
SRI_PROMOTED
|
SRI_RECONF_DONE
)) ;

3701 ià((
¦ave
->
æags
 & 
SRI_RECONF_SENT
) &&

3702 (
	`m¡ime
(è- 
¦ave
->
¦ave_»cÚf_£Á_time
) >

3703 
SENTINEL_SLAVE_RECONF_TIMEOUT
)

3705 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"-¦ave-»cÚf-£Á-timeout",
¦ave
,"%@");

3706 
¦ave
->
æags
 &ğ~
SRI_RECONF_SENT
;

3707 
¦ave
->
æags
 |ğ
SRI_RECONF_DONE
;

3712 ià(
¦ave
->
æags
 & (
SRI_DISCONNECTED
|
SRI_RECONF_SENT
|
SRI_RECONF_INPROG
))

3716 
»tv®
 = 
	`£Áš–S’dSÏveOf
(
¦ave
,

3717 
ma¡”
->
´omÙed_¦ave
->
addr
->

,

3718 
ma¡”
->
´omÙed_¦ave
->
addr
->
pÜt
);

3719 ià(
»tv®
 =ğ
REDIS_OK
) {

3720 
¦ave
->
æags
 |ğ
SRI_RECONF_SENT
;

3721 
¦ave
->
¦ave_»cÚf_£Á_time
 = 
	`m¡ime
();

3722 
	`£Áš–Ev’t
(
REDIS_NOTICE
,"+¦ave-»cÚf-£Á",
¦ave
,"%@");

3723 
š_´og»ss
++;

3726 
	`diùR–—£I‹¿tÜ
(
di
);

3729 
	`£Áš–Faov”D‘eùEnd
(
ma¡”
);

3730 
	}
}

3735 
	$£Áš–Faov”Sw™chToPromÙedSÏve
(
£Áš–RedisIn¡ªû
 *
ma¡”
) {

3736 
£Áš–RedisIn¡ªû
 *
»f
 = 
ma¡”
->
´omÙed_¦ave
 ?

3737 
ma¡”
->
´omÙed_¦ave
 : master;

3739 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+sw™ch-ma¡”",
ma¡”
,"%s %s %d %s %d",

3740 
ma¡”
->
Çme
, ma¡”->
addr
->

, ma¡”->addr->
pÜt
,

3741 
»f
->
addr
->

,„ef->addr->
pÜt
);

3743 
	`£Áš–Re£tMa¡”AndChªgeAdd»ss
(
ma¡”
,
»f
->
addr
->

,»f->addr->
pÜt
);

3744 
	}
}

3746 
	$£Áš–Faov”S‹Machše
(
£Áš–RedisIn¡ªû
 *
ri
) {

3747 
	`»disAs£¹
(
ri
->
æags
 & 
SRI_MASTER
);

3749 ià(!(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
)) ;

3751 
ri
->
çov”_¡©e
) {

3752 
SENTINEL_FAILOVER_STATE_WAIT_START
:

3753 
	`£Áš–Faov”Wa™S¹
(
ri
);

3755 
SENTINEL_FAILOVER_STATE_SELECT_SLAVE
:

3756 
	`£Áš–Faov”S–eùSÏve
(
ri
);

3758 
SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE
:

3759 
	`£Áš–Faov”S’dSÏveOfNoOÃ
(
ri
);

3761 
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
:

3762 
	`£Áš–Faov”Wa™PromÙiÚ
(
ri
);

3764 
SENTINEL_FAILOVER_STATE_RECONF_SLAVES
:

3765 
	`£Áš–Faov”RecÚfNextSÏve
(
ri
);

3768 
	}
}

3775 
	$£Áš–AbÜtFaov”
(
£Áš–RedisIn¡ªû
 *
ri
) {

3776 
	`»disAs£¹
(
ri
->
æags
 & 
SRI_FAILOVER_IN_PROGRESS
);

3777 
	`»disAs£¹
(
ri
->
çov”_¡©e
 <ğ
SENTINEL_FAILOVER_STATE_WAIT_PROMOTION
);

3779 
ri
->
æags
 &ğ~(
SRI_FAILOVER_IN_PROGRESS
|
SRI_FORCE_FAILOVER
);

3780 
ri
->
çov”_¡©e
 = 
SENTINEL_FAILOVER_STATE_NONE
;

3781 
ri
->
çov”_¡©e_chªge_time
 = 
	`m¡ime
();

3782 ià(
ri
->
´omÙed_¦ave
) {

3783 
ri
->
´omÙed_¦ave
->
æags
 &ğ~
SRI_PROMOTED
;

3784 
ri
->
´omÙed_¦ave
 = 
NULL
;

3786 
	}
}

3794 
	$£Áš–HªdËRedisIn¡ªû
(
£Áš–RedisIn¡ªû
 *
ri
) {

3797 
	`£Áš–RecÚÃùIn¡ªû
(
ri
);

3798 
	`£Áš–S’dP”iodicCommªds
(
ri
);

3804 ià(
£Áš–
.
tt
) {

3805 ià(
	`m¡ime
()-
£Áš–
.
tt_¡¬t_time
 < 
SENTINEL_TILT_PERIOD
) ;

3806 
£Áš–
.
tt
 = 0;

3807 
	`£Áš–Ev’t
(
REDIS_WARNING
,"-tt",
NULL
,"#tilt modeƒxited");

3811 
	`£Áš–CheckSubjeùiv–yDown
(
ri
);

3814 ià(
ri
->
æags
 & (
SRI_MASTER
|
SRI_SLAVE
)) {

3819 ià(
ri
->
æags
 & 
SRI_MASTER
) {

3820 
	`£Áš–CheckObjeùiv–yDown
(
ri
);

3821 ià(
	`£Áš–S¹Faov”IfN“ded
(
ri
))

3822 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_ASK_FORCED
);

3823 
	`£Áš–Faov”S‹Machše
(
ri
);

3824 
	`£Áš–AskMa¡”S‹ToOth”S’tš–s
(
ri
,
SENTINEL_NO_FLAGS
);

3826 
	}
}

3830 
	$£Áš–HªdËDiùOfRedisIn¡ªûs
(
diù
 *
š¡ªûs
) {

3831 
diùI‹¿tÜ
 *
di
;

3832 
diùEÁry
 *
de
;

3833 
£Áš–RedisIn¡ªû
 *
sw™ch_to_´omÙed
 = 
NULL
;

3836 
di
 = 
	`diùG‘I‹¿tÜ
(
š¡ªûs
);

3837 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

3838 
£Áš–RedisIn¡ªû
 *
ri
 = 
	`diùG‘V®
(
de
);

3840 
	`£Áš–HªdËRedisIn¡ªû
(
ri
);

3841 ià(
ri
->
æags
 & 
SRI_MASTER
) {

3842 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
¦aves
);

3843 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
ri
->
£Áš–s
);

3844 ià(
ri
->
çov”_¡©e
 =ğ
SENTINEL_FAILOVER_STATE_UPDATE_CONFIG
) {

3845 
sw™ch_to_´omÙed
 = 
ri
;

3849 ià(
sw™ch_to_´omÙed
)

3850 
	`£Áš–Faov”Sw™chToPromÙedSÏve
(
sw™ch_to_´omÙed
);

3851 
	`diùR–—£I‹¿tÜ
(
di
);

3852 
	}
}

3873 
	$£Áš–CheckTtCÚd™iÚ
() {

3874 
m¡ime_t
 
now
 = 
	`m¡ime
();

3875 
m¡ime_t
 
d–
 = 
now
 - 
£Áš–
.
´evious_time
;

3877 ià(
d–
 < 0 || d– > 
SENTINEL_TILT_TRIGGER
) {

3878 
£Áš–
.
tt
 = 1;

3879 
£Áš–
.
tt_¡¬t_time
 = 
	`m¡ime
();

3880 
	`£Áš–Ev’t
(
REDIS_WARNING
,"+tt",
NULL
,"#tilt modeƒntered");

3882 
£Áš–
.
´evious_time
 = 
	`m¡ime
();

3883 
	}
}

3885 
	$£Áš–Tim”
() {

3886 
	`£Áš–CheckTtCÚd™iÚ
();

3887 
	`£Áš–HªdËDiùOfRedisIn¡ªûs
(
£Áš–
.
ma¡”s
);

3888 
	`£Áš–RunP’dšgSüts
();

3889 
	`£Áš–CŞËùT”mš©edSüts
();

3890 
	`£Áš–KlTimedoutSüts
();

3898 
£rv”
.
hz
 = 
REDIS_DEFAULT_HZ
 + 
	`¿nd
() % REDIS_DEFAULT_HZ;

3899 
	}
}

	@setproctitle.c

28 #iâdeà
_GNU_SOURCE


29 
	#_GNU_SOURCE


	)

32 
	~<¡ddef.h
>

33 
	~<¡d¬g.h
>

34 
	~<¡dlib.h
>

35 
	~<¡dio.h
>

37 
	~<¡ršg.h
>

39 
	~<”ºo.h
>

41 #ià!
defšed
(
HAVE_SETPROCTITLE
)

42 
	#HAVE_SETPROCTITLE
 (
defšed
 
__N‘BSD__
 || defšed 
__F»eBSD__
 || defšed 
__O³nBSD__
)

	)

46 #ià!
HAVE_SETPROCTITLE


47 #ià(
defšed
 
__lšux
 || defšed 
__APPLE__
)

49 **
’vœÚ
;

53 cÚ¡ *
	m¬g0
;

56 *
	mba£
, *
	m’d
;

59 *
	mnul
;

61 
_BoŞ
 
	m»£t
;

62 
	m”rÜ
;

63 } 
	gSPT
;

66 #iâdeà
SPT_MIN


67 
	#SPT_MIN
(
a
, 
b
è((×è< (b))? (aè: (b))

	)

70 
šlše
 
size_t
 
	$¥t_mš
(
size_t
 
a
, size_ˆ
b
) {

71  
	`SPT_MIN
(
a
, 
b
);

72 
	}
}

79 
	$¥t_ş—»nv
() {

80 #ià
__GLIBC__


81 
	`ş—»nv
();

85 **
’vœÚ
;

86 **
tmp
;

88 ià(!(
tmp
 = 
	`m®loc
( *tmp)))

89  
”ºo
;

91 
tmp
[0] = 
NULL
;

92 
’vœÚ
 = 
tmp
;

96 
	}
}

99 
	$¥t_cİy’v
(*
Şd’v
[]) {

100 **
’vœÚ
;

101 *
eq
;

102 
i
, 
”rÜ
;

104 ià(
’vœÚ
 !ğ
Şd’v
)

107 ià((
”rÜ
 = 
	`¥t_ş—»nv
()))

108 
”rÜ
;

110 
i
 = 0; 
Şd’v
[i]; i++) {

111 ià(!(
eq
 = 
	`¡rchr
(
Şd’v
[
i
], '=')))

114 *
eq
 = '\0';

115 
”rÜ
 = (0 !ğ
	`£‹nv
(
Şd’v
[
i
], 
eq
 + 1, 1))? 
”ºo
 : 0;

116 *
eq
 = '=';

118 ià(
”rÜ
)

119 
”rÜ
;

123 
”rÜ
:

124 
’vœÚ
 = 
Şd’v
;

126  
”rÜ
;

127 
	}
}

130 
	$¥t_cİy¬gs
(
¬gc
, *
¬gv
[]) {

131 *
tmp
;

132 
i
;

134 
i
 = 1; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

135 ià(!
¬gv
[
i
])

138 ià(!(
tmp
 = 
	`¡rdup
(
¬gv
[
i
])))

139  
”ºo
;

141 
¬gv
[
i
] = 
tmp
;

145 
	}
}

148 
	$¥t_š™
(
¬gc
, *
¬gv
[]) {

149 **
’vp
 = 
’vœÚ
;

150 *
ba£
, *
’d
, *
nul
, *
tmp
;

151 
i
, 
”rÜ
;

153 ià(!(
ba£
 = 
¬gv
[0]))

156 
nul
 = &
ba£
[
	`¡¾’
(base)];

157 
’d
 = 
nul
 + 1;

159 
i
 = 0; i < 
¬gc
 || (˜>ğ¬gø&& 
¬gv
[i]); i++) {

160 ià(!
¬gv
[
i
] ||‡rgv[i] < 
’d
)

163 
’d
 = 
¬gv
[
i
] + 
	`¡¾’
(argv[i]) + 1;

166 
i
 = 0; 
’vp
[i]; i++) {

167 ià(
’vp
[
i
] < 
’d
)

170 
’d
 = 
’vp
[
i
] + 
	`¡¾’
(envp[i]) + 1;

173 ià(!(
SPT
.
¬g0
 = 
	`¡rdup
(
¬gv
[0])))

174 
sy”r
;

176 #ià
__GLIBC__


177 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_Çme
)))

178 
sy”r
;

180 
´og¿m_švoÿtiÚ_Çme
 = 
tmp
;

182 ià(!(
tmp
 = 
	`¡rdup
(
´og¿m_švoÿtiÚ_shÜt_Çme
)))

183 
sy”r
;

185 
´og¿m_švoÿtiÚ_shÜt_Çme
 = 
tmp
;

186 #–ià
__APPLE__


187 ià(!(
tmp
 = 
	`¡rdup
(
	`g‘´ogÇme
())))

188 
sy”r
;

190 
	`£rogÇme
(
tmp
);

194 ià((
”rÜ
 = 
	`¥t_cİy’v
(
’vp
)))

195 
”rÜ
;

197 ià((
”rÜ
 = 
	`¥t_cİy¬gs
(
¬gc
, 
¬gv
)))

198 
”rÜ
;

200 
SPT
.
nul
 =‚ul;

201 
SPT
.
ba£
 = base;

202 
SPT
.
’d
 =ƒnd;

205 
sy”r
:

206 
”rÜ
 = 
”ºo
;

207 
”rÜ
:

208 
SPT
.
”rÜ
 =ƒrror;

209 
	}
}

212 #iâdeà
SPT_MAXTITLE


213 
	#SPT_MAXTITLE
 255

	)

216 
	$£roù™Ë
(cÚ¡ *
fmt
, ...) {

217 
buf
[
SPT_MAXTITLE
 + 1];

218 
va_li¡
 
­
;

219 *
nul
;

220 
Ën
, 
”rÜ
;

222 ià(!
SPT
.
ba£
)

225 ià(
fmt
) {

226 
	`va_¡¬t
(
­
, 
fmt
);

227 
Ën
 = 
	`v¢´štf
(
buf
,  buf, 
fmt
, 
­
);

228 
	`va_’d
(
­
);

230 
Ën
 = 
	`¢´štf
(
buf
,  buf, "%s", 
SPT
.
¬g0
);

233 ià(
Ën
 <= 0)

234 { 
”rÜ
 = 
”ºo
; error; }

236 ià(!
SPT
.
»£t
) {

237 
	`mem£t
(
SPT
.
ba£
, 0, SPT.
’d
 - SPT.base);

238 
SPT
.
»£t
 = 1;

240 
	`mem£t
(
SPT
.
ba£
, 0, 
	`¥t_mš
( 
buf
, SPT.
’d
 - SPT.base));

243 
Ën
 = 
	`¥t_mš
Ö’, s±_mš( 
buf
, 
SPT
.
’d
 - SPT.
ba£
) - 1);

244 
	`memıy
(
SPT
.
ba£
, 
buf
, 
Ën
);

245 
nul
 = &
SPT
.
ba£
[
Ën
];

247 ià(
nul
 < 
SPT
.nul) {

248 *
SPT
.
nul
 = '.';

249 } ià(
nul
 =ğ
SPT
.nuÈ&& &nul[1] < SPT.
’d
) {

250 *
SPT
.
nul
 = ' ';

251 *++
nul
 = '\0';

255 
”rÜ
:

256 
SPT
.
”rÜ
 =ƒrror;

257 
	}
}

	@sha1.c

22 
	#SHA1HANDSOFF


	)

24 
	~<¡dio.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/ty³s.h
>

27 
	~"sŞ¬isfixes.h
"

28 
	~"sha1.h
"

29 
	~"cÚfig.h
"

31 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

35 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


36 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xFF00FF00) \

37 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00FF00FF))

	)

38 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


39 
	#blk0
(
i
è
block
->
l
[i]

	)

43 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

44 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

47 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

48 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

49 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

50 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

51 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

56 
	$SHA1T¿nsfÜm
(
u_št32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64])

58 
u_št32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

60 
c
[64];

61 
u_št32_t
 
l
[16];

62 } 
	tCHAR64LONG16
;

63 #ifdeà
SHA1HANDSOFF


64 
CHAR64LONG16
 
block
[1];

65 
	`memıy
(
block
, 
bufãr
, 64);

72 
CHAR64LONG16
* 
block
 = (cÚ¡ CHAR64LONG16*)
bufãr
;

75 
a
 = 
¡©e
[0];

76 
b
 = 
¡©e
[1];

77 
c
 = 
¡©e
[2];

78 
d
 = 
¡©e
[3];

79 
e
 = 
¡©e
[4];

81 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

82 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

83 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

84 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

85 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

86 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

87 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

88 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

89 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

90 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

91 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

92 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

93 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

94 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

95 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

96 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

97 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

98 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

99 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

100 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

102 
¡©e
[0] +ğ
a
;

103 
¡©e
[1] +ğ
b
;

104 
¡©e
[2] +ğ
c
;

105 
¡©e
[3] +ğ
d
;

106 
¡©e
[4] +ğ
e
;

108 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

109 #ifdeà
SHA1HANDSOFF


110 
	`mem£t
(
block
, '\0', (block));

112 
	}
}

117 
	$SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
)

120 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

121 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

122 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

123 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

124 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

125 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

126 
	}
}

131 
	$SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
u_št32_t
 
Ën
)

133 
u_št32_t
 
i
, 
j
;

135 
j
 = 
cÚ‹xt
->
couÁ
[0];

136 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3è< 
j
)

137 
cÚ‹xt
->
couÁ
[1]++;

138 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
>>29);

139 
j
 = (j >> 3) & 63;

140 ià((
j
 + 
Ën
) > 63) {

141 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

142 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

143  ; 
i
 + 63 < 
Ën
; i += 64) {

144 
	`SHA1T¿nsfÜm
(
cÚ‹xt
->
¡©e
, &
d©a
[
i
]);

146 
j
 = 0;

148 
i
 = 0;

149 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

150 
	}
}

155 
	$SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
)

157 
i
;

158 
fš®couÁ
[8];

159 
c
;

167 *
fı
 = &
fš®couÁ
[8];

169 
i
 = 0; i < 2; i++)

171 
u_št32_t
 
t
 = 
cÚ‹xt
->
couÁ
[
i
];

172 
j
;

174 
j
 = 0; j < 4; 
t
 >>= 8, j++)

175 *--
fı
 = (è
t
;

178 
i
 = 0; i < 8; i++) {

179 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

180 >> ((3-(
i
 & 3)) * 8) ) & 255);

183 
c
 = 0200;

184 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

185 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

186 
c
 = 0000;

187 
	`SHA1Upd©e
(
cÚ‹xt
, &
c
, 1);

189 
	`SHA1Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

190 
i
 = 0; i < 20; i++) {

191 
dige¡
[
i
] = ()

192 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

195 
	`mem£t
(
cÚ‹xt
, '\0', (*context));

196 
	`mem£t
(&
fš®couÁ
, '\0', (finalcount));

197 
	}
}

201 
	#BUFSIZE
 4096

	)

204 
	$maš
(
¬gc
, **
¬gv
)

206 
SHA1_CTX
 
ùx
;

207 
hash
[20], 
buf
[
BUFSIZE
];

208 
i
;

210 
i
=0;i<
BUFSIZE
;i++)

211 
buf
[
i
] = i;

213 
	`SHA1In™
(&
ùx
);

214 
i
=0;i<1000;i++)

215 
	`SHA1Upd©e
(&
ùx
, 
buf
, 
BUFSIZE
);

216 
	`SHA1Fš®
(
hash
, &
ùx
);

218 
	`´štf
("SHA1=");

219 
i
=0;i<20;i++)

220 
	`´štf
("%02x", 
hash
[
i
]);

221 
	`´štf
("\n");

223 
	}
}

	@sha1.h

9 
u_št32_t
 
	m¡©e
[5];

10 
u_št32_t
 
	mcouÁ
[2];

11 
	mbufãr
[64];

12 } 
	tSHA1_CTX
;

14 
SHA1T¿nsfÜm
(
u_št32_t
 
¡©e
[5], cÚ¡ 
bufãr
[64]);

15 
SHA1In™
(
SHA1_CTX
* 
cÚ‹xt
);

16 
SHA1Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ * 
d©a
, 
u_št32_t
 
Ën
);

17 
SHA1Fš®
(
dige¡
[20], 
SHA1_CTX
* 
cÚ‹xt
);

	@slowlog.c

42 
	~"»dis.h
"

43 
	~"¦owlog.h
"

48 
¦owlogEÁry
 *
	$¦owlogC»©eEÁry
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

49 
¦owlogEÁry
 *
£
 = 
	`zm®loc
((*se));

50 
j
, 
¦¬gc
 = 
¬gc
;

52 ià(
¦¬gc
 > 
SLOWLOG_ENTRY_MAX_ARGC
) slargc = SLOWLOG_ENTRY_MAX_ARGC;

53 
£
->
¬gc
 = 
¦¬gc
;

54 
£
->
¬gv
 = 
	`zm®loc
((
robj
*)*
¦¬gc
);

55 
j
 = 0; j < 
¦¬gc
; j++) {

59 ià(
¦¬gc
 !ğ
¬gc
 && 
j
 == slargc-1) {

60 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,

61 
	`sdsÿrštf
(
	`sd£m±y
(),"... (%d more‡rguments)",

62 
¬gc
-
¦¬gc
+1));

65 ià(
¬gv
[
j
]->
ty³
 =ğ
REDIS_STRING
 &&

66 
	`sdsEncodedObjeù
(
¬gv
[
j
]) &&

67 
	`sd¦’
(
¬gv
[
j
]->
±r
è> 
SLOWLOG_ENTRY_MAX_STRING
)

69 
sds
 
s
 = 
	`sd¢ewËn
(
¬gv
[
j
]->
±r
, 
SLOWLOG_ENTRY_MAX_STRING
);

71 
s
 = 
	`sdsÿrštf
(s,"... (%lu more bytes)",

73 
	`sd¦’
(
¬gv
[
j
]->
±r
è- 
SLOWLOG_ENTRY_MAX_STRING
);

74 
£
->
¬gv
[
j
] = 
	`ü—‹Objeù
(
REDIS_STRING
,
s
);

76 
£
->
¬gv
[
j
] =‡rgv[j];

77 
	`šüRefCouÁ
(
¬gv
[
j
]);

81 
£
->
time
 = 
	`time
(
NULL
);

82 
£
->
du¿tiÚ
 = duration;

83 
£
->
id
 = 
£rv”
.
¦owlog_’Œy_id
++;

84  
£
;

85 
	}
}

91 
	$¦owlogF»eEÁry
(*
£±r
) {

92 
¦owlogEÁry
 *
£
 = 
£±r
;

93 
j
;

95 
j
 = 0; j < 
£
->
¬gc
; j++)

96 
	`deüRefCouÁ
(
£
->
¬gv
[
j
]);

97 
	`zä“
(
£
->
¬gv
);

98 
	`zä“
(
£
);

99 
	}
}

103 
	$¦owlogIn™
() {

104 
£rv”
.
¦owlog
 = 
	`li¡C»©e
();

105 
£rv”
.
¦owlog_’Œy_id
 = 0;

106 
	`li¡S‘F»eM‘hod
(
£rv”
.
¦owlog
,
¦owlogF»eEÁry
);

107 
	}
}

112 
	$¦owlogPushEÁryIfN“ded
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
) {

113 ià(
£rv”
.
¦owlog_log_¦ow”_thª
 < 0) ;

114 ià(
du¿tiÚ
 >ğ
£rv”
.
¦owlog_log_¦ow”_thª
)

115 
	`li¡AddNodeH—d
(
£rv”
.
¦owlog
,
	`¦owlogC»©eEÁry
(
¬gv
,
¬gc
,
du¿tiÚ
));

118 
	`li¡L’gth
(
£rv”
.
¦owlog
è> s”v”.
¦owlog_max_Ën
)

119 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

120 
	}
}

123 
	$¦owlogRe£t
() {

124 
	`li¡L’gth
(
£rv”
.
¦owlog
) > 0)

125 
	`li¡D–Node
(
£rv”
.
¦owlog
,
	`li¡La¡
(server.slowlog));

126 
	}
}

130 
	$¦owlogCommªd
(
»disCl›Á
 *
c
) {

131 ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"reset")) {

132 
	`¦owlogRe£t
();

133 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

134 } ià(
c
->
¬gc
 =ğ2 && !
	`¡rÿ£cmp
(c->
¬gv
[1]->
±r
,"len")) {

135 
	`addR•lyLÚgLÚg
(
c
,
	`li¡L’gth
(
£rv”
.
¦owlog
));

136 } ià((
c
->
¬gc
 == 2 || c->argc == 3) &&

137 !
	`¡rÿ£cmp
(
c
->
¬gv
[1]->
±r
,"get"))

139 
couÁ
 = 10, 
£Á
 = 0;

140 
li¡I‹r
 
li
;

141 *
tÙ’Œ›s
;

142 
li¡Node
 *
Ê
;

143 
¦owlogEÁry
 *
£
;

145 ià(
c
->
¬gc
 == 3 &&

146 
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
couÁ
,
NULL
è!ğ
REDIS_OK
)

149 
	`li¡Rewšd
(
£rv”
.
¦owlog
,&
li
);

150 
tÙ’Œ›s
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

151 
couÁ
-- && (
Ê
 = 
	`li¡Next
(&
li
))) {

152 
j
;

154 
£
 = 
Ê
->
v®ue
;

155 
	`addR•lyMuÉiBulkL’
(
c
,4);

156 
	`addR•lyLÚgLÚg
(
c
,
£
->
id
);

157 
	`addR•lyLÚgLÚg
(
c
,
£
->
time
);

158 
	`addR•lyLÚgLÚg
(
c
,
£
->
du¿tiÚ
);

159 
	`addR•lyMuÉiBulkL’
(
c
,
£
->
¬gc
);

160 
j
 = 0; j < 
£
->
¬gc
; j++)

161 
	`addR•lyBulk
(
c
,
£
->
¬gv
[
j
]);

162 
£Á
++;

164 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
tÙ’Œ›s
,
£Á
);

166 
	`addR•lyE¼Ü
(
c
,

169 
	}
}

	@slowlog.h

30 
	#SLOWLOG_ENTRY_MAX_ARGC
 32

	)

31 
	#SLOWLOG_ENTRY_MAX_STRING
 128

	)

34 
	s¦owlogEÁry
 {

35 
robj
 **
	m¬gv
;

36 
	m¬gc
;

37 
	mid
;

38 
	mdu¿tiÚ
;

39 
time_t
 
	mtime
;

40 } 
	t¦owlogEÁry
;

43 
¦owlogIn™
();

44 
¦owlogPushEÁryIfN“ded
(
robj
 **
¬gv
, 
¬gc
, 
du¿tiÚ
);

47 
¦owlogCommªd
(
»disCl›Á
 *
c
);

	@solarisfixes.h

31 #ià
defšed
(
__sun
)

33 #ià
defšed
(
__GNUC__
)

34 
	~<m©h.h
>

35 #undeà
i¢ª


36 
	#i¢ª
(
x
) \

37 
	`__ex‹nsiÚ__
({ 
	`__ty³of
 (
x
è
__x_a
 = (x); \

38 
	`__butš_ex³ù
(
__x_a
 !ğ__x_a, 0); })

	)

40 #undeà
isfš™e


41 
	#isfš™e
(
x
) \

42 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_f
 = (x); \

43 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_f
 - __x_f), 1); })

	)

45 #undeà
isšf


46 
	#isšf
(
x
) \

47 
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
x
è
__x_i
 = (x); \

48 
	`__butš_ex³ù
(!
	`i¢ª
(
__x_i
è&& !
	`isfš™e
(__x_i), 0); })

	)

50 
	#u_št
 
ušt


	)

51 
	#u_št32_t
 
ušt32_t


	)

	@sort.c

32 
	~"»dis.h
"

33 
	~"pqsÜt.h
"

34 
	~<m©h.h
>

36 
zskli¡Node
* 
z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
);

38 
»disSÜtO³¿tiÚ
 *
	$ü—‹SÜtO³¿tiÚ
(
ty³
, 
robj
 *
·‰”n
) {

39 
»disSÜtO³¿tiÚ
 *
so
 = 
	`zm®loc
((*so));

40 
so
->
ty³
 =ype;

41 
so
->
·‰”n
 =…attern;

42  
so
;

43 
	}
}

61 
robj
 *
	$lookupKeyByP©‹º
(
»disDb
 *
db
, 
robj
 *
·‰”n
,„obj *
sub¡
) {

62 *
p
, *
f
, *
k
;

63 
sds
 
¥©
, 
ssub
;

64 
robj
 *
keyobj
, *
f›ldobj
 = 
NULL
, *
o
;

65 
´efixËn
, 
subËn
, 
po¡fixËn
, 
f›ldËn
;

69 
¥©
 = 
·‰”n
->
±r
;

70 ià(
¥©
[0] == '#' && spat[1] == '\0') {

71 
	`šüRefCouÁ
(
sub¡
);

72  
sub¡
;

78 
sub¡
 = 
	`g‘DecodedObjeù
(subst);

79 
ssub
 = 
sub¡
->
±r
;

83 
p
 = 
	`¡rchr
(
¥©
,'*');

84 ià(!
p
) {

85 
	`deüRefCouÁ
(
sub¡
);

86  
NULL
;

90 ià((
f
 = 
	`¡r¡r
(
p
+1, "->")è!ğ
NULL
 && *(f+2) != '\0') {

91 
f›ldËn
 = 
	`sd¦’
(
¥©
)-(
f
-spat)-2;

92 
f›ldobj
 = 
	`ü—‹SŒšgObjeù
(
f
+2,
f›ldËn
);

94 
f›ldËn
 = 0;

98 
´efixËn
 = 
p
-
¥©
;

99 
subËn
 = 
	`sd¦’
(
ssub
);

100 
po¡fixËn
 = 
	`sd¦’
(
¥©
)-(
´efixËn
+1)-(
f›ldËn
 ? fieldlen+2 : 0);

101 
keyobj
 = 
	`ü—‹SŒšgObjeù
(
NULL
,
´efixËn
+
subËn
+
po¡fixËn
);

102 
k
 = 
keyobj
->
±r
;

103 
	`memıy
(
k
,
¥©
,
´efixËn
);

104 
	`memıy
(
k
+
´efixËn
,
ssub
,
subËn
);

105 
	`memıy
(
k
+
´efixËn
+
subËn
,
p
+1,
po¡fixËn
);

106 
	`deüRefCouÁ
(
sub¡
);

109 
o
 = 
	`lookupKeyR—d
(
db
,
keyobj
);

110 ià(
o
 =ğ
NULL
è
noobj
;

112 ià(
f›ldobj
) {

113 ià(
o
->
ty³
 !ğ
REDIS_HASH
è
noobj
;

117 
o
 = 
	`hashTy³G‘Objeù
(o, 
f›ldobj
);

119 ià(
o
->
ty³
 !ğ
REDIS_STRING
è
noobj
;

123 
	`šüRefCouÁ
(
o
);

125 
	`deüRefCouÁ
(
keyobj
);

126 ià(
f›ldobj
è
	`deüRefCouÁ
(fieldobj);

127  
o
;

129 
noobj
:

130 
	`deüRefCouÁ
(
keyobj
);

131 ià(
f›ldËn
è
	`deüRefCouÁ
(
f›ldobj
);

132  
NULL
;

133 
	}
}

138 
	$sÜtCom·»
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

139 cÚ¡ 
»disSÜtObjeù
 *
so1
 = 
s1
, *
so2
 = 
s2
;

140 
cmp
;

142 ià(!
£rv”
.
sÜt_®pha
) {

144 ià(
so1
->
u
.
scÜe
 > 
so2
->u.score) {

145 
cmp
 = 1;

146 } ià(
so1
->
u
.
scÜe
 < 
so2
->u.score) {

147 
cmp
 = -1;

152 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

156 ià(
£rv”
.
sÜt_by·‰”n
) {

157 ià(!
so1
->
u
.
cmpobj
 || !
so2
->u.cmpobj) {

159 ià(
so1
->
u
.
cmpobj
 =ğ
so2
->u.cmpobj)

160 
cmp
 = 0;

161 ià(
so1
->
u
.
cmpobj
 =ğ
NULL
)

162 
cmp
 = -1;

164 
cmp
 = 1;

167 ià(
£rv”
.
sÜt_¡Üe
) {

168 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
u
.
cmpobj
,
so2
->u.cmpobj);

172 
cmp
 = 
	`¡rcŞl
(
so1
->
u
.
cmpobj
->
±r
,
so2
->u.cmpobj->ptr);

177 ià(
£rv”
.
sÜt_¡Üe
) {

178 
cmp
 = 
	`com·»SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

180 
cmp
 = 
	`cŞÏ‹SŒšgObjeùs
(
so1
->
obj
,
so2
->obj);

184  
£rv”
.
sÜt_desc
 ? -
cmp
 : cmp;

185 
	}
}

189 
	$sÜtCommªd
(
»disCl›Á
 *
c
) {

190 
li¡
 *
İ”©iÚs
;

191 
ouu’
 = 0;

192 
desc
 = 0, 
®pha
 = 0;

193 
lim™_¡¬t
 = 0, 
lim™_couÁ
 = -1, 
¡¬t
, 
’d
;

194 
j
, 
dÚtsÜt
 = 0, 
veùÜËn
;

195 
g‘İ
 = 0;

196 
št_cÚv”tiÚ_”rÜ
 = 0;

197 
syÁax_”rÜ
 = 0;

198 
robj
 *
sÜtv®
, *
sÜtby
 = 
NULL
, *
¡Üekey
 = NULL;

199 
»disSÜtObjeù
 *
veùÜ
;

202 
sÜtv®
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[1]);

203 ià(
sÜtv®
 && sÜtv®->
ty³
 !ğ
REDIS_SET
 &&

204 
sÜtv®
->
ty³
 !ğ
REDIS_LIST
 &&

205 
sÜtv®
->
ty³
 !ğ
REDIS_ZSET
)

207 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

213 
İ”©iÚs
 = 
	`li¡C»©e
();

214 
	`li¡S‘F»eM‘hod
(
İ”©iÚs
,
zä“
);

215 
j
 = 2;

220 ià(
sÜtv®
)

221 
	`šüRefCouÁ
(
sÜtv®
);

223 
sÜtv®
 = 
	`ü—‹Li¡Objeù
();

226 
j
 < 
c
->
¬gc
) {

227 
Ëá¬gs
 = 
c
->
¬gc
-
j
-1;

228 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"asc")) {

229 
desc
 = 0;

230 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"desc")) {

231 
desc
 = 1;

232 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"alpha")) {

233 
®pha
 = 1;

234 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"lim™"è&& 
Ëá¬gs
 >= 2) {

235 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+1], &
lim™_¡¬t
, 
NULL
)

236 !ğ
REDIS_OK
) ||

237 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
j
+2], &
lim™_couÁ
, 
NULL
)

238 !ğ
REDIS_OK
))

240 
syÁax_”rÜ
++;

243 
j
+=2;

244 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"¡Üe"è&& 
Ëá¬gs
 >= 1) {

245 
¡Üekey
 = 
c
->
¬gv
[
j
+1];

246 
j
++;

247 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"by"è&& 
Ëá¬gs
 >= 1) {

248 
sÜtby
 = 
c
->
¬gv
[
j
+1];

251 ià(
	`¡rchr
(
c
->
¬gv
[
j
+1]->
±r
,'*'è=ğ
NULL
) {

252 
dÚtsÜt
 = 1;

256 ià(
£rv”
.
şu¡”_’abËd
) {

257 
	`addR•lyE¼Ü
(
c
,"BY option of SORT denied in Cluster mode.");

258 
syÁax_”rÜ
++;

262 
j
++;

263 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"g‘"è&& 
Ëá¬gs
 >= 1) {

264 ià(
£rv”
.
şu¡”_’abËd
) {

265 
	`addR•lyE¼Ü
(
c
,"GET option of SORT denied in Cluster mode.");

266 
syÁax_”rÜ
++;

269 
	`li¡AddNodeTa
(
İ”©iÚs
,
	`ü—‹SÜtO³¿tiÚ
(

270 
REDIS_SORT_GET
,
c
->
¬gv
[
j
+1]));

271 
g‘İ
++;

272 
j
++;

274 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

275 
syÁax_”rÜ
++;

278 
j
++;

282 ià(
syÁax_”rÜ
) {

283 
	`deüRefCouÁ
(
sÜtv®
);

284 
	`li¡R–—£
(
İ”©iÚs
);

294 ià(
dÚtsÜt
 &&

295 
sÜtv®
->
ty³
 =ğ
REDIS_SET
 &&

296 (
¡Üekey
 || 
c
->
æags
 & 
REDIS_LUA_CLIENT
))

299 
dÚtsÜt
 = 0;

300 
®pha
 = 1;

301 
sÜtby
 = 
NULL
;

305 ià(
sÜtv®
->
ty³
 =ğ
REDIS_ZSET
)

306 
	`z£tCÚv”t
(
sÜtv®
, 
REDIS_ENCODING_SKIPLIST
);

309 
sÜtv®
->
ty³
) {

310 
REDIS_LIST
: 
veùÜËn
 = 
	`li¡Ty³L’gth
(
sÜtv®
); ;

311 
REDIS_SET
: 
veùÜËn
 = 
	`£tTy³Size
(
sÜtv®
); ;

312 
REDIS_ZSET
: 
veùÜËn
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
); ;

313 : 
veùÜËn
 = 0; 
	`»disPªic
("Bad SORType");

317 
¡¬t
 = (
lim™_¡¬t
 < 0) ? 0 :†imit_start;

318 
’d
 = (
lim™_couÁ
 < 0è? 
veùÜËn
-1 : 
¡¬t
+limit_count-1;

319 ià(
¡¬t
 >ğ
veùÜËn
) {

320 
¡¬t
 = 
veùÜËn
-1;

321 
’d
 = 
veùÜËn
-2;

323 ià(
’d
 >ğ
veùÜËn
)ƒnd = vectorlen-1;

335 ià(
sÜtv®
->
ty³
 =ğ
REDIS_ZSET
 &&

336 
dÚtsÜt
 &&

337 (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

339 
veùÜËn
 = 
’d
-
¡¬t
+1;

343 
veùÜ
 = 
	`zm®loc
((
»disSÜtObjeù
)*
veùÜËn
);

344 
j
 = 0;

346 ià(
sÜtv®
->
ty³
 =ğ
REDIS_LIST
) {

347 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
sÜtv®
,0,
REDIS_TAIL
);

348 
li¡Ty³EÁry
 
’Œy
;

349 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

350 
veùÜ
[
j
].
obj
 = 
	`li¡Ty³G‘
(&
’Œy
);

351 
veùÜ
[
j
].
u
.
scÜe
 = 0;

352 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

353 
j
++;

355 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

356 } ià(
sÜtv®
->
ty³
 =ğ
REDIS_SET
) {

357 
£tTy³I‹¿tÜ
 *
si
 = 
	`£tTy³In™I‹¿tÜ
(
sÜtv®
);

358 
robj
 *
–e
;

359 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

360 
veùÜ
[
j
].
obj
 = 
–e
;

361 
veùÜ
[
j
].
u
.
scÜe
 = 0;

362 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

363 
j
++;

365 
	`£tTy³R–—£I‹¿tÜ
(
si
);

366 } ià(
sÜtv®
->
ty³
 =ğ
REDIS_ZSET
 && 
dÚtsÜt
) {

374 
z£t
 *
zs
 = 
sÜtv®
->
±r
;

375 
zskli¡
 *
z¦
 = 
zs
->zsl;

376 
zskli¡Node
 *
Ê
;

377 
robj
 *
–e
;

378 
¿ng–’
 = 
veùÜËn
;

381 ià(
desc
) {

382 
z£’
 = 
	`diùSize
(((
z£t
*)
sÜtv®
->
±r
)->
diù
);

384 
Ê
 = 
z¦
->

;

385 ià(
¡¬t
 > 0)

386 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
z£’
-
¡¬t
);

388 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

389 ià(
¡¬t
 > 0)

390 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

393 
¿ng–’
--) {

394 
	`»disAs£¹W™hInfo
(
c
,
sÜtv®
,
Ê
 !ğ
NULL
);

395 
–e
 = 
Ê
->
obj
;

396 
veùÜ
[
j
].
obj
 = 
–e
;

397 
veùÜ
[
j
].
u
.
scÜe
 = 0;

398 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

399 
j
++;

400 
Ê
 = 
desc
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

406 
’d
 -ğ
¡¬t
;

407 
¡¬t
 = 0;

408 } ià(
sÜtv®
->
ty³
 =ğ
REDIS_ZSET
) {

409 
diù
 *
£t
 = ((
z£t
*)
sÜtv®
->
±r
)->dict;

410 
diùI‹¿tÜ
 *
di
;

411 
diùEÁry
 *
£‹Ë
;

412 
di
 = 
	`diùG‘I‹¿tÜ
(
£t
);

413 (
£‹Ë
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

414 
veùÜ
[
j
].
obj
 = 
	`diùG‘Key
(
£‹Ë
);

415 
veùÜ
[
j
].
u
.
scÜe
 = 0;

416 
veùÜ
[
j
].
u
.
cmpobj
 = 
NULL
;

417 
j
++;

419 
	`diùR–—£I‹¿tÜ
(
di
);

421 
	`»disPªic
("Unknownype");

423 
	`»disAs£¹W™hInfo
(
c
,
sÜtv®
,
j
 =ğ
veùÜËn
);

426 ià(
dÚtsÜt
 == 0) {

427 
j
 = 0; j < 
veùÜËn
; j++) {

428 
robj
 *
byv®
;

429 ià(
sÜtby
) {

431 
byv®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sÜtby
,
veùÜ
[
j
].
obj
);

432 ià(!
byv®
) ;

435 
byv®
 = 
veùÜ
[
j
].
obj
;

438 ià(
®pha
) {

439 ià(
sÜtby
è
veùÜ
[
j
].
u
.
cmpobj
 = 
	`g‘DecodedObjeù
(
byv®
);

441 ià(
	`sdsEncodedObjeù
(
byv®
)) {

442 *
•Œ
;

444 
veùÜ
[
j
].
u
.
scÜe
 = 
	`¡¹od
(
byv®
->
±r
,&
•Œ
);

445 ià(
•Œ
[0] !ğ'\0' || 
”ºo
 =ğ
ERANGE
 ||

446 
	`i¢ª
(
veùÜ
[
j
].
u
.
scÜe
))

448 
št_cÚv”tiÚ_”rÜ
 = 1;

450 } ià(
byv®
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

454 
veùÜ
[
j
].
u
.
scÜe
 = ()
byv®
->
±r
;

456 
	`»disAs£¹W™hInfo
(
c
,
sÜtv®
,1 != 1);

462 ià(
sÜtby
) {

463 
	`deüRefCouÁ
(
byv®
);

468 ià(
dÚtsÜt
 == 0) {

469 
£rv”
.
sÜt_desc
 = 
desc
;

470 
£rv”
.
sÜt_®pha
 = 
®pha
;

471 
£rv”
.
sÜt_by·‰”n
 = 
sÜtby
 ? 1 : 0;

472 
£rv”
.
sÜt_¡Üe
 = 
¡Üekey
 ? 1 : 0;

473 ià(
sÜtby
 && (
¡¬t
 !ğ0 || 
’d
 !ğ
veùÜËn
-1))

474 
	`pqsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
, 
¡¬t
,
’d
);

476 
	`qsÜt
(
veùÜ
,
veùÜËn
,(
»disSÜtObjeù
),
sÜtCom·»
);

481 
ouu’
 = 
g‘İ
 ? g‘İ*(
’d
-
¡¬t
+1) :ƒnd-start+1;

482 ià(
št_cÚv”tiÚ_”rÜ
) {

483 
	`addR•lyE¼Ü
(
c
,"One or more scores can't be converted into double");

484 } ià(
¡Üekey
 =ğ
NULL
) {

486 
	`addR•lyMuÉiBulkL’
(
c
,
ouu’
);

487 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

488 
li¡Node
 *
Ê
;

489 
li¡I‹r
 
li
;

491 ià(!
g‘İ
è
	`addR•lyBulk
(
c
,
veùÜ
[
j
].
obj
);

492 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

493 (
Ê
 = 
	`li¡Next
(&
li
))) {

494 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

495 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

496 
veùÜ
[
j
].
obj
);

498 ià(
sİ
->
ty³
 =ğ
REDIS_SORT_GET
) {

499 ià(!
v®
) {

500 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

502 
	`addR•lyBulk
(
c
,
v®
);

503 
	`deüRefCouÁ
(
v®
);

507 
	`»disAs£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
REDIS_SORT_GET
);

512 
robj
 *
sobj
 = 
	`ü—‹Zli¡Objeù
();

515 
j
 = 
¡¬t
; j <ğ
’d
; j++) {

516 
li¡Node
 *
Ê
;

517 
li¡I‹r
 
li
;

519 ià(!
g‘İ
) {

520 
	`li¡Ty³Push
(
sobj
,
veùÜ
[
j
].
obj
,
REDIS_TAIL
);

522 
	`li¡Rewšd
(
İ”©iÚs
,&
li
);

523 (
Ê
 = 
	`li¡Next
(&
li
))) {

524 
»disSÜtO³¿tiÚ
 *
sİ
 = 
Ê
->
v®ue
;

525 
robj
 *
v®
 = 
	`lookupKeyByP©‹º
(
c
->
db
,
sİ
->
·‰”n
,

526 
veùÜ
[
j
].
obj
);

528 ià(
sİ
->
ty³
 =ğ
REDIS_SORT_GET
) {

529 ià(!
v®
èv® = 
	`ü—‹SŒšgObjeù
("",0);

534 
	`li¡Ty³Push
(
sobj
,
v®
,
REDIS_TAIL
);

535 
	`deüRefCouÁ
(
v®
);

538 
	`»disAs£¹W™hInfo
(
c
,
sÜtv®
,
sİ
->
ty³
 =ğ
REDIS_SORT_GET
);

543 ià(
ouu’
) {

544 
	`£tKey
(
c
->
db
,
¡Üekey
,
sobj
);

545 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"sÜt¡Üe",
¡Üekey
,

546 
c
->
db
->
id
);

547 
£rv”
.
dœty
 +ğ
ouu’
;

548 } ià(
	`dbD–‘e
(
c
->
db
,
¡Üekey
)) {

549 
	`sigÇlModif›dKey
(
c
->
db
,
¡Üekey
);

550 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
¡Üekey
,
c
->
db
->
id
);

551 
£rv”
.
dœty
++;

553 
	`deüRefCouÁ
(
sobj
);

554 
	`addR•lyLÚgLÚg
(
c
,
ouu’
);

558 ià(
sÜtv®
->
ty³
 =ğ
REDIS_LIST
 || sÜtv®->ty³ =ğ
REDIS_SET
)

559 
j
 = 0; j < 
veùÜËn
; j++)

560 
	`deüRefCouÁ
(
veùÜ
[
j
].
obj
);

561 
	`deüRefCouÁ
(
sÜtv®
);

562 
	`li¡R–—£
(
İ”©iÚs
);

563 
j
 = 0; j < 
veùÜËn
; j++) {

564 ià(
®pha
 && 
veùÜ
[
j
].
u
.
cmpobj
)

565 
	`deüRefCouÁ
(
veùÜ
[
j
].
u
.
cmpobj
);

567 
	`zä“
(
veùÜ
);

568 
	}
}

	@sparkline.c

33 
	~"»dis.h
"

35 
	~<m©h.h
>

39 
	gch¬£t
[] = "_-`";

40 
	gch¬£t_fl
[] = "_o#";

41 
	gch¬£t_Ën
 = (
ch¬£t
)-1;

42 
	gÏb–_m¬gš_tİ
 = 1;

57 
£qu’û
 *
	$ü—‹S·rklšeSequ’û
() {

58 
£qu’û
 *
£q
 = 
	`zm®loc
((*seq));

59 
£q
->
Ëngth
 = 0;

60 
£q
->
§m¶es
 = 
NULL
;

61  
£q
;

62 
	}
}

65 
	$¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
) {

66 
Ïb–
 = (Ïb– =ğ
NULL
 ||†ab–[0] =ğ'\0'è? NULL : 
	`z¡rdup
(label);

67 ià(
£q
->
Ëngth
 == 0) {

68 
£q
->
mš
 = seq->
max
 = 
v®ue
;

70 ià(
v®ue
 < 
£q
->
mš
) seq->min = value;

71 ià(
v®ue
 > 
£q
->
max
) seq->max = value;

73 
£q
->
§m¶es
 = 
	`z»®loc
(£q->§m¶es,(
§m¶e
)*(£q->
Ëngth
+1));

74 
£q
->
§m¶es
[£q->
Ëngth
].
v®ue
 = value;

75 
£q
->
§m¶es
[£q->
Ëngth
].
Ïb–
 =†abel;

76 
£q
->
Ëngth
++;

77 ià(
Ïb–
è
£q
->
Ïb–s
++;

78 
	}
}

81 
	$ä“S·rklšeSequ’û
(
£qu’û
 *
£q
) {

82 
j
;

84 
j
 = 0; j < 
£q
->
Ëngth
; j++)

85 
	`zä“
(
£q
->
§m¶es
[
j
].
Ïb–
);

86 
	`zä“
(
£q
->
§m¶es
);

87 
	`zä“
(
£q
);

88 
	}
}

97 
sds
 
	$¥¬klšeR’d”Rªge
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
) {

98 
j
;

99 
»lmax
 = 
£q
->
max
 - seq->
mš
;

100 
¡•s
 = 
ch¬£t_Ën
*
rows
;

101 
row
 = 0;

102 *
ch¬s
 = 
	`zm®loc
(
Ën
);

103 
loİ
 = 1;

104 
İt_fl
 = 
æags
 & 
SPARKLINE_FILL
;

105 
İt_log
 = 
æags
 & 
SPARKLINE_LOG_SCALE
;

107 ià(
İt_log
) {

108 
»lmax
 = 
	`log
(relmax+1);

109 } ià(
»lmax
 == 0) {

110 
»lmax
 = 1;

113 
loİ
) {

114 
loİ
 = 0;

115 
	`mem£t
(
ch¬s
,' ',
Ën
);

116 
j
 = 0; j < 
Ën
; j++) {

117 
§m¶e
 *
s
 = &
£q
->
§m¶es
[
j
+
off£t
];

118 
»lv®
 = 
s
->
v®ue
 - 
£q
->
mš
;

119 
¡•
;

121 ià(
İt_log
è
»lv®
 = 
	`log
(relval+1);

122 
¡•
 = (è(
»lv®
*
¡•s
)/
»lmax
;

123 ià(
¡•
 < 0) step = 0;

124 ià(
¡•
 >ğ
¡•s
) step = steps-1;

126 ià(
row
 < 
rows
) {

128 
ch¬idx
 = 
¡•
-((
rows
-
row
-1)*
ch¬£t_Ën
);

129 
loİ
 = 1;

130 ià(
ch¬idx
 >ğ0 && ch¬idx < 
ch¬£t_Ën
) {

131 
ch¬s
[
j
] = 
İt_fl
 ? 
ch¬£t_fl
[
ch¬idx
] :

132 
ch¬£t
[
ch¬idx
];

133 } if(
İt_fl
 && 
ch¬idx
 >ğ
ch¬£t_Ën
) {

134 
ch¬s
[
j
] = '|';

138 ià(
£q
->
Ïb–s
 && 
row
-
rows
 < 
Ïb–_m¬gš_tİ
) {

139 
loİ
 = 1;

143 ià(
s
->
Ïb–
) {

144 
Ïb–_Ën
 = 
	`¡¾’
(
s
->
Ïb–
);

145 
Ïb–_ch¬
 = 
row
 - 
rows
 - 
Ïb–_m¬gš_tİ
;

147 ià(
Ïb–_Ën
 > 
Ïb–_ch¬
) {

148 
loİ
 = 1;

149 
ch¬s
[
j
] = 
s
->
Ïb–
[
Ïb–_ch¬
];

154 ià(
loİ
) {

155 
row
++;

156 
ouut
 = 
	`sdsÿ’
(ouut,
ch¬s
,
Ën
);

157 
ouut
 = 
	`sdsÿ’
(output,"\n",1);

160 
	`zä“
(
ch¬s
);

161  
ouut
;

162 
	}
}

165 
sds
 
	$¥¬klšeR’d”
(
sds
 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
) {

166 
j
;

168 
j
 = 0; j < 
£q
->
Ëngth
; j +ğ
cŞumns
) {

169 
subËn
 = (
£q
->
Ëngth
-
j
è< 
cŞumns
 ? (seq->length-j) : columns;

171 ià(
j
 !ğ0è
ouut
 = 
	`sdsÿ’
(output,"\n",1);

172 
ouut
 = 
	`¥¬klšeR’d”Rªge
(ouut, 
£q
, 
rows
, 
j
, 
subËn
, 
æags
);

174  
ouut
;

175 
	}
}

	@sparkline.h

30 #iâdeà
__SPARKLINE_H


31 
	#__SPARKLINE_H


	)

34 
	s§m¶e
 {

35 
	mv®ue
;

36 *
	mÏb–
;

39 
	s£qu’û
 {

40 
	mËngth
;

41 
	mÏb–s
;

42 
§m¶e
 *
	m§m¶es
;

43 
	mmš
, 
	mmax
;

46 
	#SPARKLINE_NO_FLAGS
 0

	)

47 
	#SPARKLINE_FILL
 1

	)

48 
	#SPARKLINE_LOG_SCALE
 2

	)

50 
£qu’û
 *
ü—‹S·rklšeSequ’û
();

51 
¥¬klšeSequ’ûAddSam¶e
(
£qu’û
 *
£q
, 
v®ue
, *
Ïb–
);

52 
ä“S·rklšeSequ’û
(
£qu’û
 *
£q
);

53 
sds
 
¥¬klšeR’d”Rªge
(sd 
ouut
, 
£qu’û
 *
£q
, 
rows
, 
off£t
, 
Ën
, 
æags
);

54 
sds
 
¥¬klšeR’d”
(sd 
ouut
, 
£qu’û
 *
£q
, 
cŞumns
, 
rows
, 
æags
);

	@syncio.c

31 
	~"»dis.h
"

43 
	#REDIS_SYNCIO_RESOLUTION
 10

	)

49 
ssize_t
 
	$syncWr™e
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

50 
ssize_t
 
nwr™‹n
, 
»t
 = 
size
;

51 
¡¬t
 = 
	`m¡ime
();

52 
»maššg
 = 
timeout
;

55 
wa™
 = (
»maššg
 > 
REDIS_SYNCIO_RESOLUTION
) ?

56 
»maššg
 : 
REDIS_SYNCIO_RESOLUTION
;

57 
–­£d
;

61 
nwr™‹n
 = 
	`wr™e
(
fd
,
±r
,
size
);

62 ià(
nwr™‹n
 == -1) {

63 ià(
”ºo
 !ğ
EAGAIN
)  -1;

65 
±r
 +ğ
nwr™‹n
;

66 
size
 -ğ
nwr™‹n
;

68 ià(
size
 =ğ0è 
»t
;

71 
	`«Wa™
(
fd
,
AE_WRITABLE
,
wa™
);

72 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

73 ià(
–­£d
 >ğ
timeout
) {

74 
”ºo
 = 
ETIMEDOUT
;

77 
»maššg
 = 
timeout
 - 
–­£d
;

79 
	}
}

85 
ssize_t
 
	$syncR—d
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

86 
ssize_t
 
Ä—d
, 
tÙ»ad
 = 0;

87 
¡¬t
 = 
	`m¡ime
();

88 
»maššg
 = 
timeout
;

90 ià(
size
 == 0)  0;

92 
wa™
 = (
»maššg
 > 
REDIS_SYNCIO_RESOLUTION
) ?

93 
»maššg
 : 
REDIS_SYNCIO_RESOLUTION
;

94 
–­£d
;

98 
Ä—d
 = 
	`»ad
(
fd
,
±r
,
size
);

99 ià(
Ä—d
 == 0)  -1;

100 ià(
Ä—d
 == -1) {

101 ià(
”ºo
 !ğ
EAGAIN
)  -1;

103 
±r
 +ğ
Ä—d
;

104 
size
 -ğ
Ä—d
;

105 
tÙ»ad
 +ğ
Ä—d
;

107 ià(
size
 =ğ0è 
tÙ»ad
;

110 
	`«Wa™
(
fd
,
AE_READABLE
,
wa™
);

111 
–­£d
 = 
	`m¡ime
(è- 
¡¬t
;

112 ià(
–­£d
 >ğ
timeout
) {

113 
”ºo
 = 
ETIMEDOUT
;

116 
»maššg
 = 
timeout
 - 
–­£d
;

118 
	}
}

125 
ssize_t
 
	$syncR—dLše
(
fd
, *
±r
, 
ssize_t
 
size
, 
timeout
) {

126 
ssize_t
 
Ä—d
 = 0;

128 
size
--;

129 
size
) {

130 
c
;

132 ià(
	`syncR—d
(
fd
,&
c
,1,
timeout
) == -1)  -1;

133 ià(
c
 == '\n') {

134 *
±r
 = '\0';

135 ià(
Ä—d
 && *(
±r
-1) == '\r') *(ptr-1) = '\0';

136  
Ä—d
;

138 *
±r
++ = 
c
;

139 *
±r
 = '\0';

140 
Ä—d
++;

142 
size
--;

144  
Ä—d
;

145 
	}
}

	@t_hash.c

30 
	~"»dis.h
"

31 
	~<m©h.h
>

40 
	$hashTy³TryCÚv”siÚ
(
robj
 *
o
,„obj **
¬gv
, 
¡¬t
, 
’d
) {

41 
i
;

43 ià(
o
->
’codšg
 !ğ
REDIS_ENCODING_ZIPLIST
) ;

45 
i
 = 
¡¬t
; i <ğ
’d
; i++) {

46 ià(
	`sdsEncodedObjeù
(
¬gv
[
i
]) &&

47 
	`sd¦’
(
¬gv
[
i
]->
±r
è> 
£rv”
.
hash_max_zli¡_v®ue
)

49 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

53 
	}
}

56 
	$hashTy³TryObjeùEncodšg
(
robj
 *
subjeù
,„obj **
o1
,„obj **
o2
) {

57 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

58 ià(
o1
è*o1 = 
	`ŒyObjeùEncodšg
(*o1);

59 ià(
o2
è*o2 = 
	`ŒyObjeùEncodšg
(*o2);

61 
	}
}

65 
	$hashTy³G‘FromZli¡
(
robj
 *
o
,„obj *
f›ld
,

66 **
v¡r
,

67 *
vËn
,

68 *
vÎ
)

70 *
zl
, *
åŒ
 = 
NULL
, *
v±r
 = NULL;

71 
»t
;

73 
	`»disAs£¹
(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
);

75 
f›ld
 = 
	`g‘DecodedObjeù
(field);

77 
zl
 = 
o
->
±r
;

78 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

79 ià(
åŒ
 !ğ
NULL
) {

80 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld
->
±r
, 
	`sd¦’
(field->ptr), 1);

81 ià(
åŒ
 !ğ
NULL
) {

83 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

84 
	`»disAs£¹
(
v±r
 !ğ
NULL
);

88 
	`deüRefCouÁ
(
f›ld
);

90 ià(
v±r
 !ğ
NULL
) {

91 
»t
 = 
	`zli¡G‘
(
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

92 
	`»disAs£¹
(
»t
);

97 
	}
}

101 
	$hashTy³G‘FromHashTabË
(
robj
 *
o
,„obj *
f›ld
,„obj **
v®ue
) {

102 
diùEÁry
 *
de
;

104 
	`»disAs£¹
(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
);

106 
de
 = 
	`diùFšd
(
o
->
±r
, 
f›ld
);

107 ià(
de
 =ğ
NULL
)  -1;

108 *
v®ue
 = 
	`diùG‘V®
(
de
);

110 
	}
}

118 
robj
 *
	$hashTy³G‘Objeù
(
robj
 *
o
,„obj *
f›ld
) {

119 
robj
 *
v®ue
 = 
NULL
;

121 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

122 *
v¡r
 = 
NULL
;

123 
vËn
 = 
UINT_MAX
;

124 
vÎ
 = 
LLONG_MAX
;

126 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0) {

127 ià(
v¡r
) {

128 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

130 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

134 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

135 
robj
 *
aux
;

137 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0) {

138 
	`šüRefCouÁ
(
aux
);

139 
v®ue
 = 
aux
;

142 
	`»disPªic
("Unknown hashƒncoding");

144  
v®ue
;

145 
	}
}

149 
	$hashTy³Exi¡s
(
robj
 *
o
,„obj *
f›ld
) {

150 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

151 *
v¡r
 = 
NULL
;

152 
vËn
 = 
UINT_MAX
;

153 
vÎ
 = 
LLONG_MAX
;

155 ià(
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
) == 0)  1;

156 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

157 
robj
 *
aux
;

159 ià(
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
aux
) == 0)  1;

161 
	`»disPªic
("Unknown hashƒncoding");

164 
	}
}

170 
	$hashTy³S‘
(
robj
 *
o
,„obj *
f›ld
,„obj *
v®ue
) {

171 
upd©e
 = 0;

173 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

174 *
zl
, *
åŒ
, *
v±r
;

176 
f›ld
 = 
	`g‘DecodedObjeù
(field);

177 
v®ue
 = 
	`g‘DecodedObjeù
(value);

179 
zl
 = 
o
->
±r
;

180 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

181 ià(
åŒ
 !ğ
NULL
) {

182 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld
->
±r
, 
	`sd¦’
(field->ptr), 1);

183 ià(
åŒ
 !ğ
NULL
) {

185 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

186 
	`»disAs£¹
(
v±r
 !ğ
NULL
);

187 
upd©e
 = 1;

190 
zl
 = 
	`zli¡D–‘e
(zl, &
v±r
);

193 
zl
 = 
	`zli¡In£¹
(zl, 
v±r
, 
v®ue
->
±r
, 
	`sd¦’
(value->ptr));

197 ià(!
upd©e
) {

199 
zl
 = 
	`zli¡Push
(zl, 
f›ld
->
±r
, 
	`sd¦’
(f›ld->±r), 
ZIPLIST_TAIL
);

200 
zl
 = 
	`zli¡Push
(zl, 
v®ue
->
±r
, 
	`sd¦’
(v®ue->±r), 
ZIPLIST_TAIL
);

202 
o
->
±r
 = 
zl
;

203 
	`deüRefCouÁ
(
f›ld
);

204 
	`deüRefCouÁ
(
v®ue
);

207 ià(
	`hashTy³L’gth
(
o
è> 
£rv”
.
hash_max_zli¡_’Œ›s
)

208 
	`hashTy³CÚv”t
(
o
, 
REDIS_ENCODING_HT
);

209 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

210 ià(
	`diùR•Ïû
(
o
->
±r
, 
f›ld
, 
v®ue
)) {

211 
	`šüRefCouÁ
(
f›ld
);

213 
upd©e
 = 1;

215 
	`šüRefCouÁ
(
v®ue
);

217 
	`»disPªic
("Unknown hashƒncoding");

219  
upd©e
;

220 
	}
}

224 
	$hashTy³D–‘e
(
robj
 *
o
,„obj *
f›ld
) {

225 
d–‘ed
 = 0;

227 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

228 *
zl
, *
åŒ
;

230 
f›ld
 = 
	`g‘DecodedObjeù
(field);

232 
zl
 = 
o
->
±r
;

233 
åŒ
 = 
	`zli¡Index
(
zl
, 
ZIPLIST_HEAD
);

234 ià(
åŒ
 !ğ
NULL
) {

235 
åŒ
 = 
	`zli¡Fšd
(åŒ, 
f›ld
->
±r
, 
	`sd¦’
(field->ptr), 1);

236 ià(
åŒ
 !ğ
NULL
) {

237 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

238 
zl
 = 
	`zli¡D–‘e
(zl,&
åŒ
);

239 
o
->
±r
 = 
zl
;

240 
d–‘ed
 = 1;

244 
	`deüRefCouÁ
(
f›ld
);

246 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

247 ià(
	`diùD–‘e
((
diù
*)
o
->
±r
, 
f›ld
è=ğ
REDIS_OK
) {

248 
d–‘ed
 = 1;

251 ià(
	`htN“dsResize
(
o
->
±r
)è
	`diùResize
(o->ptr);

255 
	`»disPªic
("Unknown hashƒncoding");

258  
d–‘ed
;

259 
	}
}

262 
	$hashTy³L’gth
(
robj
 *
o
) {

263 
Ëngth
 = 
ULONG_MAX
;

265 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

266 
Ëngth
 = 
	`zli¡L’
(
o
->
±r
) / 2;

267 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

268 
Ëngth
 = 
	`diùSize
((
diù
*)
o
->
±r
);

270 
	`»disPªic
("Unknown hashƒncoding");

273  
Ëngth
;

274 
	}
}

276 
hashTy³I‹¿tÜ
 *
	$hashTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

277 
hashTy³I‹¿tÜ
 *
hi
 = 
	`zm®loc
((hashTypeIterator));

278 
hi
->
subjeù
 = subject;

279 
hi
->
’codšg
 = 
subjeù
->encoding;

281 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

282 
hi
->
åŒ
 = 
NULL
;

283 
hi
->
v±r
 = 
NULL
;

284 } ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

285 
hi
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

287 
	`»disPªic
("Unknown hashƒncoding");

290  
hi
;

291 
	}
}

293 
	$hashTy³R–—£I‹¿tÜ
(
hashTy³I‹¿tÜ
 *
hi
) {

294 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

295 
	`diùR–—£I‹¿tÜ
(
hi
->
di
);

298 
	`zä“
(
hi
);

299 
	}
}

303 
	$hashTy³Next
(
hashTy³I‹¿tÜ
 *
hi
) {

304 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

305 *
zl
;

306 *
åŒ
, *
v±r
;

308 
zl
 = 
hi
->
subjeù
->
±r
;

309 
åŒ
 = 
hi
->fptr;

310 
v±r
 = 
hi
->vptr;

312 ià(
åŒ
 =ğ
NULL
) {

314 
	`»disAs£¹
(
v±r
 =ğ
NULL
);

315 
åŒ
 = 
	`zli¡Index
(
zl
, 0);

318 
	`»disAs£¹
(
v±r
 !ğ
NULL
);

319 
åŒ
 = 
	`zli¡Next
(
zl
, 
v±r
);

321 ià(
åŒ
 =ğ
NULL
è 
REDIS_ERR
;

324 
v±r
 = 
	`zli¡Next
(
zl
, 
åŒ
);

325 
	`»disAs£¹
(
v±r
 !ğ
NULL
);

328 
hi
->
åŒ
 = fptr;

329 
hi
->
v±r
 = vptr;

330 } ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

331 ià((
hi
->
de
 = 
	`diùNext
(hi->
di
)è=ğ
NULL
è 
REDIS_ERR
;

333 
	`»disPªic
("Unknown hashƒncoding");

335  
REDIS_OK
;

336 
	}
}

340 
	$hashTy³Cu¼’tFromZli¡
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
,

341 **
v¡r
,

342 *
vËn
,

343 *
vÎ
)

345 
»t
;

347 
	`»disAs£¹
(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
);

349 ià(
wh©
 & 
REDIS_HASH_KEY
) {

350 
»t
 = 
	`zli¡G‘
(
hi
->
åŒ
, 
v¡r
, 
vËn
, 
vÎ
);

351 
	`»disAs£¹
(
»t
);

353 
»t
 = 
	`zli¡G‘
(
hi
->
v±r
, 
v¡r
, 
vËn
, 
vÎ
);

354 
	`»disAs£¹
(
»t
);

356 
	}
}

360 
	$hashTy³Cu¼’tFromHashTabË
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
, 
robj
 **
d¡
) {

361 
	`»disAs£¹
(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
);

363 ià(
wh©
 & 
REDIS_HASH_KEY
) {

364 *
d¡
 = 
	`diùG‘Key
(
hi
->
de
);

366 *
d¡
 = 
	`diùG‘V®
(
hi
->
de
);

368 
	}
}

373 
robj
 *
	$hashTy³Cu¼’tObjeù
(
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

374 
robj
 *
d¡
;

376 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

377 *
v¡r
 = 
NULL
;

378 
vËn
 = 
UINT_MAX
;

379 
vÎ
 = 
LLONG_MAX
;

381 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

382 ià(
v¡r
) {

383 
d¡
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
, 
vËn
);

385 
d¡
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vÎ
);

387 } ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

388 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
d¡
);

389 
	`šüRefCouÁ
(
d¡
);

391 
	`»disPªic
("Unknown hashƒncoding");

393  
d¡
;

394 
	}
}

396 
robj
 *
	$hashTy³LookupWr™eOrC»©e
(
»disCl›Á
 *
c
, 
robj
 *
key
) {

397 
robj
 *
o
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

398 ià(
o
 =ğ
NULL
) {

399 
o
 = 
	`ü—‹HashObjeù
();

400 
	`dbAdd
(
c
->
db
,
key
,
o
);

402 ià(
o
->
ty³
 !ğ
REDIS_HASH
) {

403 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

404  
NULL
;

407  
o
;

408 
	}
}

410 
	$hashTy³CÚv”tZli¡
(
robj
 *
o
, 
’c
) {

411 
	`»disAs£¹
(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
);

413 ià(
’c
 =ğ
REDIS_ENCODING_ZIPLIST
) {

416 } ià(
’c
 =ğ
REDIS_ENCODING_HT
) {

417 
hashTy³I‹¿tÜ
 *
hi
;

418 
diù
 *dict;

419 
»t
;

421 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

422 
diù
 = 
	`diùC»©e
(&
hashDiùTy³
, 
NULL
);

424 
	`hashTy³Next
(
hi
è!ğ
REDIS_ERR
) {

425 
robj
 *
f›ld
, *
v®ue
;

427 
f›ld
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
REDIS_HASH_KEY
);

428 
f›ld
 = 
	`ŒyObjeùEncodšg
(field);

429 
v®ue
 = 
	`hashTy³Cu¼’tObjeù
(
hi
, 
REDIS_HASH_VALUE
);

430 
v®ue
 = 
	`ŒyObjeùEncodšg
(value);

431 
»t
 = 
	`diùAdd
(
diù
, 
f›ld
, 
v®ue
);

432 ià(
»t
 !ğ
DICT_OK
) {

433 
	`»disLogHexDump
(
REDIS_WARNING
,"ziplist with dupƒlements dump",

434 
o
->
±r
,
	`zli¡BlobL’
(o->ptr));

435 
	`»disAs£¹
(
»t
 =ğ
DICT_OK
);

439 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

440 
	`zä“
(
o
->
±r
);

442 
o
->
’codšg
 = 
REDIS_ENCODING_HT
;

443 
o
->
±r
 = 
diù
;

446 
	`»disPªic
("Unknown hashƒncoding");

448 
	}
}

450 
	$hashTy³CÚv”t
(
robj
 *
o
, 
’c
) {

451 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

452 
	`hashTy³CÚv”tZli¡
(
o
, 
’c
);

453 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

454 
	`»disPªic
("Not implemented");

456 
	`»disPªic
("Unknown hashƒncoding");

458 
	}
}

464 
	$h£tCommªd
(
»disCl›Á
 *
c
) {

465 
upd©e
;

466 
robj
 *
o
;

468 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

469 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

470 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

471 
upd©e
 = 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

472 
	`addR•ly
(
c
, 
upd©e
 ? 
sh¬ed
.
cz”o
 : sh¬ed.
cÚe
);

473 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

474 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

475 
£rv”
.
dœty
++;

476 
	}
}

478 
	$h£ŠxCommªd
(
»disCl›Á
 *
c
) {

479 
robj
 *
o
;

480 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

481 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,3);

483 ià(
	`hashTy³Exi¡s
(
o
, 
c
->
¬gv
[2])) {

484 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

486 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2], &c->argv[3]);

487 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],c->argv[3]);

488 
	`addR•ly
(
c
, 
sh¬ed
.
cÚe
);

489 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

490 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

491 
£rv”
.
dœty
++;

493 
	}
}

495 
	$hm£tCommªd
(
»disCl›Á
 *
c
) {

496 
i
;

497 
robj
 *
o
;

499 ià((
c
->
¬gc
 % 2) == 1) {

500 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for HMSET");

504 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

505 
	`hashTy³TryCÚv”siÚ
(
o
,
c
->
¬gv
,2,c->
¬gc
-1);

506 
i
 = 2; i < 
c
->
¬gc
; i += 2) {

507 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[
i
], &c->argv[i+1]);

508 
	`hashTy³S‘
(
o
,
c
->
¬gv
[
i
],c->argv[i+1]);

510 
	`addR•ly
(
c
, 
sh¬ed
.
ok
);

511 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

512 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"h£t",
c
->
¬gv
[1],c->
db
->
id
);

513 
£rv”
.
dœty
++;

514 
	}
}

516 
	$hšübyCommªd
(
»disCl›Á
 *
c
) {

517 
v®ue
, 
šü
, 
Şdv®ue
;

518 
robj
 *
o
, *
cu¼’t
, *
Ãw
;

520 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
REDIS_OK
) ;

521 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

522 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

523 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

524 "hash v®ui nÙ‡Àš‹g”"è!ğ
REDIS_OK
) {

525 
	`deüRefCouÁ
(
cu¼’t
);

528 
	`deüRefCouÁ
(
cu¼’t
);

530 
v®ue
 = 0;

533 
Şdv®ue
 = 
v®ue
;

534 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

535 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

536 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

539 
v®ue
 +ğ
šü
;

540 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

541 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

542 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

543 
	`deüRefCouÁ
(
Ãw
);

544 
	`addR•lyLÚgLÚg
(
c
,
v®ue
);

545 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

546 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"hšüby",
c
->
¬gv
[1],c->
db
->
id
);

547 
£rv”
.
dœty
++;

548 
	}
}

550 
	$hšübyæßtCommªd
(
»disCl›Á
 *
c
) {

551 
v®ue
, 
šü
;

552 
robj
 *
o
, *
cu¼’t
, *
Ãw
, *
aux
;

554 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
šü
,
NULL
è!ğ
REDIS_OK
) ;

555 ià((
o
 = 
	`hashTy³LookupWr™eOrC»©e
(
c
,c->
¬gv
[1])è=ğ
NULL
) ;

556 ià((
cu¼’t
 = 
	`hashTy³G‘Objeù
(
o
,
c
->
¬gv
[2])è!ğ
NULL
) {

557 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
cu¼’t
,&
v®ue
,

558 "hash v®ui nÙ‡ v®id flßt"è!ğ
REDIS_OK
) {

559 
	`deüRefCouÁ
(
cu¼’t
);

562 
	`deüRefCouÁ
(
cu¼’t
);

564 
v®ue
 = 0;

567 
v®ue
 +ğ
šü
;

568 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

569 
	`hashTy³TryObjeùEncodšg
(
o
,&
c
->
¬gv
[2],
NULL
);

570 
	`hashTy³S‘
(
o
,
c
->
¬gv
[2],
Ãw
);

571 
	`addR•lyBulk
(
c
,
Ãw
);

572 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

573 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"hšübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

574 
£rv”
.
dœty
++;

579 
aux
 = 
	`ü—‹SŒšgObjeù
("HSET",4);

580 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

581 
	`deüRefCouÁ
(
aux
);

582 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,3,
Ãw
);

583 
	`deüRefCouÁ
(
Ãw
);

584 
	}
}

586 
	$addHashF›ldToR•ly
(
»disCl›Á
 *
c
, 
robj
 *
o
,„obj *
f›ld
) {

587 
»t
;

589 ià(
o
 =ğ
NULL
) {

590 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

594 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

595 *
v¡r
 = 
NULL
;

596 
vËn
 = 
UINT_MAX
;

597 
vÎ
 = 
LLONG_MAX
;

599 
»t
 = 
	`hashTy³G‘FromZli¡
(
o
, 
f›ld
, &
v¡r
, &
vËn
, &
vÎ
);

600 ià(
»t
 < 0) {

601 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

603 ià(
v¡r
) {

604 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

606 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

610 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

611 
robj
 *
v®ue
;

613 
»t
 = 
	`hashTy³G‘FromHashTabË
(
o
, 
f›ld
, &
v®ue
);

614 ià(
»t
 < 0) {

615 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

617 
	`addR•lyBulk
(
c
, 
v®ue
);

621 
	`»disPªic
("Unknown hashƒncoding");

623 
	}
}

625 
	$hg‘Commªd
(
»disCl›Á
 *
c
) {

626 
robj
 *
o
;

628 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

629 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

631 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[2]);

632 
	}
}

634 
	$hmg‘Commªd
(
»disCl›Á
 *
c
) {

635 
robj
 *
o
;

636 
i
;

640 
o
 = 
	`lookupKeyR—d
(
c
->
db
, c->
¬gv
[1]);

641 ià(
o
 !ğ
NULL
 && o->
ty³
 !ğ
REDIS_HASH
) {

642 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

646 
	`addR•lyMuÉiBulkL’
(
c
, c->
¬gc
-2);

647 
i
 = 2; i < 
c
->
¬gc
; i++) {

648 
	`addHashF›ldToR•ly
(
c
, 
o
, c->
¬gv
[
i
]);

650 
	}
}

652 
	$hd–Commªd
(
»disCl›Á
 *
c
) {

653 
robj
 *
o
;

654 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

656 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

657 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

659 
j
 = 2; j < 
c
->
¬gc
; j++) {

660 ià(
	`hashTy³D–‘e
(
o
,
c
->
¬gv
[
j
])) {

661 
d–‘ed
++;

662 ià(
	`hashTy³L’gth
(
o
) == 0) {

663 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

664 
key»moved
 = 1;

669 ià(
d–‘ed
) {

670 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

671 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_HASH
,"hd–",
c
->
¬gv
[1],c->
db
->
id
);

672 ià(
key»moved
)

673 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

674 
c
->
db
->
id
);

675 
£rv”
.
dœty
 +ğ
d–‘ed
;

677 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

678 
	}
}

680 
	$hËnCommªd
(
»disCl›Á
 *
c
) {

681 
robj
 *
o
;

682 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

683 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

685 
	`addR•lyLÚgLÚg
(
c
,
	`hashTy³L’gth
(
o
));

686 
	}
}

688 
	$addHashI‹¿tÜCursÜToR•ly
(
»disCl›Á
 *
c
, 
hashTy³I‹¿tÜ
 *
hi
, 
wh©
) {

689 ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

690 *
v¡r
 = 
NULL
;

691 
vËn
 = 
UINT_MAX
;

692 
vÎ
 = 
LLONG_MAX
;

694 
	`hashTy³Cu¼’tFromZli¡
(
hi
, 
wh©
, &
v¡r
, &
vËn
, &
vÎ
);

695 ià(
v¡r
) {

696 
	`addR•lyBulkCBufãr
(
c
, 
v¡r
, 
vËn
);

698 
	`addR•lyBulkLÚgLÚg
(
c
, 
vÎ
);

701 } ià(
hi
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

702 
robj
 *
v®ue
;

704 
	`hashTy³Cu¼’tFromHashTabË
(
hi
, 
wh©
, &
v®ue
);

705 
	`addR•lyBulk
(
c
, 
v®ue
);

708 
	`»disPªic
("Unknown hashƒncoding");

710 
	}
}

712 
	$g’”icHg‘®lCommªd
(
»disCl›Á
 *
c
, 
æags
) {

713 
robj
 *
o
;

714 
hashTy³I‹¿tÜ
 *
hi
;

715 
muÉl›r
 = 0;

716 
Ëngth
, 
couÁ
 = 0;

718 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


719 || 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

721 ià(
æags
 & 
REDIS_HASH_KEY
è
muÉl›r
++;

722 ià(
æags
 & 
REDIS_HASH_VALUE
è
muÉl›r
++;

724 
Ëngth
 = 
	`hashTy³L’gth
(
o
è* 
muÉl›r
;

725 
	`addR•lyMuÉiBulkL’
(
c
, 
Ëngth
);

727 
hi
 = 
	`hashTy³In™I‹¿tÜ
(
o
);

728 
	`hashTy³Next
(
hi
è!ğ
REDIS_ERR
) {

729 ià(
æags
 & 
REDIS_HASH_KEY
) {

730 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
REDIS_HASH_KEY
);

731 
couÁ
++;

733 ià(
æags
 & 
REDIS_HASH_VALUE
) {

734 
	`addHashI‹¿tÜCursÜToR•ly
(
c
, 
hi
, 
REDIS_HASH_VALUE
);

735 
couÁ
++;

739 
	`hashTy³R–—£I‹¿tÜ
(
hi
);

740 
	`»disAs£¹
(
couÁ
 =ğ
Ëngth
);

741 
	}
}

743 
	$hkeysCommªd
(
»disCl›Á
 *
c
) {

744 
	`g’”icHg‘®lCommªd
(
c
,
REDIS_HASH_KEY
);

745 
	}
}

747 
	$hv®sCommªd
(
»disCl›Á
 *
c
) {

748 
	`g’”icHg‘®lCommªd
(
c
,
REDIS_HASH_VALUE
);

749 
	}
}

751 
	$hg‘®lCommªd
(
»disCl›Á
 *
c
) {

752 
	`g’”icHg‘®lCommªd
(
c
,
REDIS_HASH_KEY
|
REDIS_HASH_VALUE
);

753 
	}
}

755 
	$hexi¡sCommªd
(
»disCl›Á
 *
c
) {

756 
robj
 *
o
;

757 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

758 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

760 
	`addR•ly
(
c
, 
	`hashTy³Exi¡s
(
o
,c->
¬gv
[2]è? 
sh¬ed
.
cÚe
 : sh¬ed.
cz”o
);

761 
	}
}

763 
	$hsÿnCommªd
(
»disCl›Á
 *
c
) {

764 
robj
 *
o
;

765 
cursÜ
;

767 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
REDIS_ERR
) ;

768 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

769 
	`checkTy³
(
c
,
o
,
REDIS_HASH
)) ;

770 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

771 
	}
}

	@t_list.c

30 
	~"»dis.h
"

39 
	$li¡Ty³TryCÚv”siÚ
(
robj
 *
subjeù
,„obj *
v®ue
) {

40 ià(
subjeù
->
’codšg
 !ğ
REDIS_ENCODING_ZIPLIST
) ;

41 ià(
	`sdsEncodedObjeù
(
v®ue
) &&

42 
	`sd¦’
(
v®ue
->
±r
è> 
£rv”
.
li¡_max_zli¡_v®ue
)

43 
	`li¡Ty³CÚv”t
(
subjeù
,
REDIS_ENCODING_LINKEDLIST
);

44 
	}
}

51 
	$li¡Ty³Push
(
robj
 *
subjeù
,„obj *
v®ue
, 
wh”e
) {

53 
	`li¡Ty³TryCÚv”siÚ
(
subjeù
,
v®ue
);

54 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
 &&

55 
	`zli¡L’
(
subjeù
->
±r
è>ğ
£rv”
.
li¡_max_zli¡_’Œ›s
)

56 
	`li¡Ty³CÚv”t
(
subjeù
,
REDIS_ENCODING_LINKEDLIST
);

58 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

59 
pos
 = (
wh”e
 =ğ
REDIS_HEAD
è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

60 
v®ue
 = 
	`g‘DecodedObjeù
(value);

61 
subjeù
->
±r
 = 
	`zli¡Push
(subjeù->±r,
v®ue
->±r,
	`sd¦’
(v®ue->±r),
pos
);

62 
	`deüRefCouÁ
(
v®ue
);

63 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

64 ià(
wh”e
 =ğ
REDIS_HEAD
) {

65 
	`li¡AddNodeH—d
(
subjeù
->
±r
,
v®ue
);

67 
	`li¡AddNodeTa
(
subjeù
->
±r
,
v®ue
);

69 
	`šüRefCouÁ
(
v®ue
);

71 
	`»disPªic
("Unknown†istƒncoding");

73 
	}
}

75 
robj
 *
	$li¡Ty³Pİ
(
robj
 *
subjeù
, 
wh”e
) {

76 
robj
 *
v®ue
 = 
NULL
;

77 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

78 *
p
;

79 *
v¡r
;

80 
vËn
;

81 
vlÚg
;

82 
pos
 = (
wh”e
 =ğ
REDIS_HEAD
) ? 0 : -1;

83 
p
 = 
	`zli¡Index
(
subjeù
->
±r
,
pos
);

84 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

85 ià(
v¡r
) {

86 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

88 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

91 
subjeù
->
±r
 = 
	`zli¡D–‘e
(subjeù->±r,&
p
);

93 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

94 
li¡
 *li¡ = 
subjeù
->
±r
;

95 
li¡Node
 *
Ê
;

96 ià(
wh”e
 =ğ
REDIS_HEAD
) {

97 
Ê
 = 
	`li¡Fœ¡
(
li¡
);

99 
Ê
 = 
	`li¡La¡
(
li¡
);

101 ià(
Ê
 !ğ
NULL
) {

102 
v®ue
 = 
	`li¡NodeV®ue
(
Ê
);

103 
	`šüRefCouÁ
(
v®ue
);

104 
	`li¡D–Node
(
li¡
,
Ê
);

107 
	`»disPªic
("Unknown†istƒncoding");

109  
v®ue
;

110 
	}
}

112 
	$li¡Ty³L’gth
(
robj
 *
subjeù
) {

113 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

114  
	`zli¡L’
(
subjeù
->
±r
);

115 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

116  
	`li¡L’gth
((
li¡
*)
subjeù
->
±r
);

118 
	`»disPªic
("Unknown†istƒncoding");

120 
	}
}

123 
li¡Ty³I‹¿tÜ
 *
	$li¡Ty³In™I‹¿tÜ
(
robj
 *
subjeù
, 
šdex
, 
dœeùiÚ
) {

124 
li¡Ty³I‹¿tÜ
 *
li
 = 
	`zm®loc
((listTypeIterator));

125 
li
->
subjeù
 = subject;

126 
li
->
’codšg
 = 
subjeù
->encoding;

127 
li
->
dœeùiÚ
 = direction;

128 ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

129 
li
->
zi
 = 
	`zli¡Index
(
subjeù
->
±r
,
šdex
);

130 } ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

131 
li
->
Ê
 = 
	`li¡Index
(
subjeù
->
±r
,
šdex
);

133 
	`»disPªic
("Unknown†istƒncoding");

135  
li
;

136 
	}
}

139 
	$li¡Ty³R–—£I‹¿tÜ
(
li¡Ty³I‹¿tÜ
 *
li
) {

140 
	`zä“
(
li
);

141 
	}
}

146 
	$li¡Ty³Next
(
li¡Ty³I‹¿tÜ
 *
li
, 
li¡Ty³EÁry
 *
’Œy
) {

148 
	`»disAs£¹
(
li
->
subjeù
->
’codšg
 ==†i->encoding);

150 
’Œy
->
li
 =†i;

151 ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

152 
’Œy
->
zi
 = 
li
->zi;

153 ià(
’Œy
->
zi
 !ğ
NULL
) {

154 ià(
li
->
dœeùiÚ
 =ğ
REDIS_TAIL
)

155 
li
->
zi
 = 
	`zli¡Next
Öi->
subjeù
->
±r
,li->zi);

157 
li
->
zi
 = 
	`zli¡P»v
Öi->
subjeù
->
±r
,li->zi);

160 } ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

161 
’Œy
->
Ê
 = 
li
->ln;

162 ià(
’Œy
->
Ê
 !ğ
NULL
) {

163 ià(
li
->
dœeùiÚ
 =ğ
REDIS_TAIL
)

164 
li
->
Ê
 =†i->Ê->
Ãxt
;

166 
li
->
Ê
 =†i->Ê->
´ev
;

170 
	`»disPªic
("Unknown†istƒncoding");

173 
	}
}

176 
robj
 *
	$li¡Ty³G‘
(
li¡Ty³EÁry
 *
’Œy
) {

177 
li¡Ty³I‹¿tÜ
 *
li
 = 
’Œy
->li;

178 
robj
 *
v®ue
 = 
NULL
;

179 ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

180 *
v¡r
;

181 
vËn
;

182 
vlÚg
;

183 
	`»disAs£¹
(
’Œy
->
zi
 !ğ
NULL
);

184 ià(
	`zli¡G‘
(
’Œy
->
zi
,&
v¡r
,&
vËn
,&
vlÚg
)) {

185 ià(
v¡r
) {

186 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

188 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

191 } ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

192 
	`»disAs£¹
(
’Œy
->
Ê
 !ğ
NULL
);

193 
v®ue
 = 
	`li¡NodeV®ue
(
’Œy
->
Ê
);

194 
	`šüRefCouÁ
(
v®ue
);

196 
	`»disPªic
("Unknown†istƒncoding");

198  
v®ue
;

199 
	}
}

201 
	$li¡Ty³In£¹
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
v®ue
, 
wh”e
) {

202 
robj
 *
subjeù
 = 
’Œy
->
li
->subject;

203 ià(
’Œy
->
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

204 
v®ue
 = 
	`g‘DecodedObjeù
(value);

205 ià(
wh”e
 =ğ
REDIS_TAIL
) {

206 *
Ãxt
 = 
	`zli¡Next
(
subjeù
->
±r
,
’Œy
->
zi
);

210 ià(
Ãxt
 =ğ
NULL
) {

211 
subjeù
->
±r
 = 
	`zli¡Push
(subjeù->±r,
v®ue
->±r,
	`sd¦’
(v®ue->±r),
REDIS_TAIL
);

213 
subjeù
->
±r
 = 
	`zli¡In£¹
(subjeù->±r,
Ãxt
,
v®ue
->±r,
	`sd¦’
(value->ptr));

216 
subjeù
->
±r
 = 
	`zli¡In£¹
(subjeù->±r,
’Œy
->
zi
,
v®ue
->±r,
	`sd¦’
(value->ptr));

218 
	`deüRefCouÁ
(
v®ue
);

219 } ià(
’Œy
->
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

220 ià(
wh”e
 =ğ
REDIS_TAIL
) {

221 
	`li¡In£¹Node
(
subjeù
->
±r
,
’Œy
->
Ê
,
v®ue
,
AL_START_TAIL
);

223 
	`li¡In£¹Node
(
subjeù
->
±r
,
’Œy
->
Ê
,
v®ue
,
AL_START_HEAD
);

225 
	`šüRefCouÁ
(
v®ue
);

227 
	`»disPªic
("Unknown†istƒncoding");

229 
	}
}

232 
	$li¡Ty³Equ®
(
li¡Ty³EÁry
 *
’Œy
, 
robj
 *
o
) {

233 
li¡Ty³I‹¿tÜ
 *
li
 = 
’Œy
->li;

234 ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

235 
	`»disAs£¹W™hInfo
(
NULL
,
o
,
	`sdsEncodedObjeù
(o));

236  
	`zli¡Com·»
(
’Œy
->
zi
,
o
->
±r
,
	`sd¦’
(o->ptr));

237 } ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

238  
	`equ®SŒšgObjeùs
(
o
,
	`li¡NodeV®ue
(
’Œy
->
Ê
));

240 
	`»disPªic
("Unknown†istƒncoding");

242 
	}
}

245 
	$li¡Ty³D–‘e
(
li¡Ty³EÁry
 *
’Œy
) {

246 
li¡Ty³I‹¿tÜ
 *
li
 = 
’Œy
->li;

247 ià(
li
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

248 *
p
 = 
’Œy
->
zi
;

249 
li
->
subjeù
->
±r
 = 
	`zli¡D–‘e
Öi->subjeù->±r,&
p
);

252 ià(
li
->
dœeùiÚ
 =ğ
REDIS_TAIL
)

253 
li
->
zi
 = 
p
;

255 
li
->
zi
 = 
	`zli¡P»v
Öi->
subjeù
->
±r
,
p
);

256 } ià(
’Œy
->
li
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

257 
li¡Node
 *
Ãxt
;

258 ià(
li
->
dœeùiÚ
 =ğ
REDIS_TAIL
)

259 
Ãxt
 = 
’Œy
->
Ê
->next;

261 
Ãxt
 = 
’Œy
->
Ê
->
´ev
;

262 
	`li¡D–Node
(
li
->
subjeù
->
±r
,
’Œy
->
Ê
);

263 
li
->
Ê
 = 
Ãxt
;

265 
	`»disPªic
("Unknown†istƒncoding");

267 
	}
}

269 
	$li¡Ty³CÚv”t
(
robj
 *
subjeù
, 
’c
) {

270 
li¡Ty³I‹¿tÜ
 *
li
;

271 
li¡Ty³EÁry
 
’Œy
;

272 
	`»disAs£¹W™hInfo
(
NULL
,
subjeù
,subjeù->
ty³
 =ğ
REDIS_LIST
);

274 ià(
’c
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

275 
li¡
 *
l
 = 
	`li¡C»©e
();

276 
	`li¡S‘F»eM‘hod
(
l
,
deüRefCouÁVoid
);

279 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
REDIS_TAIL
);

280 
	`li¡Ty³Next
(
li
,&
’Œy
)è
	`li¡AddNodeTa
(
l
,
	`li¡Ty³G‘
(&entry));

281 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

283 
subjeù
->
’codšg
 = 
REDIS_ENCODING_LINKEDLIST
;

284 
	`zä“
(
subjeù
->
±r
);

285 
subjeù
->
±r
 = 
l
;

287 
	`»disPªic
("Unsupported†ist conversion");

289 
	}
}

295 
	$pushG’”icCommªd
(
»disCl›Á
 *
c
, 
wh”e
) {

296 
j
, 
wa™šg
 = 0, 
pushed
 = 0;

297 
robj
 *
lobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

299 ià(
lobj
 &&†obj->
ty³
 !ğ
REDIS_LIST
) {

300 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

304 
j
 = 2; j < 
c
->
¬gc
; j++) {

305 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

306 ià(!
lobj
) {

307 
lobj
 = 
	`ü—‹Zli¡Objeù
();

308 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
lobj
);

310 
	`li¡Ty³Push
(
lobj
,
c
->
¬gv
[
j
],
wh”e
);

311 
pushed
++;

313 
	`addR•lyLÚgLÚg
(
c
, 
wa™šg
 + (
lobj
 ? 
	`li¡Ty³L’gth
(lobj) : 0));

314 ià(
pushed
) {

315 *
ev’t
 = (
wh”e
 =ğ
REDIS_HEAD
) ? "lpush" : "rpush";

317 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

318 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

320 
£rv”
.
dœty
 +ğ
pushed
;

321 
	}
}

323 
	$ÍushCommªd
(
»disCl›Á
 *
c
) {

324 
	`pushG’”icCommªd
(
c
,
REDIS_HEAD
);

325 
	}
}

327 
	$½ushCommªd
(
»disCl›Á
 *
c
) {

328 
	`pushG’”icCommªd
(
c
,
REDIS_TAIL
);

329 
	}
}

331 
	$pushxG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 *
»fv®
,„obj *
v®
, 
wh”e
) {

332 
robj
 *
subjeù
;

333 
li¡Ty³I‹¿tÜ
 *
™”
;

334 
li¡Ty³EÁry
 
’Œy
;

335 
š£¹ed
 = 0;

337 ià((
subjeù
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

338 
	`checkTy³
(
c
,
subjeù
,
REDIS_LIST
)) ;

340 ià(
»fv®
 !ğ
NULL
) {

346 
	`li¡Ty³TryCÚv”siÚ
(
subjeù
,
v®
);

349 
™”
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
REDIS_TAIL
);

350 
	`li¡Ty³Next
(
™”
,&
’Œy
)) {

351 ià(
	`li¡Ty³Equ®
(&
’Œy
,
»fv®
)) {

352 
	`li¡Ty³In£¹
(&
’Œy
,
v®
,
wh”e
);

353 
š£¹ed
 = 1;

357 
	`li¡Ty³R–—£I‹¿tÜ
(
™”
);

359 ià(
š£¹ed
) {

361 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
 &&

362 
	`zli¡L’
(
subjeù
->
±r
è> 
£rv”
.
li¡_max_zli¡_’Œ›s
)

363 
	`li¡Ty³CÚv”t
(
subjeù
,
REDIS_ENCODING_LINKEDLIST
);

364 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

365 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"linsert",

366 
c
->
¬gv
[1],c->
db
->
id
);

367 
£rv”
.
dœty
++;

370 
	`addR•ly
(
c
,
sh¬ed
.
úegÚe
);

374 *
ev’t
 = (
wh”e
 =ğ
REDIS_HEAD
) ? "lpush" : "rpush";

376 
	`li¡Ty³Push
(
subjeù
,
v®
,
wh”e
);

377 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

378 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

379 
£rv”
.
dœty
++;

382 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
subjeù
));

383 
	}
}

385 
	$ÍushxCommªd
(
»disCl›Á
 *
c
) {

386 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

387 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
REDIS_HEAD
);

388 
	}
}

390 
	$½ushxCommªd
(
»disCl›Á
 *
c
) {

391 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

392 
	`pushxG’”icCommªd
(
c
,
NULL
,c->
¬gv
[2],
REDIS_TAIL
);

393 
	}
}

395 
	$lš£¹Commªd
(
»disCl›Á
 *
c
) {

396 
c
->
¬gv
[4] = 
	`ŒyObjeùEncodšg
(c->argv[4]);

397 ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"after") == 0) {

398 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
REDIS_TAIL
);

399 } ià(
	`¡rÿ£cmp
(
c
->
¬gv
[2]->
±r
,"before") == 0) {

400 
	`pushxG’”icCommªd
(
c
,c->
¬gv
[3],c->¬gv[4],
REDIS_HEAD
);

402 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

404 
	}
}

406 
	$Î’Commªd
(
»disCl›Á
 *
c
) {

407 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

408 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
REDIS_LIST
)) ;

409 
	`addR•lyLÚgLÚg
(
c
,
	`li¡Ty³L’gth
(
o
));

410 
	}
}

412 
	$lšdexCommªd
(
»disCl›Á
 *
c
) {

413 
robj
 *
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

414 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
REDIS_LIST
)) ;

415 
šdex
;

416 
robj
 *
v®ue
 = 
NULL
;

418 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
REDIS_OK
))

421 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

422 *
p
;

423 *
v¡r
;

424 
vËn
;

425 
vlÚg
;

426 
p
 = 
	`zli¡Index
(
o
->
±r
,
šdex
);

427 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

428 ià(
v¡r
) {

429 
v®ue
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

431 
v®ue
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

433 
	`addR•lyBulk
(
c
,
v®ue
);

434 
	`deüRefCouÁ
(
v®ue
);

436 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

438 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

439 
li¡Node
 *
Ê
 = 
	`li¡Index
(
o
->
±r
,
šdex
);

440 ià(
Ê
 !ğ
NULL
) {

441 
v®ue
 = 
	`li¡NodeV®ue
(
Ê
);

442 
	`addR•lyBulk
(
c
,
v®ue
);

444 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

447 
	`»disPªic
("Unknown†istƒncoding");

449 
	}
}

451 
	$l£tCommªd
(
»disCl›Á
 *
c
) {

452 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nokey”r
);

453 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
REDIS_LIST
)) ;

454 
šdex
;

455 
robj
 *
v®ue
 = (
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]));

457 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šdex
, 
NULL
è!ğ
REDIS_OK
))

460 
	`li¡Ty³TryCÚv”siÚ
(
o
,
v®ue
);

461 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

462 *
p
, *
zl
 = 
o
->
±r
;

463 
p
 = 
	`zli¡Index
(
zl
,
šdex
);

464 ià(
p
 =ğ
NULL
) {

465 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

467 
o
->
±r
 = 
	`zli¡D–‘e
(o->±r,&
p
);

468 
v®ue
 = 
	`g‘DecodedObjeù
(value);

469 
o
->
±r
 = 
	`zli¡In£¹
(o->±r,
p
,
v®ue
->±r,
	`sd¦’
(value->ptr));

470 
	`deüRefCouÁ
(
v®ue
);

471 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

472 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

473 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

474 
£rv”
.
dœty
++;

476 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

477 
li¡Node
 *
Ê
 = 
	`li¡Index
(
o
->
±r
,
šdex
);

478 ià(
Ê
 =ğ
NULL
) {

479 
	`addR•ly
(
c
,
sh¬ed
.
outoäªg“¼
);

481 
	`deüRefCouÁ
((
robj
*)
	`li¡NodeV®ue
(
Ê
));

482 
	`li¡NodeV®ue
(
Ê
èğ
v®ue
;

483 
	`šüRefCouÁ
(
v®ue
);

484 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

485 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

486 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"l£t",
c
->
¬gv
[1],c->
db
->
id
);

487 
£rv”
.
dœty
++;

490 
	`»disPªic
("Unknown†istƒncoding");

492 
	}
}

494 
	$pİG’”icCommªd
(
»disCl›Á
 *
c
, 
wh”e
) {

495 
robj
 *
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
);

496 ià(
o
 =ğ
NULL
 || 
	`checkTy³
(
c
,o,
REDIS_LIST
)) ;

498 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

499 ià(
v®ue
 =ğ
NULL
) {

500 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

502 *
ev’t
 = (
wh”e
 =ğ
REDIS_HEAD
) ? "lpop" : "rpop";

504 
	`addR•lyBulk
(
c
,
v®ue
);

505 
	`deüRefCouÁ
(
v®ue
);

506 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,
ev’t
,
c
->
¬gv
[1],c->
db
->
id
);

507 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

508 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"del",

509 
c
->
¬gv
[1],c->
db
->
id
);

510 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

512 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

513 
£rv”
.
dœty
++;

515 
	}
}

517 
	$ÍİCommªd
(
»disCl›Á
 *
c
) {

518 
	`pİG’”icCommªd
(
c
,
REDIS_HEAD
);

519 
	}
}

521 
	$½İCommªd
(
»disCl›Á
 *
c
) {

522 
	`pİG’”icCommªd
(
c
,
REDIS_TAIL
);

523 
	}
}

525 
	$ÌªgeCommªd
(
»disCl›Á
 *
c
) {

526 
robj
 *
o
;

527 
¡¬t
, 
’d
, 
Î’
, 
¿ng–’
;

529 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
REDIS_OK
) ||

530 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
REDIS_OK
)) ;

532 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


533 || 
	`checkTy³
(
c
,
o
,
REDIS_LIST
)) ;

534 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

537 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

538 ià(
’d
 < 0è’d = 
Î’
+end;

539 ià(
¡¬t
 < 0) start = 0;

543 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

544 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

547 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

548 
¿ng–’
 = (
’d
-
¡¬t
)+1;

551 
	`addR•lyMuÉiBulkL’
(
c
,
¿ng–’
);

552 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

553 *
p
 = 
	`zli¡Index
(
o
->
±r
,
¡¬t
);

554 *
v¡r
;

555 
vËn
;

556 
vlÚg
;

558 
¿ng–’
--) {

559 
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
);

560 ià(
v¡r
) {

561 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

563 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

565 
p
 = 
	`zli¡Next
(
o
->
±r
,p);

567 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

568 
li¡Node
 *
Ê
;

572 ià(
¡¬t
 > 
Î’
/2) start -=†len;

573 
Ê
 = 
	`li¡Index
(
o
->
±r
,
¡¬t
);

575 
¿ng–’
--) {

576 
	`addR•lyBulk
(
c
,
Ê
->
v®ue
);

577 
Ê
 =†n->
Ãxt
;

580 
	`»disPªic
("Listƒncoding is‚ot LINKEDLIST‚or ZIPLIST!");

582 
	}
}

584 
	$ÉrimCommªd
(
»disCl›Á
 *
c
) {

585 
robj
 *
o
;

586 
¡¬t
, 
’d
, 
Î’
, 
j
, 
Érim
, 
¹rim
;

587 
li¡
 *list;

588 
li¡Node
 *
Ê
;

590 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
REDIS_OK
) ||

591 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
REDIS_OK
)) ;

593 ià((
o
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
ok
)è=ğ
NULL
 ||

594 
	`checkTy³
(
c
,
o
,
REDIS_LIST
)) ;

595 
Î’
 = 
	`li¡Ty³L’gth
(
o
);

598 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

599 ià(
’d
 < 0è’d = 
Î’
+end;

600 ià(
¡¬t
 < 0) start = 0;

604 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

606 
Érim
 = 
Î’
;

607 
¹rim
 = 0;

609 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

610 
Érim
 = 
¡¬t
;

611 
¹rim
 = 
Î’
-
’d
-1;

615 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

616 
o
->
±r
 = 
	`zli¡D–‘eRªge
(o->±r,0,
Érim
);

617 
o
->
±r
 = 
	`zli¡D–‘eRªge
(o->±r,-
¹rim
,rtrim);

618 } ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_LINKEDLIST
) {

619 
li¡
 = 
o
->
±r
;

620 
j
 = 0; j < 
Érim
; j++) {

621 
Ê
 = 
	`li¡Fœ¡
(
li¡
);

622 
	`li¡D–Node
(
li¡
,
Ê
);

624 
j
 = 0; j < 
¹rim
; j++) {

625 
Ê
 = 
	`li¡La¡
(
li¡
);

626 
	`li¡D–Node
(
li¡
,
Ê
);

629 
	`»disPªic
("Unknown†istƒncoding");

632 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"Érim",
c
->
¬gv
[1],c->
db
->
id
);

633 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

634 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

635 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

637 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

638 
£rv”
.
dœty
++;

639 
	`addR•ly
(
c
,
sh¬ed
.
ok
);

640 
	}
}

642 
	$ÌemCommªd
(
»disCl›Á
 *
c
) {

643 
robj
 *
subjeù
, *
obj
;

644 
obj
 = 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

645 
tÜemove
;

646 
»moved
 = 0;

647 
li¡Ty³EÁry
 
’Œy
;

649 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
tÜemove
, 
NULL
è!ğ
REDIS_OK
))

652 
subjeù
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
);

653 ià(
subjeù
 =ğ
NULL
 || 
	`checkTy³
(
c
,subjeù,
REDIS_LIST
)) ;

656 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
)

657 
obj
 = 
	`g‘DecodedObjeù
(obj);

659 
li¡Ty³I‹¿tÜ
 *
li
;

660 ià(
tÜemove
 < 0) {

661 
tÜemove
 = -toremove;

662 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,-1,
REDIS_HEAD
);

664 
li
 = 
	`li¡Ty³In™I‹¿tÜ
(
subjeù
,0,
REDIS_TAIL
);

667 
	`li¡Ty³Next
(
li
,&
’Œy
)) {

668 ià(
	`li¡Ty³Equ®
(&
’Œy
,
obj
)) {

669 
	`li¡Ty³D–‘e
(&
’Œy
);

670 
£rv”
.
dœty
++;

671 
»moved
++;

672 ià(
tÜemove
 && 
»moved
 ==oremove) ;

675 
	`li¡Ty³R–—£I‹¿tÜ
(
li
);

678 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
)

679 
	`deüRefCouÁ
(
obj
);

681 ià(
	`li¡Ty³L’gth
(
subjeù
è=ğ0è
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

682 
	`addR•lyLÚgLÚg
(
c
,
»moved
);

683 ià(
»moved
è
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

684 
	}
}

702 
	$½İÍushHªdËPush
(
»disCl›Á
 *
c
, 
robj
 *
d¡key
,„obj *
d¡obj
,„obj *
v®ue
) {

704 ià(!
d¡obj
) {

705 
d¡obj
 = 
	`ü—‹Zli¡Objeù
();

706 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

708 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

709 
	`li¡Ty³Push
(
d¡obj
,
v®ue
,
REDIS_HEAD
);

710 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"Íush",
d¡key
,
c
->
db
->
id
);

712 
	`addR•lyBulk
(
c
,
v®ue
);

713 
	}
}

715 
	$½İÍushCommªd
(
»disCl›Á
 *
c
) {

716 
robj
 *
sobj
, *
v®ue
;

717 ià((
sobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

718 
	`checkTy³
(
c
,
sobj
,
REDIS_LIST
)) ;

720 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

723 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

725 
robj
 *
dobj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

726 
robj
 *
touchedkey
 = 
c
->
¬gv
[1];

728 ià(
dobj
 && 
	`checkTy³
(
c
,dobj,
REDIS_LIST
)) ;

729 
v®ue
 = 
	`li¡Ty³Pİ
(
sobj
,
REDIS_TAIL
);

733 
	`šüRefCouÁ
(
touchedkey
);

734 
	`½İÍushHªdËPush
(
c
,c->
¬gv
[2],
dobj
,
v®ue
);

737 
	`deüRefCouÁ
(
v®ue
);

740 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,"½İ",
touchedkey
,
c
->
db
->
id
);

741 ià(
	`li¡Ty³L’gth
(
sobj
) == 0) {

742 
	`dbD–‘e
(
c
->
db
,
touchedkey
);

743 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"del",

744 
touchedkey
,
c
->
db
->
id
);

746 
	`sigÇlModif›dKey
(
c
->
db
,
touchedkey
);

747 
	`deüRefCouÁ
(
touchedkey
);

748 
£rv”
.
dœty
++;

750 
	}
}

775 
	$blockFÜKeys
(
»disCl›Á
 *
c
, 
robj
 **
keys
, 
numkeys
, 
m¡ime_t
 
timeout
,„obj *
rg‘
) {

776 
diùEÁry
 *
de
;

777 
li¡
 *
l
;

778 
j
;

780 
c
->
bpİ
.
timeout
 =imeout;

781 
c
->
bpİ
.
rg‘
 =arget;

783 ià(
rg‘
 !ğ
NULL
è
	`šüRefCouÁ
(target);

785 
j
 = 0; j < 
numkeys
; j++) {

787 ià(
	`diùAdd
(
c
->
bpİ
.
keys
,keys[
j
],
NULL
è!ğ
DICT_OK
) ;

788 
	`šüRefCouÁ
(
keys
[
j
]);

791 
de
 = 
	`diùFšd
(
c
->
db
->
blockšg_keys
,
keys
[
j
]);

792 ià(
de
 =ğ
NULL
) {

793 
»tv®
;

796 
l
 = 
	`li¡C»©e
();

797 
»tv®
 = 
	`diùAdd
(
c
->
db
->
blockšg_keys
,
keys
[
j
],
l
);

798 
	`šüRefCouÁ
(
keys
[
j
]);

799 
	`»disAs£¹W™hInfo
(
c
,
keys
[
j
],
»tv®
 =ğ
DICT_OK
);

801 
l
 = 
	`diùG‘V®
(
de
);

803 
	`li¡AddNodeTa
(
l
,
c
);

805 
	`blockCl›Á
(
c
,
REDIS_BLOCKED_LIST
);

806 
	}
}

810 
	$unblockCl›ÁWa™šgD©a
(
»disCl›Á
 *
c
) {

811 
diùEÁry
 *
de
;

812 
diùI‹¿tÜ
 *
di
;

813 
li¡
 *
l
;

815 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`diùSize
(c->
bpİ
.
keys
) != 0);

816 
di
 = 
	`diùG‘I‹¿tÜ
(
c
->
bpİ
.
keys
);

818 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

819 
robj
 *
key
 = 
	`diùG‘Key
(
de
);

822 
l
 = 
	`diùF‘chV®ue
(
c
->
db
->
blockšg_keys
,
key
);

823 
	`»disAs£¹W™hInfo
(
c
,
key
,
l
 !ğ
NULL
);

824 
	`li¡D–Node
(
l
,
	`li¡S—rchKey
Ö,
c
));

826 ià(
	`li¡L’gth
(
l
) == 0)

827 
	`diùD–‘e
(
c
->
db
->
blockšg_keys
,
key
);

829 
	`diùR–—£I‹¿tÜ
(
di
);

832 
	`diùEm±y
(
c
->
bpİ
.
keys
,
NULL
);

833 ià(
c
->
bpİ
.
rg‘
) {

834 
	`deüRefCouÁ
(
c
->
bpİ
.
rg‘
);

835 
c
->
bpİ
.
rg‘
 = 
NULL
;

837 
	}
}

846 
	$sigÇlLi¡AsR—dy
(
»disDb
 *
db
, 
robj
 *
key
) {

847 
»adyLi¡
 *
¾
;

850 ià(
	`diùFšd
(
db
->
blockšg_keys
,
key
è=ğ
NULL
) ;

853 ià(
	`diùFšd
(
db
->
»ady_keys
,
key
è!ğ
NULL
) ;

856 
¾
 = 
	`zm®loc
((*rl));

857 
¾
->
key
 = key;

858 
¾
->
db
 = db;

859 
	`šüRefCouÁ
(
key
);

860 
	`li¡AddNodeTa
(
£rv”
.
»ady_keys
,
¾
);

865 
	`šüRefCouÁ
(
key
);

866 
	`»disAs£¹
(
	`diùAdd
(
db
->
»ady_keys
,
key
,
NULL
è=ğ
DICT_OK
);

867 
	}
}

888 
	$£rveCl›ÁBlockedOnLi¡
(
»disCl›Á
 *
»ûiv”
, 
robj
 *
key
,„obj *
d¡key
, 
»disDb
 *
db
,„obj *
v®ue
, 
wh”e
)

890 
robj
 *
¬gv
[3];

892 ià(
d¡key
 =ğ
NULL
) {

894 
¬gv
[0] = (
wh”e
 =ğ
REDIS_HEAD
è? 
sh¬ed
.
Íİ
 :

895 
sh¬ed
.
½İ
;

896 
¬gv
[1] = 
key
;

897 
	`´İag©e
((
wh”e
 =ğ
REDIS_HEAD
) ?

898 
£rv”
.
ÍİCommªd
 : s”v”.
½İCommªd
,

899 
db
->
id
,
¬gv
,2,
REDIS_PROPAGATE_AOF
|
REDIS_PROPAGATE_REPL
);

902 
	`addR•lyMuÉiBulkL’
(
»ûiv”
,2);

903 
	`addR•lyBulk
(
»ûiv”
,
key
);

904 
	`addR•lyBulk
(
»ûiv”
,
v®ue
);

907 
robj
 *
d¡obj
 =

908 
	`lookupKeyWr™e
(
»ûiv”
->
db
,
d¡key
);

909 ià(!(
d¡obj
 &&

910 
	`checkTy³
(
»ûiv”
,
d¡obj
,
REDIS_LIST
)))

913 
¬gv
[0] = 
sh¬ed
.
½İ
;

914 
¬gv
[1] = 
key
;

915 
	`´İag©e
(
£rv”
.
½İCommªd
,

916 
db
->
id
,
¬gv
,2,

917 
REDIS_PROPAGATE_AOF
|

918 
REDIS_PROPAGATE_REPL
);

919 
	`½İÍushHªdËPush
(
»ûiv”
,
d¡key
,
d¡obj
,

920 
v®ue
);

922 
¬gv
[0] = 
sh¬ed
.
Íush
;

923 
¬gv
[1] = 
d¡key
;

924 
¬gv
[2] = 
v®ue
;

925 
	`´İag©e
(
£rv”
.
ÍushCommªd
,

926 
db
->
id
,
¬gv
,3,

927 
REDIS_PROPAGATE_AOF
|

928 
REDIS_PROPAGATE_REPL
);

932  
REDIS_ERR
;

935  
REDIS_OK
;

936 
	}
}

948 
	$hªdËCl›ÁsBlockedOnLi¡s
() {

949 
	`li¡L’gth
(
£rv”
.
»ady_keys
) != 0) {

950 
li¡
 *
l
;

956 
l
 = 
£rv”
.
»ady_keys
;

957 
£rv”
.
»ady_keys
 = 
	`li¡C»©e
();

959 
	`li¡L’gth
(
l
) != 0) {

960 
li¡Node
 *
Ê
 = 
	`li¡Fœ¡
(
l
);

961 
»adyLi¡
 *
¾
 = 
Ê
->
v®ue
;

965 
	`diùD–‘e
(
¾
->
db
->
»ady_keys
,¾->
key
);

969 
robj
 *
o
 = 
	`lookupKeyWr™e
(
¾
->
db
,¾->
key
);

970 ià(
o
 !ğ
NULL
 && o->
ty³
 =ğ
REDIS_LIST
) {

971 
diùEÁry
 *
de
;

975 
de
 = 
	`diùFšd
(
¾
->
db
->
blockšg_keys
,¾->
key
);

976 ià(
de
) {

977 
li¡
 *
ş›Ás
 = 
	`diùG‘V®
(
de
);

978 
numş›Ás
 = 
	`li¡L’gth
(
ş›Ás
);

980 
numş›Ás
--) {

981 
li¡Node
 *
ş›Ánode
 = 
	`li¡Fœ¡
(
ş›Ás
);

982 
»disCl›Á
 *
»ûiv”
 = 
ş›Ánode
->
v®ue
;

983 
robj
 *
d¡key
 = 
»ûiv”
->
bpİ
.
rg‘
;

984 
wh”e
 = (
»ûiv”
->
Ï¡cmd
 &&

985 
»ûiv”
->
Ï¡cmd
->
´oc
 =ğ
bÍİCommªd
) ?

986 
REDIS_HEAD
 : 
REDIS_TAIL
;

987 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

989 ià(
v®ue
) {

993 ià(
d¡key
è
	`šüRefCouÁ
(dstkey);

994 
	`unblockCl›Á
(
»ûiv”
);

996 ià(
	`£rveCl›ÁBlockedOnLi¡
(
»ûiv”
,

997 
¾
->
key
,
d¡key
,¾->
db
,
v®ue
,

998 
wh”e
è=ğ
REDIS_ERR
)

1002 
	`li¡Ty³Push
(
o
,
v®ue
,
wh”e
);

1005 ià(
d¡key
è
	`deüRefCouÁ
(dstkey);

1006 
	`deüRefCouÁ
(
v®ue
);

1013 ià(
	`li¡Ty³L’gth
(
o
è=ğ0è
	`dbD–‘e
(
¾
->
db
,¾->
key
);

1019 
	`deüRefCouÁ
(
¾
->
key
);

1020 
	`zä“
(
¾
);

1021 
	`li¡D–Node
(
l
,
Ê
);

1023 
	`li¡R–—£
(
l
);

1025 
	}
}

1028 
	$blockšgPİG’”icCommªd
(
»disCl›Á
 *
c
, 
wh”e
) {

1029 
robj
 *
o
;

1030 
m¡ime_t
 
timeout
;

1031 
j
;

1033 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[c->
¬gc
-1],&
timeout
,
UNIT_SECONDS
)

1034 !ğ
REDIS_OK
) ;

1036 
j
 = 1; j < 
c
->
¬gc
-1; j++) {

1037 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

1038 ià(
o
 !ğ
NULL
) {

1039 ià(
o
->
ty³
 !ğ
REDIS_LIST
) {

1040 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1043 ià(
	`li¡Ty³L’gth
(
o
) != 0) {

1045 *
ev’t
 = (
wh”e
 =ğ
REDIS_HEAD
) ? "lpop" : "rpop";

1046 
robj
 *
v®ue
 = 
	`li¡Ty³Pİ
(
o
,
wh”e
);

1047 
	`»disAs£¹
(
v®ue
 !ğ
NULL
);

1049 
	`addR•lyMuÉiBulkL’
(
c
,2);

1050 
	`addR•lyBulk
(
c
,c->
¬gv
[
j
]);

1051 
	`addR•lyBulk
(
c
,
v®ue
);

1052 
	`deüRefCouÁ
(
v®ue
);

1053 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_LIST
,
ev’t
,

1054 
c
->
¬gv
[
j
],c->
db
->
id
);

1055 ià(
	`li¡Ty³L’gth
(
o
) == 0) {

1056 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[
j
]);

1057 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"del",

1058 
c
->
¬gv
[
j
],c->
db
->
id
);

1060 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[
j
]);

1061 
£rv”
.
dœty
++;

1064 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,2,

1065 (
wh”e
 =ğ
REDIS_HEAD
è? 
sh¬ed
.
Íİ
 : sh¬ed.
½İ
,

1066 
c
->
¬gv
[
j
]);

1075 ià(
c
->
æags
 & 
REDIS_MULTI
) {

1076 
	`addR•ly
(
c
,
sh¬ed
.
nuÎmuÉibulk
);

1081 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, c->
¬gc
 - 2, 
timeout
, 
NULL
);

1082 
	}
}

1084 
	$bÍİCommªd
(
»disCl›Á
 *
c
) {

1085 
	`blockšgPİG’”icCommªd
(
c
,
REDIS_HEAD
);

1086 
	}
}

1088 
	$b½İCommªd
(
»disCl›Á
 *
c
) {

1089 
	`blockšgPİG’”icCommªd
(
c
,
REDIS_TAIL
);

1090 
	}
}

1092 
	$b½İÍushCommªd
(
»disCl›Á
 *
c
) {

1093 
m¡ime_t
 
timeout
;

1095 ià(
	`g‘TimeoutFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
timeout
,
UNIT_SECONDS
)

1096 !ğ
REDIS_OK
) ;

1098 
robj
 *
key
 = 
	`lookupKeyWr™e
(
c
->
db
, c->
¬gv
[1]);

1100 ià(
key
 =ğ
NULL
) {

1101 ià(
c
->
æags
 & 
REDIS_MULTI
) {

1104 
	`addR•ly
(
c
, 
sh¬ed
.
nuÎbulk
);

1107 
	`blockFÜKeys
(
c
, c->
¬gv
 + 1, 1, 
timeout
, c->argv[2]);

1110 ià(
key
->
ty³
 !ğ
REDIS_LIST
) {

1111 
	`addR•ly
(
c
, 
sh¬ed
.
wrÚgty³”r
);

1115 
	`»disAs£¹W™hInfo
(
c
,
key
,
	`li¡Ty³L’gth
(key) > 0);

1116 
	`½İÍushCommªd
(
c
);

1119 
	}
}

	@t_set.c

30 
	~"»dis.h
"

36 
suniÚDiffG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
, 
İ
);

41 
robj
 *
	$£tTy³C»©e
(
robj
 *
v®ue
) {

42 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,
NULL
è=ğ
REDIS_OK
)

43  
	`ü—‹IÁ£tObjeù
();

44  
	`ü—‹S‘Objeù
();

45 
	}
}

47 
	$£tTy³Add
(
robj
 *
subjeù
,„obj *
v®ue
) {

48 
Îv®
;

49 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

50 ià(
	`diùAdd
(
subjeù
->
±r
,
v®ue
,
NULL
è=ğ
DICT_OK
) {

51 
	`šüRefCouÁ
(
v®ue
);

54 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

55 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
REDIS_OK
) {

56 
ušt8_t
 
sucûss
 = 0;

57 
subjeù
->
±r
 = 
	`št£tAdd
(subjeù->±r,
Îv®
,&
sucûss
);

58 ià(
sucûss
) {

61 ià(
	`št£tL’
(
subjeù
->
±r
è> 
£rv”
.
£t_max_št£t_’Œ›s
)

62 
	`£tTy³CÚv”t
(
subjeù
,
REDIS_ENCODING_HT
);

67 
	`£tTy³CÚv”t
(
subjeù
,
REDIS_ENCODING_HT
);

71 
	`»disAs£¹W™hInfo
(
NULL
,
v®ue
,
	`diùAdd
(
subjeù
->
±r
,v®ue,NULLè=ğ
DICT_OK
);

72 
	`šüRefCouÁ
(
v®ue
);

76 
	`»disPªic
("Unknown setƒncoding");

79 
	}
}

81 
	$£tTy³Remove
(
robj
 *
£tobj
,„obj *
v®ue
) {

82 
Îv®
;

83 ià(
£tobj
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

84 ià(
	`diùD–‘e
(
£tobj
->
±r
,
v®ue
è=ğ
DICT_OK
) {

85 ià(
	`htN“dsResize
(
£tobj
->
±r
)è
	`diùResize
(setobj->ptr);

88 } ià(
£tobj
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

89 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
REDIS_OK
) {

90 
sucûss
;

91 
£tobj
->
±r
 = 
	`št£tRemove
(£tobj->±r,
Îv®
,&
sucûss
);

92 ià(
sucûss
)  1;

95 
	`»disPªic
("Unknown setƒncoding");

98 
	}
}

100 
	$£tTy³IsMemb”
(
robj
 *
subjeù
,„obj *
v®ue
) {

101 
Îv®
;

102 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

103  
	`diùFšd
((
diù
*)
subjeù
->
±r
,
v®ue
è!ğ
NULL
;

104 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

105 ià(
	`isObjeùR•»£ÁabËAsLÚgLÚg
(
v®ue
,&
Îv®
è=ğ
REDIS_OK
) {

106  
	`št£tFšd
((
št£t
*)
subjeù
->
±r
,
Îv®
);

109 
	`»disPªic
("Unknown setƒncoding");

112 
	}
}

114 
£tTy³I‹¿tÜ
 *
	$£tTy³In™I‹¿tÜ
(
robj
 *
subjeù
) {

115 
£tTy³I‹¿tÜ
 *
si
 = 
	`zm®loc
((setTypeIterator));

116 
si
->
subjeù
 = subject;

117 
si
->
’codšg
 = 
subjeù
->encoding;

118 ià(
si
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

119 
si
->
di
 = 
	`diùG‘I‹¿tÜ
(
subjeù
->
±r
);

120 } ià(
si
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

121 
si
->
ii
 = 0;

123 
	`»disPªic
("Unknown setƒncoding");

125  
si
;

126 
	}
}

128 
	$£tTy³R–—£I‹¿tÜ
(
£tTy³I‹¿tÜ
 *
si
) {

129 ià(
si
->
’codšg
 =ğ
REDIS_ENCODING_HT
)

130 
	`diùR–—£I‹¿tÜ
(
si
->
di
);

131 
	`zä“
(
si
);

132 
	}
}

145 
	$£tTy³Next
(
£tTy³I‹¿tÜ
 *
si
, 
robj
 **
obj–e
, 
št64_t
 *
Î–e
) {

146 ià(
si
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

147 
diùEÁry
 *
de
 = 
	`diùNext
(
si
->
di
);

148 ià(
de
 =ğ
NULL
)  -1;

149 *
obj–e
 = 
	`diùG‘Key
(
de
);

150 } ià(
si
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

151 ià(!
	`št£tG‘
(
si
->
subjeù
->
±r
,si->
ii
++,
Î–e
))

154  
si
->
’codšg
;

155 
	}
}

164 
robj
 *
	$£tTy³NextObjeù
(
£tTy³I‹¿tÜ
 *
si
) {

165 
št64_t
 
š‹Ë
;

166 
robj
 *
obj–e
;

167 
’codšg
;

169 
’codšg
 = 
	`£tTy³Next
(
si
,&
obj–e
,&
š‹Ë
);

170 
’codšg
) {

171 -1:  
NULL
;

172 
REDIS_ENCODING_INTSET
:

173  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

174 
REDIS_ENCODING_HT
:

175 
	`šüRefCouÁ
(
obj–e
);

176  
obj–e
;

178 
	`»disPªic
("Unsupportedƒncoding");

180  
NULL
;

181 
	}
}

196 
	$£tTy³RªdomEËm’t
(
robj
 *
£tobj
,„obj **
obj–e
, 
št64_t
 *
Î–e
) {

197 ià(
£tobj
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

198 
diùEÁry
 *
de
 = 
	`diùG‘RªdomKey
(
£tobj
->
±r
);

199 *
obj–e
 = 
	`diùG‘Key
(
de
);

200 } ià(
£tobj
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

201 *
Î–e
 = 
	`št£tRªdom
(
£tobj
->
±r
);

203 
	`»disPªic
("Unknown setƒncoding");

205  
£tobj
->
’codšg
;

206 
	}
}

208 
	$£tTy³Size
(
robj
 *
subjeù
) {

209 ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

210  
	`diùSize
((
diù
*)
subjeù
->
±r
);

211 } ià(
subjeù
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

212  
	`št£tL’
((
št£t
*)
subjeù
->
±r
);

214 
	`»disPªic
("Unknown setƒncoding");

216 
	}
}

221 
	$£tTy³CÚv”t
(
robj
 *
£tobj
, 
’c
) {

222 
£tTy³I‹¿tÜ
 *
si
;

223 
	`»disAs£¹W™hInfo
(
NULL
,
£tobj
,£tobj->
ty³
 =ğ
REDIS_SET
 &&

224 
£tobj
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
);

226 ià(
’c
 =ğ
REDIS_ENCODING_HT
) {

227 
št64_t
 
š‹Ë
;

228 
diù
 *
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

229 
robj
 *
–em’t
;

232 
	`diùEx·nd
(
d
,
	`št£tL’
(
£tobj
->
±r
));

235 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£tobj
);

236 
	`£tTy³Next
(
si
,
NULL
,&
š‹Ë
) != -1) {

237 
–em’t
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
š‹Ë
);

238 
	`»disAs£¹W™hInfo
(
NULL
,
–em’t
,
	`diùAdd
(
d
,–em’t,NULLè=ğ
DICT_OK
);

240 
	`£tTy³R–—£I‹¿tÜ
(
si
);

242 
£tobj
->
’codšg
 = 
REDIS_ENCODING_HT
;

243 
	`zä“
(
£tobj
->
±r
);

244 
£tobj
->
±r
 = 
d
;

246 
	`»disPªic
("Unsupported set conversion");

248 
	}
}

250 
	$§ddCommªd
(
»disCl›Á
 *
c
) {

251 
robj
 *
£t
;

252 
j
, 
added
 = 0;

254 
£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

255 ià(
£t
 =ğ
NULL
) {

256 
£t
 = 
	`£tTy³C»©e
(
c
->
¬gv
[2]);

257 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
£t
);

259 ià(
£t
->
ty³
 !ğ
REDIS_SET
) {

260 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

265 
j
 = 2; j < 
c
->
¬gc
; j++) {

266 
c
->
¬gv
[
j
] = 
	`ŒyObjeùEncodšg
(c->argv[j]);

267 ià(
	`£tTy³Add
(
£t
,
c
->
¬gv
[
j
])è
added
++;

269 ià(
added
) {

270 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

271 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"§dd",
c
->
¬gv
[1],c->
db
->
id
);

273 
£rv”
.
dœty
 +ğ
added
;

274 
	`addR•lyLÚgLÚg
(
c
,
added
);

275 
	}
}

277 
	$¤emCommªd
(
»disCl›Á
 *
c
) {

278 
robj
 *
£t
;

279 
j
, 
d–‘ed
 = 0, 
key»moved
 = 0;

281 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

282 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

284 
j
 = 2; j < 
c
->
¬gc
; j++) {

285 ià(
	`£tTy³Remove
(
£t
,
c
->
¬gv
[
j
])) {

286 
d–‘ed
++;

287 ià(
	`£tTy³Size
(
£t
) == 0) {

288 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

289 
key»moved
 = 1;

294 ià(
d–‘ed
) {

295 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

296 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

297 ià(
key»moved
)

298 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],

299 
c
->
db
->
id
);

300 
£rv”
.
dœty
 +ğ
d–‘ed
;

302 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

303 
	}
}

305 
	$smoveCommªd
(
»disCl›Á
 *
c
) {

306 
robj
 *
¤c£t
, *
d¡£t
, *
–e
;

307 
¤c£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

308 
d¡£t
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[2]);

309 
–e
 = 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

312 ià(
¤c£t
 =ğ
NULL
) {

313 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

319 ià(
	`checkTy³
(
c
,
¤c£t
,
REDIS_SET
) ||

320 (
d¡£t
 && 
	`checkTy³
(
c
,d¡£t,
REDIS_SET
))) ;

323 ià(
¤c£t
 =ğ
d¡£t
) {

324 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

329 ià(!
	`£tTy³Remove
(
¤c£t
,
–e
)) {

330 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

333 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"¤em",
c
->
¬gv
[1],c->
db
->
id
);

336 ià(
	`£tTy³Size
(
¤c£t
) == 0) {

337 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

338 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

340 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

341 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[2]);

342 
£rv”
.
dœty
++;

345 ià(!
d¡£t
) {

346 
d¡£t
 = 
	`£tTy³C»©e
(
–e
);

347 
	`dbAdd
(
c
->
db
,c->
¬gv
[2],
d¡£t
);

351 ià(
	`£tTy³Add
(
d¡£t
,
–e
)) {

352 
£rv”
.
dœty
++;

353 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"§dd",
c
->
¬gv
[2],c->
db
->
id
);

355 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

356 
	}
}

358 
	$sismemb”Commªd
(
»disCl›Á
 *
c
) {

359 
robj
 *
£t
;

361 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

362 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

364 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

365 ià(
	`£tTy³IsMemb”
(
£t
,
c
->
¬gv
[2]))

366 
	`addR•ly
(
c
,
sh¬ed
.
cÚe
);

368 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

369 
	}
}

371 
	$sÿrdCommªd
(
»disCl›Á
 *
c
) {

372 
robj
 *
o
;

374 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

375 
	`checkTy³
(
c
,
o
,
REDIS_SET
)) ;

377 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
o
));

378 
	}
}

380 
	$¥İCommªd
(
»disCl›Á
 *
c
) {

381 
robj
 *
£t
, *
–e
, *
aux
;

382 
št64_t
 
Î–e
;

383 
’codšg
;

385 ià((
£t
 = 
	`lookupKeyWr™eOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

386 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

388 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

389 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

390 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

391 
£t
->
±r
 = 
	`št£tRemove
(£t->±r,
Î–e
,
NULL
);

393 
	`šüRefCouÁ
(
–e
);

394 
	`£tTy³Remove
(
£t
,
–e
);

396 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"¥İ",
c
->
¬gv
[1],c->
db
->
id
);

399 
aux
 = 
	`ü—‹SŒšgObjeù
("SREM",4);

400 
	`»wr™eCl›ÁCommªdVeùÜ
(
c
,3,
aux
,c->
¬gv
[1],
–e
);

401 
	`deüRefCouÁ
(
–e
);

402 
	`deüRefCouÁ
(
aux
);

404 
	`addR•lyBulk
(
c
,
–e
);

405 ià(
	`£tTy³Size
(
£t
) == 0) {

406 
	`dbD–‘e
(
c
->
db
,c->
¬gv
[1]);

407 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
c
->
¬gv
[1],c->
db
->
id
);

409 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

410 
£rv”
.
dœty
++;

411 
	}
}

419 
	#SRANDMEMBER_SUB_STRATEGY_MUL
 3

	)

421 
	$¤ªdmemb”W™hCouÁCommªd
(
»disCl›Á
 *
c
) {

422 
l
;

423 
couÁ
, 
size
;

424 
uniq
 = 1;

425 
robj
 *
£t
, *
–e
;

426 
št64_t
 
Î–e
;

427 
’codšg
;

429 
diù
 *
d
;

431 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
l
,
NULL
è!ğ
REDIS_OK
) ;

432 ià(
l
 >= 0) {

433 
couÁ
 = (è
l
;

437 
couÁ
 = -
l
;

438 
uniq
 = 0;

441 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ymuÉibulk
))

442 =ğ
NULL
 || 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

443 
size
 = 
	`£tTy³Size
(
£t
);

446 ià(
couÁ
 == 0) {

447 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

455 ià(!
uniq
) {

456 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

457 
couÁ
--) {

458 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

459 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

460 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

462 
	`addR•lyBulk
(
c
,
–e
);

471 ià(
couÁ
 >ğ
size
) {

472 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,1,
NULL
,
REDIS_OP_UNION
);

477 
d
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

488 ià(
couÁ
*
SRANDMEMBER_SUB_STRATEGY_MUL
 > 
size
) {

489 
£tTy³I‹¿tÜ
 *
si
;

492 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£t
);

493 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–e
,&
Î–e
)) != -1) {

494 
»tv®
 = 
DICT_ERR
;

496 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

497 
»tv®
 = 
	`diùAdd
(
d
,
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
),
NULL
);

499 
»tv®
 = 
	`diùAdd
(
d
,
	`dupSŒšgObjeù
(
–e
),
NULL
);

501 
	`»disAs£¹
(
»tv®
 =ğ
DICT_OK
);

503 
	`£tTy³R–—£I‹¿tÜ
(
si
);

504 
	`»disAs£¹
(
	`diùSize
(
d
è=ğ
size
);

507 
size
 > 
couÁ
) {

508 
diùEÁry
 *
de
;

510 
de
 = 
	`diùG‘RªdomKey
(
d
);

511 
	`diùD–‘e
(
d
,
	`diùG‘Key
(
de
));

512 
size
--;

521 
added
 = 0;

523 
added
 < 
couÁ
) {

524 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

525 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

526 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
Î–e
);

528 
–e
 = 
	`dupSŒšgObjeù
(ele);

533 ià(
	`diùAdd
(
d
,
–e
,
NULL
è=ğ
DICT_OK
)

534 
added
++;

536 
	`deüRefCouÁ
(
–e
);

542 
diùI‹¿tÜ
 *
di
;

543 
diùEÁry
 *
de
;

545 
	`addR•lyMuÉiBulkL’
(
c
,
couÁ
);

546 
di
 = 
	`diùG‘I‹¿tÜ
(
d
);

547 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
)

548 
	`addR•lyBulk
(
c
,
	`diùG‘Key
(
de
));

549 
	`diùR–—£I‹¿tÜ
(
di
);

550 
	`diùR–—£
(
d
);

552 
	}
}

554 
	$¤ªdmemb”Commªd
(
»disCl›Á
 *
c
) {

555 
robj
 *
£t
, *
–e
;

556 
št64_t
 
Î–e
;

557 
’codšg
;

559 ià(
c
->
¬gc
 == 3) {

560 
	`¤ªdmemb”W™hCouÁCommªd
(
c
);

562 } ià(
c
->
¬gc
 > 3) {

563 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

567 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

568 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

570 
’codšg
 = 
	`£tTy³RªdomEËm’t
(
£t
,&
–e
,&
Î–e
);

571 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

572 
	`addR•lyBulkLÚgLÚg
(
c
,
Î–e
);

574 
	`addR•lyBulk
(
c
,
–e
);

576 
	}
}

578 
	$qsÜtCom·»S‘sByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

579  
	`£tTy³Size
(*(
robj
**)
s1
)-£tTy³Size(*Ôobj**)
s2
);

580 
	}
}

584 
	$qsÜtCom·»S‘sByRevC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

585 
robj
 *
o1
 = *Ôobj**)
s1
, *
o2
 = *Ôobj**)
s2
;

587  (
o2
 ? 
	`£tTy³Size
(o2è: 0è- (
o1
 ? setTypeSize(o1) : 0);

588 
	}
}

590 
	$sš‹rG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
) {

591 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

592 
£tTy³I‹¿tÜ
 *
si
;

593 
robj
 *
–eobj
, *
d¡£t
 = 
NULL
;

594 
št64_t
 
štobj
;

595 *
»¶yËn
 = 
NULL
;

596 
j
, 
ÿrdš®™y
 = 0;

597 
’codšg
;

599 
j
 = 0; j < 
£Šum
; j++) {

600 
robj
 *
£tobj
 = 
d¡key
 ?

601 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

602 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

603 ià(!
£tobj
) {

604 
	`zä“
(
£ts
);

605 ià(
d¡key
) {

606 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

607 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

608 
£rv”
.
dœty
++;

610 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

612 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

616 ià(
	`checkTy³
(
c
,
£tobj
,
REDIS_SET
)) {

617 
	`zä“
(
£ts
);

620 
£ts
[
j
] = 
£tobj
;

624 
	`qsÜt
(
£ts
,
£Šum
,(
robj
*),
qsÜtCom·»S‘sByC¬dš®™y
);

631 ià(!
d¡key
) {

632 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

636 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

642 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

643 (
’codšg
 = 
	`£tTy³Next
(
si
,&
–eobj
,&
štobj
)) != -1) {

644 
j
 = 1; j < 
£Šum
; j++) {

645 ià(
£ts
[
j
] == sets[0]) ;

646 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

648 ià(
£ts
[
j
]->
’codšg
 =ğ
REDIS_ENCODING_INTSET
 &&

649 !
	`št£tFšd
((
št£t
*)
£ts
[
j
]->
±r
,
štobj
))

655 } ià(
£ts
[
j
]->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

656 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

657 ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–eobj
)) {

658 
	`deüRefCouÁ
(
–eobj
);

661 
	`deüRefCouÁ
(
–eobj
);

663 } ià(
’codšg
 =ğ
REDIS_ENCODING_HT
) {

667 ià(
–eobj
->
’codšg
 =ğ
REDIS_ENCODING_INT
 &&

668 
£ts
[
j
]->
’codšg
 =ğ
REDIS_ENCODING_INTSET
 &&

669 !
	`št£tFšd
((
št£t
*)
£ts
[
j
]->
±r
,()
–eobj
->ptr))

674 } ià(!
	`£tTy³IsMemb”
(
£ts
[
j
],
–eobj
)) {

681 ià(
j
 =ğ
£Šum
) {

682 ià(!
d¡key
) {

683 ià(
’codšg
 =ğ
REDIS_ENCODING_HT
)

684 
	`addR•lyBulk
(
c
,
–eobj
);

686 
	`addR•lyBulkLÚgLÚg
(
c
,
štobj
);

687 
ÿrdš®™y
++;

689 ià(
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

690 
–eobj
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
štobj
);

691 
	`£tTy³Add
(
d¡£t
,
–eobj
);

692 
	`deüRefCouÁ
(
–eobj
);

694 
	`£tTy³Add
(
d¡£t
,
–eobj
);

699 
	`£tTy³R–—£I‹¿tÜ
(
si
);

701 ià(
d¡key
) {

704 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

705 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

706 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

707 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

708 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,"sinterstore",

709 
d¡key
,
c
->
db
->
id
);

711 
	`deüRefCouÁ
(
d¡£t
);

712 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

713 ià(
d–‘ed
)

714 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"del",

715 
d¡key
,
c
->
db
->
id
);

717 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

718 
£rv”
.
dœty
++;

720 
	`£tDeã¼edMuÉiBulkL’gth
(
c
,
»¶yËn
,
ÿrdš®™y
);

722 
	`zä“
(
£ts
);

723 
	}
}

725 
	$sš‹rCommªd
(
»disCl›Á
 *
c
) {

726 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
);

727 
	}
}

729 
	$sš‹r¡ÜeCommªd
(
»disCl›Á
 *
c
) {

730 
	`sš‹rG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->argv[1]);

731 
	}
}

733 
	#REDIS_OP_UNION
 0

	)

734 
	#REDIS_OP_DIFF
 1

	)

735 
	#REDIS_OP_INTER
 2

	)

737 
	$suniÚDiffG’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 **
£tkeys
, 
£Šum
,„obj *
d¡key
, 
İ
) {

738 
robj
 **
£ts
 = 
	`zm®loc
(Ôobj*)*
£Šum
);

739 
£tTy³I‹¿tÜ
 *
si
;

740 
robj
 *
–e
, *
d¡£t
 = 
NULL
;

741 
j
, 
ÿrdš®™y
 = 0;

742 
diff_®go
 = 1;

744 
j
 = 0; j < 
£Šum
; j++) {

745 
robj
 *
£tobj
 = 
d¡key
 ?

746 
	`lookupKeyWr™e
(
c
->
db
,
£tkeys
[
j
]) :

747 
	`lookupKeyR—d
(
c
->
db
,
£tkeys
[
j
]);

748 ià(!
£tobj
) {

749 
£ts
[
j
] = 
NULL
;

752 ià(
	`checkTy³
(
c
,
£tobj
,
REDIS_SET
)) {

753 
	`zä“
(
£ts
);

756 
£ts
[
j
] = 
£tobj
;

768 ià(
İ
 =ğ
REDIS_OP_DIFF
 && 
£ts
[0]) {

769 
®go_Úe_wÜk
 = 0, 
®go_two_wÜk
 = 0;

771 
j
 = 0; j < 
£Šum
; j++) {

772 ià(
£ts
[
j
] =ğ
NULL
) ;

774 
®go_Úe_wÜk
 +ğ
	`£tTy³Size
(
£ts
[0]);

775 
®go_two_wÜk
 +ğ
	`£tTy³Size
(
£ts
[
j
]);

780 
®go_Úe_wÜk
 /= 2;

781 
diff_®go
 = (
®go_Úe_wÜk
 <ğ
®go_two_wÜk
) ? 1 : 2;

783 ià(
diff_®go
 =ğ1 && 
£Šum
 > 1) {

787 
	`qsÜt
(
£ts
+1,
£Šum
-1,(
robj
*),

788 
qsÜtCom·»S‘sByRevC¬dš®™y
);

795 
d¡£t
 = 
	`ü—‹IÁ£tObjeù
();

797 ià(
İ
 =ğ
REDIS_OP_UNION
) {

800 
j
 = 0; j < 
£Šum
; j++) {

801 ià(!
£ts
[
j
]) ;

803 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

804 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

805 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

806 
	`deüRefCouÁ
(
–e
);

808 
	`£tTy³R–—£I‹¿tÜ
(
si
);

810 } ià(
İ
 =ğ
REDIS_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 1) {

819 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[0]);

820 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

821 
j
 = 1; j < 
£Šum
; j++) {

822 ià(!
£ts
[
j
]) ;

823 ià(
£ts
[
j
] == sets[0]) ;

824 ià(
	`£tTy³IsMemb”
(
£ts
[
j
],
–e
)) ;

826 ià(
j
 =ğ
£Šum
) {

828 
	`£tTy³Add
(
d¡£t
,
–e
);

829 
ÿrdš®™y
++;

831 
	`deüRefCouÁ
(
–e
);

833 
	`£tTy³R–—£I‹¿tÜ
(
si
);

834 } ià(
İ
 =ğ
REDIS_OP_DIFF
 && 
£ts
[0] && 
diff_®go
 == 2) {

842 
j
 = 0; j < 
£Šum
; j++) {

843 ià(!
£ts
[
j
]) ;

845 
si
 = 
	`£tTy³In™I‹¿tÜ
(
£ts
[
j
]);

846 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

847 ià(
j
 == 0) {

848 ià(
	`£tTy³Add
(
d¡£t
,
–e
)è
ÿrdš®™y
++;

850 ià(
	`£tTy³Remove
(
d¡£t
,
–e
)è
ÿrdš®™y
--;

852 
	`deüRefCouÁ
(
–e
);

854 
	`£tTy³R–—£I‹¿tÜ
(
si
);

858 ià(
ÿrdš®™y
 == 0) ;

863 ià(!
d¡key
) {

864 
	`addR•lyMuÉiBulkL’
(
c
,
ÿrdš®™y
);

865 
si
 = 
	`£tTy³In™I‹¿tÜ
(
d¡£t
);

866 (
–e
 = 
	`£tTy³NextObjeù
(
si
)è!ğ
NULL
) {

867 
	`addR•lyBulk
(
c
,
–e
);

868 
	`deüRefCouÁ
(
–e
);

870 
	`£tTy³R–—£I‹¿tÜ
(
si
);

871 
	`deüRefCouÁ
(
d¡£t
);

875 
d–‘ed
 = 
	`dbD–‘e
(
c
->
db
,
d¡key
);

876 ià(
	`£tTy³Size
(
d¡£t
) > 0) {

877 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡£t
);

878 
	`addR•lyLÚgLÚg
(
c
,
	`£tTy³Size
(
d¡£t
));

879 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_SET
,

880 
İ
 =ğ
REDIS_OP_UNION
 ? "sunionstore" : "sdiffstore",

881 
d¡key
,
c
->
db
->
id
);

883 
	`deüRefCouÁ
(
d¡£t
);

884 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

885 ià(
d–‘ed
)

886 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"del",

887 
d¡key
,
c
->
db
->
id
);

889 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

890 
£rv”
.
dœty
++;

892 
	`zä“
(
£ts
);

893 
	}
}

895 
	$suniÚCommªd
(
»disCl›Á
 *
c
) {

896 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
REDIS_OP_UNION
);

897 
	}
}

899 
	$suniÚ¡ÜeCommªd
(
»disCl›Á
 *
c
) {

900 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
REDIS_OP_UNION
);

901 
	}
}

903 
	$sdiffCommªd
(
»disCl›Á
 *
c
) {

904 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+1,c->
¬gc
-1,
NULL
,
REDIS_OP_DIFF
);

905 
	}
}

907 
	$sdiff¡ÜeCommªd
(
»disCl›Á
 *
c
) {

908 
	`suniÚDiffG’”icCommªd
(
c
,c->
¬gv
+2,c->
¬gc
-2,c->¬gv[1],
REDIS_OP_DIFF
);

909 
	}
}

911 
	$ssÿnCommªd
(
»disCl›Á
 *
c
) {

912 
robj
 *
£t
;

913 
cursÜ
;

915 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
REDIS_ERR
) ;

916 ià((
£t
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

917 
	`checkTy³
(
c
,
£t
,
REDIS_SET
)) ;

918 
	`sÿnG’”icCommªd
(
c
,
£t
,
cursÜ
);

919 
	}
}

	@t_string.c

30 
	~"»dis.h
"

31 
	~<m©h.h
>

37 
	$checkSŒšgL’gth
(
»disCl›Á
 *
c
, 
size
) {

38 ià(
size
 > 512*1024*1024) {

39 
	`addR•lyE¼Ü
(
c
,"stringƒxceeds maximum‡llowed size (512MB)");

40  
REDIS_ERR
;

42  
REDIS_OK
;

43 
	}
}

61 
	#REDIS_SET_NO_FLAGS
 0

	)

62 
	#REDIS_SET_NX
 (1<<0è

	)

63 
	#REDIS_SET_XX
 (1<<1è

	)

65 
	$£tG’”icCommªd
(
»disCl›Á
 *
c
, 
æags
, 
robj
 *
key
,„obj *
v®
,„obj *
expœe
, 
un™
,„obj *
ok_»¶y
,„obj *
abÜt_»¶y
) {

66 
mli£cÚds
 = 0;

68 ià(
expœe
) {

69 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, 
expœe
, &
mli£cÚds
, 
NULL
è!ğ
REDIS_OK
)

71 ià(
mli£cÚds
 <= 0) {

72 
	`addR•lyE¼ÜFÜm©
(
c
,"šv®idƒxpœtimš %s",c->
cmd
->
Çme
);

75 ià(
un™
 =ğ
UNIT_SECONDS
è
mli£cÚds
 *= 1000;

78 ià((
æags
 & 
REDIS_SET_NX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è!ğ
NULL
) ||

79 (
æags
 & 
REDIS_SET_XX
 && 
	`lookupKeyWr™e
(
c
->
db
,
key
è=ğ
NULL
))

81 
	`addR•ly
(
c
, 
abÜt_»¶y
 ?‡bÜt_»¶y : 
sh¬ed
.
nuÎbulk
);

84 
	`£tKey
(
c
->
db
,
key
,
v®
);

85 
£rv”
.
dœty
++;

86 ià(
expœe
è
	`£tExpœe
(
c
->
db
,
key
,
	`m¡ime
()+
mli£cÚds
);

87 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"£t",
key
,
c
->
db
->
id
);

88 ià(
expœe
è
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,

89 "expœe",
key
,
c
->
db
->
id
);

90 
	`addR•ly
(
c
, 
ok_»¶y
 ? ok_»¶y : 
sh¬ed
.
ok
);

91 
	}
}

94 
	$£tCommªd
(
»disCl›Á
 *
c
) {

95 
j
;

96 
robj
 *
expœe
 = 
NULL
;

97 
un™
 = 
UNIT_SECONDS
;

98 
æags
 = 
REDIS_SET_NO_FLAGS
;

100 
j
 = 3; j < 
c
->
¬gc
; j++) {

101 *
a
 = 
c
->
¬gv
[
j
]->
±r
;

102 
robj
 *
Ãxt
 = (
j
 =ğ
c
->
¬gc
-1è? 
NULL
 : c->
¬gv
[j+1];

104 ià((
a
[0] == 'n' ||‡[0] == 'N') &&

105 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0') {

106 
æags
 |ğ
REDIS_SET_NX
;

107 } ià((
a
[0] == 'x' ||‡[0] == 'X') &&

108 (
a
[1] == 'x' ||‡[1] == 'X') &&‡[2] == '\0') {

109 
æags
 |ğ
REDIS_SET_XX
;

110 } ià((
a
[0] == 'e' ||‡[0] == 'E') &&

111 (
a
[1] =ğ'x' ||‡[1] =ğ'X'è&&‡[2] =ğ'\0' && 
Ãxt
) {

112 
un™
 = 
UNIT_SECONDS
;

113 
expœe
 = 
Ãxt
;

114 
j
++;

115 } ià((
a
[0] == 'p' ||‡[0] == 'P') &&

116 (
a
[1] =ğ'x' ||‡[1] =ğ'X'è&&‡[2] =ğ'\0' && 
Ãxt
) {

117 
un™
 = 
UNIT_MILLISECONDS
;

118 
expœe
 = 
Ãxt
;

119 
j
++;

121 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

126 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

127 
	`£tG’”icCommªd
(
c
,
æags
,c->
¬gv
[1],c->¬gv[2],
expœe
,
un™
,
NULL
,NULL);

128 
	}
}

130 
	$£ŠxCommªd
(
»disCl›Á
 *
c
) {

131 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

132 
	`£tG’”icCommªd
(
c
,
REDIS_SET_NX
,c->
¬gv
[1],c->¬gv[2],
NULL
,0,
sh¬ed
.
cÚe
,sh¬ed.
cz”o
);

133 
	}
}

135 
	$£‹xCommªd
(
»disCl›Á
 *
c
) {

136 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

137 
	`£tG’”icCommªd
(
c
,
REDIS_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_SECONDS
,
NULL
,NULL);

138 
	}
}

140 
	$p£‹xCommªd
(
»disCl›Á
 *
c
) {

141 
c
->
¬gv
[3] = 
	`ŒyObjeùEncodšg
(c->argv[3]);

142 
	`£tG’”icCommªd
(
c
,
REDIS_SET_NO_FLAGS
,c->
¬gv
[1],c->¬gv[3],c->¬gv[2],
UNIT_MILLISECONDS
,
NULL
,NULL);

143 
	}
}

145 
	$g‘G’”icCommªd
(
»disCl›Á
 *
c
) {

146 
robj
 *
o
;

148 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
nuÎbulk
)è=ğ
NULL
)

149  
REDIS_OK
;

151 ià(
o
->
ty³
 !ğ
REDIS_STRING
) {

152 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

153  
REDIS_ERR
;

155 
	`addR•lyBulk
(
c
,
o
);

156  
REDIS_OK
;

158 
	}
}

160 
	$g‘Commªd
(
»disCl›Á
 *
c
) {

161 
	`g‘G’”icCommªd
(
c
);

162 
	}
}

164 
	$g‘£tCommªd
(
»disCl›Á
 *
c
) {

165 ià(
	`g‘G’”icCommªd
(
c
è=ğ
REDIS_ERR
) ;

166 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

167 
	`£tKey
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

168 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"£t",
c
->
¬gv
[1],c->
db
->
id
);

169 
£rv”
.
dœty
++;

170 
	}
}

172 
	$£ŒªgeCommªd
(
»disCl›Á
 *
c
) {

173 
robj
 *
o
;

174 
off£t
;

175 
sds
 
v®ue
 = 
c
->
¬gv
[3]->
±r
;

177 ià(
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
off£t
,
NULL
è!ğ
REDIS_OK
)

180 ià(
off£t
 < 0) {

181 
	`addR•lyE¼Ü
(
c
,"offset is out of„ange");

185 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

186 ià(
o
 =ğ
NULL
) {

188 ià(
	`sd¦’
(
v®ue
) == 0) {

189 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

194 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
REDIS_OK
)

197 
o
 = 
	`ü—‹Objeù
(
REDIS_STRING
,
	`sd£m±y
());

198 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
o
);

200 
size_t
 
Ş’
;

203 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
))

207 
Ş’
 = 
	`¡ršgObjeùL’
(
o
);

208 ià(
	`sd¦’
(
v®ue
) == 0) {

209 
	`addR•lyLÚgLÚg
(
c
,
Ş’
);

214 ià(
	`checkSŒšgL’gth
(
c
,
off£t
+
	`sd¦’
(
v®ue
)è!ğ
REDIS_OK
)

218 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

221 ià(
	`sd¦’
(
v®ue
) > 0) {

222 
o
->
±r
 = 
	`sdsgrowz”o
(o->±r,
off£t
+
	`sd¦’
(
v®ue
));

223 
	`memıy
((*)
o
->
±r
+
off£t
,
v®ue
,
	`sd¦’
(value));

224 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

225 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,

226 "£Œªge",
c
->
¬gv
[1],c->
db
->
id
);

227 
£rv”
.
dœty
++;

229 
	`addR•lyLÚgLÚg
(
c
,
	`sd¦’
(
o
->
±r
));

230 
	}
}

232 
	$g‘¿ngeCommªd
(
»disCl›Á
 *
c
) {

233 
robj
 *
o
;

234 
¡¬t
, 
’d
;

235 *
¡r
, 
Îbuf
[32];

236 
size_t
 
¡¾’
;

238 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
REDIS_OK
)

240 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
REDIS_OK
)

242 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ybulk
)è=ğ
NULL
 ||

243 
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

245 ià(
o
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

246 
¡r
 = 
Îbuf
;

247 
¡¾’
 = 
	`Î2¡ršg
(
Îbuf
,Ölbuf),()
o
->
±r
);

249 
¡r
 = 
o
->
±r
;

250 
¡¾’
 = 
	`sd¦’
(
¡r
);

254 ià(
¡¬t
 < 0è¡¬ˆğ
¡¾’
+start;

255 ià(
’d
 < 0è’d = 
¡¾’
+end;

256 ià(
¡¬t
 < 0) start = 0;

257 ià(
’d
 < 0)ƒnd = 0;

258 ià(()
’d
 >ğ
¡¾’
)ƒnd = strlen-1;

262 ià(
¡¬t
 > 
’d
 || 
¡¾’
 == 0) {

263 
	`addR•ly
(
c
,
sh¬ed
.
em±ybulk
);

265 
	`addR•lyBulkCBufãr
(
c
,(*)
¡r
+
¡¬t
,
’d
-start+1);

267 
	}
}

269 
	$mg‘Commªd
(
»disCl›Á
 *
c
) {

270 
j
;

272 
	`addR•lyMuÉiBulkL’
(
c
,c->
¬gc
-1);

273 
j
 = 1; j < 
c
->
¬gc
; j++) {

274 
robj
 *
o
 = 
	`lookupKeyR—d
(
c
->
db
,c->
¬gv
[
j
]);

275 ià(
o
 =ğ
NULL
) {

276 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

278 ià(
o
->
ty³
 !ğ
REDIS_STRING
) {

279 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

281 
	`addR•lyBulk
(
c
,
o
);

285 
	}
}

287 
	$m£tG’”icCommªd
(
»disCl›Á
 *
c
, 
nx
) {

288 
j
, 
busykeys
 = 0;

290 ià((
c
->
¬gc
 % 2) == 0) {

291 
	`addR•lyE¼Ü
(
c
,"wrong‚umber of‡rguments for MSET");

296 ià(
nx
) {

297 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

298 ià(
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]è!ğ
NULL
) {

299 
busykeys
++;

302 ià(
busykeys
) {

303 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

308 
j
 = 1; j < 
c
->
¬gc
; j += 2) {

309 
c
->
¬gv
[
j
+1] = 
	`ŒyObjeùEncodšg
(c->argv[j+1]);

310 
	`£tKey
(
c
->
db
,c->
¬gv
[
j
],c->argv[j+1]);

311 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"£t",
c
->
¬gv
[
j
],c->
db
->
id
);

313 
£rv”
.
dœty
 +ğ(
c
->
¬gc
-1)/2;

314 
	`addR•ly
(
c
, 
nx
 ? 
sh¬ed
.
cÚe
 : sh¬ed.
ok
);

315 
	}
}

317 
	$m£tCommªd
(
»disCl›Á
 *
c
) {

318 
	`m£tG’”icCommªd
(
c
,0);

319 
	}
}

321 
	$m£ŠxCommªd
(
»disCl›Á
 *
c
) {

322 
	`m£tG’”icCommªd
(
c
,1);

323 
	}
}

325 
	$šüDeüCommªd
(
»disCl›Á
 *
c
, 
šü
) {

326 
v®ue
, 
Şdv®ue
;

327 
robj
 *
o
, *
Ãw
;

329 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

330 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
REDIS_STRING
)) ;

331 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
REDIS_OK
) ;

333 
Şdv®ue
 = 
v®ue
;

334 ià((
šü
 < 0 && 
Şdv®ue
 < 0 && inü < (
LLONG_MIN
-oldvalue)) ||

335 (
šü
 > 0 && 
Şdv®ue
 > 0 && inü > (
LLONG_MAX
-oldvalue))) {

336 
	`addR•lyE¼Ü
(
c
,"increment or decrement would overflow");

339 
v®ue
 +ğ
šü
;

341 ià(
o
 && o->
»fcouÁ
 =ğ1 && o->
’codšg
 =ğ
REDIS_ENCODING_INT
 &&

342 (
v®ue
 < 0 || v®u>ğ
REDIS_SHARED_INTEGERS
) &&

343 
v®ue
 >ğ
LONG_MIN
 && v®u<ğ
LONG_MAX
)

345 
Ãw
 = 
o
;

346 
o
->
±r
 = (*)(()
v®ue
);

348 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
v®ue
);

349 ià(
o
) {

350 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

352 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

355 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

356 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"šüby",
c
->
¬gv
[1],c->
db
->
id
);

357 
£rv”
.
dœty
++;

358 
	`addR•ly
(
c
,
sh¬ed
.
cŞÚ
);

359 
	`addR•ly
(
c
,
Ãw
);

360 
	`addR•ly
(
c
,
sh¬ed
.
ülf
);

361 
	}
}

363 
	$šüCommªd
(
»disCl›Á
 *
c
) {

364 
	`šüDeüCommªd
(
c
,1);

365 
	}
}

367 
	$deüCommªd
(
»disCl›Á
 *
c
) {

368 
	`šüDeüCommªd
(
c
,-1);

369 
	}
}

371 
	$šübyCommªd
(
»disCl›Á
 *
c
) {

372 
šü
;

374 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
REDIS_OK
) ;

375 
	`šüDeüCommªd
(
c
,
šü
);

376 
	}
}

378 
	$deübyCommªd
(
»disCl›Á
 *
c
) {

379 
šü
;

381 ià(
	`g‘LÚgLÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
šü
, 
NULL
è!ğ
REDIS_OK
) ;

382 
	`šüDeüCommªd
(
c
,-
šü
);

383 
	}
}

385 
	$šübyæßtCommªd
(
»disCl›Á
 *
c
) {

386 
šü
, 
v®ue
;

387 
robj
 *
o
, *
Ãw
, *
aux
;

389 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

390 ià(
o
 !ğ
NULL
 && 
	`checkTy³
(
c
,o,
REDIS_STRING
)) ;

391 ià(
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,
o
,&
v®ue
,
NULL
è!ğ
REDIS_OK
 ||

392 
	`g‘LÚgDoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
šü
,
NULL
è!ğ
REDIS_OK
)

395 
v®ue
 +ğ
šü
;

396 ià(
	`i¢ª
(
v®ue
è|| 
	`isšf
(value)) {

397 
	`addR•lyE¼Ü
(
c
,"increment would…roduce NaN or Infinity");

400 
Ãw
 = 
	`ü—‹SŒšgObjeùFromLÚgDoubË
(
v®ue
,1);

401 ià(
o
)

402 
	`dbOv”wr™e
(
c
->
db
,c->
¬gv
[1],
Ãw
);

404 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],
Ãw
);

405 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

406 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"šübyæßt",
c
->
¬gv
[1],c->
db
->
id
);

407 
£rv”
.
dœty
++;

408 
	`addR•lyBulk
(
c
,
Ãw
);

413 
aux
 = 
	`ü—‹SŒšgObjeù
("SET",3);

414 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,0,
aux
);

415 
	`deüRefCouÁ
(
aux
);

416 
	`»wr™eCl›ÁCommªdArgum’t
(
c
,2,
Ãw
);

417 
	}
}

419 
	$­³ndCommªd
(
»disCl›Á
 *
c
) {

420 
size_t
 
tÙËn
;

421 
robj
 *
o
, *
­³nd
;

423 
o
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[1]);

424 ià(
o
 =ğ
NULL
) {

426 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

427 
	`dbAdd
(
c
->
db
,c->
¬gv
[1],c->argv[2]);

428 
	`šüRefCouÁ
(
c
->
¬gv
[2]);

429 
tÙËn
 = 
	`¡ršgObjeùL’
(
c
->
¬gv
[2]);

432 ià(
	`checkTy³
(
c
,
o
,
REDIS_STRING
))

436 
­³nd
 = 
c
->
¬gv
[2];

437 
tÙËn
 = 
	`¡ršgObjeùL’
(
o
)+
	`sd¦’
(
­³nd
->
±r
);

438 ià(
	`checkSŒšgL’gth
(
c
,
tÙËn
è!ğ
REDIS_OK
)

442 
o
 = 
	`dbUnsh¬eSŒšgV®ue
(
c
->
db
,c->
¬gv
[1],o);

443 
o
->
±r
 = 
	`sdsÿ’
(o->±r,
­³nd
->±r,
	`sd¦’
(append->ptr));

444 
tÙËn
 = 
	`sd¦’
(
o
->
±r
);

446 
	`sigÇlModif›dKey
(
c
->
db
,c->
¬gv
[1]);

447 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_STRING
,"­³nd",
c
->
¬gv
[1],c->
db
->
id
);

448 
£rv”
.
dœty
++;

449 
	`addR•lyLÚgLÚg
(
c
,
tÙËn
);

450 
	}
}

452 
	$¡¾’Commªd
(
»disCl›Á
 *
c
) {

453 
robj
 *
o
;

454 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

455 
	`checkTy³
(
c
,
o
,
REDIS_STRING
)) ;

456 
	`addR•lyLÚgLÚg
(
c
,
	`¡ršgObjeùL’
(
o
));

457 
	}
}

	@t_zset.c

52 
	~"»dis.h
"

53 
	~<m©h.h
>

55 
z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

56 
z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
);

58 
zskli¡Node
 *
	$z¦C»©eNode
(
Ëv–
, 
scÜe
, 
robj
 *
obj
) {

59 
zskli¡Node
 *
zn
 = 
	`zm®loc
((*zn)+
Ëv–
*(
zskli¡Lev–
));

60 
zn
->
scÜe
 = score;

61 
zn
->
obj
 = obj;

62  
zn
;

63 
	}
}

65 
zskli¡
 *
	$z¦C»©e
() {

66 
j
;

67 
zskli¡
 *
z¦
;

69 
z¦
 = 
	`zm®loc
((*zsl));

70 
z¦
->
Ëv–
 = 1;

71 
z¦
->
Ëngth
 = 0;

72 
z¦
->
h—d”
 = 
	`z¦C»©eNode
(
ZSKIPLIST_MAXLEVEL
,0,
NULL
);

73 
j
 = 0; j < 
ZSKIPLIST_MAXLEVEL
; j++) {

74 
z¦
->
h—d”
->
Ëv–
[
j
].
fÜw¬d
 = 
NULL
;

75 
z¦
->
h—d”
->
Ëv–
[
j
].
¥ª
 = 0;

77 
z¦
->
h—d”
->
backw¬d
 = 
NULL
;

78 
z¦
->

 = 
NULL
;

79  
z¦
;

80 
	}
}

82 
	$z¦F»eNode
(
zskli¡Node
 *
node
) {

83 
	`deüRefCouÁ
(
node
->
obj
);

84 
	`zä“
(
node
);

85 
	}
}

87 
	$z¦F»e
(
zskli¡
 *
z¦
) {

88 
zskli¡Node
 *
node
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
, *
Ãxt
;

90 
	`zä“
(
z¦
->
h—d”
);

91 
node
) {

92 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

93 
	`z¦F»eNode
(
node
);

94 
node
 = 
Ãxt
;

96 
	`zä“
(
z¦
);

97 
	}
}

103 
	$z¦RªdomLev–
() {

104 
Ëv–
 = 1;

105 (
	`¿ndom
()&0xFFFFè< (
ZSKIPLIST_P
 * 0xFFFF))

106 
Ëv–
 += 1;

107  (
Ëv–
<
ZSKIPLIST_MAXLEVEL
) ?†evel : ZSKIPLIST_MAXLEVEL;

108 
	}
}

110 
zskli¡Node
 *
	$z¦In£¹
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

111 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

112 
¿nk
[
ZSKIPLIST_MAXLEVEL
];

113 
i
, 
Ëv–
;

115 
	`»disAs£¹
(!
	`i¢ª
(
scÜe
));

116 
x
 = 
z¦
->
h—d”
;

117 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

119 
¿nk
[
i
] = i =ğ(
z¦
->
Ëv–
-1) ? 0 :„ank[i+1];

120 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

121 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

122 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

123 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0))) {

124 
¿nk
[
i
] +ğ
x
->
Ëv–
[i].
¥ª
;

125 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

127 
upd©e
[
i
] = 
x
;

133 
Ëv–
 = 
	`z¦RªdomLev–
();

134 ià(
Ëv–
 > 
z¦
->level) {

135 
i
 = 
z¦
->
Ëv–
; i <†evel; i++) {

136 
¿nk
[
i
] = 0;

137 
upd©e
[
i
] = 
z¦
->
h—d”
;

138 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = 
z¦
->
Ëngth
;

140 
z¦
->
Ëv–
 =†evel;

142 
x
 = 
	`z¦C»©eNode
(
Ëv–
,
scÜe
,
obj
);

143 
i
 = 0; i < 
Ëv–
; i++) {

144 
x
->
Ëv–
[
i
].
fÜw¬d
 = 
upd©e
[i]->level[i].forward;

145 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
;

148 
x
->
Ëv–
[
i
].
¥ª
 = 
upd©e
[i]->Ëv–[i].¥ª - (
¿nk
[0] -„ank[i]);

149 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 = (
¿nk
[0] -„ank[i]) + 1;

153 
i
 = 
Ëv–
; i < 
z¦
->level; i++) {

154 
upd©e
[
i
]->
Ëv–
[i].
¥ª
++;

157 
x
->
backw¬d
 = (
upd©e
[0] =ğ
z¦
->
h—d”
è? 
NULL
 : update[0];

158 ià(
x
->
Ëv–
[0].
fÜw¬d
)

159 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x;

161 
z¦
->

 = 
x
;

162 
z¦
->
Ëngth
++;

163  
x
;

164 
	}
}

167 
	$z¦D–‘eNode
(
zskli¡
 *
z¦
, 
zskli¡Node
 *
x
, zskli¡Nod**
upd©e
) {

168 
i
;

169 
i
 = 0; i < 
z¦
->
Ëv–
; i++) {

170 ià(
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 =ğ
x
) {

171 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 +ğ
x
->level[i].span - 1;

172 
upd©e
[
i
]->
Ëv–
[i].
fÜw¬d
 = 
x
->level[i].forward;

174 
upd©e
[
i
]->
Ëv–
[i].
¥ª
 -= 1;

177 ià(
x
->
Ëv–
[0].
fÜw¬d
) {

178 
x
->
Ëv–
[0].
fÜw¬d
->
backw¬d
 = x->backward;

180 
z¦
->

 = 
x
->
backw¬d
;

182 
z¦
->
Ëv–
 > 1 && z¦->
h—d”
->Ëv–[z¦->Ëv–-1].
fÜw¬d
 =ğ
NULL
)

183 
z¦
->
Ëv–
--;

184 
z¦
->
Ëngth
--;

185 
	}
}

188 
	$z¦D–‘e
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
obj
) {

189 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

190 
i
;

192 
x
 = 
z¦
->
h—d”
;

193 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

194 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

195 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

196 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

197 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,obj) < 0)))

198 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

199 
upd©e
[
i
] = 
x
;

203 
x
 = x->
Ëv–
[0].
fÜw¬d
;

204 ià(
x
 && 
scÜe
 =ğx->scÜ&& 
	`equ®SŒšgObjeùs
(x->
obj
,obj)) {

205 
	`z¦D–‘eNode
(
z¦
, 
x
, 
upd©e
);

206 
	`z¦F»eNode
(
x
);

210 
	}
}

212 
	$z¦V®ueG‹Mš
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

213  
¥ec
->
mšex
 ? (
v®ue
 > s³c->
mš
) : (value >= spec->min);

214 
	}
}

216 
	$z¦V®ueL‹Max
(
v®ue
, 
z¿nge¥ec
 *
¥ec
) {

217  
¥ec
->
maxex
 ? (
v®ue
 < s³c->
max
) : (value <= spec->max);

218 
	}
}

221 
	$z¦IsInRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

222 
zskli¡Node
 *
x
;

225 ià(
¿nge
->
mš
 >„ªge->
max
 ||

226 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

228 
x
 = 
z¦
->

;

229 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueG‹Mš
(x->
scÜe
,
¿nge
))

231 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

232 ià(
x
 =ğ
NULL
 || !
	`z¦V®ueL‹Max
(x->
scÜe
,
¿nge
))

235 
	}
}

239 
zskli¡Node
 *
	$z¦Fœ¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

240 
zskli¡Node
 *
x
;

241 
i
;

244 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

246 
x
 = 
z¦
->
h—d”
;

247 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

249 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

250 !
	`z¦V®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

251 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

255 
x
 = x->
Ëv–
[0].
fÜw¬d
;

256 
	`»disAs£¹
(
x
 !ğ
NULL
);

259 ià(!
	`z¦V®ueL‹Max
(
x
->
scÜe
,
¿nge
)è 
NULL
;

260  
x
;

261 
	}
}

265 
zskli¡Node
 *
	$z¦La¡InRªge
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
) {

266 
zskli¡Node
 *
x
;

267 
i
;

270 ià(!
	`z¦IsInRªge
(
z¦
,
¿nge
)è 
NULL
;

272 
x
 = 
z¦
->
h—d”
;

273 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

275 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

276 
	`z¦V®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
,
¿nge
))

277 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

281 
	`»disAs£¹
(
x
 !ğ
NULL
);

284 ià(!
	`z¦V®ueG‹Mš
(
x
->
scÜe
,
¿nge
)è 
NULL
;

285  
x
;

286 
	}
}

292 
	$z¦D–‘eRªgeByScÜe
(
zskli¡
 *
z¦
, 
z¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

293 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

294 
»moved
 = 0;

295 
i
;

297 
x
 = 
z¦
->
h—d”
;

298 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

299 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
¿nge
->
mšex
 ?

300 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 <ğ
¿nge
->
mš
 :

301 
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < 
¿nge
->
mš
))

302 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

303 
upd©e
[
i
] = 
x
;

307 
x
 = x->
Ëv–
[0].
fÜw¬d
;

310 
x
 &&

311 (
¿nge
->
maxex
 ? 
x
->
scÜe
 <„ªge->
max
 : x->score <=„ange->max))

313 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

314 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

315 
	`diùD–‘e
(
diù
,
x
->
obj
);

316 
	`z¦F»eNode
(
x
);

317 
»moved
++;

318 
x
 = 
Ãxt
;

320  
»moved
;

321 
	}
}

323 
	$z¦D–‘eRªgeByLex
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
, 
diù
 *dict) {

324 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

325 
»moved
 = 0;

326 
i
;

329 
x
 = 
z¦
->
h—d”
;

330 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

331 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

332 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

333 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

334 
upd©e
[
i
] = 
x
;

338 
x
 = x->
Ëv–
[0].
fÜw¬d
;

341 
x
 && 
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
)) {

342 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

343 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

344 
	`diùD–‘e
(
diù
,
x
->
obj
);

345 
	`z¦F»eNode
(
x
);

346 
»moved
++;

347 
x
 = 
Ãxt
;

349  
»moved
;

350 
	}
}

354 
	$z¦D–‘eRªgeByRªk
(
zskli¡
 *
z¦
, 
¡¬t
, 
’d
, 
diù
 *dict) {

355 
zskli¡Node
 *
upd©e
[
ZSKIPLIST_MAXLEVEL
], *
x
;

356 
Œav”£d
 = 0, 
»moved
 = 0;

357 
i
;

359 
x
 = 
z¦
->
h—d”
;

360 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

361 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è< 
¡¬t
) {

362 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

363 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

365 
upd©e
[
i
] = 
x
;

368 
Œav”£d
++;

369 
x
 = x->
Ëv–
[0].
fÜw¬d
;

370 
x
 && 
Œav”£d
 <ğ
’d
) {

371 
zskli¡Node
 *
Ãxt
 = 
x
->
Ëv–
[0].
fÜw¬d
;

372 
	`z¦D–‘eNode
(
z¦
,
x
,
upd©e
);

373 
	`diùD–‘e
(
diù
,
x
->
obj
);

374 
	`z¦F»eNode
(
x
);

375 
»moved
++;

376 
Œav”£d
++;

377 
x
 = 
Ãxt
;

379  
»moved
;

380 
	}
}

386 
	$z¦G‘Rªk
(
zskli¡
 *
z¦
, 
scÜe
, 
robj
 *
o
) {

387 
zskli¡Node
 *
x
;

388 
¿nk
 = 0;

389 
i
;

391 
x
 = 
z¦
->
h—d”
;

392 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

393 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

394 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 < score ||

395 (
x
->
Ëv–
[
i
].
fÜw¬d
->
scÜe
 == score &&

396 
	`com·»SŒšgObjeùs
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
o
) <= 0))) {

397 
¿nk
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

398 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

402 ià(
x
->
obj
 && 
	`equ®SŒšgObjeùs
(x->obj,
o
)) {

403  
¿nk
;

407 
	}
}

410 
zskli¡Node
* 
	$z¦G‘EËm’tByRªk
(
zskli¡
 *
z¦
, 
¿nk
) {

411 
zskli¡Node
 *
x
;

412 
Œav”£d
 = 0;

413 
i
;

415 
x
 = 
z¦
->
h—d”
;

416 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

417 
x
->
Ëv–
[
i
].
fÜw¬d
 && (
Œav”£d
 + x->Ëv–[i].
¥ª
è<ğ
¿nk
)

419 
Œav”£d
 +ğ
x
->
Ëv–
[
i
].
¥ª
;

420 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

422 ià(
Œav”£d
 =ğ
¿nk
) {

423  
x
;

426  
NULL
;

427 
	}
}

430 
	$z¦P¬£Rªge
(
robj
 *
mš
,„obj *
max
, 
z¿nge¥ec
 *
¥ec
) {

431 *
•Œ
;

432 
¥ec
->
mšex
 = s³c->
maxex
 = 0;

438 ià(
mš
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

439 
¥ec
->
mš
 = ()mš->
±r
;

441 ià(((*)
mš
->
±r
)[0] == '(') {

442 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
+1,&
•Œ
);

443 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
REDIS_ERR
;

444 
¥ec
->
mšex
 = 1;

446 
¥ec
->
mš
 = 
	`¡¹od
((*)mš->
±r
,&
•Œ
);

447 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
mš
)è 
REDIS_ERR
;

450 ià(
max
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

451 
¥ec
->
max
 = ()max->
±r
;

453 ià(((*)
max
->
±r
)[0] == '(') {

454 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
+1,&
•Œ
);

455 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
REDIS_ERR
;

456 
¥ec
->
maxex
 = 1;

458 
¥ec
->
max
 = 
	`¡¹od
((*)max->
±r
,&
•Œ
);

459 ià(
•Œ
[0] !ğ'\0' || 
	`i¢ª
(
¥ec
->
max
)è 
REDIS_ERR
;

463  
REDIS_OK
;

464 
	}
}

481 
	$z¦P¬£LexRªgeI‹m
(
robj
 *
™em
,„obj **
de¡
, *
ex
) {

482 *
c
 = 
™em
->
±r
;

484 
c
[0]) {

486 ià(
c
[1] !ğ'\0'è 
REDIS_ERR
;

487 *
ex
 = 0;

488 *
de¡
 = 
sh¬ed
.
max¡ršg
;

489 
	`šüRefCouÁ
(
sh¬ed
.
max¡ršg
);

490  
REDIS_OK
;

492 ià(
c
[1] !ğ'\0'è 
REDIS_ERR
;

493 *
ex
 = 0;

494 *
de¡
 = 
sh¬ed
.
mš¡ršg
;

495 
	`šüRefCouÁ
(
sh¬ed
.
mš¡ršg
);

496  
REDIS_OK
;

498 *
ex
 = 1;

499 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

500  
REDIS_OK
;

502 *
ex
 = 0;

503 *
de¡
 = 
	`ü—‹SŒšgObjeù
(
c
+1,
	`sd¦’
(c)-1);

504  
REDIS_OK
;

506  
REDIS_ERR
;

508 
	}
}

515 
	$z¦P¬£LexRªge
(
robj
 *
mš
,„obj *
max
, 
zËx¿nge¥ec
 *
¥ec
) {

518 ià(
mš
->
’codšg
 =ğ
REDIS_ENCODING_INT
 ||

519 
max
->
’codšg
 =ğ
REDIS_ENCODING_INT
è 
REDIS_ERR
;

521 
¥ec
->
mš
 = s³c->
max
 = 
NULL
;

522 ià(
	`z¦P¬£LexRªgeI‹m
(
mš
, &
¥ec
->mš, &¥ec->
mšex
è=ğ
REDIS_ERR
 ||

523 
	`z¦P¬£LexRªgeI‹m
(
max
, &
¥ec
->max, &¥ec->
maxex
è=ğ
REDIS_ERR
) {

524 ià(
¥ec
->
mš
è
	`deüRefCouÁ
(spec->min);

525 ià(
¥ec
->
max
è
	`deüRefCouÁ
(spec->max);

526  
REDIS_ERR
;

528  
REDIS_OK
;

530 
	}
}

534 
	$z¦F»eLexRªge
(
zËx¿nge¥ec
 *
¥ec
) {

535 
	`deüRefCouÁ
(
¥ec
->
mš
);

536 
	`deüRefCouÁ
(
¥ec
->
max
);

537 
	}
}

542 
	$com·»SŒšgObjeùsFÜLexRªge
(
robj
 *
a
,„obj *
b
) {

543 ià(
a
 =ğ
b
)  0;

545 ià(
a
 =ğ
sh¬ed
.
mš¡ršg
 || 
b
 =ğsh¬ed.
max¡ršg
)  -1;

546 ià(
a
 =ğ
sh¬ed
.
max¡ršg
 || 
b
 =ğsh¬ed.
mš¡ršg
)  1;

547  
	`com·»SŒšgObjeùs
(
a
,
b
);

548 
	}
}

550 
	$z¦LexV®ueG‹Mš
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

551  
¥ec
->
mšex
 ?

552 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) > 0) :

553 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
mš
) >= 0);

554 
	}
}

556 
	$z¦LexV®ueL‹Max
(
robj
 *
v®ue
, 
zËx¿nge¥ec
 *
¥ec
) {

557  
¥ec
->
maxex
 ?

558 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) < 0) :

559 (
	`com·»SŒšgObjeùsFÜLexRªge
(
v®ue
,
¥ec
->
max
) <= 0);

560 
	}
}

563 
	$z¦IsInLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

564 
zskli¡Node
 *
x
;

567 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

568 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

569 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

571 
x
 = 
z¦
->

;

572 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueG‹Mš
(x->
obj
,
¿nge
))

574 
x
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

575 ià(
x
 =ğ
NULL
 || !
	`z¦LexV®ueL‹Max
(x->
obj
,
¿nge
))

578 
	}
}

582 
zskli¡Node
 *
	$z¦Fœ¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

583 
zskli¡Node
 *
x
;

584 
i
;

587 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

589 
x
 = 
z¦
->
h—d”
;

590 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

592 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

593 !
	`z¦LexV®ueG‹Mš
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

594 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

598 
x
 = x->
Ëv–
[0].
fÜw¬d
;

599 
	`»disAs£¹
(
x
 !ğ
NULL
);

602 ià(!
	`z¦LexV®ueL‹Max
(
x
->
obj
,
¿nge
)è 
NULL
;

603  
x
;

604 
	}
}

608 
zskli¡Node
 *
	$z¦La¡InLexRªge
(
zskli¡
 *
z¦
, 
zËx¿nge¥ec
 *
¿nge
) {

609 
zskli¡Node
 *
x
;

610 
i
;

613 ià(!
	`z¦IsInLexRªge
(
z¦
,
¿nge
)è 
NULL
;

615 
x
 = 
z¦
->
h—d”
;

616 
i
 = 
z¦
->
Ëv–
-1; i >= 0; i--) {

618 
x
->
Ëv–
[
i
].
fÜw¬d
 &&

619 
	`z¦LexV®ueL‹Max
(
x
->
Ëv–
[
i
].
fÜw¬d
->
obj
,
¿nge
))

620 
x
 = x->
Ëv–
[
i
].
fÜw¬d
;

624 
	`»disAs£¹
(
x
 !ğ
NULL
);

627 ià(!
	`z¦LexV®ueG‹Mš
(
x
->
obj
,
¿nge
)è 
NULL
;

628  
x
;

629 
	}
}

635 
	$zzlG‘ScÜe
(*
¥Œ
) {

636 *
v¡r
;

637 
vËn
;

638 
vlÚg
;

639 
buf
[128];

640 
scÜe
;

642 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

643 
	`»disAs£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

645 ià(
v¡r
) {

646 
	`memıy
(
buf
,
v¡r
,
vËn
);

647 
buf
[
vËn
] = '\0';

648 
scÜe
 = 
	`¡¹od
(
buf
,
NULL
);

650 
scÜe
 = 
vlÚg
;

653  
scÜe
;

654 
	}
}

659 
robj
 *
	$zli¡G‘Objeù
(*
¥Œ
) {

660 *
v¡r
;

661 
vËn
;

662 
vlÚg
;

664 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

665 
	`»disAs£¹
(
	`zli¡G‘
(
¥Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

667 ià(
v¡r
) {

668  
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

670  
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

672 
	}
}

675 
	$zzlCom·»EËm’ts
(*
•Œ
, *
c¡r
, 
ş’
) {

676 *
v¡r
;

677 
vËn
;

678 
vlÚg
;

679 
vbuf
[32];

680 
mšËn
, 
cmp
;

682 
	`»disAs£¹
(
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

683 ià(
v¡r
 =ğ
NULL
) {

685 
vËn
 = 
	`Î2¡ršg
((*)
vbuf
,(vbuf),
vlÚg
);

686 
v¡r
 = 
vbuf
;

689 
mšËn
 = (
vËn
 < 
ş’
) ? vlen : clen;

690 
cmp
 = 
	`memcmp
(
v¡r
,
c¡r
,
mšËn
);

691 ià(
cmp
 =ğ0è 
vËn
-
ş’
;

692  
cmp
;

693 
	}
}

695 
	$zzlL’gth
(*
zl
) {

696  
	`zli¡L’
(
zl
)/2;

697 
	}
}

701 
	$zzlNext
(*
zl
, **
•Œ
, **
¥Œ
) {

702 *
_•Œ
, *
_¥Œ
;

703 
	`»disAs£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

705 
_•Œ
 = 
	`zli¡Next
(
zl
,*
¥Œ
);

706 ià(
_•Œ
 !ğ
NULL
) {

707 
_¥Œ
 = 
	`zli¡Next
(
zl
,
_•Œ
);

708 
	`»disAs£¹
(
_¥Œ
 !ğ
NULL
);

711 
_¥Œ
 = 
NULL
;

714 *
•Œ
 = 
_•Œ
;

715 *
¥Œ
 = 
_¥Œ
;

716 
	}
}

720 
	$zzlP»v
(*
zl
, **
•Œ
, **
¥Œ
) {

721 *
_•Œ
, *
_¥Œ
;

722 
	`»disAs£¹
(*
•Œ
 !ğ
NULL
 && *
¥Œ
 != NULL);

724 
_¥Œ
 = 
	`zli¡P»v
(
zl
,*
•Œ
);

725 ià(
_¥Œ
 !ğ
NULL
) {

726 
_•Œ
 = 
	`zli¡P»v
(
zl
,
_¥Œ
);

727 
	`»disAs£¹
(
_•Œ
 !ğ
NULL
);

730 
_•Œ
 = 
NULL
;

733 *
•Œ
 = 
_•Œ
;

734 *
¥Œ
 = 
_¥Œ
;

735 
	}
}

739 
	$zzlIsInRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

740 *
p
;

741 
scÜe
;

744 ià(
¿nge
->
mš
 >„ªge->
max
 ||

745 (
¿nge
->
mš
 =ğ¿nge->
max
 && (¿nge->
mšex
 ||„ªge->
maxex
)))

748 
p
 = 
	`zli¡Index
(
zl
,-1);

749 ià(
p
 =ğ
NULL
)  0;

750 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

751 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

754 
p
 = 
	`zli¡Index
(
zl
,1);

755 
	`»disAs£¹
(
p
 !ğ
NULL
);

756 
scÜe
 = 
	`zzlG‘ScÜe
(
p
);

757 ià(!
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

761 
	}
}

765 *
	$zzlFœ¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

766 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

767 
scÜe
;

770 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

772 
•Œ
 !ğ
NULL
) {

773 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

774 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

776 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

777 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
)) {

779 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
))

780  
•Œ
;

781  
NULL
;

785 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

788  
NULL
;

789 
	}
}

793 *
	$zzlLa¡InRªge
(*
zl
, 
z¿nge¥ec
 *
¿nge
) {

794 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

795 
scÜe
;

798 ià(!
	`zzlIsInRªge
(
zl
,
¿nge
)è 
NULL
;

800 
•Œ
 !ğ
NULL
) {

801 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

802 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

804 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

805 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

807 ià(
	`z¦V®ueG‹Mš
(
scÜe
,
¿nge
))

808  
•Œ
;

809  
NULL
;

814 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

815 ià(
¥Œ
 !ğ
NULL
)

816 
	`»disAs£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

818 
•Œ
 = 
NULL
;

821  
NULL
;

822 
	}
}

824 
	$zzlLexV®ueG‹Mš
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

825 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

826 
»s
 = 
	`z¦LexV®ueG‹Mš
(
v®ue
,
¥ec
);

827 
	`deüRefCouÁ
(
v®ue
);

828  
»s
;

829 
	}
}

831 
	$zzlLexV®ueL‹Max
(*
p
, 
zËx¿nge¥ec
 *
¥ec
) {

832 
robj
 *
v®ue
 = 
	`zli¡G‘Objeù
(
p
);

833 
»s
 = 
	`z¦LexV®ueL‹Max
(
v®ue
,
¥ec
);

834 
	`deüRefCouÁ
(
v®ue
);

835  
»s
;

836 
	}
}

840 
	$zzlIsInLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

841 *
p
;

844 ià(
	`com·»SŒšgObjeùsFÜLexRªge
(
¿nge
->
mš
,¿nge->
max
) > 1 ||

845 (
	`com·»SŒšgObjeùs
(
¿nge
->
mš
,¿nge->
max
) == 0 &&

846 (
¿nge
->
mšex
 ||„ªge->
maxex
)))

849 
p
 = 
	`zli¡Index
(
zl
,-2);

850 ià(
p
 =ğ
NULL
)  0;

851 ià(!
	`zzlLexV®ueG‹Mš
(
p
,
¿nge
))

854 
p
 = 
	`zli¡Index
(
zl
,0);

855 
	`»disAs£¹
(
p
 !ğ
NULL
);

856 ià(!
	`zzlLexV®ueL‹Max
(
p
,
¿nge
))

860 
	}
}

864 *
	$zzlFœ¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

865 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

868 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

870 
•Œ
 !ğ
NULL
) {

871 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
)) {

873 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
))

874  
•Œ
;

875  
NULL
;

879 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

880 
	`»disAs£¹
(
¥Œ
 !ğ
NULL
);

881 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

884  
NULL
;

885 
	}
}

889 *
	$zzlLa¡InLexRªge
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
) {

890 *
•Œ
 = 
	`zli¡Index
(
zl
,-2), *
¥Œ
;

893 ià(!
	`zzlIsInLexRªge
(
zl
,
¿nge
)è 
NULL
;

895 
•Œ
 !ğ
NULL
) {

896 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

898 ià(
	`zzlLexV®ueG‹Mš
(
•Œ
,
¿nge
))

899  
•Œ
;

900  
NULL
;

905 
¥Œ
 = 
	`zli¡P»v
(
zl
,
•Œ
);

906 ià(
¥Œ
 !ğ
NULL
)

907 
	`»disAs£¹
((
•Œ
 = 
	`zli¡P»v
(
zl
,
¥Œ
)è!ğ
NULL
);

909 
•Œ
 = 
NULL
;

912  
NULL
;

913 
	}
}

915 *
	$zzlFšd
(*
zl
, 
robj
 *
–e
, *
scÜe
) {

916 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

918 
–e
 = 
	`g‘DecodedObjeù
(ele);

919 
•Œ
 !ğ
NULL
) {

920 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

921 
	`»disAs£¹W™hInfo
(
NULL
,
–e
,
¥Œ
 != NULL);

923 ià(
	`zli¡Com·»
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr))) {

925 ià(
scÜe
 !ğ
NULL
è*scÜğ
	`zzlG‘ScÜe
(
¥Œ
);

926 
	`deüRefCouÁ
(
–e
);

927  
•Œ
;

931 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

934 
	`deüRefCouÁ
(
–e
);

935  
NULL
;

936 
	}
}

940 *
	$zzlD–‘e
(*
zl
, *
•Œ
) {

941 *
p
 = 
•Œ
;

944 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

945 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

946  
zl
;

947 
	}
}

949 *
	$zzlIn£¹At
(*
zl
, *
•Œ
, 
robj
 *
–e
, 
scÜe
) {

950 *
¥Œ
;

951 
scÜebuf
[128];

952 
scÜ–’
;

953 
size_t
 
off£t
;

955 
	`»disAs£¹W™hInfo
(
NULL
,
–e
,
	`sdsEncodedObjeù
(ele));

956 
scÜ–’
 = 
	`d2¡ršg
(
scÜebuf
,(scÜebuf),
scÜe
);

957 ià(
•Œ
 =ğ
NULL
) {

958 
zl
 = 
	`zli¡Push
(zl,
–e
->
±r
,
	`sd¦’
ÓË->±r),
ZIPLIST_TAIL
);

959 
zl
 = 
	`zli¡Push
(zl,(*)
scÜebuf
,
scÜ–’
,
ZIPLIST_TAIL
);

962 
off£t
 = 
•Œ
-
zl
;

963 
zl
 = 
	`zli¡In£¹
(zl,
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr));

964 
•Œ
 = 
zl
+
off£t
;

967 
	`»disAs£¹W™hInfo
(
NULL
,
–e
,(
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)) != NULL);

968 
zl
 = 
	`zli¡In£¹
(zl,
¥Œ
,(*)
scÜebuf
,
scÜ–’
);

971  
zl
;

972 
	}
}

976 *
	$zzlIn£¹
(*
zl
, 
robj
 *
–e
, 
scÜe
) {

977 *
•Œ
 = 
	`zli¡Index
(
zl
,0), *
¥Œ
;

978 
s
;

980 
–e
 = 
	`g‘DecodedObjeù
(ele);

981 
•Œ
 !ğ
NULL
) {

982 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

983 
	`»disAs£¹W™hInfo
(
NULL
,
–e
,
¥Œ
 != NULL);

984 
s
 = 
	`zzlG‘ScÜe
(
¥Œ
);

986 ià(
s
 > 
scÜe
) {

990 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

992 } ià(
s
 =ğ
scÜe
) {

994 ià(
	`zzlCom·»EËm’ts
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr)) > 0) {

995 
zl
 = 
	`zzlIn£¹At
(zl,
•Œ
,
–e
,
scÜe
);

1001 
•Œ
 = 
	`zli¡Next
(
zl
,
¥Œ
);

1005 ià(
•Œ
 =ğ
NULL
)

1006 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
scÜe
);

1008 
	`deüRefCouÁ
(
–e
);

1009  
zl
;

1010 
	}
}

1012 *
	$zzlD–‘eRªgeByScÜe
(*
zl
, 
z¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1013 *
•Œ
, *
¥Œ
;

1014 
scÜe
;

1015 
num
 = 0;

1017 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1019 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,
¿nge
);

1020 ià(
•Œ
 =ğ
NULL
è 
zl
;

1024 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1025 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1026 ià(
	`z¦V®ueL‹Max
(
scÜe
,
¿nge
)) {

1028 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1029 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1030 
num
++;

1037 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1038  
zl
;

1039 
	}
}

1041 *
	$zzlD–‘eRªgeByLex
(*
zl
, 
zËx¿nge¥ec
 *
¿nge
, *
d–‘ed
) {

1042 *
•Œ
, *
¥Œ
;

1043 
num
 = 0;

1045 ià(
d–‘ed
 !ğ
NULL
) *deleted = 0;

1047 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,
¿nge
);

1048 ià(
•Œ
 =ğ
NULL
è 
zl
;

1052 (
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
)è!ğ
NULL
) {

1053 ià(
	`zzlLexV®ueL‹Max
(
•Œ
,
¿nge
)) {

1055 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1056 
zl
 = 
	`zli¡D–‘e
(zl,&
•Œ
);

1057 
num
++;

1064 ià(
d–‘ed
 !ğ
NULL
è*d–‘ed = 
num
;

1065  
zl
;

1066 
	}
}

1070 *
	$zzlD–‘eRªgeByRªk
(*
zl
, 
¡¬t
, 
’d
, *
d–‘ed
) {

1071 
num
 = (
’d
-
¡¬t
)+1;

1072 ià(
d–‘ed
è*d–‘ed = 
num
;

1073 
zl
 = 
	`zli¡D–‘eRªge
(zl,2*(
¡¬t
-1),2*
num
);

1074  
zl
;

1075 
	}
}

1081 
	$z£tL’gth
(
robj
 *
zobj
) {

1082 
Ëngth
 = -1;

1083 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1084 
Ëngth
 = 
	`zzlL’gth
(
zobj
->
±r
);

1085 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1086 
Ëngth
 = ((
z£t
*)
zobj
->
±r
)->
z¦
->length;

1088 
	`»disPªic
("Unknown sorted setƒncoding");

1090  
Ëngth
;

1091 
	}
}

1093 
	$z£tCÚv”t
(
robj
 *
zobj
, 
’codšg
) {

1094 
z£t
 *
zs
;

1095 
zskli¡Node
 *
node
, *
Ãxt
;

1096 
robj
 *
–e
;

1097 
scÜe
;

1099 ià(
zobj
->
’codšg
 ==ƒncoding) ;

1100 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1101 *
zl
 = 
zobj
->
±r
;

1102 *
•Œ
, *
¥Œ
;

1103 *
v¡r
;

1104 
vËn
;

1105 
vlÚg
;

1107 ià(
’codšg
 !ğ
REDIS_ENCODING_SKIPLIST
)

1108 
	`»disPªic
("Unknownargetƒncoding");

1110 
zs
 = 
	`zm®loc
((*zs));

1111 
zs
->
diù
 = 
	`diùC»©e
(&
z£tDiùTy³
,
NULL
);

1112 
zs
->
z¦
 = 
	`z¦C»©e
();

1114 
•Œ
 = 
	`zli¡Index
(
zl
,0);

1115 
	`»disAs£¹W™hInfo
(
NULL
,
zobj
,
•Œ
 != NULL);

1116 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

1117 
	`»disAs£¹W™hInfo
(
NULL
,
zobj
,
¥Œ
 != NULL);

1119 
•Œ
 !ğ
NULL
) {

1120 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

1121 
	`»disAs£¹W™hInfo
(
NULL
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

1122 ià(
v¡r
 =ğ
NULL
)

1123 
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(
vlÚg
);

1125 
–e
 = 
	`ü—‹SŒšgObjeù
((*)
v¡r
,
vËn
);

1128 
node
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1129 
	`»disAs£¹W™hInfo
(
NULL
,
zobj
,
	`diùAdd
(
zs
->
diù
,
–e
,&
node
->
scÜe
è=ğ
DICT_OK
);

1130 
	`šüRefCouÁ
(
–e
);

1131 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

1134 
	`zä“
(
zobj
->
±r
);

1135 
zobj
->
±r
 = 
zs
;

1136 
zobj
->
’codšg
 = 
REDIS_ENCODING_SKIPLIST
;

1137 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1138 *
zl
 = 
	`zli¡New
();

1140 ià(
’codšg
 !ğ
REDIS_ENCODING_ZIPLIST
)

1141 
	`»disPªic
("Unknownargetƒncoding");

1145 
zs
 = 
zobj
->
±r
;

1146 
	`diùR–—£
(
zs
->
diù
);

1147 
node
 = 
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1148 
	`zä“
(
zs
->
z¦
->
h—d”
);

1149 
	`zä“
(
zs
->
z¦
);

1151 
node
) {

1152 
–e
 = 
	`g‘DecodedObjeù
(
node
->
obj
);

1153 
zl
 = 
	`zzlIn£¹At
(zl,
NULL
,
–e
,
node
->
scÜe
);

1154 
	`deüRefCouÁ
(
–e
);

1156 
Ãxt
 = 
node
->
Ëv–
[0].
fÜw¬d
;

1157 
	`z¦F»eNode
(
node
);

1158 
node
 = 
Ãxt
;

1161 
	`zä“
(
zs
);

1162 
zobj
->
±r
 = 
zl
;

1163 
zobj
->
’codšg
 = 
REDIS_ENCODING_ZIPLIST
;

1165 
	`»disPªic
("Unknown sorted setƒncoding");

1167 
	}
}

1174 
	$zaddG’”icCommªd
(
»disCl›Á
 *
c
, 
šü
) {

1175 *
ÇÃ¼
 = "resulting score is‚ot‡‚umber (NaN)";

1176 
robj
 *
key
 = 
c
->
¬gv
[1];

1177 
robj
 *
–e
;

1178 
robj
 *
zobj
;

1179 
robj
 *
curobj
;

1180 
scÜe
 = 0, *
scÜes
 = 
NULL
, 
curscÜe
 = 0.0;

1181 
j
, 
–em’ts
 = (
c
->
¬gc
-2)/2;

1182 
added
 = 0, 
upd©ed
 = 0;

1184 ià(
c
->
¬gc
 % 2) {

1185 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1192 
scÜes
 = 
	`zm®loc
(()*
–em’ts
);

1193 
j
 = 0; j < 
–em’ts
; j++) {

1194 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[2+
j
*2],&
scÜes
[j],
NULL
)

1195 !ğ
REDIS_OK
è
ş—nup
;

1199 
zobj
 = 
	`lookupKeyWr™e
(
c
->
db
,
key
);

1200 ià(
zobj
 =ğ
NULL
) {

1201 ià(
£rv”
.
z£t_max_zli¡_’Œ›s
 == 0 ||

1202 
£rv”
.
z£t_max_zli¡_v®ue
 < 
	`sd¦’
(
c
->
¬gv
[3]->
±r
))

1204 
zobj
 = 
	`ü—‹Z£tObjeù
();

1206 
zobj
 = 
	`ü—‹Z£tZli¡Objeù
();

1208 
	`dbAdd
(
c
->
db
,
key
,
zobj
);

1210 ià(
zobj
->
ty³
 !ğ
REDIS_ZSET
) {

1211 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1212 
ş—nup
;

1216 
j
 = 0; j < 
–em’ts
; j++) {

1217 
scÜe
 = 
scÜes
[
j
];

1219 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1220 *
•Œ
;

1223 
–e
 = 
c
->
¬gv
[3+
j
*2];

1224 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
–e
,&
curscÜe
)è!ğ
NULL
) {

1225 ià(
šü
) {

1226 
scÜe
 +ğ
curscÜe
;

1227 ià(
	`i¢ª
(
scÜe
)) {

1228 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1229 
ş—nup
;

1234 ià(
scÜe
 !ğ
curscÜe
) {

1235 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1236 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1237 
£rv”
.
dœty
++;

1238 
upd©ed
++;

1243 
zobj
->
±r
 = 
	`zzlIn£¹
(zobj->±r,
–e
,
scÜe
);

1244 ià(
	`zzlL’gth
(
zobj
->
±r
è> 
£rv”
.
z£t_max_zli¡_’Œ›s
)

1245 
	`z£tCÚv”t
(
zobj
,
REDIS_ENCODING_SKIPLIST
);

1246 ià(
	`sd¦’
(
–e
->
±r
è> 
£rv”
.
z£t_max_zli¡_v®ue
)

1247 
	`z£tCÚv”t
(
zobj
,
REDIS_ENCODING_SKIPLIST
);

1248 
£rv”
.
dœty
++;

1249 
added
++;

1251 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1252 
z£t
 *
zs
 = 
zobj
->
±r
;

1253 
zskli¡Node
 *
znode
;

1254 
diùEÁry
 *
de
;

1256 
–e
 = 
c
->
¬gv
[3+
j
*2] = 
	`ŒyObjeùEncodšg
(c->argv[3+j*2]);

1257 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

1258 ià(
de
 !ğ
NULL
) {

1259 
curobj
 = 
	`diùG‘Key
(
de
);

1260 
curscÜe
 = *(*)
	`diùG‘V®
(
de
);

1262 ià(
šü
) {

1263 
scÜe
 +ğ
curscÜe
;

1264 ià(
	`i¢ª
(
scÜe
)) {

1265 
	`addR•lyE¼Ü
(
c
,
ÇÃ¼
);

1268 
ş—nup
;

1275 ià(
scÜe
 !ğ
curscÜe
) {

1276 
	`»disAs£¹W™hInfo
(
c
,
curobj
,
	`z¦D–‘e
(
zs
->
z¦
,
curscÜe
,curobj));

1277 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
curobj
);

1278 
	`šüRefCouÁ
(
curobj
);

1279 
	`diùG‘V®
(
de
èğ&
znode
->
scÜe
;

1280 
£rv”
.
dœty
++;

1281 
upd©ed
++;

1284 
znode
 = 
	`z¦In£¹
(
zs
->
z¦
,
scÜe
,
–e
);

1285 
	`šüRefCouÁ
(
–e
);

1286 
	`»disAs£¹W™hInfo
(
c
,
NULL
,
	`diùAdd
(
zs
->
diù
,
–e
,&
znode
->
scÜe
è=ğ
DICT_OK
);

1287 
	`šüRefCouÁ
(
–e
);

1288 
£rv”
.
dœty
++;

1289 
added
++;

1292 
	`»disPªic
("Unknown sorted setƒncoding");

1295 ià(
šü
)

1296 
	`addR•lyDoubË
(
c
,
scÜe
);

1298 
	`addR•lyLÚgLÚg
(
c
,
added
);

1300 
ş—nup
:

1301 
	`zä“
(
scÜes
);

1302 ià(
added
 || 
upd©ed
) {

1303 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1304 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_ZSET
,

1305 
šü
 ? "zšü" : "zadd", 
key
, 
c
->
db
->
id
);

1307 
	}
}

1309 
	$zaddCommªd
(
»disCl›Á
 *
c
) {

1310 
	`zaddG’”icCommªd
(
c
,0);

1311 
	}
}

1313 
	$zšübyCommªd
(
»disCl›Á
 *
c
) {

1314 
	`zaddG’”icCommªd
(
c
,1);

1315 
	}
}

1317 
	$z»mCommªd
(
»disCl›Á
 *
c
) {

1318 
robj
 *
key
 = 
c
->
¬gv
[1];

1319 
robj
 *
zobj
;

1320 
d–‘ed
 = 0, 
key»moved
 = 0, 
j
;

1322 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1323 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

1325 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1326 *
•Œ
;

1328 
j
 = 2; j < 
c
->
¬gc
; j++) {

1329 ià((
•Œ
 = 
	`zzlFšd
(
zobj
->
±r
,
c
->
¬gv
[
j
],
NULL
)) != NULL) {

1330 
d–‘ed
++;

1331 
zobj
->
±r
 = 
	`zzlD–‘e
(zobj->±r,
•Œ
);

1332 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1333 
	`dbD–‘e
(
c
->
db
,
key
);

1334 
key»moved
 = 1;

1339 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1340 
z£t
 *
zs
 = 
zobj
->
±r
;

1341 
diùEÁry
 *
de
;

1342 
scÜe
;

1344 
j
 = 2; j < 
c
->
¬gc
; j++) {

1345 
de
 = 
	`diùFšd
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1346 ià(
de
 !ğ
NULL
) {

1347 
d–‘ed
++;

1350 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1351 
	`»disAs£¹W™hInfo
(
c
,c->
¬gv
[
j
],
	`z¦D–‘e
(
zs
->
z¦
,
scÜe
,c->argv[j]));

1354 
	`diùD–‘e
(
zs
->
diù
,
c
->
¬gv
[
j
]);

1355 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1356 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1357 
	`dbD–‘e
(
c
->
db
,
key
);

1358 
key»moved
 = 1;

1364 
	`»disPªic
("Unknown sorted setƒncoding");

1367 ià(
d–‘ed
) {

1368 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_ZSET
,"z»m",
key
,
c
->
db
->
id
);

1369 ià(
key»moved
)

1370 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1371 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1372 
£rv”
.
dœty
 +ğ
d–‘ed
;

1374 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1375 
	}
}

1378 
	#ZRANGE_RANK
 0

	)

1379 
	#ZRANGE_SCORE
 1

	)

1380 
	#ZRANGE_LEX
 2

	)

1381 
	$z»m¿ngeG’”icCommªd
(
»disCl›Á
 *
c
, 
¿ng‘y³
) {

1382 
robj
 *
key
 = 
c
->
¬gv
[1];

1383 
robj
 *
zobj
;

1384 
key»moved
 = 0;

1385 
d–‘ed
;

1386 
z¿nge¥ec
 
¿nge
;

1387 
zËx¿nge¥ec
 
Ëx¿nge
;

1388 
¡¬t
, 
’d
, 
Î’
;

1391 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1392 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[2],&
¡¬t
,
NULL
è!ğ
REDIS_OK
) ||

1393 (
	`g‘LÚgFromObjeùOrR•ly
(
c
,c->
¬gv
[3],&
’d
,
NULL
è!ğ
REDIS_OK
))

1395 } ià(
¿ng‘y³
 =ğ
ZRANGE_SCORE
) {

1396 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
REDIS_OK
) {

1397 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

1400 } ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
) {

1401 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
Ëx¿nge
è!ğ
REDIS_OK
) {

1402 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

1408 ià((
zobj
 = 
	`lookupKeyWr™eOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

1409 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)è
ş—nup
;

1411 ià(
¿ng‘y³
 =ğ
ZRANGE_RANK
) {

1413 
Î’
 = 
	`z£tL’gth
(
zobj
);

1414 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

1415 ià(
’d
 < 0è’d = 
Î’
+end;

1416 ià(
¡¬t
 < 0) start = 0;

1420 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

1421 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

1422 
ş—nup
;

1424 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

1428 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1429 
¿ng‘y³
) {

1430 
ZRANGE_RANK
:

1431 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByRªk
(zobj->±r,
¡¬t
+1,
’d
+1,&
d–‘ed
);

1433 
ZRANGE_SCORE
:

1434 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByScÜe
(zobj->±r,&
¿nge
,&
d–‘ed
);

1436 
ZRANGE_LEX
:

1437 
zobj
->
±r
 = 
	`zzlD–‘eRªgeByLex
(zobj->±r,&
Ëx¿nge
,&
d–‘ed
);

1440 ià(
	`zzlL’gth
(
zobj
->
±r
) == 0) {

1441 
	`dbD–‘e
(
c
->
db
,
key
);

1442 
key»moved
 = 1;

1444 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1445 
z£t
 *
zs
 = 
zobj
->
±r
;

1446 
¿ng‘y³
) {

1447 
ZRANGE_RANK
:

1448 
d–‘ed
 = 
	`z¦D–‘eRªgeByRªk
(
zs
->
z¦
,
¡¬t
+1,
’d
+1,zs->
diù
);

1450 
ZRANGE_SCORE
:

1451 
d–‘ed
 = 
	`z¦D–‘eRªgeByScÜe
(
zs
->
z¦
,&
¿nge
,zs->
diù
);

1453 
ZRANGE_LEX
:

1454 
d–‘ed
 = 
	`z¦D–‘eRªgeByLex
(
zs
->
z¦
,&
Ëx¿nge
,zs->
diù
);

1457 ià(
	`htN“dsResize
(
zs
->
diù
)è
	`diùResize
(zs->dict);

1458 ià(
	`diùSize
(
zs
->
diù
) == 0) {

1459 
	`dbD–‘e
(
c
->
db
,
key
);

1460 
key»moved
 = 1;

1463 
	`»disPªic
("Unknown sorted setƒncoding");

1467 ià(
d–‘ed
) {

1468 *
ev’t
[3] = {"zremrangebyrank","zremrangebyscore","zremrangebylex"};

1469 
	`sigÇlModif›dKey
(
c
->
db
,
key
);

1470 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_ZSET
,
ev’t
[
¿ng‘y³
],
key
,
c
->
db
->
id
);

1471 ià(
key»moved
)

1472 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
key
,
c
->
db
->
id
);

1474 
£rv”
.
dœty
 +ğ
d–‘ed
;

1475 
	`addR•lyLÚgLÚg
(
c
,
d–‘ed
);

1477 
ş—nup
:

1478 ià(
¿ng‘y³
 =ğ
ZRANGE_LEX
è
	`z¦F»eLexRªge
(&
Ëx¿nge
);

1479 
	}
}

1481 
	$z»m¿ngeby¿nkCommªd
(
»disCl›Á
 *
c
) {

1482 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_RANK
);

1483 
	}
}

1485 
	$z»m¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
) {

1486 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_SCORE
);

1487 
	}
}

1489 
	$z»m¿ngebyËxCommªd
(
»disCl›Á
 *
c
) {

1490 
	`z»m¿ngeG’”icCommªd
(
c
,
ZRANGE_LEX
);

1491 
	}
}

1494 
robj
 *
	msubjeù
;

1495 
	mty³
;

1496 
	m’codšg
;

1497 
	mweight
;

1501 
	u_™”£t
 {

1503 
št£t
 *
	mis
;

1504 
	mii
;

1505 } 
	mis
;

1507 
diù
 *
	mdiù
;

1508 
diùI‹¿tÜ
 *
	mdi
;

1509 
diùEÁry
 *
	mde
;

1510 } 
	mht
;

1511 } 
	m£t
;

1514 
	u_™”z£t
 {

1516 *
	mzl
;

1517 *
	m•Œ
, *
	m¥Œ
;

1518 } 
	mzl
;

1520 
z£t
 *
	mzs
;

1521 
zskli¡Node
 *
	mnode
;

1522 } 
	m¦
;

1523 } 
	mz£t
;

1524 } 
	m™”
;

1525 } 
	tz£tİ¤c
;

1534 
	#OPVAL_DIRTY_ROBJ
 1

	)

1535 
	#OPVAL_DIRTY_LL
 2

	)

1536 
	#OPVAL_VALID_LL
 4

	)

1540 
	mæags
;

1541 
	m_buf
[32];

1542 
robj
 *
	m–e
;

1543 *
	me¡r
;

1544 
	m–’
;

1545 
	m–l
;

1546 
	mscÜe
;

1547 } 
	tz£tİv®
;

1549 
_™”£t
 
	t™”£t
;

1550 
_™”z£t
 
	t™”z£t
;

1552 
	$zuiIn™I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1553 ià(
İ
->
subjeù
 =ğ
NULL
)

1556 ià(
İ
->
ty³
 =ğ
REDIS_SET
) {

1557 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1558 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

1559 
™
->
is
.i ğ
İ
->
subjeù
->
±r
;

1560 
™
->
is
.
ii
 = 0;

1561 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

1562 
™
->
ht
.
diù
 = 
İ
->
subjeù
->
±r
;

1563 
™
->
ht
.
di
 = 
	`diùG‘I‹¿tÜ
(
İ
->
subjeù
->
±r
);

1564 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1566 
	`»disPªic
("Unknown setƒncoding");

1568 } ià(
İ
->
ty³
 =ğ
REDIS_ZSET
) {

1569 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1570 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1571 
™
->
zl
.zÈğ
İ
->
subjeù
->
±r
;

1572 
™
->
zl
.
•Œ
 = 
	`zli¡Index
(it->zl.zl,0);

1573 ià(
™
->
zl
.
•Œ
 !ğ
NULL
) {

1574 
™
->
zl
.
¥Œ
 = 
	`zli¡Next
(™->zl.zl,™->zl.
•Œ
);

1575 
	`»disAs£¹
(
™
->
zl
.
¥Œ
 !ğ
NULL
);

1577 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1578 
™
->
¦
.
zs
 = 
İ
->
subjeù
->
±r
;

1579 
™
->
¦
.
node
 = it->¦.
zs
->
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

1581 
	`»disPªic
("Unknown sorted setƒncoding");

1584 
	`»disPªic
("Unsupportedype");

1586 
	}
}

1588 
	$zuiCË¬I‹¿tÜ
(
z£tİ¤c
 *
İ
) {

1589 ià(
İ
->
subjeù
 =ğ
NULL
)

1592 ià(
İ
->
ty³
 =ğ
REDIS_SET
) {

1593 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1594 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

1595 
	`REDIS_NOTUSED
(
™
);

1596 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

1597 
	`diùR–—£I‹¿tÜ
(
™
->
ht
.
di
);

1599 
	`»disPªic
("Unknown setƒncoding");

1601 } ià(
İ
->
ty³
 =ğ
REDIS_ZSET
) {

1602 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1603 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1604 
	`REDIS_NOTUSED
(
™
);

1605 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1606 
	`REDIS_NOTUSED
(
™
);

1608 
	`»disPªic
("Unknown sorted setƒncoding");

1611 
	`»disPªic
("Unsupportedype");

1613 
	}
}

1615 
	$zuiL’gth
(
z£tİ¤c
 *
İ
) {

1616 ià(
İ
->
subjeù
 =ğ
NULL
)

1619 ià(
İ
->
ty³
 =ğ
REDIS_SET
) {

1620 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

1621  
	`št£tL’
(
İ
->
subjeù
->
±r
);

1622 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

1623 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1624  
	`diùSize
(
ht
);

1626 
	`»disPªic
("Unknown setƒncoding");

1628 } ià(
İ
->
ty³
 =ğ
REDIS_ZSET
) {

1629 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1630  
	`zzlL’gth
(
İ
->
subjeù
->
±r
);

1631 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1632 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1633  
zs
->
z¦
->
Ëngth
;

1635 
	`»disPªic
("Unknown sorted setƒncoding");

1638 
	`»disPªic
("Unsupportedype");

1640 
	}
}

1645 
	$zuiNext
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
) {

1646 ià(
İ
->
subjeù
 =ğ
NULL
)

1649 ià(
v®
->
æags
 & 
OPVAL_DIRTY_ROBJ
)

1650 
	`deüRefCouÁ
(
v®
->
–e
);

1652 
	`mem£t
(
v®
,0,(
z£tİv®
));

1654 ià(
İ
->
ty³
 =ğ
REDIS_SET
) {

1655 
™”£t
 *
™
 = &
İ
->
™”
.
£t
;

1656 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

1657 
št64_t
 
–l
;

1659 ià(!
	`št£tG‘
(
™
->
is
.is,™->is.
ii
,&
–l
))

1661 
v®
->
–l
 =ƒll;

1662 
v®
->
scÜe
 = 1.0;

1665 
™
->
is
.
ii
++;

1666 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

1667 ià(
™
->
ht
.
de
 =ğ
NULL
)

1669 
v®
->
–e
 = 
	`diùG‘Key
(
™
->
ht
.
de
);

1670 
v®
->
scÜe
 = 1.0;

1673 
™
->
ht
.
de
 = 
	`diùNext
(™->ht.
di
);

1675 
	`»disPªic
("Unknown setƒncoding");

1677 } ià(
İ
->
ty³
 =ğ
REDIS_ZSET
) {

1678 
™”z£t
 *
™
 = &
İ
->
™”
.
z£t
;

1679 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1681 ià(
™
->
zl
.
•Œ
 =ğ
NULL
 || it->zl.
¥Œ
 == NULL)

1683 
	`»disAs£¹
(
	`zli¡G‘
(
™
->
zl
.
•Œ
,&
v®
->
e¡r
,&v®->
–’
,&v®->
–l
));

1684 
v®
->
scÜe
 = 
	`zzlG‘ScÜe
(
™
->
zl
.
¥Œ
);

1687 
	`zzlNext
(
™
->
zl
.zl,&™->zl.
•Œ
,&™->zl.
¥Œ
);

1688 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1689 ià(
™
->
¦
.
node
 =ğ
NULL
)

1691 
v®
->
–e
 = 
™
->
¦
.
node
->
obj
;

1692 
v®
->
scÜe
 = 
™
->
¦
.
node
->score;

1695 
™
->
¦
.
node
 = it->¦.node->
Ëv–
[0].
fÜw¬d
;

1697 
	`»disPªic
("Unknown sorted setƒncoding");

1700 
	`»disPªic
("Unsupportedype");

1703 
	}
}

1705 
	$zuiLÚgLÚgFromV®ue
(
z£tİv®
 *
v®
) {

1706 ià(!(
v®
->
æags
 & 
OPVAL_DIRTY_LL
)) {

1707 
v®
->
æags
 |ğ
OPVAL_DIRTY_LL
;

1709 ià(
v®
->
–e
 !ğ
NULL
) {

1710 ià(
v®
->
–e
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

1711 
v®
->
–l
 = ()v®->
–e
->
±r
;

1712 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1713 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1714 ià(
	`¡ršg2Î
(
v®
->
–e
->
±r
,
	`sd¦’
(v®->–e->±r),&v®->
–l
))

1715 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1717 
	`»disPªic
("Unsupportedƒlementƒncoding");

1719 } ià(
v®
->
e¡r
 !ğ
NULL
) {

1720 ià(
	`¡ršg2Î
((*)
v®
->
e¡r
,v®->
–’
,&v®->
–l
))

1721 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1724 
v®
->
æags
 |ğ
OPVAL_VALID_LL
;

1727  
v®
->
æags
 & 
OPVAL_VALID_LL
;

1728 
	}
}

1730 
robj
 *
	$zuiObjeùFromV®ue
(
z£tİv®
 *
v®
) {

1731 ià(
v®
->
–e
 =ğ
NULL
) {

1732 ià(
v®
->
e¡r
 !ğ
NULL
) {

1733 
v®
->
–e
 = 
	`ü—‹SŒšgObjeù
((*)v®->
e¡r
,v®->
–’
);

1735 
v®
->
–e
 = 
	`ü—‹SŒšgObjeùFromLÚgLÚg
(v®->
–l
);

1737 
v®
->
æags
 |ğ
OPVAL_DIRTY_ROBJ
;

1739  
v®
->
–e
;

1740 
	}
}

1742 
	$zuiBufãrFromV®ue
(
z£tİv®
 *
v®
) {

1743 ià(
v®
->
e¡r
 =ğ
NULL
) {

1744 ià(
v®
->
–e
 !ğ
NULL
) {

1745 ià(
v®
->
–e
->
’codšg
 =ğ
REDIS_ENCODING_INT
) {

1746 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),()v®->
–e
->
±r
);

1747 
v®
->
e¡r
 = v®->
_buf
;

1748 } ià(
	`sdsEncodedObjeù
(
v®
->
–e
)) {

1749 
v®
->
–’
 = 
	`sd¦’
(v®->
–e
->
±r
);

1750 
v®
->
e¡r
 = v®->
–e
->
±r
;

1752 
	`»disPªic
("Unsupportedƒlementƒncoding");

1755 
v®
->
–’
 = 
	`Î2¡ršg
((*)v®->
_buf
,(v®->_buf),v®->
–l
);

1756 
v®
->
e¡r
 = v®->
_buf
;

1760 
	}
}

1764 
	$zuiFšd
(
z£tİ¤c
 *
İ
, 
z£tİv®
 *
v®
, *
scÜe
) {

1765 ià(
İ
->
subjeù
 =ğ
NULL
)

1768 ià(
İ
->
ty³
 =ğ
REDIS_SET
) {

1769 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_INTSET
) {

1770 ià(
	`zuiLÚgLÚgFromV®ue
(
v®
) &&

1771 
	`št£tFšd
(
İ
->
subjeù
->
±r
,
v®
->
–l
))

1773 *
scÜe
 = 1.0;

1778 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_HT
) {

1779 
diù
 *
ht
 = 
İ
->
subjeù
->
±r
;

1780 
	`zuiObjeùFromV®ue
(
v®
);

1781 ià(
	`diùFšd
(
ht
,
v®
->
–e
è!ğ
NULL
) {

1782 *
scÜe
 = 1.0;

1788 
	`»disPªic
("Unknown setƒncoding");

1790 } ià(
İ
->
ty³
 =ğ
REDIS_ZSET
) {

1791 
	`zuiObjeùFromV®ue
(
v®
);

1793 ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

1794 ià(
	`zzlFšd
(
İ
->
subjeù
->
±r
,
v®
->
–e
,
scÜe
è!ğ
NULL
) {

1800 } ià(
İ
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

1801 
z£t
 *
zs
 = 
İ
->
subjeù
->
±r
;

1802 
diùEÁry
 *
de
;

1803 ià((
de
 = 
	`diùFšd
(
zs
->
diù
,
v®
->
–e
)è!ğ
NULL
) {

1804 *
scÜe
 = *(*)
	`diùG‘V®
(
de
);

1810 
	`»disPªic
("Unknown sorted setƒncoding");

1813 
	`»disPªic
("Unsupportedype");

1815 
	}
}

1817 
	$zuiCom·»ByC¬dš®™y
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

1818  
	`zuiL’gth
((
z£tİ¤c
*)
s1
è- zuiL’gth((z£tİ¤c*)
s2
);

1819 
	}
}

1821 
	#REDIS_AGGR_SUM
 1

	)

1822 
	#REDIS_AGGR_MIN
 2

	)

1823 
	#REDIS_AGGR_MAX
 3

	)

1824 
	#zuniÚIÁ”DiùV®ue
(
_e
è(
	`diùG‘V®
(_eè=ğ
NULL
 ? 1.0 : *(*)diùG‘V®(_e))

	)

1826 
šlše
 
	$zuniÚIÁ”Agg»g©e
(*
rg‘
, 
v®
, 
agg»g©e
) {

1827 ià(
agg»g©e
 =ğ
REDIS_AGGR_SUM
) {

1828 *
rg‘
 = *rg‘ + 
v®
;

1832 ià(
	`i¢ª
(*
rg‘
)) *target = 0.0;

1833 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MIN
) {

1834 *
rg‘
 = 
v®
 < *target ? val : *target;

1835 } ià(
agg»g©e
 =ğ
REDIS_AGGR_MAX
) {

1836 *
rg‘
 = 
v®
 > *target ? val : *target;

1839 
	`»disPªic
("Unknown ZUNION/INTER‡ggregateype");

1841 
	}
}

1843 
	$zuniÚIÁ”G’”icCommªd
(
»disCl›Á
 *
c
, 
robj
 *
d¡key
, 
İ
) {

1844 
i
, 
j
;

1845 
£Šum
;

1846 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1847 
z£tİ¤c
 *
¤c
;

1848 
z£tİv®
 
zv®
;

1849 
robj
 *
tmp
;

1850 
max––’
 = 0;

1851 
robj
 *
d¡obj
;

1852 
z£t
 *
d¡z£t
;

1853 
zskli¡Node
 *
znode
;

1854 
touched
 = 0;

1857 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
£Šum
, 
NULL
è!ğ
REDIS_OK
))

1860 ià(
£Šum
 < 1) {

1861 
	`addR•lyE¼Ü
(
c
,

1867 ià(
£Šum
 > 
c
->
¬gc
-3) {

1868 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1873 
¤c
 = 
	`zÿÎoc
((
z£tİ¤c
è* 
£Šum
);

1874 
i
 = 0, 
j
 = 3; i < 
£Šum
; i++, j++) {

1875 
robj
 *
obj
 = 
	`lookupKeyWr™e
(
c
->
db
,c->
¬gv
[
j
]);

1876 ià(
obj
 !ğ
NULL
) {

1877 ià(
obj
->
ty³
 !ğ
REDIS_ZSET
 && obj->ty³ !ğ
REDIS_SET
) {

1878 
	`zä“
(
¤c
);

1879 
	`addR•ly
(
c
,
sh¬ed
.
wrÚgty³”r
);

1883 
¤c
[
i
].
subjeù
 = 
obj
;

1884 
¤c
[
i
].
ty³
 = 
obj
->type;

1885 
¤c
[
i
].
’codšg
 = 
obj
->encoding;

1887 
¤c
[
i
].
subjeù
 = 
NULL
;

1891 
¤c
[
i
].
weight
 = 1.0;

1895 ià(
j
 < 
c
->
¬gc
) {

1896 
»maššg
 = 
c
->
¬gc
 - 
j
;

1898 
»maššg
) {

1899 ià(
»maššg
 >ğ(
£Šum
 + 1è&& !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"weights")) {

1900 
j
++; 
»maššg
--;

1901 
i
 = 0; i < 
£Šum
; i++, 
j
++, 
»maššg
--) {

1902 ià(
	`g‘DoubËFromObjeùOrR•ly
(
c
,c->
¬gv
[
j
],&
¤c
[
i
].
weight
,

1903 "weighˆv®ui nÙ‡ flßt"è!ğ
REDIS_OK
)

1905 
	`zä“
(
¤c
);

1909 } ià(
»maššg
 >ğ2 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"aggregate")) {

1910 
j
++; 
»maššg
--;

1911 ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"sum")) {

1912 
agg»g©e
 = 
REDIS_AGGR_SUM
;

1913 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"min")) {

1914 
agg»g©e
 = 
REDIS_AGGR_MIN
;

1915 } ià(!
	`¡rÿ£cmp
(
c
->
¬gv
[
j
]->
±r
,"max")) {

1916 
agg»g©e
 = 
REDIS_AGGR_MAX
;

1918 
	`zä“
(
¤c
);

1919 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1922 
j
++; 
»maššg
--;

1924 
	`zä“
(
¤c
);

1925 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

1933 
	`qsÜt
(
¤c
,
£Šum
,(
z£tİ¤c
),
zuiCom·»ByC¬dš®™y
);

1935 
d¡obj
 = 
	`ü—‹Z£tObjeù
();

1936 
d¡z£t
 = 
d¡obj
->
±r
;

1937 
	`mem£t
(&
zv®
, 0, (zval));

1939 ià(
İ
 =ğ
REDIS_OP_INTER
) {

1941 ià(
	`zuiL’gth
(&
¤c
[0]) > 0) {

1944 
	`zuiIn™I‹¿tÜ
(&
¤c
[0]);

1945 
	`zuiNext
(&
¤c
[0],&
zv®
)) {

1946 
scÜe
, 
v®ue
;

1948 
scÜe
 = 
¤c
[0].
weight
 * 
zv®
.score;

1949 ià(
	`i¢ª
(
scÜe
)) score = 0;

1951 
j
 = 1; j < 
£Šum
; j++) {

1954 ià(
¤c
[
j
].
subjeù
 == src[0].subject) {

1955 
v®ue
 = 
zv®
.
scÜe
*
¤c
[
j
].
weight
;

1956 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

1957 } ià(
	`zuiFšd
(&
¤c
[
j
],&
zv®
,&
v®ue
)) {

1958 
v®ue
 *ğ
¤c
[
j
].
weight
;

1959 
	`zuniÚIÁ”Agg»g©e
(&
scÜe
,
v®ue
,
agg»g©e
);

1966 ià(
j
 =ğ
£Šum
) {

1967 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

1968 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
tmp
);

1969 
	`šüRefCouÁ
(
tmp
);

1970 
	`diùAdd
(
d¡z£t
->
diù
,
tmp
,&
znode
->
scÜe
);

1971 
	`šüRefCouÁ
(
tmp
);

1973 ià(
	`sdsEncodedObjeù
(
tmp
)) {

1974 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

1975 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

1979 
	`zuiCË¬I‹¿tÜ
(&
¤c
[0]);

1981 } ià(
İ
 =ğ
REDIS_OP_UNION
) {

1982 
diù
 *
accumuÏtÜ
 = 
	`diùC»©e
(&
£tDiùTy³
,
NULL
);

1983 
diùI‹¿tÜ
 *
di
;

1984 
diùEÁry
 *
de
;

1985 
scÜe
;

1987 ià(
£Šum
) {

1990 
	`diùEx·nd
(
accumuÏtÜ
,
	`zuiL’gth
(&
¤c
[
£Šum
-1]));

1995 
i
 = 0; i < 
£Šum
; i++) {

1996 ià(
	`zuiL’gth
(&
¤c
[
i
]) == 0) ;

1998 
	`zuiIn™I‹¿tÜ
(&
¤c
[
i
]);

1999 
	`zuiNext
(&
¤c
[
i
],&
zv®
)) {

2001 
scÜe
 = 
¤c
[
i
].
weight
 * 
zv®
.score;

2002 ià(
	`i¢ª
(
scÜe
)) score = 0;

2005 
de
 = 
	`diùFšd
(
accumuÏtÜ
,
	`zuiObjeùFromV®ue
(&
zv®
));

2007 ià(
de
 =ğ
NULL
) {

2008 
tmp
 = 
	`zuiObjeùFromV®ue
(&
zv®
);

2012 ià(
	`sdsEncodedObjeù
(
tmp
)) {

2013 ià(
	`sd¦’
(
tmp
->
±r
è> 
max––’
)

2014 
max––’
 = 
	`sd¦’
(
tmp
->
±r
);

2017 
de
 = 
	`diùAddRaw
(
accumuÏtÜ
,
tmp
);

2018 
	`šüRefCouÁ
(
tmp
);

2019 
	`diùS‘DoubËV®
(
de
,
scÜe
);

2027 
	`zuniÚIÁ”Agg»g©e
(&
de
->
v
.
d
,
scÜe
,
agg»g©e
);

2030 
	`zuiCË¬I‹¿tÜ
(&
¤c
[
i
]);

2034 
di
 = 
	`diùG‘I‹¿tÜ
(
accumuÏtÜ
);

2039 
	`diùEx·nd
(
d¡z£t
->
diù
,
	`diùSize
(
accumuÏtÜ
));

2041 (
de
 = 
	`diùNext
(
di
)è!ğ
NULL
) {

2042 
robj
 *
–e
 = 
	`diùG‘Key
(
de
);

2043 
scÜe
 = 
	`diùG‘DoubËV®
(
de
);

2044 
znode
 = 
	`z¦In£¹
(
d¡z£t
->
z¦
,
scÜe
,
–e
);

2045 
	`šüRefCouÁ
(
–e
);

2046 
	`diùAdd
(
d¡z£t
->
diù
,
–e
,&
znode
->
scÜe
);

2047 
	`šüRefCouÁ
(
–e
);

2049 
	`diùR–—£I‹¿tÜ
(
di
);

2052 
	`diùR–—£
(
accumuÏtÜ
);

2054 
	`»disPªic
("Unknown operator");

2057 ià(
	`dbD–‘e
(
c
->
db
,
d¡key
)) {

2058 
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2059 
touched
 = 1;

2060 
£rv”
.
dœty
++;

2062 ià(
d¡z£t
->
z¦
->
Ëngth
) {

2064 ià(
d¡z£t
->
z¦
->
Ëngth
 <ğ
£rv”
.
z£t_max_zli¡_’Œ›s
 &&

2065 
max––’
 <ğ
£rv”
.
z£t_max_zli¡_v®ue
)

2066 
	`z£tCÚv”t
(
d¡obj
,
REDIS_ENCODING_ZIPLIST
);

2068 
	`dbAdd
(
c
->
db
,
d¡key
,
d¡obj
);

2069 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
d¡obj
));

2070 ià(!
touched
è
	`sigÇlModif›dKey
(
c
->
db
,
d¡key
);

2071 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_ZSET
,

2072 (
İ
 =ğ
REDIS_OP_UNION
) ? "zunionstore" : "zinterstore",

2073 
d¡key
,
c
->
db
->
id
);

2074 
£rv”
.
dœty
++;

2076 
	`deüRefCouÁ
(
d¡obj
);

2077 
	`addR•ly
(
c
,
sh¬ed
.
cz”o
);

2078 ià(
touched
)

2079 
	`nÙifyKey¥aûEv’t
(
REDIS_NOTIFY_GENERIC
,"d–",
d¡key
,
c
->
db
->
id
);

2081 
	`zä“
(
¤c
);

2082 
	}
}

2084 
	$zuniÚ¡ÜeCommªd
(
»disCl›Á
 *
c
) {

2085 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
REDIS_OP_UNION
);

2086 
	}
}

2088 
	$zš‹r¡ÜeCommªd
(
»disCl›Á
 *
c
) {

2089 
	`zuniÚIÁ”G’”icCommªd
(
c
,c->
¬gv
[1], 
REDIS_OP_INTER
);

2090 
	}
}

2092 
	$z¿ngeG’”icCommªd
(
»disCl›Á
 *
c
, 
»v”£
) {

2093 
robj
 *
key
 = 
c
->
¬gv
[1];

2094 
robj
 *
zobj
;

2095 
w™hscÜes
 = 0;

2096 
¡¬t
;

2097 
’d
;

2098 
Î’
;

2099 
¿ng–’
;

2101 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[2], &
¡¬t
, 
NULL
è!ğ
REDIS_OK
) ||

2102 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[3], &
’d
, 
NULL
è!ğ
REDIS_OK
)) ;

2104 ià(
c
->
¬gc
 =ğ5 && !
	`¡rÿ£cmp
(c->
¬gv
[4]->
±r
,"withscores")) {

2105 
w™hscÜes
 = 1;

2106 } ià(
c
->
¬gc
 >= 5) {

2107 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2111 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL


2112 || 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

2115 
Î’
 = 
	`z£tL’gth
(
zobj
);

2116 ià(
¡¬t
 < 0è¡¬ˆğ
Î’
+start;

2117 ià(
’d
 < 0è’d = 
Î’
+end;

2118 ià(
¡¬t
 < 0) start = 0;

2122 ià(
¡¬t
 > 
’d
 || s¹ >ğ
Î’
) {

2123 
	`addR•ly
(
c
,
sh¬ed
.
em±ymuÉibulk
);

2126 ià(
’d
 >ğ
Î’
)ƒnd =†len-1;

2127 
¿ng–’
 = (
’d
-
¡¬t
)+1;

2130 
	`addR•lyMuÉiBulkL’
(
c
, 
w™hscÜes
 ? (
¿ng–’
*2) :„angelen);

2132 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2133 *
zl
 = 
zobj
->
±r
;

2134 *
•Œ
, *
¥Œ
;

2135 *
v¡r
;

2136 
vËn
;

2137 
vlÚg
;

2139 ià(
»v”£
)

2140 
•Œ
 = 
	`zli¡Index
(
zl
,-2-(2*
¡¬t
));

2142 
•Œ
 = 
	`zli¡Index
(
zl
,2*
¡¬t
);

2144 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2145 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2147 
¿ng–’
--) {

2148 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
 && 
¥Œ
 != NULL);

2149 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2150 ià(
v¡r
 =ğ
NULL
)

2151 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2153 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2155 ià(
w™hscÜes
)

2156 
	`addR•lyDoubË
(
c
,
	`zzlG‘ScÜe
(
¥Œ
));

2158 ià(
»v”£
)

2159 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2161 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2164 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2165 
z£t
 *
zs
 = 
zobj
->
±r
;

2166 
zskli¡
 *
z¦
 = 
zs
->zsl;

2167 
zskli¡Node
 *
Ê
;

2168 
robj
 *
–e
;

2171 ià(
»v”£
) {

2172 
Ê
 = 
z¦
->

;

2173 ià(
¡¬t
 > 0)

2174 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
Î’
-
¡¬t
);

2176 
Ê
 = 
z¦
->
h—d”
->
Ëv–
[0].
fÜw¬d
;

2177 ià(
¡¬t
 > 0)

2178 
Ê
 = 
	`z¦G‘EËm’tByRªk
(
z¦
,
¡¬t
+1);

2181 
¿ng–’
--) {

2182 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
Ê
 !ğ
NULL
);

2183 
–e
 = 
Ê
->
obj
;

2184 
	`addR•lyBulk
(
c
,
–e
);

2185 ià(
w™hscÜes
)

2186 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2187 
Ê
 = 
»v”£
 ?†n->
backw¬d
 :†n->
Ëv–
[0].
fÜw¬d
;

2190 
	`»disPªic
("Unknown sorted setƒncoding");

2192 
	}
}

2194 
	$z¿ngeCommªd
(
»disCl›Á
 *
c
) {

2195 
	`z¿ngeG’”icCommªd
(
c
,0);

2196 
	}
}

2198 
	$z»v¿ngeCommªd
(
»disCl›Á
 *
c
) {

2199 
	`z¿ngeG’”icCommªd
(
c
,1);

2200 
	}
}

2203 
	$g’”icZ¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
, 
»v”£
) {

2204 
z¿nge¥ec
 
¿nge
;

2205 
robj
 *
key
 = 
c
->
¬gv
[1];

2206 
robj
 *
zobj
;

2207 
off£t
 = 0, 
lim™
 = -1;

2208 
w™hscÜes
 = 0;

2209 
¿ng–’
 = 0;

2210 *
»¶yËn
 = 
NULL
;

2211 
mšidx
, 
maxidx
;

2214 ià(
»v”£
) {

2216 
maxidx
 = 2; 
mšidx
 = 3;

2219 
mšidx
 = 2; 
maxidx
 = 3;

2222 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
REDIS_OK
) {

2223 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2229 ià(
c
->
¬gc
 > 4) {

2230 
»maššg
 = 
c
->
¬gc
 - 4;

2231 
pos
 = 4;

2233 
»maššg
) {

2234 ià(
»maššg
 >ğ1 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"withscores")) {

2235 
pos
++; 
»maššg
--;

2236 
w™hscÜes
 = 1;

2237 } ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2238 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
REDIS_OK
) ||

2239 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
REDIS_OK
)) ;

2240 
pos
 +ğ3; 
»maššg
 -= 3;

2242 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2249 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2250 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

2252 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2253 *
zl
 = 
zobj
->
±r
;

2254 *
•Œ
, *
¥Œ
;

2255 *
v¡r
;

2256 
vËn
;

2257 
vlÚg
;

2258 
scÜe
;

2261 ià(
»v”£
) {

2262 
•Œ
 = 
	`zzlLa¡InRªge
(
zl
,&
¿nge
);

2264 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2268 ià(
•Œ
 =ğ
NULL
) {

2269 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2274 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2275 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2280 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2284 
•Œ
 && 
off£t
--) {

2285 ià(
»v”£
) {

2286 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2288 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2292 
•Œ
 && 
lim™
--) {

2293 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2296 ià(
»v”£
) {

2297 ià(!
	`z¦V®ueG‹Mš
(
scÜe
,&
¿nge
)) ;

2299 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) ;

2303 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2305 
¿ng–’
++;

2306 ià(
v¡r
 =ğ
NULL
) {

2307 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2309 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2312 ià(
w™hscÜes
) {

2313 
	`addR•lyDoubË
(
c
,
scÜe
);

2317 ià(
»v”£
) {

2318 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2320 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2323 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2324 
z£t
 *
zs
 = 
zobj
->
±r
;

2325 
zskli¡
 *
z¦
 = 
zs
->zsl;

2326 
zskli¡Node
 *
Ê
;

2329 ià(
»v”£
) {

2330 
Ê
 = 
	`z¦La¡InRªge
(
z¦
,&
¿nge
);

2332 
Ê
 = 
	`z¦Fœ¡InRªge
(
z¦
,&
¿nge
);

2336 ià(
Ê
 =ğ
NULL
) {

2337 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2344 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2348 
Ê
 && 
off£t
--) {

2349 ià(
»v”£
) {

2350 
Ê
 =†n->
backw¬d
;

2352 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2356 
Ê
 && 
lim™
--) {

2358 ià(
»v”£
) {

2359 ià(!
	`z¦V®ueG‹Mš
(
Ê
->
scÜe
,&
¿nge
)) ;

2361 ià(!
	`z¦V®ueL‹Max
(
Ê
->
scÜe
,&
¿nge
)) ;

2364 
¿ng–’
++;

2365 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2367 ià(
w™hscÜes
) {

2368 
	`addR•lyDoubË
(
c
,
Ê
->
scÜe
);

2372 ià(
»v”£
) {

2373 
Ê
 =†n->
backw¬d
;

2375 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2379 
	`»disPªic
("Unknown sorted setƒncoding");

2382 ià(
w™hscÜes
) {

2383 
¿ng–’
 *= 2;

2386 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2387 
	}
}

2389 
	$z¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
) {

2390 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,0);

2391 
	}
}

2393 
	$z»v¿ngebyscÜeCommªd
(
»disCl›Á
 *
c
) {

2394 
	`g’”icZ¿ngebyscÜeCommªd
(
c
,1);

2395 
	}
}

2397 
	$zcouÁCommªd
(
»disCl›Á
 *
c
) {

2398 
robj
 *
key
 = 
c
->
¬gv
[1];

2399 
robj
 *
zobj
;

2400 
z¿nge¥ec
 
¿nge
;

2401 
couÁ
 = 0;

2404 ià(
	`z¦P¬£Rªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
REDIS_OK
) {

2405 
	`addR•lyE¼Ü
(
c
,"min or max is‚ot‡ float");

2410 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2411 
	`checkTy³
(
c
, 
zobj
, 
REDIS_ZSET
)) ;

2413 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2414 *
zl
 = 
zobj
->
±r
;

2415 *
•Œ
, *
¥Œ
;

2416 
scÜe
;

2419 
•Œ
 = 
	`zzlFœ¡InRªge
(
zl
,&
¿nge
);

2422 ià(
•Œ
 =ğ
NULL
) {

2423 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2428 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2429 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2430 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
));

2433 
•Œ
) {

2434 
scÜe
 = 
	`zzlG‘ScÜe
(
¥Œ
);

2437 ià(!
	`z¦V®ueL‹Max
(
scÜe
,&
¿nge
)) {

2440 
couÁ
++;

2441 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2444 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2445 
z£t
 *
zs
 = 
zobj
->
±r
;

2446 
zskli¡
 *
z¦
 = 
zs
->zsl;

2447 
zskli¡Node
 *
zn
;

2448 
¿nk
;

2451 
zn
 = 
	`z¦Fœ¡InRªge
(
z¦
, &
¿nge
);

2454 ià(
zn
 !ğ
NULL
) {

2455 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2456 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2459 
zn
 = 
	`z¦La¡InRªge
(
z¦
, &
¿nge
);

2462 ià(
zn
 !ğ
NULL
) {

2463 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2464 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2468 
	`»disPªic
("Unknown sorted setƒncoding");

2471 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2472 
	}
}

2474 
	$zËxcouÁCommªd
(
»disCl›Á
 *
c
) {

2475 
robj
 *
key
 = 
c
->
¬gv
[1];

2476 
robj
 *
zobj
;

2477 
zËx¿nge¥ec
 
¿nge
;

2478 
couÁ
 = 0;

2481 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[2],c->¬gv[3],&
¿nge
è!ğ
REDIS_OK
) {

2482 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2487 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
, 
key
, 
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2488 
	`checkTy³
(
c
, 
zobj
, 
REDIS_ZSET
))

2490 
	`z¦F»eLexRªge
(&
¿nge
);

2494 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2495 *
zl
 = 
zobj
->
±r
;

2496 *
•Œ
, *
¥Œ
;

2499 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2502 ià(
•Œ
 =ğ
NULL
) {

2503 
	`z¦F»eLexRªge
(&
¿nge
);

2504 
	`addR•ly
(
c
, 
sh¬ed
.
cz”o
);

2509 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2510 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
));

2513 
•Œ
) {

2515 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) {

2518 
couÁ
++;

2519 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2522 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2523 
z£t
 *
zs
 = 
zobj
->
±r
;

2524 
zskli¡
 *
z¦
 = 
zs
->zsl;

2525 
zskli¡Node
 *
zn
;

2526 
¿nk
;

2529 
zn
 = 
	`z¦Fœ¡InLexRªge
(
z¦
, &
¿nge
);

2532 ià(
zn
 !ğ
NULL
) {

2533 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2534 
couÁ
 = (
z¦
->
Ëngth
 - (
¿nk
 - 1));

2537 
zn
 = 
	`z¦La¡InLexRªge
(
z¦
, &
¿nge
);

2540 ià(
zn
 !ğ
NULL
) {

2541 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
, 
zn
->
scÜe
, zn->
obj
);

2542 
couÁ
 -ğ(
z¦
->
Ëngth
 - 
¿nk
);

2546 
	`»disPªic
("Unknown sorted setƒncoding");

2549 
	`z¦F»eLexRªge
(&
¿nge
);

2550 
	`addR•lyLÚgLÚg
(
c
, 
couÁ
);

2551 
	}
}

2554 
	$g’”icZ¿ngebyËxCommªd
(
»disCl›Á
 *
c
, 
»v”£
) {

2555 
zËx¿nge¥ec
 
¿nge
;

2556 
robj
 *
key
 = 
c
->
¬gv
[1];

2557 
robj
 *
zobj
;

2558 
off£t
 = 0, 
lim™
 = -1;

2559 
¿ng–’
 = 0;

2560 *
»¶yËn
 = 
NULL
;

2561 
mšidx
, 
maxidx
;

2564 ià(
»v”£
) {

2566 
maxidx
 = 2; 
mšidx
 = 3;

2569 
mšidx
 = 2; 
maxidx
 = 3;

2572 ià(
	`z¦P¬£LexRªge
(
c
->
¬gv
[
mšidx
],c->¬gv[
maxidx
],&
¿nge
è!ğ
REDIS_OK
) {

2573 
	`addR•lyE¼Ü
(
c
,"min or max‚ot valid string„ange item");

2579 ià(
c
->
¬gc
 > 4) {

2580 
»maššg
 = 
c
->
¬gc
 - 4;

2581 
pos
 = 4;

2583 
»maššg
) {

2584 ià(
»maššg
 >ğ3 && !
	`¡rÿ£cmp
(
c
->
¬gv
[
pos
]->
±r
,"limit")) {

2585 ià((
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+1], &
off£t
, 
NULL
è!ğ
REDIS_OK
) ||

2586 (
	`g‘LÚgFromObjeùOrR•ly
(
c
, c->
¬gv
[
pos
+2], &
lim™
, 
NULL
è!ğ
REDIS_OK
)) ;

2587 
pos
 +ğ3; 
»maššg
 -= 3;

2589 
	`z¦F»eLexRªge
(&
¿nge
);

2590 
	`addR•ly
(
c
,
sh¬ed
.
syÁax”r
);

2597 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
em±ymuÉibulk
)è=ğ
NULL
 ||

2598 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
))

2600 
	`z¦F»eLexRªge
(&
¿nge
);

2604 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2605 *
zl
 = 
zobj
->
±r
;

2606 *
•Œ
, *
¥Œ
;

2607 *
v¡r
;

2608 
vËn
;

2609 
vlÚg
;

2612 ià(
»v”£
) {

2613 
•Œ
 = 
	`zzlLa¡InLexRªge
(
zl
,&
¿nge
);

2615 
•Œ
 = 
	`zzlFœ¡InLexRªge
(
zl
,&
¿nge
);

2619 ià(
•Œ
 =ğ
NULL
) {

2620 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2621 
	`z¦F»eLexRªge
(&
¿nge
);

2626 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2627 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2632 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2636 
•Œ
 && 
off£t
--) {

2637 ià(
»v”£
) {

2638 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2640 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2644 
•Œ
 && 
lim™
--) {

2646 ià(
»v”£
) {

2647 ià(!
	`zzlLexV®ueG‹Mš
(
•Œ
,&
¿nge
)) ;

2649 ià(!
	`zzlLexV®ueL‹Max
(
•Œ
,&
¿nge
)) ;

2654 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
	`zli¡G‘
(
•Œ
,&
v¡r
,&
vËn
,&
vlÚg
));

2656 
¿ng–’
++;

2657 ià(
v¡r
 =ğ
NULL
) {

2658 
	`addR•lyBulkLÚgLÚg
(
c
,
vlÚg
);

2660 
	`addR•lyBulkCBufãr
(
c
,
v¡r
,
vËn
);

2664 ià(
»v”£
) {

2665 
	`zzlP»v
(
zl
,&
•Œ
,&
¥Œ
);

2667 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2670 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2671 
z£t
 *
zs
 = 
zobj
->
±r
;

2672 
zskli¡
 *
z¦
 = 
zs
->zsl;

2673 
zskli¡Node
 *
Ê
;

2676 ià(
»v”£
) {

2677 
Ê
 = 
	`z¦La¡InLexRªge
(
z¦
,&
¿nge
);

2679 
Ê
 = 
	`z¦Fœ¡InLexRªge
(
z¦
,&
¿nge
);

2683 ià(
Ê
 =ğ
NULL
) {

2684 
	`addR•ly
(
c
, 
sh¬ed
.
em±ymuÉibulk
);

2685 
	`z¦F»eLexRªge
(&
¿nge
);

2692 
»¶yËn
 = 
	`addDeã¼edMuÉiBulkL’gth
(
c
);

2696 
Ê
 && 
off£t
--) {

2697 ià(
»v”£
) {

2698 
Ê
 =†n->
backw¬d
;

2700 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2704 
Ê
 && 
lim™
--) {

2706 ià(
»v”£
) {

2707 ià(!
	`z¦LexV®ueG‹Mš
(
Ê
->
obj
,&
¿nge
)) ;

2709 ià(!
	`z¦LexV®ueL‹Max
(
Ê
->
obj
,&
¿nge
)) ;

2712 
¿ng–’
++;

2713 
	`addR•lyBulk
(
c
,
Ê
->
obj
);

2716 ià(
»v”£
) {

2717 
Ê
 =†n->
backw¬d
;

2719 
Ê
 =†n->
Ëv–
[0].
fÜw¬d
;

2723 
	`»disPªic
("Unknown sorted setƒncoding");

2726 
	`z¦F»eLexRªge
(&
¿nge
);

2727 
	`£tDeã¼edMuÉiBulkL’gth
(
c
, 
»¶yËn
, 
¿ng–’
);

2728 
	}
}

2730 
	$z¿ngebyËxCommªd
(
»disCl›Á
 *
c
) {

2731 
	`g’”icZ¿ngebyËxCommªd
(
c
,0);

2732 
	}
}

2734 
	$z»v¿ngebyËxCommªd
(
»disCl›Á
 *
c
) {

2735 
	`g’”icZ¿ngebyËxCommªd
(
c
,1);

2736 
	}
}

2738 
	$zÿrdCommªd
(
»disCl›Á
 *
c
) {

2739 
robj
 *
key
 = 
c
->
¬gv
[1];

2740 
robj
 *
zobj
;

2742 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
cz”o
)è=ğ
NULL
 ||

2743 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

2745 
	`addR•lyLÚgLÚg
(
c
,
	`z£tL’gth
(
zobj
));

2746 
	}
}

2748 
	$zscÜeCommªd
(
»disCl›Á
 *
c
) {

2749 
robj
 *
key
 = 
c
->
¬gv
[1];

2750 
robj
 *
zobj
;

2751 
scÜe
;

2753 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

2754 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

2756 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2757 ià(
	`zzlFšd
(
zobj
->
±r
,
c
->
¬gv
[2],&
scÜe
è!ğ
NULL
)

2758 
	`addR•lyDoubË
(
c
,
scÜe
);

2760 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2761 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2762 
z£t
 *
zs
 = 
zobj
->
±r
;

2763 
diùEÁry
 *
de
;

2765 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

2766 
de
 = 
	`diùFšd
(
zs
->
diù
,
c
->
¬gv
[2]);

2767 ià(
de
 !ğ
NULL
) {

2768 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2769 
	`addR•lyDoubË
(
c
,
scÜe
);

2771 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2774 
	`»disPªic
("Unknown sorted setƒncoding");

2776 
	}
}

2778 
	$z¿nkG’”icCommªd
(
»disCl›Á
 *
c
, 
»v”£
) {

2779 
robj
 *
key
 = 
c
->
¬gv
[1];

2780 
robj
 *
–e
 = 
c
->
¬gv
[2];

2781 
robj
 *
zobj
;

2782 
Î’
;

2783 
¿nk
;

2785 ià((
zobj
 = 
	`lookupKeyR—dOrR•ly
(
c
,
key
,
sh¬ed
.
nuÎbulk
)è=ğ
NULL
 ||

2786 
	`checkTy³
(
c
,
zobj
,
REDIS_ZSET
)) ;

2787 
Î’
 = 
	`z£tL’gth
(
zobj
);

2789 
	`»disAs£¹W™hInfo
(
c
,
–e
,
	`sdsEncodedObjeù
(ele));

2791 ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_ZIPLIST
) {

2792 *
zl
 = 
zobj
->
±r
;

2793 *
•Œ
, *
¥Œ
;

2795 
•Œ
 = 
	`zli¡Index
(
zl
,0);

2796 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
•Œ
 !ğ
NULL
);

2797 
¥Œ
 = 
	`zli¡Next
(
zl
,
•Œ
);

2798 
	`»disAs£¹W™hInfo
(
c
,
zobj
,
¥Œ
 !ğ
NULL
);

2800 
¿nk
 = 1;

2801 
•Œ
 !ğ
NULL
) {

2802 ià(
	`zli¡Com·»
(
•Œ
,
–e
->
±r
,
	`sd¦’
(ele->ptr)))

2804 
¿nk
++;

2805 
	`zzlNext
(
zl
,&
•Œ
,&
¥Œ
);

2808 ià(
•Œ
 !ğ
NULL
) {

2809 ià(
»v”£
)

2810 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2812 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2814 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2816 } ià(
zobj
->
’codšg
 =ğ
REDIS_ENCODING_SKIPLIST
) {

2817 
z£t
 *
zs
 = 
zobj
->
±r
;

2818 
zskli¡
 *
z¦
 = 
zs
->zsl;

2819 
diùEÁry
 *
de
;

2820 
scÜe
;

2822 
–e
 = 
c
->
¬gv
[2] = 
	`ŒyObjeùEncodšg
(c->argv[2]);

2823 
de
 = 
	`diùFšd
(
zs
->
diù
,
–e
);

2824 ià(
de
 !ğ
NULL
) {

2825 
scÜe
 = *(*)
	`diùG‘V®
(
de
);

2826 
¿nk
 = 
	`z¦G‘Rªk
(
z¦
,
scÜe
,
–e
);

2827 
	`»disAs£¹W™hInfo
(
c
,
–e
,
¿nk
);

2828 ià(
»v”£
)

2829 
	`addR•lyLÚgLÚg
(
c
,
Î’
-
¿nk
);

2831 
	`addR•lyLÚgLÚg
(
c
,
¿nk
-1);

2833 
	`addR•ly
(
c
,
sh¬ed
.
nuÎbulk
);

2836 
	`»disPªic
("Unknown sorted setƒncoding");

2838 
	}
}

2840 
	$z¿nkCommªd
(
»disCl›Á
 *
c
) {

2841 
	`z¿nkG’”icCommªd
(
c
, 0);

2842 
	}
}

2844 
	$z»v¿nkCommªd
(
»disCl›Á
 *
c
) {

2845 
	`z¿nkG’”icCommªd
(
c
, 1);

2846 
	}
}

2848 
	$zsÿnCommªd
(
»disCl›Á
 *
c
) {

2849 
robj
 *
o
;

2850 
cursÜ
;

2852 ià(
	`·r£SÿnCursÜOrR•ly
(
c
,c->
¬gv
[2],&
cursÜ
è=ğ
REDIS_ERR
) ;

2853 ià((
o
 = 
	`lookupKeyR—dOrR•ly
(
c
,c->
¬gv
[1],
sh¬ed
.
em±ysÿn
)è=ğ
NULL
 ||

2854 
	`checkTy³
(
c
,
o
,
REDIS_ZSET
)) ;

2855 
	`sÿnG’”icCommªd
(
c
,
o
,
cursÜ
);

2856 
	}
}

	@testhelp.h

39 #iâdeà
__TESTHELP_H


40 
	#__TESTHELP_H


	)

42 
	g__çed_‹¡s
 = 0;

43 
	g__‹¡_num
 = 0;

44 
	#‹¡_cÚd
(
desü
,
_c
) do { \

45 
__‹¡_num
++; 
	`´štf
("%d - %s: ", __‹¡_num, 
desü
); \

46 if(
_c
è
	`´štf
("PASSED\n"); {´štf("FAILED\n"); 
__çed_‹¡s
++;} \

47 } 0);

	)

48 
	#‹¡_»pÜt
() do { \

49 
	`´štf
("%de¡s, %d…as£d, %d faed\n", 
__‹¡_num
, \

50 
__‹¡_num
-
__çed_‹¡s
, __failed_tests); \

51 ià(
__çed_‹¡s
) { \

52 
	`´štf
("=== WARNING === We have failedests here...\n"); \

53 
	`ex™
(1); \

55 } 0);

	)

	@util.c

30 
	~"fmaüos.h
"

31 
	~<¡dlib.h
>

32 
	~<¡dio.h
>

33 
	~<¡ršg.h
>

34 
	~<ùy³.h
>

35 
	~<lim™s.h
>

36 
	~<m©h.h
>

37 
	~<uni¡d.h
>

38 
	~<sys/time.h
>

39 
	~<æßt.h
>

40 
	~<¡dšt.h
>

41 
	~<”ºo.h
>

43 
	~"ut.h
"

44 
	~"sha1.h
"

47 
	$¡ršgm©chËn
(cÚ¡ *
·‰”n
, 
·‰”nL’
,

48 cÚ¡ *
¡ršg
, 
¡ršgL’
, 
noÿ£
)

50 
·‰”nL’
) {

51 
·‰”n
[0]) {

53 
·‰”n
[1] == '*') {

54 
·‰”n
++;

55 
·‰”nL’
--;

57 ià(
·‰”nL’
 == 1)

59 
¡ršgL’
) {

60 ià(
	`¡ršgm©chËn
(
·‰”n
+1, 
·‰”nL’
-1,

61 
¡ršg
, 
¡ršgL’
, 
noÿ£
))

63 
¡ršg
++;

64 
¡ršgL’
--;

69 ià(
¡ršgL’
 == 0)

71 
¡ršg
++;

72 
¡ršgL’
--;

76 
nÙ
, 
m©ch
;

78 
·‰”n
++;

79 
·‰”nL’
--;

80 
nÙ
 = 
·‰”n
[0] == '^';

81 ià(
nÙ
) {

82 
·‰”n
++;

83 
·‰”nL’
--;

85 
m©ch
 = 0;

87 ià(
·‰”n
[0] == '\\') {

88 
·‰”n
++;

89 
·‰”nL’
--;

90 ià(
·‰”n
[0] =ğ
¡ršg
[0])

91 
m©ch
 = 1;

92 } ià(
·‰”n
[0] == ']') {

94 } ià(
·‰”nL’
 == 0) {

95 
·‰”n
--;

96 
·‰”nL’
++;

98 } ià(
·‰”n
[1] =ğ'-' && 
·‰”nL’
 >= 3) {

99 
¡¬t
 = 
·‰”n
[0];

100 
’d
 = 
·‰”n
[2];

101 
c
 = 
¡ršg
[0];

102 ià(
¡¬t
 > 
’d
) {

103 
t
 = 
¡¬t
;

104 
¡¬t
 = 
’d
;

105 
’d
 = 
t
;

107 ià(
noÿ£
) {

108 
¡¬t
 = 
	`tŞow”
(start);

109 
’d
 = 
	`tŞow”
(end);

110 
c
 = 
	`tŞow”
(c);

112 
·‰”n
 += 2;

113 
·‰”nL’
 -= 2;

114 ià(
c
 >ğ
¡¬t
 && c <ğ
’d
)

115 
m©ch
 = 1;

117 ià(!
noÿ£
) {

118 ià(
·‰”n
[0] =ğ
¡ršg
[0])

119 
m©ch
 = 1;

121 ià(
	`tŞow”
(()
·‰”n
[0]è=ğtŞow”(()
¡ršg
[0]))

122 
m©ch
 = 1;

125 
·‰”n
++;

126 
·‰”nL’
--;

128 ià(
nÙ
)

129 
m©ch
 = !match;

130 ià(!
m©ch
)

132 
¡ršg
++;

133 
¡ršgL’
--;

137 ià(
·‰”nL’
 >= 2) {

138 
·‰”n
++;

139 
·‰”nL’
--;

143 ià(!
noÿ£
) {

144 ià(
·‰”n
[0] !ğ
¡ršg
[0])

147 ià(
	`tŞow”
(()
·‰”n
[0]è!ğtŞow”(()
¡ršg
[0]))

150 
¡ršg
++;

151 
¡ršgL’
--;

154 
·‰”n
++;

155 
·‰”nL’
--;

156 ià(
¡ršgL’
 == 0) {

157 *
·‰”n
 == '*') {

158 
·‰”n
++;

159 
·‰”nL’
--;

164 ià(
·‰”nL’
 =ğ0 && 
¡ršgL’
 == 0)

167 
	}
}

169 
	$¡ršgm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
noÿ£
) {

170  
	`¡ršgm©chËn
(
·‰”n
,
	`¡¾’
Õ©‹º),
¡ršg
,¡¾’(¡ršg),
noÿ£
);

171 
	}
}

180 
	$memtŞl
(cÚ¡ *
p
, *
”r
) {

181 cÚ¡ *
u
;

182 
buf
[128];

183 
mul
;

184 
v®
;

185 
dig™s
;

187 ià(
”r
) *err = 0;

190 
u
 = 
p
;

191 ià(*
u
 == '-') u++;

192 *
u
 && 
	`isdig™
(*u)) u++;

193 ià(*
u
 =ğ'\0' || !
	`¡rÿ£cmp
(u,"b")) {

194 
mul
 = 1;

195 } ià(!
	`¡rÿ£cmp
(
u
,"k")) {

196 
mul
 = 1000;

197 } ià(!
	`¡rÿ£cmp
(
u
,"kb")) {

198 
mul
 = 1024;

199 } ià(!
	`¡rÿ£cmp
(
u
,"m")) {

200 
mul
 = 1000*1000;

201 } ià(!
	`¡rÿ£cmp
(
u
,"mb")) {

202 
mul
 = 1024*1024;

203 } ià(!
	`¡rÿ£cmp
(
u
,"g")) {

204 
mul
 = 1000L*1000*1000;

205 } ià(!
	`¡rÿ£cmp
(
u
,"gb")) {

206 
mul
 = 1024L*1024*1024;

208 ià(
”r
) *err = 1;

214 
dig™s
 = 
u
-
p
;

215 ià(
dig™s
 >ğ(
buf
)) {

216 ià(
”r
) *err = 1;

219 
	`memıy
(
buf
,
p
,
dig™s
);

220 
buf
[
dig™s
] = '\0';

222 *
’d±r
;

223 
”ºo
 = 0;

224 
v®
 = 
	`¡¹Şl
(
buf
,&
’d±r
,10);

225 ià((
v®
 =ğ0 && 
”ºo
 =ğ
EINVAL
è|| *
’d±r
 != '\0') {

226 ià(
”r
) *err = 1;

229  
v®
*
mul
;

230 
	}
}

234 
ušt32_t
 
	$dig™s10
(
ušt64_t
 
v
) {

235 ià(
v
 < 10)  1;

236 ià(
v
 < 100)  2;

237 ià(
v
 < 1000)  3;

238 ià(
v
 < 1000000000000UL) {

239 ià(
v
 < 100000000UL) {

240 ià(
v
 < 1000000) {

241 ià(
v
 < 10000)  4;

242  5 + (
v
 >= 100000);

244  7 + (
v
 >= 10000000UL);

246 ià(
v
 < 10000000000UL) {

247  9 + (
v
 >= 1000000000UL);

249  11 + (
v
 >= 100000000000UL);

251  12 + 
	`dig™s10
(
v
 / 1000000000000UL);

252 
	}
}

265 
	$Î2¡ršg
(* 
d¡
, 
size_t
 
d¡Ën
, 
sv®ue
) {

266 cÚ¡ 
dig™s
[201] =

272 
Ãg©ive
;

273 
v®ue
;

277 ià(
sv®ue
 < 0) {

278 ià(
sv®ue
 !ğ
LLONG_MIN
) {

279 
v®ue
 = -
sv®ue
;

281 
v®ue
 = ((è
LLONG_MAX
)+1;

283 
Ãg©ive
 = 1;

285 
v®ue
 = 
sv®ue
;

286 
Ãg©ive
 = 0;

290 
ušt32_t
 cÚ¡ 
Ëngth
 = 
	`dig™s10
(
v®ue
)+
Ãg©ive
;

291 ià(
Ëngth
 >ğ
d¡Ën
)  0;

294 
ušt32_t
 
Ãxt
 = 
Ëngth
;

295 
d¡
[
Ãxt
] = '\0';

296 
Ãxt
--;

297 
v®ue
 >= 100) {

298 cÚ¡ 
i
 = (
v®ue
 % 100) * 2;

299 
v®ue
 /= 100;

300 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

301 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

302 
Ãxt
 -= 2;

306 ià(
v®ue
 < 10) {

307 
d¡
[
Ãxt
] = '0' + (
ušt32_t
è
v®ue
;

309 
i
 = (
ušt32_t
è
v®ue
 * 2;

310 
d¡
[
Ãxt
] = 
dig™s
[
i
 + 1];

311 
d¡
[
Ãxt
 - 1] = 
dig™s
[
i
];

315 ià(
Ãg©ive
è
d¡
[0] = '-';

316  
Ëngth
;

317 
	}
}

322 
	$¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
) {

323 cÚ¡ *
p
 = 
s
;

324 
size_t
 
¶’
 = 0;

325 
Ãg©ive
 = 0;

326 
v
;

328 ià(
¶’
 =ğ
¦’
)

332 ià(
¦’
 =ğ1 && 
p
[0] == '0') {

333 ià(
v®ue
 !ğ
NULL
) *value = 0;

337 ià(
p
[0] == '-') {

338 
Ãg©ive
 = 1;

339 
p
++; 
¶’
++;

342 ià(
¶’
 =ğ
¦’
)

347 ià(
p
[0] >= '1' &&…[0] <= '9') {

348 
v
 = 
p
[0]-'0';

349 
p
++; 
¶’
++;

350 } ià(
p
[0] =ğ'0' && 
¦’
 == 1) {

351 *
v®ue
 = 0;

357 
¶’
 < 
¦’
 && 
p
[0] >= '0' &&…[0] <= '9') {

358 ià(
v
 > (
ULLONG_MAX
 / 10))

360 
v
 *= 10;

362 ià(
v
 > (
ULLONG_MAX
 - (
p
[0]-'0')))

364 
v
 +ğ
p
[0]-'0';

366 
p
++; 
¶’
++;

370 ià(
¶’
 < 
¦’
)

373 ià(
Ãg©ive
) {

374 ià(
v
 > (()(-(
LLONG_MIN
+1))+1))

376 ià(
v®ue
 !ğ
NULL
è*v®uğ-
v
;

378 ià(
v
 > 
LLONG_MAX
)

380 ià(
v®ue
 !ğ
NULL
è*v®uğ
v
;

383 
	}
}

388 
	$¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
lv®
) {

389 
Îv®
;

391 ià(!
	`¡ršg2Î
(
s
,
¦’
,&
Îv®
))

394 ià(
Îv®
 < 
LONG_MIN
 ||†lv® > 
LONG_MAX
)

397 *
lv®
 = ()
Îv®
;

399 
	}
}

403 
	$d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
) {

404 ià(
	`i¢ª
(
v®ue
)) {

405 
Ën
 = 
	`¢´štf
(
buf
,len,"nan");

406 } ià(
	`isšf
(
v®ue
)) {

407 ià(
v®ue
 < 0)

408 
Ën
 = 
	`¢´štf
(
buf
,len,"-inf");

410 
Ën
 = 
	`¢´štf
(
buf
,len,"inf");

411 } ià(
v®ue
 == 0) {

413 ià(1.0/
v®ue
 < 0)

414 
Ën
 = 
	`¢´štf
(
buf
,len,"-0");

416 
Ën
 = 
	`¢´štf
(
buf
,len,"0");

418 #ià(
DBL_MANT_DIG
 >ğ52è&& (
LLONG_MAX
 == 0x7fffffffffffffffLL)

428 
mš
 = -4503599627370495;

429 
max
 = 4503599627370496;

430 ià(
v®ue
 > 
mš
 && v®u< 
max
 && value == (()(()value)))

431 
Ën
 = 
	`Î2¡ršg
(
buf
,Ën,()
v®ue
);

434 
Ën
 = 
	`¢´štf
(
buf
,Ën,"%.17g",
v®ue
);

437  
Ën
;

438 
	}
}

444 
	$g‘RªdomHexCh¬s
(*
p
, 
Ën
) {

445 *
ch¬£t
 = "0123456789abcdef";

446 
j
;

449 
£ed_š™Ÿlized
 = 0;

450 
£ed
[20];

451 
ušt64_t
 
couÁ”
 = 0;

453 ià(!
£ed_š™Ÿlized
) {

458 
FILE
 *
å
 = 
	`fİ’
("/dev/urandom","r");

459 ià(
å
 && 
	`ä—d
(
£ed
,(seed),1,fp) == 1)

460 
£ed_š™Ÿlized
 = 1;

461 ià(
å
è
	`fşo£
(fp);

464 ià(
£ed_š™Ÿlized
) {

465 
Ën
) {

466 
dige¡
[20];

467 
SHA1_CTX
 
ùx
;

468 
cİyËn
 = 
Ën
 > 20 ? 20 :†en;

470 
	`SHA1In™
(&
ùx
);

471 
	`SHA1Upd©e
(&
ùx
, 
£ed
, (seed));

472 
	`SHA1Upd©e
(&
ùx
, (*)&
couÁ”
,(counter));

473 
	`SHA1Fš®
(
dige¡
, &
ùx
);

474 
couÁ”
++;

476 
	`memıy
(
p
,
dige¡
,
cİyËn
);

478 
j
 = 0; j < 
cİyËn
; j++è
p
[j] = 
ch¬£t
[p[j] & 0x0F];

479 
Ën
 -ğ
cİyËn
;

480 
p
 +ğ
cİyËn
;

486 *
x
 = 
p
;

487 
l
 = 
Ën
;

488 
timev®
 
tv
;

489 
pid_t
 
pid
 = 
	`g‘pid
();

492 
	`g‘timeofday
(&
tv
,
NULL
);

493 ià(
l
 >ğ(
tv
.
tv_u£c
)) {

494 
	`memıy
(
x
,&
tv
.
tv_u£c
,(tv.tv_usec));

495 
l
 -ğ(
tv
.
tv_u£c
);

496 
x
 +ğ(
tv
.
tv_u£c
);

498 ià(
l
 >ğ(
tv
.
tv_£c
)) {

499 
	`memıy
(
x
,&
tv
.
tv_£c
,(tv.tv_sec));

500 
l
 -ğ(
tv
.
tv_£c
);

501 
x
 +ğ(
tv
.
tv_£c
);

503 ià(
l
 >ğ(
pid
)) {

504 
	`memıy
(
x
,&
pid
,(pid));

505 
l
 -ğ(
pid
);

506 
x
 +ğ(
pid
);

510 
j
 = 0; j < 
Ën
; j++) {

511 
p
[
j
] ^ğ
	`¿nd
();

512 
p
[
j
] = 
ch¬£t
[p[j] & 0x0F];

515 
	}
}

524 
sds
 
	$g‘AbsŞu‹P©h
(*
f’ame
) {

525 
cwd
[1024];

526 
sds
 
ab¥©h
;

527 
sds
 
»Í©h
 = 
	`sd¢ew
(
f’ame
);

529 
»Í©h
 = 
	`sd¡rim
(relpath," \r\n\t");

530 ià(
»Í©h
[0] == '/') „elpath;

533 ià(
	`g‘cwd
(
cwd
,(cwd)è=ğ
NULL
) {

534 
	`sdsä“
(
»Í©h
);

535  
NULL
;

537 
ab¥©h
 = 
	`sd¢ew
(
cwd
);

538 ià(
	`sd¦’
(
ab¥©h
) &&‡bspath[sdslen(abspath)-1] != '/')

539 
ab¥©h
 = 
	`sdsÿt
(abspath,"/");

547 
	`sd¦’
(
»Í©h
) >= 3 &&

548 
»Í©h
[0] == '.' &&„elpath[1] == '.' &&„elpath[2] == '/')

550 
	`sd¤ªge
(
»Í©h
,3,-1);

551 ià(
	`sd¦’
(
ab¥©h
) > 1) {

552 *
p
 = 
ab¥©h
 + 
	`sd¦’
(abspath)-2;

553 
ŒimËn
 = 1;

555 *
p
 != '/') {

556 
p
--;

557 
ŒimËn
++;

559 
	`sd¤ªge
(
ab¥©h
,0,-(
ŒimËn
+1));

564 
ab¥©h
 = 
	`sdsÿtsds
×b¥©h,
»Í©h
);

565 
	`sdsä“
(
»Í©h
);

566  
ab¥©h
;

567 
	}
}

573 
	$·thIsBa£Name
(*
·th
) {

574  
	`¡rchr
(
·th
,'/'è=ğ
NULL
 && strchr(path,'\\') == NULL;

575 
	}
}

577 #ifdeà
UTIL_TEST_MAIN


578 
	~<as£¹.h
>

580 
	$‹¡_¡ršg2Î
() {

581 
buf
[32];

582 
v
;

585 
	`¡rıy
(
buf
,"+1");

586 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

589 
	`¡rıy
(
buf
," 1");

590 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

593 
	`¡rıy
(
buf
,"1 ");

594 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

597 
	`¡rıy
(
buf
,"01");

598 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

600 
	`¡rıy
(
buf
,"-1");

601 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

602 
	`as£¹
(
v
 == -1);

604 
	`¡rıy
(
buf
,"0");

605 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

606 
	`as£¹
(
v
 == 0);

608 
	`¡rıy
(
buf
,"1");

609 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

610 
	`as£¹
(
v
 == 1);

612 
	`¡rıy
(
buf
,"99");

613 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

614 
	`as£¹
(
v
 == 99);

616 
	`¡rıy
(
buf
,"-99");

617 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

618 
	`as£¹
(
v
 == -99);

620 
	`¡rıy
(
buf
,"-9223372036854775808");

621 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

622 
	`as£¹
(
v
 =ğ
LLONG_MIN
);

624 
	`¡rıy
(
buf
,"-9223372036854775809");

625 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

627 
	`¡rıy
(
buf
,"9223372036854775807");

628 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

629 
	`as£¹
(
v
 =ğ
LLONG_MAX
);

631 
	`¡rıy
(
buf
,"9223372036854775808");

632 
	`as£¹
(
	`¡ršg2Î
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

633 
	}
}

635 
	$‹¡_¡ršg2l
() {

636 
buf
[32];

637 
v
;

640 
	`¡rıy
(
buf
,"+1");

641 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

644 
	`¡rıy
(
buf
,"01");

645 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

647 
	`¡rıy
(
buf
,"-1");

648 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

649 
	`as£¹
(
v
 == -1);

651 
	`¡rıy
(
buf
,"0");

652 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

653 
	`as£¹
(
v
 == 0);

655 
	`¡rıy
(
buf
,"1");

656 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

657 
	`as£¹
(
v
 == 1);

659 
	`¡rıy
(
buf
,"99");

660 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

661 
	`as£¹
(
v
 == 99);

663 
	`¡rıy
(
buf
,"-99");

664 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

665 
	`as£¹
(
v
 == -99);

667 #ià
LONG_MAX
 !ğ
LLONG_MAX


668 
	`¡rıy
(
buf
,"-2147483648");

669 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

670 
	`as£¹
(
v
 =ğ
LONG_MIN
);

672 
	`¡rıy
(
buf
,"-2147483649");

673 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

675 
	`¡rıy
(
buf
,"2147483647");

676 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 1);

677 
	`as£¹
(
v
 =ğ
LONG_MAX
);

679 
	`¡rıy
(
buf
,"2147483648");

680 
	`as£¹
(
	`¡ršg2l
(
buf
,
	`¡¾’
(buf),&
v
) == 0);

682 
	}
}

684 
	$maš
(
¬gc
, **
¬gv
) {

685 
	`‹¡_¡ršg2Î
();

686 
	`‹¡_¡ršg2l
();

688 
	}
}

	@util.h

30 #iâdeà
__REDIS_UTIL_H


31 
	#__REDIS_UTIL_H


	)

33 
	~"sds.h
"

35 
¡ršgm©chËn
(cÚ¡ *
p
, 
¶’
, cÚ¡ *
s
, 
¦’
, 
noÿ£
);

36 
¡ršgm©ch
(cÚ¡ *
p
, cÚ¡ *
s
, 
noÿ£
);

37 
memtŞl
(cÚ¡ *
p
, *
”r
);

38 
Î2¡ršg
(*
s
, 
size_t
 
Ën
, 
v®ue
);

39 
¡ršg2Î
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

40 
¡ršg2l
(cÚ¡ *
s
, 
size_t
 
¦’
, *
v®ue
);

41 
d2¡ršg
(*
buf
, 
size_t
 
Ën
, 
v®ue
);

42 
sds
 
g‘AbsŞu‹P©h
(*
f’ame
);

43 
·thIsBa£Name
(*
·th
);

	@version.h

1 
	#REDIS_VERSION
 "3.0.0"

	)

	@ziplist.c

104 
	~<¡dio.h
>

105 
	~<¡dlib.h
>

106 
	~<¡ršg.h
>

107 
	~<¡dšt.h
>

108 
	~<lim™s.h
>

109 
	~"zm®loc.h
"

110 
	~"ut.h
"

111 
	~"zli¡.h
"

112 
	~"’dŸncÚv.h
"

113 
	~"»di§s£¹.h
"

115 
	#ZIP_END
 255

	)

116 
	#ZIP_BIGLEN
 254

	)

119 
	#ZIP_STR_MASK
 0xc0

	)

120 
	#ZIP_INT_MASK
 0x30

	)

121 
	#ZIP_STR_06B
 (0 << 6)

	)

122 
	#ZIP_STR_14B
 (1 << 6)

	)

123 
	#ZIP_STR_32B
 (2 << 6)

	)

124 
	#ZIP_INT_16B
 (0xc0 | 0<<4)

	)

125 
	#ZIP_INT_32B
 (0xc0 | 1<<4)

	)

126 
	#ZIP_INT_64B
 (0xc0 | 2<<4)

	)

127 
	#ZIP_INT_24B
 (0xc0 | 3<<4)

	)

128 
	#ZIP_INT_8B
 0xã

	)

130 
	#ZIP_INT_IMM_MASK
 0x0f

	)

131 
	#ZIP_INT_IMM_MIN
 0xf1

	)

132 
	#ZIP_INT_IMM_MAX
 0xfd

	)

133 
	#ZIP_INT_IMM_VAL
(
v
è(v & 
ZIP_INT_IMM_MASK
)

	)

135 
	#INT24_MAX
 0x7fffff

	)

136 
	#INT24_MIN
 (-
INT24_MAX
 - 1)

	)

139 
	#ZIP_IS_STR
(
’c
è((Óncè& 
ZIP_STR_MASK
è< ZIP_STR_MASK)

	)

142 
	#ZIPLIST_BYTES
(
zl
è(*((
ušt32_t
*)(zl)))

	)

143 
	#ZIPLIST_TAIL_OFFSET
(
zl
è(*((
ušt32_t
*)((zl)+(ušt32_t))))

	)

144 
	#ZIPLIST_LENGTH
(
zl
è(*((
ušt16_t
*)((zl)+(
ušt32_t
)*2)))

	)

145 
	#ZIPLIST_HEADER_SIZE
 ((
ušt32_t
)*2+(
ušt16_t
))

	)

146 
	#ZIPLIST_ENTRY_HEAD
(
zl
è((zl)+
ZIPLIST_HEADER_SIZE
)

	)

147 
	#ZIPLIST_ENTRY_TAIL
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl)))

	)

148 
	#ZIPLIST_ENTRY_END
(
zl
è((zl)+
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-1)

	)

152 
	#ZIPLIST_INCR_LENGTH
(
zl
,
šü
) { \

153 ià(
	`ZIPLIST_LENGTH
(
zl
è< 
UINT16_MAX
) \

154 
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(šŒev16ifbe(ZIPLIST_LENGTH(zl))+
šü
); \

155 }

	)

157 
	szËÁry
 {

158 
	m´ev¿wËnsize
, 
	m´ev¿wËn
;

159 
	mËnsize
, 
	mËn
;

160 
	mh—d”size
;

161 
	m’codšg
;

162 *
	mp
;

163 } 
	tzËÁry
;

167 
	#ZIP_ENTRY_ENCODING
(
±r
, 
’codšg
) do { \

168 (
’codšg
èğ(
±r
[0]); \

169 ià((
’codšg
è< 
ZIP_STR_MASK
) (encoding) &= ZIP_STR_MASK; \

170 } 0)

	)

173 
	$zIÁSize
(
’codšg
) {

174 
’codšg
) {

175 
ZIP_INT_8B
:  1;

176 
ZIP_INT_16B
:  2;

177 
ZIP_INT_24B
:  3;

178 
ZIP_INT_32B
:  4;

179 
ZIP_INT_64B
:  8;

182 
	`as£¹
(
NULL
);

184 
	}
}

188 
	$zEncodeL’gth
(*
p
, 
’codšg
, 
¿wËn
) {

189 
Ën
 = 1, 
buf
[5];

191 ià(
	`ZIP_IS_STR
(
’codšg
)) {

194 ià(
¿wËn
 <= 0x3f) {

195 ià(!
p
è 
Ën
;

196 
buf
[0] = 
ZIP_STR_06B
 | 
¿wËn
;

197 } ià(
¿wËn
 <= 0x3fff) {

198 
Ën
 += 1;

199 ià(!
p
è 
Ën
;

200 
buf
[0] = 
ZIP_STR_14B
 | ((
¿wËn
 >> 8) & 0x3f);

201 
buf
[1] = 
¿wËn
 & 0xff;

203 
Ën
 += 4;

204 ià(!
p
è 
Ën
;

205 
buf
[0] = 
ZIP_STR_32B
;

206 
buf
[1] = (
¿wËn
 >> 24) & 0xff;

207 
buf
[2] = (
¿wËn
 >> 16) & 0xff;

208 
buf
[3] = (
¿wËn
 >> 8) & 0xff;

209 
buf
[4] = 
¿wËn
 & 0xff;

213 ià(!
p
è 
Ën
;

214 
buf
[0] = 
’codšg
;

218 
	`memıy
(
p
,
buf
,
Ën
);

219  
Ën
;

220 
	}
}

226 
	#ZIP_DECODE_LENGTH
(
±r
, 
’codšg
, 
Ënsize
, 
Ën
) do { \

227 
	`ZIP_ENTRY_ENCODING
((
±r
), (
’codšg
)); \

228 ià((
’codšg
è< 
ZIP_STR_MASK
) { \

229 ià((
’codšg
è=ğ
ZIP_STR_06B
) { \

230 (
Ënsize
) = 1; \

231 (
Ën
èğ(
±r
)[0] & 0x3f; \

232 } ià((
’codšg
è=ğ
ZIP_STR_14B
) { \

233 (
Ënsize
) = 2; \

234 (
Ën
èğ(((
±r
)[0] & 0x3f) << 8) | (ptr)[1]; \

235 } ià(
’codšg
 =ğ
ZIP_STR_32B
) { \

236 (
Ënsize
) = 5; \

237 (
Ën
èğ((
±r
)[1] << 24) | \

238 ((
±r
)[2] << 16) | \

239 ((
±r
)[3] << 8) | \

240 ((
±r
)[4]); \

242 
	`as£¹
(
NULL
); \

245 (
Ënsize
) = 1; \

246 (
Ën
èğ
	`zIÁSize
(
’codšg
); \

248 } 0);

	)

252 
	$zP»vEncodeL’gth
(*
p
, 
Ën
) {

253 ià(
p
 =ğ
NULL
) {

254  (
Ën
 < 
ZIP_BIGLEN
) ? 1 : (len)+1;

256 ià(
Ën
 < 
ZIP_BIGLEN
) {

257 
p
[0] = 
Ën
;

260 
p
[0] = 
ZIP_BIGLEN
;

261 
	`memıy
(
p
+1,&
Ën
,(len));

262 
	`mem»v32ifbe
(
p
+1);

263  1+(
Ën
);

266 
	}
}

270 
	$zP»vEncodeL’gthFÜûL¬ge
(*
p
, 
Ën
) {

271 ià(
p
 =ğ
NULL
) ;

272 
p
[0] = 
ZIP_BIGLEN
;

273 
	`memıy
(
p
+1,&
Ën
,(len));

274 
	`mem»v32ifbe
(
p
+1);

275 
	}
}

279 
	#ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
) do { \

280 ià((
±r
)[0] < 
ZIP_BIGLEN
) { \

281 (
´evËnsize
) = 1; \

283 (
´evËnsize
) = 5; \

285 } 0);

	)

289 
	#ZIP_DECODE_PREVLEN
(
±r
, 
´evËnsize
, 
´evËn
) do { \

290 
	`ZIP_DECODE_PREVLENSIZE
(
±r
, 
´evËnsize
); \

291 ià((
´evËnsize
) == 1) { \

292 (
´evËn
èğ(
±r
)[0]; \

293 } ià((
´evËnsize
) == 5) { \

294 
	`as£¹
(((
´evËnsize
)) == 4); \

295 
	`memıy
(&(
´evËn
), ((*)(
±r
)) + 1, 4); \

296 
	`mem»v32ifbe
(&
´evËn
); \

298 } 0);

	)

302 
	$zP»vL’By‹Diff
(*
p
, 
Ën
) {

303 
´evËnsize
;

304 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

305  
	`zP»vEncodeL’gth
(
NULL
, 
Ën
è- 
´evËnsize
;

306 
	}
}

309 
	$zRawEÁryL’gth
(*
p
) {

310 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

311 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

312 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

313  
´evËnsize
 + 
Ënsize
 + 
Ën
;

314 
	}
}

318 
	$zTryEncodšg
(*
’Œy
, 
’ŒyËn
, *
v
, *
’codšg
) {

319 
v®ue
;

321 ià(
’ŒyËn
 >= 32 ||ƒntrylen == 0)  0;

322 ià(
	`¡ršg2Î
((*)
’Œy
,
’ŒyËn
,&
v®ue
)) {

325 ià(
v®ue
 >= 0 && value <= 12) {

326 *
’codšg
 = 
ZIP_INT_IMM_MIN
+
v®ue
;

327 } ià(
v®ue
 >ğ
INT8_MIN
 && v®u<ğ
INT8_MAX
) {

328 *
’codšg
 = 
ZIP_INT_8B
;

329 } ià(
v®ue
 >ğ
INT16_MIN
 && v®u<ğ
INT16_MAX
) {

330 *
’codšg
 = 
ZIP_INT_16B
;

331 } ià(
v®ue
 >ğ
INT24_MIN
 && v®u<ğ
INT24_MAX
) {

332 *
’codšg
 = 
ZIP_INT_24B
;

333 } ià(
v®ue
 >ğ
INT32_MIN
 && v®u<ğ
INT32_MAX
) {

334 *
’codšg
 = 
ZIP_INT_32B
;

336 *
’codšg
 = 
ZIP_INT_64B
;

338 *
v
 = 
v®ue
;

342 
	}
}

345 
	$zSaveIÁeg”
(*
p
, 
št64_t
 
v®ue
, 
’codšg
) {

346 
št16_t
 
i16
;

347 
št32_t
 
i32
;

348 
št64_t
 
i64
;

349 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

350 ((
št8_t
*)
p
)[0] = (št8_t)
v®ue
;

351 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

352 
i16
 = 
v®ue
;

353 
	`memıy
(
p
,&
i16
,(i16));

354 
	`mem»v16ifbe
(
p
);

355 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

356 
i32
 = 
v®ue
<<8;

357 
	`mem»v32ifbe
(&
i32
);

358 
	`memıy
(
p
,((
ušt8_t
*)&
i32
)+1,(i32)-(uint8_t));

359 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

360 
i32
 = 
v®ue
;

361 
	`memıy
(
p
,&
i32
,(i32));

362 
	`mem»v32ifbe
(
p
);

363 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

364 
i64
 = 
v®ue
;

365 
	`memıy
(
p
,&
i64
,(i64));

366 
	`mem»v64ifbe
(
p
);

367 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

370 
	`as£¹
(
NULL
);

372 
	}
}

375 
št64_t
 
	$zLßdIÁeg”
(*
p
, 
’codšg
) {

376 
št16_t
 
i16
;

377 
št32_t
 
i32
;

378 
št64_t
 
i64
, 
»t
 = 0;

379 ià(
’codšg
 =ğ
ZIP_INT_8B
) {

380 
»t
 = ((
št8_t
*)
p
)[0];

381 } ià(
’codšg
 =ğ
ZIP_INT_16B
) {

382 
	`memıy
(&
i16
,
p
,(i16));

383 
	`mem»v16ifbe
(&
i16
);

384 
»t
 = 
i16
;

385 } ià(
’codšg
 =ğ
ZIP_INT_32B
) {

386 
	`memıy
(&
i32
,
p
,(i32));

387 
	`mem»v32ifbe
(&
i32
);

388 
»t
 = 
i32
;

389 } ià(
’codšg
 =ğ
ZIP_INT_24B
) {

390 
i32
 = 0;

391 
	`memıy
(((
ušt8_t
*)&
i32
)+1,
p
,(i32)-(uint8_t));

392 
	`mem»v32ifbe
(&
i32
);

393 
»t
 = 
i32
>>8;

394 } ià(
’codšg
 =ğ
ZIP_INT_64B
) {

395 
	`memıy
(&
i64
,
p
,(i64));

396 
	`mem»v64ifbe
(&
i64
);

397 
»t
 = 
i64
;

398 } ià(
’codšg
 >ğ
ZIP_INT_IMM_MIN
 &&ƒncodšg <ğ
ZIP_INT_IMM_MAX
) {

399 
»t
 = (
’codšg
 & 
ZIP_INT_IMM_MASK
)-1;

401 
	`as£¹
(
NULL
);

403  
»t
;

404 
	}
}

407 
zËÁry
 
	$zEÁry
(*
p
) {

408 
zËÁry
 
e
;

410 
	`ZIP_DECODE_PREVLEN
(
p
, 
e
.
´ev¿wËnsize
,ƒ.
´ev¿wËn
);

411 
	`ZIP_DECODE_LENGTH
(
p
 + 
e
.
´ev¿wËnsize
,ƒ.
’codšg
,ƒ.
Ënsize
,ƒ.
Ën
);

412 
e
.
h—d”size
 =ƒ.
´ev¿wËnsize
 +ƒ.
Ënsize
;

413 
e
.
p
 =…;

414  
e
;

415 
	}
}

418 *
	$zli¡New
() {

419 
by‹s
 = 
ZIPLIST_HEADER_SIZE
+1;

420 *
zl
 = 
	`zm®loc
(
by‹s
);

421 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
by‹s
);

422 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
ZIPLIST_HEADER_SIZE
);

423 
	`ZIPLIST_LENGTH
(
zl
) = 0;

424 
zl
[
by‹s
-1] = 
ZIP_END
;

425  
zl
;

426 
	}
}

429 *
	$zli¡Resize
(*
zl
, 
Ën
) {

430 
zl
 = 
	`z»®loc
(zl,
Ën
);

431 
	`ZIPLIST_BYTES
(
zl
èğ
	`šŒev32ifbe
(
Ën
);

432 
zl
[
Ën
-1] = 
ZIP_END
;

433  
zl
;

434 
	}
}

456 *
	$__zli¡CasÿdeUpd©e
(*
zl
, *
p
) {

457 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
¿wËn
, 
¿wËnsize
;

458 
size_t
 
off£t
, 
noff£t
, 
exŒa
;

459 *
Å
;

460 
zËÁry
 
cur
, 
Ãxt
;

462 
p
[0] !ğ
ZIP_END
) {

463 
cur
 = 
	`zEÁry
(
p
);

464 
¿wËn
 = 
cur
.
h—d”size
 + cur.
Ën
;

465 
¿wËnsize
 = 
	`zP»vEncodeL’gth
(
NULL
,
¿wËn
);

468 ià(
p
[
¿wËn
] =ğ
ZIP_END
) ;

469 
Ãxt
 = 
	`zEÁry
(
p
+
¿wËn
);

472 ià(
Ãxt
.
´ev¿wËn
 =ğ
¿wËn
) ;

474 ià(
Ãxt
.
´ev¿wËnsize
 < 
¿wËnsize
) {

477 
off£t
 = 
p
-
zl
;

478 
exŒa
 = 
¿wËnsize
-
Ãxt
.
´ev¿wËnsize
;

479 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
exŒa
);

480 
p
 = 
zl
+
off£t
;

483 
Å
 = 
p
+
¿wËn
;

484 
noff£t
 = 
Å
-
zl
;

487 ià((
zl
+
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(zl))è!ğ
Å
) {

488 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

489 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
exŒa
);

493 
	`memmove
(
Å
+
¿wËnsize
,

494 
Å
+
Ãxt
.
´ev¿wËnsize
,

495 
cu¾’
-
noff£t
-
Ãxt
.
´ev¿wËnsize
-1);

496 
	`zP»vEncodeL’gth
(
Å
,
¿wËn
);

499 
p
 +ğ
¿wËn
;

500 
cu¾’
 +ğ
exŒa
;

502 ià(
Ãxt
.
´ev¿wËnsize
 > 
¿wËnsize
) {

505 
	`zP»vEncodeL’gthFÜûL¬ge
(
p
+
¿wËn
,rawlen);

507 
	`zP»vEncodeL’gth
(
p
+
¿wËn
,rawlen);

514  
zl
;

515 
	}
}

518 *
	$__zli¡D–‘e
(*
zl
, *
p
, 
num
) {

519 
i
, 
tÙËn
, 
d–‘ed
 = 0;

520 
size_t
 
off£t
;

521 
Ãxtdiff
 = 0;

522 
zËÁry
 
fœ¡
, 

;

524 
fœ¡
 = 
	`zEÁry
(
p
);

525 
i
 = 0; 
p
[0] !ğ
ZIP_END
 && i < 
num
; i++) {

526 
p
 +ğ
	`zRawEÁryL’gth
(p);

527 
d–‘ed
++;

530 
tÙËn
 = 
p
-
fœ¡
.p;

531 ià(
tÙËn
 > 0) {

532 ià(
p
[0] !ğ
ZIP_END
) {

537 
Ãxtdiff
 = 
	`zP»vL’By‹Diff
(
p
,
fœ¡
.
´ev¿wËn
);

538 
p
 -ğ
Ãxtdiff
;

539 
	`zP»vEncodeL’gth
(
p
,
fœ¡
.
´ev¿wËn
);

542 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

543 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))-
tÙËn
);

548 

 = 
	`zEÁry
(
p
);

549 ià(
p
[

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

550 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

551 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

555 
	`memmove
(
fœ¡
.
p
,p,

556 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
))-(
p
-zl)-1);

559 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

560 
	`šŒev32ifbe
((
fœ¡
.
p
-
zl
)-fœ¡.
´ev¿wËn
);

564 
off£t
 = 
fœ¡
.
p
-
zl
;

565 
zl
 = 
	`zli¡Resize
(zl, 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(zl))-
tÙËn
+
Ãxtdiff
);

566 
	`ZIPLIST_INCR_LENGTH
(
zl
,-
d–‘ed
);

567 
p
 = 
zl
+
off£t
;

571 ià(
Ãxtdiff
 != 0)

572 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
);

574  
zl
;

575 
	}
}

578 *
	$__zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

579 
size_t
 
cu¾’
 = 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)), 
»qËn
;

580 
´evËnsize
, 
´evËn
 = 0;

581 
size_t
 
off£t
;

582 
Ãxtdiff
 = 0;

583 
’codšg
 = 0;

584 
v®ue
 = 123456789;

587 
zËÁry
 

;

590 ià(
p
[0] !ğ
ZIP_END
) {

591 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

593 *
±a
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

594 ià(
±a
[0] !ğ
ZIP_END
) {

595 
´evËn
 = 
	`zRawEÁryL’gth
(
±a
);

600 ià(
	`zTryEncodšg
(
s
,
¦’
,&
v®ue
,&
’codšg
)) {

602 
»qËn
 = 
	`zIÁSize
(
’codšg
);

606 
»qËn
 = 
¦’
;

610 
»qËn
 +ğ
	`zP»vEncodeL’gth
(
NULL
,
´evËn
);

611 
»qËn
 +ğ
	`zEncodeL’gth
(
NULL
,
’codšg
,
¦’
);

616 
Ãxtdiff
 = (
p
[0] !ğ
ZIP_END
è? 
	`zP»vL’By‹Diff
Õ,
»qËn
) : 0;

619 
off£t
 = 
p
-
zl
;

620 
zl
 = 
	`zli¡Resize
(zl,
cu¾’
+
»qËn
+
Ãxtdiff
);

621 
p
 = 
zl
+
off£t
;

624 ià(
p
[0] !ğ
ZIP_END
) {

626 
	`memmove
(
p
+
»qËn
,p-
Ãxtdiff
,
cu¾’
-
off£t
-1+nextdiff);

629 
	`zP»vEncodeL’gth
(
p
+
»qËn
,reqlen);

632 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

633 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
»qËn
);

638 

 = 
	`zEÁry
(
p
+
»qËn
);

639 ià(
p
[
»qËn
+

.
h—d”size
+.
Ën
] !ğ
ZIP_END
) {

640 
	`ZIPLIST_TAIL_OFFSET
(
zl
) =

641 
	`šŒev32ifbe
(šŒev32ifbe(
	`ZIPLIST_TAIL_OFFSET
(
zl
))+
Ãxtdiff
);

645 
	`ZIPLIST_TAIL_OFFSET
(
zl
èğ
	`šŒev32ifbe
(
p
-zl);

650 ià(
Ãxtdiff
 != 0) {

651 
off£t
 = 
p
-
zl
;

652 
zl
 = 
	`__zli¡CasÿdeUpd©e
(zl,
p
+
»qËn
);

653 
p
 = 
zl
+
off£t
;

657 
p
 +ğ
	`zP»vEncodeL’gth
Õ,
´evËn
);

658 
p
 +ğ
	`zEncodeL’gth
Õ,
’codšg
,
¦’
);

659 ià(
	`ZIP_IS_STR
(
’codšg
)) {

660 
	`memıy
(
p
,
s
,
¦’
);

662 
	`zSaveIÁeg”
(
p
,
v®ue
,
’codšg
);

664 
	`ZIPLIST_INCR_LENGTH
(
zl
,1);

665  
zl
;

666 
	}
}

668 *
	$zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
) {

669 *
p
;

670 
p
 = (
wh”e
 =ğ
ZIPLIST_HEAD
è? 
	`ZIPLIST_ENTRY_HEAD
(
zl
è: 
	`ZIPLIST_ENTRY_END
(zl);

671  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

672 
	}
}

677 *
	$zli¡Index
(*
zl
, 
šdex
) {

678 *
p
;

679 
´evËnsize
, 
´evËn
 = 0;

680 ià(
šdex
 < 0) {

681 
šdex
 = (-index)-1;

682 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

683 ià(
p
[0] !ğ
ZIP_END
) {

684 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

685 
´evËn
 > 0 && 
šdex
--) {

686 
p
 -ğ
´evËn
;

687 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

691 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

692 
p
[0] !ğ
ZIP_END
 && 
šdex
--) {

693 
p
 +ğ
	`zRawEÁryL’gth
(p);

696  (
p
[0] =ğ
ZIP_END
 || 
šdex
 > 0è? 
NULL
 :…;

697 
	}
}

705 *
	$zli¡Next
(*
zl
, *
p
) {

706 ((è
zl
);

711 ià(
p
[0] =ğ
ZIP_END
) {

712  
NULL
;

715 
p
 +ğ
	`zRawEÁryL’gth
(p);

716 ià(
p
[0] =ğ
ZIP_END
) {

717  
NULL
;

720  
p
;

721 
	}
}

724 *
	$zli¡P»v
(*
zl
, *
p
) {

725 
´evËnsize
, 
´evËn
 = 0;

730 ià(
p
[0] =ğ
ZIP_END
) {

731 
p
 = 
	`ZIPLIST_ENTRY_TAIL
(
zl
);

732  (
p
[0] =ğ
ZIP_END
è? 
NULL
 :…;

733 } ià(
p
 =ğ
	`ZIPLIST_ENTRY_HEAD
(
zl
)) {

734  
NULL
;

736 
	`ZIP_DECODE_PREVLEN
(
p
, 
´evËnsize
, 
´evËn
);

737 
	`as£¹
(
´evËn
 > 0);

738  
p
-
´evËn
;

740 
	}
}

746 
	$zli¡G‘
(*
p
, **
s¡r
, *
¦’
, *
sv®
) {

747 
zËÁry
 
’Œy
;

748 ià(
p
 =ğ
NULL
 ||…[0] =ğ
ZIP_END
)  0;

749 ià(
s¡r
è*s¡¸ğ
NULL
;

751 
’Œy
 = 
	`zEÁry
(
p
);

752 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

753 ià(
s¡r
) {

754 *
¦’
 = 
’Œy
.
Ën
;

755 *
s¡r
 = 
p
+
’Œy
.
h—d”size
;

758 ià(
sv®
) {

759 *
sv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

763 
	}
}

766 *
	$zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
) {

767  
	`__zli¡In£¹
(
zl
,
p
,
s
,
¦’
);

768 
	}
}

773 *
	$zli¡D–‘e
(*
zl
, **
p
) {

774 
size_t
 
off£t
 = *
p
-
zl
;

775 
zl
 = 
	`__zli¡D–‘e
(zl,*
p
,1);

781 *
p
 = 
zl
+
off£t
;

782  
zl
;

783 
	}
}

786 *
	$zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
) {

787 *
p
 = 
	`zli¡Index
(
zl
,
šdex
);

788  (
p
 =ğ
NULL
è? 
zl
 : 
	`__zli¡D–‘e
(zl,p,
num
);

789 
	}
}

793 
	$zli¡Com·»
(*
p
, *
s¡r
, 
¦’
) {

794 
zËÁry
 
’Œy
;

795 
£ncodšg
;

796 
zv®
, 
sv®
;

797 ià(
p
[0] =ğ
ZIP_END
)  0;

799 
’Œy
 = 
	`zEÁry
(
p
);

800 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

802 ià(
’Œy
.
Ën
 =ğ
¦’
) {

803  
	`memcmp
(
p
+
’Œy
.
h—d”size
,
s¡r
,
¦’
) == 0;

810 ià(
	`zTryEncodšg
(
s¡r
,
¦’
,&
sv®
,&
£ncodšg
)) {

811 
zv®
 = 
	`zLßdIÁeg”
(
p
+
’Œy
.
h—d”size
,’Œy.
’codšg
);

812  
zv®
 =ğ
sv®
;

816 
	}
}

820 *
	$zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
) {

821 
skút
 = 0;

822 
v’codšg
 = 0;

823 
vÎ
 = 0;

825 
p
[0] !ğ
ZIP_END
) {

826 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
;

827 *
q
;

829 
	`ZIP_DECODE_PREVLENSIZE
(
p
, 
´evËnsize
);

830 
	`ZIP_DECODE_LENGTH
(
p
 + 
´evËnsize
, 
’codšg
, 
Ënsize
, 
Ën
);

831 
q
 = 
p
 + 
´evËnsize
 + 
Ënsize
;

833 ià(
skút
 == 0) {

835 ià(
	`ZIP_IS_STR
(
’codšg
)) {

836 ià(
Ën
 =ğ
vËn
 && 
	`memcmp
(
q
, 
v¡r
, vlen) == 0) {

837  
p
;

843 ià(
v’codšg
 == 0) {

844 ià(!
	`zTryEncodšg
(
v¡r
, 
vËn
, &
vÎ
, &
v’codšg
)) {

848 
v’codšg
 = 
UCHAR_MAX
;

851 
	`as£¹
(
v’codšg
);

857 ià(
v’codšg
 !ğ
UCHAR_MAX
) {

858 
Î
 = 
	`zLßdIÁeg”
(
q
, 
’codšg
);

859 ià(
Î
 =ğ
vÎ
) {

860  
p
;

866 
skút
 = 
sk
;

869 
skút
--;

873 
p
 = 
q
 + 
Ën
;

876  
NULL
;

877 
	}
}

880 
	$zli¡L’
(*
zl
) {

881 
Ën
 = 0;

882 ià(
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)è< 
UINT16_MAX
) {

883 
Ën
 = 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
));

885 *
p
 = 
zl
+
ZIPLIST_HEADER_SIZE
;

886 *
p
 !ğ
ZIP_END
) {

887 
p
 +ğ
	`zRawEÁryL’gth
(p);

888 
Ën
++;

892 ià(
Ën
 < 
UINT16_MAX
è
	`ZIPLIST_LENGTH
(
zl
èğ
	`šŒev16ifbe
(len);

894  
Ën
;

895 
	}
}

898 
size_t
 
	$zli¡BlobL’
(*
zl
) {

899  
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
));

900 
	}
}

902 
	$zli¡R•r
(*
zl
) {

903 *
p
;

904 
šdex
 = 0;

905 
zËÁry
 
’Œy
;

907 
	`´štf
(

911 
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),

912 
	`šŒev16ifbe
(
	`ZIPLIST_LENGTH
(
zl
)),

913 
	`šŒev32ifbe
(
	`ZIPLIST_TAIL_OFFSET
(
zl
)));

914 
p
 = 
	`ZIPLIST_ENTRY_HEAD
(
zl
);

915 *
p
 !ğ
ZIP_END
) {

916 
’Œy
 = 
	`zEÁry
(
p
);

917 
	`´štf
(

928 ()
p
,

929 
šdex
,

930 (è(
p
-
zl
),

931 
’Œy
.
h—d”size
+’Œy.
Ën
,

932 
’Œy
.
h—d”size
,

933 
’Œy
.
´ev¿wËn
,

934 
’Œy
.
´ev¿wËnsize
,

935 
’Œy
.
Ën
);

936 
p
 +ğ
’Œy
.
h—d”size
;

937 ià(
	`ZIP_IS_STR
(
’Œy
.
’codšg
)) {

938 ià(
’Œy
.
Ën
 > 40) {

939 ià(
	`fwr™e
(
p
,40,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

940 
	`´štf
("...");

942 ià(
’Œy
.
Ën
 &&

943 
	`fwr™e
(
p
,
’Œy
.
Ën
,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

946 
	`´štf
("%Îd", (è
	`zLßdIÁeg”
(
p
,
’Œy
.
’codšg
));

948 
	`´štf
("\n");

949 
p
 +ğ
’Œy
.
Ën
;

950 
šdex
++;

952 
	`´štf
("{end}\n\n");

953 
	}
}

955 #ifdeà
ZIPLIST_TEST_MAIN


956 
	~<sys/time.h
>

957 
	~"adli¡.h
"

958 
	~"sds.h
"

960 
	#debug
(
f
, ...è{ ià(
DEBUG
è
	`´štf
(f, 
__VA_ARGS__
); }

	)

962 *
	$ü—‹Li¡
() {

963 *
zl
 = 
	`zli¡New
();

964 
zl
 = 
	`zli¡Push
(zl, (*)"foo", 3, 
ZIPLIST_TAIL
);

965 
zl
 = 
	`zli¡Push
(zl, (*)"quux", 4, 
ZIPLIST_TAIL
);

966 
zl
 = 
	`zli¡Push
(zl, (*)"h–lo", 5, 
ZIPLIST_HEAD
);

967 
zl
 = 
	`zli¡Push
(zl, (*)"1024", 4, 
ZIPLIST_TAIL
);

968  
zl
;

969 
	}
}

971 *
	$ü—‹IÁLi¡
() {

972 *
zl
 = 
	`zli¡New
();

973 
buf
[32];

975 
	`¥rštf
(
buf
, "100");

976 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

977 
	`¥rštf
(
buf
, "128000");

978 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

979 
	`¥rštf
(
buf
, "-100");

980 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

981 
	`¥rštf
(
buf
, "4294967296");

982 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_HEAD
);

983 
	`¥rštf
(
buf
, "non integer");

984 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

985 
	`¥rštf
(
buf
, "much much†onger‚on integer");

986 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
	`¡¾’
(buf), 
ZIPLIST_TAIL
);

987  
zl
;

988 
	}
}

990 
	$u£c
() {

991 
timev®
 
tv
;

992 
	`g‘timeofday
(&
tv
,
NULL
);

993  ((()
tv
.
tv_£c
)*1000000)+tv.
tv_u£c
;

994 
	}
}

996 
	$¡»ss
(
pos
, 
num
, 
maxsize
, 
dnum
) {

997 
i
,
j
,
k
;

998 *
zl
;

999 
pos¡r
[2][5] = { "HEAD", "TAIL" };

1000 
¡¬t
;

1001 
i
 = 0; i < 
maxsize
; i+=
dnum
) {

1002 
zl
 = 
	`zli¡New
();

1003 
j
 = 0; j < 
i
; j++) {

1004 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
ZIPLIST_TAIL
);

1008 
¡¬t
 = 
	`u£c
();

1009 
k
 = 0; k < 
num
; k++) {

1010 
zl
 = 
	`zli¡Push
(zl,(*)"quux",4,
pos
);

1011 
zl
 = 
	`zli¡D–‘eRªge
(zl,0,1);

1013 
	`´štf
("List size: %8d, bytes: %8d, %dx…ush+pop (%s): %6lld usec\n",

1014 
i
,
	`šŒev32ifbe
(
	`ZIPLIST_BYTES
(
zl
)),
num
,
pos¡r
[
pos
],
	`u£c
()-
¡¬t
);

1015 
	`zä“
(
zl
);

1017 
	}
}

1019 
	$pİ
(*
zl
, 
wh”e
) {

1020 *
p
, *
v¡r
;

1021 
vËn
;

1022 
vlÚg
;

1024 
p
 = 
	`zli¡Index
(
zl
,
wh”e
 =ğ
ZIPLIST_HEAD
 ? 0 : -1);

1025 ià(
	`zli¡G‘
(
p
,&
v¡r
,&
vËn
,&
vlÚg
)) {

1026 ià(
wh”e
 =ğ
ZIPLIST_HEAD
)

1027 
	`´štf
("Pop head: ");

1029 
	`´štf
("Popail: ");

1031 ià(
v¡r
)

1032 ià(
vËn
 && 
	`fwr™e
(
v¡r
,vËn,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1034 
	`´štf
("%Îd", 
vlÚg
);

1036 
	`´štf
("\n");

1037 
	`zli¡D–‘eRªge
(
zl
,-1,1);

1039 
	`´štf
("ERROR: Could‚ot…op\n");

1040 
	`ex™
(1);

1042 
	}
}

1044 
	$¿nd¡ršg
(*
rg‘
, 
mš
, 
max
) {

1045 
p
 = 0;

1046 
Ën
 = 
mš
+
	`¿nd
()%(
max
-min+1);

1047 
mšv®
, 
maxv®
;

1048 
	`¿nd
() % 3) {

1050 
mšv®
 = 0;

1051 
maxv®
 = 255;

1054 
mšv®
 = 48;

1055 
maxv®
 = 122;

1058 
mšv®
 = 48;

1059 
maxv®
 = 52;

1062 
	`as£¹
(
NULL
);

1065 
p
 < 
Ën
)

1066 
rg‘
[
p
++] = 
mšv®
+
	`¿nd
()%(
maxv®
-minval+1);

1067  
Ën
;

1068 
	}
}

1070 
	$v”ify
(*
zl
, 
zËÁry
 *
e
) {

1071 
i
;

1072 
Ën
 = 
	`zli¡L’
(
zl
);

1073 
zËÁry
 
_e
;

1075 
i
 = 0; i < 
Ën
; i++) {

1076 
	`mem£t
(&
e
[
i
], 0, (
zËÁry
));

1077 
e
[
i
] = 
	`zEÁry
(
	`zli¡Index
(
zl
, i));

1079 
	`mem£t
(&
_e
, 0, (
zËÁry
));

1080 
_e
 = 
	`zEÁry
(
	`zli¡Index
(
zl
, -
Ën
+
i
));

1082 
	`as£¹
(
	`memcmp
(&
e
[
i
], &
_e
, (
zËÁry
)) == 0);

1084 
	}
}

1086 
	$maš
(
¬gc
, **
¬gv
) {

1087 *
zl
, *
p
;

1088 *
’Œy
;

1089 
–’
;

1090 
v®ue
;

1093 ià(
¬gc
 == 2)

1094 
	`¤ªd
(
	`©oi
(
¬gv
[1]));

1096 
zl
 = 
	`ü—‹IÁLi¡
();

1097 
	`zli¡R•r
(
zl
);

1099 
zl
 = 
	`ü—‹Li¡
();

1100 
	`zli¡R•r
(
zl
);

1102 
	`pİ
(
zl
,
ZIPLIST_TAIL
);

1103 
	`zli¡R•r
(
zl
);

1105 
	`pİ
(
zl
,
ZIPLIST_HEAD
);

1106 
	`zli¡R•r
(
zl
);

1108 
	`pİ
(
zl
,
ZIPLIST_TAIL
);

1109 
	`zli¡R•r
(
zl
);

1111 
	`pİ
(
zl
,
ZIPLIST_TAIL
);

1112 
	`zli¡R•r
(
zl
);

1114 
	`´štf
("Getƒlement‡t index 3:\n");

1116 
zl
 = 
	`ü—‹Li¡
();

1117 
p
 = 
	`zli¡Index
(
zl
, 3);

1118 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1119 
	`´štf
("ERROR: Could‚ot‡ccess index 3\n");

1122 ià(
’Œy
) {

1123 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1124 
	`´štf
("\n");

1126 
	`´štf
("%Îd\n", 
v®ue
);

1128 
	`´štf
("\n");

1131 
	`´štf
("Getƒlement‡t index 4 (out of„ange):\n");

1133 
zl
 = 
	`ü—‹Li¡
();

1134 
p
 = 
	`zli¡Index
(
zl
, 4);

1135 ià(
p
 =ğ
NULL
) {

1136 
	`´štf
("Noƒntry\n");

1138 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1141 
	`´štf
("\n");

1144 
	`´štf
("Getƒlement‡t index -1 (lastƒlement):\n");

1146 
zl
 = 
	`ü—‹Li¡
();

1147 
p
 = 
	`zli¡Index
(
zl
, -1);

1148 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1149 
	`´štf
("ERROR: Could‚ot‡ccess index -1\n");

1152 ià(
’Œy
) {

1153 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1154 
	`´štf
("\n");

1156 
	`´štf
("%Îd\n", 
v®ue
);

1158 
	`´štf
("\n");

1161 
	`´štf
("Getƒlement‡t index -4 (firstƒlement):\n");

1163 
zl
 = 
	`ü—‹Li¡
();

1164 
p
 = 
	`zli¡Index
(
zl
, -4);

1165 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1166 
	`´štf
("ERROR: Could‚ot‡ccess index -4\n");

1169 ià(
’Œy
) {

1170 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1171 
	`´štf
("\n");

1173 
	`´štf
("%Îd\n", 
v®ue
);

1175 
	`´štf
("\n");

1178 
	`´štf
("Getƒlement‡t index -5 (reverse out of„ange):\n");

1180 
zl
 = 
	`ü—‹Li¡
();

1181 
p
 = 
	`zli¡Index
(
zl
, -5);

1182 ià(
p
 =ğ
NULL
) {

1183 
	`´štf
("Noƒntry\n");

1185 
	`´štf
("ERROR: Ouˆoà¿ngšdex should„‘uº NULL,„‘uºed off£t: %ld\n", 
p
-
zl
);

1188 
	`´štf
("\n");

1191 
	`´štf
("Iterate†ist from 0oƒnd:\n");

1193 
zl
 = 
	`ü—‹Li¡
();

1194 
p
 = 
	`zli¡Index
(
zl
, 0);

1195 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1196 
	`´štf
("Entry: ");

1197 ià(
’Œy
) {

1198 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1200 
	`´štf
("%Îd", 
v®ue
);

1202 
p
 = 
	`zli¡Next
(
zl
,p);

1203 
	`´štf
("\n");

1205 
	`´štf
("\n");

1208 
	`´štf
("Iterate†ist from 1oƒnd:\n");

1210 
zl
 = 
	`ü—‹Li¡
();

1211 
p
 = 
	`zli¡Index
(
zl
, 1);

1212 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1213 
	`´štf
("Entry: ");

1214 ià(
’Œy
) {

1215 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1217 
	`´štf
("%Îd", 
v®ue
);

1219 
p
 = 
	`zli¡Next
(
zl
,p);

1220 
	`´štf
("\n");

1222 
	`´štf
("\n");

1225 
	`´štf
("Iterate†ist from 2oƒnd:\n");

1227 
zl
 = 
	`ü—‹Li¡
();

1228 
p
 = 
	`zli¡Index
(
zl
, 2);

1229 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1230 
	`´štf
("Entry: ");

1231 ià(
’Œy
) {

1232 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1234 
	`´štf
("%Îd", 
v®ue
);

1236 
p
 = 
	`zli¡Next
(
zl
,p);

1237 
	`´štf
("\n");

1239 
	`´štf
("\n");

1242 
	`´štf
("Iterate starting out of„ange:\n");

1244 
zl
 = 
	`ü—‹Li¡
();

1245 
p
 = 
	`zli¡Index
(
zl
, 4);

1246 ià(!
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1247 
	`´štf
("Noƒntry\n");

1249 
	`´štf
("ERROR\n");

1251 
	`´štf
("\n");

1254 
	`´štf
("Iterate from backo front:\n");

1256 
zl
 = 
	`ü—‹Li¡
();

1257 
p
 = 
	`zli¡Index
(
zl
, -1);

1258 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1259 
	`´štf
("Entry: ");

1260 ià(
’Œy
) {

1261 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1263 
	`´štf
("%Îd", 
v®ue
);

1265 
p
 = 
	`zli¡P»v
(
zl
,p);

1266 
	`´štf
("\n");

1268 
	`´štf
("\n");

1271 
	`´štf
("Iterate from backo front, deleting‡ll items:\n");

1273 
zl
 = 
	`ü—‹Li¡
();

1274 
p
 = 
	`zli¡Index
(
zl
, -1);

1275 
	`zli¡G‘
(
p
, &
’Œy
, &
–’
, &
v®ue
)) {

1276 
	`´štf
("Entry: ");

1277 ià(
’Œy
) {

1278 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

1280 
	`´štf
("%Îd", 
v®ue
);

1282 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1283 
p
 = 
	`zli¡P»v
(
zl
,p);

1284 
	`´štf
("\n");

1286 
	`´štf
("\n");

1289 
	`´štf
("Delete inclusive„ange 0,0:\n");

1291 
zl
 = 
	`ü—‹Li¡
();

1292 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 1);

1293 
	`zli¡R•r
(
zl
);

1296 
	`´štf
("Delete inclusive„ange 0,1:\n");

1298 
zl
 = 
	`ü—‹Li¡
();

1299 
zl
 = 
	`zli¡D–‘eRªge
(zl, 0, 2);

1300 
	`zli¡R•r
(
zl
);

1303 
	`´štf
("Delete inclusive„ange 1,2:\n");

1305 
zl
 = 
	`ü—‹Li¡
();

1306 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 2);

1307 
	`zli¡R•r
(
zl
);

1310 
	`´štf
("Delete with start index out of„ange:\n");

1312 
zl
 = 
	`ü—‹Li¡
();

1313 
zl
 = 
	`zli¡D–‘eRªge
(zl, 5, 1);

1314 
	`zli¡R•r
(
zl
);

1317 
	`´štf
("Delete with‚um overflow:\n");

1319 
zl
 = 
	`ü—‹Li¡
();

1320 
zl
 = 
	`zli¡D–‘eRªge
(zl, 1, 5);

1321 
	`zli¡R•r
(
zl
);

1324 
	`´štf
("Delete foo while iterating:\n");

1326 
zl
 = 
	`ü—‹Li¡
();

1327 
p
 = 
	`zli¡Index
(
zl
,0);

1328 
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
)) {

1329 ià(
’Œy
 && 
	`¡ºcmp
("foo",(*ëÁry,
–’
) == 0) {

1330 
	`´štf
("Delete foo\n");

1331 
zl
 = 
	`zli¡D–‘e
(zl,&
p
);

1333 
	`´štf
("Entry: ");

1334 ià(
’Œy
) {

1335 ià(
–’
 && 
	`fwr™e
(
’Œy
,–’,1,
¡dout
) == 0)

1336 
	`³¼Ü
("fwrite");

1338 
	`´štf
("%Îd",
v®ue
);

1340 
p
 = 
	`zli¡Next
(
zl
,p);

1341 
	`´štf
("\n");

1344 
	`´štf
("\n");

1345 
	`zli¡R•r
(
zl
);

1348 
	`´štf
("Regressionest for >255 byte strings:\n");

1350 
v1
[257],
v2
[257];

1351 
	`mem£t
(
v1
,'x',256);

1352 
	`mem£t
(
v2
,'y',256);

1353 
zl
 = 
	`zli¡New
();

1354 
zl
 = 
	`zli¡Push
(zl,(*)
v1
,
	`¡¾’
(v1),
ZIPLIST_TAIL
);

1355 
zl
 = 
	`zli¡Push
(zl,(*)
v2
,
	`¡¾’
(v2),
ZIPLIST_TAIL
);

1358 
p
 = 
	`zli¡Index
(
zl
,0);

1359 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1360 
	`as£¹
(
	`¡ºcmp
(
v1
,(*)
’Œy
,
–’
) == 0);

1361 
p
 = 
	`zli¡Index
(
zl
,1);

1362 
	`as£¹
(
	`zli¡G‘
(
p
,&
’Œy
,&
–’
,&
v®ue
));

1363 
	`as£¹
(
	`¡ºcmp
(
v2
,(*)
’Œy
,
–’
) == 0);

1364 
	`´štf
("SUCCESS\n\n");

1367 
	`´štf
("Regressionest deleting‚exto†astƒntries:\n");

1369 
v
[3][257];

1370 
zËÁry
 
e
[3];

1371 
i
;

1373 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1374 
	`mem£t
(
v
[
i
], 'a' + i, (v[0]));

1377 
v
[0][256] = '\0';

1378 
v
[1][ 1] = '\0';

1379 
v
[2][256] = '\0';

1381 
zl
 = 
	`zli¡New
();

1382 
i
 = 0; i < ((
v
)/(v[0])); i++) {

1383 
zl
 = 
	`zli¡Push
(zl, (*è
v
[
i
], 
	`¡¾’
(v[i]), 
ZIPLIST_TAIL
);

1386 
	`v”ify
(
zl
, 
e
);

1388 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1389 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1390 
	`as£¹
(
e
[2].
´ev¿wËnsize
 == 1);

1393 *
p
 = 
e
[1].p;

1394 
zl
 = 
	`zli¡D–‘e
(zl, &
p
);

1396 
	`v”ify
(
zl
, 
e
);

1398 
	`as£¹
(
e
[0].
´ev¿wËnsize
 == 1);

1399 
	`as£¹
(
e
[1].
´ev¿wËnsize
 == 5);

1401 
	`´štf
("SUCCESS\n\n");

1404 
	`´štf
("Create†ong†ist‡nd check indices:\n");

1406 
zl
 = 
	`zli¡New
();

1407 
buf
[32];

1408 
i
,
Ën
;

1409 
i
 = 0; i < 1000; i++) {

1410 
Ën
 = 
	`¥rštf
(
buf
,"%d",
i
);

1411 
zl
 = 
	`zli¡Push
(zl,(*)
buf
,
Ën
,
ZIPLIST_TAIL
);

1413 
i
 = 0; i < 1000; i++) {

1414 
p
 = 
	`zli¡Index
(
zl
,
i
);

1415 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1416 
	`as£¹
(
i
 =ğ
v®ue
);

1418 
p
 = 
	`zli¡Index
(
zl
,-
i
-1);

1419 
	`as£¹
(
	`zli¡G‘
(
p
,
NULL
,NULL,&
v®ue
));

1420 
	`as£¹
(999-
i
 =ğ
v®ue
);

1422 
	`´štf
("SUCCESS\n\n");

1425 
	`´štf
("Compare strings with ziplistƒntries:\n");

1427 
zl
 = 
	`ü—‹Li¡
();

1428 
p
 = 
	`zli¡Index
(
zl
,0);

1429 ià(!
	`zli¡Com·»
(
p
,(*)"hello",5)) {

1430 
	`´štf
("ERROR:‚ot \"hello\"\n");

1433 ià(
	`zli¡Com·»
(
p
,(*)"hella",5)) {

1434 
	`´štf
("ERROR: \"hella\"\n");

1438 
p
 = 
	`zli¡Index
(
zl
,3);

1439 ià(!
	`zli¡Com·»
(
p
,(*)"1024",4)) {

1440 
	`´štf
("ERROR:‚ot \"1024\"\n");

1443 ià(
	`zli¡Com·»
(
p
,(*)"1025",4)) {

1444 
	`´štf
("ERROR: \"1025\"\n");

1447 
	`´štf
("SUCCESS\n\n");

1450 
	`´štf
("Stress with„andom…ayloads of differentƒncoding:\n");

1452 
i
,
j
,
Ën
,
wh”e
;

1453 *
p
;

1454 
buf
[1024];

1455 
buæ’
;

1456 
li¡
 *
»f
;

1457 
li¡Node
 *
»âode
;

1460 *
s¡r
;

1461 
¦’
;

1462 
sv®
;

1464 
i
 = 0; i < 20000; i++) {

1465 
zl
 = 
	`zli¡New
();

1466 
»f
 = 
	`li¡C»©e
();

1467 
	`li¡S‘F»eM‘hod
(
»f
,
sdsä“
);

1468 
Ën
 = 
	`¿nd
() % 256;

1471 
j
 = 0; j < 
Ën
; j++) {

1472 
wh”e
 = (
	`¿nd
(è& 1è? 
ZIPLIST_HEAD
 : 
ZIPLIST_TAIL
;

1473 ià(
	`¿nd
() % 2) {

1474 
buæ’
 = 
	`¿nd¡ršg
(
buf
,1,(buf)-1);

1476 
	`¿nd
() % 3) {

1478 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) >> 20);

1481 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()));

1484 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",(0LL + 
	`¿nd
()) << 20);

1487 
	`as£¹
(
NULL
);

1492 
zl
 = 
	`zli¡Push
(zl, (*)
buf
, 
buæ’
, 
wh”e
);

1495 ià(
wh”e
 =ğ
ZIPLIST_HEAD
) {

1496 
	`li¡AddNodeH—d
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1497 } ià(
wh”e
 =ğ
ZIPLIST_TAIL
) {

1498 
	`li¡AddNodeTa
(
»f
,
	`sd¢ewËn
(
buf
, 
buæ’
));

1500 
	`as£¹
(
NULL
);

1504 
	`as£¹
(
	`li¡L’gth
(
»f
è=ğ
	`zli¡L’
(
zl
));

1505 
j
 = 0; j < 
Ën
; j++) {

1508 
p
 = 
	`zli¡Index
(
zl
,
j
);

1509 
»âode
 = 
	`li¡Index
(
»f
,
j
);

1511 
	`as£¹
(
	`zli¡G‘
(
p
,&
s¡r
,&
¦’
,&
sv®
));

1512 ià(
s¡r
 =ğ
NULL
) {

1513 
buæ’
 = 
	`¥rštf
(
buf
,"%Îd",
sv®
);

1515 
buæ’
 = 
¦’
;

1516 
	`memıy
(
buf
,
s¡r
,
buæ’
);

1517 
buf
[
buæ’
] = '\0';

1519 
	`as£¹
(
	`memcmp
(
buf
,
	`li¡NodeV®ue
(
»âode
),
buæ’
) == 0);

1521 
	`zä“
(
zl
);

1522 
	`li¡R–—£
(
»f
);

1524 
	`´štf
("SUCCESS\n\n");

1527 
	`´štf
("Stress with variable ziplist size:\n");

1529 
	`¡»ss
(
ZIPLIST_HEAD
,100000,16384,256);

1530 
	`¡»ss
(
ZIPLIST_TAIL
,100000,16384,256);

1534 
	}
}

	@ziplist.h

31 
	#ZIPLIST_HEAD
 0

	)

32 
	#ZIPLIST_TAIL
 1

	)

34 *
zli¡New
();

35 *
zli¡Push
(*
zl
, *
s
, 
¦’
, 
wh”e
);

36 *
zli¡Index
(*
zl
, 
šdex
);

37 *
zli¡Next
(*
zl
, *
p
);

38 *
zli¡P»v
(*
zl
, *
p
);

39 
zli¡G‘
(*
p
, **
sv®
, *
¦’
, *
lv®
);

40 *
zli¡In£¹
(*
zl
, *
p
, *
s
, 
¦’
);

41 *
zli¡D–‘e
(*
zl
, **
p
);

42 *
zli¡D–‘eRªge
(*
zl
, 
šdex
, 
num
);

43 
zli¡Com·»
(*
p
, *
s
, 
¦’
);

44 *
zli¡Fšd
(*
p
, *
v¡r
, 
vËn
, 
sk
);

45 
zli¡L’
(*
zl
);

46 
size_t
 
zli¡BlobL’
(*
zl
);

	@zipmap.c

78 
	~<¡dio.h
>

79 
	~<¡ršg.h
>

80 
	~"zm®loc.h
"

81 
	~"’dŸncÚv.h
"

83 
	#ZIPMAP_BIGLEN
 254

	)

84 
	#ZIPMAP_END
 255

	)

88 
	#ZIPMAP_VALUE_MAX_FREE
 4

	)

93 
	#ZIPMAP_LEN_BYTES
(
_l
è(((_lè< 
ZIPMAP_BIGLEN
è? 1 : ()+1)

	)

96 *
	$zm­New
() {

97 *
zm
 = 
	`zm®loc
(2);

99 
zm
[0] = 0;

100 
zm
[1] = 
ZIPMAP_END
;

101  
zm
;

102 
	}
}

105 
	$zm­DecodeL’gth
(*
p
) {

106 
Ën
 = *
p
;

108 ià(
Ën
 < 
ZIPMAP_BIGLEN
) †en;

109 
	`memıy
(&
Ën
,
p
+1,());

110 
	`mem»v32ifbe
(&
Ën
);

111  
Ën
;

112 
	}
}

116 
	$zm­EncodeL’gth
(*
p
, 
Ën
) {

117 ià(
p
 =ğ
NULL
) {

118  
	`ZIPMAP_LEN_BYTES
(
Ën
);

120 ià(
Ën
 < 
ZIPMAP_BIGLEN
) {

121 
p
[0] = 
Ën
;

124 
p
[0] = 
ZIPMAP_BIGLEN
;

125 
	`memıy
(
p
+1,&
Ën
,(len));

126 
	`mem»v32ifbe
(
p
+1);

127  1+(
Ën
);

130 
	}
}

138 *
	$zm­LookupRaw
(*
zm
, *
key
, 
kËn
, *
tÙËn
) {

139 *
p
 = 
zm
+1, *
k
 = 
NULL
;

140 
l
,
Î’
;

142 *
p
 !ğ
ZIPMAP_END
) {

143 
ä“
;

146 
l
 = 
	`zm­DecodeL’gth
(
p
);

147 
Î’
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

148 ià(
key
 !ğ
NULL
 && 
k
 =ğNULL && 
l
 =ğ
kËn
 && !
	`memcmp
(
p
+
Î’
,key,l)) {

151 ià(
tÙËn
 !ğ
NULL
) {

152 
k
 = 
p
;

154  
p
;

157 
p
 +ğ
Î’
+
l
;

159 
l
 = 
	`zm­DecodeL’gth
(
p
);

160 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

161 
ä“
 = 
p
[0];

162 
p
 +ğ
l
+1+
ä“
;

164 ià(
tÙËn
 !ğ
NULL
è*tÙËÀğ()(
p
-
zm
)+1;

165  
k
;

166 
	}
}

168 
	$zm­RequœedL’gth
(
kËn
, 
vËn
) {

169 
l
;

171 
l
 = 
kËn
+
vËn
+3;

172 ià(
kËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

173 ià(
vËn
 >ğ
ZIPMAP_BIGLEN
è
l
 += 4;

174  
l
;

175 
	}
}

178 
	$zm­RawKeyL’gth
(*
p
) {

179 
l
 = 
	`zm­DecodeL’gth
(
p
);

180  
	`zm­EncodeL’gth
(
NULL
,
l
) +†;

181 
	}
}

185 
	$zm­RawV®ueL’gth
(*
p
) {

186 
l
 = 
	`zm­DecodeL’gth
(
p
);

187 
u£d
;

189 
u£d
 = 
	`zm­EncodeL’gth
(
NULL
,
l
);

190 
u£d
 +ğ
p
[u£d] + 1 + 
l
;

191  
u£d
;

192 
	}
}

197 
	$zm­RawEÁryL’gth
(*
p
) {

198 
l
 = 
	`zm­RawKeyL’gth
(
p
);

199  
l
 + 
	`zm­RawV®ueL’gth
(
p
+l);

200 
	}
}

202 
šlše
 *
	$zm­Resize
(*
zm
, 
Ën
) {

203 
zm
 = 
	`z»®loc
(zm, 
Ën
);

204 
zm
[
Ën
-1] = 
ZIPMAP_END
;

205  
zm
;

206 
	}
}

211 *
	$zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
) {

212 
zmËn
, 
off£t
;

213 
ä“Ën
, 
»qËn
 = 
	`zm­RequœedL’gth
(
kËn
,
vËn
);

214 
em±y
, 
vem±y
;

215 *
p
;

217 
ä“Ën
 = 
»qËn
;

218 ià(
upd©e
) *update = 0;

219 
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

220 ià(
p
 =ğ
NULL
) {

222 
zm
 = 
	`zm­Resize
(zm, 
zmËn
+
»qËn
);

223 
p
 = 
zm
+
zmËn
-1;

224 
zmËn
 = zmËn+
»qËn
;

227 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]++;

231 ià(
upd©e
) *update = 1;

232 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

233 ià(
ä“Ën
 < 
»qËn
) {

237 
off£t
 = 
p
-
zm
;

238 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
+
»qËn
);

239 
p
 = 
zm
+
off£t
;

243 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

244 
zmËn
 = zmËn-
ä“Ën
+
»qËn
;

245 
ä“Ën
 = 
»qËn
;

253 
em±y
 = 
ä“Ën
-
»qËn
;

254 ià(
em±y
 >ğ
ZIPMAP_VALUE_MAX_FREE
) {

257 
off£t
 = 
p
-
zm
;

258 
	`memmove
(
p
+
»qËn
,…+
ä“Ën
, 
zmËn
-(
off£t
+freelen+1));

259 
zmËn
 -ğ
em±y
;

260 
zm
 = 
	`zm­Resize
(zm, 
zmËn
);

261 
p
 = 
zm
+
off£t
;

262 
vem±y
 = 0;

264 
vem±y
 = 
em±y
;

269 
p
 +ğ
	`zm­EncodeL’gth
Õ,
kËn
);

270 
	`memıy
(
p
,
key
,
kËn
);

271 
p
 +ğ
kËn
;

273 
p
 +ğ
	`zm­EncodeL’gth
Õ,
vËn
);

274 *
p
++ = 
vem±y
;

275 
	`memıy
(
p
,
v®
,
vËn
);

276  
zm
;

277 
	}
}

281 *
	$zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
) {

282 
zmËn
, 
ä“Ën
;

283 *
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,&
zmËn
);

284 ià(
p
) {

285 
ä“Ën
 = 
	`zm­RawEÁryL’gth
(
p
);

286 
	`memmove
(
p
,…+
ä“Ën
, 
zmËn
-(Õ-
zm
)+freelen+1));

287 
zm
 = 
	`zm­Resize
(zm, 
zmËn
-
ä“Ën
);

290 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) zm[0]--;

292 ià(
d–‘ed
) *deleted = 1;

294 ià(
d–‘ed
) *deleted = 0;

296  
zm
;

297 
	}
}

300 *
	$zm­Rewšd
(*
zm
) {

301  
zm
+1;

302 
	}
}

315 *
	$zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
) {

316 ià(
zm
[0] =ğ
ZIPMAP_END
è 
NULL
;

317 ià(
key
) {

318 *
key
 = 
zm
;

319 *
kËn
 = 
	`zm­DecodeL’gth
(
zm
);

320 *
key
 +ğ
	`ZIPMAP_LEN_BYTES
(*
kËn
);

322 
zm
 +ğ
	`zm­RawKeyL’gth
(zm);

323 ià(
v®ue
) {

324 *
v®ue
 = 
zm
+1;

325 *
vËn
 = 
	`zm­DecodeL’gth
(
zm
);

326 *
v®ue
 +ğ
	`ZIPMAP_LEN_BYTES
(*
vËn
);

328 
zm
 +ğ
	`zm­RawV®ueL’gth
(zm);

329  
zm
;

330 
	}
}

334 
	$zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
) {

335 *
p
;

337 ià((
p
 = 
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
)) == NULL)  0;

338 
p
 +ğ
	`zm­RawKeyL’gth
(p);

339 *
vËn
 = 
	`zm­DecodeL’gth
(
p
);

340 *
v®ue
 = 
p
 + 
	`ZIPMAP_LEN_BYTES
(*
vËn
) + 1;

342 
	}
}

345 
	$zm­Exi¡s
(*
zm
, *
key
, 
kËn
) {

346  
	`zm­LookupRaw
(
zm
,
key
,
kËn
,
NULL
) != NULL;

347 
	}
}

350 
	$zm­L’
(*
zm
) {

351 
Ën
 = 0;

352 ià(
zm
[0] < 
ZIPMAP_BIGLEN
) {

353 
Ën
 = 
zm
[0];

355 *
p
 = 
	`zm­Rewšd
(
zm
);

356 (
p
 = 
	`zm­Next
Õ,
NULL
,NULL,NULL,NULL)è!ğNULLè
Ën
++;

359 ià(
Ën
 < 
ZIPMAP_BIGLEN
è
zm
[0] =†en;

361  
Ën
;

362 
	}
}

367 
size_t
 
	$zm­BlobL’
(*
zm
) {

368 
tÙËn
;

369 
	`zm­LookupRaw
(
zm
,
NULL
,0,&
tÙËn
);

370  
tÙËn
;

371 
	}
}

373 #ifdeà
ZIPMAP_TEST_MAIN


374 
	$zm­R•r
(*
p
) {

375 
l
;

377 
	`´štf
("{¡©u %u}",*
p
++);

379 ià(
p
[0] =ğ
ZIPMAP_END
) {

380 
	`´štf
("{end}");

383 
e
;

385 
l
 = 
	`zm­DecodeL’gth
(
p
);

386 
	`´štf
("{key %u}",
l
);

387 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

388 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

389 
p
 +ğ
l
;

391 
l
 = 
	`zm­DecodeL’gth
(
p
);

392 
	`´štf
("{v®u%u}",
l
);

393 
p
 +ğ
	`zm­EncodeL’gth
(
NULL
,
l
);

394 
e
 = *
p
++;

395 ià(
l
 !ğ0 && 
	`fwr™e
(
p
,l,1,
¡dout
è=ğ0è
	`³¼Ü
("fwrite");

396 
p
 +ğ
l
+
e
;

397 ià(
e
) {

398 
	`´štf
("[");

399 
e
--è
	`´štf
(".");

400 
	`´štf
("]");

404 
	`´štf
("\n");

405 
	}
}

407 
	$maš
() {

408 *
zm
;

410 
zm
 = 
	`zm­New
();

412 
zm
 = 
	`zm­S‘
(zm,(*è"Çme",4, (*è"foo",3,
NULL
);

413 
zm
 = 
	`zm­S‘
(zm,(*è"suºame",7, (*è"foo",3,
NULL
);

414 
zm
 = 
	`zm­S‘
(zm,(*è"age",3, (*è"foo",3,
NULL
);

415 
	`zm­R•r
(
zm
);

417 
zm
 = 
	`zm­S‘
(zm,(*è"h–lo",5, (*è"wÜld!",6,
NULL
);

418 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"b¬",3,
NULL
);

419 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"!",1,
NULL
);

420 
	`zm­R•r
(
zm
);

421 
zm
 = 
	`zm­S‘
(zm,(*è"foo",3, (*è"12345",5,
NULL
);

422 
	`zm­R•r
(
zm
);

423 
zm
 = 
	`zm­S‘
(zm,(*è"Ãw",3, (*è"xx",2,
NULL
);

424 
zm
 = 
	`zm­S‘
(zm,(*è"nov®",5, (*è"",0,
NULL
);

425 
	`zm­R•r
(
zm
);

426 
zm
 = 
	`zm­D–
(zm,(*è"Ãw",3,
NULL
);

427 
	`zm­R•r
(
zm
);

429 
	`´štf
("\nLook up†arge key:\n");

431 
buf
[512];

432 *
v®ue
;

433 
vËn
, 
i
;

434 
i
 = 0; i < 512; i++è
buf
[i] = 'a';

436 
zm
 = 
	`zm­S‘
(zm,
buf
,512,(*è"lÚg",4,
NULL
);

437 ià(
	`zm­G‘
(
zm
,
buf
,512,&
v®ue
,&
vËn
)) {

438 
	`´štf
(" <long key> is‡ssociatedohe %d bytes value: %.*s\n",

439 
vËn
, vËn, 
v®ue
);

443 
	`´štf
("\nPerform‡ direct†ookup:\n");

445 *
v®ue
;

446 
vËn
;

448 ià(
	`zm­G‘
(
zm
,(*è"foo",3,&
v®ue
,&
vËn
)) {

449 
	`´štf
(" foo is‡ssociatedohe %d bytes value: %.*s\n",

450 
vËn
, vËn, 
v®ue
);

453 
	`´štf
("\nIteratehroughƒlements:\n");

455 *
i
 = 
	`zm­Rewšd
(
zm
);

456 *
key
, *
v®ue
;

457 
kËn
, 
vËn
;

459 (
i
 = 
	`zm­Next
(i,&
key
,&
kËn
,&
v®ue
,&
vËn
)è!ğ
NULL
) {

460 
	`´štf
(" %d:%.* => %d:%.*s\n", 
kËn
, kËn, 
key
, 
vËn
, vËn, 
v®ue
);

464 
	}
}

	@zipmap.h

35 #iâdeà
_ZIPMAP_H


36 
	#_ZIPMAP_H


	)

38 *
zm­New
();

39 *
zm­S‘
(*
zm
, *
key
, 
kËn
, *
v®
, 
vËn
, *
upd©e
);

40 *
zm­D–
(*
zm
, *
key
, 
kËn
, *
d–‘ed
);

41 *
zm­Rewšd
(*
zm
);

42 *
zm­Next
(*
zm
, **
key
, *
kËn
, **
v®ue
, *
vËn
);

43 
zm­G‘
(*
zm
, *
key
, 
kËn
, **
v®ue
, *
vËn
);

44 
zm­Exi¡s
(*
zm
, *
key
, 
kËn
);

45 
zm­L’
(*
zm
);

46 
size_t
 
zm­BlobL’
(*
zm
);

47 
zm­R•r
(*
p
);

	@zmalloc.c

32 
	~<¡dio.h
>

33 
	~<¡dlib.h
>

39 
	$zlibc_ä“
(*
±r
) {

40 
	`ä“
(
±r
);

41 
	}
}

43 
	~<¡ršg.h
>

44 
	~<±h»ad.h
>

45 
	~"cÚfig.h
"

46 
	~"zm®loc.h
"

48 #ifdeà
HAVE_MALLOC_SIZE


49 
	#PREFIX_SIZE
 (0)

	)

51 #ià
defšed
(
__sun
è|| defšed(
__¥¬c
è|| defšed(
__¥¬c__
)

52 
	#PREFIX_SIZE
 (())

	)

54 
	#PREFIX_SIZE
 ((
size_t
))

	)

59 #ià
defšed
(
USE_TCMALLOC
)

60 
	#m®loc
(
size
è
	`tc_m®loc
(size)

	)

61 
	#ÿÎoc
(
couÁ
,
size
è
	`tc_ÿÎoc
(couÁ,size)

	)

62 
	#»®loc
(
±r
,
size
è
	`tc_»®loc
ÕŒ,size)

	)

63 
	#ä“
(
±r
è
	`tc_ä“
ÕŒ)

	)

64 #–ià
defšed
(
USE_JEMALLOC
)

65 
	#m®loc
(
size
è
	`je_m®loc
(size)

	)

66 
	#ÿÎoc
(
couÁ
,
size
è
	`je_ÿÎoc
(couÁ,size)

	)

67 
	#»®loc
(
±r
,
size
è
	`je_»®loc
ÕŒ,size)

	)

68 
	#ä“
(
±r
è
	`je_ä“
ÕŒ)

	)

71 #ià
defšed
(
__ATOMIC_RELAXED
)

72 
	#upd©e_zm®loc_¡©_add
(
__n
è
	`__©omic_add_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

73 
	#upd©e_zm®loc_¡©_sub
(
__n
è
	`__©omic_sub_ãtch
(&
u£d_memÜy
, (__n), 
__ATOMIC_RELAXED
)

	)

74 #–ià
defšed
(
HAVE_ATOMIC
)

75 
	#upd©e_zm®loc_¡©_add
(
__n
è
	`__sync_add_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

76 
	#upd©e_zm®loc_¡©_sub
(
__n
è
	`__sync_sub_ªd_ãtch
(&
u£d_memÜy
, (__n))

	)

78 
	#upd©e_zm®loc_¡©_add
(
__n
) do { \

79 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

80 
u£d_memÜy
 +ğ(
__n
); \

81 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

82 } 0)

	)

84 
	#upd©e_zm®loc_¡©_sub
(
__n
) do { \

85 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
); \

86 
u£d_memÜy
 -ğ(
__n
); \

87 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
); \

88 } 0)

	)

92 
	#upd©e_zm®loc_¡©_®loc
(
__n
) do { \

93 
size_t
 
_n
 = (
__n
); \

94 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

95 ià(
zm®loc_th»ad_§ã
) { \

96 
	`upd©e_zm®loc_¡©_add
(
_n
); \

98 
u£d_memÜy
 +ğ
_n
; \

100 } 0)

	)

102 
	#upd©e_zm®loc_¡©_ä“
(
__n
) do { \

103 
size_t
 
_n
 = (
__n
); \

104 ià(
_n
&(()-1)) _n += ()-(_n&(()-1)); \

105 ià(
zm®loc_th»ad_§ã
) { \

106 
	`upd©e_zm®loc_¡©_sub
(
_n
); \

108 
u£d_memÜy
 -ğ
_n
; \

110 } 0)

	)

112 
size_t
 
	gu£d_memÜy
 = 0;

113 
	gzm®loc_th»ad_§ã
 = 0;

114 
±h»ad_mu‹x_t
 
	gu£d_memÜy_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

116 
	$zm®loc_deçuÉ_oom
(
size_t
 
size
) {

117 
	`årštf
(
¡d”r
, "zmalloc: Out of memoryryingo‡llocate %zu bytes\n",

118 
size
);

119 
	`fæush
(
¡d”r
);

120 
	`abÜt
();

121 
	}
}

123 (*
zm®loc_oom_hªdËr
)(
size_t
èğ
zm®loc_deçuÉ_oom
;

125 *
	$zm®loc
(
size_t
 
size
) {

127 *
±r
 = 
	`m®loc
(
size
+
PREFIX_SIZE
);

129 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

130 #ifdeà
HAVE_MALLOC_SIZE


131 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

132  
±r
;

134 *((
size_t
*)
±r
èğ
size
;

135 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

136  (*)
±r
+
PREFIX_SIZE
;

138 
	}
}

140 *
	$zÿÎoc
(
size_t
 
size
) {

141 *
±r
 = 
	`ÿÎoc
(1, 
size
+
PREFIX_SIZE
);

143 ià(!
±r
è
	`zm®loc_oom_hªdËr
(
size
);

144 #ifdeà
HAVE_MALLOC_SIZE


145 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
±r
));

146  
±r
;

148 *((
size_t
*)
±r
èğ
size
;

149 
	`upd©e_zm®loc_¡©_®loc
(
size
+
PREFIX_SIZE
);

150  (*)
±r
+
PREFIX_SIZE
;

152 
	}
}

154 *
	$z»®loc
(*
±r
, 
size_t
 
size
) {

155 #iâdeà
HAVE_MALLOC_SIZE


156 *
»®±r
;

158 
size_t
 
Şdsize
;

159 *
Ãw±r
;

161 ià(
±r
 =ğ
NULL
è 
	`zm®loc
(
size
);

162 #ifdeà
HAVE_MALLOC_SIZE


163 
Şdsize
 = 
	`zm®loc_size
(
±r
);

164 
Ãw±r
 = 
	`»®loc
(
±r
,
size
);

165 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

167 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

168 
	`upd©e_zm®loc_¡©_®loc
(
	`zm®loc_size
(
Ãw±r
));

169  
Ãw±r
;

171 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

172 
Şdsize
 = *((
size_t
*)
»®±r
);

173 
Ãw±r
 = 
	`»®loc
(
»®±r
,
size
+
PREFIX_SIZE
);

174 ià(!
Ãw±r
è
	`zm®loc_oom_hªdËr
(
size
);

176 *((
size_t
*)
Ãw±r
èğ
size
;

177 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
);

178 
	`upd©e_zm®loc_¡©_®loc
(
size
);

179  (*)
Ãw±r
+
PREFIX_SIZE
;

181 
	}
}

186 #iâdeà
HAVE_MALLOC_SIZE


187 
size_t
 
	$zm®loc_size
(*
±r
) {

188 *
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

189 
size_t
 
size
 = *((size_t*)
»®±r
);

192 ià(
size
&(()-1)) size += ()-(size&(()-1));

193  
size
+
PREFIX_SIZE
;

194 
	}
}

197 
	$zä“
(*
±r
) {

198 #iâdeà
HAVE_MALLOC_SIZE


199 *
»®±r
;

200 
size_t
 
Şdsize
;

203 ià(
±r
 =ğ
NULL
) ;

204 #ifdeà
HAVE_MALLOC_SIZE


205 
	`upd©e_zm®loc_¡©_ä“
(
	`zm®loc_size
(
±r
));

206 
	`ä“
(
±r
);

208 
»®±r
 = (*)
±r
-
PREFIX_SIZE
;

209 
Şdsize
 = *((
size_t
*)
»®±r
);

210 
	`upd©e_zm®loc_¡©_ä“
(
Şdsize
+
PREFIX_SIZE
);

211 
	`ä“
(
»®±r
);

213 
	}
}

215 *
	$z¡rdup
(cÚ¡ *
s
) {

216 
size_t
 
l
 = 
	`¡¾’
(
s
)+1;

217 *
p
 = 
	`zm®loc
(
l
);

219 
	`memıy
(
p
,
s
,
l
);

220  
p
;

221 
	}
}

223 
size_t
 
	$zm®loc_u£d_memÜy
() {

224 
size_t
 
um
;

226 ià(
zm®loc_th»ad_§ã
) {

227 #ià
	`defšed
(
__ATOMIC_RELAXED
è|| defšed(
HAVE_ATOMIC
)

228 
um
 = 
	`upd©e_zm®loc_¡©_add
(0);

230 
	`±h»ad_mu‹x_lock
(&
u£d_memÜy_mu‹x
);

231 
um
 = 
u£d_memÜy
;

232 
	`±h»ad_mu‹x_uÆock
(&
u£d_memÜy_mu‹x
);

236 
um
 = 
u£d_memÜy
;

239  
um
;

240 
	}
}

242 
	$zm®loc_’abË_th»ad_§ãÃss
() {

243 
zm®loc_th»ad_§ã
 = 1;

244 
	}
}

246 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
)) {

247 
zm®loc_oom_hªdËr
 = 
oom_hªdËr
;

248 
	}
}

260 #ià
defšed
(
HAVE_PROC_STAT
)

261 
	~<uni¡d.h
>

262 
	~<sys/ty³s.h
>

263 
	~<sys/¡©.h
>

264 
	~<fú.h
>

266 
size_t
 
	$zm®loc_g‘_rss
() {

267 
·ge
 = 
	`syscÚf
(
_SC_PAGESIZE
);

268 
size_t
 
rss
;

269 
buf
[4096];

270 
f’ame
[256];

271 
fd
, 
couÁ
;

272 *
p
, *
x
;

274 
	`¢´štf
(
f’ame
,256,"/´oc/%d/¡©",
	`g‘pid
());

275 ià((
fd
 = 
	`İ’
(
f’ame
,
O_RDONLY
)) == -1)  0;

276 ià(
	`»ad
(
fd
,
buf
,4096) <= 0) {

277 
	`şo£
(
fd
);

280 
	`şo£
(
fd
);

282 
p
 = 
buf
;

283 
couÁ
 = 23;

284 
p
 && 
couÁ
--) {

285 
p
 = 
	`¡rchr
(p,' ');

286 ià(
p
)…++;

288 ià(!
p
)  0;

289 
x
 = 
	`¡rchr
(
p
,' ');

290 ià(!
x
)  0;

291 *
x
 = '\0';

293 
rss
 = 
	`¡¹Şl
(
p
,
NULL
,10);

294 
rss
 *ğ
·ge
;

295  
rss
;

296 
	}
}

297 #–ià
defšed
(
HAVE_TASKINFO
)

298 
	~<uni¡d.h
>

299 
	~<¡dio.h
>

300 
	~<¡dlib.h
>

301 
	~<sys/ty³s.h
>

302 
	~<sys/sysùl.h
>

303 
	~<mach/sk.h
>

304 
	~<mach/mach_š™.h
>

306 
size_t
 
	$zm®loc_g‘_rss
() {

307 
sk_t
 
sk
 = 
MACH_PORT_NULL
;

308 
sk_basic_šfo
 
t_šfo
;

309 
mach_msg_ty³_numb”_t
 
t_šfo_couÁ
 = 
TASK_BASIC_INFO_COUNT
;

311 ià(
	`sk_fÜ_pid
(
	`cu¼’t_sk
(), 
	`g‘pid
(), &
sk
è!ğ
KERN_SUCCESS
)

313 
	`sk_šfo
(
sk
, 
TASK_BASIC_INFO
, (
sk_šfo_t
)&
t_šfo
, &
t_šfo_couÁ
);

315  
t_šfo
.
»sid’t_size
;

316 
	}
}

318 
size_t
 
	$zm®loc_g‘_rss
() {

324  
	`zm®loc_u£d_memÜy
();

325 
	}
}

329 
	$zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
) {

330  ()
rss
/
	`zm®loc_u£d_memÜy
();

331 
	}
}

339 #ià
defšed
(
HAVE_PROC_SMAPS
)

340 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
) {

341 
lše
[1024];

342 
size_t
 
by‹s
 = 0;

343 
FILE
 *
å
 = 
	`fİ’
("/proc/self/smaps","r");

344 
æ’
 = 
	`¡¾’
(
f›ld
);

346 ià(!
å
)  0;

347 
	`fg‘s
(
lše
,Öše),
å
è!ğ
NULL
) {

348 ià(
	`¡ºcmp
(
lše
,
f›ld
,
æ’
) == 0) {

349 *
p
 = 
	`¡rchr
(
lše
,'k');

350 ià(
p
) {

351 *
p
 = '\0';

352 
by‹s
 +ğ
	`¡¹Ş
(
lše
+
æ’
,
NULL
,10) * 1024;

356 
	`fşo£
(
å
);

357  
by‹s
;

358 
	}
}

360 
size_t
 
	$zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
) {

361 ((è
f›ld
);

363 
	}
}

366 
size_t
 
	$zm®loc_g‘_´iv©e_dœty
() {

367  
	`zm®loc_g‘_sm­_by‹s_by_f›ld
("Private_Dirty:");

368 
	}
}

	@zmalloc.h

31 #iâdeà
__ZMALLOC_H


32 
	#__ZMALLOC_H


	)

35 
	#__x¡r
(
s
è
	`__¡r
(s)

	)

36 
	#__¡r
(
s
è#s

	)

38 #ià
defšed
(
USE_TCMALLOC
)

39 
	#ZMALLOC_LIB
 ("tcm®loc-" 
	`__x¡r
(
TC_VERSION_MAJOR
è"." __x¡r(
TC_VERSION_MINOR
))

	)

40 
	~<googË/tcm®loc.h
>

41 #ià(
TC_VERSION_MAJOR
 =ğ1 && 
TC_VERSION_MINOR
 >= 6) || (TC_VERSION_MAJOR > 1)

42 
	#HAVE_MALLOC_SIZE
 1

	)

43 
	#zm®loc_size
(
p
è
	`tc_m®loc_size
Õ)

	)

48 #–ià
defšed
(
USE_JEMALLOC
)

49 
	#ZMALLOC_LIB
 ("jem®loc-" 
	`__x¡r
(
JEMALLOC_VERSION_MAJOR
è"." __x¡r(
JEMALLOC_VERSION_MINOR
è"." __x¡r(
JEMALLOC_VERSION_BUGFIX
))

	)

50 
	~<jem®loc/jem®loc.h
>

51 #ià(
JEMALLOC_VERSION_MAJOR
 =ğ2 && 
JEMALLOC_VERSION_MINOR
 >= 1) || (JEMALLOC_VERSION_MAJOR > 2)

52 
	#HAVE_MALLOC_SIZE
 1

	)

53 
	#zm®loc_size
(
p
è
	`je_m®loc_u§bË_size
Õ)

	)

58 #–ià
defšed
(
__APPLE__
)

59 
	~<m®loc/m®loc.h
>

60 
	#HAVE_MALLOC_SIZE
 1

	)

61 
	#zm®loc_size
(
p
è
	`m®loc_size
Õ)

	)

64 #iâdeà
ZMALLOC_LIB


65 
	#ZMALLOC_LIB
 "libc"

	)

68 *
zm®loc
(
size_t
 
size
);

69 *
zÿÎoc
(
size_t
 
size
);

70 *
z»®loc
(*
±r
, 
size_t
 
size
);

71 
zä“
(*
±r
);

72 *
z¡rdup
(cÚ¡ *
s
);

73 
size_t
 
zm®loc_u£d_memÜy
();

74 
zm®loc_’abË_th»ad_§ãÃss
();

75 
zm®loc_£t_oom_hªdËr
((*
oom_hªdËr
)(
size_t
));

76 
	`zm®loc_g‘_äagm’tiÚ_¿tio
(
size_t
 
rss
);

77 
size_t
 
	`zm®loc_g‘_rss
();

78 
size_t
 
	`zm®loc_g‘_´iv©e_dœty
();

79 
size_t
 
	`zm®loc_g‘_sm­_by‹s_by_f›ld
(*
f›ld
);

80 
	`zlibc_ä“
(*
±r
);

82 #iâdeà
HAVE_MALLOC_SIZE


83 
size_t
 
	`zm®loc_size
(*
±r
);

	@/usr/include/arpa/inet.h

19 #iâdeà
_ARPA_INET_H


20 
	#_ARPA_INET_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<Ãtš‘/š.h
>

26 #iâdeà
__sockËn_t_defšed


27 
__sockËn_t
 
	tsockËn_t
;

28 
	#__sockËn_t_defšed


	)

31 
__BEGIN_DECLS


35 
š_addr_t
 
	$š‘_addr
 (
__cÚ¡
 *
__ı
è
__THROW
;

38 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

42 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

43 
__THROW
;

46 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

50 
š_addr_t
 
	$š‘_ÃtwÜk
 (
__cÚ¡
 *
__ı
è
__THROW
;

54 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

59 
	$š‘_±Ú
 (
__af
, 
__cÚ¡
 *
__»¡riù
 
__ı
,

60 *
__»¡riù
 
__buf
è
__THROW
;

65 
__cÚ¡
 *
	$š‘_Áİ
 (
__af
, 
__cÚ¡
 *
__»¡riù
 
__ı
,

66 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

67 
__THROW
;

71 #ifdeà
__USE_MISC


74 
	$š‘_©Ú
 (
__cÚ¡
 *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

78 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

83 *
	$š‘_Ãt_Áİ
 (
__af
, 
__cÚ¡
 *
__ı
, 
__b™s
,

84 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

89 
	$š‘_Ãt_±Ú
 (
__af
, 
__cÚ¡
 *
__ı
,

90 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

95 
	$š‘_n§p_addr
 (
__cÚ¡
 *
__ı
,

96 *
__buf
, 
__Ën
è
__THROW
;

100 *
	$š‘_n§p_Áß
 (
__Ën
, 
__cÚ¡
 *
__ı
,

101 *
__buf
è
__THROW
;

104 
__END_DECLS


	@/usr/include/assert.h

24 #ifdef 
_ASSERT_H


26 #undeà
_ASSERT_H


27 #undeà
as£¹


28 #undeà
__ASSERT_VOID_CAST


30 #ifdef 
__USE_GNU


31 #undeà
as£¹_³¼Ü


36 
	#_ASSERT_H
 1

	)

37 
	~<ã©u»s.h
>

39 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

40 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

42 
	#__ASSERT_VOID_CAST
 ()

	)

50 #ifdef 
NDEBUG


52 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

60 #ifdef 
__USE_GNU


61 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

66 #iâdeà
_ASSERT_H_DECLS


67 
	#_ASSERT_H_DECLS


	)

68 
__BEGIN_DECLS


71 
	$__as£¹_ç
 (
__cÚ¡
 *
__as£¹iÚ
, __cÚ¡ *
__fe
,

72 
__lše
, 
__cÚ¡
 *
__funùiÚ
)

73 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

76 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, 
__cÚ¡
 *
__fe
,

77 
__lše
,

78 
__cÚ¡
 *
__funùiÚ
)

79 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

84 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

85 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

88 
__END_DECLS


91 
	#as£¹
(
ex´
) \

92 ((
ex´
) \

93 ? 
	`__ASSERT_VOID_CAST
 (0) \

94 : 
	`__as£¹_ç
 (
	`__STRING
(
ex´
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

96 #ifdef 
__USE_GNU


97 
	#as£¹_³¼Ü
(
”ºum
) \

98 (!(
”ºum
) \

99 ? 
	`__ASSERT_VOID_CAST
 (0) \

100 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

108 #ià
defšed
 
__ılu¥lus
 ? 
	`__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

109 
	#__ASSERT_FUNCTION
 
__PRETTY_FUNCTION__


	)

111 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

112 
	#__ASSERT_FUNCTION
 
__func__


	)

114 
	#__ASSERT_FUNCTION
 ((
__cÚ¡
 *è0)

	)

	@/usr/include/ctype.h

24 #iâdef 
_CTYPE_H


25 
	#_CTYPE_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/ty³s.h
>

30 
	g__BEGIN_DECLS


32 #iâdeà
_ISb™


41 
	~<’dŸn.h
>

42 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


43 
	#_ISb™
(
b™
è(1 << (b™))

	)

45 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

50 
	m_ISuµ”
 = 
_ISb™
 (0),

51 
	m_ISlow”
 = 
_ISb™
 (1),

52 
	m_IS®pha
 = 
_ISb™
 (2),

53 
	m_ISdig™
 = 
_ISb™
 (3),

54 
	m_ISxdig™
 = 
_ISb™
 (4),

55 
	m_IS¥aû
 = 
_ISb™
 (5),

56 
	m_IS´št
 = 
_ISb™
 (6),

57 
	m_ISg¿ph
 = 
_ISb™
 (7),

58 
	m_ISbÏnk
 = 
_ISb™
 (8),

59 
	m_ISúŒl
 = 
_ISb™
 (9),

60 
	m_ISpunù
 = 
_ISb™
 (10),

61 
	m_IS®num
 = 
_ISb™
 (11)

81 
__cÚ¡
 **
	$__ùy³_b_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

83 
__cÚ¡
 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

85 
__cÚ¡
 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

86 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

91 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

92 
	#__tßscii
(
c
è((cè& 0x7fè

	)

94 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

96 
__BEGIN_NAMESPACE_STD


102 
	`__exùy³
 (
i§Êum
);

103 
	`__exùy³
 (
i§Íha
);

104 
	`__exùy³
 (
isúŒl
);

105 
	`__exùy³
 (
isdig™
);

106 
	`__exùy³
 (
i¦ow”
);

107 
	`__exùy³
 (
isg¿ph
);

108 
	`__exùy³
 (
i¥ršt
);

109 
	`__exùy³
 (
i¥unù
);

110 
	`__exùy³
 (
is¥aû
);

111 
	`__exùy³
 (
isuµ”
);

112 
	`__exùy³
 (
isxdig™
);

116 
	$tŞow”
 (
__c
è
__THROW
;

119 
	$touµ”
 (
__c
è
__THROW
;

121 
__END_NAMESPACE_STD


125 #ifdef 
__USE_ISOC99


126 
__BEGIN_NAMESPACE_C99


128 
	`__exùy³
 (
isbÏnk
);

130 
__END_NAMESPACE_C99


133 #ifdeà
__USE_GNU


135 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

138 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


142 
	$i§scii
 (
__c
è
__THROW
;

146 
	$tßscii
 (
__c
è
__THROW
;

150 
	`__exùy³
 (
_touµ”
);

151 
	`__exùy³
 (
_tŞow”
);

155 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

156 (
__ex‹nsiÚ__
 \

157 ({ 
__»s
; \

158 ià( (
c
) > 1) \

160 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

162 
__c
 = (
c
); \

163 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

166 
__»s
 = 
f
 
¬gs
; \

169 
__»s
 = (
a
)[(è(
c
)]; \

170 
__»s
; 
	}
}))

	)

172 #ià!
defšed
 
__NO_CTYPE
 && !defšed 
__ılu¥lus


173 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

174 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

175 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

176 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

177 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

178 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

179 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

180 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

181 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

182 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

183 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

185 #ifdeà
__USE_ISOC99


186 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

189 #ifdeà
__USE_EXTERN_INLINES


190 
__ex‹º_šlše
 

191 
__NTH
 (
	$tŞow”
 (
__c
))

193  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

194 
	}
}

196 
__ex‹º_šlše
 

197 
__NTH
 (
	$touµ”
 (
__c
))

199  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

200 
	}
}

203 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


204 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

205 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

208 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


209 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

210 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

212 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

213 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

219 #ifdeà
__USE_XOPEN2K8


233 
	~<xloÿË.h
>

237 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

238 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

240 
	#__exùy³_l
(
Çme
) \

241 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

247 
__exùy³_l
 (
i§Êum_l
);

248 
__exùy³_l
 (
i§Íha_l
);

249 
__exùy³_l
 (
isúŒl_l
);

250 
__exùy³_l
 (
isdig™_l
);

251 
__exùy³_l
 (
i¦ow”_l
);

252 
__exùy³_l
 (
isg¿ph_l
);

253 
__exùy³_l
 (
i¥ršt_l
);

254 
__exùy³_l
 (
i¥unù_l
);

255 
__exùy³_l
 (
is¥aû_l
);

256 
__exùy³_l
 (
isuµ”_l
);

257 
__exùy³_l
 (
isxdig™_l
);

259 
__exùy³_l
 (
isbÏnk_l
);

263 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

264 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

267 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

268 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

270 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


271 
	#__tŞow”_l
(
c
, 
loÿË
) \

272 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

273 
	#__touµ”_l
(
c
, 
loÿË
) \

274 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

275 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

276 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

280 #iâdeà
__NO_CTYPE


281 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

282 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

283 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

284 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

285 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

286 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

287 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

288 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

289 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

290 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

291 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

293 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

295 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


296 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

297 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

300 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

301 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

302 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

303 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

304 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

305 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

306 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

307 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

308 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

309 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

310 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

312 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

314 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


315 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

316 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

323 
__END_DECLS


	@/usr/include/endian.h

19 #iâdef 
_ENDIAN_H


20 
	#_ENDIAN_H
 1

	)

22 
	~<ã©u»s.h
>

32 
	#__LITTLE_ENDIAN
 1234

	)

33 
	#__BIG_ENDIAN
 4321

	)

34 
	#__PDP_ENDIAN
 3412

	)

37 
	~<b™s/’dŸn.h
>

41 #iâdeà
__FLOAT_WORD_ORDER


42 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

45 #ifdef 
__USE_BSD


46 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

47 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

48 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

49 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

52 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


53 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

54 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


55 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

59 #ifdeà
__USE_BSD


61 
	~<b™s/by‹sw­.h
>

63 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


64 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

65 
	#htŞe16
(
x
è(x)

	)

66 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

67 
	#Ë16toh
(
x
è(x)

	)

69 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

70 
	#htŞe32
(
x
è(x)

	)

71 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

72 
	#Ë32toh
(
x
è(x)

	)

74 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

75 
	#htŞe64
(
x
è(x)

	)

76 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

77 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/errno.h

23 #iâdef 
_ERRNO_H


27 #iâdef 
__Ãed_Em©h


28 
	#_ERRNO_H
 1

	)

29 
	~<ã©u»s.h
>

32 
	g__BEGIN_DECLS


36 
	~<b™s/”ºo.h
>

37 #undeà
__Ãed_Em©h


39 #ifdef 
_ERRNO_H


46 #iâdef 
”ºo


47 
”ºo
;

50 #ifdeà
__USE_GNU


55 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

59 
	g__END_DECLS


67 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


68 #iâdeà
__”rÜ_t_defšed


69 
	t”rÜ_t
;

70 
	#__”rÜ_t_defšed
 1

	)

72 #undeà
__Ãed_”rÜ_t


	@/usr/include/execinfo.h

19 #iâdeà
_EXECINFO_H


20 
	#_EXECINFO_H
 1

	)

22 
	~<ã©u»s.h
>

24 
__BEGIN_DECLS


28 
	$backŒaû
 (**
__¬¿y
, 
__size
è
	`__nÚnuÎ
 ((1));

33 **
	$backŒaû_symbŞs
 (*
__cÚ¡
 *
__¬¿y
, 
__size
)

34 
__THROW
 
	`__nÚnuÎ
 ((1));

39 
	$backŒaû_symbŞs_fd
 (*
__cÚ¡
 *
__¬¿y
, 
__size
, 
__fd
)

40 
__THROW
 
	`__nÚnuÎ
 ((1));

42 
__END_DECLS


	@/usr/include/fcntl.h

24 #iâdef 
_FCNTL_H


25 
	#_FCNTL_H
 1

	)

27 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 
	~<b™s/fú.h
>

37 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


38 
	~<b™s/ty³s.h
>

39 
	#__Ãed_time¥ec


	)

40 
	~<time.h
>

41 
	~<b™s/¡©.h
>

43 
	#S_IFMT
 
__S_IFMT


	)

44 
	#S_IFDIR
 
__S_IFDIR


	)

45 
	#S_IFCHR
 
__S_IFCHR


	)

46 
	#S_IFBLK
 
__S_IFBLK


	)

47 
	#S_IFREG
 
__S_IFREG


	)

48 #ifdeà
__S_IFIFO


49 
	#S_IFIFO
 
__S_IFIFO


	)

51 #ifdeà
__S_IFLNK


52 
	#S_IFLNK
 
__S_IFLNK


	)

54 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


55 
	#S_IFSOCK
 
__S_IFSOCK


	)

60 
	#S_ISUID
 
__S_ISUID


	)

61 
	#S_ISGID
 
__S_ISGID


	)

63 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


65 
	#S_ISVTX
 
__S_ISVTX


	)

68 
	#S_IRUSR
 
__S_IREAD


	)

69 
	#S_IWUSR
 
__S_IWRITE


	)

70 
	#S_IXUSR
 
__S_IEXEC


	)

72 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

74 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

75 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

76 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

78 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

80 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

81 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

82 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

84 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

87 #ifdef 
__USE_MISC


88 #iâdeà
R_OK


91 
	#R_OK
 4

	)

92 
	#W_OK
 2

	)

93 
	#X_OK
 1

	)

94 
	#F_OK
 0

	)

99 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


100 
	#SEEK_SET
 0

	)

101 
	#SEEK_CUR
 1

	)

102 
	#SEEK_END
 2

	)

110 
fú
 (
__fd
, 
__cmd
, ...);

118 #iâdeà
__USE_FILE_OFFSET64


119 
	$İ’
 (
__cÚ¡
 *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

121 #ifdeà
__REDIRECT


122 
	`__REDIRECT
 (
İ’
, (
__cÚ¡
 *
__fe
, 
__oæag
, ...), 
İ’64
)

123 
	`__nÚnuÎ
 ((1));

125 
	#İ’
 
İ’64


	)

128 #ifdeà
__USE_LARGEFILE64


129 
	$İ’64
 (
__cÚ¡
 *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

132 #ifdeà
__USE_ATFILE


142 #iâdeà
__USE_FILE_OFFSET64


143 
	$İ’©
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
, ...)

144 
	`__nÚnuÎ
 ((2));

146 #ifdeà
__REDIRECT


147 
	`__REDIRECT
 (
İ’©
, (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
,

148 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

150 
	#İ’©
 
İ’©64


	)

153 #ifdeà
__USE_LARGEFILE64


154 
	$İ’©64
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
, ...)

155 
	`__nÚnuÎ
 ((2));

164 #iâdeà
__USE_FILE_OFFSET64


165 
	$ü—t
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

167 #ifdeà
__REDIRECT


168 
	`__REDIRECT
 (
ü—t
, (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
),

169 
ü—t64
è
	`__nÚnuÎ
 ((1));

171 
	#ü—t
 
ü—t64


	)

174 #ifdeà
__USE_LARGEFILE64


175 
	$ü—t64
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

178 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

179 && !
defšed
 
__USE_POSIX
))

188 
	#F_ULOCK
 0

	)

189 
	#F_LOCK
 1

	)

190 
	#F_TLOCK
 2

	)

191 
	#F_TEST
 3

	)

193 #iâdeà
__USE_FILE_OFFSET64


194 
	`lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
);

196 #ifdeà
__REDIRECT


197 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

199 
	#lockf
 
lockf64


	)

202 #ifdeà
__USE_LARGEFILE64


203 
	`lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
);

207 #ifdeà
__USE_XOPEN2K


210 #iâdeà
__USE_FILE_OFFSET64


211 
	$posix_çdvi£
 (
__fd
, 
__off_t
 
__off£t
, __off_ˆ
__Ën
,

212 
__advi£
è
__THROW
;

214 #ifdeà
__REDIRECT_NTH


215 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

216 
__off64_t
 
__Ën
, 
__advi£
),

217 
posix_çdvi£64
);

219 
	#posix_çdvi£
 
posix_çdvi£64


	)

222 #ifdeà
__USE_LARGEFILE64


223 
	$posix_çdvi£64
 (
__fd
, 
__off64_t
 
__off£t
, __off64_ˆ
__Ën
,

224 
__advi£
è
__THROW
;

232 #iâdeà
__USE_FILE_OFFSET64


233 
	`posix_çÎoÿ‹
 (
__fd
, 
__off_t
 
__off£t
, __off_ˆ
__Ën
);

235 #ifdeà
__REDIRECT


236 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

237 
__off64_t
 
__Ën
),

238 
posix_çÎoÿ‹64
);

240 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

243 #ifdeà
__USE_LARGEFILE64


244 
	`posix_çÎoÿ‹64
 (
__fd
, 
__off64_t
 
__off£t
, __off64_ˆ
__Ën
);

250 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše
 \

251 && 
defšed
 
__va_¬g_·ck_Ën


252 
	~<b™s/fú2.h
>

255 
__END_DECLS


	@/usr/include/features.h

20 #iâdef 
_FEATURES_H


21 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC99


98 #undeà
__USE_ISOC95


99 #undeà
__USE_POSIX


100 #undeà
__USE_POSIX2


101 #undeà
__USE_POSIX199309


102 #undeà
__USE_POSIX199506


103 #undeà
__USE_XOPEN


104 #undeà
__USE_XOPEN_EXTENDED


105 #undeà
__USE_UNIX98


106 #undeà
__USE_XOPEN2K


107 #undeà
__USE_XOPEN2KXSI


108 #undeà
__USE_XOPEN2K8


109 #undeà
__USE_XOPEN2K8XSI


110 #undeà
__USE_LARGEFILE


111 #undeà
__USE_LARGEFILE64


112 #undeà
__USE_FILE_OFFSET64


113 #undeà
__USE_BSD


114 #undeà
__USE_SVID


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__FAVOR_BSD


121 #undeà
__KERNEL_STRICT_NAMES


125 #iâdeà
_LOOSE_KERNEL_NAMES


126 
	#__KERNEL_STRICT_NAMES


	)

130 
	#__USE_ANSI
 1

	)

139 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


140 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

141 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

143 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

148 #ià
defšed
 
_BSD_SOURCE
 && \

149 !(
defšed
 
	g_POSIX_SOURCE
 || defšed 
	g_POSIX_C_SOURCE
 || \

150 
defšed
 
	g_XOPEN_SOURCE
 || defšed 
	g_GNU_SOURCE
 || defšed 
	g_SVID_SOURCE
)

151 
	#__FAVOR_BSD
 1

	)

155 #ifdeà
_GNU_SOURCE


156 #undeà
_ISOC95_SOURCE


157 
	#_ISOC95_SOURCE
 1

	)

158 #undeà
_ISOC99_SOURCE


159 
	#_ISOC99_SOURCE
 1

	)

160 #undeà
_POSIX_SOURCE


161 
	#_POSIX_SOURCE
 1

	)

162 #undeà
_POSIX_C_SOURCE


163 
	#_POSIX_C_SOURCE
 200809L

	)

164 #undeà
_XOPEN_SOURCE


165 
	#_XOPEN_SOURCE
 700

	)

166 #undeà
_XOPEN_SOURCE_EXTENDED


167 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

168 #undeà
_LARGEFILE64_SOURCE


169 
	#_LARGEFILE64_SOURCE
 1

	)

170 #undeà
_BSD_SOURCE


171 
	#_BSD_SOURCE
 1

	)

172 #undeà
_SVID_SOURCE


173 
	#_SVID_SOURCE
 1

	)

174 #undeà
_ATFILE_SOURCE


175 
	#_ATFILE_SOURCE
 1

	)

180 #ià(!
defšed
 
__STRICT_ANSI__
 && !defšed 
_ISOC99_SOURCE
 && \

181 !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 && \

182 !
defšed
 
	g_XOPEN_SOURCE
 && !defšed 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
)

183 
	#_BSD_SOURCE
 1

	)

184 
	#_SVID_SOURCE
 1

	)

191 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

192 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

193 
	#__USE_ISOC99
 1

	)

197 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

198 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

199 
	#__USE_ISOC95
 1

	)

204 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

205 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

206 
	#_POSIX_SOURCE
 1

	)

207 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

208 
	#_POSIX_C_SOURCE
 2

	)

209 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

210 
	#_POSIX_C_SOURCE
 199506L

	)

211 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

212 
	#_POSIX_C_SOURCE
 200112L

	)

214 
	#_POSIX_C_SOURCE
 200809L

	)

216 
	#__USE_POSIX_IMPLICITLY
 1

	)

219 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


220 
	#__USE_POSIX
 1

	)

223 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


224 
	#__USE_POSIX2
 1

	)

227 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

228 
	#__USE_POSIX199309
 1

	)

231 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

232 
	#__USE_POSIX199506
 1

	)

235 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

236 
	#__USE_XOPEN2K
 1

	)

237 #undeà
__USE_ISOC95


238 
	#__USE_ISOC95
 1

	)

239 #undeà
__USE_ISOC99


240 
	#__USE_ISOC99
 1

	)

243 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

244 
	#__USE_XOPEN2K8
 1

	)

245 #undeà
_ATFILE_SOURCE


246 
	#_ATFILE_SOURCE
 1

	)

249 #ifdef 
_XOPEN_SOURCE


250 
	#__USE_XOPEN
 1

	)

251 #ià(
_XOPEN_SOURCE
 - 0) >= 500

252 
	#__USE_XOPEN_EXTENDED
 1

	)

253 
	#__USE_UNIX98
 1

	)

254 #undeà
_LARGEFILE_SOURCE


255 
	#_LARGEFILE_SOURCE
 1

	)

256 #ià(
_XOPEN_SOURCE
 - 0) >= 600

257 #ià(
_XOPEN_SOURCE
 - 0) >= 700

258 
	#__USE_XOPEN2K8
 1

	)

259 
	#__USE_XOPEN2K8XSI
 1

	)

261 
	#__USE_XOPEN2K
 1

	)

262 
	#__USE_XOPEN2KXSI
 1

	)

263 #undeà
__USE_ISOC95


264 
	#__USE_ISOC95
 1

	)

265 #undeà
__USE_ISOC99


266 
	#__USE_ISOC99
 1

	)

269 #ifdeà
_XOPEN_SOURCE_EXTENDED


270 
	#__USE_XOPEN_EXTENDED
 1

	)

275 #ifdeà
_LARGEFILE_SOURCE


276 
	#__USE_LARGEFILE
 1

	)

279 #ifdeà
_LARGEFILE64_SOURCE


280 
	#__USE_LARGEFILE64
 1

	)

283 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

284 
	#__USE_FILE_OFFSET64
 1

	)

287 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


288 
	#__USE_MISC
 1

	)

291 #ifdef 
_BSD_SOURCE


292 
	#__USE_BSD
 1

	)

295 #ifdef 
_SVID_SOURCE


296 
	#__USE_SVID
 1

	)

299 #ifdef 
_ATFILE_SOURCE


300 
	#__USE_ATFILE
 1

	)

303 #ifdef 
_GNU_SOURCE


304 
	#__USE_GNU
 1

	)

307 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


308 
	#__USE_REENTRANT
 1

	)

311 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

312 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

313 #ià
_FORTIFY_SOURCE
 > 1

314 
	#__USE_FORTIFY_LEVEL
 2

	)

316 
	#__USE_FORTIFY_LEVEL
 1

	)

319 
	#__USE_FORTIFY_LEVEL
 0

	)

323 
	~<b™s/´edefs.h
>

326 
	#__STDC_ISO_10646__
 200009L

	)

334 #undeà
__GNU_LIBRARY__


335 
	#__GNU_LIBRARY__
 6

	)

339 
	#__GLIBC__
 2

	)

340 
	#__GLIBC_MINOR__
 13

	)

342 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

343 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

346 #ià
defšed
 
__GNUC__
 \

347 || (
defšed
 
	g__PGI
 && defšed 
	g__i386__
 ) \

348 || (
defšed
 
	g__INTEL_COMPILER
 && (defšed 
	g__i386__
 || defšed 
	g__Ÿ64__
)) \

349 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

350 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

354 #iâdeà
__ASSEMBLER__


355 #iâdeà
_SYS_CDEFS_H


356 
	~<sys/cdefs.h
>

361 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


362 
	#__USE_LARGEFILE
 1

	)

363 
	#__USE_LARGEFILE64
 1

	)

369 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

370 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

371 && 
defšed
 
	g__ex‹º_šlše


372 
	#__USE_EXTERN_INLINES
 1

	)

377 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

378 && (
defšed
 
	g_LIBC
 || !defšed 
	g__OPTIMIZE_SIZE__
è&& !defšed 
	g__NO_INLINE__
 \

379 && 
defšed
 
	g__ex‹º_šlše


380 
	#__USE_EXTERN_INLINES_IN_LIBC
 1

	)

388 
	~<gnu/¡ubs.h
>

	@/usr/include/inttypes.h

23 #iâdeà
_INTTYPES_H


24 
	#_INTTYPES_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	~<¡dšt.h
>

31 #iâdeà
____gwch¬_t_defšed


32 #ifdeà
__ılu¥lus


33 
	#__gwch¬_t
 
wch¬_t


	)

34 #–ià
defšed
 
__WCHAR_TYPE__


35 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

37 
	#__Ãed_wch¬_t


	)

38 
	~<¡ddef.h
>

39 
wch¬_t
 
	t__gwch¬_t
;

41 
	#____gwch¬_t_defšed
 1

	)

47 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_FORMAT_MACROS


49 #ià
__WORDSIZE
 == 64

50 
	#__PRI64_PREFIX
 "l"

	)

51 
	#__PRIPTR_PREFIX
 "l"

	)

53 
	#__PRI64_PREFIX
 "Î"

	)

54 
	#__PRIPTR_PREFIX


	)

60 
	#PRId8
 "d"

	)

61 
	#PRId16
 "d"

	)

62 
	#PRId32
 "d"

	)

63 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

65 
	#PRIdLEAST8
 "d"

	)

66 
	#PRIdLEAST16
 "d"

	)

67 
	#PRIdLEAST32
 "d"

	)

68 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIdFAST8
 "d"

	)

71 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

72 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

73 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

76 
	#PRIi8
 "i"

	)

77 
	#PRIi16
 "i"

	)

78 
	#PRIi32
 "i"

	)

79 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

81 
	#PRIiLEAST8
 "i"

	)

82 
	#PRIiLEAST16
 "i"

	)

83 
	#PRIiLEAST32
 "i"

	)

84 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIiFAST8
 "i"

	)

87 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

88 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

89 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

92 
	#PRIo8
 "o"

	)

93 
	#PRIo16
 "o"

	)

94 
	#PRIo32
 "o"

	)

95 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

97 
	#PRIoLEAST8
 "o"

	)

98 
	#PRIoLEAST16
 "o"

	)

99 
	#PRIoLEAST32
 "o"

	)

100 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIoFAST8
 "o"

	)

103 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

104 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

105 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

108 
	#PRIu8
 "u"

	)

109 
	#PRIu16
 "u"

	)

110 
	#PRIu32
 "u"

	)

111 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

113 
	#PRIuLEAST8
 "u"

	)

114 
	#PRIuLEAST16
 "u"

	)

115 
	#PRIuLEAST32
 "u"

	)

116 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIuFAST8
 "u"

	)

119 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

120 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

121 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

124 
	#PRIx8
 "x"

	)

125 
	#PRIx16
 "x"

	)

126 
	#PRIx32
 "x"

	)

127 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

129 
	#PRIxLEAST8
 "x"

	)

130 
	#PRIxLEAST16
 "x"

	)

131 
	#PRIxLEAST32
 "x"

	)

132 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIxFAST8
 "x"

	)

135 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

136 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

137 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

140 
	#PRIX8
 "X"

	)

141 
	#PRIX16
 "X"

	)

142 
	#PRIX32
 "X"

	)

143 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

145 
	#PRIXLEAST8
 "X"

	)

146 
	#PRIXLEAST16
 "X"

	)

147 
	#PRIXLEAST32
 "X"

	)

148 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

150 
	#PRIXFAST8
 "X"

	)

151 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

152 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

153 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

157 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

158 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

159 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

160 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

161 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

162 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

166 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

167 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

168 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

169 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

170 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

171 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

177 
	#SCNd8
 "hhd"

	)

178 
	#SCNd16
 "hd"

	)

179 
	#SCNd32
 "d"

	)

180 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

182 
	#SCNdLEAST8
 "hhd"

	)

183 
	#SCNdLEAST16
 "hd"

	)

184 
	#SCNdLEAST32
 "d"

	)

185 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNdFAST8
 "hhd"

	)

188 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

189 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

190 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

193 
	#SCNi8
 "hhi"

	)

194 
	#SCNi16
 "hi"

	)

195 
	#SCNi32
 "i"

	)

196 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

198 
	#SCNiLEAST8
 "hhi"

	)

199 
	#SCNiLEAST16
 "hi"

	)

200 
	#SCNiLEAST32
 "i"

	)

201 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNiFAST8
 "hhi"

	)

204 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

205 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

206 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

209 
	#SCNu8
 "hhu"

	)

210 
	#SCNu16
 "hu"

	)

211 
	#SCNu32
 "u"

	)

212 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

214 
	#SCNuLEAST8
 "hhu"

	)

215 
	#SCNuLEAST16
 "hu"

	)

216 
	#SCNuLEAST32
 "u"

	)

217 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNuFAST8
 "hhu"

	)

220 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

221 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

222 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

225 
	#SCNo8
 "hho"

	)

226 
	#SCNo16
 "ho"

	)

227 
	#SCNo32
 "o"

	)

228 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

230 
	#SCNoLEAST8
 "hho"

	)

231 
	#SCNoLEAST16
 "ho"

	)

232 
	#SCNoLEAST32
 "o"

	)

233 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNoFAST8
 "hho"

	)

236 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

237 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

238 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

241 
	#SCNx8
 "hhx"

	)

242 
	#SCNx16
 "hx"

	)

243 
	#SCNx32
 "x"

	)

244 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

246 
	#SCNxLEAST8
 "hhx"

	)

247 
	#SCNxLEAST16
 "hx"

	)

248 
	#SCNxLEAST32
 "x"

	)

249 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

251 
	#SCNxFAST8
 "hhx"

	)

252 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

253 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

254 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

258 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

259 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

260 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

261 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

262 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

265 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

266 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

267 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

268 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

269 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

274 
	g__BEGIN_DECLS


276 #ià
__WORDSIZE
 == 64

281 
	mquÙ
;

282 
	m»m
;

283 } 
	timaxdiv_t
;

290 
	mquÙ
;

291 
	m»m
;

292 } 
	timaxdiv_t
;

298 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

301 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

302 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

305 
štmax_t
 
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

306 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

309 
uštmax_t
 
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

310 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

313 
štmax_t
 
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

314 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

315 
__THROW
;

318 
uštmax_t
 
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

319 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

320 
__THROW
;

322 #ifdeà
__USE_EXTERN_INLINES


324 #ià
__WORDSIZE
 == 64

326 
	$__¡¹Ş_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

327 **
__»¡riù
 
__’d±r
,

328 
__ba£
, 
__group
)

329 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

331 
__ex‹º_šlše
 
štmax_t


332 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

333 
ba£
))

335  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

336 
	}
}

338 
	$__¡¹oul_š‹º®
 (
__cÚ¡
 *

339 
__»¡riù
 
__ÅŒ
,

340 ** 
__»¡riù
 
__’d±r
,

341 
__ba£
, 
__group
)

342 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

344 
__ex‹º_šlše
 
uštmax_t


345 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

346 
ba£
))

348  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

349 
	}
}

351 
	$__wc¡Ş_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

352 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

353 
__ba£
, 
__group
)

354 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

356 
__ex‹º_šlše
 
štmax_t


357 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

358 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

360  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

361 
	}
}

363 
	$__wc¡oul_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

364 
__»¡riù
 
__ÅŒ
,

365 
__gwch¬_t
 **

366 
__»¡riù
 
__’d±r
,

367 
__ba£
, 
__group
)

368 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

370 
__ex‹º_šlše
 
uštmax_t


371 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

372 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

374  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

375 
	}
}

379 
__ex‹nsiÚ__


380 
	$__¡¹Şl_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

381 **
__»¡riù
 
__’d±r
,

382 
__ba£
, 
__group
)

383 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

385 
__ex‹º_šlše
 
štmax_t


386 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

387 
ba£
))

389  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

390 
	}
}

392 
__ex‹nsiÚ__


393 
	$__¡¹ouÎ_š‹º®
 (
__cÚ¡
 *

394 
__»¡riù
 
__ÅŒ
,

396 
__»¡riù
 
__’d±r
,

397 
__ba£
,

398 
__group
)

399 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

401 
__ex‹º_šlše
 
uštmax_t


402 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

403 
ba£
))

405  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

406 
	}
}

408 
__ex‹nsiÚ__


409 
	$__wc¡Şl_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

410 
__»¡riù
 
__ÅŒ
,

411 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

412 
__ba£
, 
__group
)

413 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

415 
__ex‹º_šlše
 
štmax_t


416 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

417 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

419  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

420 
	}
}

423 
__ex‹nsiÚ__


424 
	$__wc¡ouÎ_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

425 
__»¡riù
 
__ÅŒ
,

426 
__gwch¬_t
 **

427 
__»¡riù
 
__’d±r
,

428 
__ba£
,

429 
__group
)

430 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

432 
__ex‹º_šlše
 
uštmax_t


433 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

434 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

436  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

437 
	}
}

442 
	g__END_DECLS


	@/usr/include/limits.h

24 #iâdeà
_LIBC_LIMITS_H_


25 
	#_LIBC_LIMITS_H_
 1

	)

27 
	~<ã©u»s.h
>

33 
	#MB_LEN_MAX
 16

	)

38 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

43 #iâdeà
_LIMITS_H


44 
	#_LIMITS_H
 1

	)

46 
	~<b™s/wÜdsize.h
>

55 
	#CHAR_BIT
 8

	)

58 
	#SCHAR_MIN
 (-128)

	)

59 
	#SCHAR_MAX
 127

	)

62 
	#UCHAR_MAX
 255

	)

65 #ifdeà
__CHAR_UNSIGNED__


66 
	#CHAR_MIN
 0

	)

67 
	#CHAR_MAX
 
UCHAR_MAX


	)

69 
	#CHAR_MIN
 
SCHAR_MIN


	)

70 
	#CHAR_MAX
 
SCHAR_MAX


	)

74 
	#SHRT_MIN
 (-32768)

	)

75 
	#SHRT_MAX
 32767

	)

78 
	#USHRT_MAX
 65535

	)

81 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

82 
	#INT_MAX
 2147483647

	)

85 
	#UINT_MAX
 4294967295U

	)

88 #ià
__WORDSIZE
 == 64

89 
	#LONG_MAX
 9223372036854775807L

	)

91 
	#LONG_MAX
 2147483647L

	)

93 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

96 #ià
__WORDSIZE
 == 64

97 
	#ULONG_MAX
 18446744073709551615UL

	)

99 
	#ULONG_MAX
 4294967295UL

	)

102 #ifdeà
__USE_ISOC99


105 
	#LLONG_MAX
 9223372036854775807LL

	)

106 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

109 
	#ULLONG_MAX
 18446744073709551615ULL

	)

123 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


125 #šşude_Ãxˆ<
lim™s
.
h
>

131 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


132 #iâdeà
LLONG_MIN


133 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

135 #iâdeà
LLONG_MAX


136 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

138 #iâdeà
ULLONG_MAX


139 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

143 #ifdef 
__USE_POSIX


145 
	~<b™s/posix1_lim.h
>

148 #ifdef 
__USE_POSIX2


149 
	~<b™s/posix2_lim.h
>

152 #ifdef 
__USE_XOPEN


153 
	~<b™s/xİ’_lim.h
>

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 196625

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/locale.h

23 #iâdef 
_LOCALE_H


24 
	#_LOCALE_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	#__Ãed_NULL


	)

29 
	~<¡ddef.h
>

30 
	~<b™s/loÿË.h
>

32 
	g__BEGIN_DECLS


36 
	#LC_CTYPE
 
__LC_CTYPE


	)

37 
	#LC_NUMERIC
 
__LC_NUMERIC


	)

38 
	#LC_TIME
 
__LC_TIME


	)

39 
	#LC_COLLATE
 
__LC_COLLATE


	)

40 
	#LC_MONETARY
 
__LC_MONETARY


	)

41 
	#LC_MESSAGES
 
__LC_MESSAGES


	)

42 
	#LC_ALL
 
__LC_ALL


	)

43 
	#LC_PAPER
 
__LC_PAPER


	)

44 
	#LC_NAME
 
__LC_NAME


	)

45 
	#LC_ADDRESS
 
__LC_ADDRESS


	)

46 
	#LC_TELEPHONE
 
__LC_TELEPHONE


	)

47 
	#LC_MEASUREMENT
 
__LC_MEASUREMENT


	)

48 
	#LC_IDENTIFICATION
 
__LC_IDENTIFICATION


	)

51 
__BEGIN_NAMESPACE_STD


54 
	slcÚv


58 *
	mdecim®_pošt
;

59 *
	mthou§nds_£p
;

65 *
	mgroupšg
;

71 *
	mšt_cu¼_symbŞ
;

72 *
	mcu¼’cy_symbŞ
;

73 *
	mmÚ_decim®_pošt
;

74 *
	mmÚ_thou§nds_£p
;

75 *
	mmÚ_groupšg
;

76 *
	mpos™ive_sign
;

77 *
	mÃg©ive_sign
;

78 
	mšt_äac_dig™s
;

79 
	mäac_dig™s
;

81 
	mp_cs_´eûdes
;

83 
	mp_£p_by_¥aû
;

85 
	mn_cs_´eûdes
;

87 
	mn_£p_by_¥aû
;

94 
	mp_sign_po¢
;

95 
	mn_sign_po¢
;

96 #ifdeà
__USE_ISOC99


98 
	mšt_p_cs_´eûdes
;

100 
	mšt_p_£p_by_¥aû
;

102 
	mšt_n_cs_´eûdes
;

104 
	mšt_n_£p_by_¥aû
;

111 
	mšt_p_sign_po¢
;

112 
	mšt_n_sign_po¢
;

114 
	m__št_p_cs_´eûdes
;

115 
	m__št_p_£p_by_¥aû
;

116 
	m__št_n_cs_´eûdes
;

117 
	m__št_n_£p_by_¥aû
;

118 
	m__št_p_sign_po¢
;

119 
	m__št_n_sign_po¢
;

125 *
	$£oÿË
 (
__ÿ‹gÜy
, 
__cÚ¡
 *
__loÿË
è
__THROW
;

128 
lcÚv
 *
	$loÿËcÚv
 (è
__THROW
;

130 
__END_NAMESPACE_STD


133 #ifdef 
__USE_XOPEN2K8


146 
	~<xloÿË.h
>

152 
__loÿË_t
 
	$ÃwloÿË
 (
__ÿ‹gÜy_mask
, 
__cÚ¡
 *
__loÿË
,

153 
__loÿË_t
 
__ba£
è
__THROW
;

159 
	#LC_CTYPE_MASK
 (1 << 
__LC_CTYPE
)

	)

160 
	#LC_NUMERIC_MASK
 (1 << 
__LC_NUMERIC
)

	)

161 
	#LC_TIME_MASK
 (1 << 
__LC_TIME
)

	)

162 
	#LC_COLLATE_MASK
 (1 << 
__LC_COLLATE
)

	)

163 
	#LC_MONETARY_MASK
 (1 << 
__LC_MONETARY
)

	)

164 
	#LC_MESSAGES_MASK
 (1 << 
__LC_MESSAGES
)

	)

165 
	#LC_PAPER_MASK
 (1 << 
__LC_PAPER
)

	)

166 
	#LC_NAME_MASK
 (1 << 
__LC_NAME
)

	)

167 
	#LC_ADDRESS_MASK
 (1 << 
__LC_ADDRESS
)

	)

168 
	#LC_TELEPHONE_MASK
 (1 << 
__LC_TELEPHONE
)

	)

169 
	#LC_MEASUREMENT_MASK
 (1 << 
__LC_MEASUREMENT
)

	)

170 
	#LC_IDENTIFICATION_MASK
 (1 << 
__LC_IDENTIFICATION
)

	)

171 
	#LC_ALL_MASK
 (
LC_CTYPE_MASK
 \

172 | 
LC_NUMERIC_MASK
 \

173 | 
LC_TIME_MASK
 \

174 | 
LC_COLLATE_MASK
 \

175 | 
LC_MONETARY_MASK
 \

176 | 
LC_MESSAGES_MASK
 \

177 | 
LC_PAPER_MASK
 \

178 | 
LC_NAME_MASK
 \

179 | 
LC_ADDRESS_MASK
 \

180 | 
LC_TELEPHONE_MASK
 \

181 | 
LC_MEASUREMENT_MASK
 \

182 | 
LC_IDENTIFICATION_MASK
 \

183 )

	)

187 
__loÿË_t
 
	$du¶oÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

191 
	$ä“loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

198 
__loÿË_t
 
	$u£loÿË
 (
__loÿË_t
 
__d©a£t
è
__THROW
;

202 
	#LC_GLOBAL_LOCALE
 ((
__loÿË_t
è-1L)

	)

206 
__END_DECLS


	@/usr/include/math.h

25 #iâdef 
_MATH_H


26 
	#_MATH_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 
	~<b™s/huge_v®.h
>

35 #ifdeà
__USE_ISOC99


36 
	~<b™s/huge_v®f.h
>

37 
	~<b™s/huge_v®l.h
>

40 
	~<b™s/šf.h
>

43 
	~<b™s/Çn.h
>

47 
	~<b™s/m©hdef.h
>

54 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

55 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

56 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

57 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

58 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

59 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

60 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

61 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

62 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

63 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

64 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

65 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

67 
	#_MdoubË_
 

	)

68 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

69 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_STD


	)

70 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_STD


	)

71 
	~<b™s/m©hÿÎs.h
>

72 #undeà
_MdoubË_


73 #undeà
_MdoubË_BEGIN_NAMESPACE


74 #undeà
_MdoubË_END_NAMESPACE


75 #undeà
__MATH_PRECNAME


77 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


83 #iâdeà
_Mæßt_


84 
	#_Mæßt_
 

	)

86 
	#_MdoubË_
 
_Mæßt_


	)

87 #ifdeà
__STDC__


88 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

90 
	#__MATH_PRECNAME
(
Çme
,
r
èÇm
f
 
	)
r

92 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

93 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

94 
	~<b™s/m©hÿÎs.h
>

95 #undeà
_MdoubË_


96 #undeà
_MdoubË_BEGIN_NAMESPACE


97 #undeà
_MdoubË_END_NAMESPACE


98 #undeà
__MATH_PRECNAME


100 #ià(
__STDC__
 - 0 || 
__GNUC__
 - 0) \

101 && (!
defšed
 
__NO_LONG_DOUBLE_MATH
 \

102 || 
defšed
 
__LDBL_COMPAT
 \

103 || !
defšed
 
_LIBC
)

104 #ifdeà
__LDBL_COMPAT


106 #ifdeà
__USE_ISOC99


107 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

108 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

109 #ifdeà
__REDIRECT_NTH


110 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

111 
__Ædbl_Ãx‰ow¬df
)

112 
	`__©Œibu‹__
 ((
__cÚ¡__
));

113 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

114 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

115 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

116 (
__x
, 
__y
),

117 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

122 #ià
defšed
 
__LDBL_COMPAT
 || defšed 
__NO_LONG_DOUBLE_MATH


124 #undeà
__MATHDECL_1


125 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

126 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

127 
¬gs
, 
®Ÿs
)

	)

128 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

129 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

134 #iâdeà
_MlÚg_doubË_


135 
	#_MlÚg_doubË_
 

	)

137 
	#_MdoubË_
 
_MlÚg_doubË_


	)

138 #ifdeà
__STDC__


139 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

141 
	#__MATH_PRECNAME
(
Çme
,
r
èÇm
l
 
	)
r

143 
	#_MdoubË_BEGIN_NAMESPACE
 
__BEGIN_NAMESPACE_C99


	)

144 
	#_MdoubË_END_NAMESPACE
 
__END_NAMESPACE_C99


	)

145 
	~<b™s/m©hÿÎs.h
>

146 #undeà
_MdoubË_


147 #undeà
_MdoubË_BEGIN_NAMESPACE


148 #undeà
_MdoubË_END_NAMESPACE


149 #undeà
__MATH_PRECNAME


154 #undeà
__MATHDECL_1


155 #undeà
__MATHDECL


156 #undeà
__MATHCALL


159 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


161 
signgam
;

166 #ifdeà
__USE_ISOC99


204 
FP_NAN
,

205 
	#FP_NAN
 
FP_NAN


	)

206 
FP_INFINITE
,

207 
	#FP_INFINITE
 
FP_INFINITE


	)

208 
FP_ZERO
,

209 
	#FP_ZERO
 
FP_ZERO


	)

210 
FP_SUBNORMAL
,

211 
	#FP_SUBNORMAL
 
FP_SUBNORMAL


	)

212 
FP_NORMAL


213 
	#FP_NORMAL
 
FP_NORMAL


	)

217 #ifdeà
__NO_LONG_DOUBLE_MATH


218 
	#åşassify
(
x
) \

219 ( (
x
è=ğ (è? 
	`__åşassifyf
 (xè: 
	`__åşassify
 (x))

	)

221 
	#åşassify
(
x
) \

222 ( (
x
) ==  () \

223 ? 
	`__åşassifyf
 (
x
) \

224 :  (
x
) ==  () \

225 ? 
	`__åşassify
 (
x
è: 
	`__åşassifyl
 (x))

	)

229 #ifdeà
__NO_LONG_DOUBLE_MATH


230 
	#signb™
(
x
) \

231 ( (
x
è=ğ (è? 
	`__signb™f
 (xè: 
	`__signb™
 (x))

	)

233 
	#signb™
(
x
) \

234 ( (
x
) ==  () \

235 ? 
	`__signb™f
 (
x
) \

236 :  (
x
) ==  () \

237 ? 
	`__signb™
 (
x
è: 
	`__signb™l
 (x))

	)

241 #ifdeà
__NO_LONG_DOUBLE_MATH


242 
	#isfš™e
(
x
) \

243 ( (
x
è=ğ (è? 
	`__fš™ef
 (xè: 
	`__fš™e
 (x))

	)

245 
	#isfš™e
(
x
) \

246 ( (
x
) ==  () \

247 ? 
	`__fš™ef
 (
x
) \

248 :  (
x
) ==  () \

249 ? 
	`__fš™e
 (
x
è: 
	`__fš™–
 (x))

	)

253 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

257 #ifdeà
__NO_LONG_DOUBLE_MATH


258 
	#i¢ª
(
x
) \

259 ( (
x
è=ğ (è? 
	`__i¢ªf
 (xè: 
	`__i¢ª
 (x))

	)

261 
	#i¢ª
(
x
) \

262 ( (
x
) ==  () \

263 ? 
	`__i¢ªf
 (
x
) \

264 :  (
x
) ==  () \

265 ? 
	`__i¢ª
 (
x
è: 
	`__i¢ªl
 (x))

	)

269 #ifdeà
__NO_LONG_DOUBLE_MATH


270 
	#isšf
(
x
) \

271 ( (
x
è=ğ (è? 
	`__isšff
 (xè: 
	`__isšf
 (x))

	)

273 
	#isšf
(
x
) \

274 ( (
x
) ==  () \

275 ? 
	`__isšff
 (
x
) \

276 :  (
x
) ==  () \

277 ? 
	`__isšf
 (
x
è: 
	`__isšæ
 (x))

	)

281 
	#MATH_ERRNO
 1

	)

282 
	#MATH_ERREXCEPT
 2

	)

287 #iâdeà
__FAST_MATH__


288 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

293 #ifdef 
__USE_MISC


297 
_IEEE_
 = -1,

298 
_SVID_
,

299 
_XOPEN_
,

300 
_POSIX_
,

301 
_ISOC_


302 } 
	t_LIB_VERSION_TYPE
;

307 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

311 #ifdeà
__USE_SVID


317 #ifdeà
__ılu¥lus


318 
__exû±iÚ


320 
exû±iÚ


323 
ty³
;

324 *
Çme
;

325 
¬g1
;

326 
¬g2
;

327 
»tv®
;

328 
	}
};

330 #ifdeà
__ılu¥lus


331 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

333 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

336 
	#X_TLOSS
 1.41484755040568800000e+16

	)

339 
	#DOMAIN
 1

	)

340 
	#SING
 2

	)

341 
	#OVERFLOW
 3

	)

342 
	#UNDERFLOW
 4

	)

343 
	#TLOSS
 5

	)

344 
	#PLOSS
 6

	)

347 
	#HUGE
 3.40282347e+38F

	)

351 #ifdeà
__USE_XOPEN


353 
	#MAXFLOAT
 3.40282347e+38F

	)

360 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


361 
	#M_E
 2.7182818284590452354

	)

362 
	#M_LOG2E
 1.4426950408889634074

	)

363 
	#M_LOG10E
 0.43429448190325182765

	)

364 
	#M_LN2
 0.69314718055994530942

	)

365 
	#M_LN10
 2.30258509299404568402

	)

366 
	#M_PI
 3.14159265358979323846

	)

367 
	#M_PI_2
 1.57079632679489661923

	)

368 
	#M_PI_4
 0.78539816339744830962

	)

369 
	#M_1_PI
 0.31830988618379067154

	)

370 
	#M_2_PI
 0.63661977236758134308

	)

371 
	#M_2_SQRTPI
 1.12837916709551257390

	)

372 
	#M_SQRT2
 1.41421356237309504880

	)

373 
	#M_SQRT1_2
 0.70710678118654752440

	)

379 #ifdeà
__USE_GNU


380 
	#M_El
 2.7182818284590452353602874713526625L

	)

381 
	#M_LOG2El
 1.4426950408889634073599246810018921L

	)

382 
	#M_LOG10El
 0.4342944819032518276511289189166051L

	)

383 
	#M_LN2l
 0.6931471805599453094172321214581766L

	)

384 
	#M_LN10l
 2.3025850929940456840179914546843642L

	)

385 
	#M_PIl
 3.1415926535897932384626433832795029L

	)

386 
	#M_PI_2l
 1.5707963267948966192313216916397514L

	)

387 
	#M_PI_4l
 0.7853981633974483096156608458198757L

	)

388 
	#M_1_PIl
 0.3183098861837906715377675267450287L

	)

389 
	#M_2_PIl
 0.6366197723675813430755350534900574L

	)

390 
	#M_2_SQRTPIl
 1.1283791670955125738961589031215452L

	)

391 
	#M_SQRT2l
 1.4142135623730950488016887242096981L

	)

392 
	#M_SQRT1_2l
 0.7071067811865475244008443621048490L

	)

399 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


400 
	#__NO_MATH_INLINES
 1

	)

403 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

410 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

411 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

412 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

413 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

414 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

415 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

419 #ifdeà
__USE_EXTERN_INLINES


420 
	~<b™s/m©hšlše.h
>

423 #ifdeà
__USE_ISOC99


427 #iâdeà
isg»©”


428 
	#isg»©”
(
x
, 
y
) \

429 (
__ex‹nsiÚ__
 \

430 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

431 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

435 #iâdeà
isg»©”equ®


436 
	#isg»©”equ®
(
x
, 
y
) \

437 (
__ex‹nsiÚ__
 \

438 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

439 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

443 #iâdeà
i¦ess


444 
	#i¦ess
(
x
, 
y
) \

445 (
__ex‹nsiÚ__
 \

446 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

447 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

451 #iâdeà
i¦es£qu®


452 
	#i¦es£qu®
(
x
, 
y
) \

453 (
__ex‹nsiÚ__
 \

454 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

455 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

459 #iâdeà
i¦essg»©”


460 
	#i¦essg»©”
(
x
, 
y
) \

461 (
__ex‹nsiÚ__
 \

462 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

463 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

467 #iâdeà
isunÜd”ed


468 
	#isunÜd”ed
(
u
, 
v
) \

469 (
__ex‹nsiÚ__
 \

470 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

471 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

476 
	g__END_DECLS


	@/usr/include/migration.h

1 #iâdeà
MMAPLIB_H_


2 
	#MMAPLIB_H_


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

7 
	~<uni¡d.h
>

8 
	~<”ºo.h
>

9 
	~<sys/mmª.h
>

10 
	~<fú.h
>

11 
	~<as£¹.h
>

12 
	~<time.h
>

15 #ifdeà
__ılu¥lus


18 
»cÜd_addr
(* 
addr
, 
size_t
 
size
);

19 
mig¿‹_·ges
(
node
);

20 
mig¿‹_now
();

21 
š™_®locs
();

22 
¡İmig¿‹
();

23 #ifdeà
__ılu¥lus


	@/usr/include/netdb.h

23 #iâdef 
_NETDB_H


24 
	#_NETDB_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	~<Ãtš‘/š.h
>

29 
	~<¡dšt.h
>

30 #ifdeà
__USE_MISC


33 
	~<½c/Ãtdb.h
>

36 #ifdeà
__USE_GNU


37 
	#__Ãed_sigev’t_t


	)

38 
	~<b™s/sigšfo.h
>

39 
	#__Ãed_time¥ec


	)

40 
	~<time.h
>

43 
	~<b™s/Ãtdb.h
>

46 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

47 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

48 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

49 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

50 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

51 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

54 
	g__BEGIN_DECLS


56 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


59 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

62 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

66 
	#HOST_NOT_FOUND
 1

	)

67 
	#TRY_AGAIN
 2

	)

69 
	#NO_RECOVERY
 3

	)

71 
	#NO_DATA
 4

	)

74 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


75 
	#NETDB_INTERNAL
 -1

	)

76 
	#NETDB_SUCCESS
 0

	)

77 
	#NO_ADDRESS
 
NO_DATA


	)

80 #ifdeà
__USE_XOPEN2K


82 
	#IPPORT_RESERVED
 1024

	)

85 #ifdeà
__USE_GNU


87 
	#SCOPE_DELIMITER
 '%'

	)

90 #ifdeà
__USE_MISC


93 
	$h”rÜ
 (
__cÚ¡
 *
__¡r
è
__THROW
;

96 
__cÚ¡
 *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

101 
	sho¡’t


103 *
h_Çme
;

104 **
h_®Ÿ£s
;

105 
h_add¹y³
;

106 
h_Ëngth
;

107 **
h_addr_li¡
;

108 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


109 
	#h_addr
 
h_addr_li¡
[0]

	)

118 
	`£tho¡’t
 (
__¡ay_İ’
);

124 
	`’dho¡’t
 ();

131 
ho¡’t
 *
	`g‘ho¡’t
 ();

138 
ho¡’t
 *
	`g‘ho¡byaddr
 (
__cÚ¡
 *
__addr
, 
__sockËn_t
 
__Ën
,

139 
__ty³
);

145 
ho¡’t
 *
	`g‘ho¡byÇme
 (
__cÚ¡
 *
__Çme
);

147 #ifdeà
__USE_MISC


156 
ho¡’t
 *
	`g‘ho¡byÇme2
 (
__cÚ¡
 *
__Çme
, 
__af
);

168 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

169 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

170 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

171 *
__»¡riù
 
__h_”ºİ
);

173 
	`g‘ho¡byaddr_r
 (
__cÚ¡
 *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

174 
__ty³
,

175 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

176 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

177 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

178 *
__»¡riù
 
__h_”ºİ
);

180 
	`g‘ho¡byÇme_r
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

181 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

182 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

183 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

184 *
__»¡riù
 
__h_”ºİ
);

186 
	`g‘ho¡byÇme2_r
 (
__cÚ¡
 *
__»¡riù
 
__Çme
, 
__af
,

187 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

188 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

189 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

190 *
__»¡riù
 
__h_”ºİ
);

199 
	`£Š‘’t
 (
__¡ay_İ’
);

205 
	`’dÃ‹Á
 ();

212 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

219 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

225 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (
__cÚ¡
 *
__Çme
);

227 #ifdef 
__USE_MISC


238 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

239 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

240 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

241 *
__»¡riù
 
__h_”ºİ
);

243 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

244 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

245 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

246 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

247 *
__»¡riù
 
__h_”ºİ
);

249 
	`g‘ÃtbyÇme_r
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

250 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

251 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

252 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

253 *
__»¡riù
 
__h_”ºİ
);

258 
	s£rv’t


260 *
s_Çme
;

261 **
s_®Ÿ£s
;

262 
s_pÜt
;

263 *
s_´Ùo
;

271 
	`£t£rv’t
 (
__¡ay_İ’
);

277 
	`’d£rv’t
 ();

284 
£rv’t
 *
	`g‘£rv’t
 ();

291 
£rv’t
 *
	`g‘£rvbyÇme
 (
__cÚ¡
 *
__Çme
,

292 
__cÚ¡
 *
__´Ùo
);

299 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, 
__cÚ¡
 *
__´Ùo
);

302 #ifdef 
__USE_MISC


310 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

311 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

312 
£rv’t
 **
__»¡riù
 
__»suÉ
);

314 
	`g‘£rvbyÇme_r
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

315 
__cÚ¡
 *
__»¡riù
 
__´Ùo
,

316 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

317 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

318 
£rv’t
 **
__»¡riù
 
__»suÉ
);

320 
	`g‘£rvbypÜt_r
 (
__pÜt
, 
__cÚ¡
 *
__»¡riù
 
__´Ùo
,

321 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

322 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

323 
£rv’t
 **
__»¡riù
 
__»suÉ
);

328 
	s´ÙÛÁ


330 *
p_Çme
;

331 **
p_®Ÿ£s
;

332 
p_´Ùo
;

340 
	`£rÙÛÁ
 (
__¡ay_İ’
);

346 
	`’d´ÙÛÁ
 ();

353 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

359 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (
__cÚ¡
 *
__Çme
);

365 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

368 #ifdef 
__USE_MISC


376 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

377 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

378 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

380 
	`g‘´ÙobyÇme_r
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

381 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

382 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

383 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

385 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

386 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

387 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

388 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

397 
	`£Š‘g»Á
 (
__cÚ¡
 *
__Ãtgroup
);

405 
	`’dÃtg»Á
 ();

414 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

415 **
__»¡riù
 
__u£½
,

416 **
__»¡riù
 
__domašp
);

425 
	`šÃtgr
 (
__cÚ¡
 *
__Ãtgroup
, __cÚ¡ *
__ho¡
,

426 
__cÚ¡
 *
__u£r
, __cÚ¡ *
__domaš
);

434 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

435 **
__»¡riù
 
__u£½
,

436 **
__»¡riù
 
__domašp
,

437 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

441 #ifdeà
__USE_BSD


453 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

454 
__cÚ¡
 *
__»¡riù
 
__locu£r
,

455 
__cÚ¡
 *
__»¡riù
 
__»mu£r
,

456 
__cÚ¡
 *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

465 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

466 
__cÚ¡
 *
__»¡riù
 
__locu£r
,

467 
__cÚ¡
 *
__»¡riù
 
__»mu£r
,

468 
__cÚ¡
 *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

469 
§_çmy_t
 
__af
);

481 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

482 
__cÚ¡
 *
__»¡riù
 
__Çme
,

483 
__cÚ¡
 *
__»¡riù
 
__·ss
,

484 
__cÚ¡
 *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

493 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

494 
__cÚ¡
 *
__»¡riù
 
__Çme
,

495 
__cÚ¡
 *
__»¡riù
 
__·ss
,

496 
__cÚ¡
 *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

497 
§_çmy_t
 
__af
);

507 
	`ru£rok
 (
__cÚ¡
 *
__rho¡
, 
__su£r
,

508 
__cÚ¡
 *
__»mu£r
, __cÚ¡ *
__locu£r
);

517 
	`ru£rok_af
 (
__cÚ¡
 *
__rho¡
, 
__su£r
,

518 
__cÚ¡
 *
__»mu£r
, __cÚ¡ *
__locu£r
,

519 
§_çmy_t
 
__af
);

530 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

531 
__cÚ¡
 *
__»mu£r
, __cÚ¡ *
__locu£r
);

541 
	`œu£rok_af
 (
__cÚ¡
 *
__¿ddr
, 
__su£r
,

542 
__cÚ¡
 *
__»mu£r
, __cÚ¡ *
__locu£r
,

543 
§_çmy_t
 
__af
);

553 
	`¼esvpÜt
 (*
__®pÜt
);

562 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

567 #ifdef 
__USE_POSIX


569 
	saddršfo


571 
ai_æags
;

572 
ai_çmy
;

573 
ai_sockty³
;

574 
ai_´ÙocŞ
;

575 
sockËn_t
 
ai_add¾’
;

576 
sockaddr
 *
ai_addr
;

577 *
ai_ÿnÚÇme
;

578 
addršfo
 *
ai_Ãxt
;

581 #ifdeà
__USE_GNU


583 
	sgaicb


585 cÚ¡ *
¬_Çme
;

586 cÚ¡ *
¬_£rviû
;

587 cÚ¡ 
addršfo
 *
¬_»que¡
;

588 
addršfo
 *
¬_»suÉ
;

590 
__»tuº
;

591 
__unu£d
[5];

595 
	#GAI_WAIT
 0

	)

596 
	#GAI_NOWAIT
 1

	)

600 
	#AI_PASSIVE
 0x0001

	)

601 
	#AI_CANONNAME
 0x0002

	)

602 
	#AI_NUMERICHOST
 0x0004

	)

603 
	#AI_V4MAPPED
 0x0008

	)

604 
	#AI_ALL
 0x0010

	)

605 
	#AI_ADDRCONFIG
 0x0020

	)

607 #ifdeà
__USE_GNU


608 
	#AI_IDN
 0x0040

	)

611 
	#AI_CANONIDN
 0x0080

	)

612 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

614 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

617 
	#AI_NUMERICSERV
 0x0400

	)

620 
	#EAI_BADFLAGS
 -1

	)

621 
	#EAI_NONAME
 -2

	)

622 
	#EAI_AGAIN
 -3

	)

623 
	#EAI_FAIL
 -4

	)

624 
	#EAI_FAMILY
 -6

	)

625 
	#EAI_SOCKTYPE
 -7

	)

626 
	#EAI_SERVICE
 -8

	)

627 
	#EAI_MEMORY
 -10

	)

628 
	#EAI_SYSTEM
 -11

	)

629 
	#EAI_OVERFLOW
 -12

	)

630 #ifdeà
__USE_GNU


631 
	#EAI_NODATA
 -5

	)

632 
	#EAI_ADDRFAMILY
 -9

	)

633 
	#EAI_INPROGRESS
 -100

	)

634 
	#EAI_CANCELED
 -101

	)

635 
	#EAI_NOTCANCELED
 -102

	)

636 
	#EAI_ALLDONE
 -103

	)

637 
	#EAI_INTR
 -104

	)

638 
	#EAI_IDN_ENCODE
 -105

	)

641 #ifdeà
__USE_MISC


642 
	#NI_MAXHOST
 1025

	)

643 
	#NI_MAXSERV
 32

	)

646 
	#NI_NUMERICHOST
 1

	)

647 
	#NI_NUMERICSERV
 2

	)

648 
	#NI_NOFQDN
 4

	)

649 
	#NI_NAMEREQD
 8

	)

650 
	#NI_DGRAM
 16

	)

651 #ifdeà
__USE_GNU


652 
	#NI_IDN
 32

	)

653 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

655 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

664 
	`g‘addršfo
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

665 
__cÚ¡
 *
__»¡riù
 
__£rviû
,

666 
__cÚ¡
 
addršfo
 *
__»¡riù
 
__»q
,

667 
addršfo
 **
__»¡riù
 
__·i
);

670 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

673 
__cÚ¡
 *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

679 
	`g‘Çmešfo
 (
__cÚ¡
 
sockaddr
 *
__»¡riù
 
__§
,

680 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

681 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

682 
sockËn_t
 
__£rvËn
, 
__æags
);

685 #ifdeà
__USE_GNU


694 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

695 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

705 
	`gai_su¥’d
 (
__cÚ¡
 
gaicb
 *__cÚ¡ 
__li¡
[], 
__’t
,

706 
__cÚ¡
 
time¥ec
 *
__timeout
);

709 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

712 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

715 
__END_DECLS


	@/usr/include/netinet/in.h

20 #iâdef 
_NETINET_IN_H


21 
	#_NETINET_IN_H
 1

	)

23 
	~<ã©u»s.h
>

24 
	~<¡dšt.h
>

25 
	~<sys/sock‘.h
>

26 
	~<b™s/ty³s.h
>

29 
__BEGIN_DECLS


34 
	mIPPROTO_IP
 = 0,

35 
	#IPPROTO_IP
 
IPPROTO_IP


	)

36 
	mIPPROTO_HOPOPTS
 = 0,

37 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

38 
	mIPPROTO_ICMP
 = 1,

39 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

40 
	mIPPROTO_IGMP
 = 2,

41 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

42 
	mIPPROTO_IPIP
 = 4,

43 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

44 
	mIPPROTO_TCP
 = 6,

45 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

46 
	mIPPROTO_EGP
 = 8,

47 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

48 
	mIPPROTO_PUP
 = 12,

49 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

50 
	mIPPROTO_UDP
 = 17,

51 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

52 
	mIPPROTO_IDP
 = 22,

53 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

54 
	mIPPROTO_TP
 = 29,

55 
	#IPPROTO_TP
 
IPPROTO_TP


	)

56 
	mIPPROTO_DCCP
 = 33,

57 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

58 
	mIPPROTO_IPV6
 = 41,

59 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

60 
	mIPPROTO_ROUTING
 = 43,

61 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

62 
	mIPPROTO_FRAGMENT
 = 44,

63 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

64 
	mIPPROTO_RSVP
 = 46,

65 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

66 
	mIPPROTO_GRE
 = 47,

67 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

68 
	mIPPROTO_ESP
 = 50,

69 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

70 
	mIPPROTO_AH
 = 51,

71 
	#IPPROTO_AH
 
IPPROTO_AH


	)

72 
	mIPPROTO_ICMPV6
 = 58,

73 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

74 
	mIPPROTO_NONE
 = 59,

75 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

76 
	mIPPROTO_DSTOPTS
 = 60,

77 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

78 
	mIPPROTO_MTP
 = 92,

79 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

80 
	mIPPROTO_ENCAP
 = 98,

81 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

82 
	mIPPROTO_PIM
 = 103,

83 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

84 
	mIPPROTO_COMP
 = 108,

85 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

86 
	mIPPROTO_SCTP
 = 132,

87 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

88 
	mIPPROTO_UDPLITE
 = 136,

89 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

90 
	mIPPROTO_RAW
 = 255,

91 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

92 
	mIPPROTO_MAX


97 
ušt16_t
 
	tš_pÜt_t
;

102 
	mIPPORT_ECHO
 = 7,

103 
	mIPPORT_DISCARD
 = 9,

104 
	mIPPORT_SYSTAT
 = 11,

105 
	mIPPORT_DAYTIME
 = 13,

106 
	mIPPORT_NETSTAT
 = 15,

107 
	mIPPORT_FTP
 = 21,

108 
	mIPPORT_TELNET
 = 23,

109 
	mIPPORT_SMTP
 = 25,

110 
	mIPPORT_TIMESERVER
 = 37,

111 
	mIPPORT_NAMESERVER
 = 42,

112 
	mIPPORT_WHOIS
 = 43,

113 
	mIPPORT_MTP
 = 57,

115 
	mIPPORT_TFTP
 = 69,

116 
	mIPPORT_RJE
 = 77,

117 
	mIPPORT_FINGER
 = 79,

118 
	mIPPORT_TTYLINK
 = 87,

119 
	mIPPORT_SUPDUP
 = 95,

122 
	mIPPORT_EXECSERVER
 = 512,

123 
	mIPPORT_LOGINSERVER
 = 513,

124 
	mIPPORT_CMDSERVER
 = 514,

125 
	mIPPORT_EFSSERVER
 = 520,

128 
	mIPPORT_BIFFUDP
 = 512,

129 
	mIPPORT_WHOSERVER
 = 513,

130 
	mIPPORT_ROUTESERVER
 = 520,

133 
	mIPPORT_RESERVED
 = 1024,

136 
	mIPPORT_USERRESERVED
 = 5000

141 
ušt32_t
 
	tš_addr_t
;

142 
	sš_addr


144 
š_addr_t
 
	ms_addr
;

153 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

154 
	#IN_CLASSA_NET
 0xff000000

	)

155 
	#IN_CLASSA_NSHIFT
 24

	)

156 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

157 
	#IN_CLASSA_MAX
 128

	)

159 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

160 
	#IN_CLASSB_NET
 0xffff0000

	)

161 
	#IN_CLASSB_NSHIFT
 16

	)

162 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

163 
	#IN_CLASSB_MAX
 65536

	)

165 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

166 
	#IN_CLASSC_NET
 0xffffff00

	)

167 
	#IN_CLASSC_NSHIFT
 8

	)

168 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

170 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

171 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

173 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

174 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

177 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

179 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

181 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

184 
	#IN_LOOPBACKNET
 127

	)

186 #iâdeà
INADDR_LOOPBACK


187 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

191 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

192 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

193 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

194 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

198 
	sš6_addr


202 
ušt8_t
 
	m__u6_addr8
[16];

203 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


204 
ušt16_t
 
	m__u6_addr16
[8];

205 
ušt32_t
 
	m__u6_addr32
[4];

207 } 
	m__š6_u
;

208 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

209 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


210 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

211 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

215 cÚ¡ 
š6_addr
 
š6addr_ªy
;

216 cÚ¡ 
š6_addr
 
š6addr_loİback
;

217 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

218 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

220 
	#INET_ADDRSTRLEN
 16

	)

221 
	#INET6_ADDRSTRLEN
 46

	)

225 
	ssockaddr_š


227 
__SOCKADDR_COMMON
 (
sš_
);

228 
š_pÜt_t
 
	msš_pÜt
;

229 
š_addr
 
	msš_addr
;

232 
	msš_z”o
[ (
sockaddr
) -

233 
__SOCKADDR_COMMON_SIZE
 -

234  (
š_pÜt_t
) -

235  (
š_addr
)];

239 
	ssockaddr_š6


241 
__SOCKADDR_COMMON
 (
sš6_
);

242 
š_pÜt_t
 
	msš6_pÜt
;

243 
ušt32_t
 
	msš6_æowšfo
;

244 
š6_addr
 
	msš6_addr
;

245 
ušt32_t
 
	msš6_scİe_id
;

249 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


251 
	s_m»q


254 
š_addr
 
	mimr_muÉŸddr
;

257 
š_addr
 
	mimr_š‹rçû
;

260 
	s_m»q_sourû


263 
š_addr
 
	mimr_muÉŸddr
;

266 
š_addr
 
	mimr_š‹rçû
;

269 
š_addr
 
	mimr_sourûaddr
;

275 
	sv6_m»q


278 
š6_addr
 
	mv6mr_muÉŸddr
;

281 
	mv6mr_š‹rçû
;

285 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


287 
	sgroup_»q


290 
ušt32_t
 
	mgr_š‹rçû
;

293 
sockaddr_¡Üage
 
	mgr_group
;

296 
	sgroup_sourû_»q


299 
ušt32_t
 
	mg¤_š‹rçû
;

302 
sockaddr_¡Üage
 
	mg¤_group
;

305 
sockaddr_¡Üage
 
	mg¤_sourû
;

310 
	s_msf‹r


313 
š_addr
 
	mimsf_muÉŸddr
;

316 
š_addr
 
	mimsf_š‹rçû
;

319 
ušt32_t
 
	mimsf_fmode
;

322 
ušt32_t
 
	mimsf_num¤c
;

324 
š_addr
 
	mimsf_¦i¡
[1];

327 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

328 -  (
š_addr
) \

329 + (
num¤c
è*  (
š_addr
))

	)

331 
	sgroup_f‹r


334 
ušt32_t
 
	mgf_š‹rçû
;

337 
sockaddr_¡Üage
 
	mgf_group
;

340 
ušt32_t
 
	mgf_fmode
;

343 
ušt32_t
 
	mgf_num¤c
;

345 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

348 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

349 -  (
sockaddr_¡Üage
) \

350 + ((
num¤c
) \

351 *  (
sockaddr_¡Üage
)))

	)

356 
	~<b™s/š.h
>

365 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

366 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

367 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

368 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

369 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

370 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

371 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

373 
	~<’dŸn.h
>

376 
	~<b™s/by‹sw­.h
>

378 #ifdeà
__OPTIMIZE__


382 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


385 
	#Áohl
(
x
è(x)

	)

386 
	#Áohs
(
x
è(x)

	)

387 
	#htÚl
(
x
è(x)

	)

388 
	#htÚs
(
x
è(x)

	)

390 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


391 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

392 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

393 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

394 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

399 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

400 (((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] == 0 \

401 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[1] == 0 \

402 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[2] == 0 \

403 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

405 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

406 (((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] == 0 \

407 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[1] == 0 \

408 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[2] == 0 \

409 && ((
__cÚ¡
 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

411 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((
__cÚ¡
 
ušt8_t
 *è×))[0] =ğ0xff)

	)

413 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

414 ((((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

415 =ğ
	`htÚl
 (0xã800000))

	)

417 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

418 ((((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

419 =ğ
	`htÚl
 (0xãc00000))

	)

421 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

422 ((((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] == 0) \

423 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[1] == 0) \

424 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

426 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

427 ((((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] == 0) \

428 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[1] == 0) \

429 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[2] == 0) \

430 && (
	`Áohl
 (((
__cÚ¡
 
ušt32_t
 *è(
a
))[3]è> 1))

	)

432 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

433 ((((
__cÚ¡
 
ušt32_t
 *è(
a
))[0] =ğ((__cÚ¡ ušt32_ˆ*è(
b
))[0]) \

434 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[1] =ğ((__cÚ¡ ušt32_ˆ*è(
b
))[1]) \

435 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[2] =ğ((__cÚ¡ ušt32_ˆ*è(
b
))[2]) \

436 && (((
__cÚ¡
 
ušt32_t
 *è(
a
))[3] =ğ((__cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

438 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_GNU


440 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

443 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

444 
__THROW
;

448 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

449 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

450 && ((((
__cÚ¡
 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

452 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

453 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

454 && ((((
__cÚ¡
 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

456 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

457 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

458 && ((((
__cÚ¡
 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

460 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

461 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

462 && ((((
__cÚ¡
 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

464 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

465 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

466 && ((((
__cÚ¡
 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

469 #ifdeà
__USE_GNU


471 
	sš6_pktšfo


473 
š6_addr
 
i6_addr
;

474 
i6_ifšdex
;

478 
	s6_mtušfo


480 
sockaddr_š6
 
6m_addr
;

481 
ušt32_t
 
6m_mtu
;

486 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

487 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

488 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

489 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

490 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

491 
__cÚ¡
 
ušt8_t
 *
__ty³p
, 
__muÉx
,

492 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

493 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

494 
__muÉx
, 
__¶usy
)

495 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

496 
	$š‘6_İtiÚ_Ãxt
 (
__cÚ¡
 
cmsghdr
 *
__cmsg
,

497 
ušt8_t
 **
__Œp
)

498 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

499 
	$š‘6_İtiÚ_fšd
 (
__cÚ¡
 
cmsghdr
 *
__cmsg
,

500 
ušt8_t
 **
__Œp
, 
__ty³
)

501 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

505 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

506 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

507 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

508 **
__d©abuå
è
__THROW
;

509 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

510 
__THROW
;

511 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

512 
sockËn_t
 
__v®Ën
è
__THROW
;

513 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

514 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

515 **
__d©abuå
è
__THROW
;

516 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

517 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

518 **
__d©abuå
è
__THROW
;

519 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

520 
sockËn_t
 
__v®Ën
è
__THROW
;

524 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

525 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

526 
__£gm’ts
è
__THROW
;

527 
	$š‘6_¹h_add
 (*
__bp
, 
__cÚ¡
 
š6_addr
 *
__addr
è
__THROW
;

528 
	$š‘6_¹h_»v”£
 (
__cÚ¡
 *
__š
, *
__out
è
__THROW
;

529 
	$š‘6_¹h_£gm’ts
 (
__cÚ¡
 *
__bp
è
__THROW
;

530 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (
__cÚ¡
 *
__bp
, 
__šdex
)

531 
__THROW
;

537 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

538 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

539 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

540 
__THROW
;

543 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

544 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

545 
ušt32_t
 
__num¤c
,

546 
__cÚ¡
 
š_addr
 *
__¦i¡
)

547 
__THROW
;

551 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

552 
__cÚ¡
 
sockaddr
 *
__group
,

553 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

554 
ušt32_t
 *
__num¤c
,

555 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

558 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

559 
__cÚ¡
 
sockaddr
 *
__group
,

560 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

561 
ušt32_t
 
__num¤c
,

562 
__cÚ¡
 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

565 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

55 #ifdeà
__USE_MISC


56 
	~<sys/ty³s.h
>

57 
	~<sys/sock‘.h
>

59 #ifdeà
__FAVOR_BSD


60 
u_št32_t
 
	ttı_£q
;

65 
	stıhdr


67 
u_št16_t
 
	mth_¥Üt
;

68 
u_št16_t
 
	mth_dpÜt
;

69 
tı_£q
 
	mth_£q
;

70 
tı_£q
 
	mth_ack
;

71 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


72 
u_št8_t
 
	mth_x2
:4;

73 
u_št8_t
 
	mth_off
:4;

75 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


76 
u_št8_t
 
	mth_off
:4;

77 
u_št8_t
 
	mth_x2
:4;

79 
u_št8_t
 
	mth_æags
;

80 
	#TH_FIN
 0x01

	)

81 
	#TH_SYN
 0x02

	)

82 
	#TH_RST
 0x04

	)

83 
	#TH_PUSH
 0x08

	)

84 
	#TH_ACK
 0x10

	)

85 
	#TH_URG
 0x20

	)

86 
u_št16_t
 
	mth_wš
;

87 
u_št16_t
 
	mth_sum
;

88 
u_št16_t
 
	mth_u½
;

92 
	stıhdr


94 
u_št16_t
 
	msourû
;

95 
u_št16_t
 
	mde¡
;

96 
u_št32_t
 
	m£q
;

97 
u_št32_t
 
	mack_£q
;

98 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


99 
u_št16_t
 
	m»s1
:4;

100 
u_št16_t
 
	mdoff
:4;

101 
u_št16_t
 
	mfš
:1;

102 
u_št16_t
 
	msyn
:1;

103 
u_št16_t
 
	mr¡
:1;

104 
u_št16_t
 
	mpsh
:1;

105 
u_št16_t
 
	mack
:1;

106 
u_št16_t
 
	murg
:1;

107 
u_št16_t
 
	m»s2
:2;

108 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


109 
u_št16_t
 
	mdoff
:4;

110 
u_št16_t
 
	m»s1
:4;

111 
u_št16_t
 
	m»s2
:2;

112 
u_št16_t
 
	murg
:1;

113 
u_št16_t
 
	mack
:1;

114 
u_št16_t
 
	mpsh
:1;

115 
u_št16_t
 
	mr¡
:1;

116 
u_št16_t
 
	msyn
:1;

117 
u_št16_t
 
	mfš
:1;

121 
u_št16_t
 
	mwšdow
;

122 
u_št16_t
 
	mcheck
;

123 
u_št16_t
 
	murg_±r
;

129 
	mTCP_ESTABLISHED
 = 1,

130 
	mTCP_SYN_SENT
,

131 
	mTCP_SYN_RECV
,

132 
	mTCP_FIN_WAIT1
,

133 
	mTCP_FIN_WAIT2
,

134 
	mTCP_TIME_WAIT
,

135 
	mTCP_CLOSE
,

136 
	mTCP_CLOSE_WAIT
,

137 
	mTCP_LAST_ACK
,

138 
	mTCP_LISTEN
,

139 
	mTCP_CLOSING


142 
	#TCPOPT_EOL
 0

	)

143 
	#TCPOPT_NOP
 1

	)

144 
	#TCPOPT_MAXSEG
 2

	)

145 
	#TCPOLEN_MAXSEG
 4

	)

146 
	#TCPOPT_WINDOW
 3

	)

147 
	#TCPOLEN_WINDOW
 3

	)

148 
	#TCPOPT_SACK_PERMITTED
 4

	)

149 
	#TCPOLEN_SACK_PERMITTED
 2

	)

150 
	#TCPOPT_SACK
 5

	)

151 
	#TCPOPT_TIMESTAMP
 8

	)

152 
	#TCPOLEN_TIMESTAMP
 10

	)

153 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

155 
	#TCPOPT_TSTAMP_HDR
 \

156 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

164 
	#TCP_MSS
 512

	)

166 
	#TCP_MAXWIN
 65535

	)

168 
	#TCP_MAX_WINSHIFT
 14

	)

170 
	#SOL_TCP
 6

	)

173 
	#TCPI_OPT_TIMESTAMPS
 1

	)

174 
	#TCPI_OPT_SACK
 2

	)

175 
	#TCPI_OPT_WSCALE
 4

	)

176 
	#TCPI_OPT_ECN
 8

	)

179 
	etı_ÿ_¡©e


181 
	mTCP_CA_O³n
 = 0,

182 
	mTCP_CA_DisÜd”
 = 1,

183 
	mTCP_CA_CWR
 = 2,

184 
	mTCP_CA_Recov”y
 = 3,

185 
	mTCP_CA_Loss
 = 4

188 
	stı_šfo


190 
u_št8_t
 
	mtıi_¡©e
;

191 
u_št8_t
 
	mtıi_ÿ_¡©e
;

192 
u_št8_t
 
	mtıi_»Œªsm™s
;

193 
u_št8_t
 
	mtıi_´obes
;

194 
u_št8_t
 
	mtıi_backoff
;

195 
u_št8_t
 
	mtıi_İtiÚs
;

196 
u_št8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

198 
u_št32_t
 
	mtıi_¹o
;

199 
u_št32_t
 
	mtıi_©o
;

200 
u_št32_t
 
	mtıi_¢d_mss
;

201 
u_št32_t
 
	mtıi_rcv_mss
;

203 
u_št32_t
 
	mtıi_uÇcked
;

204 
u_št32_t
 
	mtıi_§cked
;

205 
u_št32_t
 
	mtıi_lo¡
;

206 
u_št32_t
 
	mtıi_»Œªs
;

207 
u_št32_t
 
	mtıi_çck‘s
;

210 
u_št32_t
 
	mtıi_Ï¡_d©a_£Á
;

211 
u_št32_t
 
	mtıi_Ï¡_ack_£Á
;

212 
u_št32_t
 
	mtıi_Ï¡_d©a_»cv
;

213 
u_št32_t
 
	mtıi_Ï¡_ack_»cv
;

216 
u_št32_t
 
	mtıi_pmtu
;

217 
u_št32_t
 
	mtıi_rcv_s¡h»sh
;

218 
u_št32_t
 
	mtıi_¹t
;

219 
u_št32_t
 
	mtıi_¹tv¬
;

220 
u_št32_t
 
	mtıi_¢d_s¡h»sh
;

221 
u_št32_t
 
	mtıi_¢d_cwnd
;

222 
u_št32_t
 
	mtıi_advmss
;

223 
u_št32_t
 
	mtıi_»Üd”šg
;

225 
u_št32_t
 
	mtıi_rcv_¹t
;

226 
u_št32_t
 
	mtıi_rcv_¥aû
;

228 
u_št32_t
 
	mtıi_tÙ®_»Œªs
;

233 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

235 
	stı_md5sig


237 
sockaddr_¡Üage
 
	mtım_addr
;

238 
u_št16_t
 
	m__tım_·d1
;

239 
u_št16_t
 
	mtım_keyËn
;

240 
u_št32_t
 
	m__tım_·d2
;

241 
u_št8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

	@/usr/include/poll.h

1 
	~<sys/pŞl.h
>

	@/usr/include/pthread.h

20 #iâdeà
_PTHREAD_H


21 
	#_PTHREAD_H
 1

	)

23 
	~<ã©u»s.h
>

24 
	~<’dŸn.h
>

25 
	~<sched.h
>

26 
	~<time.h
>

28 
	~<b™s/±h»adty³s.h
>

29 
	~<b™s/£tjmp.h
>

30 
	~<b™s/wÜdsize.h
>

36 
	mPTHREAD_CREATE_JOINABLE
,

37 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

38 
	mPTHREAD_CREATE_DETACHED


39 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

46 
	mPTHREAD_MUTEX_TIMED_NP
,

47 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

48 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

49 
	mPTHREAD_MUTEX_ADAPTIVE_NP


50 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


52 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

53 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

54 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

55 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


57 #ifdeà
__USE_GNU


59 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


64 #ifdeà
__USE_XOPEN2K


68 
	mPTHREAD_MUTEX_STALLED
,

69 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

70 
	mPTHREAD_MUTEX_ROBUST
,

71 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


76 #ifdeà
__USE_UNIX98


80 
	mPTHREAD_PRIO_NONE
,

81 
	mPTHREAD_PRIO_INHERIT
,

82 
	mPTHREAD_PRIO_PROTECT


88 #ià
__WORDSIZE
 == 64

89 
	#PTHREAD_MUTEX_INITIALIZER
 \

90 { { 0, 0, 0, 0, 0, 0, { 0, 0 } } }

	)

91 #ifdeà
__USE_GNU


92 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

93 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 0, 0 } } }

	)

94 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

95 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 0, 0 } } }

	)

96 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

97 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 0, 0 } } }

	)

100 
	#PTHREAD_MUTEX_INITIALIZER
 \

101 { { 0, 0, 0, 0, 0, { 0 } } }

	)

102 #ifdeà
__USE_GNU


103 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

104 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 0 } } }

	)

105 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

106 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 0 } } }

	)

107 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

108 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 0 } } }

	)

114 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


117 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

119 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

120 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


124 
	#PTHREAD_RWLOCK_INITIALIZER
 \

125 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 } }

	)

126 #ifdeà
__USE_GNU


127 #ià
__WORDSIZE
 == 64

128 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

130 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

132 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


133 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

134 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

135 0, 0, 0, 0 } }

	)

137 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

138 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

139 0 } }

	)

149 
	mPTHREAD_INHERIT_SCHED
,

150 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

151 
	mPTHREAD_EXPLICIT_SCHED


152 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

159 
	mPTHREAD_SCOPE_SYSTEM
,

160 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

161 
	mPTHREAD_SCOPE_PROCESS


162 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

169 
	mPTHREAD_PROCESS_PRIVATE
,

170 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

171 
	mPTHREAD_PROCESS_SHARED


172 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

178 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

182 
	s_±h»ad_ş—nup_bufãr


184 (*
	m__routše
) (*);

185 *
	m__¬g
;

186 
	m__ÿnûÉy³
;

187 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

193 
	mPTHREAD_CANCEL_ENABLE
,

194 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

195 
	mPTHREAD_CANCEL_DISABLE


196 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

200 
	mPTHREAD_CANCEL_DEFERRED
,

201 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

202 
	mPTHREAD_CANCEL_ASYNCHRONOUS


203 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

205 
	#PTHREAD_CANCELED
 ((*è-1)

	)

209 
	#PTHREAD_ONCE_INIT
 0

	)

212 #ifdeà
__USE_XOPEN2K


216 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

220 
__BEGIN_DECLS


225 
±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

226 
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

227 *(*
__¡¬t_routše
) (*),

228 *
__»¡riù
 
__¬g
è
__THROW
 
__nÚnuÎ
 ((1, 3));

234 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

242 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

244 #ifdeà
__USE_GNU


247 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

255 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

256 
__cÚ¡
 
time¥ec
 *
__ab¡ime
);

263 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

267 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

270 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
è
__THROW
;

278 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

281 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

282 
__THROW
 
	`__nÚnuÎ
 ((1));

285 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

286 *
__d‘ach¡©e
)

287 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

290 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

291 
__d‘ach¡©e
)

292 
__THROW
 
	`__nÚnuÎ
 ((1));

296 
	$±h»ad_©Œ_g‘gu¬dsize
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

297 
size_t
 *
__gu¬dsize
)

298 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

301 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

302 
size_t
 
__gu¬dsize
)

303 
__THROW
 
	`__nÚnuÎ
 ((1));

307 
	$±h»ad_©Œ_g‘sched·¿m
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


308 
__©Œ
,

309 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

310 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

313 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

314 
__cÚ¡
 
sched_·¿m
 *
__»¡riù


315 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

318 
	$±h»ad_©Œ_g‘schedpŞicy
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


319 
__©Œ
, *
__»¡riù
 
__pŞicy
)

320 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

323 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

324 
__THROW
 
	`__nÚnuÎ
 ((1));

327 
	$±h»ad_©Œ_g‘šh”™sched
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


328 
__©Œ
, *
__»¡riù
 
__šh”™
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

333 
__šh”™
)

334 
__THROW
 
	`__nÚnuÎ
 ((1));

338 
	$±h»ad_©Œ_g‘scİe
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

339 *
__»¡riù
 
__scİe
)

340 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

343 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

344 
__THROW
 
	`__nÚnuÎ
 ((1));

347 
	$±h»ad_©Œ_g‘¡ackaddr
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


348 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

349 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

355 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

356 *
__¡ackaddr
)

357 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

360 
	$±h»ad_©Œ_g‘¡acksize
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


361 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

362 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

367 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

368 
size_t
 
__¡acksize
)

369 
__THROW
 
	`__nÚnuÎ
 ((1));

371 #ifdeà
__USE_XOPEN2K


373 
	$±h»ad_©Œ_g‘¡ack
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

374 **
__»¡riù
 
__¡ackaddr
,

375 
size_t
 *
__»¡riù
 
__¡acksize
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

381 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

382 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

385 #ifdeà
__USE_GNU


388 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

389 
size_t
 
__ıu£tsize
,

390 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
)

391 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

395 
	$±h»ad_©Œ_g‘affš™y_Å
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

396 
size_t
 
__ıu£tsize
,

397 
ıu_£t_t
 *
__ıu£t
)

398 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

404 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

405 
__THROW
 
	`__nÚnuÎ
 ((2));

413 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

414 
__cÚ¡
 
sched_·¿m
 *
__·¿m
)

415 
__THROW
 
	`__nÚnuÎ
 ((3));

418 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

419 *
__»¡riù
 
__pŞicy
,

420 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

421 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

424 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

425 
__THROW
;

428 #ifdeà
__USE_GNU


430 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

431 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

435 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, 
__cÚ¡
 *
__Çme
)

436 
__THROW
 
	`__nÚnuÎ
 ((2));

440 #ifdeà
__USE_UNIX98


442 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

445 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

448 #ifdeà
__USE_GNU


453 
	$±h»ad_y›ld
 (è
__THROW
;

458 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

459 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
)

460 
__THROW
 
	`__nÚnuÎ
 ((3));

463 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

464 
ıu_£t_t
 *
__ıu£t
)

465 
__THROW
 
	`__nÚnuÎ
 ((3));

478 
	`±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

479 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

490 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

494 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

497 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

502 
	`±h»ad_‹¡ÿnûl
 ();

511 
__jmp_buf
 
__ÿnûl_jmp_buf
;

512 
__mask_was_§ved
;

513 } 
__ÿnûl_jmp_buf
[1];

514 *
__·d
[4];

515 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

518 #iâdeà
__ş—nup_fù_©Œibu‹


519 
	#__ş—nup_fù_©Œibu‹


	)

524 
	s__±h»ad_ş—nup_äame


526 (*
__ÿnûl_routše
) (*);

527 *
__ÿnûl_¬g
;

528 
__do_™
;

529 
__ÿnûl_ty³
;

532 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


533 #ifdeà
__ılu¥lus


535 şas 
	c__±h»ad_ş—nup_şass


537 (*
__ÿnûl_routše
) (*);

538 *
__ÿnûl_¬g
;

539 
__do_™
;

540 
__ÿnûl_ty³
;

542 
public
:

543 
	`__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

544 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

545 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

546 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

547 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

548 &
__ÿnûl_ty³
); 
	}
}

549 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

559 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

561 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

565 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

566 
__şäame
.
	`__£tdo™
 (
execu‹
); \

567 } 0)

	)

569 #ifdeà
__USE_GNU


573 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

575 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

576 
__şäame
.
	`__deãr
 ()

	)

581 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

582 
__şäame
.
	`__»¡Üe
 (); \

583 
__şäame
.
	`__£tdo™
 (
execu‹
); \

584 } 0)

	)

591 
__ex‹º_šlše
 

592 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

594 ià(
__äame
->
__do_™
)

595 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

596 
	}
}

605 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

607 
__±h»ad_ş—nup_äame
 
__şäame
 \

608 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

609 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

610 .
__do_™
 = 1 };

	)

614 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

615 
__şäame
.
__do_™
 = (
execu‹
); \

616 } 0)

	)

618 #ifdeà
__USE_GNU


622 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

624 
__±h»ad_ş—nup_äame
 
__şäame
 \

625 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

626 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

627 .
__do_™
 = 1 }; \

628 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

629 &
__şäame
.
__ÿnûl_ty³
)

	)

634 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

635 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

636 
__şäame
.
__do_™
 = (
execu‹
); \

637 } 0)

	)

648 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

650 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

651 (*
__ÿnûl_routše
è(*èğ(
routše
); \

652 *
__ÿnûl_¬g
 = (
¬g
); \

653 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

654 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

655 ià(
	`__butš_ex³ù
 (
__nÙ_fœ¡_ÿÎ
, 0)) \

657 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

658 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

662 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

663 dØ{

	)

664 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

665 
__ş—nup_fù_©Œibu‹
;

669 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

672 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

673 ià(
execu‹
) \

674 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

675 } 0)

	)

676 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

677 
__ş—nup_fù_©Œibu‹
;

679 #ifdeà
__USE_GNU


683 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

685 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

686 (*
__ÿnûl_routše
è(*èğ(
routše
); \

687 *
__ÿnûl_¬g
 = (
¬g
); \

688 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

689 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

690 ià(
	`__butš_ex³ù
 (
__nÙ_fœ¡_ÿÎ
, 0)) \

692 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

693 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

697 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

698 dØ{

	)

699 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

700 
__ş—nup_fù_©Œibu‹
;

705 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

708 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

709 ià(
execu‹
) \

710 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

711 
	}
} 0)

	)

712 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

713 
__ş—nup_fù_©Œibu‹
;

717 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

718 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

719 #iâdeà
SHARED


720 
	`__©Œibu‹__
 ((
__w—k__
))

726 
__jmp_buf_g
;

727 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROW
;

733 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

734 
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

735 
__THROW
 
	`__nÚnuÎ
 ((1));

738 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

739 
__THROW
 
	`__nÚnuÎ
 ((1));

742 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

743 
__THROW
 
	`__nÚnuÎ
 ((1));

746 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

747 
__THROW
 
	`__nÚnuÎ
 ((1));

749 #ifdeà
__USE_XOPEN2K


751 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

752 
__cÚ¡
 
time¥ec
 *
__»¡riù


753 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

757 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

758 
__THROW
 
	`__nÚnuÎ
 ((1));

762 
	$±h»ad_mu‹x_g‘´ioûšg
 (
__cÚ¡
 
±h»ad_mu‹x_t
 *

763 
__»¡riù
 
__mu‹x
,

764 *
__»¡riù
 
__´ioûšg
)

765 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

769 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

770 
__´ioûšg
,

771 *
__»¡riù
 
__Şd_ûšg
)

772 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

775 #ifdeà
__USE_XOPEN2K8


777 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

778 
__THROW
 
	`__nÚnuÎ
 ((1));

779 #ifdeà
__USE_GNU


780 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

781 
__THROW
 
	`__nÚnuÎ
 ((1));

790 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

791 
__THROW
 
	`__nÚnuÎ
 ((1));

794 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

795 
__THROW
 
	`__nÚnuÎ
 ((1));

798 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

799 
__»¡riù
 
__©Œ
,

800 *
__»¡riù
 
__psh¬ed
)

801 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

804 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

805 
__psh¬ed
)

806 
__THROW
 
	`__nÚnuÎ
 ((1));

808 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


810 
	$±h»ad_mu‹x©Œ_g‘ty³
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


811 
__©Œ
, *
__»¡riù
 
__kšd
)

812 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

817 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

818 
__THROW
 
	`__nÚnuÎ
 ((1));

822 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

823 
__»¡riù
 
__©Œ
,

824 *
__»¡riù
 
__´ÙocŞ
)

825 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

829 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

830 
__´ÙocŞ
)

831 
__THROW
 
	`__nÚnuÎ
 ((1));

834 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

835 
__»¡riù
 
__©Œ
,

836 *
__»¡riù
 
__´ioûšg
)

837 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

840 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

841 
__´ioûšg
)

842 
__THROW
 
	`__nÚnuÎ
 ((1));

844 #ifdeà
__USE_XOPEN2K


846 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

847 *
__robu¡Ãss
)

848 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

849 #ifdeà
__USE_GNU


850 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

851 *
__robu¡Ãss
)

852 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__robu¡Ãss
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

859 #ifdeà
__USE_GNU


860 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

861 
__robu¡Ãss
)

862 
__THROW
 
	`__nÚnuÎ
 ((1));

867 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


872 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

873 
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *
__»¡riù


874 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

877 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

878 
__THROW
 
	`__nÚnuÎ
 ((1));

881 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

882 
__THROW
 
	`__nÚnuÎ
 ((1));

885 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

886 
__THROW
 
	`__nÚnuÎ
 ((1));

888 #ifdeà
__USE_XOPEN2K


890 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

891 
__cÚ¡
 
time¥ec
 *
__»¡riù


892 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

896 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

897 
__THROW
 
	`__nÚnuÎ
 ((1));

900 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

901 
__THROW
 
	`__nÚnuÎ
 ((1));

903 #ifdeà
__USE_XOPEN2K


905 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

906 
__cÚ¡
 
time¥ec
 *
__»¡riù


907 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

911 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

912 
__THROW
 
	`__nÚnuÎ
 ((1));

918 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

919 
__THROW
 
	`__nÚnuÎ
 ((1));

922 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

923 
__THROW
 
	`__nÚnuÎ
 ((1));

926 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *

927 
__»¡riù
 
__©Œ
,

928 *
__»¡riù
 
__psh¬ed
)

929 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

932 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

933 
__psh¬ed
)

934 
__THROW
 
	`__nÚnuÎ
 ((1));

937 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *

938 
__»¡riù
 
__©Œ
,

939 *
__»¡riù
 
__´ef
)

940 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

943 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

944 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

952 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

953 
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *
__»¡riù


954 
__cÚd_©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

957 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

958 
__THROW
 
	`__nÚnuÎ
 ((1));

961 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

962 
__THROW
 
	`__nÚnuÎ
 ((1));

965 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

966 
__THROW
 
	`__nÚnuÎ
 ((1));

973 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

974 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

975 
	`__nÚnuÎ
 ((1, 2));

984 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

985 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

986 
__cÚ¡
 
time¥ec
 *
__»¡riù


987 
__ab¡ime
è
	`__nÚnuÎ
 ((1, 2, 3));

992 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

993 
__THROW
 
	`__nÚnuÎ
 ((1));

996 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

997 
__THROW
 
	`__nÚnuÎ
 ((1));

1000 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *

1001 
__»¡riù
 
__©Œ
,

1002 *
__»¡riù
 
__psh¬ed
)

1003 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1006 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1007 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1009 #ifdeà
__USE_XOPEN2K


1011 
	$±h»ad_cÚd©Œ_g‘şock
 (
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *

1012 
__»¡riù
 
__©Œ
,

1013 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1014 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1017 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1018 
__şockid_t
 
__şock_id
)

1019 
__THROW
 
	`__nÚnuÎ
 ((1));

1023 #ifdeà
__USE_XOPEN2K


1028 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1029 
__THROW
 
	`__nÚnuÎ
 ((1));

1032 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1033 
__THROW
 
	`__nÚnuÎ
 ((1));

1036 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1037 
__THROW
 
	`__nÚnuÎ
 ((1));

1040 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1041 
__THROW
 
	`__nÚnuÎ
 ((1));

1044 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1045 
__THROW
 
	`__nÚnuÎ
 ((1));

1052 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1053 
__cÚ¡
 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1054 
__©Œ
, 
__couÁ
)

1055 
__THROW
 
	`__nÚnuÎ
 ((1));

1058 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1059 
__THROW
 
	`__nÚnuÎ
 ((1));

1062 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1063 
__THROW
 
	`__nÚnuÎ
 ((1));

1067 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1068 
__THROW
 
	`__nÚnuÎ
 ((1));

1071 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1072 
__THROW
 
	`__nÚnuÎ
 ((1));

1075 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_b¬r›¿‰r_t
 *

1076 
__»¡riù
 
__©Œ
,

1077 *
__»¡riù
 
__psh¬ed
)

1078 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1081 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1082 
__psh¬ed
)

1083 
__THROW
 
	`__nÚnuÎ
 ((1));

1095 
	`±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1096 (*
__de¡r_funùiÚ
) (*))

1097 
__THROW
 
	`__nÚnuÎ
 ((1));

1100 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1103 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1106 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1107 
__cÚ¡
 *
__poš‹r
è
__THROW
 ;

1110 #ifdeà
__USE_XOPEN2K


1112 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1113 
__şockid_t
 *
__şock_id
)

1114 
__THROW
 
	`__nÚnuÎ
 ((2));

1129 
	`±h»ad_©fÜk
 ((*
__´•¬e
) (),

1130 (*
__·»Á
) (),

1131 (*
__chd
è()è
__THROW
;

1134 #ifdeà
__USE_EXTERN_INLINES


1136 
__ex‹º_šlše
 

1137 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1139  
__th»ad1
 =ğ
__th»ad2
;

1140 
	}
}

1143 
	g__END_DECLS


	@/usr/include/signal.h

23 #iâdef 
_SIGNAL_H


25 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


26 
	#_SIGNAL_H


	)

29 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


33 
	~<b™s/sig£t.h
>

37 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


38 #iâdeà
__sig_©omic_t_defšed


39 
	#__sig_©omic_t_defšed


	)

40 
__BEGIN_NAMESPACE_STD


41 
__sig_©omic_t
 
	tsig_©omic_t
;

42 
	g__END_NAMESPACE_STD


44 #undeà
__Ãed_sig_©omic_t


47 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

48 #iâdeà
__sig£t_t_defšed


49 
	#__sig£t_t_defšed


	)

50 
__sig£t_t
 
	tsig£t_t
;

52 #undeà
__Ãed_sig£t_t


55 #ifdeà
_SIGNAL_H


57 
	~<b™s/ty³s.h
>

58 
	~<b™s/signum.h
>

60 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


61 #iâdeà
__pid_t_defšed


62 
__pid_t
 
	tpid_t
;

63 
	#__pid_t_defšed


	)

65 #ifdeà
__USE_XOPEN


67 #iâdeà
__uid_t_defšed


68 
__uid_t
 
	tuid_t
;

69 
	#__uid_t_defšed


	)

73 #ifdeà
__USE_POSIX199309


75 
	#__Ãed_time¥ec


	)

76 
	~<time.h
>

79 
	~<b™s/sigšfo.h
>

84 (*
	t__sighªdËr_t
) ();

89 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

90 
__THROW
;

91 #ifdeà
__USE_GNU


92 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

93 
__THROW
;

99 
__BEGIN_NAMESPACE_STD


100 #ifdeà
__USE_BSD


101 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

102 
__THROW
;

105 #ifdeà
__REDIRECT_NTH


106 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

107 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

108 
__sysv_sigÇl
);

110 
	#sigÇl
 
__sysv_sigÇl


	)

113 
__END_NAMESPACE_STD


115 #ifdeà
__USE_XOPEN


118 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

119 
__THROW
;

125 #ifdeà
__USE_POSIX


126 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

129 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


133 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

136 
__BEGIN_NAMESPACE_STD


138 
	$¿i£
 (
__sig
è
__THROW
;

139 
__END_NAMESPACE_STD


141 #ifdeà
__USE_SVID


143 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

144 
__THROW
;

145 
	$gsigÇl
 (
__sig
è
__THROW
;

148 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K


150 
	`psigÇl
 (
__sig
, 
__cÚ¡
 *
__s
);

153 #ifdeà
__USE_XOPEN2K


155 
	`psigšfo
 (
__cÚ¡
 
sigšfo_t
 *
__pšfo
, __cÚ¡ *
__s
);

168 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

170 #ifdeà
__FAVOR_BSD


173 
	$sig·u£
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

175 #ifdeà
__USE_XOPEN


176 #ifdeà
__GNUC__


177 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

180 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

186 #ifdeà
__USE_BSD


193 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

196 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

199 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

202 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

206 #ifdeà
__USE_MISC


207 
	#NSIG
 
_NSIG


	)

210 #ifdeà
__USE_GNU


211 
__sighªdËr_t
 
	tsighªdËr_t
;

215 #ifdeà
__USE_BSD


216 
__sighªdËr_t
 
	tsig_t
;

219 #ifdeà
__USE_POSIX


222 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

228 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

231 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

234 
	$sigismemb”
 (
__cÚ¡
 
sig£t_t
 *
__£t
, 
__signo
)

235 
__THROW
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__USE_GNU


239 
	$sigi£m±y£t
 (
__cÚ¡
 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

242 
	$sigªd£t
 (
sig£t_t
 *
__£t
, 
__cÚ¡
 sig£t_ˆ*
__Ëá
,

243 
__cÚ¡
 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

246 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, 
__cÚ¡
 sig£t_ˆ*
__Ëá
,

247 
__cÚ¡
 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

252 
	~<b™s/sigaùiÚ.h
>

255 
	$sig´ocmask
 (
__how
, 
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

256 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

263 
	$sigsu¥’d
 (
__cÚ¡
 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

266 
	$sigaùiÚ
 (
__sig
, 
__cÚ¡
 
sigaùiÚ
 *
__»¡riù
 
__aù
,

267 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

270 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

277 
	$sigwa™
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

278 
	`__nÚnuÎ
 ((1, 2));

280 #ifdeà
__USE_POSIX199309


285 
	$sigwa™šfo
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

286 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

293 
	$sigtimedwa™
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

294 
sigšfo_t
 *
__»¡riù
 
__šfo
,

295 
__cÚ¡
 
time¥ec
 *
__»¡riù
 
__timeout
)

296 
	`__nÚnuÎ
 ((1));

300 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, 
__cÚ¡
 
sigv®
 
__v®
)

301 
__THROW
;

306 #ifdeà
__USE_BSD


310 
__cÚ¡
 *__cÚ¡ 
_sys_sigli¡
[
_NSIG
];

311 
__cÚ¡
 *__cÚ¡ 
sys_sigli¡
[
_NSIG
];

314 
	ssigvec


316 
__sighªdËr_t
 
sv_hªdËr
;

317 
sv_mask
;

319 
sv_æags
;

320 
	#sv_Ú¡ack
 
sv_æags


	)

324 
	#SV_ONSTACK
 (1 << 0)

	)

325 
	#SV_INTERRUPT
 (1 << 1)

	)

326 
	#SV_RESETHAND
 (1 << 2)

	)

334 
	$sigvec
 (
__sig
, 
__cÚ¡
 
sigvec
 *
__vec
,

335 
sigvec
 *
__ovec
è
__THROW
;

339 
	~<b™s/sigcÚ‹xt.h
>

342 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

347 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


348 
	#__Ãed_size_t


	)

349 
	~<¡ddef.h
>

354 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

356 
	~<b™s/sig¡ack.h
>

357 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


359 
	~<sys/ucÚ‹xt.h
>

365 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

366 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

370 
	$sig®t¡ack
 (
__cÚ¡
 
sig®t¡ack
 *
__»¡riù
 
__ss
,

371 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

375 #ifdeà
__USE_XOPEN_EXTENDED


379 
	$sighŞd
 (
__sig
è
__THROW
;

382 
	$sig»l£
 (
__sig
è
__THROW
;

385 
	$sigignÜe
 (
__sig
è
__THROW
;

388 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

391 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


394 
	~<b™s/±h»adty³s.h
>

395 
	~<b™s/sigth»ad.h
>

402 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

404 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

408 
__END_DECLS


	@/usr/include/stdint.h

23 #iâdeà
_STDINT_H


24 
	#_STDINT_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	~<b™s/wch¬.h
>

28 
	~<b™s/wÜdsize.h
>

35 #iâdeà
__št8_t_defšed


36 
	#__št8_t_defšed


	)

37 sigÃd 
	tšt8_t
;

38 
	tšt16_t
;

39 
	tšt32_t
;

40 #ià
__WORDSIZE
 == 64

41 
	tšt64_t
;

43 
__ex‹nsiÚ__


44 
	tšt64_t
;

49 
	tušt8_t
;

50 
	tušt16_t
;

51 #iâdeà
__ušt32_t_defšed


52 
	tušt32_t
;

53 
	#__ušt32_t_defšed


	)

55 #ià
__WORDSIZE
 == 64

56 
	tušt64_t
;

58 
__ex‹nsiÚ__


59 
	tušt64_t
;

66 sigÃd 
	tšt_Ëa¡8_t
;

67 
	tšt_Ëa¡16_t
;

68 
	tšt_Ëa¡32_t
;

69 #ià
__WORDSIZE
 == 64

70 
	tšt_Ëa¡64_t
;

72 
__ex‹nsiÚ__


73 
	tšt_Ëa¡64_t
;

77 
	tušt_Ëa¡8_t
;

78 
	tušt_Ëa¡16_t
;

79 
	tušt_Ëa¡32_t
;

80 #ià
__WORDSIZE
 == 64

81 
	tušt_Ëa¡64_t
;

83 
__ex‹nsiÚ__


84 
	tušt_Ëa¡64_t
;

91 sigÃd 
	tšt_ç¡8_t
;

92 #ià
__WORDSIZE
 == 64

93 
	tšt_ç¡16_t
;

94 
	tšt_ç¡32_t
;

95 
	tšt_ç¡64_t
;

97 
	tšt_ç¡16_t
;

98 
	tšt_ç¡32_t
;

99 
__ex‹nsiÚ__


100 
	tšt_ç¡64_t
;

104 
	tušt_ç¡8_t
;

105 #ià
__WORDSIZE
 == 64

106 
	tušt_ç¡16_t
;

107 
	tušt_ç¡32_t
;

108 
	tušt_ç¡64_t
;

110 
	tušt_ç¡16_t
;

111 
	tušt_ç¡32_t
;

112 
__ex‹nsiÚ__


113 
	tušt_ç¡64_t
;

118 #ià
__WORDSIZE
 == 64

119 #iâdeà
__šŒ_t_defšed


120 
	tšŒ_t
;

121 
	#__šŒ_t_defšed


	)

123 
	tušŒ_t
;

125 #iâdeà
__šŒ_t_defšed


126 
	tšŒ_t
;

127 
	#__šŒ_t_defšed


	)

129 
	tušŒ_t
;

134 #ià
__WORDSIZE
 == 64

135 
	tštmax_t
;

136 
	tuštmax_t
;

138 
__ex‹nsiÚ__


139 
	tštmax_t
;

140 
__ex‹nsiÚ__


141 
	tuštmax_t
;

147 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_LIMIT_MACROS


149 #ià
__WORDSIZE
 == 64

150 
	#__INT64_C
(
c
èø## 
L


	)

151 
	#__UINT64_C
(
c
èø## 
UL


	)

153 
	#__INT64_C
(
c
èø## 
LL


	)

154 
	#__UINT64_C
(
c
èø## 
ULL


	)

160 
	#INT8_MIN
 (-128)

	)

161 
	#INT16_MIN
 (-32767-1)

	)

162 
	#INT32_MIN
 (-2147483647-1)

	)

163 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

165 
	#INT8_MAX
 (127)

	)

166 
	#INT16_MAX
 (32767)

	)

167 
	#INT32_MAX
 (2147483647)

	)

168 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

171 
	#UINT8_MAX
 (255)

	)

172 
	#UINT16_MAX
 (65535)

	)

173 
	#UINT32_MAX
 (4294967295U)

	)

174 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

178 
	#INT_LEAST8_MIN
 (-128)

	)

179 
	#INT_LEAST16_MIN
 (-32767-1)

	)

180 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

181 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

183 
	#INT_LEAST8_MAX
 (127)

	)

184 
	#INT_LEAST16_MAX
 (32767)

	)

185 
	#INT_LEAST32_MAX
 (2147483647)

	)

186 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

189 
	#UINT_LEAST8_MAX
 (255)

	)

190 
	#UINT_LEAST16_MAX
 (65535)

	)

191 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

192 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

196 
	#INT_FAST8_MIN
 (-128)

	)

197 #ià
__WORDSIZE
 == 64

198 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

199 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

201 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

202 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

204 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

206 
	#INT_FAST8_MAX
 (127)

	)

207 #ià
__WORDSIZE
 == 64

208 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

209 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

211 
	#INT_FAST16_MAX
 (2147483647)

	)

212 
	#INT_FAST32_MAX
 (2147483647)

	)

214 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

217 
	#UINT_FAST8_MAX
 (255)

	)

218 #ià
__WORDSIZE
 == 64

219 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

220 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

222 
	#UINT_FAST16_MAX
 (4294967295U)

	)

223 
	#UINT_FAST32_MAX
 (4294967295U)

	)

225 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

229 #ià
__WORDSIZE
 == 64

230 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

231 
	#INTPTR_MAX
 (9223372036854775807L)

	)

232 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

234 
	#INTPTR_MIN
 (-2147483647-1)

	)

235 
	#INTPTR_MAX
 (2147483647)

	)

236 
	#UINTPTR_MAX
 (4294967295U)

	)

241 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

243 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

246 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

252 #ià
__WORDSIZE
 == 64

253 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

254 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

256 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

257 
	#PTRDIFF_MAX
 (2147483647)

	)

261 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

262 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

265 #ià
__WORDSIZE
 == 64

266 
	#SIZE_MAX
 (18446744073709551615UL)

	)

268 
	#SIZE_MAX
 (4294967295U)

	)

272 #iâdeà
WCHAR_MIN


274 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

275 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

279 
	#WINT_MIN
 (0u)

	)

280 
	#WINT_MAX
 (4294967295u)

	)

287 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_CONSTANT_MACROS


290 
	#INT8_C
(
c
è
	)
c

291 
	#INT16_C
(
c
è
	)
c

292 
	#INT32_C
(
c
è
	)
c

293 #ià
__WORDSIZE
 == 64

294 
	#INT64_C
(
c
èø## 
L


	)

296 
	#INT64_C
(
c
èø## 
LL


	)

300 
	#UINT8_C
(
c
è
	)
c

301 
	#UINT16_C
(
c
è
	)
c

302 
	#UINT32_C
(
c
èø## 
U


	)

303 #ià
__WORDSIZE
 == 64

304 
	#UINT64_C
(
c
èø## 
UL


	)

306 
	#UINT64_C
(
c
èø## 
ULL


	)

310 #ià
__WORDSIZE
 == 64

311 
	#INTMAX_C
(
c
èø## 
L


	)

312 
	#UINTMAX_C
(
c
èø## 
UL


	)

314 
	#INTMAX_C
(
c
èø## 
LL


	)

315 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/stdio.h

24 #iâdeà
_STDIO_H


26 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


27 
	#_STDIO_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	#__Ãed_size_t


	)

33 
	#__Ãed_NULL


	)

34 
	~<¡ddef.h
>

36 
	~<b™s/ty³s.h
>

37 
	#__Ãed_FILE


	)

38 
	#__Ãed___FILE


	)

42 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


45 
	g_IO_FILE
;

47 
__BEGIN_NAMESPACE_STD


49 
_IO_FILE
 
	tFILE
;

50 
	g__END_NAMESPACE_STD


51 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_SVID
 || defšed 
__USE_POSIX
 \

52 || 
defšed
 
	g__USE_BSD
 || defšed 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

53 || 
defšed
 
__USE_POSIX2


54 
	$__USING_NAMESPACE_STD
(
FILE
)

57 
	#__FILE_defšed
 1

	)

59 #undeà
__Ãed_FILE


62 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


65 
_IO_FILE
 
	t__FILE
;

67 
	#____FILE_defšed
 1

	)

69 #undeà
__Ãed___FILE


72 #ifdef 
_STDIO_H


73 
	#_STDIO_USES_IOSTREAM


	)

75 
	~<libio.h
>

77 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


78 #ifdeà
__GNUC__


79 #iâdeà
_VA_LIST_DEFINED


80 
_G_va_li¡
 
	tva_li¡
;

81 
	#_VA_LIST_DEFINED


	)

84 
	~<¡d¬g.h
>

88 #ifdeà
__USE_XOPEN2K8


89 #iâdeà
__off_t_defšed


90 #iâdeà
__USE_FILE_OFFSET64


91 
__off_t
 
	toff_t
;

93 
__off64_t
 
	toff_t
;

95 
	#__off_t_defšed


	)

97 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


98 
__off64_t
 
	toff64_t
;

99 
	#__off64_t_defšed


	)

102 #iâdeà
__ssize_t_defšed


103 
__ssize_t
 
	tssize_t
;

104 
	#__ssize_t_defšed


	)

109 
__BEGIN_NAMESPACE_STD


110 #iâdeà
__USE_FILE_OFFSET64


111 
_G_åos_t
 
	tåos_t
;

113 
_G_åos64_t
 
	tåos_t
;

115 
__END_NAMESPACE_STD


116 #ifdeà
__USE_LARGEFILE64


117 
_G_åos64_t
 
	tåos64_t
;

121 
	#_IOFBF
 0

	)

122 
	#_IOLBF
 1

	)

123 
	#_IONBF
 2

	)

127 #iâdeà
BUFSIZ


128 
	#BUFSIZ
 
_IO_BUFSIZ


	)

134 #iâdeà
EOF


135 
	#EOF
 (-1)

	)

141 
	#SEEK_SET
 0

	)

142 
	#SEEK_CUR
 1

	)

143 
	#SEEK_END
 2

	)

146 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


148 
	#P_tmpdœ
 "/tmp"

	)

161 
	~<b™s/¡dio_lim.h
>

165 
_IO_FILE
 *
¡dš
;

166 
_IO_FILE
 *
¡dout
;

167 
_IO_FILE
 *
¡d”r
;

169 
	#¡dš
 
¡dš


	)

170 
	#¡dout
 
¡dout


	)

171 
	#¡d”r
 
¡d”r


	)

173 
__BEGIN_NAMESPACE_STD


175 
	$»move
 (
__cÚ¡
 *
__f’ame
è
__THROW
;

177 
	$»Çme
 (
__cÚ¡
 *
__Şd
, __cÚ¡ *
__Ãw
è
__THROW
;

178 
__END_NAMESPACE_STD


180 #ifdeà
__USE_ATFILE


182 
	$»Çm—t
 (
__Şdfd
, 
__cÚ¡
 *
__Şd
, 
__Ãwfd
,

183 
__cÚ¡
 *
__Ãw
è
__THROW
;

186 
__BEGIN_NAMESPACE_STD


191 #iâdeà
__USE_FILE_OFFSET64


192 
FILE
 *
	$tmpfe
 (è
__wur
;

194 #ifdeà
__REDIRECT


195 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

197 
	#tmpfe
 
tmpfe64


	)

201 #ifdeà
__USE_LARGEFILE64


202 
FILE
 *
	$tmpfe64
 (è
__wur
;

206 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

207 
__END_NAMESPACE_STD


209 #ifdeà
__USE_MISC


212 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

216 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


224 *
	$‹m²am
 (
__cÚ¡
 *
__dœ
, __cÚ¡ *
__pfx
)

225 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

229 
__BEGIN_NAMESPACE_STD


234 
	`fşo£
 (
FILE
 *
__¡»am
);

239 
	`fæush
 (
FILE
 *
__¡»am
);

240 
__END_NAMESPACE_STD


242 #ifdeà
__USE_MISC


249 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

252 #ifdeà
__USE_GNU


259 
	`fşo£®l
 ();

263 
__BEGIN_NAMESPACE_STD


264 #iâdeà
__USE_FILE_OFFSET64


269 
FILE
 *
	$fİ’
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

270 
__cÚ¡
 *
__»¡riù
 
__modes
è
__wur
;

275 
FILE
 *
	$äeİ’
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

276 
__cÚ¡
 *
__»¡riù
 
__modes
,

277 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

279 #ifdeà
__REDIRECT


280 
FILE
 *
	`__REDIRECT
 (
fİ’
, (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

281 
__cÚ¡
 *
__»¡riù
 
__modes
), 
fİ’64
)

282 
__wur
;

283 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

284 
__cÚ¡
 *
__»¡riù
 
__modes
,

285 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

286 
__wur
;

288 
	#fİ’
 
fİ’64


	)

289 
	#äeİ’
 
äeİ’64


	)

292 
__END_NAMESPACE_STD


293 #ifdeà
__USE_LARGEFILE64


294 
FILE
 *
	$fİ’64
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

295 
__cÚ¡
 *
__»¡riù
 
__modes
è
__wur
;

296 
FILE
 *
	$äeİ’64
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

297 
__cÚ¡
 *
__»¡riù
 
__modes
,

298 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

301 #ifdef 
__USE_POSIX


303 
FILE
 *
	$fdİ’
 (
__fd
, 
__cÚ¡
 *
__modes
è
__THROW
 
__wur
;

306 #ifdef 
__USE_GNU


309 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

310 
__cÚ¡
 *
__»¡riù
 
__modes
,

311 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

314 #ifdeà
__USE_XOPEN2K8


316 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, 
__cÚ¡
 *
__modes
)

317 
__THROW
 
__wur
;

322 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

326 
__BEGIN_NAMESPACE_STD


329 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

333 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

334 
__modes
, 
size_t
 
__n
è
__THROW
;

335 
__END_NAMESPACE_STD


337 #ifdef 
__USE_BSD


340 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

341 
size_t
 
__size
è
__THROW
;

344 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

348 
__BEGIN_NAMESPACE_STD


353 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

354 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

359 
	`´štf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

361 
	$¥rštf
 (*
__»¡riù
 
__s
,

362 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

368 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

369 
_G_va_li¡
 
__¬g
);

374 
	`v´štf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

376 
	$v¥rštf
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

377 
_G_va_li¡
 
__¬g
è
__THROW
;

378 
__END_NAMESPACE_STD


380 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


381 
__BEGIN_NAMESPACE_C99


383 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

384 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...)

385 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

387 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

388 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

389 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

390 
__END_NAMESPACE_C99


393 #ifdeà
__USE_GNU


396 
	$va¥rštf
 (**
__»¡riù
 
__±r
, 
__cÚ¡
 *__»¡riù 
__f
,

397 
_G_va_li¡
 
__¬g
)

398 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

399 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

400 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

401 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

402 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

403 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

404 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

407 #ifdeà
__USE_XOPEN2K8


414 
	$vd´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
,

415 
_G_va_li¡
 
__¬g
)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

417 
	$d´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

418 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

422 
__BEGIN_NAMESPACE_STD


427 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

428 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$sÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

435 
	$ssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

436 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

438 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

439 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

440 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

441 #ifdeà
__REDIRECT


445 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

446 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_fsÿnf
è
__wur
;

448 
	`__REDIRECT
 (
sÿnf
, (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

449 
__isoc99_sÿnf
è
__wur
;

450 
	`__REDIRECT_NTH
 (
ssÿnf
, (
__cÚ¡
 *
__»¡riù
 
__s
,

451 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

452 
__isoc99_ssÿnf
);

454 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

455 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

456 
	$__isoc99_sÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

457 
	$__isoc99_ssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

458 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

459 
	#fsÿnf
 
__isoc99_fsÿnf


	)

460 
	#sÿnf
 
__isoc99_sÿnf


	)

461 
	#ssÿnf
 
__isoc99_ssÿnf


	)

465 
__END_NAMESPACE_STD


467 #ifdef 
__USE_ISOC99


468 
__BEGIN_NAMESPACE_C99


473 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

474 
_G_va_li¡
 
__¬g
)

475 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

481 
	$vsÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

482 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

485 
	$vssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

486 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

487 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

489 #ià!
defšed
 
__USE_GNU
 \

490 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

491 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

492 #ifdeà
__REDIRECT


496 
	`__REDIRECT
 (
vfsÿnf
,

497 (
FILE
 *
__»¡riù
 
__s
,

498 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

499 
__isoc99_vfsÿnf
)

500 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

501 
	`__REDIRECT
 (
vsÿnf
, (
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

502 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

503 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

504 
	`__REDIRECT_NTH
 (
vssÿnf
,

505 (
__cÚ¡
 *
__»¡riù
 
__s
,

506 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

507 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

508 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

510 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

511 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vsÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

514 
_G_va_li¡
 
__¬g
è
__wur
;

515 
	$__isoc99_vssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

516 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

517 
_G_va_li¡
 
__¬g
è
__THROW
;

518 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

519 
	#vsÿnf
 
__isoc99_vsÿnf


	)

520 
	#vssÿnf
 
__isoc99_vssÿnf


	)

524 
__END_NAMESPACE_C99


528 
__BEGIN_NAMESPACE_STD


533 
	`fg‘c
 (
FILE
 *
__¡»am
);

534 
	`g‘c
 (
FILE
 *
__¡»am
);

540 
	`g‘ch¬
 ();

541 
__END_NAMESPACE_STD


545 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

547 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


552 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

553 
	`g‘ch¬_uÆocked
 ();

556 #ifdeà
__USE_MISC


563 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

567 
__BEGIN_NAMESPACE_STD


575 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

576 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

582 
	`putch¬
 (
__c
);

583 
__END_NAMESPACE_STD


587 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

589 #ifdeà
__USE_MISC


596 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

599 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


604 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

605 
	`putch¬_uÆocked
 (
__c
);

609 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 \

610 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

612 
	`g‘w
 (
FILE
 *
__¡»am
);

615 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

619 
__BEGIN_NAMESPACE_STD


624 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

625 
__wur
;

632 *
	$g‘s
 (*
__s
è
__wur
;

633 
__END_NAMESPACE_STD


635 #ifdeà
__USE_GNU


642 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

643 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

647 #ifdef 
__USE_XOPEN2K8


658 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

659 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

660 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

661 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

662 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

663 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

671 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

672 
size_t
 *
__»¡riù
 
__n
,

673 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

677 
__BEGIN_NAMESPACE_STD


682 
	`åuts
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

688 
	`puts
 (
__cÚ¡
 *
__s
);

695 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

702 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

703 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

708 
size_t
 
	`fwr™e
 (
__cÚ¡
 *
__»¡riù
 
__±r
, size_ˆ
__size
,

709 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

710 
__END_NAMESPACE_STD


712 #ifdeà
__USE_GNU


719 
	`åuts_uÆocked
 (
__cÚ¡
 *
__»¡riù
 
__s
,

720 
FILE
 *
__»¡riù
 
__¡»am
);

723 #ifdeà
__USE_MISC


730 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

731 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

732 
size_t
 
	`fwr™e_uÆocked
 (
__cÚ¡
 *
__»¡riù
 
__±r
, size_ˆ
__size
,

733 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

737 
__BEGIN_NAMESPACE_STD


742 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

747 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

752 
	`»wšd
 (
FILE
 *
__¡»am
);

753 
__END_NAMESPACE_STD


760 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


761 #iâdeà
__USE_FILE_OFFSET64


766 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

771 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

773 #ifdeà
__REDIRECT


774 
	`__REDIRECT
 (
f£eko
,

775 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

776 
f£eko64
);

777 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

779 
	#f£eko
 
f£eko64


	)

780 
	#á–lo
 
á–lo64


	)

785 
__BEGIN_NAMESPACE_STD


786 #iâdeà
__USE_FILE_OFFSET64


791 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

796 
	`f£os
 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos_t
 *
__pos
);

798 #ifdeà
__REDIRECT


799 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

800 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

801 
	`__REDIRECT
 (
f£os
,

802 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos_t
 *
__pos
), 
f£os64
);

804 
	#fg‘pos
 
fg‘pos64


	)

805 
	#f£os
 
f£os64


	)

808 
__END_NAMESPACE_STD


810 #ifdeà
__USE_LARGEFILE64


811 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

812 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

813 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

814 
	`f£os64
 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos64_t
 *
__pos
);

817 
__BEGIN_NAMESPACE_STD


819 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

821 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

823 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

824 
__END_NAMESPACE_STD


826 #ifdeà
__USE_MISC


828 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

829 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

834 
__BEGIN_NAMESPACE_STD


839 
	`³¼Ü
 (
__cÚ¡
 *
__s
);

840 
__END_NAMESPACE_STD


846 
	~<b™s/sys_”¾i¡.h
>

849 #ifdef 
__USE_POSIX


851 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

854 #ifdeà
__USE_MISC


856 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

860 #ià(
defšed
 
__USE_POSIX2
 || defšed 
__USE_SVID
 || defšed 
__USE_BSD
 || \

861 
defšed
 
__USE_MISC
)

866 
FILE
 *
	$pİ’
 (
__cÚ¡
 *
__commªd
, __cÚ¡ *
__modes
è
__wur
;

872 
	`pşo£
 (
FILE
 *
__¡»am
);

876 #ifdef 
__USE_POSIX


878 *
	$ù”mid
 (*
__s
è
__THROW
;

882 #ifdeà
__USE_XOPEN


884 *
	`cu£rid
 (*
__s
);

888 #ifdef 
__USE_GNU


889 
ob¡ack
;

892 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

893 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...)

894 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

895 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

896 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

897 
_G_va_li¡
 
__¬gs
)

898 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

902 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


906 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

910 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

913 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


920 
	#__Ãed_g‘İt


	)

921 
	~<g‘İt.h
>

926 #ifdeà
__USE_EXTERN_INLINES


927 
	~<b™s/¡dio.h
>

929 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


930 
	~<b™s/¡dio2.h
>

932 #ifdeà
__LDBL_COMPAT


933 
	~<b™s/¡dio-ldbl.h
>

936 
__END_DECLS


	@/usr/include/stdlib.h

23 #iâdef 
_STDLIB_H


25 
	~<ã©u»s.h
>

28 
	#__Ãed_size_t


	)

29 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


30 
	#__Ãed_wch¬_t


	)

31 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	g__BEGIN_DECLS


37 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


38 
	#_STDLIB_H
 1

	)

40 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


42 
	~<b™s/wa™æags.h
>

43 
	~<b™s/wa™¡©us.h
>

45 #ifdeà
__USE_BSD


50 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


51 
	#__WAIT_INT
(
¡©us
) \

52 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

53 { .
__š
 = (
¡©us
è}).
__i
))

	)

55 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

63 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


64 
	#__WAIT_STATUS
 *

	)

65 
	#__WAIT_STATUS_DEFN
 *

	)

70 
wa™
 *
	m__u±r
;

71 *
	m__Œ
;

72 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

73 
	#__WAIT_STATUS_DEFN
 *

	)

78 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

79 
	#__WAIT_STATUS
 *

	)

80 
	#__WAIT_STATUS_DEFN
 *

	)

85 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

90 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

91 #ifdeà
__WIFCONTINUED


92 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

96 
__BEGIN_NAMESPACE_STD


100 
	mquÙ
;

101 
	m»m
;

102 } 
	tdiv_t
;

105 #iâdeà
__ldiv_t_defšed


108 
	mquÙ
;

109 
	m»m
;

110 } 
	tldiv_t
;

111 
	#__ldiv_t_defšed
 1

	)

113 
	g__END_NAMESPACE_STD


115 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


116 
__BEGIN_NAMESPACE_C99


118 
__ex‹nsiÚ__
 struct

120 
	mquÙ
;

121 
	m»m
;

122 } 
	tÎdiv_t
;

123 
	#__Îdiv_t_defšed
 1

	)

124 
	g__END_NAMESPACE_C99


129 
	#RAND_MAX
 2147483647

	)

134 
	#EXIT_FAILURE
 1

	)

135 
	#EXIT_SUCCESS
 0

	)

139 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

140 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

143 
__BEGIN_NAMESPACE_STD


145 
	$©of
 (
__cÚ¡
 *
__ÅŒ
)

146 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

148 
	$©oi
 (
__cÚ¡
 *
__ÅŒ
)

149 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

151 
	$©Ş
 (
__cÚ¡
 *
__ÅŒ
)

152 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

153 
__END_NAMESPACE_STD


155 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_MISC
)

156 
__BEGIN_NAMESPACE_C99


158 
__ex‹nsiÚ__
 
	$©Şl
 (
__cÚ¡
 *
__ÅŒ
)

159 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

160 
__END_NAMESPACE_C99


163 
__BEGIN_NAMESPACE_STD


165 
	$¡¹od
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

166 **
__»¡riù
 
__’d±r
)

167 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

168 
__END_NAMESPACE_STD


170 #ifdef 
__USE_ISOC99


171 
__BEGIN_NAMESPACE_C99


173 
	$¡¹of
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

174 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

176 
	$¡¹Şd
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

177 **
__»¡riù
 
__’d±r
)

178 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

179 
__END_NAMESPACE_C99


182 
__BEGIN_NAMESPACE_STD


184 
	$¡¹Ş
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

185 **
__»¡riù
 
__’d±r
, 
__ba£
)

186 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

188 
	$¡¹oul
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

189 **
__»¡riù
 
__’d±r
, 
__ba£
)

190 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

191 
__END_NAMESPACE_STD


193 #ià
defšed
 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_BSD


195 
__ex‹nsiÚ__


196 
	$¡¹oq
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

197 **
__»¡riù
 
__’d±r
, 
__ba£
)

198 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

200 
__ex‹nsiÚ__


201 
	$¡¹ouq
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

202 **
__»¡riù
 
__’d±r
, 
__ba£
)

203 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

206 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_MISC
)

207 
__BEGIN_NAMESPACE_C99


209 
__ex‹nsiÚ__


210 
	$¡¹Şl
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

211 **
__»¡riù
 
__’d±r
, 
__ba£
)

212 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

214 
__ex‹nsiÚ__


215 
	$¡¹ouÎ
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

216 **
__»¡riù
 
__’d±r
, 
__ba£
)

217 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

218 
__END_NAMESPACE_C99


222 #ifdeà
__USE_GNU


236 
	~<xloÿË.h
>

240 
	$¡¹Ş_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

241 **
__»¡riù
 
__’d±r
, 
__ba£
,

242 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

244 
	$¡¹oul_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

245 **
__»¡riù
 
__’d±r
,

246 
__ba£
, 
__loÿË_t
 
__loc
)

247 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

249 
__ex‹nsiÚ__


250 
	$¡¹Şl_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

251 **
__»¡riù
 
__’d±r
, 
__ba£
,

252 
__loÿË_t
 
__loc
)

253 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

255 
__ex‹nsiÚ__


256 
	$¡¹ouÎ_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

257 **
__»¡riù
 
__’d±r
,

258 
__ba£
, 
__loÿË_t
 
__loc
)

259 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

261 
	$¡¹od_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

262 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

263 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

265 
	$¡¹of_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

266 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

267 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

269 
	$¡¹Şd_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

270 **
__»¡riù
 
__’d±r
,

271 
__loÿË_t
 
__loc
)

272 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

276 #ifdeà
__USE_EXTERN_INLINES


277 
__BEGIN_NAMESPACE_STD


278 
__ex‹º_šlše
 

279 
	`__NTH
 (
	$©of
 (
__cÚ¡
 *
__ÅŒ
))

281  
	`¡¹od
 (
__ÅŒ
, (**è
NULL
);

282 
	}
}

283 
__ex‹º_šlše
 

284 
__NTH
 (
	$©oi
 (
__cÚ¡
 *
__ÅŒ
))

286  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

287 
	}
}

288 
__ex‹º_šlše
 

289 
__NTH
 (
	$©Ş
 (
__cÚ¡
 *
__ÅŒ
))

291  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

292 
	}
}

293 
	g__END_NAMESPACE_STD


295 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


296 
__BEGIN_NAMESPACE_C99


297 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

298 
__NTH
 (
	$©Şl
 (
__cÚ¡
 *
__ÅŒ
))

300  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

301 
	}
}

302 
	g__END_NAMESPACE_C99


307 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED


311 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

314 
	$a64l
 (
__cÚ¡
 *
__s
)

315 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

319 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_BSD


320 
	~<sys/ty³s.h
>

327 
	$¿ndom
 (è
__THROW
;

330 
	$¤ªdom
 (
__£ed
è
__THROW
;

336 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

337 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

341 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

344 #ifdeà
__USE_MISC


349 
	s¿ndom_d©a


351 
št32_t
 *
åŒ
;

352 
št32_t
 *
½Œ
;

353 
št32_t
 *
¡©e
;

354 
¿nd_ty³
;

355 
¿nd_deg
;

356 
¿nd_£p
;

357 
št32_t
 *
’d_±r
;

360 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

361 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

363 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

364 
__THROW
 
	`__nÚnuÎ
 ((2));

366 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

367 
size_t
 
__¡©–’
,

368 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

369 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

371 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

372 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

373 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

378 
__BEGIN_NAMESPACE_STD


380 
	$¿nd
 (è
__THROW
;

382 
	$¤ªd
 (
__£ed
è
__THROW
;

383 
__END_NAMESPACE_STD


385 #ifdeà
__USE_POSIX


387 
	$¿nd_r
 (*
__£ed
è
__THROW
;

391 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


395 
	$d¿nd48
 (è
__THROW
;

396 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

399 
	$Ìªd48
 (è
__THROW
;

400 
	$Äªd48
 (
__xsubi
[3])

401 
__THROW
 
	`__nÚnuÎ
 ((1));

404 
	$m¿nd48
 (è
__THROW
;

405 
	$j¿nd48
 (
__xsubi
[3])

406 
__THROW
 
	`__nÚnuÎ
 ((1));

409 
	$¤ªd48
 (
__£edv®
è
__THROW
;

410 *
	$£ed48
 (
__£ed16v
[3])

411 
__THROW
 
	`__nÚnuÎ
 ((1));

412 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

414 #ifdeà
__USE_MISC


418 
	sd¿nd48_d©a


420 
__x
[3];

421 
__Şd_x
[3];

422 
__c
;

423 
__š™
;

424 
__a
;

428 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

429 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$”ªd48_r
 (
__xsubi
[3],

431 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

432 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

435 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

436 *
__»¡riù
 
__»suÉ
)

437 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

438 
	$Äªd48_r
 (
__xsubi
[3],

439 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

445 *
__»¡riù
 
__»suÉ
)

446 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

447 
	$j¿nd48_r
 (
__xsubi
[3],

448 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

449 *
__»¡riù
 
__»suÉ
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

453 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

454 
__THROW
 
	`__nÚnuÎ
 ((2));

456 
	$£ed48_r
 (
__£ed16v
[3],

457 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$lcÚg48_r
 (
__·¿m
[7],

460 
d¿nd48_d©a
 *
__bufãr
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

467 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


468 
	#__m®loc_ªd_ÿÎoc_defšed


	)

469 
__BEGIN_NAMESPACE_STD


471 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

473 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

474 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

475 
__END_NAMESPACE_STD


478 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


479 
__BEGIN_NAMESPACE_STD


485 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

486 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

488 
	$ä“
 (*
__±r
è
__THROW
;

489 
__END_NAMESPACE_STD


491 #ifdef 
__USE_MISC


493 
	$cä“
 (*
__±r
è
__THROW
;

496 #ià
defšed
 
__USE_GNU
 || defšed 
__USE_BSD
 || defšed 
__USE_MISC


497 
	~<®loÿ.h
>

500 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

501 || 
defšed
 
__USE_BSD


503 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

506 #ifdeà
__USE_XOPEN2K


508 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

509 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

512 
__BEGIN_NAMESPACE_STD


514 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

518 
	`©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

520 #ifdeà
__USE_GNU


524 #ifdeà
__ılu¥lus


525 "C++" 
	`©_quick_ex™
 ((*
__func
) ())

526 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

528 
	`©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

531 
__END_NAMESPACE_STD


533 #ifdef 
__USE_MISC


536 
	`Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

537 
__THROW
 
	`__nÚnuÎ
 ((1));

540 
__BEGIN_NAMESPACE_STD


544 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

546 #ifdeà
__USE_GNU


552 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

554 
__END_NAMESPACE_STD


556 #ifdeà
__USE_ISOC99


557 
__BEGIN_NAMESPACE_C99


560 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

561 
__END_NAMESPACE_C99


565 
__BEGIN_NAMESPACE_STD


567 *
	$g‘’v
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

568 
__END_NAMESPACE_STD


572 *
	$__£cu»_g‘’v
 (
__cÚ¡
 *
__Çme
)

573 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

575 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


579 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

582 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


585 
	$£‹nv
 (
__cÚ¡
 *
__Çme
, __cÚ¡ *
__v®ue
, 
__»¶aû
)

586 
__THROW
 
	`__nÚnuÎ
 ((2));

589 
	$un£‹nv
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

592 #ifdef 
__USE_MISC


596 
	$ş—»nv
 (è
__THROW
;

600 #ià
defšed
 
__USE_MISC
 \

601 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

609 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 \

610 || 
defšed
 
__USE_XOPEN2K8


619 #iâdeà
__USE_FILE_OFFSET64


620 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

622 #ifdeà
__REDIRECT


623 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

624 
	`__nÚnuÎ
 ((1)è
__wur
;

626 
	#mk¡emp
 
mk¡emp64


	)

629 #ifdeà
__USE_LARGEFILE64


630 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

634 #ifdeà
__USE_MISC


641 #iâdeà
__USE_FILE_OFFSET64


642 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

644 #ifdeà
__REDIRECT


645 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

646 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

648 
	#mk¡emps
 
mk¡emps64


	)

651 #ifdeà
__USE_LARGEFILE64


652 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

653 
	`__nÚnuÎ
 ((1)è
__wur
;

657 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K8


663 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

666 #ifdeà
__USE_GNU


673 #iâdeà
__USE_FILE_OFFSET64


674 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

676 #ifdeà
__REDIRECT


677 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

678 
	`__nÚnuÎ
 ((1)è
__wur
;

680 
	#mko¡emp
 
mko¡emp64


	)

683 #ifdeà
__USE_LARGEFILE64


684 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

693 #iâdeà
__USE_FILE_OFFSET64


694 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

695 
	`__nÚnuÎ
 ((1)è
__wur
;

697 #ifdeà
__REDIRECT


698 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

699 
__æags
), 
mko¡emps64
)

700 
	`__nÚnuÎ
 ((1)è
__wur
;

702 
	#mko¡emps
 
mko¡emps64


	)

705 #ifdeà
__USE_LARGEFILE64


706 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

707 
	`__nÚnuÎ
 ((1)è
__wur
;

712 
__BEGIN_NAMESPACE_STD


717 
	$sy¡em
 (
__cÚ¡
 *
__commªd
è
__wur
;

718 
__END_NAMESPACE_STD


721 #ifdef 
__USE_GNU


724 *
	$ÿnÚiÿlize_fe_Çme
 (
__cÚ¡
 *
__Çme
)

725 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

728 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


734 *
	$»®·th
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

735 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

740 #iâdeà
__COMPAR_FN_T


741 
	#__COMPAR_FN_T


	)

742 (*
	t__com·r_â_t
è(
	t__cÚ¡
 *, __const *);

744 #ifdef 
__USE_GNU


745 
__com·r_â_t
 
	tcom·risÚ_â_t
;

748 #ifdeà
__USE_GNU


749 (*
	t__com·r_d_â_t
è(
	t__cÚ¡
 *, __const *, *);

752 
__BEGIN_NAMESPACE_STD


755 *
	$b£¬ch
 (
__cÚ¡
 *
__key
, __cÚ¡ *
__ba£
,

756 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

757 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

761 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

762 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

763 #ifdeà
__USE_GNU


764 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

766 
	`__nÚnuÎ
 ((1, 4));

771 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

772 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

773 
__END_NAMESPACE_STD


775 #ifdeà
__USE_ISOC99


776 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

777 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

781 
__BEGIN_NAMESPACE_STD


785 
div_t
 
	$div
 (
__num”
, 
__d’om
)

786 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

787 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

788 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

789 
__END_NAMESPACE_STD


791 #ifdeà
__USE_ISOC99


792 
__BEGIN_NAMESPACE_C99


793 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

794 
__d’om
)

795 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

796 
__END_NAMESPACE_C99


800 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

801 || 
defšed
 
__USE_SVID


808 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

809 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

814 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

815 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

820 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

821 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

824 #ifdeà
__USE_MISC


826 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

827 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

828 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

829 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

833 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

838 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

839 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

840 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

841 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

845 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

846 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

847 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

848 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

849 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

850 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

851 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

852 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

857 
__BEGIN_NAMESPACE_STD


860 
	$mbËn
 (
__cÚ¡
 *
__s
, 
size_t
 
__n
è
__THROW
 
__wur
;

863 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

864 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
 
__wur
;

867 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
 
__wur
;

871 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

872 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

874 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

875 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

876 
__THROW
;

877 
__END_NAMESPACE_STD


880 #ifdeà
__USE_SVID


885 
	$½m©ch
 (
__cÚ¡
 *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

889 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


896 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

897 *
__cÚ¡
 *
__»¡riù
 
__tok’s
,

898 **
__»¡riù
 
__v®u•
)

899 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

903 #ifdeà
__USE_XOPEN


905 
	$£tkey
 (
__cÚ¡
 *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

911 #ifdeà
__USE_XOPEN2KXSI


913 
	$posix_İ’±
 (
__oæag
è
__wur
;

916 #ifdeà
__USE_XOPEN


921 
	$g¿Á±
 (
__fd
è
__THROW
;

925 
	$uÆock±
 (
__fd
è
__THROW
;

930 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

933 #ifdeà
__USE_GNU


937 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

938 
__THROW
 
	`__nÚnuÎ
 ((2));

941 
	`g‘±
 ();

944 #ifdeà
__USE_BSD


948 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

949 
__THROW
 
	`__nÚnuÎ
 ((1));

954 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


955 
	~<b™s/¡dlib.h
>

957 #ifdeà
__LDBL_COMPAT


958 
	~<b™s/¡dlib-ldbl.h
>

962 #undeà
__Ãed_m®loc_ªd_ÿÎoc


964 
__END_DECLS


	@/usr/include/string.h

24 #iâdef 
_STRING_H


25 
	#_STRING_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


32 
	#__Ãed_size_t


	)

33 
	#__Ãed_NULL


	)

34 
	~<¡ddef.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 
__BEGIN_NAMESPACE_STD


44 *
	$memıy
 (*
__»¡riù
 
__de¡
,

45 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

46 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

49 *
	$memmove
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
)

50 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

51 
__END_NAMESPACE_STD


56 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN


57 *
	$memcıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

58 
__c
, 
size_t
 
__n
)

59 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

63 
__BEGIN_NAMESPACE_STD


65 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

68 
	$memcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

72 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


75 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

76 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 
__cÚ¡
 *
	`memchr
 (__cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

78 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

80 #ifdeà
__OPTIMIZE__


81 
__ex‹º_®ways_šlše
 *

82 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


84  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

87 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

88 
	`memchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


90  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

93 
	}
}

95 *
	$memchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

96 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

98 
__END_NAMESPACE_STD


100 #ifdeà
__USE_GNU


103 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


104 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

105 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 "C++" 
__cÚ¡
 *
	$¿wmemchr
 (
__cÚ¡
 *
__s
, 
__c
)

107 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

109 *
	$¿wmemchr
 (
__cÚ¡
 *
__s
, 
__c
)

110 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 "C++" 
__cÚ¡
 *
	$memrchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

120 *
	$memrchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

126 
__BEGIN_NAMESPACE_STD


128 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

129 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

131 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

132 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

133 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

137 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

139 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

140 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
	$¡ºcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

147 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
	$¡rcŞl
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

153 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

154 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

155 
__THROW
 
	`__nÚnuÎ
 ((2));

156 
__END_NAMESPACE_STD


158 #ifdeà
__USE_XOPEN2K8


162 
	~<xloÿË.h
>

165 
	$¡rcŞl_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

166 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

168 
size_t
 
	$¡rxäm_l
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
,

169 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

172 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 \

173 || 
defšed
 
__USE_XOPEN2K8


175 *
	$¡rdup
 (
__cÚ¡
 *
__s
)

176 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

182 #ià
defšed
 
__USE_XOPEN2K8


183 *
	$¡ºdup
 (
__cÚ¡
 *
__¡ršg
, 
size_t
 
__n
)

184 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

187 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


189 
	#¡rdu·
(
s
) \

190 (
__ex‹nsiÚ__
 \

192 
__cÚ¡
 *
__Şd
 = (
s
); \

193 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

194 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

195 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

196 
	}
}))

	)

199 
	#¡ºdu·
(
s
, 
n
) \

200 (
__ex‹nsiÚ__
 \

202 
__cÚ¡
 *
__Şd
 = (
s
); \

203 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

204 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

205 
__Ãw
[
__Ën
] = '\0'; \

206 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

207 }))

	)

210 
	g__BEGIN_NAMESPACE_STD


212 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


215 *
¡rchr
 (*
__s
, 
__c
)

216 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

217 
__cÚ¡
 *
¡rchr
 (__cÚ¡ *
__s
, 
__c
)

218 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

220 #ifdeà
__OPTIMIZE__


221 
__ex‹º_®ways_šlše
 *

222 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


224  
__butš_¡rchr
 (
__s
, 
__c
);

227 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

228 
¡rchr
 (
__cÚ¡
 *
__s
, 
__c
è
	g__THROW


230  
__butš_¡rchr
 (
__s
, 
__c
);

235 *
	$¡rchr
 (
__cÚ¡
 *
__s
, 
__c
)

236 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

239 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


242 *
	`¡¼chr
 (*
__s
, 
__c
)

243 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

244 
__cÚ¡
 *
	`¡¼chr
 (__cÚ¡ *
__s
, 
__c
)

245 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

247 #ifdeà
__OPTIMIZE__


248 
__ex‹º_®ways_šlše
 *

249 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


251  
	`__butš_¡¼chr
 (
__s
, 
__c
);

254 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

255 
	`¡¼chr
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


257  
	`__butš_¡¼chr
 (
__s
, 
__c
);

260 
	}
}

262 *
	$¡¼chr
 (
__cÚ¡
 *
__s
, 
__c
)

263 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_GNU


270 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


271 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

272 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

273 "C++" 
__cÚ¡
 *
	$¡rchºul
 (
__cÚ¡
 *
__s
, 
__c
)

274 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

276 *
	$¡rchºul
 (
__cÚ¡
 *
__s
, 
__c
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

281 
__BEGIN_NAMESPACE_STD


284 
size_t
 
	$¡rc¥n
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__»jeù
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

288 
size_t
 
	$¡r¥n
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
)

289 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

291 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


294 *
	`¡½brk
 (*
__s
, 
__cÚ¡
 *
__acû±
)

295 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

296 
__cÚ¡
 *
	`¡½brk
 (__cÚ¡ *
__s
, __cÚ¡ *
__acû±
)

297 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

299 #ifdeà
__OPTIMIZE__


300 
__ex‹º_®ways_šlše
 *

301 
	`¡½brk
 (*
__s
, 
__cÚ¡
 *
__acû±
è
__THROW


303  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

306 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

307 
	`¡½brk
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
è
__THROW


309  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

312 
	}
}

314 *
	$¡½brk
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
)

315 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

318 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


321 *
	`¡r¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
)

322 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

323 
__cÚ¡
 *
	`¡r¡r
 (__cÚ¡ *
__hay¡ack
,

324 
__cÚ¡
 *
__ÃedË
)

325 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__OPTIMIZE__


328 
__ex‹º_®ways_šlše
 *

329 
	`¡r¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
è
__THROW


331  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

334 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

335 
	`¡r¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
è
__THROW


337  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

340 
	}
}

342 *
	$¡r¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
)

343 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

348 *
	$¡¹ok
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__d–im
)

349 
__THROW
 
	`__nÚnuÎ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

355 
__cÚ¡
 *
__»¡riù
 
__d–im
,

356 **
__»¡riù
 
__§ve_±r
)

357 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

358 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


359 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__d–im
,

360 **
__»¡riù
 
__§ve_±r
)

361 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

364 #ifdeà
__USE_GNU


366 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
)

368 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

369 "C++" 
__cÚ¡
 *
	$¡rÿ£¡r
 (
__cÚ¡
 *
__hay¡ack
,

370 
__cÚ¡
 *
__ÃedË
)

371 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 *
	$¡rÿ£¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
)

374 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

378 #ifdeà
__USE_GNU


382 *
	$memmem
 (
__cÚ¡
 *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

383 
__cÚ¡
 *
__ÃedË
, 
size_t
 
__ÃedËËn
)

384 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

388 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

389 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

390 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

391 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

392 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

393 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$¡¾’
 (
__cÚ¡
 *
__s
)

400 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$¡ºËn
 (
__cÚ¡
 *
__¡ršg
, 
size_t
 
__maxËn
)

407 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

414 
__END_NAMESPACE_STD


415 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_MISC


423 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


426 #ifdeà
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

428 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

429 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

431 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

433 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

438 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

439 
__THROW
 
	`__nÚnuÎ
 ((2));

443 #ifdeà
__USE_XOPEN2K8


445 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

451 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

453 #ifdeà
__USE_BSD


455 
	$bcİy
 (
__cÚ¡
 *
__¤c
, *
__de¡
, 
size_t
 
__n
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

462 
	$bcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

466 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`šdex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

471 
__cÚ¡
 *
	`šdex
 (__cÚ¡ *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

474 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__ex‹º_®ways_šlše
 *

476 
	`šdex
 (*
__s
, 
__c
è
__THROW


478  
	`__butš_šdex
 (
__s
, 
__c
);

481 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

482 
	`šdex
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


484  
	`__butš_šdex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$šdex
 (
__cÚ¡
 *
__s
, 
__c
)

490 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`ršdex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

499 
__cÚ¡
 *
	`ršdex
 (__cÚ¡ *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

502 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__ex‹º_®ways_šlše
 *

504 
	`ršdex
 (*
__s
, 
__c
è
__THROW


506  
	`__butš_ršdex
 (
__s
, 
__c
);

509 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

510 
	`ršdex
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


512  
	`__butš_ršdex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$ršdex
 (
__cÚ¡
 *
__s
, 
__c
)

518 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

523 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

527 #ifdef 
__USE_GNU


528 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 #ifdeà
__GNUC__


530 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

531 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

536 
	$¡rÿ£cmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

537 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

540 
	$¡ºÿ£cmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

541 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

544 #ifdef 
__USE_GNU


547 
	$¡rÿ£cmp_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
,

548 
__loÿË_t
 
__loc
)

549 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

551 
	$¡ºÿ£cmp_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
,

552 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

553 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

556 #ifdef 
__USE_BSD


559 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

560 
__cÚ¡
 *
__»¡riù
 
__d–im
)

561 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 #ifdef 
__USE_XOPEN2K8


566 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

569 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

570 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

577 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

578 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

579 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

580 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

581 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 #ifdef 
__USE_GNU


586 
	$¡rv”scmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

587 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

590 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

593 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

595 #iâdeà
ba£Çme


600 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


601 "C++" *
	$ba£Çme
 (*
__f’ame
)

602 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

603 "C++" 
__cÚ¡
 *
	$ba£Çme
 (
__cÚ¡
 *
__f’ame
)

604 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

606 *
	$ba£Çme
 (
__cÚ¡
 *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

612 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

613 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

614 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


634 
	~<b™s/¡ršg.h
>

637 
	~<b™s/¡ršg2.h
>

640 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


642 
	~<b™s/¡ršg3.h
>

646 
__END_DECLS


	@/usr/include/stropts.h

19 #iâdeà
_STROPTS_H


20 
	#_STROPTS_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<b™s/ty³s.h
>

24 
	~<b™s/xt™y³s.h
>

26 #iâdeà
__gid_t_defšed


27 
__gid_t
 
	tgid_t
;

28 
	#__gid_t_defšed


	)

31 #iâdeà
__uid_t_defšed


32 
__uid_t
 
	tuid_t
;

33 
	#__uid_t_defšed


	)

36 
__t_usÿÏr_t
 
	tt_usÿÏr_t
;

39 
	~<b™s/¡rİts.h
>

42 
__BEGIN_DECLS


45 
	$i§¡»am
 (
__fdes
è
__THROW
;

51 
	`g‘msg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

52 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

53 *
__»¡riù
 
__æag¥
);

60 
	`g‘pmsg
 (
__fdes
, 
¡rbuf
 *
__»¡riù
 
__ùÍŒ
,

61 
¡rbuf
 *
__»¡riù
 
__d©­Œ
,

62 *
__»¡riù
 
__bªdp
, *__»¡riù 
__æag¥
);

67 
	$ioùl
 (
__fd
, 
__»que¡
, ...è
__THROW
;

73 
	`putmsg
 (
__fdes
, 
__cÚ¡
 
¡rbuf
 *
__ùÍŒ
,

74 
__cÚ¡
 
¡rbuf
 *
__d©­Œ
, 
__æags
);

80 
	`pumsg
 (
__fdes
, 
__cÚ¡
 
¡rbuf
 *
__ùÍŒ
,

81 
__cÚ¡
 
¡rbuf
 *
__d©­Œ
, 
__bªd
, 
__æags
);

85 
	$ç‰ach
 (
__fdes
, 
__cÚ¡
 *
__·th
è
__THROW
;

88 
	$fd‘ach
 (
__cÚ¡
 *
__·th
è
__THROW
;

90 
__END_DECLS


	@/usr/include/syslog.h

1 
	~<sys/sy¦og.h
>

	@/usr/include/termios.h

23 #iâdef 
_TERMIOS_H


24 
	#_TERMIOS_H
 1

	)

26 
	~<ã©u»s.h
>

27 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


29 
	~<b™s/ty³s.h
>

30 #iâdeà
__pid_t_defšed


31 
__pid_t
 
	tpid_t
;

32 
	#__pid_t_defšed


	)

36 
	g__BEGIN_DECLS


40 
	~<b™s/‹rmios.h
>

42 #ifdeà
__USE_BSD


45 
	#CCEQ
(
v®
, 
c
è((cè=ğ(v®è&& (v®è!ğ
_POSIX_VDISABLE
)

	)

49 
¥“d_t
 
	$cfg‘o¥“d
 (
__cÚ¡
 
‹rmios
 *
__‹rmios_p
è
__THROW
;

52 
¥“d_t
 
	$cfg‘i¥“d
 (
__cÚ¡
 
‹rmios
 *
__‹rmios_p
è
__THROW
;

55 
	$cf£to¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

58 
	$cf£ti¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

60 #ifdef 
__USE_BSD


62 
	$cf£t¥“d
 (
‹rmios
 *
__‹rmios_p
, 
¥“d_t
 
__¥“d
è
__THROW
;

67 
	$tcg‘©Œ
 (
__fd
, 
‹rmios
 *
__‹rmios_p
è
__THROW
;

71 
	$tc£‰r
 (
__fd
, 
__İtiÚ®_aùiÚs
,

72 
__cÚ¡
 
‹rmios
 *
__‹rmios_p
è
__THROW
;

75 #ifdef 
__USE_BSD


77 
	$cfmak”aw
 (
‹rmios
 *
__‹rmios_p
è
__THROW
;

81 
	$tc£ndb»ak
 (
__fd
, 
__du¿tiÚ
è
__THROW
;

87 
	`tcd¿š
 (
__fd
);

91 
	$tcæush
 (
__fd
, 
__queue_£ËùÜ
è
__THROW
;

95 
	$tcæow
 (
__fd
, 
__aùiÚ
è
__THROW
;

98 #ifdeà
__USE_UNIX98


100 
__pid_t
 
	$tcg‘sid
 (
__fd
è
__THROW
;

104 #ifdeà
__USE_BSD


105 
	~<sys/‰ydeçuÉs.h
>

108 
__END_DECLS


	@/usr/include/time.h

23 #iâdef 
_TIME_H


25 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

26 ! 
defšed
 
	g__Ãed_time¥ec
)

27 
	#_TIME_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 #ifdef 
_TIME_H


36 
	#__Ãed_size_t


	)

37 
	#__Ãed_NULL


	)

38 
	~<¡ddef.h
>

42 
	~<b™s/time.h
>

45 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


46 #iâdeà
CLK_TCK


47 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

53 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

54 
	#__şock_t_defšed
 1

	)

56 
	~<b™s/ty³s.h
>

58 
__BEGIN_NAMESPACE_STD


60 
__şock_t
 
	tşock_t
;

61 
	g__END_NAMESPACE_STD


62 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


63 
	$__USING_NAMESPACE_STD
(
şock_t
)

67 #undeà
__Ãed_şock_t


69 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

70 
	#__time_t_defšed
 1

	)

72 
	~<b™s/ty³s.h
>

74 
__BEGIN_NAMESPACE_STD


76 
__time_t
 
	ttime_t
;

77 
__END_NAMESPACE_STD


78 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


79 
	$__USING_NAMESPACE_STD
(
time_t
)

83 #undeà
__Ãed_time_t


85 #ià!
defšed
 
__şockid_t_defšed
 && \

86 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

87 
	#__şockid_t_defšed
 1

	)

89 
	~<b™s/ty³s.h
>

92 
__şockid_t
 
	tşockid_t
;

95 #undeà
__şockid_time_t


97 #ià!
defšed
 
__tim”_t_defšed
 && \

98 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

99 
	#__tim”_t_defšed
 1

	)

101 
	~<b™s/ty³s.h
>

104 
__tim”_t
 
	ttim”_t
;

107 #undeà
__Ãed_tim”_t


110 #ià!
defšed
 
__time¥ec_defšed
 && \

111 ((
defšed
 
_TIME_H
 && \

112 (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
)) || \

113 
defšed
 
__Ãed_time¥ec
)

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 
__cÚ¡
 *
tm_zÚe
;

149 
__tm_gmtoff
;

150 
__cÚ¡
 *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 
__BEGIN_NAMESPACE_STD


183 
şock_t
 
	$şock
 (è
__THROW
;

186 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

189 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

190 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

193 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

199 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

200 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

201 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

202 
__END_NAMESPACE_STD


204 #ifdeà
__USE_XOPEN


207 *
	$¡½time
 (
__cÚ¡
 *
__»¡riù
 
__s
,

208 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
)

209 
__THROW
;

212 #ifdeà
__USE_XOPEN2K8


215 
	~<xloÿË.h
>

217 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

218 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

219 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

220 
__loÿË_t
 
__loc
è
__THROW
;

223 #ifdeà
__USE_GNU


224 *
	$¡½time_l
 (
__cÚ¡
 *
__»¡riù
 
__s
,

225 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

230 
__BEGIN_NAMESPACE_STD


233 
tm
 *
	$gmtime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

237 
tm
 *
	$loÿÉime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

238 
__END_NAMESPACE_STD


240 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


243 
tm
 *
	$gmtime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

244 
tm
 *
__»¡riù
 
__
è
__THROW
;

248 
tm
 *
	$loÿÉime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

249 
tm
 *
__»¡riù
 
__
è
__THROW
;

252 
__BEGIN_NAMESPACE_STD


255 *
	$asùime
 (
__cÚ¡
 
tm
 *
__
è
__THROW
;

258 *
	$ùime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

259 
__END_NAMESPACE_STD


261 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


266 *
	$asùime_r
 (
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

267 *
__»¡riù
 
__buf
è
__THROW
;

270 *
	$ùime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

271 *
__»¡riù
 
__buf
è
__THROW
;

276 *
__tzÇme
[2];

277 
__daylight
;

278 
__timezÚe
;

281 #ifdef 
__USE_POSIX


283 *
tzÇme
[2];

287 
	$tz£t
 (è
__THROW
;

290 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


291 
daylight
;

292 
timezÚe
;

295 #ifdeà
__USE_SVID


298 
	$¡ime
 (
__cÚ¡
 
time_t
 *
__wh’
è
__THROW
;

304 
	#__i¦—p
(
y—r
) \

305 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

308 #ifdeà
__USE_MISC


313 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

316 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

319 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

323 #ifdeà
__USE_POSIX199309


328 
	`Çno¦“p
 (
__cÚ¡
 
time¥ec
 *
__»que¡ed_time
,

329 
time¥ec
 *
__»maššg
);

333 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

336 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

339 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, 
__cÚ¡
 
time¥ec
 *
__
)

340 
__THROW
;

342 #ifdeà
__USE_XOPEN2K


347 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

348 
__cÚ¡
 
time¥ec
 *
__»q
,

349 
time¥ec
 *
__»m
);

352 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

357 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

358 
sigev’t
 *
__»¡riù
 
__evp
,

359 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

362 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

365 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

366 
__cÚ¡
 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

367 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

370 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

371 
__THROW
;

374 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

378 #ifdeà
__USE_XOPEN_EXTENDED


390 
g‘d©e_”r
;

399 
tm
 *
	`g‘d©e
 (
__cÚ¡
 *
__¡ršg
);

402 #ifdeà
__USE_GNU


413 
	`g‘d©e_r
 (
__cÚ¡
 *
__»¡riù
 
__¡ršg
,

414 
tm
 *
__»¡riù
 
__»sbuå
);

417 
__END_DECLS


	@/usr/include/ucontext.h

21 #iâdeà
_UCONTEXT_H


22 
	#_UCONTEXT_H
 1

	)

24 
	~<ã©u»s.h
>

27 
	~<sys/ucÚ‹xt.h
>

29 
__BEGIN_DECLS


32 
	$g‘cÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
è
__THROW
;

35 
	$£tcÚ‹xt
 (
__cÚ¡
 
ucÚ‹xt_t
 *
__uı
è
__THROW
;

39 
	$sw­cÚ‹xt
 (
ucÚ‹xt_t
 *
__»¡riù
 
__ouı
,

40 
__cÚ¡
 
ucÚ‹xt_t
 *
__»¡riù
 
__uı
è
__THROW
;

48 
	`makecÚ‹xt
 (
ucÚ‹xt_t
 *
__uı
, (*
__func
) (),

49 
__¬gc
, ...è
__THROW
;

51 
__END_DECLS


	@/usr/include/unistd.h

23 #iâdef 
_UNISTD_H


24 
	#_UNISTD_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


33 #ifdeà
__USE_XOPEN2K8


35 
	#_POSIX_VERSION
 200809L

	)

36 #–ià
defšed
 
__USE_XOPEN2K


38 
	#_POSIX_VERSION
 200112L

	)

39 #–ià
defšed
 
__USE_POSIX199506


41 
	#_POSIX_VERSION
 199506L

	)

42 #–ià
defšed
 
__USE_POSIX199309


44 
	#_POSIX_VERSION
 199309L

	)

47 
	#_POSIX_VERSION
 199009L

	)

53 #ifdeà
__USE_XOPEN2K8


54 
	#__POSIX2_THIS_VERSION
 200809L

	)

56 #–ià
defšed
 
__USE_XOPEN2K


58 
	#__POSIX2_THIS_VERSION
 200112L

	)

59 #–ià
defšed
 
__USE_POSIX199506


61 
	#__POSIX2_THIS_VERSION
 199506L

	)

64 
	#__POSIX2_THIS_VERSION
 199209L

	)

68 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

72 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

76 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

80 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

84 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

87 #ifdeà
__USE_XOPEN2K8


88 
	#_XOPEN_VERSION
 700

	)

89 #–ià
defšed
 
__USE_XOPEN2K


90 
	#_XOPEN_VERSION
 600

	)

91 #–ià
defšed
 
__USE_UNIX98


92 
	#_XOPEN_VERSION
 500

	)

94 
	#_XOPEN_VERSION
 4

	)

98 
	#_XOPEN_XCU_VERSION
 4

	)

101 
	#_XOPEN_XPG2
 1

	)

102 
	#_XOPEN_XPG3
 1

	)

103 
	#_XOPEN_XPG4
 1

	)

106 
	#_XOPEN_UNIX
 1

	)

109 
	#_XOPEN_CRYPT
 1

	)

113 
	#_XOPEN_ENH_I18N
 1

	)

116 
	#_XOPEN_LEGACY
 1

	)

203 
	~<b™s/posix_İt.h
>

206 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


207 
	~<b™s/’vœÚm’ts.h
>

211 
	#STDIN_FILENO
 0

	)

212 
	#STDOUT_FILENO
 1

	)

213 
	#STDERR_FILENO
 2

	)

218 
	~<b™s/ty³s.h
>

220 #iâdef 
__ssize_t_defšed


221 
__ssize_t
 
	tssize_t
;

222 
	#__ssize_t_defšed


	)

225 
	#__Ãed_size_t


	)

226 
	#__Ãed_NULL


	)

227 
	~<¡ddef.h
>

229 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


232 #iâdeà
__gid_t_defšed


233 
__gid_t
 
	tgid_t
;

234 
	#__gid_t_defšed


	)

237 #iâdeà
__uid_t_defšed


238 
__uid_t
 
	tuid_t
;

239 
	#__uid_t_defšed


	)

242 #iâdeà
__off_t_defšed


243 #iâdeà
__USE_FILE_OFFSET64


244 
__off_t
 
	toff_t
;

246 
__off64_t
 
	toff_t
;

248 
	#__off_t_defšed


	)

250 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


251 
__off64_t
 
	toff64_t
;

252 
	#__off64_t_defšed


	)

255 #iâdeà
__u£cÚds_t_defšed


256 
__u£cÚds_t
 
	tu£cÚds_t
;

257 
	#__u£cÚds_t_defšed


	)

260 #iâdeà
__pid_t_defšed


261 
__pid_t
 
	tpid_t
;

262 
	#__pid_t_defšed


	)

266 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


267 #iâdeà
__šŒ_t_defšed


268 
__šŒ_t
 
	tšŒ_t
;

269 
	#__šŒ_t_defšed


	)

273 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


274 #iâdeà
__sockËn_t_defšed


275 
__sockËn_t
 
	tsockËn_t
;

276 
	#__sockËn_t_defšed


	)

282 
	#R_OK
 4

	)

283 
	#W_OK
 2

	)

284 
	#X_OK
 1

	)

285 
	#F_OK
 0

	)

288 
	$acûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

290 #ifdeà
__USE_GNU


293 
	$euidacûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
)

294 
__THROW
 
	`__nÚnuÎ
 ((1));

297 
	$—cûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
)

298 
__THROW
 
	`__nÚnuÎ
 ((1));

301 #ifdeà
__USE_ATFILE


305 
	$çcûs§t
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__ty³
, 
__æag
)

306 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

311 #iâdef 
_STDIO_H


312 
	#SEEK_SET
 0

	)

313 
	#SEEK_CUR
 1

	)

314 
	#SEEK_END
 2

	)

317 #ià
defšed
 
__USE_BSD
 && !defšed 
L_SET


319 
	#L_SET
 
SEEK_SET


	)

320 
	#L_INCR
 
SEEK_CUR


	)

321 
	#L_XTND
 
SEEK_END


	)

330 #iâdeà
__USE_FILE_OFFSET64


331 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

333 #ifdeà
__REDIRECT_NTH


334 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

335 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

336 
l£ek64
);

338 
	#l£ek
 
l£ek64


	)

341 #ifdeà
__USE_LARGEFILE64


342 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

343 
__THROW
;

350 
	`şo£
 (
__fd
);

357 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

363 
ssize_t
 
	$wr™e
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
è
__wur
;

365 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


366 #iâdeà
__USE_FILE_OFFSET64


373 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

374 
__off_t
 
__off£t
è
__wur
;

381 
ssize_t
 
	$pwr™e
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
,

382 
__off_t
 
__off£t
è
__wur
;

384 #ifdeà
__REDIRECT


385 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

386 
__off64_t
 
__off£t
),

387 
´—d64
è
__wur
;

388 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, 
__cÚ¡
 *
__buf
,

389 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

390 
pwr™e64
è
__wur
;

392 
	#´—d
 
´—d64


	)

393 
	#pwr™e
 
pwr™e64


	)

397 #ifdeà
__USE_LARGEFILE64


401 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

402 
__off64_t
 
__off£t
è
__wur
;

405 
ssize_t
 
	$pwr™e64
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
,

406 
__off64_t
 
__off£t
è
__wur
;

414 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

416 #ifdeà
__USE_GNU


419 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

429 
	$®¬m
 (
__£cÚds
è
__THROW
;

441 
	`¦“p
 (
__£cÚds
);

443 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

444 || 
defšed
 
__USE_BSD


449 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

450 
__THROW
;

457 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

466 
	`·u£
 ();

470 
	$chown
 (
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

471 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

473 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


475 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

480 
	$lchown
 (
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

481 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

485 #ifdeà
__USE_ATFILE


488 
	$fchowÇt
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
,

489 
__gid_t
 
__group
, 
__æag
)

490 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

494 
	$chdœ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

496 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


498 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

508 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

510 #ifdef 
__USE_GNU


514 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

517 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

518 || 
defšed
 
__USE_BSD


522 *
	$g‘wd
 (*
__buf
)

523 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

528 
	$dup
 (
__fd
è
__THROW
 
__wur
;

531 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

533 #ifdeà
__USE_GNU


536 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

540 **
__’vœÚ
;

541 #ifdeà
__USE_GNU


542 **
’vœÚ
;

548 
	$execve
 (
__cÚ¡
 *
__·th
, *__cÚ¡ 
__¬gv
[],

549 *
__cÚ¡
 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

551 #ifdeà
__USE_XOPEN2K8


554 
	$ãxecve
 (
__fd
, *
__cÚ¡
 
__¬gv
[], *__cÚ¡ 
__’vp
[])

555 
__THROW
 
	`__nÚnuÎ
 ((2));

560 
	$execv
 (
__cÚ¡
 *
__·th
, *__cÚ¡ 
__¬gv
[])

561 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

565 
	$exeşe
 (
__cÚ¡
 *
__·th
, __cÚ¡ *
__¬g
, ...)

566 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

570 
	$exeş
 (
__cÚ¡
 *
__·th
, __cÚ¡ *
__¬g
, ...)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

575 
	$execvp
 (
__cÚ¡
 *
__fe
, *__cÚ¡ 
__¬gv
[])

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$exeşp
 (
__cÚ¡
 *
__fe
, __cÚ¡ *
__¬g
, ...)

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 #ifdeà
__USE_GNU


587 
	$execv³
 (
__cÚ¡
 *
__fe
, *__cÚ¡ 
__¬gv
[],

588 *
__cÚ¡
 
__’vp
[])

589 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

593 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


595 
	$niû
 (
__šc
è
__THROW
 
__wur
;

600 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

606 
	~<b™s/cÚâame.h
>

609 
	$·thcÚf
 (
__cÚ¡
 *
__·th
, 
__Çme
)

610 
__THROW
 
	`__nÚnuÎ
 ((1));

613 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

616 
	$syscÚf
 (
__Çme
è
__THROW
;

618 #ifdef 
__USE_POSIX2


620 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

625 
__pid_t
 
	$g‘pid
 (è
__THROW
;

628 
__pid_t
 
	$g‘µid
 (è
__THROW
;

632 #iâdeà
__FAVOR_BSD


633 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

635 #ifdeà
__REDIRECT_NTH


636 
__pid_t
 
	`__REDIRECT_NTH
 (
g‘pg½
, (__pid_ˆ
__pid
), 
__g‘pgid
);

638 
	#g‘pg½
 
__g‘pgid


	)

643 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

644 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


645 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

652 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

654 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


665 #iâdeà
__FAVOR_BSD


669 
	$£g½
 (è
__THROW
;

674 #ifdeà
__REDIRECT_NTH


675 
	`__REDIRECT_NTH
 (
£g½
, (
__pid_t
 
__pid
, __pid_ˆ
__pg½
), 
£gid
);

677 
	#£g½
 
£gid


	)

686 
__pid_t
 
	$£tsid
 (è
__THROW
;

688 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


690 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

694 
__uid_t
 
	$g‘uid
 (è
__THROW
;

697 
__uid_t
 
	$g‘euid
 (è
__THROW
;

700 
__gid_t
 
	$g‘gid
 (è
__THROW
;

703 
__gid_t
 
	$g‘egid
 (è
__THROW
;

708 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

710 #ifdef 
__USE_GNU


712 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

719 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
;

721 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


724 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
;

727 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


729 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
;

736 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
;

738 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


741 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
;

744 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


746 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
;

749 #ifdeà
__USE_GNU


752 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

753 
__THROW
;

757 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

758 
__THROW
;

762 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

763 
__THROW
;

767 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

768 
__THROW
;

775 
__pid_t
 
	$fÜk
 (è
__THROW
;

777 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

778 || 
defšed
 
__USE_BSD


783 
__pid_t
 
	$vfÜk
 (è
__THROW
;

789 *
	$‰yÇme
 (
__fd
è
__THROW
;

793 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

794 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

798 
	$i§‰y
 (
__fd
è
__THROW
;

800 #ià
defšed
 
__USE_BSD
 \

801 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

804 
	$‰y¦Ù
 (è
__THROW
;

809 
	$lšk
 (
__cÚ¡
 *
__äom
, __cÚ¡ *
__to
)

810 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

812 #ifdeà
__USE_ATFILE


815 
	$lšk©
 (
__äomfd
, 
__cÚ¡
 *
__äom
, 
__tofd
,

816 
__cÚ¡
 *
__to
, 
__æags
)

817 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

820 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


822 
	$symlšk
 (
__cÚ¡
 *
__äom
, __cÚ¡ *
__to
)

823 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

828 
ssize_t
 
	$»adlšk
 (
__cÚ¡
 *
__»¡riù
 
__·th
,

829 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

830 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

833 #ifdeà
__USE_ATFILE


835 
	$symlšk©
 (
__cÚ¡
 *
__äom
, 
__tofd
,

836 
__cÚ¡
 *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

839 
ssize_t
 
	$»adlšk©
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

840 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

841 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

845 
	$uÆšk
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

847 #ifdeà
__USE_ATFILE


849 
	$uÆšk©
 (
__fd
, 
__cÚ¡
 *
__Çme
, 
__æag
)

850 
__THROW
 
	`__nÚnuÎ
 ((2));

854 
	$rmdœ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

858 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

861 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

868 *
	`g‘logš
 ();

869 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


876 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

879 #ifdef 
__USE_BSD


881 
	$£ogš
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

885 #ifdef 
__USE_POSIX2


889 
	#__Ãed_g‘İt


	)

890 
	~<g‘İt.h
>

894 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


898 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

902 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

905 
	$£tho¡Çme
 (
__cÚ¡
 *
__Çme
, 
size_t
 
__Ën
)

906 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

910 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

916 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

917 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

918 
	$£tdomašÇme
 (
__cÚ¡
 *
__Çme
, 
size_t
 
__Ën
)

919 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

925 
	$vhªgup
 (è
__THROW
;

928 
	$»voke
 (
__cÚ¡
 *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

936 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

937 
size_t
 
__off£t
, 
__sÿË
)

938 
__THROW
 
	`__nÚnuÎ
 ((1));

944 
	$acù
 (
__cÚ¡
 *
__Çme
è
__THROW
;

948 *
	$g‘u£rsh–l
 (è
__THROW
;

949 
	$’du£rsh–l
 (è
__THROW
;

950 
	$£tu£rsh–l
 (è
__THROW
;

956 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

960 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

963 
	$chroÙ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

967 *
	$g‘·ss
 (
__cÚ¡
 *
__´om±
è
	`__nÚnuÎ
 ((1));

971 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


976 
	`fsync
 (
__fd
);

980 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


983 
	`g‘ho¡id
 ();

986 
	$sync
 (è
__THROW
;

989 #ià
defšed
 
__USE_BSD
 || !defšed 
__USE_XOPEN2K


992 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

997 
	$g‘dbËsize
 (è
__THROW
;

1003 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


1006 #iâdeà
__USE_FILE_OFFSET64


1007 
	$Œunÿ‹
 (
__cÚ¡
 *
__fe
, 
__off_t
 
__Ëngth
)

1008 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1010 #ifdeà
__REDIRECT_NTH


1011 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1012 (
__cÚ¡
 *
__fe
, 
__off64_t
 
__Ëngth
),

1013 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1015 
	#Œunÿ‹
 
Œunÿ‹64


	)

1018 #ifdeà
__USE_LARGEFILE64


1019 
	$Œunÿ‹64
 (
__cÚ¡
 *
__fe
, 
__off64_t
 
__Ëngth
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1025 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1028 #iâdeà
__USE_FILE_OFFSET64


1029 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1031 #ifdeà
__REDIRECT_NTH


1032 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1033 
árunÿ‹64
è
__wur
;

1035 
	#árunÿ‹
 
árunÿ‹64


	)

1038 #ifdeà
__USE_LARGEFILE64


1039 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1045 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1046 || 
defšed
 
__USE_MISC


1050 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1056 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1060 #ifdeà
__USE_MISC


1071 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1076 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1088 
	#F_ULOCK
 0

	)

1089 
	#F_LOCK
 1

	)

1090 
	#F_TLOCK
 2

	)

1091 
	#F_TEST
 3

	)

1093 #iâdeà
__USE_FILE_OFFSET64


1094 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1096 #ifdeà
__REDIRECT


1097 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1098 
lockf64
è
__wur
;

1100 
	#lockf
 
lockf64


	)

1103 #ifdeà
__USE_LARGEFILE64


1104 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1109 #ifdeà
__USE_GNU


1114 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1115 (
__ex‹nsiÚ__
 \

1116 ({ 
__»suÉ
; \

1117 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1118 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1119 
__»suÉ
; 
	}
}))

	)

1122 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1125 
fd©async
 (
__fdes
);

1131 #ifdef 
__USE_XOPEN


1133 *
	$üy±
 (
__cÚ¡
 *
__key
, __cÚ¡ *
__§É
)

1134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1138 
	$’üy±
 (*
__libc_block
, 
__edæag
è
__THROW
 
	`__nÚnuÎ
 ((1));

1145 
	$swab
 (
__cÚ¡
 *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1146 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1152 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


1154 *
	$ù”mid
 (*
__s
è
__THROW
;

1159 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


1160 
	~<b™s/uni¡d.h
>

1163 
__END_DECLS


	@/usr/include/alloca.h

19 #iâdef 
_ALLOCA_H


20 
	#_ALLOCA_H
 1

	)

22 
	~<ã©u»s.h
>

24 
	#__Ãed_size_t


	)

25 
	~<¡ddef.h
>

27 
	g__BEGIN_DECLS


30 #undeà
®loÿ


33 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

35 #ifdef 
__GNUC__


36 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

39 
__END_DECLS


	@/usr/include/getopt.h

21 #iâdeà
_GETOPT_H


23 #iâdeà
__Ãed_g‘İt


24 
	#_GETOPT_H
 1

	)

34 #ià!
defšed
 
__GNU_LIBRARY__


35 
	~<ùy³.h
>

38 #iâdeà
__THROW


39 #iâdeà
__GNUC_PREREQ


40 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

42 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

43 
	#__THROW
 
	`throw
 ()

	)

45 
	#__THROW


	)

49 #ifdef 
__ılu¥lus


59 *
İrg
;

73 
İtšd
;

78 
İ‹¼
;

82 
İtİt
;

84 #iâdeà
__Ãed_g‘İt


106 
	sİtiÚ


108 cÚ¡ *
	gÇme
;

111 
	ghas_¬g
;

112 *
	gæag
;

113 
	gv®
;

118 
	#no_¬gum’t
 0

	)

119 
	#»quœed_¬gum’t
 1

	)

120 
	#İtiÚ®_¬gum’t
 2

	)

148 #ifdeà
__GNU_LIBRARY__


152 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

153 
__THROW
;

155 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

156 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


160 #ifdeà
__REDIRECT


161 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

162 cÚ¡ *
__shÜtİts
),

163 
__posix_g‘İt
);

165 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

166 cÚ¡ *
__shÜtİts
è
__THROW
;

167 
	#g‘İt
 
__posix_g‘İt


	)

171 
g‘İt
 ();

174 #iâdeà
__Ãed_g‘İt


175 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

176 cÚ¡ *
__shÜtİts
,

177 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

178 
__THROW
;

179 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

180 cÚ¡ *
__shÜtİts
,

181 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

182 
__THROW
;

186 #ifdef 
__ılu¥lus


191 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

29 #iâdeà
_IO_STDIO_H


30 
	#_IO_STDIO_H


	)

32 
	~<_G_cÚfig.h
>

34 
	#_IO_pos_t
 
_G_åos_t


	)

35 
	#_IO_åos_t
 
_G_åos_t


	)

36 
	#_IO_åos64_t
 
_G_åos64_t


	)

37 
	#_IO_size_t
 
_G_size_t


	)

38 
	#_IO_ssize_t
 
_G_ssize_t


	)

39 
	#_IO_off_t
 
_G_off_t


	)

40 
	#_IO_off64_t
 
_G_off64_t


	)

41 
	#_IO_pid_t
 
_G_pid_t


	)

42 
	#_IO_uid_t
 
_G_uid_t


	)

43 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

44 
	#_IO_HAVE_SYS_WAIT
 
_G_HAVE_SYS_WAIT


	)

45 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

46 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

47 
	#_IO_va_li¡
 
_G_va_li¡


	)

48 
	#_IO_wšt_t
 
_G_wšt_t


	)

50 #ifdeà
_G_NEED_STDARG_H


52 
	#__Ãed___va_li¡


	)

53 
	~<¡d¬g.h
>

54 #ifdeà
__GNUC_VA_LIST


55 #undeà
_IO_va_li¡


56 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

60 #iâdeà
__P


61 #ià
_G_HAVE_SYS_CDEFS


62 
	~<sys/cdefs.h
>

64 #ifdeà
__STDC__


65 
	#__P
(
p
è
	)
p

66 
	#__PMT
(
p
è
	)
p

68 
	#__P
(
p
è()

	)

69 
	#__PMT
(
p
è()

	)

75 #iâdeà
_PARAMS


76 
	#_PARAMS
(
´Ùos
è
	`__P
ÕrÙos)

	)

79 #iâdeà
__STDC__


81 cÚ¡

	)

84 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

85 #iâdeà
_G_HAVE_PRINTF_FP


86 
	#_IO_USE_DTOA
 1

	)

89 #iâdeà
EOF


90 
	#EOF
 (-1)

	)

92 #iâdeà
NULL


93 #ià
defšed
 
__GNUG__
 && \

94 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

95 
	#NULL
 (
__nuÎ
)

	)

97 #ià!
defšed
(
__ılu¥lus
)

98 
	#NULL
 ((*)0)

	)

100 
	#NULL
 (0)

	)

105 
	#_IOS_INPUT
 1

	)

106 
	#_IOS_OUTPUT
 2

	)

107 
	#_IOS_ATEND
 4

	)

108 
	#_IOS_APPEND
 8

	)

109 
	#_IOS_TRUNC
 16

	)

110 
	#_IOS_NOCREATE
 32

	)

111 
	#_IOS_NOREPLACE
 64

	)

112 
	#_IOS_BIN
 128

	)

120 
	#_IO_MAGIC
 0xFBAD0000

	)

121 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

122 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

123 
	#_IO_USER_BUF
 1

	)

124 
	#_IO_UNBUFFERED
 2

	)

125 
	#_IO_NO_READS
 4

	)

126 
	#_IO_NO_WRITES
 8

	)

127 
	#_IO_EOF_SEEN
 0x10

	)

128 
	#_IO_ERR_SEEN
 0x20

	)

129 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

130 
	#_IO_LINKED
 0x80

	)

131 
	#_IO_IN_BACKUP
 0x100

	)

132 
	#_IO_LINE_BUF
 0x200

	)

133 
	#_IO_TIED_PUT_GET
 0x400

	)

134 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

135 
	#_IO_IS_APPENDING
 0x1000

	)

136 
	#_IO_IS_FILEBUF
 0x2000

	)

137 
	#_IO_BAD_SEEN
 0x4000

	)

138 
	#_IO_USER_LOCK
 0x8000

	)

140 
	#_IO_FLAGS2_MMAP
 1

	)

141 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

142 #ifdeà
_LIBC


143 
	#_IO_FLAGS2_FORTIFY
 4

	)

145 
	#_IO_FLAGS2_USER_WBUF
 8

	)

146 #ifdeà
_LIBC


147 
	#_IO_FLAGS2_SCANF_STD
 16

	)

151 
	#_IO_SKIPWS
 01

	)

152 
	#_IO_LEFT
 02

	)

153 
	#_IO_RIGHT
 04

	)

154 
	#_IO_INTERNAL
 010

	)

155 
	#_IO_DEC
 020

	)

156 
	#_IO_OCT
 040

	)

157 
	#_IO_HEX
 0100

	)

158 
	#_IO_SHOWBASE
 0200

	)

159 
	#_IO_SHOWPOINT
 0400

	)

160 
	#_IO_UPPERCASE
 01000

	)

161 
	#_IO_SHOWPOS
 02000

	)

162 
	#_IO_SCIENTIFIC
 04000

	)

163 
	#_IO_FIXED
 010000

	)

164 
	#_IO_UNITBUF
 020000

	)

165 
	#_IO_STDIO
 040000

	)

166 
	#_IO_DONT_CLOSE
 0100000

	)

167 
	#_IO_BOOLALPHA
 0200000

	)

170 
_IO_jump_t
; 
	g_IO_FILE
;

173 #ifdeà
_IO_MTSAFE_IO


174 #ià
defšed
 
__GLIBC__
 && __GLIBC__ >= 2

175 
	~<b™s/¡dio-lock.h
>

180 
	t_IO_lock_t
;

186 
	s_IO_m¬k”
 {

187 
_IO_m¬k”
 *
	m_Ãxt
;

188 
_IO_FILE
 *
	m_sbuf
;

192 
	m_pos
;

194 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

195 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

196 
	mpublic
:

197 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

198 ~
¡»amm¬k”
();

199 
§všg
(è{  
	m_¥os
 == -2; }

200 
d–
(
¡»amm¬k”
&);

201 
d–
();

206 
	e__codecvt_»suÉ


208 
	m__codecvt_ok
,

209 
	m__codecvt_·¹Ÿl
,

210 
	m__codecvt_”rÜ
,

211 
	m__codecvt_nocÚv


214 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


217 
	s_IO_codecvt


219 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

220 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

221 
	m__mb¡©e_t
 *,

222 cÚ¡ 
	mwch¬_t
 *,

223 cÚ¡ 
	mwch¬_t
 *,

224 cÚ¡ 
	mwch¬_t
 **, *,

226 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

227 
	m__mb¡©e_t
 *, *,

229 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

230 
	m__mb¡©e_t
 *,

232 cÚ¡ **, 
	mwch¬_t
 *,

233 
	mwch¬_t
 *, wchar_t **);

234 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

235 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

236 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

237 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

238 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

240 
_IO_icÚv_t
 
	m__cd_š
;

241 
_IO_icÚv_t
 
	m__cd_out
;

245 
	s_IO_wide_d©a


247 
wch¬_t
 *
	m_IO_»ad_±r
;

248 
wch¬_t
 *
	m_IO_»ad_’d
;

249 
wch¬_t
 *
	m_IO_»ad_ba£
;

250 
wch¬_t
 *
	m_IO_wr™e_ba£
;

251 
wch¬_t
 *
	m_IO_wr™e_±r
;

252 
wch¬_t
 *
	m_IO_wr™e_’d
;

253 
wch¬_t
 *
	m_IO_buf_ba£
;

254 
wch¬_t
 *
	m_IO_buf_’d
;

256 
wch¬_t
 *
	m_IO_§ve_ba£
;

257 
wch¬_t
 *
	m_IO_backup_ba£
;

259 
wch¬_t
 *
	m_IO_§ve_’d
;

261 
__mb¡©e_t
 
	m_IO_¡©e
;

262 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

263 
_IO_codecvt
 
	m_codecvt
;

265 
wch¬_t
 
	m_shÜtbuf
[1];

267 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

271 
	s_IO_FILE
 {

272 
	m_æags
;

273 
	#_IO_fe_æags
 
_æags


	)

277 * 
	m_IO_»ad_±r
;

278 * 
	m_IO_»ad_’d
;

279 * 
	m_IO_»ad_ba£
;

280 * 
	m_IO_wr™e_ba£
;

281 * 
	m_IO_wr™e_±r
;

282 * 
	m_IO_wr™e_’d
;

283 * 
	m_IO_buf_ba£
;

284 * 
	m_IO_buf_’d
;

286 *
	m_IO_§ve_ba£
;

287 *
	m_IO_backup_ba£
;

288 *
	m_IO_§ve_’d
;

290 
_IO_m¬k”
 *
	m_m¬k”s
;

292 
_IO_FILE
 *
	m_chaš
;

294 
	m_f’o
;

296 
	m_blksize
;

298 
	m_æags2
;

300 
_IO_off_t
 
	m_Şd_off£t
;

302 
	#__HAVE_COLUMN


	)

304 
	m_cur_cŞumn
;

305 sigÃd 
	m_vbË_off£t
;

306 
	m_shÜtbuf
[1];

310 
_IO_lock_t
 *
	m_lock
;

311 #ifdeà
_IO_USE_OLD_IO_FILE


314 
	s_IO_FILE_com¶‘e


316 
_IO_FILE
 
	m_fe
;

318 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

319 
_IO_off64_t
 
	m_off£t
;

320 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


322 
_IO_codecvt
 *
	m_codecvt
;

323 
_IO_wide_d©a
 *
	m_wide_d©a
;

324 
_IO_FILE
 *
	m_ä“»s_li¡
;

325 *
	m_ä“»s_buf
;

326 
size_t
 
	m_ä“»s_size
;

328 *
	m__·d1
;

329 *
	m__·d2
;

330 *
	m__·d3
;

331 *
	m__·d4
;

332 
size_t
 
	m__·d5
;

334 
	m_mode
;

336 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

340 #iâdeà
__ılu¥lus


341 
_IO_FILE
 
	t_IO_FILE
;

344 
	g_IO_FILE_¶us
;

346 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

347 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

348 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

349 #iâdeà
_LIBC


350 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

351 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

352 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

354 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

355 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

356 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

364 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

372 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, 
	t__cÚ¡
 *
	t__buf
,

373 
	tsize_t
 
	t__n
);

381 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

384 
	t__io_şo£_â
 (*
	t__cook›
);

387 #ifdeà
_GNU_SOURCE


389 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

390 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

391 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

392 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

397 
__io_»ad_â
 *
	m»ad
;

398 
__io_wr™e_â
 *
	mwr™e
;

399 
__io_£ek_â
 *
	m£ek
;

400 
__io_şo£_â
 *
	mşo£
;

401 } 
	t_IO_cook›_io_funùiÚs_t
;

402 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

404 
	g_IO_cook›_fe
;

407 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

408 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

412 #ifdeà
__ılu¥lus


416 
__und”æow
 (
_IO_FILE
 *);

417 
__uæow
 (
_IO_FILE
 *);

418 
__ov”æow
 (
_IO_FILE
 *, );

419 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


420 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

421 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

422 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

425 #ià 
__GNUC__
 >= 3

426 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

428 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

431 
	#_IO_g‘c_uÆocked
(
_å
) \

432 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

433 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

434 
	#_IO_³ekc_uÆocked
(
_å
) \

435 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

436 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

437 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

438 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

439 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

440 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

441 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

443 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


444 
	#_IO_g‘wc_uÆocked
(
_å
) \

445 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

446 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

447 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

448 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

449 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

450 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

451 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

452 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

453 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

454 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

457 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

458 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

460 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

461 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

462 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

463 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

465 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

468 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

469 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

471 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

472 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

473 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

475 #ifdeà
_IO_MTSAFE_IO


476 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

477 
	#_IO_æockfe
(
_å
) \

478 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

479 
	#_IO_fuÆockfe
(
_å
) \

480 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

482 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

483 
	#_IO_æockfe
(
_å
è

	)

484 
	#_IO_fuÆockfe
(
_å
è

	)

485 
	#_IO_árylockfe
(
_å
è

	)

486 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

487 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

490 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

491 
_IO_va_li¡
, *
__»¡riù
);

492 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

493 
_IO_va_li¡
);

494 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

495 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

497 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

498 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

500 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

502 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


503 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

504 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

505 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

506 #ià
__GNUC__
 >= 2

509 #ià
defšed
 
_LIBC
 && defšed 
SHARED


510 
	~<shlib-com·t.h
>

511 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

512 
	#_IO_fwide_maybe_šcom·tibË
 \

513 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

514 cÚ¡ 
_IO_¡dš_u£d
;

515 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

518 #iâdeà
_IO_fwide_maybe_šcom·tibË


519 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

523 
	#_IO_fwide
(
__å
, 
__mode
) \

524 ({ 
__»suÉ
 = (
__mode
); \

525 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

527 ià((
__å
)->
_mode
 == 0) \

529 (
__å
)->
_mode
 = -1; \

530 
__»suÉ
 = (
__å
)->
_mode
; \

532 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

533 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

535 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

536 
__»suÉ
; })

	)

539 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

540 
_IO_va_li¡
, *
__»¡riù
);

541 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

542 
_IO_va_li¡
);

543 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

544 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

547 #ifdeà
__LDBL_COMPAT


548 
	~<b™s/libio-ldbl.h
>

551 #ifdeà
__ılu¥lus


	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (
__cÚ¡
 *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (
__cÚ¡
 *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

21 #iâdef 
_SCHED_H


22 
	#_SCHED_H
 1

	)

24 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

29 
	#__Ãed_size_t


	)

30 
	~<¡ddef.h
>

32 
	#__Ãed_time_t


	)

33 
	#__Ãed_time¥ec


	)

34 
	~<time.h
>

36 #iâdeà
__pid_t_defšed


37 
__pid_t
 
	tpid_t
;

38 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

45 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

48 
__BEGIN_DECLS


51 
	$sched_£¬am
 (
__pid_t
 
__pid
, 
__cÚ¡
 
sched_·¿m
 *
__·¿m
)

52 
__THROW
;

55 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

58 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

59 
__cÚ¡
 
sched_·¿m
 *
__·¿m
è
__THROW
;

62 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

65 
	$sched_y›ld
 (è
__THROW
;

68 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

71 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

77 #ifdeà
__USE_GNU


79 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

80 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

81 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

82 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

83 
ıu£
)

	)

84 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

87 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

88 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

89 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

90 
ıu£
)

	)

91 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

92 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

94 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

96 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

97 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

101 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

103 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

105 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

107 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

109 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

110 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

112 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

113 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

114 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

118 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

119 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

122 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

123 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

126 
__END_DECLS


	@/usr/include/xlocale.h

21 #iâdeà
_XLOCALE_H


22 
	#_XLOCALE_H
 1

	)

28 
	s__loÿË_¡ruù


31 
__loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

40 } *
	t__loÿË_t
;

43 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

21 
	#_G_size_t
 
size_t


	)

24 
__off_t
 
	m__pos
;

25 
__mb¡©e_t
 
	m__¡©e
;

26 } 
	t_G_åos_t
;

29 
__off64_t
 
	m__pos
;

30 
__mb¡©e_t
 
	m__¡©e
;

31 } 
	t_G_åos64_t
;

32 
	#_G_ssize_t
 
__ssize_t


	)

33 
	#_G_off_t
 
__off_t


	)

34 
	#_G_off64_t
 
__off64_t


	)

35 
	#_G_pid_t
 
__pid_t


	)

36 
	#_G_uid_t
 
__uid_t


	)

37 
	#_G_wch¬_t
 
wch¬_t


	)

38 
	#_G_wšt_t
 
wšt_t


	)

39 
	#_G_¡©64
 
¡©64


	)

40 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


41 
	~<gcÚv.h
>

44 
__gcÚv_šfo
 
	m__cd
;

47 
__gcÚv_šfo
 
	m__cd
;

48 
__gcÚv_¡•_d©a
 
	m__d©a
;

49 } 
	m__combšed
;

50 } 
	t_G_icÚv_t
;

53 
	t_G_št16_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__HI__
)));

54 
	t_G_št32_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__SI__
)));

55 
	t_G_ušt16_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__HI__
)));

56 
	t_G_ušt32_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__SI__
)));

58 
	#_G_HAVE_BOOL
 1

	)

62 
	#_G_HAVE_ATEXIT
 1

	)

63 
	#_G_HAVE_SYS_CDEFS
 1

	)

64 
	#_G_HAVE_SYS_WAIT
 1

	)

65 
	#_G_NEED_STDARG_H
 1

	)

66 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

68 
	#_G_HAVE_PRINTF_FP
 1

	)

69 
	#_G_HAVE_MMAP
 1

	)

70 
	#_G_HAVE_MREMAP
 1

	)

71 
	#_G_HAVE_LONG_DOUBLE_IO
 1

	)

72 
	#_G_HAVE_IO_FILE_OPEN
 1

	)

73 
	#_G_HAVE_IO_GETLINE_INFO
 1

	)

75 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

77 
	#_G_OPEN64
 
__İ’64


	)

78 
	#_G_LSEEK64
 
__l£ek64


	)

79 
	#_G_MMAP64
 
__mm­64


	)

80 
	#_G_FSTAT64
(
fd
,
buf
è
	`__fx¡©64
 (
_STAT_VER
, fd, buf)

	)

83 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

85 
	#_G_BUFSIZ
 8192

	)

88 
	#_G_NAMES_HAVE_UNDERSCORE
 0

	)

89 
	#_G_VTABLE_LABEL_HAS_LENGTH
 1

	)

90 
	#_G_USING_THUNKS
 1

	)

91 
	#_G_VTABLE_LABEL_PREFIX
 "__vt_"

	)

92 
	#_G_VTABLE_LABEL_PREFIX_ID
 
__vt_


	)

95 #ià
defšed
 
__ılu¥lus
 || defšed 
__STDC__


96 
	#_G_ARGS
(
ARGLIST
è
	)
ARGLIST

98 
	#_G_ARGS
(
ARGLIST
è()

	)

	@/usr/include/gconv.h

23 #iâdeà
_GCONV_H


24 
	#_GCONV_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	#__Ãed_mb¡©e_t


	)

28 
	#__Ãed_wšt_t


	)

29 
	~<wch¬.h
>

30 
	#__Ãed_size_t


	)

31 
	#__Ãed_wch¬_t


	)

32 
	~<¡ddef.h
>

35 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

40 
	m__GCONV_OK
 = 0,

41 
	m__GCONV_NOCONV
,

42 
	m__GCONV_NODB
,

43 
	m__GCONV_NOMEM
,

45 
	m__GCONV_EMPTY_INPUT
,

46 
	m__GCONV_FULL_OUTPUT
,

47 
	m__GCONV_ILLEGAL_INPUT
,

48 
	m__GCONV_INCOMPLETE_INPUT
,

50 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

51 
	m__GCONV_INTERNAL_ERROR


58 
	m__GCONV_IS_LAST
 = 0x0001,

59 
	m__GCONV_IGNORE_ERRORS
 = 0x0002

64 
	g__gcÚv_¡•
;

65 
	g__gcÚv_¡•_d©a
;

66 
	g__gcÚv_lßded_objeù
;

67 
	g__gcÚv_Œªs_d©a
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

72 
	t__cÚ¡
 **, __const *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 (*
	t__gcÚv_Œªs_fù
è(
	t__gcÚv_¡•
 *,

85 
	t__gcÚv_¡•_d©a
 *, *,

86 
	t__cÚ¡
 *,

87 
	t__cÚ¡
 **,

88 
	t__cÚ¡
 *, **,

89 
	tsize_t
 *);

92 (*
	t__gcÚv_Œªs_cÚ‹xt_fù
è(*, 
	t__cÚ¡
 *,

93 
	t__cÚ¡
 *,

97 (*
	t__gcÚv_Œªs_qu”y_fù
è(
	t__cÚ¡
 *, __const ***,

98 
	tsize_t
 *);

101 (*
	t__gcÚv_Œªs_š™_fù
) (**, const *);

102 (*
	t__gcÚv_Œªs_’d_fù
) (*);

104 
	s__gcÚv_Œªs_d©a


107 
__gcÚv_Œªs_fù
 
__Œªs_fù
;

108 
__gcÚv_Œªs_cÚ‹xt_fù
 
__Œªs_cÚ‹xt_fù
;

109 
__gcÚv_Œªs_’d_fù
 
__Œªs_’d_fù
;

110 *
__d©a
;

111 
__gcÚv_Œªs_d©a
 *
__Ãxt
;

116 
	s__gcÚv_¡•


118 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

119 
__cÚ¡
 *
__modÇme
;

121 
__couÁ”
;

123 *
__äom_Çme
;

124 *
__to_Çme
;

126 
__gcÚv_fù
 
__fù
;

127 
__gcÚv_btowc_fù
 
__btowc_fù
;

128 
__gcÚv_š™_fù
 
__š™_fù
;

129 
__gcÚv_’d_fù
 
__’d_fù
;

133 
__mš_Ãeded_äom
;

134 
__max_Ãeded_äom
;

135 
__mš_Ãeded_to
;

136 
__max_Ãeded_to
;

139 
__¡©eful
;

141 *
__d©a
;

146 
	s__gcÚv_¡•_d©a


148 *
__outbuf
;

149 *
__outbuãnd
;

153 
__æags
;

157 
__švoÿtiÚ_couÁ”
;

161 
__š‹º®_u£
;

163 
__mb¡©e_t
 *
__¡©•
;

164 
__mb¡©e_t
 
__¡©e
;

168 
__gcÚv_Œªs_d©a
 *
__Œªs
;

173 
	s__gcÚv_šfo


175 
size_t
 
__n¡•s
;

176 
__gcÚv_¡•
 *
__¡•s
;

177 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

178 } *
	t__gcÚv_t
;

	@/usr/include/wchar.h

24 #iâdeà
_WCHAR_H


26 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


27 
	#_WCHAR_H
 1

	)

28 
	~<ã©u»s.h
>

31 #ifdeà
_WCHAR_H


33 
	#__Ãed___FILE


	)

34 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


35 
	#__Ãed_FILE


	)

37 
	~<¡dio.h
>

39 
	#__Ãed___va_li¡


	)

40 
	~<¡d¬g.h
>

42 
	~<b™s/wch¬.h
>

45 
	#__Ãed_size_t


	)

46 
	#__Ãed_wch¬_t


	)

47 
	#__Ãed_NULL


	)

49 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


50 #undeà
__Ãed_wšt_t


51 
	#__Ãed_wšt_t


	)

52 
	~<¡ddef.h
>

56 #iâdeà
_WINT_T


61 
	#_WINT_T


	)

62 
	twšt_t
;

66 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

67 && 
defšed
 
__WINT_TYPE__


68 
__BEGIN_NAMESPACE_STD


69 
__WINT_TYPE__
 
	twšt_t
;

70 
	g__END_NAMESPACE_STD


75 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

76 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

80 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
__mb¡©e_t_defšed


81 
	#__mb¡©e_t_defšed
 1

	)

85 
	m__couÁ
;

88 #ifdeà
__WINT_TYPE__


89 
__WINT_TYPE__
 
	m__wch
;

91 
wšt_t
 
	m__wch
;

93 
	m__wchb
[4];

94 } 
	m__v®ue
;

95 } 
	t__mb¡©e_t
;

97 #undeà
__Ãed_mb¡©e_t


102 #ifdeà
_WCHAR_H


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 #ifdeà
__USE_GNU


109 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

112 #iâdeà
WCHAR_MIN


114 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

115 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

118 #iâdeà
WEOF


119 
	#WEOF
 (0xffffffffu)

	)

124 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


125 
	~<wùy³.h
>

129 
__BEGIN_DECLS


131 
__BEGIN_NAMESPACE_STD


134 
tm
;

135 
__END_NAMESPACE_STD


139 
	$__USING_NAMESPACE_STD
(
tm
)

142 
__BEGIN_NAMESPACE_STD


144 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

145 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

147 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

149 
__THROW
;

152 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

155 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

156 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

157 
__THROW
;

160 
	$wcscmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
)

161 
__THROW
 
__©Œibu‹_pu»__
;

163 
	$wc¢cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

164 
__THROW
 
__©Œibu‹_pu»__
;

165 
__END_NAMESPACE_STD


167 #ifdeà
__USE_XOPEN2K8


169 
	$wcsÿ£cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

172 
	$wc¢ÿ£cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

173 
size_t
 
__n
è
__THROW
;

177 
	~<xloÿË.h
>

179 
	$wcsÿ£cmp_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

180 
__loÿË_t
 
__loc
è
__THROW
;

182 
	$wc¢ÿ£cmp_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

183 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

186 
__BEGIN_NAMESPACE_STD


189 
	$wcscŞl
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

193 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

194 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

195 
__END_NAMESPACE_STD


197 #ifdeà
__USE_XOPEN2K8


203 
	$wcscŞl_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

204 
__loÿË_t
 
__loc
è
__THROW
;

209 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
,

210 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

213 
wch¬_t
 *
	$wcsdup
 (
__cÚ¡
 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

216 
__BEGIN_NAMESPACE_STD


218 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


219 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

220 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

221 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcschr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

222 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

224 
wch¬_t
 *
	$wcschr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

225 
__THROW
 
__©Œibu‹_pu»__
;

228 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


229 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

230 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

231 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wc¤chr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

232 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

234 
wch¬_t
 *
	$wc¤chr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

235 
__THROW
 
__©Œibu‹_pu»__
;

237 
__END_NAMESPACE_STD


239 #ifdeà
__USE_GNU


242 
wch¬_t
 *
	$wcschºul
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

243 
__THROW
 
__©Œibu‹_pu»__
;

246 
__BEGIN_NAMESPACE_STD


249 
size_t
 
	$wcsc¥n
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__»jeù
)

250 
__THROW
 
__©Œibu‹_pu»__
;

253 
size_t
 
	$wcs¥n
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__acû±
)

254 
__THROW
 
__©Œibu‹_pu»__
;

256 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


257 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, 
__cÚ¡
 wch¬_ˆ*
__acû±
)

258 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

259 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wc¥brk
 (
__cÚ¡
 
wch¬_t
 *
__wcs
,

260 
__cÚ¡
 
wch¬_t
 *
__acû±
)

261 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

263 
wch¬_t
 *
	$wc¥brk
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
__©Œibu‹_pu»__
;

267 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


268 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, 
__cÚ¡
 wch¬_ˆ*
__ÃedË
)

269 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

270 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcs¡r
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
,

271 
__cÚ¡
 
wch¬_t
 *
__ÃedË
)

272 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

274 
wch¬_t
 *
	$wcs¡r
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
, __cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
__©Œibu‹_pu»__
;

279 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

280 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__d–im
,

281 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

284 
size_t
 
	$wc¦’
 (
__cÚ¡
 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

285 
__END_NAMESPACE_STD


287 #ifdeà
__USE_XOPEN


289 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


290 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, 
__cÚ¡
 wch¬_ˆ*
__ÃedË
)

291 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

292 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcswcs
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
,

293 
__cÚ¡
 
wch¬_t
 *
__ÃedË
)

294 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

296 
wch¬_t
 *
	$wcswcs
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
, __cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
__©Œibu‹_pu»__
;

301 #ifdeà
__USE_XOPEN2K8


303 
size_t
 
	$wc¢Ën
 (
__cÚ¡
 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

304 
__THROW
 
__©Œibu‹_pu»__
;

308 
__BEGIN_NAMESPACE_STD


310 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


311 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

312 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

313 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wmemchr
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

314 
size_t
 
__n
)

315 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

317 
wch¬_t
 *
	$wmemchr
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
__©Œibu‹_pu»__
;

322 
	$wmemcmp
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s1
,

323 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

327 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

328 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

332 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
, 
size_t
 
__n
)

333 
__THROW
;

336 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

337 
__END_NAMESPACE_STD


339 #ifdeà
__USE_GNU


342 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

343 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

344 
__THROW
;

348 
__BEGIN_NAMESPACE_STD


351 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

355 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

359 
	$mbsš™
 (
__cÚ¡
 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

363 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

364 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

365 
mb¡©e_t
 *
__p
è
__THROW
;

368 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

369 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

372 
size_t
 
	$__mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

373 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

374 
size_t
 
	$mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

375 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

376 
__END_NAMESPACE_STD


378 #ifdeà
__USE_EXTERN_INLINES


384 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

385 
__ex‹º_šlše
 
wšt_t


386 
	`__NTH
 (
	$btowc
 (
__c
))

387 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

388 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

390 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

391 
__ex‹º_šlše
 

392 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

393 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

394 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

396 
__ex‹º_šlše
 
size_t


397 
__NTH
 (
	$mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

398 
mb¡©e_t
 *
__»¡riù
 
__ps
))

399 {  (
__ps
 !ğ
NULL


400 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

403 
__BEGIN_NAMESPACE_STD


406 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

407 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

408 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

412 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

413 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

414 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

415 
__END_NAMESPACE_STD


418 #ifdef 
__USE_XOPEN2K8


421 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

422 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

423 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

427 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

428 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

429 
size_t
 
__nwc
, size_ˆ
__Ën
,

430 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

435 #ifdeà
__USE_XOPEN


437 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

441 
	$wcswidth
 (
__cÚ¡
 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

445 
__BEGIN_NAMESPACE_STD


448 
	$wc¡od
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

449 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

450 
__END_NAMESPACE_STD


452 #ifdeà
__USE_ISOC99


453 
__BEGIN_NAMESPACE_C99


455 
	$wc¡of
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

456 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

457 
	$wc¡Şd
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

458 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

459 
__END_NAMESPACE_C99


463 
__BEGIN_NAMESPACE_STD


466 
	$wc¡Ş
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

467 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

471 
	$wc¡oul
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

473 
__THROW
;

474 
__END_NAMESPACE_STD


476 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GNUC__
 && defšed 
__USE_GNU
)

477 
__BEGIN_NAMESPACE_C99


480 
__ex‹nsiÚ__


481 
	$wc¡Şl
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

482 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

483 
__THROW
;

487 
__ex‹nsiÚ__


488 
	$wc¡ouÎ
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

489 
wch¬_t
 **
__»¡riù
 
__’d±r
,

490 
__ba£
è
__THROW
;

491 
__END_NAMESPACE_C99


494 #ià
defšed
 
__GNUC__
 && defšed 
__USE_GNU


497 
__ex‹nsiÚ__


498 
	$wc¡oq
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

499 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

500 
__THROW
;

504 
__ex‹nsiÚ__


505 
	$wc¡ouq
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

506 
wch¬_t
 **
__»¡riù
 
__’d±r
,

507 
__ba£
è
__THROW
;

510 #ifdeà
__USE_GNU


524 
	~<xloÿË.h
>

528 
	$wc¡Ş_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

529 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

530 
__loÿË_t
 
__loc
è
__THROW
;

532 
	$wc¡oul_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

533 
wch¬_t
 **
__»¡riù
 
__’d±r
,

534 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

536 
__ex‹nsiÚ__


537 
	$wc¡Şl_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡ouÎ_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
)

545 
__THROW
;

547 
	$wc¡od_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

549 
__THROW
;

551 
	$wc¡of_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

552 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

553 
__THROW
;

555 
	$wc¡Şd_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

556 
wch¬_t
 **
__»¡riù
 
__’d±r
,

557 
__loÿË_t
 
__loc
è
__THROW
;

562 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

563 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

567 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

568 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

569 
__THROW
;

575 #ifdef 
__USE_XOPEN2K8


578 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

581 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


582 
__BEGIN_NAMESPACE_STD


585 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

592 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

593 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

599 
	`w´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

602 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

603 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
__THROW
 ;

610 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

611 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

612 
__gnuc_va_li¡
 
__¬g
)

618 
	`vw´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

619 
__gnuc_va_li¡
 
__¬g
)

623 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

624 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

625 
__gnuc_va_li¡
 
__¬g
)

626 
__THROW
 ;

633 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

634 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

640 
	`wsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

643 
	$swsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

644 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
__THROW
 ;

647 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

648 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

649 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

650 #ifdeà
__REDIRECT


654 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

655 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

656 
__isoc99_fwsÿnf
)

658 
	`__REDIRECT
 (
wsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

659 
__isoc99_wsÿnf
)

661 
	`__REDIRECT_NTH
 (
swsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

662 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

663 ...), 
__isoc99_swsÿnf
)

666 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

667 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

668 
	`__isoc99_wsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

669 
	$__isoc99_swsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

670 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

671 
__THROW
;

672 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

673 
	#wsÿnf
 
__isoc99_wsÿnf


	)

674 
	#swsÿnf
 
__isoc99_swsÿnf


	)

678 
__END_NAMESPACE_STD


681 #ifdeà
__USE_ISOC99


682 
__BEGIN_NAMESPACE_C99


687 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

688 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

689 
__gnuc_va_li¡
 
__¬g
)

695 
	`vwsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

696 
__gnuc_va_li¡
 
__¬g
)

699 
	$vswsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

700 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

702 
__THROW
 ;

704 #ià!
defšed
 
__USE_GNU
 \

705 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

706 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

707 #ifdeà
__REDIRECT


708 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

709 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

710 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

712 
	`__REDIRECT
 (
vwsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

713 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

715 
	`__REDIRECT_NTH
 (
vswsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

716 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

717 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

720 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

721 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
);

723 
	`__isoc99_vwsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

724 
__gnuc_va_li¡
 
__¬g
);

725 
	$__isoc99_vswsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

726 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

728 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

729 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

730 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

734 
__END_NAMESPACE_C99


738 
__BEGIN_NAMESPACE_STD


743 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

744 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

750 
wšt_t
 
	`g‘wch¬
 ();

757 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

758 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

764 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

772 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

773 
__FILE
 *
__»¡riù
 
__¡»am
);

779 
	`åutws
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ws
,

780 
__FILE
 *
__»¡riù
 
__¡»am
);

787 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

788 
__END_NAMESPACE_STD


791 #ifdeà
__USE_GNU


799 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

800 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

808 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

816 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

825 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

826 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

835 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

836 
__FILE
 *
__»¡riù
 
__¡»am
);

844 
	`åutws_uÆocked
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ws
,

845 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
__BEGIN_NAMESPACE_C99


853 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

854 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

855 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

856 
__END_NAMESPACE_C99


858 #ifdeà
__USE_GNU


859 
	~<xloÿË.h
>

863 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

864 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

865 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

866 
__loÿË_t
 
__loc
è
__THROW
;

875 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


876 
	#__Ãed_iswxxx


	)

877 
	~<wùy³.h
>

881 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


882 
	~<b™s/wch¬2.h
>

885 #ifdeà
__LDBL_COMPAT


886 
	~<b™s/wch¬-ldbl.h
>

889 
__END_DECLS


897 #undeà
__Ãed_mb¡©e_t


898 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

24 #iâdeà
_WCTYPE_H


26 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

29 #iâdeà
__Ãed_iswxxx


30 
	#_WCTYPE_H
 1

	)

33 
	#__Ãed_wšt_t


	)

34 
	~<wch¬.h
>

38 #iâdeà
WEOF


39 
	#WEOF
 (0xffffffffu)

	)

42 #undeà
__Ãed_iswxxx


47 #iâdeà
__iswxxx_defšed


48 
	#__iswxxx_defšed
 1

	)

50 
__BEGIN_NAMESPACE_C99


53 
	twùy³_t
;

54 
	g__END_NAMESPACE_C99


56 #iâdeà
_ISwb™


61 
	~<’dŸn.h
>

62 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


63 
	#_ISwb™
(
b™
è(1 << (b™))

	)

65 
	#_ISwb™
(
b™
) \

66 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

67 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

68 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

69 : (è((1UL << (
b™
)è>> 24))))

	)

74 
	m__ISwuµ”
 = 0,

75 
	m__ISwlow”
 = 1,

76 
	m__ISw®pha
 = 2,

77 
	m__ISwdig™
 = 3,

78 
	m__ISwxdig™
 = 4,

79 
	m__ISw¥aû
 = 5,

80 
	m__ISw´št
 = 6,

81 
	m__ISwg¿ph
 = 7,

82 
	m__ISwbÏnk
 = 8,

83 
	m__ISwúŒl
 = 9,

84 
	m__ISwpunù
 = 10,

85 
	m__ISw®num
 = 11,

87 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

88 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

89 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

90 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

91 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

92 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

93 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

94 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

95 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

96 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

97 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

98 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

103 
__BEGIN_DECLS


105 
__BEGIN_NAMESPACE_C99


112 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

118 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

121 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

125 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

129 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

134 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

137 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

142 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

147 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

152 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

157 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

162 #ifdeà
__USE_ISOC99


163 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

172 
wùy³_t
 
	$wùy³
 (
__cÚ¡
 *
__´İ”ty
è
__THROW
;

176 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

177 
__END_NAMESPACE_C99


184 
__BEGIN_NAMESPACE_C99


187 
__cÚ¡
 
	t__št32_t
 *
	twù¿ns_t
;

188 
__END_NAMESPACE_C99


189 #ifdeà
__USE_GNU


190 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

193 
__BEGIN_NAMESPACE_C99


195 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

198 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

199 
__END_NAMESPACE_C99


201 
__END_DECLS


208 #ifdeà
_WCTYPE_H


214 
__BEGIN_DECLS


216 
__BEGIN_NAMESPACE_C99


219 
wù¿ns_t
 
	$wù¿ns
 (
__cÚ¡
 *
__´İ”ty
è
__THROW
;

222 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

223 
__END_NAMESPACE_C99


225 #ifdeà
__USE_XOPEN2K8


227 
	~<xloÿË.h
>

231 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

237 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

240 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

244 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

248 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

253 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

256 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

261 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

266 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

271 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

276 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

281 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

285 
wùy³_t
 
	$wùy³_l
 (
__cÚ¡
 *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

286 
__THROW
;

290 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

291 
__THROW
;

299 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

302 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

306 
wù¿ns_t
 
	$wù¿ns_l
 (
__cÚ¡
 *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

307 
__THROW
;

310 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

311 
__loÿË_t
 
__loÿË
è
__THROW
;

315 
__END_DECLS


	@
1
.
1
/usr/include
133
1779
adlist.c
adlist.h
ae.c
ae.h
ae_epoll.c
ae_evport.c
ae_kqueue.c
ae_select.c
anet.c
anet.h
aof.c
asciilogo.h
bio.c
bio.h
bitops.c
blocked.c
cluster.c
cluster.h
config.c
config.h
crc16.c
crc64.c
crc64.h
db.c
debug.c
dict.c
dict.h
endianconv.c
endianconv.h
fmacros.h
help.h
hyperloglog.c
intset.c
intset.h
latency.c
latency.h
lzf.h
lzfP.h
lzf_c.c
lzf_d.c
memtest.c
multi.c
networking.c
notify.c
object.c
pqsort.c
pqsort.h
pubsub.c
rand.c
rand.h
rdb.c
rdb.h
redis-benchmark.c
redis-check-aof.c
redis-check-dump.c
redis-cli.c
redis.c
redis.h
redisassert.h
release.c
release.h
replication.c
rio.c
rio.h
scripting.c
sds.c
sds.h
sentinel.c
setproctitle.c
sha1.c
sha1.h
slowlog.c
slowlog.h
solarisfixes.h
sort.c
sparkline.c
sparkline.h
syncio.c
t_hash.c
t_list.c
t_set.c
t_string.c
t_zset.c
testhelp.h
util.c
util.h
version.h
ziplist.c
ziplist.h
zipmap.c
zipmap.h
zmalloc.c
zmalloc.h
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/endian.h
/usr/include/errno.h
/usr/include/execinfo.h
/usr/include/fcntl.h
/usr/include/features.h
/usr/include/inttypes.h
/usr/include/limits.h
/usr/include/linux/version.h
/usr/include/locale.h
/usr/include/math.h
/usr/include/migration.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/poll.h
/usr/include/pthread.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/stropts.h
/usr/include/syslog.h
/usr/include/termios.h
/usr/include/time.h
/usr/include/ucontext.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
